Project Structure:
├── CHANGELOG.md
├── CLAUDE.md
├── GEMINI.md
├── README.md
├── bun.lockb
├── codefetch
│   └── codebase.md
├── components.json
├── debug-edge-function.js
├── deno.lock
├── deploy-pm2.sh
├── dist
│   ├── index.html
├── docs
│   ├── PAUTAS_DE_DISENO.md
│   ├── Stripe_integration.md
│   ├── preset_suggestions.sql
│   ├── project_structure.md
│   ├── provisional_logica_tts.md
│   ├── sql_supabase.sql
│   └── store_arquitecture.md
├── ecosystem.config.cjs
├── eslint.config.js
├── get-token.js
├── index.html
├── package-lock.json
├── package.json
├── postcss.config.cjs
├── public
├── src
│   ├── App.css
│   ├── App.tsx
│   ├── env.d.ts
│   ├── index.css
│   ├── main.tsx
│   ├── supabaseAuth.ts
│   ├── supabaseClient.ts
│   └── vite-env.d.ts
├── supabase
│   ├── config.toml
├── tailwind.config.ts
├── tasks
├── test-edge-functions
│   ├── README.md
│   ├── test-data.js
│   └── test-simple.js
├── tsconfig.app.json
├── tsconfig.json
├── tsconfig.node.json
└── vite.config.ts


CLAUDE.md
```
1 | # CLAUDE.md
2 | 
3 | This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
4 | 
5 | ## Project Overview
6 | 
7 | **Fantasia** is undergoing transformation from a children's storytelling application to an adult-oriented erotic content platform. The project generates personalized stories with voice narration and interactive elements, now targeting mature audiences with sophisticated adult themes.
8 | 
9 | **Current Version**: 1.1.4  
10 | **Main Branch**: master  
11 | **Project Type**: Single Page Application (SPA)  
12 | **Target Audience**: Adults (18+)  
13 | **Content Focus**: Adult erotic literature and interactive experiences  
14 | **Language**: English (migrating from Spanish)
15 | 
16 | ## Technology Stack
17 | 
18 | ### Frontend
19 | - **React 18.3.1** with TypeScript
20 | - **Vite** for build tooling and development server
21 | - **Tailwind CSS** for styling with custom configuration
22 | - **shadcn/ui** component library (extensive Radix UI components)
23 | - **Framer Motion** for animations and transitions
24 | - **Zustand** for state management
25 | - **React Router DOM** for navigation
26 | - **React Hook Form** with Zod validation
27 | - **TanStack Query** for server state management
28 | 
29 | ### Backend & Services
30 | - **Supabase** as Backend-as-a-Service (BaaS)
31 |   - Authentication and user management
32 |   - PostgreSQL database with Row Level Security (RLS)
33 |   - Edge Functions for serverless compute
34 |   - File storage for audio and images
35 | - **OpenAI** for AI-powered story generation and TTS
36 | - **Google Generative AI** (Gemini) for story generation
37 | - **Stripe** for payment processing and subscriptions
38 | - **ElevenLabs** for voice synthesis (via API)
39 | 
40 | ### Development Tools
41 | - **TypeScript** with strict configuration
42 | - **ESLint** with React and TypeScript rules
43 | - **PostCSS** with Tailwind CSS
44 | - **PM2** for production deployment
45 | - **Bun** as package manager (with npm fallback)
46 | 
47 | ## Project Structure
48 | 
49 | ```
50 | FantasIA/
51 | ├── src/
52 | │   ├── components/           # Reusable UI components
53 | │   │   ├── ui/              # shadcn/ui components (~49 files)
54 | │   │   └── [various].tsx    # App-specific components
55 | │   ├── pages/               # Route-based page components
56 | │   ├── services/            # API integration layer
57 | │   │   ├── ai/             # AI service wrappers
58 | │   │   └── [various].ts    # Database and third-party services
59 | │   ├── store/              # Zustand state management
60 | │   │   ├── character/      # Character management
61 | │   │   ├── stories/        # Story-related state
62 | │   │   ├── user/           # User profile and auth
63 | │   │   └── core/           # Store utilities
64 | │   ├── hooks/              # Custom React hooks
65 | │   ├── lib/                # Utility functions
66 | │   ├── types/              # TypeScript type definitions
67 | │   └── config/             # App configuration
68 | ├── supabase/
69 | │   ├── functions/          # Edge Functions
70 | │   ├── migrations/         # Database migrations
71 | │   └── sql-functions/      # Database functions
72 | ├── docs/                   # Project documentation
73 | └── public/                 # Static assets
74 | ```
75 | 
76 | ## Key Features
77 | 
78 | ### Story Generation
79 | - **Personalized Adult Stories**: AI-generated erotic tales based on character preferences, kinks, and interests
80 | - **Chapter System**: Multi-chapter stories with continuation options
81 | - **Story Format Choice**: Users can choose between 'single' self-contained stories or 'episodic' stories designed for multiple chapters
82 | - **Multiple Genres**: Romance, BDSM, fantasy, contemporary, etc.
83 | - **Character Customization**: Name, gender ('male', 'female', 'non-binary'), and free-text description
84 | 
85 | ### Audio Features
86 | - **Text-to-Speech**: Professional voice narration using OpenAI TTS with sensual voices
87 | - **Multiple Voices**: Different personality-matched voices for adult content
88 | - **Audio Player**: Custom audio player with progress tracking
89 | - **Voice Preview**: Sample voices before selection
90 | 
91 | ### Image Generation
92 | - **Currently Deactivated**: Image generation functionality is temporarily disabled
93 | - **Database Ready**: The schema includes a 'cover_image_url' field in the 'stories' table for future implementation
94 | - **Planned Features**: DALL-E 3 integration for story illustrations, cover images, and character portraits
95 | 
96 | ### Adult Content Features
97 | - **Content Warnings**: Appropriate warnings for different types of adult content
98 | - **Age Verification**: Robust age verification system
99 | - **Customizable Content**: User preferences for content intensity and themes
100 | - **Privacy Controls**: Enhanced privacy features for adult content
101 | 
102 | ### User Management
103 | - **Authentication**: Supabase Auth with email/password
104 | - **Profiles**: User preferences and adult content settings
105 | - **Subscriptions**: Stripe-powered payment system
106 | - **Usage Tracking**: Story and voice credit limits
107 | 
108 | ## Development Workflow
109 | 
110 | ### Local Development
111 | ```bash
112 | # Install dependencies
113 | npm install
114 | 
115 | # Start development server
116 | npm run dev
117 | 
118 | # Build for production
119 | npm run build:prod
120 | 
121 | # Preview production build
122 | npm run start:prod
123 | ```
124 | 
125 | ### Key Commands
126 | - `npm run dev` - Start development server (localhost:8080)
127 | - `npm run build` - Build for production
128 | - `npm run lint` - Run ESLint
129 | - `npm run deploy` - Build and start production server
130 | 
131 | ### Environment Setup
132 | Required environment variables:
133 | - `VITE_SUPABASE_URL` - Supabase project URL
134 | - `VITE_SUPABASE_ANON_KEY` - Supabase anonymous key
135 | - `VITE_STRIPE_PUBLISHABLE_KEY` - Stripe publishable key
136 | - `VITE_ELEVENLABS_API_KEY` - ElevenLabs API key
137 | 
138 | ## Architecture Patterns
139 | 
140 | ### State Management
141 | - **Zustand stores** for global state
142 | - **Store separation** by domain (user, character, stories, etc.)
143 | - **Persistence** with localStorage for offline support
144 | - **Sync queue** for offline-first data handling
145 | 
146 | ### Service Layer
147 | - **Abstraction layer** between UI and backend
148 | - **Edge Function wrappers** for AI services
149 | - **Direct database access** with RLS security
150 | - **Error handling** with standardized response format
151 | 
152 | ### Component Architecture
153 | - **Atomic design** with reusable components
154 | - **Page-based routing** with React Router
155 | - **Custom hooks** for shared logic
156 | - **TypeScript** for type safety
157 | 
158 | ## Database Schema
159 | 
160 | ### Main Tables
161 | - `profiles` - User profiles with language settings and adult content preferences (free-text field for tastes, kinks, etc.)
162 | - `characters` - Simplified custom characters with only name, gender, and description
163 | - `stories` - Generated stories with metadata, including story_format ('single' or 'episodic'), flexible genre field, and cover_image_url for future use
164 | - `story_chapters` - Individual story chapters (used for stories marked as 'episodic')
165 | - `audio_files` - Generated audio recordings
166 | - `user_voices` - Voice preferences
167 | - `preset_suggestions` - Story prompt presets for generation
168 | 
169 | ### Security
170 | - **Row Level Security (RLS)** on all tables
171 | - **User-based access control**
172 | - **Secure API key management** in Edge Functions
173 | 
174 | ### SQL Documentation
175 | **IMPORTANT**: `/docs/sql_supabase.sql` is the **canonical reference** for the database schema. This is the definitive migration script that contains:
176 | - Complete table definitions and structure
177 | - All RLS policies and permissions
178 | - Database enums and constraints
179 | - The exact SQL to be executed in Supabase SQL Editor
180 | 
181 | **Development Guidelines**:
182 | - **Always refer to** `/docs/sql_supabase.sql` for any SQL-related queries or modifications
183 | - **Do NOT modify** this file unless absolutely necessary for new functionality
184 | - This script is designed to be executed in the Supabase SQL Editor to apply changes remotely
185 | - Other SQL files in `/docs/` may be outdated and should be considered legacy
186 | 
187 | Legacy files (may be outdated):
188 | - `/docs/supabase_tables.sql` - Legacy table definitions
189 | - `/docs/supabase_RLS.sql` - Legacy RLS policies
190 | 
191 | ## Testing
192 | 
193 | **Note**: Currently no test framework is configured. The project uses:
194 | - Manual testing in development
195 | - TypeScript for compile-time validation
196 | - ESLint for code quality
197 | - Production monitoring for runtime issues
198 | 
199 | ## Deployment
200 | 
201 | ### Production Setup
202 | - **PM2** for process management
203 | - **Nginx** reverse proxy (not included in repo)
204 | - **Environment variables** for configuration
205 | - **Supabase Edge Functions** for serverless compute
206 | 
207 | ### PM2 Configuration
208 | ```javascript
209 | // ecosystem.config.cjs
210 | {
211 |   name: "cuenta-cuentos",
212 |   script: "npm",
213 |   args: "run start:prod",
214 |   env: {
215 |     NODE_ENV: "production",
216 |     PORT: "8080"
217 |   }
218 | }
219 | ```
220 | 
221 | ## Development Guidelines
222 | 
223 | ### Transformation Rules
224 | 1. **Think First**: Read codebase for relevant files, write plan to tasks/todo.md
225 | 2. **Check Before Working**: Always verify plan with user before implementation
226 | 3. **High-Level Updates**: Give brief explanations of changes made
227 | 4. **Simple Changes**: Make every task as simple as possible, minimal code impact
228 | 5. **Review Documentation**: Add review section to todo.md with change summary
229 | 
230 | ### Project Transformation Context
231 | - **Content Migration**: Transform from children's stories to adult erotic content
232 | - **Language Migration**: Gradually change from Spanish to English (new features in English)
233 | - **Architecture Migration**: Replace Zustand local store with direct Supabase queries
234 | - **Simplicity Focus**: Avoid massive or complex changes, every change should be incremental
235 | 
236 | ### Code Style
237 | - **TypeScript strict mode** enabled
238 | - **ESLint** configuration with React rules
239 | - **Consistent naming** (camelCase for JS, snake_case for DB)
240 | - **Component organization** by feature/domain
241 | - **English-first approach** for new functions and components
242 | 
243 | ### Best Practices
244 | - **Prefer editing** existing files over creating new ones
245 | - **Use absolute imports** with `@/` alias
246 | - **Handle errors** gracefully with user feedback
247 | - **Implement loading states** for async operations
248 | - **Follow Tailwind CSS** utility-first approach
249 | - **Direct Supabase integration** for new features (avoid Zustand dependency)
250 | 
251 | ### State Management Migration
252 | - **Legacy**: Zustand stores with localStorage persistence
253 | - **Target**: Direct Supabase queries with real-time subscriptions
254 | - **Approach**: Gradual migration, maintain existing patterns during transition
255 | - **New Features**: Extract data directly from Supabase, don't use local stores
256 | 
257 | ## API Integration
258 | 
259 | ### Edge Functions
260 | - `generate-story` - AI adult story generation with mature themes
261 | - `story-continuation` - Story continuation options for adult narratives
262 | - `generate-audio` - Text-to-speech conversion with sensual voices
263 | - `upload-story-image` - Adult content image generation and storage (Currently Deactivated)
264 | - Stripe functions for payment processing
265 | 
266 | ### External APIs
267 | - **OpenAI** - GPT models and TTS
268 | - **Google Generative AI** - Gemini models
269 | - **Stripe** - Payment processing
270 | - **ElevenLabs** - Voice synthesis
271 | 
272 | ## Common Issues & Solutions
273 | 
274 | ### Authentication
275 | - **Race conditions** handled with auth guards
276 | - **Session management** through Supabase client
277 | - **Redirect handling** for auth callbacks
278 | 
279 | ### Performance
280 | - **Lazy loading** for route components
281 | - **Image optimization** with proper formats
282 | - **Audio streaming** for large files
283 | - **State persistence** to avoid refetching
284 | 
285 | ### Offline Support
286 | - **Sync queue** for failed operations
287 | - **localStorage persistence** for critical data
288 | - **Network detection** for connectivity changes
289 | 
290 | ## Transformation Roadmap
291 | 
292 | ### Phase 1: Content Migration (Current)
293 | - **Story Generation**: Update prompts for adult content
294 | - **Character System**: ✅ Completed - Simplified to name, gender, and description
295 | - **Content Warnings**: Implement age verification and content warnings
296 | - **Language**: Begin Spanish to English migration
297 | 
298 | ### Phase 2: Architecture Migration
299 | - **State Management**: Replace Zustand with direct Supabase queries
300 | - **Real-time Features**: Implement Supabase real-time subscriptions
301 | - **Database Optimization**: Optimize for adult content storage and retrieval
302 | 
303 | ### Phase 3: Enhanced Features
304 | - **Advanced Personalization**: AI-driven content customization
305 | - **Community Features**: User-generated content and sharing
306 | - **Enhanced Privacy**: Advanced privacy controls for adult platform
307 | 
308 | ### Current Technical Debt
309 | - **Spanish Language Content**: Systematic translation needed
310 | - **Zustand Dependencies**: Local storage elimination required
311 | - **Component Localization**: Adult content UI adaptations needed
312 | - **Image Generation**: Re-enable functionality when ready for production
313 | 
314 | ## Implementation Guidelines
315 | 
316 | ### Adult Content Considerations
317 | - **Content Moderation**: Implement appropriate content filtering
318 | - **Privacy First**: Enhanced privacy features for sensitive content
319 | - **Age Verification**: Robust verification system
320 | - **Content Warnings**: Clear labeling of content types and intensity
321 | 
322 | ### Migration Strategy
323 | - **Incremental Changes**: Small, focused updates
324 | - **Backward Compatibility**: Maintain existing functionality during transition
325 | - **Testing**: Manual testing for each change
326 | - **Documentation**: Update docs as changes are implemented
327 | 
328 | ---
329 | 
330 | **Last Updated**: January 2025  
331 | **Version**: 1.1.4  
332 | **Transformation Status**: Phase 1 - Content Migration  
333 | **Maintainer**: Development Team
334 | 
335 | For detailed implementation guides, see the `/docs` directory and `/tasks/todo.md`.
```

GEMINI.md
```
1 | # CLAUDE.md
2 | 
3 | This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
4 | 
5 | ## Project Overview
6 | 
7 | **Fantasia** is undergoing transformation from a children's storytelling application to an adult-oriented erotic content platform. The project generates personalized stories with voice narration and interactive elements, now targeting mature audiences with sophisticated adult themes.
8 | 
9 | **Current Version**: 1.1.4  
10 | **Main Branch**: master  
11 | **Project Type**: Single Page Application (SPA)  
12 | **Target Audience**: Adults (18+)  
13 | **Content Focus**: Adult erotic literature and interactive experiences  
14 | **Language**: English (migrating from Spanish)
15 | 
16 | ## Technology Stack
17 | 
18 | ### Frontend
19 | - **React 18.3.1** with TypeScript
20 | - **Vite** for build tooling and development server
21 | - **Tailwind CSS** for styling with custom configuration
22 | - **shadcn/ui** component library (extensive Radix UI components)
23 | - **Framer Motion** for animations and transitions
24 | - **Zustand** for state management
25 | - **React Router DOM** for navigation
26 | - **React Hook Form** with Zod validation
27 | - **TanStack Query** for server state management
28 | 
29 | ### Backend & Services
30 | - **Supabase** as Backend-as-a-Service (BaaS)
31 |   - Authentication and user management
32 |   - PostgreSQL database with Row Level Security (RLS)
33 |   - Edge Functions for serverless compute
34 |   - File storage for audio and images
35 | - **OpenAI** for AI-powered story generation and TTS
36 | - **Google Generative AI** (Gemini) for story generation
37 | - **Stripe** for payment processing and subscriptions
38 | - **ElevenLabs** for voice synthesis (via API)
39 | 
40 | ### Development Tools
41 | - **TypeScript** with strict configuration
42 | - **ESLint** with React and TypeScript rules
43 | - **PostCSS** with Tailwind CSS
44 | - **PM2** for production deployment
45 | - **Bun** as package manager (with npm fallback)
46 | 
47 | ## Project Structure
48 | 
49 | ```
50 | FantasIA/
51 | ├── src/
52 | │   ├── components/           # Reusable UI components
53 | │   │   ├── ui/              # shadcn/ui components (~49 files)
54 | │   │   └── [various].tsx    # App-specific components
55 | │   ├── pages/               # Route-based page components
56 | │   ├── services/            # API integration layer
57 | │   │   ├── ai/             # AI service wrappers
58 | │   │   └── [various].ts    # Database and third-party services
59 | │   ├── store/              # Zustand state management
60 | │   │   ├── character/      # Character management
61 | │   │   ├── stories/        # Story-related state
62 | │   │   ├── user/           # User profile and auth
63 | │   │   └── core/           # Store utilities
64 | │   ├── hooks/              # Custom React hooks
65 | │   ├── lib/                # Utility functions
66 | │   ├── types/              # TypeScript type definitions
67 | │   └── config/             # App configuration
68 | ├── supabase/
69 | │   ├── functions/          # Edge Functions
70 | │   ├── migrations/         # Database migrations
71 | │   └── sql-functions/      # Database functions
72 | ├── docs/                   # Project documentation
73 | └── public/                 # Static assets
74 | ```
75 | 
76 | ## Key Features
77 | 
78 | ### Story Generation
79 | - **Personalized Adult Stories**: AI-generated erotic tales based on character preferences, kinks, and interests
80 | - **Chapter System**: Multi-chapter stories with continuation options
81 | - **Story Format Choice**: Users can choose between 'single' self-contained stories or 'episodic' stories designed for multiple chapters
82 | - **Multiple Genres**: Romance, BDSM, fantasy, contemporary, etc.
83 | - **Character Customization**: Name, gender ('male', 'female', 'non-binary'), and free-text description
84 | 
85 | ### Audio Features
86 | - **Text-to-Speech**: Professional voice narration using OpenAI TTS with sensual voices
87 | - **Multiple Voices**: Different personality-matched voices for adult content
88 | - **Audio Player**: Custom audio player with progress tracking
89 | - **Voice Preview**: Sample voices before selection
90 | 
91 | ### Image Generation
92 | - **Currently Deactivated**: Image generation functionality is temporarily disabled
93 | - **Database Ready**: The schema includes a 'cover_image_url' field in the 'stories' table for future implementation
94 | - **Planned Features**: DALL-E 3 integration for story illustrations, cover images, and character portraits
95 | 
96 | ### Adult Content Features
97 | - **Content Warnings**: Appropriate warnings for different types of adult content
98 | - **Age Verification**: Robust age verification system
99 | - **Customizable Content**: User preferences for content intensity and themes
100 | - **Privacy Controls**: Enhanced privacy features for adult content
101 | 
102 | ### User Management
103 | - **Authentication**: Supabase Auth with email/password
104 | - **Profiles**: User preferences and adult content settings
105 | - **Subscriptions**: Stripe-powered payment system
106 | - **Usage Tracking**: Story and voice credit limits
107 | 
108 | ## Development Workflow
109 | 
110 | ### Local Development
111 | ```bash
112 | # Install dependencies
113 | npm install
114 | 
115 | # Start development server
116 | npm run dev
117 | 
118 | # Build for production
119 | npm run build:prod
120 | 
121 | # Preview production build
122 | npm run start:prod
123 | ```
124 | 
125 | ### Key Commands
126 | - `npm run dev` - Start development server (localhost:8080)
127 | - `npm run build` - Build for production
128 | - `npm run lint` - Run ESLint
129 | - `npm run deploy` - Build and start production server
130 | 
131 | ### Environment Setup
132 | Required environment variables:
133 | - `VITE_SUPABASE_URL` - Supabase project URL
134 | - `VITE_SUPABASE_ANON_KEY` - Supabase anonymous key
135 | - `VITE_STRIPE_PUBLISHABLE_KEY` - Stripe publishable key
136 | - `VITE_ELEVENLABS_API_KEY` - ElevenLabs API key
137 | 
138 | ## Architecture Patterns
139 | 
140 | ### State Management
141 | - **Zustand stores** for global state
142 | - **Store separation** by domain (user, character, stories, etc.)
143 | - **Persistence** with localStorage for offline support
144 | - **Sync queue** for offline-first data handling
145 | 
146 | ### Service Layer
147 | - **Abstraction layer** between UI and backend
148 | - **Edge Function wrappers** for AI services
149 | - **Direct database access** with RLS security
150 | - **Error handling** with standardized response format
151 | 
152 | ### Component Architecture
153 | - **Atomic design** with reusable components
154 | - **Page-based routing** with React Router
155 | - **Custom hooks** for shared logic
156 | - **TypeScript** for type safety
157 | 
158 | ## Database Schema
159 | 
160 | ### Main Tables
161 | - `profiles` - User profiles with language settings and adult content preferences (free-text field for tastes, kinks, etc.)
162 | - `characters` - Simplified custom characters with only name, gender, and description
163 | - `stories` - Generated stories with metadata, including story_format ('single' or 'episodic'), flexible genre field, and cover_image_url for future use
164 | - `story_chapters` - Individual story chapters (used for stories marked as 'episodic')
165 | - `audio_files` - Generated audio recordings
166 | - `user_voices` - Voice preferences
167 | - `preset_suggestions` - Story prompt presets for generation
168 | 
169 | ### Security
170 | - **Row Level Security (RLS)** on all tables
171 | - **User-based access control**
172 | - **Secure API key management** in Edge Functions
173 | 
174 | ### SQL Documentation
175 | **IMPORTANT**: `/docs/sql_supabase.sql` is the **canonical reference** for the database schema. This is the definitive migration script that contains:
176 | - Complete table definitions and structure
177 | - All RLS policies and permissions
178 | - Database enums and constraints
179 | - The exact SQL to be executed in Supabase SQL Editor
180 | 
181 | **Development Guidelines**:
182 | - **Always refer to** `/docs/sql_supabase.sql` for any SQL-related queries or modifications
183 | - **Do NOT modify** this file unless absolutely necessary for new functionality
184 | - This script is designed to be executed in the Supabase SQL Editor to apply changes remotely
185 | - Other SQL files in `/docs/` may be outdated and should be considered legacy
186 | 
187 | Legacy files (may be outdated):
188 | - `/docs/supabase_tables.sql` - Legacy table definitions
189 | - `/docs/supabase_RLS.sql` - Legacy RLS policies
190 | 
191 | ## Testing
192 | 
193 | **Note**: Currently no test framework is configured. The project uses:
194 | - Manual testing in development
195 | - TypeScript for compile-time validation
196 | - ESLint for code quality
197 | - Production monitoring for runtime issues
198 | 
199 | ## Deployment
200 | 
201 | ### Production Setup
202 | - **PM2** for process management
203 | - **Nginx** reverse proxy (not included in repo)
204 | - **Environment variables** for configuration
205 | - **Supabase Edge Functions** for serverless compute
206 | 
207 | ### PM2 Configuration
208 | ```javascript
209 | // ecosystem.config.cjs
210 | {
211 |   name: "cuenta-cuentos",
212 |   script: "npm",
213 |   args: "run start:prod",
214 |   env: {
215 |     NODE_ENV: "production",
216 |     PORT: "8080"
217 |   }
218 | }
219 | ```
220 | 
221 | ## Development Guidelines
222 | 
223 | ### Transformation Rules
224 | 1. **Think First**: Read codebase for relevant files, write plan to tasks/todo.md
225 | 2. **Check Before Working**: Always verify plan with user before implementation
226 | 3. **High-Level Updates**: Give brief explanations of changes made
227 | 4. **Simple Changes**: Make every task as simple as possible, minimal code impact
228 | 5. **Review Documentation**: Add review section to todo.md with change summary
229 | 
230 | ### Project Transformation Context
231 | - **Content Migration**: Transform from children's stories to adult erotic content
232 | - **Language Migration**: Gradually change from Spanish to English (new features in English)
233 | - **Architecture Migration**: Replace Zustand local store with direct Supabase queries
234 | - **Simplicity Focus**: Avoid massive or complex changes, every change should be incremental
235 | 
236 | ### Code Style
237 | - **TypeScript strict mode** enabled
238 | - **ESLint** configuration with React rules
239 | - **Consistent naming** (camelCase for JS, snake_case for DB)
240 | - **Component organization** by feature/domain
241 | - **English-first approach** for new functions and components
242 | 
243 | ### Best Practices
244 | - **Prefer editing** existing files over creating new ones
245 | - **Use absolute imports** with `@/` alias
246 | - **Handle errors** gracefully with user feedback
247 | - **Implement loading states** for async operations
248 | - **Follow Tailwind CSS** utility-first approach
249 | - **Direct Supabase integration** for new features (avoid Zustand dependency)
250 | 
251 | ### State Management Migration
252 | - **Legacy**: Zustand stores with localStorage persistence
253 | - **Target**: Direct Supabase queries with real-time subscriptions
254 | - **Approach**: Gradual migration, maintain existing patterns during transition
255 | - **New Features**: Extract data directly from Supabase, don't use local stores
256 | 
257 | ## API Integration
258 | 
259 | ### Edge Functions
260 | - `generate-story` - AI adult story generation with mature themes
261 | - `story-continuation` - Story continuation options for adult narratives
262 | - `generate-audio` - Text-to-speech conversion with sensual voices
263 | - `upload-story-image` - Adult content image generation and storage (Currently Deactivated)
264 | - Stripe functions for payment processing
265 | 
266 | ### External APIs
267 | - **OpenAI** - GPT models and TTS
268 | - **Google Generative AI** - Gemini models
269 | - **Stripe** - Payment processing
270 | - **ElevenLabs** - Voice synthesis
271 | 
272 | ## Common Issues & Solutions
273 | 
274 | ### Authentication
275 | - **Race conditions** handled with auth guards
276 | - **Session management** through Supabase client
277 | - **Redirect handling** for auth callbacks
278 | 
279 | ### Performance
280 | - **Lazy loading** for route components
281 | - **Image optimization** with proper formats
282 | - **Audio streaming** for large files
283 | - **State persistence** to avoid refetching
284 | 
285 | ### Offline Support
286 | - **Sync queue** for failed operations
287 | - **localStorage persistence** for critical data
288 | - **Network detection** for connectivity changes
289 | 
290 | ## Transformation Roadmap
291 | 
292 | ### Phase 1: Content Migration (Current)
293 | - **Story Generation**: Update prompts for adult content
294 | - **Character System**: ✅ Completed - Simplified to name, gender, and description
295 | - **Content Warnings**: Implement age verification and content warnings
296 | - **Language**: Begin Spanish to English migration
297 | 
298 | ### Phase 2: Architecture Migration
299 | - **State Management**: Replace Zustand with direct Supabase queries
300 | - **Real-time Features**: Implement Supabase real-time subscriptions
301 | - **Database Optimization**: Optimize for adult content storage and retrieval
302 | 
303 | ### Phase 3: Enhanced Features
304 | - **Advanced Personalization**: AI-driven content customization
305 | - **Community Features**: User-generated content and sharing
306 | - **Enhanced Privacy**: Advanced privacy controls for adult platform
307 | 
308 | ### Current Technical Debt
309 | - **Spanish Language Content**: Systematic translation needed
310 | - **Zustand Dependencies**: Local storage elimination required
311 | - **Component Localization**: Adult content UI adaptations needed
312 | - **Image Generation**: Re-enable functionality when ready for production
313 | 
314 | ## Implementation Guidelines
315 | 
316 | ### Adult Content Considerations
317 | - **Content Moderation**: Implement appropriate content filtering
318 | - **Privacy First**: Enhanced privacy features for sensitive content
319 | - **Age Verification**: Robust verification system
320 | - **Content Warnings**: Clear labeling of content types and intensity
321 | 
322 | ### Migration Strategy
323 | - **Incremental Changes**: Small, focused updates
324 | - **Backward Compatibility**: Maintain existing functionality during transition
325 | - **Testing**: Manual testing for each change
326 | - **Documentation**: Update docs as changes are implemented
327 | 
328 | ---
329 | 
330 | **Last Updated**: January 2025  
331 | **Version**: 1.1.4  
332 | **Transformation Status**: Phase 1 - Content Migration  
333 | **Maintainer**: Development Team
334 | 
335 | For detailed implementation guides, see the `/docs` directory and `/tasks/todo.md`.
```

components.json
```
1 | {
2 |   "$schema": "https://ui.shadcn.com/schema.json",
3 |   "style": "default",
4 |   "rsc": false,
5 |   "tsx": true,
6 |   "tailwind": {
7 |     "config": "tailwind.config.ts",
8 |     "css": "src/index.css",
9 |     "baseColor": "slate",
10 |     "cssVariables": true,
11 |     "prefix": ""
12 |   },
13 |   "aliases": {
14 |     "components": "@/components",
15 |     "utils": "@/lib/utils",
16 |     "ui": "@/components/ui",
17 |     "lib": "@/lib",
18 |     "hooks": "@/hooks"
19 |   }
20 | }
```

debug-edge-function.js
```
1 | // Script de depuración para probar la función edge de generación de títulos
2 | import { createClient } from '@supabase/supabase-js';
3 | 
4 | // Configuración de Supabase (usar las mismas credenciales que en el proyecto)
5 | const supabaseUrl = 'https://vgzhkvnrutesdynrrlpm.supabase.co';
6 | const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnemhrdm5ydXRlc2R5bnJybHBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MDc4NzksImV4cCI6MjA2NzQ4Mzg3OX0.cjWfW_GdhQpiF_-hq6IcoWNEDLx2Yncqe8Bx0DqvW3E';
7 | const supabase = createClient(supabaseUrl, supabaseKey);
8 | 
9 | // Función para probar la generación de títulos
10 | async function testGenerateTitle() {
11 |   console.log('Probando generación de títulos...');
12 |   
13 |   try {
14 |     // Contenido de ejemplo para generar un título
15 |     const sampleContent = `Había una vez un pequeño conejo llamado Tito que vivía en el bosque. A Tito le gustaba explorar y descubrir nuevos lugares. Un día, mientras saltaba entre los arbustos, encontró una madriguera que nunca antes había visto. Era extraña y misteriosa, con un brillo tenue que salía desde su interior.`;
16 |     
17 |     console.log('Enviando solicitud a la Edge Function story-continuation (generateTitle)...');
18 |     
19 |     const { data, error } = await supabase.functions.invoke('story-continuation', {
20 |       body: {
21 |         action: 'generateTitle',
22 |         content: sampleContent
23 |       }
24 |     });
25 |     
26 |     if (error) {
27 |       console.error('Error en Edge Function:', error);
28 |       return;
29 |     }
30 |     
31 |     // Mostrar la respuesta completa para depuración
32 |     console.log('Respuesta completa:', JSON.stringify(data, null, 2));
33 |     
34 |     if (data && data.title) {
35 |       console.log('Título generado correctamente:', data.title);
36 |     } else {
37 |       console.error('La respuesta no contiene un título:', data);
38 |     }
39 |   } catch (error) {
40 |     console.error('Error al ejecutar la prueba:', error);
41 |   }
42 | }
43 | 
44 | // Ejecutar la prueba
45 | testGenerateTitle(); 
```

deno.lock
```
1 | {
2 |   "version": "5",
3 |   "redirects": {
4 |     "https://esm.sh/@supabase/node-fetch@^2.6.14?target=denonext": "https://esm.sh/@supabase/node-fetch@2.6.15?target=denonext",
5 |     "https://esm.sh/bufferutil@^4.0.1?target=denonext": "https://esm.sh/bufferutil@4.0.9?target=denonext",
6 |     "https://esm.sh/node-gyp-build@^4.3.0?target=denonext": "https://esm.sh/node-gyp-build@4.8.4?target=denonext",
7 |     "https://esm.sh/tr46@~0.0.3?target=denonext": "https://esm.sh/tr46@0.0.3?target=denonext",
8 |     "https://esm.sh/utf-8-validate@%3E=5.0.2?target=denonext": "https://esm.sh/utf-8-validate@6.0.5?target=denonext",
9 |     "https://esm.sh/webidl-conversions@^3.0.0?target=denonext": "https://esm.sh/webidl-conversions@3.0.1?target=denonext",
10 |     "https://esm.sh/whatwg-url@^5.0.0?target=denonext": "https://esm.sh/whatwg-url@5.0.0?target=denonext",
11 |     "https://esm.sh/ws@^8.14.2?target=denonext": "https://esm.sh/ws@8.18.1?target=denonext"
12 |   },
13 |   "remote": {
14 |     "https://esm.sh/@supabase/functions-js@2.1.5/denonext/functions-js.mjs": "e6c31ad2262a84ed55da33f4a253a9ec5cd5cc41a6b4393b5ab9b0a108a2e9a8",
15 |     "https://esm.sh/@supabase/gotrue-js@2.62.2/denonext/gotrue-js.mjs": "d3dd1c95a023b518efab9fc1fb8fa172458864a4e0f4a95b5e77f8a0df526054",
16 |     "https://esm.sh/@supabase/node-fetch@2.6.15/denonext/node-fetch.mjs": "0bae9052231f4f6dbccc7234d05ea96923dbf967be12f402764580b6bf9f713d",
17 |     "https://esm.sh/@supabase/node-fetch@2.6.15?target=denonext": "4d28c4ad97328403184353f68434f2b6973971507919e9150297413664919cf3",
18 |     "https://esm.sh/@supabase/postgrest-js@1.9.2/denonext/postgrest-js.mjs": "216c149bc04130518774d10fcf2df5d1c1369d985fee7fe942840f6f77459e27",
19 |     "https://esm.sh/@supabase/realtime-js@2.9.3/denonext/realtime-js.mjs": "aac782e4fcf8d2e2f4b2592f566a0324b19b0262a2938a0c8ce546c681faef14",
20 |     "https://esm.sh/@supabase/storage-js@2.5.5/denonext/storage-js.mjs": "a952ba6fdc889a4ae8d671ce4d1a152702c1caa3158eb2269a0208b091856075",
21 |     "https://esm.sh/@supabase/supabase-js@2.39.8": "5cb81f5217dda9564abd7d7d6211484d30441d41a113954d5904bcd0ef1007e0",
22 |     "https://esm.sh/@supabase/supabase-js@2.39.8/denonext/supabase-js.mjs": "1a4d0e38fed110fef252639a51247066a642e855794bea026efb26e5ed55abd8",
23 |     "https://esm.sh/bufferutil@4.0.9/denonext/bufferutil.mjs": "13dca4d5bb2c68cbe119f880fa3bd785b9a81a8e02e0834dae604b4b85295cd8",
24 |     "https://esm.sh/bufferutil@4.0.9?target=denonext": "e32574569ab438facfcc3f412c659b0719bbf05477136ca176938c9a3ac45125",
25 |     "https://esm.sh/node-gyp-build@4.8.4/denonext/node-gyp-build.mjs": "9a86f2d044fc77bd60aaa3d697c2ba1b818da5fb1b9aaeedec59a40b8e908803",
26 |     "https://esm.sh/node-gyp-build@4.8.4?target=denonext": "261a6cedf1fdbf159798141ba1e2311ac1510682c5c8b55dacc8cf5fdee4aa06",
27 |     "https://esm.sh/tr46@0.0.3/denonext/tr46.mjs": "5753ec0a99414f4055f0c1f97691100f13d88e48a8443b00aebb90a512785fa2",
28 |     "https://esm.sh/tr46@0.0.3?target=denonext": "19cb9be0f0d418a0c3abb81f2df31f080e9540a04e43b0f699bce1149cba0cbb",
29 |     "https://esm.sh/utf-8-validate@6.0.5/denonext/utf-8-validate.mjs": "66b8ea532a0c745068f5b96ddb1bae332c3036703243541d2e89e66331974d98",
30 |     "https://esm.sh/utf-8-validate@6.0.5?target=denonext": "071bc33ba1a58297e23a34d69dd589fd06df04b0f373b382ff5da544a623f271",
31 |     "https://esm.sh/webidl-conversions@3.0.1/denonext/webidl-conversions.mjs": "54b5c2d50a294853c4ccebf9d5ed8988c94f4e24e463d84ec859a866ea5fafec",
32 |     "https://esm.sh/webidl-conversions@3.0.1?target=denonext": "4e20318d50528084616c79d7b3f6e7f0fe7b6d09013bd01b3974d7448d767e29",
33 |     "https://esm.sh/whatwg-url@5.0.0/denonext/whatwg-url.mjs": "29b16d74ee72624c915745bbd25b617cfd2248c6af0f5120d131e232a9a9af79",
34 |     "https://esm.sh/whatwg-url@5.0.0?target=denonext": "f001a2cadf81312d214ca330033f474e74d81a003e21e8c5d70a1f46dc97b02d",
35 |     "https://esm.sh/ws@8.18.1/denonext/ws.mjs": "732cae76ba0acb311a561003d2f7ef569293cb9159d67dd800ab346b84f80432",
36 |     "https://esm.sh/ws@8.18.1?target=denonext": "e99b670fc49b38e15a7576ddcd5bb01e123fe9b3a017db7f97898127811b4e27"
37 |   },
38 |   "workspace": {
39 |     "packageJson": {
40 |       "dependencies": [
41 |         "npm:@eslint/js@^9.9.0",
42 |         "npm:@google/generative-ai@0.24",
43 |         "npm:@hookform/resolvers@^3.9.0",
44 |         "npm:@radix-ui/react-accordion@^1.2.0",
45 |         "npm:@radix-ui/react-alert-dialog@^1.1.1",
46 |         "npm:@radix-ui/react-aspect-ratio@^1.1.0",
47 |         "npm:@radix-ui/react-avatar@^1.1.0",
48 |         "npm:@radix-ui/react-checkbox@^1.1.1",
49 |         "npm:@radix-ui/react-collapsible@^1.1.0",
50 |         "npm:@radix-ui/react-context-menu@^2.2.1",
51 |         "npm:@radix-ui/react-dialog@^1.1.2",
52 |         "npm:@radix-ui/react-dropdown-menu@^2.1.1",
53 |         "npm:@radix-ui/react-hover-card@^1.1.1",
54 |         "npm:@radix-ui/react-label@^2.1.0",
55 |         "npm:@radix-ui/react-menubar@^1.1.1",
56 |         "npm:@radix-ui/react-navigation-menu@^1.2.0",
57 |         "npm:@radix-ui/react-popover@^1.1.1",
58 |         "npm:@radix-ui/react-progress@^1.1.0",
59 |         "npm:@radix-ui/react-radio-group@^1.2.0",
60 |         "npm:@radix-ui/react-scroll-area@^1.1.0",
61 |         "npm:@radix-ui/react-select@^2.1.1",
62 |         "npm:@radix-ui/react-separator@^1.1.0",
63 |         "npm:@radix-ui/react-slider@^1.2.0",
64 |         "npm:@radix-ui/react-slot@^1.1.0",
65 |         "npm:@radix-ui/react-switch@^1.1.0",
66 |         "npm:@radix-ui/react-tabs@^1.1.0",
67 |         "npm:@radix-ui/react-toast@^1.2.1",
68 |         "npm:@radix-ui/react-toggle-group@^1.1.0",
69 |         "npm:@radix-ui/react-toggle@^1.1.0",
70 |         "npm:@radix-ui/react-tooltip@^1.1.4",
71 |         "npm:@stripe/stripe-js@7",
72 |         "npm:@supabase/supabase-js@^2.49.3",
73 |         "npm:@tailwindcss/typography@~0.5.15",
74 |         "npm:@tanstack/react-query@^5.56.2",
75 |         "npm:@types/howler@^2.2.12",
76 |         "npm:@types/node@^22.5.5",
77 |         "npm:@types/react-dom@^18.3.0",
78 |         "npm:@types/react@^18.3.3",
79 |         "npm:@types/uuid@10",
80 |         "npm:@vitejs/plugin-react-swc@^3.5.0",
81 |         "npm:autoprefixer@^10.4.20",
82 |         "npm:class-variance-authority@~0.7.1",
83 |         "npm:clsx@^2.1.1",
84 |         "npm:cmdk@1",
85 |         "npm:date-fns@^3.6.0",
86 |         "npm:embla-carousel-react@^8.3.0",
87 |         "npm:eslint-plugin-react-hooks@^5.1.0-rc.0",
88 |         "npm:eslint-plugin-react-refresh@~0.4.9",
89 |         "npm:eslint@^9.9.0",
90 |         "npm:framer-motion@^10.16.4",
91 |         "npm:globals@^15.9.0",
92 |         "npm:howler@^2.2.4",
93 |         "npm:html2canvas@^1.4.1",
94 |         "npm:input-otp@^1.2.4",
95 |         "npm:jspdf@^3.0.1",
96 |         "npm:lovable-tagger@^1.1.7",
97 |         "npm:lucide-react@0.462",
98 |         "npm:next-themes@0.3",
99 |         "npm:openai@^4.104.0",
100 |         "npm:postcss@^8.4.47",
101 |         "npm:react-day-picker@^8.10.1",
102 |         "npm:react-dom@^18.3.1",
103 |         "npm:react-hook-form@^7.53.0",
104 |         "npm:react-resizable-panels@^2.1.3",
105 |         "npm:react-router-dom@^6.26.2",
106 |         "npm:react@^18.3.1",
107 |         "npm:recharts@^2.12.7",
108 |         "npm:sonner@^1.7.4",
109 |         "npm:tailwind-merge@^2.5.2",
110 |         "npm:tailwindcss-animate@^1.0.7",
111 |         "npm:tailwindcss@^3.4.11",
112 |         "npm:typescript-eslint@^8.0.1",
113 |         "npm:typescript@^5.5.3",
114 |         "npm:uuid@^11.1.0",
115 |         "npm:vaul@~0.9.3",
116 |         "npm:vite@^5.4.1",
117 |         "npm:zod@^3.23.8",
118 |         "npm:zustand@^4.5.6"
119 |       ]
120 |     }
121 |   }
122 | }
```

deploy-pm2.sh
```
1 | #!/bin/bash
2 | set -e
3 | 
4 | # Messages colors
5 | GREEN='\033[0;32m'
6 | YELLOW='\033[1;33m'
7 | RED='\033[0;31m'
8 | NC='\033[0m' # No Color
9 | 
10 | echo -e "${GREEN}=== Starting production deployment with PM2 ===${NC}"
11 | 
12 | # Verify if pm2 is installed
13 | if ! command -v pm2 &> /dev/null; then
14 |     echo -e "${YELLOW}PM2 is not installed. Installing globally...${NC}"
15 |     npm install -g pm2
16 | fi
17 | 
18 | # Verify if .env file exists
19 | if [ ! -f .env.production ]; then
20 |     echo -e "${YELLOW}File .env not found. Copying from .env.example...${NC}"
21 |     if [ -f .env.example ]; then
22 |         cp .env.example .env
23 |         echo -e "${YELLOW}¡Copied! Please edit the .env file with your real credentials before continuing.${NC}"
24 |         exit 1
25 |     else
26 |         echo -e "${RED}File .env.example not found. Please create a .env file manually.${NC}"
27 |         exit 1
28 |     fi
29 | fi
30 | 
31 | # Install dependencies
32 | echo -e "${GREEN}Installing dependencies...${NC}"
33 | npm ci
34 | 
35 | # Build the application
36 | echo -e "${GREEN}Building the application for production...${NC}"
37 | npm run build:prod
38 | 
39 | # Stop previous instance in PM2 (if exists)
40 | echo -e "${GREEN}Stopping previous instance (if exists)...${NC}"
41 | pm2 delete cuenta-cuentos 2>/dev/null || true
42 | 
43 | # Start with PM2
44 | echo -e "${GREEN}Starting the application with PM2...${NC}"
45 | pm2 start ecosystem.config.cjs --env production
46 | 
47 | # Save PM2 configuration
48 | echo -e "${GREEN}Saving PM2 configuration...${NC}"
49 | pm2 save
50 | 
51 | # Show status
52 | echo -e "${GREEN}Showing application status...${NC}"
53 | pm2 status
54 | 
55 | echo -e "${GREEN}=== Deployment completed ===${NC}"
56 | echo -e "${GREEN}The application is available at: http://localhost:80${NC}"
57 | echo -e "${YELLOW}To see the logs: pm2 logs cuenta-cuentos${NC}"
58 | echo -e "${YELLOW}To stop the application: pm2 stop cuenta-cuentos${NC}"
59 | echo -e "${YELLOW}To restart the application: pm2 restart cuenta-cuentos${NC}"
60 | echo -e "${YELLOW}To monitor resources: pm2 monit${NC}" 
```

ecosystem.config.cjs
```
1 | module.exports = {
2 |   apps: [
3 |     {
4 |       name: "cuenta-cuentos",
5 |       script: "npm",
6 |       args: "run start:prod",
7 |       env: {
8 |         NODE_ENV: "production",
9 |         PORT: "8080"
10 |       },
11 |       instances: 1,
12 |       exec_mode: "fork",
13 |       watch: false,
14 |       max_memory_restart: "1G",
15 |       env_production: {
16 |         NODE_ENV: "production"
17 |       }
18 |     }
19 |   ]
20 | } 
```

eslint.config.js
```
1 | import js from "@eslint/js";
2 | import globals from "globals";
3 | import reactHooks from "eslint-plugin-react-hooks";
4 | import reactRefresh from "eslint-plugin-react-refresh";
5 | import tseslint from "typescript-eslint";
6 | 
7 | export default tseslint.config(
8 |   { ignores: ["dist"] },
9 |   {
10 |     extends: [js.configs.recommended, ...tseslint.configs.recommended],
11 |     files: ["**/*.{ts,tsx}"],
12 |     languageOptions: {
13 |       ecmaVersion: 2020,
14 |       globals: globals.browser,
15 |     },
16 |     plugins: {
17 |       "react-hooks": reactHooks,
18 |       "react-refresh": reactRefresh,
19 |     },
20 |     rules: {
21 |       ...reactHooks.configs.recommended.rules,
22 |       "react-refresh/only-export-components": [
23 |         "warn",
24 |         { allowConstantExport: true },
25 |       ],
26 |       "@typescript-eslint/no-unused-vars": "off",
27 |     },
28 |   }
29 | );
```

index.html
```
1 | <!DOCTYPE html>
2 | <html lang="en">
3 | 
4 | <head>
5 |   <meta charset="UTF-8" />
6 |   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
7 |   <title>Fantasia</title>
8 |   <meta name="description" content="Fantasia - Adult erotic stories powered by AI" />
9 |   <meta name="author" content="" />
10 |   
11 |   <!-- Favicon configuración -->
12 |   <link rel="icon" href="/favicon_v2.png" />
13 |   <link rel="apple-touch-icon" href="/favicon_v2.png" />
14 |   <link rel="shortcut icon" type="image/png" href="/favicon_v2.png" />
15 |   <meta property="og:image" content="/favicon_v2.png" />
16 |   <meta name="theme-color" content="#ffffff" />
17 |   
18 |   <link rel="preconnect" href="https://fonts.googleapis.com">
19 |   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
20 |   <link
21 |     href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap"
22 |     rel="stylesheet">
23 | </head>
24 | 
25 | <body>
26 |   <div id="root"></div>
27 |   <script type="module" src="/src/main.tsx"></script>
28 | </body>
29 | 
30 | </html>
```

package.json
```
1 | {
2 |   "name": "vite_react_shadcn_ts",
3 |   "private": true,
4 |   "version": "0.0.0",
5 |   "type": "module",
6 |   "scripts": {
7 |     "dev": "vite",
8 |     "build": "vite build",
9 |     "build:dev": "vite build --mode development",
10 |     "build:prod": "vite build --mode production",
11 |     "start": "vite preview --host --port 8080",
12 |     "start:prod": "NODE_ENV=production vite preview --host --port 8080",
13 |     "deploy": "npm run build:prod && npm run start:prod",
14 |     "lint": "eslint .",
15 |     "preview": "vite preview"
16 |   },
17 |   "dependencies": {
18 |     "@google/generative-ai": "^0.24.0",
19 |     "@hookform/resolvers": "^3.9.0",
20 |     "@radix-ui/react-accordion": "^1.2.0",
21 |     "@radix-ui/react-alert-dialog": "^1.1.1",
22 |     "@radix-ui/react-aspect-ratio": "^1.1.0",
23 |     "@radix-ui/react-avatar": "^1.1.0",
24 |     "@radix-ui/react-checkbox": "^1.1.1",
25 |     "@radix-ui/react-collapsible": "^1.1.0",
26 |     "@radix-ui/react-context-menu": "^2.2.1",
27 |     "@radix-ui/react-dialog": "^1.1.2",
28 |     "@radix-ui/react-dropdown-menu": "^2.1.1",
29 |     "@radix-ui/react-hover-card": "^1.1.1",
30 |     "@radix-ui/react-label": "^2.1.0",
31 |     "@radix-ui/react-menubar": "^1.1.1",
32 |     "@radix-ui/react-navigation-menu": "^1.2.0",
33 |     "@radix-ui/react-popover": "^1.1.1",
34 |     "@radix-ui/react-progress": "^1.1.0",
35 |     "@radix-ui/react-radio-group": "^1.2.0",
36 |     "@radix-ui/react-scroll-area": "^1.1.0",
37 |     "@radix-ui/react-select": "^2.1.1",
38 |     "@radix-ui/react-separator": "^1.1.0",
39 |     "@radix-ui/react-slider": "^1.2.0",
40 |     "@radix-ui/react-slot": "^1.1.0",
41 |     "@radix-ui/react-switch": "^1.1.0",
42 |     "@radix-ui/react-tabs": "^1.1.0",
43 |     "@radix-ui/react-toast": "^1.2.1",
44 |     "@radix-ui/react-toggle": "^1.1.0",
45 |     "@radix-ui/react-toggle-group": "^1.1.0",
46 |     "@radix-ui/react-tooltip": "^1.1.4",
47 |     "@stripe/stripe-js": "^7.0.0",
48 |     "@supabase/supabase-js": "^2.49.3",
49 |     "@tanstack/react-query": "^5.56.2",
50 |     "@types/howler": "^2.2.12",
51 |     "@types/uuid": "^10.0.0",
52 |     "class-variance-authority": "^0.7.1",
53 |     "clsx": "^2.1.1",
54 |     "cmdk": "^1.0.0",
55 |     "date-fns": "^3.6.0",
56 |     "embla-carousel-react": "^8.3.0",
57 |     "framer-motion": "^10.16.4",
58 |     "howler": "^2.2.4",
59 |     "html2canvas": "^1.4.1",
60 |     "input-otp": "^1.2.4",
61 |     "jspdf": "^3.0.1",
62 |     "lucide-react": "^0.462.0",
63 |     "next-themes": "^0.3.0",
64 |     "openai": "^4.104.0",
65 |     "react": "^18.3.1",
66 |     "react-day-picker": "^8.10.1",
67 |     "react-dom": "^18.3.1",
68 |     "react-hook-form": "^7.53.0",
69 |     "react-resizable-panels": "^2.1.3",
70 |     "react-router-dom": "^6.26.2",
71 |     "recharts": "^2.12.7",
72 |     "sonner": "^1.7.4",
73 |     "tailwind-merge": "^2.5.2",
74 |     "tailwindcss-animate": "^1.0.7",
75 |     "uuid": "^11.1.0",
76 |     "vaul": "^0.9.3",
77 |     "zod": "^3.23.8",
78 |     "zustand": "^4.5.6"
79 |   },
80 |   "devDependencies": {
81 |     "@eslint/js": "^9.9.0",
82 |     "@tailwindcss/typography": "^0.5.15",
83 |     "@types/node": "^22.5.5",
84 |     "@types/react": "^18.3.3",
85 |     "@types/react-dom": "^18.3.0",
86 |     "@vitejs/plugin-react-swc": "^3.5.0",
87 |     "autoprefixer": "^10.4.20",
88 |     "eslint": "^9.9.0",
89 |     "eslint-plugin-react-hooks": "^5.1.0-rc.0",
90 |     "eslint-plugin-react-refresh": "^0.4.9",
91 |     "globals": "^15.9.0",
92 |     "lovable-tagger": "^1.1.7",
93 |     "postcss": "^8.4.47",
94 |     "tailwindcss": "^3.4.11",
95 |     "typescript": "^5.5.3",
96 |     "typescript-eslint": "^8.0.1",
97 |     "vite": "^5.4.1"
98 |   }
99 | }
```

postcss.config.cjs
```
1 | module.exports = {
2 |   plugins: {
3 |     tailwindcss: {},
4 |     autoprefixer: {},
5 |   },
6 | } 
```

tailwind.config.ts
```
1 | import type { Config } from "tailwindcss";
2 | 
3 | export default {
4 | 	darkMode: ["class"],
5 | 	content: [
6 | 		"./pages/**/*.{ts,tsx}",
7 | 		"./components/**/*.{ts,tsx}",
8 | 		"./app/**/*.{ts,tsx}",
9 | 		"./src/**/*.{ts,tsx}",
10 | 	],
11 | 	prefix: "",
12 | 	theme: {
13 | 		container: {
14 | 			center: true,
15 | 			padding: '2rem',
16 | 			screens: {
17 | 				'2xl': '1400px'
18 | 			}
19 | 		},
20 | 		extend: {
21 | 			fontFamily: {
22 | 				sans: ['Open Sans', 'ui-sans-serif', 'system-ui', 'sans-serif'],
23 | 				heading: ['Quicksand', 'ui-sans-serif', 'system-ui', 'sans-serif'],
24 | 			},
25 | 			colors: {
26 | 				'brand': {
27 | 					'pink': '#FDDDE3',      // Rosa Base
28 | 					'purple': '#BB79D1',    // Morado
29 | 					'blue': '#7DC4E0',      // Azul Claro
30 | 					'yellow': '#F9DA60',    // Amarillo
31 | 				},
32 | 				border: 'hsl(var(--border))',
33 | 				input: 'hsl(var(--input))',
34 | 				ring: 'hsl(var(--ring))',
35 | 				background: '#FFFBF5',       // Un blanco muy suave con tinte rosa/amarillo
36 | 				foreground: 'hsl(var(--foreground))',
37 | 				primary: {
38 | 					DEFAULT: '#BB79D1',     // Morado como primario
39 | 					foreground: 'hsl(var(--primary-foreground))'
40 | 				},
41 | 				secondary: {
42 | 					DEFAULT: '#7DC4E0',     // Azul como secundario
43 | 					foreground: 'hsl(var(--secondary-foreground))'
44 | 				},
45 | 				destructive: {
46 | 					DEFAULT: 'hsl(var(--destructive))',
47 | 					foreground: 'hsl(var(--destructive-foreground))'
48 | 				},
49 | 				muted: {
50 | 					DEFAULT: 'hsl(var(--muted))',
51 | 					foreground: 'hsl(var(--muted-foreground))'
52 | 				},
53 | 				accent: {
54 | 					DEFAULT: '#F9DA60',     // Amarillo como acento
55 | 					foreground: 'hsl(var(--accent-foreground))'
56 | 				},
57 | 				popover: {
58 | 					DEFAULT: 'hsl(var(--popover))',
59 | 					foreground: 'hsl(var(--popover-foreground))'
60 | 				},
61 | 				card: {
62 | 					DEFAULT: '#FFFFFF',     // Blanco puro para tarjetas
63 | 					foreground: 'hsl(var(--card-foreground))'
64 | 				},
65 | 				'text-primary': '#4A4A4A',  // Gris oscuro para texto principal
66 | 				'text-secondary': '#757575', // Gris medio para texto secundario
67 | 				story: {
68 | 					purple: {
69 | 						DEFAULT: '#3F2E5D',
70 | 						50: '#F5F2FA',
71 | 						100: '#EBE6F5',
72 | 						200: '#D7CCE9',
73 | 						300: '#C3B3DE',
74 | 						400: '#AF99D2',
75 | 						500: '#9B80C7',
76 | 						600: '#8767BB',
77 | 						700: '#6E4CA6',
78 | 						800: '#563C82',
79 | 						900: '#3F2E5D',
80 | 						950: '#302246'
81 | 					},
82 | 					orange: {
83 | 						DEFAULT: '#F4A261',
84 | 						50: '#FEF5EE',
85 | 						100: '#FDEADC',
86 | 						200: '#FBCFAF',
87 | 						300: '#F9B383',
88 | 						400: '#F4A261',
89 | 						500: '#F08430',
90 | 						600: '#DD6A10',
91 | 						700: '#A64F0C',
92 | 						800: '#6F3608',
93 | 						900: '#371A04'
94 | 					},
95 | 					blue: {
96 | 						DEFAULT: '#457B9D',
97 | 						50: '#E9F0F4',
98 | 						100: '#D3E1E8',
99 | 						200: '#A7C3D1',
100 | 						300: '#7BAABF',
101 | 						400: '#5692AE',
102 | 						500: '#457B9D',
103 | 						600: '#345C75',
104 | 						700: '#233E4E',
105 | 						800: '#111F26',
106 | 						900: '#06090B'
107 | 					},
108 | 				}
109 | 			},
110 | 			borderRadius: {
111 | 				lg: 'var(--radius)',
112 | 				md: 'calc(var(--radius) - 2px)',
113 | 				sm: 'calc(var(--radius) - 4px)'
114 | 			},
115 | 			keyframes: {
116 | 				'accordion-down': {
117 | 					from: { height: '0' },
118 | 					to: { height: 'var(--radix-accordion-content-height)' }
119 | 				},
120 | 				'accordion-up': {
121 | 					from: { height: 'var(--radix-accordion-content-height)' },
122 | 					to: { height: '0' }
123 | 				},
124 | 				'fade-in': {
125 | 					'0%': { opacity: '0', transform: 'translateY(10px)' },
126 | 					'100%': { opacity: '1', transform: 'translateY(0)' }
127 | 				},
128 | 				'fade-out': {
129 | 					'0%': { opacity: '1', transform: 'translateY(0)' },
130 | 					'100%': { opacity: '0', transform: 'translateY(10px)' }
131 | 				},
132 | 				'scale-in': {
133 | 					'0%': { transform: 'scale(0.95)', opacity: '0' },
134 | 					'100%': { transform: 'scale(1)', opacity: '1' }
135 | 				},
136 | 				'scale-out': {
137 | 					from: { transform: 'scale(1)', opacity: '1' },
138 | 					to: { transform: 'scale(0.95)', opacity: '0' }
139 | 				},
140 | 				'slide-in-right': {
141 | 					'0%': { transform: 'translateX(100%)' },
142 | 					'100%': { transform: 'translateX(0)' }
143 | 				},
144 | 				'slide-out-right': {
145 | 					'0%': { transform: 'translateX(0)' },
146 | 					'100%': { transform: 'translateX(100%)' }
147 | 				},
148 | 				'pulse-subtle': {
149 | 					'0%, 100%': { opacity: '1' },
150 | 					'50%': { opacity: '0.8' }
151 | 				},
152 | 				'float': {
153 | 					'0%, 100%': { transform: 'translateY(0)' },
154 | 					'50%': { transform: 'translateY(-5px)' }
155 | 				}
156 | 			},
157 | 			animation: {
158 | 				'accordion-down': 'accordion-down 0.2s ease-out',
159 | 				'accordion-up': 'accordion-up 0.2s ease-out',
160 | 				'fade-in': 'fade-in 0.5s ease-out',
161 | 				'fade-out': 'fade-out 0.5s ease-out',
162 | 				'scale-in': 'scale-in 0.3s ease-out',
163 | 				'scale-out': 'scale-out 0.3s ease-out',
164 | 				'slide-in-right': 'slide-in-right 0.3s ease-out',
165 | 				'slide-out-right': 'slide-out-right 0.3s ease-out',
166 | 				'pulse-subtle': 'pulse-subtle 2s infinite ease-in-out',
167 | 				'float': 'float 3s infinite ease-in-out'
168 | 			}
169 | 		}
170 | 	},
171 | 	plugins: [require("tailwindcss-animate")],
172 | } satisfies Config;
```

tsconfig.app.json
```
1 | {
2 |   "compilerOptions": {
3 |     "target": "ES2020",
4 |     "useDefineForClassFields": true,
5 |     "lib": ["ES2020", "DOM", "DOM.Iterable"],
6 |     "module": "ESNext",
7 |     "skipLibCheck": true,
8 | 
9 |     /* Bundler mode */
10 |     "moduleResolution": "bundler",
11 |     "allowImportingTsExtensions": true,
12 |     "isolatedModules": true,
13 |     "moduleDetection": "force",
14 |     "noEmit": true,
15 |     "jsx": "react",
16 | 
17 |     /* Linting */
18 |     "strict": false,
19 |     "noUnusedLocals": false,
20 |     "noUnusedParameters": false,
21 |     "noImplicitAny": false,
22 |     "noFallthroughCasesInSwitch": false,
23 | 
24 |     "baseUrl": ".",
25 |     "paths": {
26 |       "@/*": ["./src/*"]
27 |     }
28 |   },
29 |   "include": ["src"]
30 | }
```

tsconfig.json
```
1 | {
2 |   "files": [],
3 |   "references": [
4 |     { "path": "./tsconfig.app.json" },
5 |     { "path": "./tsconfig.node.json" }
6 |   ],
7 |   "compilerOptions": {
8 |     "baseUrl": ".",
9 |     "paths": {
10 |       "@/*": ["./src/*"]
11 |     },
12 |     "noImplicitAny": false,
13 |     "noUnusedParameters": false,
14 |     "skipLibCheck": true,
15 |     "allowJs": true,
16 |     "noUnusedLocals": false,
17 |     "strictNullChecks": false
18 |   }
19 | }
```

tsconfig.node.json
```
1 | {
2 |   "compilerOptions": {
3 |     "target": "ES2022",
4 |     "lib": ["ES2023"],
5 |     "module": "ESNext",
6 |     "skipLibCheck": true,
7 | 
8 |     /* Bundler mode */
9 |     "moduleResolution": "bundler",
10 |     "allowImportingTsExtensions": true,
11 |     "isolatedModules": true,
12 |     "moduleDetection": "force",
13 |     "noEmit": true,
14 | 
15 |     /* Linting */
16 |     "strict": true,
17 |     "noUnusedLocals": false,
18 |     "noUnusedParameters": false,
19 |     "noFallthroughCasesInSwitch": true
20 |   },
21 |   "include": ["vite.config.ts"]
22 | }
```

vite.config.ts
```
1 | import { defineConfig, loadEnv } from "vite";
2 | import react from "@vitejs/plugin-react-swc";
3 | import path from "path";
4 | import { componentTagger } from "lovable-tagger";
5 | 
6 | // https://vitejs.dev/config/
7 | export default defineConfig(({ mode }) => {
8 |   // Cargar variables de entorno
9 |   const env = loadEnv(mode, process.cwd(), '');
10 |   
11 |   return {
12 |     server: {
13 |       host: "::",
14 |       port: 8080,
15 |     },
16 |     plugins: [
17 |       react(),
18 |       mode === 'development' &&
19 |       componentTagger(),
20 |     ].filter(Boolean),
21 |     resolve: {
22 |       alias: {
23 |         "@": path.resolve(__dirname, "./src"),
24 |       },
25 |     },
26 |     envDir: './',
27 |     envPrefix: 'VITE_',
28 |     define: {
29 |       'process.env.VITE_ELEVENLABS_API_KEY': JSON.stringify(env.VITE_ELEVENLABS_API_KEY),
30 |     }
31 |   };
32 | });
```

.claude/settings.local.json
```
1 | {
2 |   "permissions": {
3 |     "allow": [
4 |       "Bash(rg:*)",
5 |       "Bash(grep:*)",
6 |       "Bash(npx vite:*)",
7 |       "Bash(npx tsc:*)",
8 |       "mcp__ide__getDiagnostics",
9 |       "Bash(npm install)",
10 |       "Bash(npm run:*)",
11 |       "Bash(rm:*)",
12 |       "Bash(timeout 10 npm run dev)",
13 |       "Bash(gtimeout:*)",
14 |       "Bash(npx eslint:*)",
15 |       "Bash(true)"
16 |     ],
17 |     "deny": []
18 |   }
19 | }
```

docs/PAUTAS_DE_DISENO.md
```
1 | # Pautas de Diseño UI/UX – FantasIA
2 | 
3 | ## ⚠️ DISCLAIMER IMPORTANTE: PRESERVACIÓN DE FUNCIONALIDAD
4 | 
5 | **EXTREMADAMENTE IMPORTANTE: Al aplicar estas pautas de diseño, NUNCA se debe alterar la funcionalidad existente.**
6 | 
7 | - **Mantener toda la lógica intacta:** Al rediseñar componentes, solo modificar aspectos visuales (colores, espaciado, tipografía, etc.).
8 | - **No eliminar ni añadir botones:** La cantidad y tipo de elementos interactivos debe permanecer exactamente igual.
9 | - **Preservar todos los estados:** Asegurarse de que estados como hover, active, disabled, loading, etc. sigan funcionando correctamente.
10 | - **No modificar manejadores de eventos:** Las funciones onClick, onChange y similares deben permanecer intactas.
11 | - **Mantener la estructura de datos:** No alterar la forma en que se almacenan o procesan los datos.
12 | - **Respetar los permisos y restricciones:** Los bloqueos para usuarios free/premium deben seguir funcionando igual.
13 | 
14 | El objetivo es **ÚNICAMENTE mejorar la apariencia visual** manteniendo toda la funcionalidad existente. Cualquier cambio que afecte el comportamiento de la aplicación está estrictamente prohibido.
15 | 
16 | ## 1. Identidad Visual
17 | - **Logotipo:** Utiliza siempre el logotipo oficial en sus variantes de color y fondo según el manual de marca.
18 | - **Iconografía:** Usa los iconos oficiales de FantasIA, preferiblemente en formato SVG o PNG de alta calidad.
19 | 
20 | ## 2. Paleta de Colores
21 | Utiliza la paleta oficial para todos los elementos de la interfaz:
22 | - **Rosa:** #F6A5B7  (principal, botones primarios)
23 | - **Morado:** #BB79D1  (acentos, fondos suaves)
24 | - **Celeste:** #A5D6F6  (botones secundarios, fondos)
25 | - **Amarillo:** #F9DA60  (acentos, detalles)
26 | - **Lavanda:** #E6B7D9  (fondos suaves, tarjetas)
27 | - **Azul Claro:** #7DC4E0  (fondos, detalles)
28 | 
29 | ## 3. Tipografía
30 | - **Principal (encabezados):** Quicksand, bold y semibold.
31 | - **Secundaria (texto):** Open Sans, regular y semibold.
32 | - **Tamaños:**
33 |   - Títulos: grandes y llamativos.
34 |   - Botones: medianos, legibles y en mayúsculas si aplica.
35 | 
36 | ## 4. Estilo Visual
37 | - **Fondo:** Gradientes pastel, nubes y estrellas decorativas (preferentemente SVG o PNG).
38 | - **Botones:**
39 |   - Grandes, redondeados (`border-radius: 24px` o más).
40 |   - Colores sólidos de la paleta, texto blanco.
41 |   - Sombra suave y efecto hover.
42 | - **Componentes:**
43 |   - Bordes suaves y esquinas redondeadas.
44 |   - Espaciado generoso y aireado.
45 | 
46 | ## 5. Uso de Imágenes y Decoraciones
47 | - **Logo y fondo:** Siempre centrados, con espacio suficiente.
48 | - **Ilustraciones:** Usa las oficiales del manual de marca.
49 | - **No sobrecargar:** Mantén la interfaz limpia y amigable.
50 | 
51 | ## 6. Accesibilidad
52 | - Contraste suficiente entre texto y fondo.
53 | - Botones grandes y fácilmente tocables.
54 | - Texto legible y jerarquías claras.
55 | 
56 | ## 7. Tono y Estilo de Comunicación
57 | - Moderno, amigable, imaginativo.
58 | - Mensajes claros, positivos y cercanos.
59 | 
60 | ## 8. Distribución del Espacio
61 | - **Agrupación de elementos:** Mantén juntos los elementos relacionados.
62 | - **Espaciado vertical:** 
63 |   - Reduce espacios entre logo y contenido principal (usar `mt-4 mb-0` y `py-0`).
64 |   - Asegura suficiente espacio entre el contenido y el borde inferior (usar `mb-10` para botones inferiores).
65 | - **Estructura de página:** Usa contenedores flex con `min-h-[80vh]` y `justify-between` para distribuir el espacio.
66 | - **Jerarquía visual:** Elementos importantes más grandes y con mayor contraste.
67 | 
68 | ## 9. Preservación de Funcionalidad
69 | - **⚠️ EXTREMADAMENTE IMPORTANTE: Nunca eliminar botones ni cambiar funcionalidades existentes.**
70 | - Todos los botones y elementos interactivos deben preservarse en el rediseño.
71 | - Si un botón existe en la versión original, debe existir en la versión rediseñada.
72 | - Mantener la misma navegación y flujos de usuario que en la versión original.
73 | - Solo se permite mejorar el aspecto visual, no modificar comportamientos.
74 | 
75 | ## 10. Legibilidad
76 | - Usar fondos con opacidad adecuada (40-50% para fondos de tarjetas).
77 | - Texto principal en colores oscuros de la paleta (#BB79D1).
78 | - Texto secundario en colores contrastantes (#7DC4E0).
79 | - Usar `font-bold` para elementos importantes y `font-medium` para mejorar legibilidad.
80 | 
81 | ## 11. Legibilidad y Uso de Colores en Texto
82 | - **Regla general:** Siempre prioriza el contraste entre texto y fondo para garantizar la legibilidad.
83 | 
84 | ### Cuándo usar cada color:
85 | - **Texto principal en tarjetas o bloques claros (fondos blancos, lavanda, pastel):**
86 |   - Usa **gris oscuro** (`#222` o `#333`) para el texto principal. Esto asegura máxima legibilidad en fondos claros/pastel.
87 |   - Ejemplo: títulos, frases clave, información principal.
88 | - **Números, datos clave o acentos:**
89 |   - Usa colores de la paleta para resaltar: rosa (`#F6A5B7`), amarillo (`#F9DA60`), azul claro (`#7DC4E0`), morado (`#BB79D1`).
90 |   - Ejemplo: “8 / 10”, precios, alertas.
91 | - **Iconos:**
92 |   - Usa el color corporativo correspondiente según el contexto (ej. morado para elementos generales, azul para info, rosa para acciones, amarillo para alertas positivas).
93 | - **Texto secundario o descripciones:**
94 |   - Usa azul claro (`#7DC4E0`) o morado claro, siempre que el fondo sea suficientemente claro.
95 | 
96 | ### Fondos:
97 | - **Tarjetas y bloques de información:**
98 |   - Usa fondo blanco translúcido (`bg-white/70` o `#fff9`), lavanda muy clara o pastel con suficiente opacidad.
99 |   - Nunca uses fondo morado medio con texto morado o azul claro encima.
100 |   - Si el fondo es pastel/morado claro y el texto no se lee bien, sube la opacidad del fondo o cambia el texto a gris oscuro.
101 | 
102 | ### Reglas de contraste:
103 | - **No usar negro puro** (`#000`) salvo casos extremos de accesibilidad. Prefiere gris oscuro.
104 | - **Evita morado sobre morado y azul sobre morado claro**: el contraste es insuficiente.
105 | - **Para alertas o mensajes críticos:**
106 |   - Usa fondo claro y texto oscuro o viceversa, nunca dos colores de baja diferencia de luminosidad.
107 | 
108 | ### Sombra de texto:
109 | - Puedes añadir `text-shadow: 0 1px 4px rgba(187, 121, 209, 0.15);` para separar el texto del fondo en fondos translúcidos o pastel.
110 | 
111 | ### Resumen de buenas prácticas:
112 | - Texto principal: gris oscuro (`#222`), nunca morado/azul claro sobre pastel/morado claro.
113 | - Números/acento: color de la paleta.
114 | - Iconos: color de la paleta según contexto.
115 | - Fondos: blanco translúcido, pastel claro, suficiente opacidad.
116 | - Sombra de texto para mejorar legibilidad si es necesario.
117 | 
118 | ## 12. Consistencia Visual y Matices Aprendidos
119 | 
120 | ### Fondo general de la aplicación
121 | - **Siempre usar el mismo fondo:** Utiliza `public/fondo_png.png` en todas las pantallas principales.
122 | - **Modo de aplicación:** Aplica el fondo usando `style` con las siguientes propiedades para evitar zoom excesivo o repetición:
123 |   ```jsx
124 |   style={{
125 |     backgroundImage: 'url(/fondo_png.png)',
126 |     backgroundSize: 'cover',
127 |     backgroundPosition: 'center',
128 |     backgroundRepeat: 'no-repeat',
129 |   }}
130 |   ```
131 | - **No uses clases como `bg-cover` si no garantizan el mismo comportamiento cross-browser.**
132 | 
133 | ### Tarjetas y bloques de información
134 | - **Fondo:** Usa `bg-white/40` (blanco translúcido) para tarjetas y bloques principales, con `rounded-3xl`, borde pastel (`border-[#BB79D1]/20`) y sombra suave.
135 | - **No uses blanco sólido salvo en menús desplegables o casos de legibilidad crítica.**
136 | - **No uses translúcido en dropdowns:** Los menús desplegables deben ser `bg-white` sólido para máxima legibilidad.
137 | 
138 | ### Menús desplegables (selects)
139 | - **Fondo:** `bg-white` sólido, nunca translúcido.
140 | - **Borde:** Pastel (`border-[#BB79D1]/40`), sombra y esquinas redondeadas.
141 | - **Texto:** Siempre oscuro (`#222`).
142 | - **Focus:** Fondo morado translúcido suave (`focus:bg-[#BB79D1]/20`).
143 | 
144 | ### Consistencia de colores para cada elemento
145 | - **Texto principal:** Gris oscuro (`#222` o `#333`) en tarjetas, formularios y menús.
146 | - **Números/acento:** Usa la paleta oficial:
147 |   - Rosa (`#F6A5B7`): para cantidades, estados destacados.
148 |   - Amarillo (`#F9DA60`): para edades, avisos positivos.
149 |   - Azul claro (`#7DC4E0`): para descripciones, textos secundarios.
150 |   - Morado (`#BB79D1`): para títulos, iconos principales y acentos.
151 | - **Iconos:** Color de la paleta según contexto (ejemplo: azul para info, rosa para acciones, amarillo para alertas, morado para elementos generales).
152 | 
153 | ### Legibilidad y contraste
154 | - **Nunca uses texto morado o azul claro sobre fondo morado claro o pastel:** El contraste es insuficiente.
155 | - **No uses negro puro:** Prefiere gris oscuro.
156 | - **En menús y tarjetas, prioriza la legibilidad sobre la estética pastel.**
157 | 
158 | ### Resumen de buenas prácticas
159 | - Fondo uniforme y sin zoom excesivo.
160 | - Tarjetas translúcidas, menús sólidos.
161 | - Colores coherentes para cada tipo de elemento.
162 | - Máxima legibilidad en todos los contextos.
163 | 
164 | ## 13. Patrones de Diseño Específicos
165 | 
166 | ### Fondos y Contenedores
167 | 
168 | #### Fondo Principal
169 | - **Cuándo usar**: En todas las pantallas principales de la aplicación.
170 | - **Implementación**: 
171 |   ```jsx
172 |   style={{
173 |     backgroundImage: 'url(/fondo_png.png)',
174 |     backgroundSize: 'cover',
175 |     backgroundPosition: 'center',
176 |     backgroundRepeat: 'no-repeat',
177 |   }}
178 |   ```
179 | - **Razón**: Proporciona una identidad visual consistente y un ambiente acogedor para la aplicación de cuentos.
180 | 
181 | #### Contenedores de Información
182 | - **Cuándo usar**: Para agrupar información relacionada (textos explicativos, preguntas).
183 | - **Implementación**: Fondo blanco con opacidad 70-80% (`bg-white/70` o `bg-white/80`), bordes redondeados (`rounded-xl`), sombra suave.
184 | - **Razón**: Mejora la legibilidad del texto sobre el fondo decorativo, manteniendo la estética general.
185 | 
186 | ### Tarjetas de Selección
187 | 
188 | #### Estilo Base
189 | - **Implementación**: 
190 |   - Fondo blanco con opacidad 70% (`bg-white/70`)
191 |   - Bordes redondeados amplios (`rounded-2xl`)
192 |   - Bordes coloreados según su contenido (`border-2 border-[#COLOR]/60`)
193 |   - Sombra suave para elevación visual
194 |   - Transiciones suaves para interacciones
195 | 
196 | #### Estados Interactivos
197 | - **Normal**: Fondo blanco translúcido, icono colorido, texto oscuro para máxima legibilidad.
198 | - **Hover**: Ligero tinte del color temático (`hover:bg-[#COLOR]/10`), aumento de escala (`hover:scale-105`), sombra mejorada.
199 | - **Seleccionado**: Anillo de color destacado (`ring-4 ring-[#COLOR]`), sombra más prominente, escala ligeramente aumentada.
200 | 
201 | ### Código de Colores Funcionales
202 | 
203 | - **Rosa (#F6A5B7)**: Para elementos primarios, acciones principales, duración corta.
204 | - **Amarillo (#F9DA60)**: Para alertas positivas, elementos medios, duración media.
205 | - **Azul Claro (#7DC4E0)**: Para información, elementos secundarios, duración larga.
206 | - **Morado (#BB79D1)**: Para navegación, títulos, botones de avance en el flujo.
207 | 
208 | ### Botones de Acción
209 | 
210 | #### Botones Principales (como "Continuar")
211 | - **Implementación**: 
212 |   ```jsx
213 |   <div className="flex justify-center w-full">
214 |     <button className="w-full max-w-xs py-4 rounded-2xl text-white text-lg font-semibold 
215 |                       shadow-lg bg-[#BB79D1] hover:bg-[#BB79D1]/90 
216 |                       border-2 border-[#BB79D1]/50 transition-all duration-200">
217 |       Texto del botón
218 |     </button>
219 |   </div>
220 |   ```
221 | - **Razón**: Destacan visualmente como puntos de acción principales, manteniendo coherencia con el flujo de la aplicación.
222 | 
223 | #### Botón de Retroceso
224 | - **Implementación**: 
225 |   ```jsx
226 |   <button className="absolute top-6 left-6 w-12 h-12 flex items-center justify-center 
227 |                     rounded-full bg-white shadow-lg border-2 border-[#BB79D1]/60 
228 |                     text-[#BB79D1] hover:bg-[#BB79D1]/10 hover:text-[#7DC4E0] 
229 |                     focus:ring-4 focus:ring-[#BB79D1]/30 transition-all duration-300 z-20">
230 |     <ChevronLeft size={28} />
231 |   </button>
232 |   ```
233 | - **Razón**: Proporciona una forma consistente de navegación hacia atrás sin competir visualmente con el contenido principal.
234 | 
235 | ### Consideraciones para Pantallas de Selección
236 | 
237 | 1. **Uso de colores diferenciados por opción**: Cada opción debe tener su propio color de la paleta para crear asociación visual y facilitar la identificación.
238 | 
239 | 2. **Mayor opacidad en fondos de tarjetas** (70% en lugar de 40%): Mejora significativamente la legibilidad del texto mientras mantiene la estética translúcida.
240 | 
241 | 3. **Texto oscuro en lugar de blanco para tarjetas**: Siguiendo las pautas de legibilidad, el texto oscuro (`text-[#222]`) sobre fondo claro proporciona mejor contraste.
242 | 
243 | 4. **Estados visuales claros**: Los estados normal, hover y seleccionado deben tener diferencias visuales significativas pero coherentes.
244 | 
245 | 5. **Botones de acción centrados y con ancho controlado**: Seguir el patrón de los botones principales de la Home, creando consistencia en la experiencia de usuario.
246 | 
247 | ---
248 | 
249 | _Última actualización: 17 de abril de 2025_
250 | 
251 | ---
252 | 
253 | **Referencia:**
254 | Estas pautas se basan en el manual de marca oficial de FantasIA (ver imágenes adjuntas en docs/manual_marca.png o docs/manual_marca.pdf si están disponibles).
255 | 
256 | ---
257 | 
258 | _Actualiza este documento si el manual de marca evoluciona o hay nuevas directrices de diseño._
```

docs/Stripe_integration.md
```
1 | # Guía Detallada: Integración de Stripe en Web App con Supabase (Cuenta Cuentos)
2 | 
3 | **Documento creado para:**
4 | 
5 | *   Servir como referencia detallada del proceso de integración de Stripe.
6 | *   Facilitar la consulta y resolución de dudas sobre la implementación.
7 | *   Proporcionar una guía paso a paso para la futura implementación de Stripe en aplicaciones similares.
8 | 
9 | **Versión:** 1.1 (Actualizado para reflejar manejo de creación de personajes sin límite)
10 | **Fecha:** 2024-04-03
11 | 
12 | ---
13 | 
14 | ## 1. Introducción
15 | 
16 | Este documento describe el proceso completo para integrar **Stripe** como pasarela de pagos en una aplicación web (Cuenta Cuentos) que utiliza **Supabase** como backend y **Vite** como framework frontend. La integración permite:
17 | 
18 | *   **Suscripción Premium:** Venta de un plan de suscripción mensual recurrente.
19 | *   **Compra de Créditos:** Venta de paquetes de créditos de voz (pago único).
20 | *   **Gestión de Suscripción:** Permite a los usuarios gestionar sus suscripciones (cancelar, actualizar método de pago) a través del **Stripe Customer Portal**.
21 | 
22 | La implementación se basa en **Stripe Checkout**, **Supabase Edge Functions** para la lógica segura del backend y **Stripe Webhooks** para mantener la sincronización del estado.
23 | 
24 | ---
25 | 
26 | ## 2. Prerrequisitos
27 | 
28 | *   **Cuenta de Stripe:** Activa ([https://stripe.com/](https://stripe.com)). Usar **modo de prueba** durante el desarrollo.
29 | *   **Proyecto Supabase:** Funcional (Base de datos, Auth, Edge Functions habilitadas).
30 | *   **CLI de Supabase:** Instalada y configurada.
31 | *   **CLI de Stripe (Opcional):** Útil para pruebas básicas.
32 | *   **Entorno Frontend:** Configurado (Vite).
33 | *   **Variables de Entorno/Secretos de Supabase Configurados:** (Ver paso 3.2).
34 | 
35 | ---
36 | 
37 | ## 3. Configuración Inicial
38 | 
39 | ### 3.1. Configuración de Productos y Precios en Stripe
40 | 
41 | 1.  **Accede al Dashboard de Stripe** (modo de prueba).
42 | 2.  **Crea Productos:**
43 |     *   Navega a "Productos" > "Catálogo de productos" > "+ Añadir producto".
44 |     *   **Producto 1: Suscripción Premium**
45 |         *   Nombre: "Plan Premium Cuenta Cuentos"
46 |         *   Modelo: "Periódico", Mensual, Precio (ej. 10 USD).
47 |         *   Guarda. Anota **ID Producto (`prod_...`)** y **ID Precio (`price_...`)**.
48 |     *   **Producto 2: Créditos de Voz**
49 |         *   Nombre: "Paquete Créditos de Voz"
50 |         *   Modelo: "Pago único", Precio (ej. 5 USD).
51 |         *   Guarda. Anota **ID Producto (`prod_...`)** y **ID Precio (`price_...`)**.
52 | 
53 | ### 3.2. Configuración de Secretos en Supabase
54 | 
55 | Usa la CLI de Supabase (`supabase secrets set <NOMBRE>=<VALOR>`):
56 | 
57 | ```bash
58 | # Clave secreta de Stripe
59 | supabase secrets set STRIPE_SECRET_KEY=sk_test_xxxxxxxxxxxx
60 | 
61 | # Clave publicable de Stripe (Prefijo VITE_ para Vite)
62 | supabase secrets set VITE_STRIPE_PUBLISHABLE_KEY=pk_test_zzzzzzzzzzzz
63 | 
64 | # ID del Precio del Plan Premium
65 | supabase secrets set PREMIUM_PLAN_PRICE_ID=price_12345abcdefg
66 | 
67 | # ID del Precio de los Créditos de Voz
68 | supabase secrets set VOICE_CREDITS_PRICE_ID=price_67890hijklmn
69 | 
70 | # URL base de tu app frontend (Ajusta para producción)
71 | supabase secrets set APP_BASE_URL=http://localhost:8080
72 | 
73 | # Clave Service Role de Supabase (Usa nombre personalizado)
74 | supabase secrets set APP_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR.......
75 | 
76 | # Secreto de Firma de Webhooks (Obtenido más tarde de Stripe)
77 | supabase secrets set STRIPE_SIGNING_SECRET=whsec_yyyyyyyyyyyy_TEMPORAL
78 | ```
79 | 
80 | ### 3.3. Configuración de la Base de Datos (profiles)
81 | 
82 | Asegura que la tabla public.profiles (vinculada a auth.users.id) contenga los campos necesarios.
83 | 
84 | Código SQL para definir/modificar tabla profiles (SQL Editor de Supabase):
85 | 
86 | ```sql
87 | -- Añadir o asegurar columnas para Stripe y límites de la app
88 | ALTER TABLE public.profiles
89 | ADD COLUMN IF NOT EXISTS stripe_customer_id TEXT UNIQUE,
90 | ADD COLUMN IF NOT EXISTS subscription_id TEXT UNIQUE,
91 | ADD COLUMN IF NOT EXISTS subscription_status TEXT,
92 | ADD COLUMN IF NOT EXISTS plan_id TEXT,
93 | ADD COLUMN IF NOT EXISTS current_period_end TIMESTAMPTZ,
94 | ADD COLUMN IF NOT EXISTS voice_credits INT4 DEFAULT 0,
95 | ADD COLUMN IF NOT EXISTS monthly_stories_generated INT4 DEFAULT 0,
96 | ADD COLUMN IF NOT EXISTS last_story_reset_date TIMESTAMPTZ;
97 | 
98 | -- Hacer columnas NULLables si se establecen después del registro
99 | ALTER TABLE public.profiles ALTER COLUMN child_age DROP NOT NULL; -- Ejemplo
100 | ```
101 | 
102 | Función SQL RPC increment_voice_credits (SQL Editor de Supabase): (Usada por Webhook)
103 | 
104 | ```sql
105 | CREATE OR REPLACE FUNCTION increment_voice_credits(user_uuid uuid, credits_to_add integer)
106 | RETURNS void LANGUAGE plpgsql AS $$
107 | BEGIN
108 |   UPDATE public.profiles
109 |   SET voice_credits = COALESCE(voice_credits, 0) + credits_to_add
110 |   WHERE id = user_uuid;
111 | END; $$;
112 | GRANT EXECUTE ON FUNCTION public.increment_voice_credits(uuid, integer) TO service_role;
113 | ```
114 | 
115 | Funciones SQL RPC para Límites (SQL Editor de Supabase): (Usadas por Edge Functions)
116 | 
117 | ```sql
118 | -- Incrementa contador de historias (llamada desde generate-story)
119 | CREATE OR REPLACE FUNCTION increment_story_count(user_uuid UUID)
120 | RETURNS VOID LANGUAGE plpgsql AS $$
121 | BEGIN
122 |   UPDATE public.profiles
123 |   SET monthly_stories_generated = COALESCE(monthly_stories_generated, 0) + 1
124 |   WHERE id = user_uuid;
125 | END; $$;
126 | GRANT EXECUTE ON FUNCTION public.increment_story_count(UUID) TO service_role;
127 | 
128 | -- Decrementa créditos de voz (llamada desde narrate-voice)
129 | CREATE OR REPLACE FUNCTION decrement_voice_credits(user_uuid UUID)
130 | RETURNS INTEGER LANGUAGE plpgsql AS $$
131 | DECLARE updated_credits INTEGER;
132 | BEGIN
133 |   UPDATE public.profiles
134 |   SET voice_credits = voice_credits - 1
135 |   WHERE id = user_uuid AND voice_credits > 0
136 |   RETURNING voice_credits INTO updated_credits;
137 |   RETURN COALESCE(updated_credits, -1); -- -1 si no se pudo decrementar
138 | END; $$;
139 | GRANT EXECUTE ON FUNCTION public.decrement_voice_credits(UUID) TO service_role;
140 | ```
141 | 
142 | ## 4. Implementación del Backend (Supabase Edge Functions)
143 | 
144 | ### 4.1. Función: create-checkout-session
145 | 
146 | Propósito: Inicia el proceso de compra (Suscripción o Créditos).
147 | Código (supabase/functions/create-checkout-session/index.ts):
148 | (Inserta aquí el código completo y final de la función proporcionado anteriormente).
149 | Despliegue: `supabase functions deploy create-checkout-session --no-verify-jwt`
150 | 
151 | ### 4.2. Función: stripe-webhook
152 | 
153 | Propósito: Recibe eventos de Stripe y actualiza la BD Supabase.
154 | Código (supabase/functions/stripe-webhook/index.ts):
155 | (Inserta aquí el código completo y final (versión con APP_SERVICE_ROLE_KEY) proporcionado anteriormente).
156 | Despliegue: `supabase functions deploy stripe-webhook --no-verify-jwt`
157 | Configuración del Endpoint en Stripe: (Realizar DESPUÉS de desplegar)
158 | 
159 | Dashboard Stripe -> Desarrolladores -> Webhooks -> "+ Añadir endpoint".
160 | URL: `https://<TU_PROYECTO_REF>.supabase.co/functions/v1/stripe-webhook`
161 | Eventos: `checkout.session.completed`, `invoice.paid`, `customer.subscription.updated`, `customer.subscription.deleted`.
162 | Añadir endpoint y copiar "Secreto de firma" (whsec_...).
163 | Guardar secreto en Supabase: `supabase secrets set STRIPE_SIGNING_SECRET=<SECRETO_WHSEC_REAL>`
164 | 
165 | ### 4.3. Función: create-customer-portal-session
166 | 
167 | Propósito: Genera enlace al Stripe Customer Portal para gestión de suscripción.
168 | Código (supabase/functions/create-customer-portal-session/index.ts):
169 | (Inserta aquí el código completo y final de la función proporcionado anteriormente).
170 | Despliegue: `supabase functions deploy create-customer-portal-session --no-verify-jwt`
171 | 
172 | ### 4.4. Lógica de Límites y Reset Mensual (Integrada en Funciones Existentes)
173 | 
174 | Importante: La aplicación de límites (10 historias/mes, 1 continuación gratuita, créditos de voz) y el reset mensual dinámico se integran directamente en las funciones que manejan esas acciones (ej. generate-story, continue-story, narrate-voice), no en funciones separadas.
175 | 
176 | **Generar Historia (generate-story function):**
177 | Debe incluir lógica para:
178 | - Obtener subscription_status, monthly_stories_generated, last_story_reset_date del perfil.
179 | - Reset Dinámico: Si el usuario es gratuito, comparar last_story_reset_date con la fecha actual. Si es un mes nuevo, actualizar monthly_stories_generated = 0 y last_story_reset_date ANTES de la verificación de límite.
180 | - Verificación Límite: Si es gratuito, comprobar monthly_stories_generated < 10. Si no, devolver error 429.
181 | - Actualización Post-Éxito: Si la generación es exitosa y el usuario es gratuito, llamar a supabaseAdmin.rpc('increment_story_count', { user_uuid: user.id }).
182 | (Nota: El código detallado para esta lógica se proporcionó en la conversación anterior).
183 | 
184 | **Continuar Historia (continue-story function):**
185 | Debe incluir lógica para:
186 | - Obtener subscription_status.
187 | - Obtener free_continuation_used de la tabla stories.
188 | - Verificación Límite: Si es gratuito y free_continuation_used es true, devolver error 403.
189 | - Actualización Post-Éxito: Si la continuación es exitosa y el usuario es gratuito, actualizar stories.free_continuation_used = true.
190 | (Nota: El pseudocódigo para esta lógica se proporcionó anteriormente).
191 | 
192 | **Narración de Voz (narrate-voice function):**
193 | Debe incluir lógica para:
194 | - Obtener subscription_status y voice_credits.
195 | - Verificación Límite: Si no es 'active', devolver error 403. Si voice_credits <= 0, devolver error 402.
196 | - Actualización Post-Éxito: Si la generación es exitosa, llamar a supabaseAdmin.rpc('decrement_voice_credits', { user_uuid: user.id }). Verificar que el resultado RPC no sea -1.
197 | (Nota: El pseudocódigo para esta lógica se proporcionó anteriormente).
198 | 
199 | ### 4.5. Manejo de Creación de Personajes (Sin Límite Actual)
200 | 
201 | Implementación Actual: La creación de personajes se maneja directamente desde el frontend mediante llamadas al cliente Supabase (supabase.from('characters').insert(...)). No se aplica límite entre usuarios gratuitos y premium en esta versión.
202 | 
203 | Nota de Seguridad: Este enfoque frontend es aceptable mientras no haya límites. Si se introduce un límite en el futuro (ej. 2 personajes para gratuitos), será necesario implementar una Edge Function dedicada (create-character) para aplicar el límite de forma segura en el backend.
204 | 
205 | ## 5. Configuración del Stripe Customer Portal
206 | 
207 | Dashboard Stripe -> Configuración (⚙️) -> Billing -> Customer portal.
208 | Activar y Configurar:
209 | - Actualizar suscripciones -> Cancelar suscripciones (marcar, fin de periodo).
210 | - Actualizar métodos de pago.
211 | - Ver historial de facturación.
212 | - Revisar Información del Negocio y Branding.
213 | - URL de Redirección Predeterminada: http://localhost:8080/profile (Ajustar para producción).
214 | - Guardar cambios.
215 | 
216 | ## 6. Implementación del Frontend (Vite Ejemplo)
217 | 
218 | ### 6.1. Inicialización de Stripe.js
219 | 
220 | En tu punto de entrada JS/TS:
221 | 
222 | ```typescript
223 | import { loadStripe } from '@stripe/stripe-js';
224 | const stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY);
225 | ```
226 | 
227 | ### 6.2. Lógica para Iniciar Checkout
228 | 
229 | En el componente con botones "Suscribirse"/"Comprar Créditos":
230 | 
231 | ```typescript
232 | import { supabase } from './supabaseClient';
233 | async function redirectToCheckout(itemType: 'premium' | 'credits') {
234 |   try {
235 |     const { data, error } = await supabase.functions.invoke('create-checkout-session', { body: JSON.stringify({ item: itemType }) });
236 |     if (error) throw error;
237 |     if (data?.url) window.location.href = data.url;
238 |     else alert('Error al iniciar el pago.');
239 |   } catch (error) { console.error(error); alert('Ocurrió un error.'); }
240 | }
241 | // Asignar a botones...
242 | ```
243 | 
244 | ### 6.3. Página de Éxito (/payment-success)
245 | 
246 | Crea esta ruta/componente:
247 | 
248 | ```typescript
249 | // Ejemplo React (adaptar)
250 | import { useEffect } from 'react';
251 | import { useLocation, useNavigate } from 'react-router-dom';
252 | function PaymentSuccessPage() {
253 |   const location = useLocation(); const navigate = useNavigate();
254 |   useEffect(() => {
255 |     const sessionId = new URLSearchParams(location.search).get('session_id');
256 |     if (sessionId) alert('¡Gracias! Tu cuenta se actualizará.');
257 |     else alert('Pago procesado, revisa tu perfil.');
258 |     setTimeout(() => navigate('/profile'), 3000);
259 |   }, [location, navigate]);
260 |   return <div><h1>¡Pago Exitoso!</h1><p>Actualizando cuenta...</p></div>;
261 | }
262 | export default PaymentSuccessPage;
263 | ```
264 | 
265 | ### 6.4. Lógica para Gestionar Suscripción (Customer Portal)
266 | 
267 | En el componente con el botón "Gestionar Suscripción":
268 | 
269 | ```typescript
270 | import { supabase } from './supabaseClient';
271 | async function handleManageSubscriptionClick() {
272 |   try {
273 |     const { data: { session }, error: se } = await supabase.auth.getSession();
274 |     if (se || !session) { alert('Inicia sesión.'); return; }
275 |     const { data, error } = await supabase.functions.invoke('create-customer-portal-session');
276 |     if (error) {
277 |       if (error.context?.status === 404) alert(data?.error || 'No se encontró info de facturación.');
278 |       else throw error;
279 |     } else if (data?.url) window.location.href = data.url;
280 |     else alert('No se pudo obtener el enlace.');
281 |   } catch (err) { console.error(err); alert('Ocurrió un error.'); }
282 | }
283 | // Asignar al botón...
284 | ```
285 | 
286 | ### 6.5. Lógica para Crear Personajes
287 | 
288 | En el servicio/componente que crea personajes:
289 | 
290 | ```typescript
291 | import { supabase } from './supabaseClient';
292 | async function createCharacterDirectly(characterData: { name: string, user_id: string, /*...*/ }) {
293 |   console.log(`Inserting character directly for user ${characterData.user_id}...`);
294 |   const { data: newCharacter, error } = await supabase
295 |     .from('characters')
296 |     .insert(characterData) // Inserción directa
297 |     .select().single();
298 |   if (error) { console.error(error); throw error; }
299 |   return newCharacter;
300 | }
301 | // Llamar a esta función desde la UI
302 | ```
303 | 
304 | ## 7. Estrategia de Pruebas
305 | 
306 | - Pruebas Backend (curl): Verifica respuestas básicas de las Edge Functions desplegadas.
307 | - Pruebas End-to-End (Esencial):
308 |   - Compra: Flujo completo desde frontend (login -> comprar -> checkout Stripe prueba -> /payment-success).
309 |   - Webhook: Monitorizar logs de stripe-webhook en Supabase Dashboard.
310 |   - Base de Datos: Verificar actualizaciones en profiles (status, créditos, contadores).
311 |   - Límites: Probar generar/continuar/narrar/crear (según aplique) como usuario gratuito y premium para confirmar que los límites (o ausencia de ellos) se aplican correctamente según la lógica integrada en las funciones.
312 |   - Gestión: Flujo completo desde frontend (login -> gestionar -> portal Stripe -> cancelar -> volver). Verificar logs y BD.
313 | 
314 | ## 8. Consideraciones Adicionales
315 | 
316 | - Manejo de Errores: Refinar mensajes de error en frontend y backend.
317 | - UI Dinámica: Mostrar estado (Gratuito/Premium), créditos restantes, deshabilitar/ocultar funciones según plan.
318 | - Seguridad Producción:
319 |   - Usar claves Live de Stripe.
320 |   - Configurar webhook y secreto de firma Live.
321 |   - Restringir CORS a tu dominio de producción.
322 |   - Actualizar APP_BASE_URL.
323 | - Future Character Limits: Si se introducen límites de personajes gratuitos, implementar una Edge Function dedicada (create-character) para validación segura en backend.
324 | 
325 | Este documento actualizado refleja la estructura completa de la integración, incluyendo la decisión actual sobre la creación de personajes.
```

docs/preset_suggestions.sql
```
1 | INSERT INTO public.preset_suggestions (text_prompt, category, language_code, is_active) VALUES
2 | -- Romantic Encounters
3 | ('A moonlit walk on the beach turns into a passionate embrace.', 'Romantic Encounters', 'en', true),
4 | ('A surprise proposal leads to a night of celebration and love.', 'Romantic Encounters', 'en', true),
5 | ('A couple rediscovers their spark during a weekend retreat.', 'Romantic Encounters', 'en', true),
6 | ('A first kiss under the stars sets the stage for a romantic journey.', 'Romantic Encounters', 'en', true),
7 | ('A love letter found years later rekindles an old flame.', 'Romantic Encounters', 'en', true),
8 | ('A dance at a wedding brings two strangers together.', 'Romantic Encounters', 'en', true),
9 | ('A shared umbrella in the rain leads to a cozy night in.', 'Romantic Encounters', 'en', true),
10 | ('A picnic in the park becomes a feast of the senses.', 'Romantic Encounters', 'en', true),
11 | ('A couple''s massage turns into an intimate exploration.', 'Romantic Encounters', 'en', true),
12 | ('A candlelit bath for two washes away inhibitions.', 'Romantic Encounters', 'en', true),
13 | ('A serenade outside the window melts the heart.', 'Romantic Encounters', 'en', true),
14 | ('A cooking class together stirs up more than just food.', 'Romantic Encounters', 'en', true),
15 | ('A horseback ride through the countryside ends in a secluded spot.', 'Romantic Encounters', 'en', true),
16 | ('A painting session becomes a masterpiece of desire.', 'Romantic Encounters', 'en', true),
17 | ('A book club discussion turns into a private reading session.', 'Romantic Encounters', 'en', true),
18 | ('A yoga retreat fosters a deep connection.', 'Romantic Encounters', 'en', true),
19 | ('A photography project captures more than just images.', 'Romantic Encounters', 'en', true),
20 | ('A gardening day together plants the seeds of love.', 'Romantic Encounters', 'en', true),
21 | ('A stargazing night reveals the universe''s beauty and their own.', 'Romantic Encounters', 'en', true),
22 | ('A shared dream inspires a reality of passion.', 'Romantic Encounters', 'en', true),
23 | 
24 | -- Forbidden Love
25 | ('A priest and a parishioner struggle with their forbidden attraction.', 'Forbidden Love', 'en', true),
26 | ('Two spies from opposing sides fall in love.', 'Forbidden Love', 'en', true),
27 | ('A royal and a commoner defy societal norms.', 'Forbidden Love', 'en', true),
28 | ('Siblings-in-law find themselves drawn to each other.', 'Forbidden Love', 'en', true),
29 | ('A therapist and a client cross professional boundaries.', 'Forbidden Love', 'en', true),
30 | ('A vampire and a werewolf break the rules of their kinds.', 'Forbidden Love', 'en', true),
31 | ('A time traveler falls for someone from the past.', 'Forbidden Love', 'en', true),
32 | ('A ghost and a living person share an impossible romance.', 'Forbidden Love', 'en', true),
33 | ('A superhero and a villain can''t resist their chemistry.', 'Forbidden Love', 'en', true),
34 | ('A mermaid and a sailor navigate their differences.', 'Forbidden Love', 'en', true),
35 | ('A witch and a witch hunter find common ground.', 'Forbidden Love', 'en', true),
36 | ('A demon and an angel discover love in the midst of war.', 'Forbidden Love', 'en', true),
37 | ('A prisoner and a guard develop feelings against all odds.', 'Forbidden Love', 'en', true),
38 | ('A celebrity and a fan blur the lines of fame.', 'Forbidden Love', 'en', true),
39 | ('A politician and a journalist risk everything for love.', 'Forbidden Love', 'en', true),
40 | ('A married couple''s open relationship leads to unexpected connections.', 'Forbidden Love', 'en', true),
41 | ('A cult leader and a follower explore their power dynamic.', 'Forbidden Love', 'en', true),
42 | ('A shapeshifter and a human learn to trust each other.', 'Forbidden Love', 'en', true),
43 | ('A cyborg and an organic human bridge the gap between machine and flesh.', 'Forbidden Love', 'en', true),
44 | ('A dragon and a knight forge a bond beyond battle.', 'Forbidden Love', 'en', true),
45 | 
46 | -- Fantasy and Sci-Fi
47 | ('In a world where dreams are shared, two lovers meet every night.', 'Fantasy and Sci-Fi', 'en', true),
48 | ('A space explorer discovers a planet where pleasure is the currency.', 'Fantasy and Sci-Fi', 'en', true),
49 | ('A wizard''s apprentice accidentally casts a love spell.', 'Fantasy and Sci-Fi', 'en', true),
50 | ('A time loop traps two people in a repeating day of passion.', 'Fantasy and Sci-Fi', 'en', true),
51 | ('A virtual reality game becomes indistinguishable from reality.', 'Fantasy and Sci-Fi', 'en', true),
52 | ('A potion maker brews an elixir that heightens desire.', 'Fantasy and Sci-Fi', 'en', true),
53 | ('A shapeshifter uses their abilities to fulfill fantasies.', 'Fantasy and Sci-Fi', 'en', true),
54 | ('A telepathic connection leads to an intimate understanding.', 'Fantasy and Sci-Fi', 'en', true),
55 | ('A cursed artifact brings two adventurers together.', 'Fantasy and Sci-Fi', 'en', true),
56 | ('A portal to another dimension reveals a world of sensual delights.', 'Fantasy and Sci-Fi', 'en', true),
57 | ('A mythical creature seduces a mortal.', 'Fantasy and Sci-Fi', 'en', true),
58 | ('A futuristic society where arranged marriages are based on compatibility algorithms.', 'Fantasy and Sci-Fi', 'en', true),
59 | ('A rebellion against a dystopian regime sparks a romance.', 'Fantasy and Sci-Fi', 'en', true),
60 | ('A magical academy where students learn more than just spells.', 'Fantasy and Sci-Fi', 'en', true),
61 | ('A quest for a legendary artifact becomes a journey of love.', 'Fantasy and Sci-Fi', 'en', true),
62 | ('A parallel universe where one''s alternate self is their lover.', 'Fantasy and Sci-Fi', 'en', true),
63 | ('A cybernetic enhancement designed for pleasure.', 'Fantasy and Sci-Fi', 'en', true),
64 | ('A alien abduction turns into a consensual encounter.', 'Fantasy and Sci-Fi', 'en', true),
65 | ('A medieval fantasy where courtly love is taken to new heights.', 'Fantasy and Sci-Fi', 'en', true),
66 | ('A steampunk world where inventors create devices for pleasure.', 'Fantasy and Sci-Fi', 'en', true),
67 | 
68 | -- BDSM and Power Dynamics
69 | ('A novice submissive attends their first play party.', 'BDSM and Power Dynamics', 'en', true),
70 | ('A dominant teaches a new partner the art of control.', 'BDSM and Power Dynamics', 'en', true),
71 | ('A couple negotiates their first scene together.', 'BDSM and Power Dynamics', 'en', true),
72 | ('A public display of affection turns into a private session.', 'BDSM and Power Dynamics', 'en', true),
73 | ('A online relationship moves to real life with agreed-upon rules.', 'BDSM and Power Dynamics', 'en', true),
74 | ('A professional dominatrix meets a client who changes everything.', 'BDSM and Power Dynamics', 'en', true),
75 | ('A switch couple takes turns in control.', 'BDSM and Power Dynamics', 'en', true),
76 | ('A bondage workshop leads to a hands-on demonstration.', 'BDSM and Power Dynamics', 'en', true),
77 | ('A sensory deprivation experience heightens every touch.', 'BDSM and Power Dynamics', 'en', true),
78 | ('A role reversal night flips the script on their dynamic.', 'BDSM and Power Dynamics', 'en', true),
79 | ('A contract is signed, sealing their commitment to each other.', 'BDSM and Power Dynamics', 'en', true),
80 | ('A punishment turns into a reward.', 'BDSM and Power Dynamics', 'en', true),
81 | ('A safe word is tested, strengthening trust.', 'BDSM and Power Dynamics', 'en', true),
82 | ('A public outing with discreet toys adds excitement.', 'BDSM and Power Dynamics', 'en', true),
83 | ('A weekend retreat dedicated to exploring limits.', 'BDSM and Power Dynamics', 'en', true),
84 | ('A mentor guides a newcomer through their first experience.', 'BDSM and Power Dynamics', 'en preparation true),
85 | ('A scene inspired by a favorite book or movie.', 'BDSM and Power Dynamics', 'en', true),
86 | ('A power exchange during a business trip.', 'BDSM and Power Dynamics', 'en', true),
87 | ('A couple incorporates new toys into their play.', 'BDSM and Power Dynamics', 'en', true),
88 | ('A dominant surprises their submissive with a special gift.', 'BDSM and Power Dynamics', 'en', true),
89 | 
90 | -- Historical Settings
91 | ('In the roaring ''20s, flappers and gangsters find love.', 'Historical Settings', 'en', true),
92 | ('During the Renaissance, artists and muses inspire each other.', 'Historical Settings', 'en', true),
93 | ('In ancient Egypt, pharaohs and priestesses share secrets.', 'Historical Settings', 'en', true),
94 | ('Victorian-era lovers correspond through coded letters.', 'Historical Settings', 'en', true),
95 | ('Samurai and zamanda geishas navigate honor and desire.', 'Historical Settings', 'en', true),
96 | ('Pirates and stowaways find romance on the high seas.', 'Historical Settings', 'en', true),
97 | ('In the Wild West, outlaws and saloon girls make their own rules.', 'Historical Settings', 'en', true),
98 | ('During the French Revolution, passion amidst chaos.', 'Historical Settings', 'en', true),
99 | ('In medieval times, knights and ladies engage in courtly love.', 'Historical Settings', 'en', true),
100 | ('Ancient Greek philosophers debate love and lust.', 'Historical Settings', 'en', true),
101 | ('In the Byzantine Empire, intrigue and seduction in the palace.', 'Historical Settings', 'en', true),
102 | ('During the Industrial Revolution, factory workers find solace.', 'Historical Settings', 'en', true),
103 | ('In pre-Columbian America, tribal rituals include sensual ceremonies.', 'Historical Settings', 'en', true),
104 | ('In feudal Japan, a ronin and a noblewoman defy conventions.', 'Historical Settings', 'en', true),
105 | ('During the Age of Exploration, sailors and island natives meet.', 'Historical Settings', 'en', true),
106 | ('In ancient Rome, gladiators and patricians cross class lines.', 'Historical Settings', 'en', true),
107 | ('In the Viking age, warriors and shieldmaidens bond.', 'Historical Settings', 'en', true),
108 | ('During the Enlightenment, free thinkers explore libertine ideas.', 'Historical Settings', 'en', true),
109 | ('In the Ottoman Empire, harem dynamics lead to forbidden love.', 'Historical Settings', 'en', true),
110 | ('In colonial times, settlers and indigenous people connect.', 'Historical Settings', 'en', true),
111 | 
112 | -- Workplace Romance
113 | ('Late nights at the office lead to more than just work.', 'Workplace Romance', 'en', true),
114 | ('A business trip becomes a romantic getaway.', 'Workplace Romance', 'en', true),
115 | ('A promotion celebration turns intimate.', 'Workplace Romance', 'en', true),
116 | ('A team-building retreat fosters closer bonds.', 'Workplace Romance', 'en', true),
117 | ('A workplace rivalry turns into mutual attraction.', 'Workplace Romance', 'en', true),
118 | ('A secret admirer leaves notes on the desk.', 'Workplace Romance', 'en', true),
119 | ('A coffee break becomes a daily date.', 'Workplace Romance', 'en', true),
120 | ('A shared project leads to shared feelings.', 'Workplace Romance', 'en', true),
121 | ('A company party ends with a private after-party.', 'Workplace Romance', 'en', true),
122 | ('A mentorship program pairs compatible partners.', 'Workplace Romance', 'en', true),
123 | ('A lunch meeting extends into the evening.', 'Workplace Romance', 'en', true),
124 | ('A job interview takes an unexpected turn.', 'Workplace Romance', 'en', true),
125 | ('A training session includes hands-on learning.', 'Workplace Romance', 'en', true),
126 | ('A corporate merger brings two executives together.', 'Workplace Romance', 'en', true),
127 | ('A workplace accident leads to tender care.', 'Workplace Romance', 'en', true),
128 | ('A shared cab ride home becomes a regular occurrence.', 'Workplace Romance', 'en', true),
129 | ('A business negotiation turns into a personal deal.', 'Workplace Romance', 'en', true),
130 | ('A company outing to a spa relaxes inhibitions.', 'Workplace Romance', 'en', true),
131 | ('A tech support call leads to a personal connection.', 'Workplace Romance', 'en', true),
132 | ('A workplace competition ends with a tie-breaker in private.', 'Workplace Romance', 'en', true),
133 | 
134 | -- Vacation and Travel
135 | ('A beach resort fling under the sun.', 'Vacation and Travel', 'en', true),
136 | ('A mountain cabin provides seclusion for romance.', 'Vacation and Travel', 'en', true),
137 | ('A cruise ship romance with a stranger.', 'Vacation and Travel', 'en', true),
138 | ('A backpacking trip through Europe leads to love.', 'Vacation and Travel', 'en', true),
139 | ('A safari adventure includes a wild night.', 'Vacation and Travel', 'en', true),
140 | ('A ski lodge becomes a winter wonderland for two.', 'Vacation and Travel', 'en', true),
141 | ('A road trip across the country with a companion.', 'Vacation and Travel', 'en', true),
142 | ('A tropical island escape from reality.', 'Vacation and Travel', 'en', true),
143 | ('A cultural tour of Asia reveals new desires.', 'Vacation and Travel', 'en', true),
144 | ('A camping trip under the stars.', 'Vacation and Travel', 'en', true),
145 | ('A luxury hotel stay with all amenities.', 'Vacation and Travel', 'en', true),
146 | ('A volunteer trip turns into a meaningful connection.', 'Vacation and Travel', 'en', true),
147 | ('A music festival where the vibe is electric.', 'Vacation and Travel', 'en', true),
148 | ('A wine tasting tour in the countryside.', 'Vacation and Travel', 'en', true),
149 | ('A historical tour where the past comes alive.', 'Vacation and Travel', 'en', true),
150 | ('A culinary journey through Italy.', 'Vacation and Travel', 'en', true),
151 | ('A wellness retreat for body and soul.', 'Vacation and Travel', 'en', true),
152 | ('A photography expedition captures beauty.', 'Vacation and Travel', 'en', true),
153 | ('A sailing trip on the open sea.', 'Vacation and Travel', 'en', true),
154 | ('A desert oasis offers a mirage of passion.', 'Vacation and Travel', 'en', true),
155 | 
156 | -- Mystery and Suspense
157 | ('A private investigator falls for their client.', 'Mystery and Suspense', 'en', true),
158 | ('A witness protection program hides more than identities.', 'Mystery and Suspense', 'en', true),
159 | ('A treasure hunt uncovers hidden desires.', 'Mystery and Suspense', 'en', true),
160 | ('A masquerade ball conceals true intentions.', 'Mystery and Suspense', 'en', true),
161 | ('A haunted house holds secrets of past lovers.', 'Mystery and Suspense', 'en', true),
162 | ('A spy uses seduction as a weapon.', 'Mystery and Suspense', 'en', true),
163 | ('A journalist investigates a scandal and finds love.', 'Mystery and Suspense', 'en', true),
164 | ('A criminal and a cop play a dangerous game.', 'Mystery and Suspense', 'en', true),
165 | ('A mysterious inheritance leads to a romantic entanglement.', 'Mystery and Suspense', 'en', true),
166 | ('A secret society with erotic initiation rites.', 'Mystery and Suspense', 'en', true),
167 | ('A blackmail plot turns into a consensual arrangement.', 'Mystery and Suspense', 'en', true),
168 | ('A kidnapping scenario with a twist.', 'Mystery and Suspense', 'en', true),
169 | ('A heist where the real prize is each other.', 'Mystery and Suspense', 'en', true),
170 | ('A cold case reopened, heating up old flames.', 'Mystery and Suspense', 'en', true),
171 | ('A survival situation brings two people closer.', 'Mystery and Suspense', 'en', true),
172 | ('A political thriller with bedroom politics.', 'Mystery and Suspense', 'en', true),
173 | ('A supernatural mystery with ghostly encounters.', 'Mystery and Suspense', 'en', true),
174 | ('A psychological thriller where minds and bodies connect.', 'Mystery and Suspense', 'en', true),
175 | ('A noir detective story with a femme fatale.', 'Mystery and Suspense', 'en', true),
176 | ('A conspiracy theory that proves true in love.', 'Mystery and Suspense', 'en', true),
177 | 
178 | -- Humor and Light-hearted
179 | ('A mistaken identity leads to a comedy of errors and eros.', 'Humor and Light-hearted', 'en', true),
180 | ('A bet between friends to see who can be more seductive.', 'Humor and Light-hearted', 'en', true),
181 | ('A cooking disaster turns into a food fight and more.', 'Humor and Light-hearted', 'en', true),
182 | ('A pet''s antics bring two owners together.', 'Humor and Light-hearted', 'en', true),
183 | ('A karaoke night where singing isn''t the only performance.', 'Humor and Light-hearted', 'en', true),
184 | ('A costume party where roles are played to the fullest.', 'Humor and Light-hearted', 'en', true),
185 | ('A game of truth or dare gets daring.', 'Humor and Light-hearted', 'en', true),
186 | ('A DIY project requires close collaboration.', 'Humor and Light-hearted', 'en', true),
187 | ('A lost bet results in a sexy forfeit.', 'Humor and Light-hearted', 'en', true),
188 | ('A mix-up at a hotel puts two strangers in the same room.', 'Humor and Light-hearted', 'en', true),
189 | ('A comedy club date ends with private jokes.', 'Humor and Light-hearted', 'en', true),
190 | ('A playful pillow fight escalates.', 'Humor and Light-hearted', 'en', true),
191 | ('A themed party with adult games.', 'Humor and Light-hearted', 'en', true),
192 | ('A scavenger hunt with erotic clues.', 'Humor and Light-hearted', 'en', true),
193 | ('A dare to try something new in bed.', 'Humor and Light-hearted', 'en', true),
194 | ('A humorous misunderstanding clears up with a kiss.', 'Humor and Light-hearted', 'en', true),
195 | ('A couple tries to be quiet but fails delightfully.', 'Humor and Light-hearted', 'en', true),
196 | ('A playful rivalry in sports turns flirtatious.', 'Humor and Light-hearted', 'en', true),
197 | ('A board game night with stripping rules.', 'Humor and Light-hearted', 'en', true),
198 | ('A comedy roast where the heat is on.', 'Humor and Light-hearted', 'en', true),
199 | 
200 | -- Exploration and Discovery
201 | ('A couple attends a tantric workshop.', 'Exploration and Discovery', 'en', true),
202 | ('A character explores their bisexuality.', 'Exploration and Discovery', 'en', true),
203 | ('A first experience with a same-sex partner.', 'Exploration and Discovery', 'en', true),
204 | ('A journey into polyamory.', 'Exploration and Discovery', 'en', true),
205 | ('A character discovers a new kink.', 'Exploration and Discovery', 'en', true),
206 | ('A couple experiments with role-playing.', 'Exploration and Discovery', 'en', true),
207 | ('A solo traveler meets a local guide.', 'Exploration and Discovery', 'en', true),
208 | ('A character learns the art of erotic massage.', 'Exploration and Discovery', 'en', true),
209 | ('A couple tries sensory play.', 'Exploration and Discovery', 'en', true),
210 | ('A character explores their dominant side.', 'Exploration and Discovery', 'en', true),
211 | ('A submissive learns to voice their desires.', 'Exploration and Discovery', 'en', true),
212 | ('A couple incorporates toys into their lovemaking.', 'Exploration and Discovery', 'en', true),
213 | ('A character attends a sex-positive event.', 'Exploration and Discovery', 'en', true),
214 | ('A couple watches erotic films together.', 'Exploration and Discovery', 'en', true),
215 | ('A character writes their own erotic story.', 'Exploration and Discovery', 'en', true),
216 | ('A couple takes a class on intimacy.', 'Exploration and Discovery', 'en', true),
217 | ('A character practices self-love and acceptance.', 'Exploration and Discovery', 'en', true),
218 | ('A couple explores outdoor intimacy.', 'Exploration and Discovery', 'en', true),
219 | ('A character discovers the joy of giving pleasure.', 'Exploration and Discovery', 'en', true),
220 | ('A couple redefines their relationship boundaries.', 'Exploration and Discovery', 'en', true);
```

docs/project_structure.md
```
1 | # Estructura del Proyecto Cuenta-Cuentos
2 | 
3 | Este documento describe la estructura de carpetas y archivos principales del proyecto. Utiliza un formato de árbol para facilitar la comprensión de la organización del código y los recursos. Los comentarios explicativos se presentan después de los nombres de archivos, precedidos por `#`.
4 | 
5 | ```text
6 | Cuenta-Cuentos/
7 | ├── .vscode/
8 | │   └── extensions.json
9 | ├── docs/
10 | │   ├── EDGE_FUNCTIONS.md
11 | │   ├── PAUTAS_DE_DISENO.md
12 | │   ├── Stripe_integration.md
13 | │   ├── project_files_content.md
14 | │   ├── project_structure.md
15 | │   ├── services.md
16 | │   ├── store_arquitecture.md
17 | │   ├── supabase-integration-guide.md
18 | │   ├── supabase_RLS.sql
19 | │   ├── supabase_presets_data.sql
20 | │   └── supabase_tables.sql
21 | ├── node_modules/
22 | ├── public/
23 | ├── src/
24 | │   ├── App.css
25 | │   ├── App.tsx
26 | │   ├── components/
27 | │   │   ├── AudioPlayer.tsx
28 | │   │   ├── AuthGuard.tsx
29 | │   │   ├── BackButton.tsx
30 | │   │   ├── ChallengeQuestion.tsx
31 | │   │   ├── ChallengeSelector.tsx
32 | │   │   ├── IconLoadingAnimation.tsx
33 | │   │   ├── LanguageSelector.tsx
34 | │   │   ├── LoadingAnimation.tsx
35 | │   │   ├── ManageSubscriptionButton.tsx
36 | │   │   ├── PageTransition.tsx
37 | │   │   ├── PaymentButtons.tsx
38 | │   │   ├── ProgressBar.tsx
39 | │   │   ├── StoryAudioPlayer.tsx
40 | │   │   ├── StoryButton.tsx
41 | │   │   ├── StoryChapter.tsx
42 | │   │   ├── StoryContinuationCustomInput.tsx
43 | │   │   ├── StoryContinuationOptions.tsx
44 | │   │   ├── StoryOptionCard.tsx
45 | │   │   ├── VoiceSettings.tsx
46 | │   │   └── ui/                   # Componentes reutilizables (~49 archivos *.tsx)
47 | │   ├── env.d.ts
48 | │   ├── hooks/
49 | │   │   ├── use-mobile.tsx
50 | │   │   └── use-toast.tsx
51 | │   ├── index.css
52 | │   ├── lib/
53 | │   │   └── utils.ts
54 | │   ├── main.tsx
55 | │   ├── pages/
56 | │   │   ├── AuthCallback.tsx
57 | │   │   ├── CharacterHobbies.tsx
58 | │   │   ├── CharacterName.tsx
59 | │   │   ├── CharacterPersonality.tsx
60 | │   │   ├── CharacterProfession.tsx
61 | │   │   ├── CharacterSelection.tsx
62 | │   │   ├── CharactersManagement.tsx
63 | │   │   ├── DurationSelection.tsx
64 | │   │   ├── ErrorPage.tsx
65 | │   │   ├── GeneratingStory.tsx
66 | │   │   ├── Home.tsx
67 | │   │   ├── Index.tsx
68 | │   │   ├── Login.tsx
69 | │   │   ├── NotFound.tsx
70 | │   │   ├── PaymentCancel.tsx
71 | │   │   ├── PaymentSuccess.tsx
72 | │   │   ├── PlansPage.tsx
73 | │   │   ├── ProfileConfigPage.tsx
74 | │   │   ├── SavedStories.tsx
75 | │   │   ├── SettingsPage.tsx
76 | │   │   ├── Signup.tsx
77 | │   │   ├── StoryAudioPage.tsx
78 | │   │   ├── StoryContinuation.tsx
79 | │   │   ├── StoryDetailsInput.tsx
80 | │   │   ├── StoryGenre.tsx
81 | │   │   ├── StoryMoral.tsx
82 | │   │   ├── StoryViewer.tsx
83 | │   │   └── Welcome.tsx
84 | │   ├── services/
85 | │   │   ├── ai/
86 | │   │   │   ├── ChallengeService.ts
87 | │   │   │   ├── GenerateStoryService.ts
88 | │   │   │   ├── StoryContinuationService.ts
89 | │   │   │   └── ttsService.ts
90 | │   │   ├── stripeService.ts
91 | │   │   ├── supabase.ts
92 | │   │   └── syncService.ts
93 | │   ├── store/
94 | │   │   ├── character/
95 | │   │   │   └── characterStore.ts
96 | │   │   ├── core/
97 | │   │   │   ├── createStore.ts
98 | │   │   │   └── utils.ts
99 | │   │   ├── index.ts
100 | │   │   ├── stories/
101 | │   │   │   ├── audio/
102 | │   │   │   │   └── audioStore.ts
103 | │   │   │   ├── challenges/
104 | │   │   │   │   └── challengesStore.ts
105 | │   │   │   ├── chapters/
106 | │   │   │   │   └── chaptersStore.ts
107 | │   │   │   ├── storiesStore.ts
108 | │   │   │   └── storyGenerator.ts
109 | │   │   ├── storyOptions/
110 | │   │   │   └── storyOptionsStore.ts
111 | │   │   ├── types/
112 | │   │   │   └── storeTypes.ts
113 | │   │   └── user/
114 | │   │       └── userStore.ts
115 | │   ├── supabaseAuth.ts
116 | │   ├── supabaseClient.ts
117 | │   ├── types/
118 | │   │   ├── index.ts
119 | │   │   └── storeTypes.ts
120 | │   └── vite-env.d.ts
121 | ├── supabase/
122 | │   ├── .branches/
123 | │   ├── .temp/
124 | │   ├── config.toml
125 | │   ├── functions/
126 | │   │   ├── Stripe/
127 | │   │   │   ├── create-checkout-session/
128 | │   │   │   │   └── index.ts
129 | │   │   │   ├── create-customer-portal-session/
130 | │   │   │   │   └── index.ts
131 | │   │   │   └── stripe-webhook/
132 | │   │   │       └── index.ts
133 | │   │   ├── _shared/
134 | │   │   │   └── cors.ts
135 | │   │   ├── ai/
136 | │   │   │   ├── challenge/
137 | │   │   │   │   ├── index.ts
138 | │   │   │   │   └── README.md
139 | │   │   │   ├── generate-audio/
140 | │   │   │   │   ├── deno.jsonc
141 | │   │   │   │   ├── import_map.json
142 | │   │   │   │   └── index.ts
143 | │   │   │   ├── generate-story/
144 | │   │   │   │   ├── index.ts
145 | │   │   │   │   └── README.md
146 | │   │   │   └── story-continuation/
147 | │   │   │       ├── index.ts
148 | │   │   │       └── README.md
149 | │   │   └── deno.jsonc
150 | │   ├── migrations/
151 | │   │   ├── 20230901000000_init_db.sql
152 | │   │   └── 20231027103000_schedule_monthly_reset.sql
153 | │   ├── sql-functions/
154 | │   │   ├── decrement_voice_credits.sql
155 | │   │   ├── handle_new_user.sql
156 | │   │   ├── increment_monthly_voice_usage.sql
157 | │   │   ├── increment_story_count.sql
158 | │   │   ├── increment_voice_credits.sql
159 | │   │   ├── reset_monthly_counters.sql
160 | │   │   └── update_modified_column.sql
161 | │   └── config.toml
162 | ├── .env
163 | ├── .gitignore
164 | ├── bun.lockb
165 | ├── components.json
166 | ├── debug-edge-function.js
167 | ├── eslint.config.js
168 | ├── get-token.js
169 | ├── index.html
170 | ├── package-lock.json
171 | ├── package.json
172 | ├── postcss.config.cjs
173 | ├── README.md
174 | ├── tailwind.config.ts
175 | ├── tsconfig.app.json
176 | ├── tsconfig.json
177 | ├── tsconfig.node.json
178 | ├── vite.config.ts
179 | ```
180 | 
181 | > **Nota:** Este esquema puede variar ligeramente si se agregan o eliminan archivos/carpetas. Consulta el repositorio para la versión más actualizada.
```

docs/provisional_logica_tts.md
```
1 | # Lógica de Consumo de Créditos de Voz
2 | 
3 | ## Objetivo
4 | 
5 | Definir el proceso y las reglas para verificar la disponibilidad de créditos de
6 | voz y registrarlos como gastados cuando un usuario solicita la generación de una
7 | narración (audio TTS) para un capítulo de una historia.
8 | 
9 | ## Ubicación de la Lógica
10 | 
11 | Esta lógica **debe implementarse en el backend**, específicamente dentro de la
12 | **Edge Function encargada de procesar la solicitud de generación de audio**
13 | (probablemente llamada `generate-audio` o similar). No debe realizarse en el
14 | frontend por razones de seguridad y control.
15 | 
16 | ## Flujo General
17 | 
18 | 1. **Recepción de Solicitud:** La función recibe una petición del frontend para
19 |    generar audio para un texto/capítulo específico, incluyendo el ID de la voz
20 |    deseada.
21 | 2. **Autenticación:** Se verifica el token del usuario para confirmar que es una
22 |    solicitud válida y obtener su `user_id`. Si falla, se devuelve un error 401
23 |    (No autorizado).
24 | 3. **Obtención de Perfil:** Se consulta la tabla `profiles` en la base de datos
25 |    (usando el `user_id`) para obtener el estado actual del usuario:
26 |    - `subscription_status` (ej. 'free', 'active', 'trialing', 'canceled')
27 |    - `monthly_voice_generations_used` (contador de uso para Premium)
28 |    - `voice_credits` (créditos comprados) Si no se encuentra el perfil, se
29 |      devuelve un error 500.
30 | 4. **Verificación de Créditos (¡Lógica Clave!):** Se aplican las reglas para
31 |    determinar si el usuario tiene permiso y créditos suficientes para generar el
32 |    audio (ver detalles abajo).
33 | 5. **Error por Falta de Créditos:** Si la verificación determina que no hay
34 |    créditos suficientes, se devuelve un error al frontend **antes** de realizar
35 |    cualquier llamada a la API de TTS. Se recomienda usar el código de estado
36 |    HTTP:
37 |    - `402 Payment Required`: Si el usuario podría obtener más créditos
38 |      (comprando o esperando la renovación del plan).
39 |    - `403 Forbidden`: Si el tipo de usuario (ej. gratuito sin opción de compra)
40 |      simplemente no tiene acceso a la función. (En nuestro caso, como los
41 |      gratuitos pueden comprar, 402 suele ser más apropiado si se quedan sin
42 |      créditos).
43 | 6. **Actualización de Base de Datos (¡CRÍTICO!):** Si la verificación de
44 |    créditos es exitosa, se debe **actualizar inmediatamente** el contador
45 |    correspondiente en la base de datos **ANTES** de llamar a la API externa de
46 |    TTS. Esto se hace llamando a la función SQL apropiada mediante RPC:
47 |    - Si se usa un crédito del plan mensual:
48 |      `increment_monthly_voice_usage(user_id)`
49 |    - Si se usa un crédito comprado: `decrement_voice_credits(user_id)` Si esta
50 |      actualización falla, se debe devolver un error 500 al frontend y **no**
51 |      proceder con la generación de TTS.
52 | 7. **Generación de Audio (TTS):** Solo si la actualización de la base de datos
53 |    fue exitosa, se procede a llamar a la API externa de Text-to-Speech (ej.
54 |    ElevenLabs, OpenAI TTS) con el texto y la voz solicitada.
55 | 8. **Manejo de Errores TTS:** Si la API de TTS devuelve un error, se debe
56 |    registrar el fallo y devolver un error apropiado (ej. 500 o 502) al frontend.
57 |    _Nota: El crédito ya se gastó en el paso 6, lo cual es intencional para
58 |    evitar abusos o reintentos infinitos si la API externa falla
59 |    intermitentemente._
60 | 9. **Respuesta Exitosa:** Si la generación de TTS es exitosa, se devuelve el
61 |    buffer de audio (o la URL, según la implementación) al frontend con un estado
62 |    200 OK.
63 | 
64 | ## Lógica Detallada por Tipo de Usuario
65 | 
66 | ### Usuario Premium (`subscription_status` es 'active' o 'trialing')
67 | 
68 | 1. **Verificar Límite Mensual:** Se comprueba si
69 |    `monthly_voice_generations_used` es menor que el límite mensual permitido
70 |    (ej. 20).
71 |    - **Si SÍ (< 20):** El usuario puede generar.
72 |      - **Acción DB (ANTES de TTS):** Llamar a
73 |        `increment_monthly_voice_usage(user_id)`.
74 |    - **Si NO (>= 20):** Pasar al siguiente paso.
75 | 2. **Verificar Créditos Comprados:** Se comprueba si `voice_credits` es mayor
76 |    que 0.
77 |    - **Si SÍ (> 0):** El usuario puede generar.
78 |      - **Acción DB (ANTES de TTS):** Llamar a
79 |        `decrement_voice_credits(user_id)`.
80 |    - **Si NO (<= 0):** El usuario **no** puede generar. Devolver error 402 (Pago
81 |      Requerido).
82 | 
83 | ### Usuario Gratuito (o Cancelado, etc.)
84 | 
85 | 1. **Verificar Créditos Comprados:** Se comprueba si `voice_credits` es mayor
86 |    que 0.
87 |    - **Si SÍ (> 0):** El usuario puede generar.
88 |      - **Acción DB (ANTES de TTS):** Llamar a
89 |        `decrement_voice_credits(user_id)`.
90 |    - **Si NO (<= 0):** El usuario **no** puede generar. Devolver error 402 (Pago
91 |      Requerido), indicando que necesita comprar créditos.
92 | 
93 | ## Funciones SQL Necesarias (Supabase RPC)
94 | 
95 | Asegúrate de que estas funciones existan en tu base de datos y sean accesibles
96 | por el rol `service_role` (usado por `supabaseAdmin`):
97 | 
98 | - `increment_monthly_voice_usage(user_uuid uuid)`: Incrementa el contador
99 |   `monthly_voice_generations_used` en 1 para el usuario dado.
100 | - `decrement_voice_credits(user_uuid uuid)`: Decrementa `voice_credits` en 1
101 |   para el usuario dado, idealmente devolviendo el nuevo saldo o un indicador
102 |   (-1) si no había créditos para decrementar (aunque la lógica principal ya lo
103 |   verifica).
104 | 
105 | ## Consideraciones Adicionales
106 | 
107 | - **Constantes:** Definir el límite mensual (ej. 20) como una constante o
108 |   variable de entorno para fácil mantenimiento.
109 | - **Atomicidad:** Las llamadas RPC a funciones SQL que actualizan una sola fila
110 |   suelen ser suficientemente atómicas para este caso de uso, minimizando riesgos
111 |   de condiciones de carrera.
112 | - **Errores:** Manejar adecuadamente los errores de red, de base de datos y de
113 |   la API de TTS, devolviendo códigos de estado HTTP informativos.
```

docs/sql_supabase.sql
```
1 | -- =============================================================================
2 | -- || DATABASE MIGRATION SCRIPT FOR FANTASIA (ADULT VERSION)                ||
3 | -- ||                                                                         ||
4 | -- || This script transforms the database schema from the children's version  ||
5 | -- || to the new adult content platform.                                      ||
6 | -- ||                                                                         ||
7 | -- || Execute this script in your Supabase SQL Editor.                        ||
8 | -- || It is highly recommended to perform a backup before execution.          ||
9 | -- =============================================================================
10 | 
11 | BEGIN;
12 | 
13 | -- =============================================================================
14 | -- STEP 1: CLEANUP OF OBSOLETE TABLES
15 | -- We remove tables related to "challenges", which no longer exist.
16 | -- =============================================================================
17 | 
18 | DROP TABLE IF EXISTS public.challenge_questions;
19 | DROP TABLE IF EXISTS public.challenges;
20 | 
21 | 
22 | -- =============================================================================
23 | -- STEP 2: CREATION OF CUSTOM DATA TYPES (ENUMS)
24 | -- We define fixed data types to ensure data consistency.
25 | -- =============================================================================
26 | 
27 | -- Gender options for characters.
28 | DO $$ BEGIN
29 |     CREATE TYPE public.gender_options AS ENUM ('male', 'female', 'non-binary');
30 | EXCEPTION
31 |     WHEN duplicate_object THEN null;
32 | END $$;
33 | 
34 | -- Story format: single story or episodic.
35 | DO $$ BEGIN
36 |     CREATE TYPE public.story_format AS ENUM ('single', 'episodic');
37 | EXCEPTION
38 |     WHEN duplicate_object THEN null;
39 | END $$;
40 | 
41 | 
42 | -- =============================================================================
43 | -- STEP 3: TABLE DEFINITIONS
44 | -- We recreate and/or alter tables to fit the new data model.
45 | -- =============================================================================
46 | 
47 | -- 'profiles' table: Updated to reflect adult preferences.
48 | DROP TABLE IF EXISTS public.profiles;
49 | CREATE TABLE public.profiles (
50 |     id uuid NOT NULL,
51 |     language text NOT NULL,
52 |     preferences text NULL,
53 |     created_at timestamp with time zone NOT NULL DEFAULT now(),
54 |     updated_at timestamp with time zone NOT NULL DEFAULT now(),
55 |     stripe_customer_id text NULL,
56 |     subscription_status text NULL,
57 |     voice_credits integer NOT NULL DEFAULT 0,
58 |     current_period_end timestamp with time zone NULL,
59 |     monthly_stories_generated integer NOT NULL DEFAULT 0,
60 |     subscription_id text NULL,
61 |     plan_id text NULL,
62 |     period_start_date timestamp with time zone NULL,
63 |     monthly_voice_generations_used integer NULL DEFAULT 0,
64 |     has_completed_setup boolean NOT NULL DEFAULT false,
65 |     CONSTRAINT profiles_pkey PRIMARY KEY (id),
66 |     CONSTRAINT profiles_stripe_customer_id_key UNIQUE (stripe_customer_id),
67 |     CONSTRAINT profiles_subscription_id_key UNIQUE (subscription_id),
68 |     CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id) ON DELETE CASCADE
69 | );
70 | COMMENT ON COLUMN public.profiles.preferences IS 'User preferences and tastes for story generation (e.g., kinks, fetishes).';
71 | 
72 | -- 'characters' table: Completely simplified for the new scope.
73 | DROP TABLE IF EXISTS public.characters;
74 | CREATE TABLE public.characters (
75 |     id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
76 |     user_id uuid NOT NULL,
77 |     name text NOT NULL,
78 |     gender public.gender_options NOT NULL,
79 |     description text NOT NULL,
80 |     created_at timestamp with time zone NOT NULL DEFAULT now(),
81 |     updated_at timestamp with time zone NOT NULL DEFAULT now(),
82 |     CONSTRAINT characters_pkey PRIMARY KEY (id),
83 |     CONSTRAINT characters_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE
84 | );
85 | COMMENT ON TABLE public.characters IS 'Stores user-created characters for stories. Simplified for adult content.';
86 | 
87 | -- 'stories' table: Adapted to the new story options.
88 | DROP TABLE IF EXISTS public.stories;
89 | CREATE TABLE public.stories (
90 |     id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
91 |     user_id uuid NOT NULL,
92 |     title text NOT NULL,
93 |     content text NOT NULL,
94 |     audio_url text NULL,
95 |     genre text NULL, -- Kept as text to allow for custom user-defined genres.
96 |     story_format public.story_format NOT NULL DEFAULT 'single'::public.story_format,
97 |     cover_image_url text NULL, -- For future use with image generation.
98 |     character_id uuid NULL,
99 |     additional_details text NULL, -- For the final optional customization prompt.
100 |     created_at timestamp with time zone NOT NULL DEFAULT now(),
101 |     updated_at timestamp with time zone NOT NULL DEFAULT now(),
102 |     CONSTRAINT stories_pkey PRIMARY KEY (id),
103 |     CONSTRAINT stories_character_id_fkey FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE SET NULL,
104 |     CONSTRAINT stories_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE
105 | );
106 | COMMENT ON COLUMN public.stories.story_format IS 'Indicates if the story is a single one-off or episodic with chapters.';
107 | COMMENT ON COLUMN public.stories.genre IS 'Story genre. Can be a preset (e.g., Erotic Romance) or a custom user value.';
108 | COMMENT ON COLUMN public.stories.cover_image_url IS 'URL for the story''s cover image. Functionality disabled for now but schema is ready.';
109 | 
110 | 
111 | -- Tables with no structural changes (recreated for a clean script) --
112 | DROP TABLE IF EXISTS public.story_chapters;
113 | CREATE TABLE public.story_chapters (
114 |     id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
115 |     story_id uuid NOT NULL,
116 |     chapter_number integer NOT NULL,
117 |     title text NOT NULL,
118 |     content text NOT NULL,
119 |     generation_method text NULL,
120 |     custom_input text NULL,
121 |     created_at timestamp with time zone NOT NULL DEFAULT now(),
122 |     updated_at timestamp with time zone NOT NULL DEFAULT now(),
123 |     CONSTRAINT story_chapters_pkey PRIMARY KEY (id),
124 |     CONSTRAINT story_chapters_story_id_fkey FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE
125 | );
126 | 
127 | DROP TABLE IF EXISTS public.audio_files;
128 | CREATE TABLE public.audio_files (
129 |     id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
130 |     user_id uuid NOT NULL,
131 |     story_id uuid NULL,
132 |     chapter_id uuid NULL,
133 |     voice_id text NOT NULL,
134 |     url text NOT NULL,
135 |     created_at timestamp with time zone NOT NULL DEFAULT now(),
136 |     CONSTRAINT audio_files_pkey PRIMARY KEY (id),
137 |     CONSTRAINT audio_files_chapter_id_fkey FOREIGN KEY (chapter_id) REFERENCES story_chapters(id) ON DELETE CASCADE,
138 |     CONSTRAINT audio_files_story_id_fkey FOREIGN KEY (story_id) REFERENCES stories(id) ON DELETE CASCADE,
139 |     CONSTRAINT audio_files_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE
140 | );
141 | 
142 | DROP TABLE IF EXISTS public.preset_suggestions;
143 | CREATE TABLE public.preset_suggestions (
144 |     id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
145 |     text_prompt text NOT NULL,
146 |     category text NULL,
147 |     language_code character varying(5) NOT NULL DEFAULT 'en'::character varying,
148 |     is_active boolean NOT NULL DEFAULT true,
149 |     created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
150 |     CONSTRAINT preset_suggestions_pkey PRIMARY KEY (id)
151 | );
152 | COMMENT ON TABLE public.preset_suggestions IS 'Stores preset prompts for story generation (e.g., scenarios, settings). To be populated later.';
153 | 
154 | 
155 | DROP TABLE IF EXISTS public.user_voices;
156 | CREATE TABLE public.user_voices (
157 |     id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
158 |     user_id uuid NOT NULL,
159 |     voice_id text NOT NULL,
160 |     is_current boolean NULL DEFAULT false,
161 |     created_at timestamp with time zone NOT NULL DEFAULT now(),
162 |     updated_at timestamp with time zone NOT NULL DEFAULT now(),
163 |     CONSTRAINT user_voices_pkey PRIMARY KEY (id),
164 |     CONSTRAINT user_voices_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE
165 | );
166 | 
167 | 
168 | -- =============================================================================
169 | -- STEP 4: ENABLE AND CONFIGURE ROW LEVEL SECURITY (RLS)
170 | -- Security first: we ensure that each user can only see and modify their own data.
171 | -- =============================================================================
172 | 
173 | -- Enable RLS on all relevant tables
174 | ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
175 | ALTER TABLE public.characters ENABLE ROW LEVEL SECURITY;
176 | ALTER TABLE public.stories ENABLE ROW LEVEL SECURITY;
177 | ALTER TABLE public.story_chapters ENABLE ROW LEVEL SECURITY;
178 | ALTER TABLE public.audio_files ENABLE ROW LEVEL SECURITY;
179 | ALTER TABLE public.user_voices ENABLE ROW LEVEL SECURITY;
180 | ALTER TABLE public.preset_suggestions ENABLE ROW LEVEL SECURITY;
181 | 
182 | -- Policies for 'profiles'
183 | DROP POLICY IF EXISTS "Users can manage their own profile." ON public.profiles;
184 | CREATE POLICY "Users can manage their own profile."
185 |     ON public.profiles FOR ALL
186 |     TO authenticated
187 |     USING (auth.uid() = id)
188 |     WITH CHECK (auth.uid() = id);
189 | 
190 | -- Policies for 'characters'
191 | DROP POLICY IF EXISTS "Users can manage their own characters." ON public.characters;
192 | CREATE POLICY "Users can manage their own characters."
193 |     ON public.characters FOR ALL
194 |     TO authenticated
195 |     USING (auth.uid() = user_id)
196 |     WITH CHECK (auth.uid() = user_id);
197 | 
198 | -- Policies for 'stories'
199 | DROP POLICY IF EXISTS "Users can manage their own stories." ON public.stories;
200 | CREATE POLICY "Users can manage their own stories."
201 |     ON public.stories FOR ALL
202 |     TO authenticated
203 |     USING (auth.uid() = user_id)
204 |     WITH CHECK (auth.uid() = user_id);
205 | 
206 | -- Policies for 'story_chapters' (Access via parent story)
207 | DROP POLICY IF EXISTS "Users can manage chapters for their own stories." ON public.story_chapters;
208 | CREATE POLICY "Users can manage chapters for their own stories."
209 |     ON public.story_chapters FOR ALL
210 |     TO authenticated
211 |     USING (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = story_chapters.story_id))
212 |     WITH CHECK (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = story_chapters.story_id));
213 | 
214 | -- Policies for 'audio_files'
215 | DROP POLICY IF EXISTS "Users can manage their own audio files." ON public.audio_files;
216 | CREATE POLICY "Users can manage their own audio files."
217 |     ON public.audio_files FOR ALL
218 |     TO authenticated
219 |     USING (auth.uid() = user_id)
220 |     WITH CHECK (auth.uid() = user_id);
221 | 
222 | -- Policies for 'user_voices'
223 | DROP POLICY IF EXISTS "Users can manage their own voice settings." ON public.user_voices;
224 | CREATE POLICY "Users can manage their own voice settings."
225 |     ON public.user_voices FOR ALL
226 |     TO authenticated
227 |     USING (auth.uid() = user_id)
228 |     WITH CHECK (auth.uid() = user_id);
229 | 
230 | -- Policies for 'preset_suggestions' (Read-only access for users)
231 | DROP POLICY IF EXISTS "Authenticated users can read active presets." ON public.preset_suggestions;
232 | CREATE POLICY "Authenticated users can read active presets."
233 |     ON public.preset_suggestions FOR SELECT
234 |     TO authenticated
235 |     USING (is_active = true);
236 | 
237 | 
238 | COMMIT;
239 | 
240 | 
241 | -- =============================================================================
242 | -- ||                 FINAL SQL FUNCTIONS FOR FANTASIA                        ||
243 | -- =============================================================================
244 | 
245 | -- Function to decrement voice credits when an audio is generated
246 | CREATE OR REPLACE FUNCTION public.decrement_voice_credits(user_uuid uuid)
247 | RETURNS integer LANGUAGE plpgsql SECURITY INVOKER AS $$
248 | DECLARE updated_credits INTEGER;
249 | BEGIN
250 |   UPDATE public.profiles SET voice_credits = voice_credits - 1
251 |   WHERE id = user_uuid AND voice_credits > 0
252 |   RETURNING voice_credits INTO updated_credits;
253 |   RETURN COALESCE(updated_credits, -1);
254 | END;
255 | $$;
256 | 
257 | -- Trigger function to create a profile for a new user
258 | -- UPDATED: Default language is now 'en'
259 | CREATE OR REPLACE FUNCTION public.handle_new_user()
260 | RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER AS $$
261 | BEGIN
262 |   INSERT INTO public.profiles (id, language, has_completed_setup)
263 |   VALUES (new.id, 'en', false);
264 |   RETURN new;
265 | END;
266 | $$;
267 | 
268 | -- Function to increment the monthly voice generation usage counter
269 | CREATE OR REPLACE FUNCTION public.increment_monthly_voice_usage(user_uuid uuid)
270 | RETURNS void LANGUAGE plpgsql SECURITY INVOKER AS $$
271 | BEGIN
272 |   UPDATE public.profiles
273 |   SET monthly_voice_generations_used = COALESCE(monthly_voice_generations_used, 0) + 1
274 |   WHERE id = user_uuid;
275 | END;
276 | $$;
277 | 
278 | -- Function to increment the monthly story generation usage counter
279 | CREATE OR REPLACE FUNCTION public.increment_story_count(user_uuid uuid)
280 | RETURNS void LANGUAGE plpgsql SECURITY INVOKER AS $$
281 | BEGIN
282 |   UPDATE public.profiles
283 |   SET monthly_stories_generated = COALESCE(monthly_stories_generated, 0) + 1
284 |   WHERE id = user_uuid;
285 | END;
286 | $$;
287 | 
288 | -- Function to add voice credits to a user (e.g., after a purchase)
289 | CREATE OR REPLACE FUNCTION public.increment_voice_credits(user_uuid uuid, credits_to_add integer)
290 | RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
291 | BEGIN
292 |   UPDATE public.profiles
293 |   SET voice_credits = COALESCE(voice_credits, 0) + credits_to_add
294 |   WHERE id = user_uuid;
295 | END;
296 | $$;
297 | 
298 | -- Scheduled function to reset usage counters for non-premium users
299 | CREATE OR REPLACE FUNCTION public.reset_monthly_counters()
300 | RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
301 | BEGIN
302 |   UPDATE public.profiles
303 |   SET monthly_stories_generated = 0
304 |   WHERE (subscription_status IS NULL OR subscription_status NOT IN ('active', 'trialing'))
305 |     AND monthly_stories_generated > 0;
306 |   RAISE LOG 'Monthly story counters for free users have been reset.';
307 | END;
308 | $$;
309 | 
310 | -- Generic trigger function to automatically update the 'updated_at' timestamp on modification
311 | CREATE OR REPLACE FUNCTION public.update_modified_column()
312 | RETURNS trigger LANGUAGE plpgsql SECURITY INVOKER AS $$
313 | BEGIN
314 |    NEW.updated_at = NOW();
315 |    RETURN NEW;
316 | END;
317 | $$;
318 | 
319 | -- =============================================================================
320 | -- ||                             TRIGGERS                                  ||
321 | -- =============================================================================
322 | 
323 | -- Crear trigger para auto-generar perfiles en el registro de nuevos usuarios
324 | CREATE TRIGGER trigger_create_profile_on_signup
325 |     AFTER INSERT ON auth.users
326 |     FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
327 | 
328 | -- Triggers para actualizar timestamps automáticamente en 'updated_at'
329 | CREATE TRIGGER trigger_profiles_updated_at
330 |     BEFORE UPDATE ON public.profiles
331 |     FOR EACH ROW EXECUTE FUNCTION public.update_modified_column();
332 | 
333 | CREATE TRIGGER trigger_characters_updated_at
334 |     BEFORE UPDATE ON public.characters
335 |     FOR EACH ROW EXECUTE FUNCTION public.update_modified_column();
336 | 
337 | CREATE TRIGGER trigger_stories_updated_at
338 |     BEFORE UPDATE ON public.stories
339 |     FOR EACH ROW EXECUTE FUNCTION public.update_modified_column();
340 | 
341 | CREATE TRIGGER trigger_story_chapters_updated_at
342 |     BEFORE UPDATE ON public.story_chapters
343 |     FOR EACH ROW EXECUTE FUNCTION public.update_modified_column();
344 | 
345 | CREATE TRIGGER trigger_user_voices_updated_at
346 |     BEFORE UPDATE ON public.user_voices
347 |     FOR EACH ROW EXECUTE FUNCTION public.update_modified_column();
348 | 
349 | 
350 | -- =============================================================================
351 | -- ||                                END OF SCRIPT                              ||
352 | -- =============================================================================
```

docs/store_arquitecture.md
```
1 | # Store Architecture and Data Flow Guide (Zustand + Supabase)
2 | 
3 | **Document Version:** 1.0
4 | **Date:** 2023-10-27 (Update with actual date)
5 | **Target Audience:** Code Agent (e.g., Windsurf), Developers
6 | 
7 | ## 1. Overview
8 | 
9 | This document details the state management architecture for the AI Storyteller web application, primarily located within the `src/store` directory. The application utilizes **Zustand** as its state management library, employing a modular approach where different aspects of the application state are handled by separate "stores."
10 | 
11 | **Key Goals of this Architecture:**
12 | 
13 | *   **Centralized State:** Provide a single source of truth for various application states.
14 | *   **Modularity:** Separate concerns into logical units (user, characters, stories, etc.) for maintainability.
15 | *   **Reactivity:** Enable UI components to react automatically to state changes.
16 | *   **Persistence:** Persist user-specific state across browser sessions using `localStorage`.
17 | *   **Supabase Integration:** Manage the flow of data between the frontend state and the Supabase backend (database and authentication).
18 | *   **Multi-User Support:** Isolate the persisted state for different authenticated users.
19 | 
20 | ## 2. Core Concepts & Mechanisms
21 | 
22 | Several core mechanisms underpin how the stores function:
23 | 
24 | ### 2.1. Persistent Store Creation (`@store/core/createStore.ts`)
25 | 
26 | *   **`createPersistentStore<T>(initialState, storeLogic, storeName)`:** A custom wrapper around Zustand's `create` and `persist` middleware.
27 | *   **User-Specific Persistence:**
28 |     *   It automatically generates a unique `localStorage` key for each store *and* each authenticated user: `` `story-app-${userId}-${storeName}` `` (e.g., `story-app-user123-characters`). `userId` is 'anonymous' if no user is logged in.
29 |     *   This ensures that data from different users does not mix in `localStorage`.
30 | *   **`setCurrentAuthUser(userId: string | null)`:** **Crucial function.** Called by `@store/user/userStore.ts` during login/logout/auth check. It updates a global tracker for the current user ID, which `createPersistentStore` uses to generate the correct storage key.
31 | *   **`cleanPreviousUserStores(currentUserId: string)`:** Called when the user changes (via `setCurrentAuthUser`). It iterates through `localStorage` and removes keys associated with *previous* users (keys matching `story-app-...` but *not* containing the `currentUserId` and not being the generic `story-app-user` key).
32 | *   **`registerStoreRefresh(storeName: string, refreshFn: Function)` & `refreshAllStores()`:** A mechanism allowing stores to register a function (typically their `load...FromSupabase` method) that gets called automatically by `refreshAllStores` (triggered via `setCurrentAuthUser` on user change) to reload data relevant to the *new* user.
33 | 
34 | ### 2.2. Data Loading & Synchronization Flow
35 | 
36 | The loading of user-specific data from Supabase upon login or app initialization follows a specific, centralized pattern orchestrated by `@store/user/userStore.ts`:
37 | 
38 | 1.  **Initiation:** Triggered by:
39 |     *   App load (`@main.ts` -> `@services/syncService.ts` -> `useUserStore.checkAuth()`).
40 |     *   Explicit Login (`Login Page` -> `supabaseAuth.login` -> `useUserStore.loginUser()`).
41 |     *   Coming back online (`online` event -> `@services/syncService.ts` -> `useUserStore.checkAuth()`).
42 | 2.  **`userStore.checkAuth()` / `userStore.loginUser()`:**
43 |     *   Verifies authentication state with Supabase Auth (`supabase.auth.getSession`, `supabase.auth.getUser`).
44 |     *   If authenticated, calls `setCurrentAuthUser(userId)` to set the global user ID.
45 |     *   Calls `@services/supabase.ts -> getUserProfile(userId)` to fetch the user's *complete* profile data (including settings, subscription status, limits, credits).
46 |     *   Updates its *own* state (`user` and `profileSettings`).
47 |     *   **Crucially, calls the internal `syncAllUserData(userId)` function.**
48 | 3.  **`userStore.syncAllUserData(userId)`:**
49 |     *   This function acts as the **central orchestrator** for loading data into *other* stores.
50 |     *   It iterates through a predefined list (`otherStores`) of stores and their respective data-loading methods (e.g., `useCharacterStore.loadCharactersFromSupabase`, `useStoriesStore.loadStoriesFromSupabase`, `useAudioStore.loadAudioFromSupabase`).
51 |     *   It calls these methods sequentially, passing the `userId`.
52 | 4.  **Individual Store `load...FromSupabase(userId)` Methods:**
53 |     *   Each store's loading method (e.g., `@store/character/characterStore.ts -> loadCharactersFromSupabase`) uses the provided `userId` to call the relevant data-fetching function in `@services/supabase.ts` (e.g., `getUserCharacters`).
54 |     *   **Important:** These methods should **first clear** the relevant part of their local state (e.g., `set({ savedCharacters: [] })`) before fetching and setting the fresh data from Supabase to prevent merging old/stale data.
55 |     *   They update their own state upon successful data retrieval.
56 | 
57 | ### 2.3. Offline Queue (`@services/supabase.ts -> syncQueue`)
58 | 
59 | *   **Purpose:** To handle situations where the application is offline or a direct Supabase operation fails temporarily.
60 | *   **Mechanism:**
61 |     *   When a direct Supabase write operation (e.g., `syncCharacter`, `syncUserProfile`) fails within its `try...catch` block, the operation details (table, operation type, data) are added to the `syncQueue` using `syncQueue.addToQueue(...)`.
62 |     *   The `SyncQueueService` class persists this queue in `localStorage`.
63 |     *   An `online` event listener triggers `syncQueue.processQueue()`.
64 |     *   `processQueue()` attempts to execute the queued operations (using `upsert` for resilience) against Supabase. Successful operations are removed from the queue; failed ones are re-queued.
65 | *   **Consideration:** Requires careful handling of data format, especially ensuring `id` is present for `delete` operations.
66 | 
67 | ## 3. Store Breakdown
68 | 
69 | ### 3.1. `@store/user/userStore.ts`
70 | 
71 | *   **Purpose:** Manages user authentication state, user profile settings (including subscription/limit data), and orchestrates the initial data loading for other stores.
72 | *   **Key State:**
73 |     *   `user: User | null`: Basic user info (id, email).
74 |     *   `profileSettings: ProfileSettings | null`: Complete profile data fetched from the `profiles` table (language, age, need, subscription status, limits, credits, etc.). **Crucial for app logic.**
75 |         *   Includes fields like `subscription_status`, `monthly_stories_generated`, `monthly_voice_generations_used`, `voice_credits`, `current_period_end`.
76 |         *   Includes `has_completed_setup: boolean`: A flag indicating if the user has gone through the initial profile configuration (`ProfileConfigPage`) at least once. This flag is crucial for redirection logic.
77 | *   **Key Selectors (Computed State):**
78 |     *   `isPremium()`: Returns `true` if `subscription_status` indicates an active premium plan ('premium_monthly', 'premium_yearly', 'trialing').
79 |     *   `getRemainingMonthlyStories()`: Calculates remaining stories for free users based on `monthly_stories_generated`.
80 |     *   `getRemainingMonthlyVoiceGenerations()`: Returns the number of *included* monthly voice generations remaining for premium users (e.g., `20 - monthly_voice_generations_used`). Returns 0 for non-premium users.
81 |     *   `getAvailableVoiceCredits()`: Returns the number of *purchased* `voice_credits`.
82 |     *   `canGenerateStory()`: Checks if the user (free or premium) has available story generations (monthly limit or purchased credits, though story credits are not fully implemented yet).
83 |     *   `canGenerateVoice()`: Determines if the user can generate voice based on subscription status and voice credits.
84 |         * **Premium users (`active` or `trialing`):** Allowed if they have remaining monthly voice generations (quota) OR purchased voice credits.
85 |         * **Non-premium users (`free`, `canceled`, etc.):** Allowed only if they have purchased voice credits.
86 |     *   `hasCompletedProfile()`: A selector returning `true` if `profileSettings` exists and `profileSettings.has_completed_setup` is true. Used by components like `Home` and `AuthGuard` to check if the user needs to be sent to profile configuration.
87 | *   **Important Distinction: Monthly Quota vs. Purchased Credits:**
88 |     It's crucial to understand the difference in how voice generation allowances work:
89 |     *   **Monthly Voice Generations (Premium):** Represented by tracking `monthly_voice_generations_used` against a fixed limit (e.g., 20). This is a *quota* that **resets to 0** at the start of each subscription period (handled by the Stripe webhook). This effectively makes the full quota available again each month. Unused generations from one month **do not roll over** to the next.
90 |     *   **Purchased Voice Credits (`voice_credits`):** Represent a *balance* of credits bought separately. These credits **persist** across subscription periods and **do not reset** monthly. They are only consumed when used (either by free users or by premium users who have exhausted their monthly quota). This balance accumulates if more credits are purchased.
91 | 
92 | *   **Key Actions:**
93 |     *   `checkAuth()`: Verifies auth, loads profile, triggers `syncAllUserData`. **Central function.** Determines initial redirect path (`/home` or `/profile-config`) based on `profileSettings.has_completed_setup`.
94 |     *   `loginUser(user)`: Sets user state, loads profile, triggers `syncAllUserData`.
95 |     *   `logoutUser()`: Processes sync queue, signs out via `@services/supabaseAuth.logout`, clears local state, calls `setCurrentAuthUser(null)`.
96 |     *   `setProfileSettings(settings)`: 
97 |         1. Recibe un objeto `settings` con las propiedades del perfil a actualizar (usando nombres en camelCase, ej. `childAge`).
98 |         2. **Actualiza inmediatamente el estado local (`profileSettings`)** fusionando los nuevos `settings` para que la UI refleje los cambios al instante.
99 |         3. **Mapea las claves del objeto `settings`** de camelCase (TypeScript) a snake_case (Supabase DB) usando un `keyMap` interno (ej., `childAge` -> `child_age`, `specialNeed` -> `special_need`). Solo se incluyen en el mapeo las propiedades presentes en el `settings` recibido.
100 |         4. Construye un objeto `syncData` que contiene únicamente las propiedades mapeadas a snake_case con sus valores.
101 |         5. Llama a `@services/supabase.syncUserProfile` pasándole el `userId` y el objeto `syncData` (con claves snake_case) para persistir los cambios en la base de datos.
102 |         6. Utiliza `@services/syncQueue` como fallback si la sincronización directa falla.
103 |         7. **Nota:** Cuando se llama desde `ProfileConfigPage` por primera vez, el objeto `settings` también incluye explícitamente `has_completed_setup: true` para marcar el perfil como configurado.
104 | *   **Supabase Interaction:** Calls `getCurrentUser`, `logout`, `getUserProfile`, `syncUserProfile`, `syncQueue`.
105 | *   **Notes:** Contains the vital `syncAllUserData` orchestrator function. Ensure all necessary stores are listed in its `otherStores` array.
106 | 
107 | ### 3.2. `@store/character/characterStore.ts`
108 | 
109 | *   **Purpose:** Manages user-created characters.
110 | *   **Key State:**
111 |     *   `currentCharacter: StoryCharacter | null`: The character currently being edited or selected.
112 |     *   `savedCharacters: StoryCharacter[]`: List of all characters saved by the user.
113 | *   **Key Actions:**
114 |     *   `updateCharacter(updates)`: Modifies `currentCharacter`.
115 |     *   `resetCharacter()`: Clears `currentCharacter` for creating a new one.
116 |     *   `saveCurrentCharacter()`: Adds/updates `currentCharacter` in `savedCharacters`, calls `@services/supabase.syncCharacter`, uses `syncQueue` on failure. Handles local duplicate name check.
117 |     *   `selectCharacter(characterId)`: Sets `currentCharacter` from `savedCharacters`.
118 |     *   `deleteCharacter(characterId)`: Removes character locally, calls `@services/supabase.deleteCharacter`, uses `syncQueue` on failure.
119 |     *   `loadCharactersFromSupabase(userId)`: Clears `savedCharacters`, fetches via `@services/supabase.getUserCharacters`, updates state. Called by `syncAllUserData`.
120 | *   **Supabase Interaction:** Calls `syncCharacter`, `getUserCharacters`, `deleteCharacter`, `syncQueue`.
121 | *   **Notes:** The previous `setTimeout` for initial load was removed; relies solely on `syncAllUserData`.
122 | 
123 | ### 3.3. `@store/stories/storiesStore.ts`
124 | 
125 | *   **Purpose:** Manages the list of generated stories (metadata and initial content).
126 | *   **Key State:**
127 |     *   `generatedStories: Story[]`: List of stories created by the user.
128 |     *   `isGeneratingStory: boolean`: Flag for UI loading state during story generation.
129 | *   **Key Actions:**
130 |     *   `addGeneratedStory(story)`: Adds a new story locally, calls `@services/supabase.syncStory`, uses `syncQueue` on failure.
131 |         *   **Note:** After this action is successfully called by `@store/stories/storyGenerator.ts`, the generator proceeds to create and save the initial chapter (Chapter 1) using `chaptersStore.addChapter`.
132 |     *   `getStoryById(id)`: Retrieves a specific story from the local state.
133 |     *   `loadStoriesFromSupabase(userId)`: Clears `generatedStories`, fetches via `@services/supabase.getUserStories`, updates state. Called by `syncAllUserData`.
134 | *   **Supabase Interaction:** Calls `syncStory`, `getUserStories`, `syncQueue`.
135 | 
136 | ### 3.4. `@store/storyOptions/storyOptionsStore.ts`
137 | 
138 | *   **Purpose:** Manages the temporary options selected by the user during the story creation flow *before* the story is generated.
139 | *   **Key State:**
140 |     *   `currentStoryOptions: Partial<StoryOptions>`: Holds selected duration, genre, moral, character.
141 |     *   `additionalDetails: string | null | undefined`: Holds optional free-text details or instructions provided by the user to further customize the story generation.
142 | *   **Key Actions:**
143 |     *   `updateStoryOptions(options)`: Updates multiple options at once.
144 |     *   `resetStoryOptions()`: Clears all selected options.
145 |     *   `setDuration(duration)`: Sets the story duration.
146 |     *   `setMoral(moral)`: Sets the story moral.
147 |     *   `setGenre(genre)`: Sets the story genre.
148 |     *   `setAdditionalDetails(details)`: Sets the optional additional details provided by the user. This is read by `storyGenerator.ts` before calling the generation service.
149 | *   **Persistence:** This store is **not persistent** as the options are temporary for the current creation flow.
150 | 
151 | ### 3.5. `@store/stories/chapters/chaptersStore.ts`
152 | 
153 | *   **Purpose:** Manages the individual chapters associated with each story.
154 | *   **Key State:**
155 |     *   `storyChapters: StoryWithChapters[]`: An array where each element represents a story and contains an array of its `chapters`. (Note: This duplicates some story metadata; consider if just storing chapters grouped by `storyId` is sufficient).
156 | *   **Key Actions:**
157 |     *   `addChapter(storyId, chapter)`: Adds a new chapter to the appropriate story in `storyChapters`, calls `@services/supabase.syncChapter`, uses `syncQueue` on failure.
158 |         *   **Important State Update Logic:** To prevent inconsistencies (especially for free user limit checks), the local state (`storyChapters`) is **only updated *after* the `syncChapter` call successfully completes**.
159 |         *   **Note:** This action is called both by `@store/stories/storyGenerator.ts` (for the initial Chapter 1, using the story's title/content) and by `@pages/StoryContinuation.tsx` (for subsequent chapters). The logic for determining the correct `chapterNumber` (either `1` or based on `getChapterCountForStory`) resides in the calling code *before* this action is invoked.
160 |     *   `getChaptersByStoryId(storyId)`: Retrieves chapters for a specific story.
161 |     *   `loadChaptersFromSupabase(storyId)`: Fetches chapters for a *specific story* via `@services/supabase.getStoryChapters`. This is typically called on demand when viewing a story, *not* by `syncAllUserData` initially.
162 | *   **Supabase Interaction:** Calls `syncChapter`, `getStoryChapters`, `syncQueue`.
163 | 
164 | ### 3.6. `@store/stories/audio/audioStore.ts`
165 | 
166 | *   **Purpose:** Manages generated audio files, generation status, and user voice preference.
167 | *   **Key State:**
168 |     *   `audioCache: { [key: string]: { url: string; timestamp: string } }`: Cache of generated audio URLs.
169 |     *   `generationStatus: { [key: string]: { status: string; progress: number } }`: Tracks audio generation progress.
170 |     *   `currentVoice: string | null`: The ID of the user's preferred voice.
171 | *   **Key Actions:**
172 |     *   `addAudioToCache(...)`: Adds audio URL locally, calls `@services/supabase.syncAudioFile`, uses `syncQueue` on failure.
173 |     *   `setCurrentVoice(voiceId)`: Updates state, calls `@services/supabase.setCurrentVoice`.
174 |     *   `loadAudioFromSupabase(userId)`: Fetches *existing* generated audio records and the user's current voice preference via `@services/supabase.getUserAudios` and `@services/supabase.getCurrentVoice`. Called by `syncAllUserData`.
175 | *   **Supabase Interaction:** Calls `syncAudioFile`, `getUserAudios`, `setCurrentVoice`, `getCurrentVoice`, `syncQueue`.
176 | 
177 | ### 3.7. `@store/stories/challenges/challengesStore.ts`
178 | 
179 | *   **Purpose:** Manages challenges and questions associated with stories.
180 | *   **Key State:**
181 |     *   `challenges: Challenge[]`: List of all challenges across stories.
182 | *   **Key Actions:**
183 |     *   `addChallenge(challenge)`: Adds challenge locally, calls `@services/supabase.syncChallenge` (which handles challenge and questions), uses `syncQueue` on failure.
184 |     *   `getChallengesByStoryId(storyId)`: Filters challenges for a specific story.
185 |     *   `loadChallengesFromSupabase(storyId)`: Fetches challenges for a *specific story* via `@services/supabase.getStoryChallenges`. Called on demand.
186 | *   **Supabase Interaction:** Calls `syncChallenge`, `getStoryChallenges`, `syncQueue`.
187 | 
188 | ## 4. Supabase Interaction Layer
189 | 
190 | *   **`@services/supabaseClient.ts`:** **Single source of truth.** Initializes and exports the `supabase` client instance. All other files needing the client *must* import it from here.
191 | *   **`@services/supabaseAuth.ts`:** Handles **authentication** operations ONLY (`signUp`, `login`, `logout`, `signInWithGoogle`, `getCurrentUser`, `requestPasswordReset`). It imports and uses the client from `@supabaseClient.ts`. It *does not* handle profile data or manual state tracking anymore.
192 | *   **`@services/supabase.ts`:** Handles **database operations** ONLY (CRUD for profiles, characters, stories, chapters, audio, challenges, voices). It imports and uses the client from `@supabaseClient.ts`. Relies heavily on Supabase RLS for security and data access control.
193 | *   **Reliance on RLS:** Security and data access rules (e.g., "user can only see their own stories", "user can only insert profile if ID matches auth ID") are primarily enforced by **Row Level Security (RLS) policies** defined directly in the Supabase database, *not* by client-side checks (which were removed).
194 | 
195 | ## 5. Context within the Application
196 | 
197 | *   **Initialization (`@main.ts`):** The entry point initializes the core app (`AppWithAuth`). `AppWithAuth` uses a `useEffect` hook to call `useUserStore.checkAuth()` on mount. After `checkAuth` completes, it calls `@services/syncService.initSyncService()`.
198 | *   **Sync Service (`@services/syncService.ts`):**
199 |     *   `initSyncService`: Called once by `main.ts`. Sets up listeners. Tries an initial sync.
200 |     *   `initSyncListeners`: Listens for `online` and `visibilitychange` events.
201 |     *   `syncUserData`: **Initiator function.** Called on initial load (if online) and by listeners. It verifies connection/session and then triggers the main loading flow by calling `useUserStore.checkAuth()`. **It no longer loads data directly.**
202 | *   **UI Components (`@components/`, `@pages/`):**
203 |     *   Interact with the state using Zustand hooks (e.g., `const { user, profileSettings } = useUserStore();`, `const { savedCharacters, saveCurrentCharacter } = useCharacterStore();`).
204 |     *   Subscribe to state changes and re-render automatically.
205 |     *   Call action functions from the stores (e.g., `saveCurrentCharacter()`, `setProfileSettings(...)`, `addGeneratedStory(...)`) to modify state and trigger backend synchronization.
206 |     *   Use selectors/state data (e.g., `profileSettings.subscription_status`, `profileSettings.voice_credits`) for **Feature Gating**: enabling/disabling buttons, showing/hiding options, displaying limits based on the user's plan.
207 | 
208 | ## 6. Common Issues & Pitfalls Encountered/Resolved
209 | 
210 | *   **RLS Policies:**
211 |     *   **Missing `INSERT` Policy:** Forgetting to define an `INSERT` policy (e.g., for `profiles`) prevents record creation even if the user is authenticated. Solution: Add `CREATE POLICY ... FOR INSERT ... WITH CHECK (auth.uid() = id);`.
212 |     *   **Incorrect Conditions:** Ensure `USING` (for SELECT/UPDATE/DELETE) and `WITH CHECK` (for INSERT/UPDATE) conditions correctly use `auth.uid()` and match the appropriate columns (`id` or `user_id`).
213 | *   **Type Mismatches:**
214 |     *   **`ProfileSettings`:** The type definition in `@types.ts` *must* accurately reflect *all* columns fetched from the `profiles` table by `getUserProfile`, including Stripe/limit fields. Failure leads to TS errors and missing data in the store.
215 |     *   **DB Column Names:** Trying to insert/update a column name (e.g., `age_range`) in Supabase functions (`syncUserProfile`, `syncQueue.addToQueue`) or SQL Functions (`HandleNewUser`) that doesn't exist in the actual DB table causes runtime errors. Solution: Ensure code uses exact DB column names.
216 | *   **Redundant Data Loading:**
217 |     *   Avoid calling individual `load...FromSupabase` methods directly after `checkAuth` if `syncAllUserData` already handles it (e.g., removed in `syncService.ts`).
218 |     *   Avoid using `setTimeout` for initial data loading in stores (e.g., removed in `characterStore.ts`). Rely on the `checkAuth` -> `syncAllUserData` flow.
219 | *   **Supabase Client Initialization:**
220 |     *   Having multiple `createClient` calls leads to confusion and potential errors. Solution: Centralize client creation in `@supabaseClient.ts` and import it everywhere else. Ensure all `import { supabase }` statements point to this single file.
221 | *   **Timing Issues:**
222 |     *   **Post-`signUp` Profile Creation:** Calling profile creation (`syncUserProfile`) *immediately* after `signUp` might fail due to RLS not recognizing the new `auth.uid()` yet. Solution: Integrate profile creation into the standard `checkAuth` / `loginUser` flow, which ensures the session is fully established, or add a small delay/retry if absolutely necessary.
223 | *   **Forgetting Store Orchestration:**
224 |     *   When adding a new store that needs initial data loading, remember to add it to the `otherStores` array within the `syncAllUserData` function in `@userStore.ts`.
225 | *   **Offline Queue (`syncQueue`):**
226 |     *   Ensure data passed to `addToQueue` for `delete` operations contains the necessary `id`.
227 |     *   Stale/incorrect items stuck in `localStorage` can cause repeated errors. Solution: Clear the `sync_queue` key in `localStorage` during debugging if necessary.
228 | *   **SQL Function Security:**
229 |     *   Functions modifying sensitive data or called from untrusted contexts (like webhooks) should generally use `SECURITY DEFINER` (e.g., `increment_voice_credits`). Ensure appropriate `GRANT EXECUTE` permissions are set for the calling role (e.g., `service_role`). Trigger functions often use `INVOKER` or `DEFINER` depending on needs (`handle_new_user` needs `DEFINER`).
230 | 
231 | ## 7. Conclusion
232 | 
233 | This modular Zustand architecture, coupled with a well-defined data synchronization flow orchestrated by `userStore` and reliant on Supabase RLS, provides a robust foundation for the application. Maintaining consistency in Supabase client usage, type definitions, and the central data loading pattern is key to stability. Understanding the interaction between frontend stores, the Supabase service layer, and RLS policies is crucial for debugging and future development. Remember to manage SQL functions via Supabase Migrations for proper version control.
234 | 
235 | ## 8. Race Condition Fixes: Authentication and Story Loading
236 | 
237 | **Authentication Race Condition**
238 | 
239 | - Updated `checkAuth` signature to return `Promise<User | null>` instead of `Promise<boolean>`.
240 | - Refactored `AuthGuard.tsx` to use an internal `authStatus` (`'pending' | 'authenticated' | 'unauthenticated'`), awaiting `checkAuth()` result before rendering or redirecting.
241 | - Eliminated separate `authChecked` state and reliance on store `user` for decision-making.
242 | 
243 | **Story Loading Race Condition**
244 | 
245 | - Added `isLoadingStories: boolean` to `StoriesState` and initialized it in `storiesStore.ts`.
246 | - In `storiesStore.ts`, `loadStoriesFromSupabase` sets `isLoadingStories` to `true` at start and resets it to `false` in `finally`.
247 | - Updated `StoryViewer.tsx` to depend on `isLoadingStories` in its main `useEffect`, exiting early if `true`, and rendering a loading spinner until stories are loaded. Navigation to `/not-found` only occurs if the story remains `undefined` after loading.
248 | 
249 | ## 9. Flujo de Parámetros Contextuales en la Generación de Opciones de Continuación
250 | 
251 | ### 3.2. `@store/stories/storyGenerator.ts`
252 | 
253 | *   **Propósito:** Orquesta la generación de historias y la continuación de las mismas, gestionando tanto la creación inicial como la obtención de opciones de continuación adaptadas al usuario.
254 | *   **Estado Clave:**
255 |     *   `currentStory: Story | null`: Historia activa en el flujo.
256 |     *   `storyChapters: StoryChapter[]`: Capítulos generados hasta el momento.
257 |     *   `continuationOptions: Option[]`: Opciones generadas para continuar la historia, adaptadas al contexto del usuario.
258 | *   **Acciones Clave:**
259 |     *   `generateOptions()`: Llama a `StoryContinuationService.generateContinuationOptions`, pasando además de la historia y capítulos, los parámetros contextuales:
260 |         - `childAge`: Edad del niño/a (desde `profileSettings`).
261 |         - `specialNeed`: Necesidad especial del usuario (desde `profileSettings`).
262 |         - `language`: Idioma preferido del usuario (desde `profileSettings` o historia).
263 |     *   El store se encarga de obtener estos valores desde `userStore.profileSettings` y asegurarse de que se pasan correctamente al servicio y a la Edge Function.
264 | *   **Flujo de Datos:**
265 |     1. El usuario inicia la generación de opciones de continuación desde la UI.
266 |     2. El store recupera los valores de contexto del perfil del usuario.
267 |     3. Se invoca el método del servicio, que a su vez llama a la Edge Function con el prompt contextualizado.
268 |     4. Las opciones generadas se almacenan en el estado y se muestran en la UI.
269 | *   **Impacto:**
270 |     - Esto garantiza que las opciones de historia sean relevantes para la edad, necesidades y preferencias lingüísticas del usuario final, mejorando la personalización y adecuación del contenido.
```

src/App.css
```
1 | #root {
2 |   max-width: 1280px;
3 |   margin: 0 auto;
4 |   padding: 2rem;
5 |   text-align: center;
6 | }
7 | 
8 | .logo {
9 |   height: 6em;
10 |   padding: 1.5em;
11 |   will-change: filter;
12 |   transition: filter 300ms;
13 | }
14 | 
15 | .logo:hover {
16 |   filter: drop-shadow(0 0 2em #BB79D1aa);
17 |   /* Morado Fantasia! */
18 | }
19 | 
20 | .logo.react:hover {
21 |   filter: drop-shadow(0 0 2em #7DC4E0aa);
22 |   /* Azul Fantasia! */
23 | }
24 | 
25 | @keyframes logo-spin {
26 |   from {
27 |     transform: rotate(0deg);
28 |   }
29 | 
30 |   to {
31 |     transform: rotate(360deg);
32 |   }
33 | }
34 | 
35 | @media (prefers-reduced-motion: no-preference) {
36 |   a:nth-of-type(2) .logo {
37 |     animation: logo-spin infinite 20s linear;
38 |   }
39 | }
40 | 
41 | .card {
42 |   padding: 2em;
43 | }
44 | 
45 | .read-the-docs {
46 |   color: #888;
47 | }
```

src/App.tsx
```
1 | import { Toaster } from "@/components/ui/toaster";
2 | import { Toaster as Sonner } from "@/components/ui/sonner";
3 | import { TooltipProvider } from "@/components/ui/tooltip";
4 | import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
5 | import React from 'react';
6 | import { BrowserRouter, Routes, Route } from "react-router-dom";
7 | import { AnimatePresence } from "framer-motion";
8 | import AuthGuard from "./components/AuthGuard";
9 | import MainLayout from "./components/MainLayout";
10 | 
11 | // Pages
12 | import Welcome from "./pages/Welcome";
13 | import Login from "./pages/Login";
14 | import Signup from "./pages/Signup";
15 | import SignupSuccess from "./pages/SignupSuccess";
16 | // import ProfileSetup from "./pages/ProfileSetup"; 
17 | import Home from "./pages/Home";
18 | import CharacterSelection from "./pages/CharacterSelection";
19 | import CharacterName from "./pages/CharacterName";
20 | 
21 | import StoryGenre from "./pages/StoryGenre";
22 | 
23 | import GeneratingStory from "./pages/GeneratingStory";
24 | import StoryViewer from "./pages/StoryViewer";
25 | import StoryAudioPage from "./pages/StoryAudioPage";
26 | import StoryContinuation from "./pages/StoryContinuation";
27 | import SavedStories from "./pages/SavedStories";
28 | import ErrorPage from "./pages/ErrorPage";
29 | import NotFound from "./pages/NotFound";
30 | import AuthCallback from "./pages/AuthCallback";
31 | import CharactersManagement from "./pages/CharactersManagement";
32 | import PaymentSuccess from "./pages/PaymentSuccess";
33 | import PaymentCancel from "./pages/PaymentCancel";
34 | import StoryDetailsInput from "./pages/StoryDetailsInput";
35 | import TermsAndConditions from "./pages/TermsAndConditions";
36 | import PrivacyPolicy from "./pages/PrivacyPolicy";
37 | import Contact from "./pages/Contact";
38 | import Changelog from "./pages/Changelog";
39 | 
40 | // New Pages for Refactor
41 | import ProfileConfigPage from './pages/ProfileConfigPage';
42 | import SettingsPage from './pages/SettingsPage';
43 | import PlansPage from './pages/PlansPage';
44 | 
45 | const queryClient = new QueryClient();
46 | 
47 | const App = () => {
48 |   return (
49 |     <QueryClientProvider client={queryClient}>
50 |       <TooltipProvider>
51 |         <Toaster />
52 |         <Sonner />
53 |         <BrowserRouter>
54 |           <AnimatePresence mode="wait">
55 |             <MainLayout>
56 |               <Routes>
57 |                 {/* Public routes */}
58 |                 <Route path="/" element={<Welcome />} />
59 |                 <Route path="/login" element={<Login />} />
60 |                 <Route path="/signup" element={<Signup />} />
61 |                 <Route path="/signup-success" element={<SignupSuccess />} />
62 |                 <Route path="/error" element={<ErrorPage />} />
63 |                 <Route path="*" element={<NotFound />} />
64 |                 <Route path="/auth/callback" element={<AuthCallback />} />
65 |                 <Route path="/terms" element={<TermsAndConditions />} />
66 |                 <Route path="/privacy-policy" element={<PrivacyPolicy />} />
67 |                 <Route path="/contact" element={<Contact />} />
68 |                 <Route path="/changelog" element={<Changelog />} />
69 | 
70 |                 {/* Payment routes */}
71 |                 <Route path="/payment-success" element={<AuthGuard><PaymentSuccess /></AuthGuard>} />
72 |                 <Route path="/payment-cancel" element={<AuthGuard><PaymentCancel /></AuthGuard>} />
73 | 
74 |                 {/* Protected routes */}
75 |                 <Route path="/home" element={<AuthGuard><Home /></AuthGuard>} />
76 | 
77 |                 <Route path="/characters-management" element={<AuthGuard><CharactersManagement /></AuthGuard>} />
78 |                 <Route path="/character-selection" element={<AuthGuard><CharacterSelection /></AuthGuard>} />
79 |                 <Route path="/character-name" element={<AuthGuard><CharacterName /></AuthGuard>} />
80 |                 <Route path="/story-genre" element={<AuthGuard><StoryGenre /></AuthGuard>} />
81 | 
82 |                 <Route path="/story-details-input" element={<AuthGuard><StoryDetailsInput /></AuthGuard>} />
83 |                 <Route path="/generating" element={<AuthGuard><GeneratingStory /></AuthGuard>} />
84 |                 <Route path="/story/:storyId" element={<AuthGuard><StoryViewer /></AuthGuard>} />
85 |                 <Route path="/story/:storyId/audio/:chapterId?" element={<AuthGuard><StoryAudioPage /></AuthGuard>} />
86 |                 <Route path="/story/:storyId/continue" element={<AuthGuard><StoryContinuation /></AuthGuard>} />
87 |                 <Route path="/stories" element={<AuthGuard><SavedStories /></AuthGuard>} />
88 | 
89 |                 {/* New Protected Routes */}
90 |                 <Route path="/profile-config" element={<AuthGuard><ProfileConfigPage /></AuthGuard>} />
91 |                 <Route path="/settings" element={<AuthGuard><SettingsPage /></AuthGuard>} />
92 |                 <Route path="/plans" element={<AuthGuard><PlansPage /></AuthGuard>} />
93 |               </Routes>
94 |             </MainLayout>
95 |           </AnimatePresence>
96 |         </BrowserRouter>
97 |       </TooltipProvider>
98 |     </QueryClientProvider>
99 |   );
100 | };
101 | 
102 | export default App;
```

src/index.css
```
1 | @tailwind base;
2 | @tailwind components;
3 | @tailwind utilities;
4 | 
5 | @layer base {
6 |   :root {
7 |     /* Fantasia! colors as HSL values */
8 |     --background: 35 100% 98%;
9 |     /* #FFFBF5 - Fondo claro */
10 |     --foreground: 0 0% 29%;
11 |     /* #4A4A4A - Texto principal */
12 | 
13 |     --card: 0 0% 100%;
14 |     /* #FFFFFF - Fondo de tarjetas */
15 |     --card-foreground: 0 0% 29%;
16 |     /* #4A4A4A - Texto en tarjetas */
17 | 
18 |     --popover: 0 0% 100%;
19 |     /* #FFFFFF - Fondo de popovers */
20 |     --popover-foreground: 0 0% 29%;
21 |     /* #4A4A4A - Texto en popovers */
22 | 
23 |     --primary: 284 43% 65%;
24 |     /* #BB79D1 - Morado como primario */
25 |     --primary-foreground: 0 0% 100%;
26 |     /* #FFFFFF - Texto sobre primario */
27 | 
28 |     --secondary: 195 65% 69%;
29 |     /* #7DC4E0 - Azul como secundario */
30 |     --secondary-foreground: 0 0% 100%;
31 |     /* #FFFFFF - Texto sobre secundario */
32 | 
33 |     --muted: 284 43% 90%;
34 |     /* Versión más clara del morado */
35 |     --muted-foreground: 0 0% 46%;
36 |     /* #757575 - Texto secundario */
37 | 
38 |     --accent: 49 94% 68%;
39 |     /* #F9DA60 - Amarillo como acento */
40 |     --accent-foreground: 0 0% 29%;
41 |     /* #4A4A4A - Texto sobre acento */
42 | 
43 |     --destructive: 0 84% 60%;
44 |     /* Mantener el error en rojo */
45 |     --destructive-foreground: 0 0% 98%;
46 | 
47 |     --border: 284 43% 90%;
48 |     /* Borde en tono morado claro */
49 |     --input: 284 43% 95%;
50 |     /* Input en tono morado muy claro */
51 |     --ring: 284 43% 65%;
52 |     /* Ring en tono morado primario */
53 | 
54 |     --radius: 0.75rem;
55 | 
56 |     /* Mantener las variables legacy para compatibilidad */
57 |     --story-purple-50: hsl(284, 43%, 95%);
58 |     --story-purple-100: hsl(284, 43%, 90%);
59 |     --story-purple-200: hsl(284, 43%, 80%);
60 |     --story-purple-300: hsl(284, 43%, 70%);
61 |     --story-purple-400: hsl(284, 43%, 65%);
62 |     --story-purple-500: hsl(284, 43%, 60%);
63 | 
64 |     --story-orange-400: hsl(49, 94%, 68%);
65 |     --story-orange-500: hsl(49, 94%, 60%);
66 |   }
67 | 
68 |   .dark {
69 |     --background: 284 43% 15%;
70 |     /* Fondo oscuro basado en el morado */
71 |     --foreground: 0 0% 90%;
72 |     /* Texto claro sobre fondo oscuro */
73 | 
74 |     --card: 284 43% 20%;
75 |     /* Tarjetas en tono morado oscuro */
76 |     --card-foreground: 0 0% 90%;
77 |     /* Texto claro sobre tarjetas */
78 | 
79 |     --popover: 284 43% 20%;
80 |     /* Popovers en tono morado oscuro */
81 |     --popover-foreground: 0 0% 90%;
82 |     /* Texto claro sobre popovers */
83 | 
84 |     --primary: 284 43% 70%;
85 |     /* Primario un poco más claro para dark mode */
86 |     --primary-foreground: 0 0% 98%;
87 | 
88 |     --secondary: 195 65% 69%;
89 |     /* Mantener el azul para secondary */
90 |     --secondary-foreground: 0 0% 15%;
91 | 
92 |     --muted: 284 43% 25%;
93 |     /* Muted en tono morado oscuro */
94 |     --muted-foreground: 0 0% 60%;
95 |     /* Texto muted más claro */
96 | 
97 |     --accent: 49 94% 68%;
98 |     /* Mantener el amarillo para accent */
99 |     --accent-foreground: 0 0% 15%;
100 | 
101 |     --destructive: 0 62.8% 30.6%;
102 |     --destructive-foreground: 0 0% 98%;
103 | 
104 |     --border: 284 43% 30%;
105 |     /* Borde más oscuro */
106 |     --input: 284 43% 30%;
107 |     /* Input más oscuro */
108 |     --ring: 284 43% 70%;
109 |     /* Ring en tono morado claro */
110 |   }
111 | }
112 | 
113 | @layer base {
114 |   * {
115 |     @apply border-border;
116 |   }
117 | 
118 |   html,
119 |   body {
120 |     @apply font-sans bg-background text-text-primary min-h-screen overflow-x-hidden;
121 |     -webkit-font-smoothing: antialiased;
122 |     -moz-osx-font-smoothing: grayscale;
123 |     font-feature-settings: "rlig" 1, "calt" 1;
124 |   }
125 | 
126 |   h1,
127 |   h2,
128 |   h3,
129 |   h4,
130 |   h5,
131 |   h6 {
132 |     @apply font-heading;
133 |   }
134 | 
135 |   /* Hide scrollbar for Chrome, Safari and Opera */
136 |   .hide-scrollbar::-webkit-scrollbar {
137 |     display: none;
138 |   }
139 | 
140 |   /* Hide scrollbar for IE, Edge and Firefox */
141 |   .hide-scrollbar {
142 |     -ms-overflow-style: none;
143 |     /* IE and Edge */
144 |     scrollbar-width: none;
145 |     /* Firefox */
146 |   }
147 | }
148 | 
149 | @layer components {
150 |   .story-card {
151 |     @apply relative rounded-3xl bg-gradient-to-br from-white/15 to-white/5 backdrop-blur-md shadow-lg border border-white/20 overflow-hidden transition-all duration-300 ease-in-out;
152 |   }
153 | 
154 |   .glass-card {
155 |     @apply bg-white/15 backdrop-blur-md border border-white/20 rounded-3xl shadow-md;
156 |   }
157 | 
158 |   .gradient-bg {
159 |     @apply bg-gradient-to-br from-brand-purple via-brand-blue to-brand-pink;
160 |   }
161 | 
162 |   .story-btn {
163 |     @apply rounded-2xl px-8 py-4 text-lg font-medium transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-2;
164 |   }
165 | 
166 |   .story-btn-primary {
167 |     @apply story-btn bg-gradient-to-r from-brand-purple to-brand-blue text-white shadow-md hover:shadow-xl hover:from-brand-purple hover:to-brand-purple focus:ring-2 focus:ring-brand-purple/20 focus:ring-offset-2 font-semibold;
168 |   }
169 | 
170 |   .story-btn-secondary {
171 |     @apply story-btn bg-white/15 backdrop-blur-md text-white border border-white/30 hover:bg-white/25 hover:shadow-md hover:border-white/40;
172 |   }
173 | 
174 |   /* Narrar con Voz & Volver al Inicio buttons */
175 |   .nav-button {
176 |     @apply flex items-center justify-center gap-2 px-6 py-3 rounded-xl transition-all duration-300;
177 |     @apply bg-white/15 backdrop-blur-lg border border-white/20;
178 |     @apply hover:bg-white/25 hover:shadow-lg hover:border-white/30 hover:scale-105;
179 |     @apply active:scale-95 text-white font-medium;
180 |     text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
181 |     box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), inset 0 1px 1px rgba(255, 255, 255, 0.2);
182 |   }
183 | 
184 |   .nav-button svg {
185 |     @apply transition-transform duration-300;
186 |   }
187 | 
188 |   .nav-button:hover svg {
189 |     @apply transform scale-110;
190 |   }
191 | 
192 |   .story-input {
193 |     @apply w-full rounded-xl border border-white/20 bg-white/15 backdrop-blur-md px-4 py-3 text-black placeholder:text-white/60 focus:outline-none focus:ring-2 focus:ring-story-orange-400/70 shadow-md;
194 |   }
195 | 
196 |   /* Override for white background Select components */
197 |   .bg-white .SelectTrigger,
198 |   .bg-white .SelectContent,
199 |   .bg-white .SelectItem,
200 |   .SelectContent,
201 |   .story-input.bg-white {
202 |     @apply text-black font-medium;
203 |   }
204 | 
205 |   /* Fix for SelectContent items */
206 |   .SelectItem {
207 |     @apply text-black;
208 |   }
209 | 
210 |   /* Updated input styles for white backgrounds */
211 |   input.bg-white,
212 |   select.bg-white,
213 |   textarea.bg-white,
214 |   .bg-white input,
215 |   .bg-white select,
216 |   .bg-white textarea,
217 |   [data-theme="light"] input,
218 |   [data-theme="light"] select,
219 |   [data-theme="light"] textarea,
220 |   .SelectTrigger[style*="background: white"],
221 |   .SelectContent,
222 |   div[style*="background-color: white"] input,
223 |   div[style*="background-color: white"] select,
224 |   div[style*="background-color: white"] textarea,
225 |   div[style*="background: white"] input,
226 |   div[style*="background: white"] select,
227 |   div[style*="background: white"] textarea,
228 |   input[style*="background: white"],
229 |   select[style*="background: white"],
230 |   textarea[style*="background: white"] {
231 |     @apply text-black placeholder:text-gray-500;
232 |   }
233 | 
234 |   .story-label {
235 |     @apply block text-base font-medium text-white mb-2;
236 |   }
237 | 
238 |   .story-choice-card {
239 |     @apply relative overflow-hidden rounded-3xl bg-gradient-to-br from-white/20 to-white/10 backdrop-blur-md border border-white/20 transition-all duration-300 ease-in-out cursor-pointer hover:scale-105 active:scale-95 flex flex-col items-center justify-center gap-3 p-4 shadow-md hover:shadow-lg;
240 |   }
241 | 
242 |   .story-page-container {
243 |     @apply min-h-screen w-full flex flex-col items-center justify-center p-6 relative overflow-hidden animate-fade-in;
244 |   }
245 | 
246 |   .page-transition-enter {
247 |     opacity: 0;
248 |     transform: translateY(20px);
249 |   }
250 | 
251 |   .page-transition-enter-active {
252 |     opacity: 1;
253 |     transform: translateY(0);
254 |     transition: opacity 500ms, transform 500ms;
255 |   }
256 | 
257 |   .page-transition-exit {
258 |     opacity: 1;
259 |     transform: translateY(0);
260 |   }
261 | 
262 |   .page-transition-exit-active {
263 |     opacity: 0;
264 |     transform: translateY(-20px);
265 |     transition: opacity 500ms, transform 500ms;
266 |   }
267 | 
268 |   .audio-player-controls {
269 |     @apply flex items-center justify-center gap-6 mt-6;
270 |   }
271 | 
272 |   .audio-player-btn {
273 |     @apply w-14 h-14 rounded-full flex items-center justify-center transition-all duration-300 ease-in-out hover:bg-white/20 active:bg-white/30 text-white;
274 |   }
275 | 
276 |   .audio-player-progress {
277 |     @apply w-full h-2 bg-white/20 rounded-full overflow-hidden mt-4;
278 |   }
279 | 
280 |   .audio-player-progress-bar {
281 |     @apply h-full bg-story-orange-400;
282 |   }
283 | 
284 |   /* Custom animation for spinner */
285 |   .animate-spin-slow {
286 |     animation: spin 3s linear infinite;
287 |   }
288 | 
289 |   @keyframes spin {
290 |     from {
291 |       transform: rotate(0deg);
292 |     }
293 | 
294 |     to {
295 |       transform: rotate(360deg);
296 |     }
297 |   }
298 | }
299 | 
300 | /* Print styles */
301 | @media print {
302 |   .gradient-bg {
303 |     background: white !important;
304 |     color: black !important;
305 |   }
306 | 
307 |   .bg-white\/20,
308 |   .bg-white\/15,
309 |   .bg-white\/10 {
310 |     background: white !important;
311 |     color: black !important;
312 |     border: 1px solid #ddd !important;
313 |   }
314 | 
315 |   .text-white {
316 |     color: black !important;
317 |   }
318 | 
319 |   button,
320 |   .story-btn {
321 |     display: none !important;
322 |   }
323 | }
324 | 
325 | /* Fix high contrast */
326 | .text-white {
327 |   text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
328 | }
329 | 
330 | .story-choice-card:hover {
331 |   box-shadow: 0 0 0 2px rgba(244, 162, 97, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2);
332 | }
333 | 
334 | .voice-settings {
335 |   @apply mt-4;
336 | }
337 | 
338 | .voice-settings select {
339 |   @apply bg-white/20 text-white rounded-lg px-4 py-2 backdrop-blur-md outline-none focus:ring-2 focus:ring-purple-300;
340 | }
341 | 
342 | .voice-settings input[type="range"] {
343 |   @apply w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer;
344 | }
345 | 
346 | .voice-settings input[type="range"]::-webkit-slider-thumb {
347 |   @apply appearance-none w-4 h-4 rounded-full bg-story-orange-400 cursor-pointer;
348 | }
349 | 
350 | .animate-fadeIn {
351 |   animation: fadeIn 0.3s ease-in-out;
352 | }
353 | 
354 | @keyframes fadeIn {
355 |   from {
356 |     opacity: 0;
357 |     transform: translateY(-10px);
358 |   }
359 | 
360 |   to {
361 |     opacity: 1;
362 |     transform: translateY(0);
363 |   }
364 | }
```

src/main.tsx
```
1 | import { createRoot } from 'react-dom/client'
2 | import { useEffect } from 'react'
3 | import App from './App.tsx'
4 | import './index.css'
5 | import { useUserStore } from './store/user/userStore'
6 | import { initSyncService } from './services/syncService'
7 | 
8 | // Component to handle authentication check on app load
9 | const AppWithAuth = () => {
10 |   const { checkAuth } = useUserStore()
11 | 
12 |   useEffect(() => {
13 |     // Check authentication status when app loads
14 |     const initAuth = async () => {
15 |       await checkAuth()
16 |       // Inicializar el servicio de sincronización después de verificar autenticación
17 |       initSyncService()
18 |     }
19 |     
20 |     initAuth()
21 |   }, [checkAuth])
22 | 
23 |   return <App />
24 | }
25 | 
26 | createRoot(document.getElementById("root")!).render(<AppWithAuth />)
```

src/supabaseAuth.ts
```
1 | // Importa el cliente ÚNICO desde supabaseClient.ts
2 | import { supabase } from "./supabaseClient"; // Asegúrate que la ruta es correcta
3 | import { User } from "./types"; // Asume que estos tipos son correctos
4 | 
5 | // Listener de Auth simplificado (opcional, solo para logging)
6 | supabase.auth.onAuthStateChange((event, session) => {
7 |   console.log(`Auth Event: ${event}`, session ? `User: ${session.user.id}` : 'No session');
8 | });
9 | 
10 | // --- Funciones de Autenticación ---
11 | 
12 | export const signUp = async (
13 |   email: string,
14 |   password: string,
15 | ): Promise<{ user: User | null; error: Error | null }> => {
16 |   // Eliminada la llamada a clearSessionData
17 |   try {
18 |     const { data, error } = await supabase.auth.signUp({
19 |       email,
20 |       password,
21 |       // Opciones adicionales si las necesitas (e.g., data para metadata inicial)
22 |     });
23 | 
24 |     if (error) {
25 |       console.error("Error en signUp:", error.message);
26 |       return { user: null, error };
27 |     }
28 | 
29 |     // ¡Importante! signUp puede requerir verificación de email.
30 |     // data.user puede existir pero data.session ser null hasta la verificación.
31 |     // La lógica que llama a signUp debe manejar esto.
32 |     if (!data.user) {
33 |       // Esto no debería ocurrir si no hay error, pero por si acaso.
34 |       console.error("signUp exitoso pero no se devolvió usuario.");
35 |       return { user: null, error: new Error("User creation failed unexpectedly") };
36 |     }
37 | 
38 |     // Devolver solo la información básica del usuario creado.
39 |     // El proceso de login/checkAuth se encargará de establecer la sesión completa y cargar datos.
40 |     return {
41 |       user: {
42 |         id: data.user.id,
43 |         email: data.user.email || "",
44 |       },
45 |       error: null,
46 |     };
47 |   } catch (err) {
48 |     console.error("Error inesperado durante signUp:", err);
49 |     return { user: null, error: err as Error };
50 |   }
51 | };
52 | 
53 | export const signInWithGoogle = async (): Promise<{ error: Error | null }> => {
54 |   // Eliminada la llamada a clearSessionData
55 |   try {
56 |     const { error } = await supabase.auth.signInWithOAuth({
57 |       provider: "google",
58 |       options: {
59 |         // Asegúrate que esta URL está en la lista de URLs permitidas en Supabase Auth settings
60 |         redirectTo: `${window.location.origin}/auth/callback`, // o tu ruta de callback
61 |       },
62 |     });
63 | 
64 |     if (error) {
65 |       console.error("Error en signInWithGoogle:", error.message);
66 |       return { error };
67 |     }
68 |     // signInWithOAuth redirige, no devuelve usuario/sesión aquí.
69 |     // El manejo se hace en la página de callback.
70 |     return { error: null };
71 |   } catch (err) {
72 |     console.error("Error inesperado durante signInWithGoogle:", err);
73 |     return { error: err as Error };
74 |   }
75 | };
76 | 
77 | export const login = async (
78 |   email: string,
79 |   password: string,
80 | ): Promise<{ user: User | null; error: Error | null }> => {
81 |   // Eliminada la llamada a clearSessionData
82 |   try {
83 |     const { data, error } = await supabase.auth.signInWithPassword({
84 |       email,
85 |       password,
86 |     });
87 | 
88 |     if (error) {
89 |       console.error("Error en login:", error.message);
90 |       return { user: null, error };
91 |     }
92 | 
93 |     // signIn devuelve tanto user como session si es exitoso
94 |     if (!data.user || !data.session) {
95 |       console.error("Login exitoso pero faltan datos de usuario o sesión.");
96 |       return { user: null, error: new Error("Login failed unexpectedly") };
97 |     }
98 | 
99 |     // Devolver usuario básico. El userStore.checkAuth/loginUser
100 |     // se encargará de actualizar el estado global y cargar datos.
101 |     return {
102 |       user: {
103 |         id: data.user.id,
104 |         email: data.user.email || "",
105 |       },
106 |       error: null,
107 |     };
108 |   } catch (err) {
109 |     console.error("Error inesperado durante login:", err);
110 |     return { user: null, error: err as Error };
111 |   }
112 | };
113 | 
114 | export const logout = async (): Promise<{ error: Error | null }> => {
115 |   // Eliminada la llamada a clearSessionData
116 |   try {
117 |     // El userStore.logoutUser debería llamar a syncQueue.processQueue() ANTES de llamar a esta función.
118 |     const { error } = await supabase.auth.signOut();
119 | 
120 |     if (error) {
121 |       console.error("Error en logout:", error.message);
122 |       // Incluso si hay error, el estado local debe limpiarse. userStore lo hará.
123 |       return { error };
124 |     }
125 | 
126 |     // El estado local (stores, userStore.user) será limpiado por userStore.logoutUser
127 |     // después de llamar a esta función de signOut.
128 |     return { error: null };
129 |   } catch (err) {
130 |     console.error("Error inesperado durante logout:", err);
131 |     return { error: err as Error };
132 |   }
133 | };
134 | 
135 | // ELIMINADAS las funciones getProfile y updateProfile. Usar getUserProfile y syncUserProfile de supabase.ts
136 | 
137 | // getCurrentUser sigue siendo útil como una forma rápida de obtener el usuario básico.
138 | export const getCurrentUser = async (): Promise<{ user: User | null; error: Error | null }> => {
139 |   try {
140 |     // getUser es preferible a getSession si solo necesitas el usuario y quieres forzar refresco si es necesario.
141 |     const { data: { user }, error } = await supabase.auth.getUser();
142 | 
143 |     if (error) {
144 |       // No loguear error aquí necesariamente, puede ser normal si no hay sesión.
145 |       return { user: null, error };
146 |     }
147 | 
148 |     if (!user) {
149 |       return { user: null, error: null }; // Sin usuario, sin error.
150 |     }
151 | 
152 |     return {
153 |       user: {
154 |         id: user.id,
155 |         email: user.email || "",
156 |       },
157 |       error: null,
158 |     };
159 |   } catch (err) {
160 |     // Capturar errores inesperados del propio método getUser
161 |     console.error("Error inesperado en getCurrentUser:", err);
162 |     return { user: null, error: err as Error };
163 |   }
164 | };
165 | 
166 | export const requestPasswordReset = async (
167 |   email: string,
168 | ): Promise<{ error: Error | null }> => {
169 |   try {
170 |     const { error } = await supabase.auth.resetPasswordForEmail(email, {
171 |       // Asegúrate que esta ruta existe y maneja la actualización de contraseña
172 |       redirectTo: `${window.location.origin}/update-password`, // Ruta para actualizar contraseña
173 |     });
174 | 
175 |     if (error) {
176 |       console.error("Error solicitando reseteo de contraseña:", error.message);
177 |       return { error };
178 |     }
179 | 
180 |     return { error: null };
181 |   } catch (err) {
182 |     console.error("Error inesperado solicitando reseteo de contraseña:", err);
183 |     return { error: err as Error };
184 |   }
185 | };
```

src/supabaseClient.ts
```
1 | import { createClient } from "@supabase/supabase-js";
2 | 
3 | const supabaseUrl = import.meta.env.VITE_SUPABASE_URL as string;
4 | const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY as string;
5 | 
6 | export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

src/vite-env.d.ts
```
1 | /// <reference types="vite/client" />
```

supabase/config.toml
```
1 | # supabase/config.toml
2 | 
3 | # For detailed configuration reference documentation, visit:
4 | # https://supabase.com/docs/guides/local-development/cli/config
5 | # A string used to distinguish different Supabase projects on the same host. Defaults to the
6 | # working directory name when running `supabase init`.
7 | project_id = "vgzhkvnrutesdynrrlpm"
8 | 
9 | [api]
10 | enabled = true
11 | port = 54321
12 | schemas = ["public", "graphql_public"]
13 | extra_search_path = ["public", "extensions"]
14 | max_rows = 1000
15 | 
16 | [api.tls]
17 | enabled = false
18 | 
19 | [db]
20 | port = 54322
21 | shadow_port = 54320
22 | major_version = 15
23 | 
24 | [db.pooler]
25 | enabled = false
26 | port = 54329
27 | pool_mode = "transaction"
28 | default_pool_size = 20
29 | max_client_conn = 100
30 | 
31 | [db.migrations]
32 | schema_paths = []
33 | 
34 | [db.seed]
35 | enabled = true
36 | sql_paths = ["./seed.sql"]
37 | 
38 | [realtime]
39 | enabled = true
40 | 
41 | [studio]
42 | enabled = true
43 | port = 54323
44 | api_url = "http://127.0.0.1"
45 | openai_api_key = "env(OPENAI_API_KEY)"
46 | 
47 | [inbucket]
48 | enabled = true
49 | port = 54324
50 | 
51 | [storage]
52 | enabled = true
53 | file_size_limit = "50MiB"
54 | 
55 | [auth]
56 | enabled = true
57 | # --- Asegúrate que estas URLs coincidan con tu config remota o local deseada ---
58 | site_url = "http://localhost:8080"
59 | additional_redirect_urls = ["http://localhost:8080/auth/v1/callback"]
60 | # --- Fin URLs ---
61 | jwt_expiry = 3600
62 | enable_refresh_token_rotation = true
63 | refresh_token_reuse_interval = 10
64 | enable_signup = true
65 | enable_anonymous_sign_ins = false
66 | enable_manual_linking = false
67 | minimum_password_length = 6
68 | password_requirements = ""
69 | 
70 | [auth.rate_limit]
71 | email_sent = 2
72 | sms_sent = 30
73 | anonymous_users = 30
74 | token_refresh = 150
75 | sign_in_sign_ups = 30
76 | token_verifications = 30
77 | 
78 | [auth.email]
79 | enable_signup = true
80 | double_confirm_changes = true
81 | enable_confirmations = false
82 | secure_password_change = false
83 | max_frequency = "1m0s"
84 | otp_length = 6
85 | otp_expiry = 86400
86 | 
87 | [auth.sms]
88 | enable_signup = false
89 | enable_confirmations = false
90 | template = "Your code is {{ .Code }}"
91 | max_frequency = "5s"
92 | 
93 | [auth.sms.twilio]
94 | enabled = false
95 | account_sid = ""
96 | message_service_sid = ""
97 | auth_token = "env(SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN)"
98 | 
99 | [auth.mfa]
100 | max_enrolled_factors = 10
101 | 
102 | [auth.mfa.totp]
103 | enroll_enabled = true
104 | verify_enabled = true
105 | 
106 | [auth.mfa.phone]
107 | enroll_enabled = false
108 | verify_enabled = false
109 | otp_length = 6
110 | template = "Your code is {{ .Code }}"
111 | max_frequency = "5s"
112 | 
113 | [auth.external.apple]
114 | enabled = false
115 | client_id = ""
116 | secret = "env(SUPABASE_AUTH_EXTERNAL_APPLE_SECRET)"
117 | redirect_uri = ""
118 | url = ""
119 | skip_nonce_check = false
120 | 
121 | [auth.third_party.firebase]
122 | enabled = false
123 | 
124 | [auth.third_party.auth0]
125 | enabled = false
126 | 
127 | [auth.third_party.aws_cognito]
128 | enabled = false
129 | 
130 | [auth.third_party.clerk]
131 | enabled = false
132 | 
133 | # --- NO DEBE HABER SECCIÓN [functions] AQUÍ ---
134 | 
135 | [edge_runtime]
136 | enabled = true
137 | policy = "oneshot"
138 | inspector_port = 8083
139 | deno_version = 1
140 | 
141 | [analytics]
142 | enabled = true
143 | port = 54327
144 | backend = "postgres"
145 | 
146 | [experimental]
147 | orioledb_version = ""
148 | s3_host = "env(S3_HOST)"
149 | s3_region = "env(S3_REGION)"
150 | s3_access_key = "env(S3_ACCESS_KEY)"
151 | s3_secret_key = "env(S3_SECRET_KEY)"
```

test-edge-functions/test-data.js
```
1 | // test-data.js - Datos de prueba realistas para Edge Functions
2 | // Datos que simulan exactamente lo que enviaría el frontend
3 | 
4 | export const testCharacters = [
5 |   {
6 |     id: "char-luna-001",
7 |     name: "Luna",
8 |     profession: "Astronauta",
9 |     hobbies: ["explorar", "leer"],
10 |     personality: "valiente",
11 |     description: "Una valiente astronauta que ama explorar el universo",
12 |     characterType: "custom"
13 |   },
14 |   {
15 |     id: "char-max-002", 
16 |     name: "Chef Max",
17 |     profession: "Cocinero",
18 |     hobbies: ["cocinar", "jardinería"],
19 |     personality: "creativo",
20 |     description: "Un chef creativo que cultiva sus propios ingredientes",
21 |     characterType: "custom"
22 |   },
23 |   {
24 |     id: "char-ruby-003",
25 |     name: "Dra. Ruby",
26 |     profession: "Doctora",
27 |     hobbies: ["ayudar", "estudiar"],
28 |     personality: "amable",
29 |     description: "Una doctora amable que siempre quiere ayudar a otros",
30 |     characterType: "custom"
31 |   }
32 | ];
33 | 
34 | // singleCharacter removed - now using unified multiple character system
35 | 
36 | // Payload para test de múltiples personajes (con compatibilidad temporal)
37 | export const multipleCharactersPayload = {
38 |   options: {
39 |     characters: testCharacters,
40 |     character: testCharacters[0], // Temporal: para compatibilidad con versión actual deployada
41 |     genre: "aventura",
42 |     moral: "La amistad y el trabajo en equipo son más valiosos que cualquier tesoro",
43 |     duration: "medium"
44 |   },
45 |   language: "es",
46 |   childAge: 7,
47 |   additionalDetails: "Una historia donde Luna, Chef Max y Dra. Ruby trabajan juntos para resolver un misterio. Cada uno debe usar sus habilidades únicas."
48 | };
49 | 
50 | // singleCharacterPayload removed - now using unified multiple character system
51 | 
52 | // Datos para test de continuación
53 | export const mockStory = {
54 |   id: "story-test-001",
55 |   title: "La Gran Aventura de Luna, Chef Max y Dra. Ruby",
56 |   content: `Había una vez tres amigos muy especiales que vivían en el pueblo de Estrella Dorada. Luna era una valiente astronauta que siempre miraba las estrellas con curiosidad. Chef Max era un cocinero creativo que preparaba los platos más deliciosos del pueblo. Y la Dra. Ruby era una doctora amable que cuidaba de todos los habitantes.
57 | 
58 | Un día, mientras Luna observaba el cielo con su telescopio, vio algo muy extraño: una luz brillante que caía del cielo como una estrella fugaz. "¡Amigos!" gritó Luna emocionada. "Tenemos que investigar esto juntos."
59 | 
60 | Chef Max dejó su cocina y la Dra. Ruby cerró su consulta. Los tres amigos se dirigieron hacia el lugar donde había caído la misteriosa luz. Al llegar, encontraron un pequeño meteorito que brillaba con colores mágicos.
61 | 
62 | "Esto es fascinante," dijo la Dra. Ruby examinando el objeto. "Nunca había visto algo así."
63 | "Tal vez podamos usarlo para algo especial," sugirió Chef Max con una sonrisa.
64 | 
65 | Pero de repente, el meteorito comenzó a emitir una música misteriosa...`,
66 |   options: {
67 |     characters: testCharacters,
68 |     character: testCharacters[0], // Compatibilidad hacia atrás
69 |     genre: "aventura", 
70 |     moral: "La amistad y el trabajo en equipo son más valiosos que cualquier tesoro",
71 |     duration: "medium",
72 |     language: "es"
73 |   },
74 |   createdAt: new Date().toISOString()
75 | };
76 | 
77 | export const mockChapters = [
78 |   {
79 |     id: "chapter-001",
80 |     chapter_number: 1,
81 |     title: "El Descubrimiento del Meteorito Musical",
82 |     content: `Los tres amigos se acercaron más al meteorito brillante. La música que emanaba de él era dulce y misteriosa, como si estuviera llamándolos.
83 | 
84 | "¿Creen que sea seguro?" preguntó la Dra. Ruby, sacando su estetoscopio para examinar el objeto.
85 | 
86 | Luna, con su valentía característica, se acercó primero. "Como astronauta, he estudiado muchos meteoritos. Este definitivamente no es normal, ¡pero parece amigable!"
87 | 
88 | Chef Max tuvo una idea brillante. "¿Y si preparamos algo especial para darle la bienvenida? En mi experiencia, la buena comida siempre ayuda a hacer amigos."
89 | 
90 | Mientras Chef Max sacaba ingredientes de su mochila de aventuras, la Dra. Ruby notó que el meteorito parecía responder a sus voces haciéndose más brillante.
91 | 
92 | "¡Creo que nos está escuchando!" exclamó Ruby con emoción.
93 | 
94 | De repente, del meteorito salió una pequeña criatura espacial del tamaño de una ardilla, con ojos grandes y brillantes como estrellas...`
95 |   }
96 | ];
97 | 
98 | // Configuraciones de test variadas
99 | export const testConfigurations = {
100 |   multipleShort: {
101 |     ...multipleCharactersPayload,
102 |     options: {
103 |       ...multipleCharactersPayload.options,
104 |       duration: "short"
105 |     }
106 |   },
107 |   multipleLong: {
108 |     ...multipleCharactersPayload,
109 |     options: {
110 |       ...multipleCharactersPayload.options,
111 |       duration: "long"
112 |     }
113 |   },
114 |   multipleFantasy: {
115 |     ...multipleCharactersPayload,
116 |     options: {
117 |       ...multipleCharactersPayload.options,
118 |       genre: "fantasía",
119 |       moral: "La magia está en la amistad verdadera"
120 |     }
121 |   },
122 |   specialNeedTEA: {
123 |     ...multipleCharactersPayload,
124 |     specialNeed: "TEA",
125 |     childAge: 6
126 |   }
127 | };
128 | 
129 | // URLs de Supabase (usando secrets disponibles en Supabase)
130 | export const getSupabaseConfig = () => ({
131 |   supabaseUrl: Deno.env.get("SUPABASE_URL"),
132 |   serviceRoleKey: Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") || Deno.env.get("APP_SERVICE_ROLE_KEY"),
133 |   anonKey: Deno.env.get("SUPABASE_ANON_KEY"),
134 |   geminiApiKey: Deno.env.get("GEMINI_API_KEY"),
135 |   textModel: Deno.env.get("TEXT_MODEL_GENERATE")
136 | });
137 | 
138 | // Función helper para crear headers
139 | export const createHeaders = (serviceRoleKey) => ({
140 |   'Authorization': `Bearer ${serviceRoleKey}`,
141 |   'Content-Type': 'application/json',
142 |   'apikey': serviceRoleKey
143 | });
144 | 
145 | // Validadores de respuesta
146 | export const validateStoryResponse = (response) => {
147 |   const errors = [];
148 |   
149 |   if (!response.title || typeof response.title !== 'string') {
150 |     errors.push('Título faltante o inválido');
151 |   }
152 |   
153 |   if (!response.content || typeof response.content !== 'string') {
154 |     errors.push('Contenido faltante o inválido');
155 |   }
156 |   
157 |   if (response.content && response.content.length < 100) {
158 |     errors.push('Contenido demasiado corto');
159 |   }
160 |   
161 |   return {
162 |     isValid: errors.length === 0,
163 |     errors
164 |   };
165 | };
166 | 
167 | export const validateContinuationOptionsResponse = (response) => {
168 |   const errors = [];
169 |   
170 |   if (!response.options || !Array.isArray(response.options)) {
171 |     errors.push('Opciones faltantes o no es array');
172 |   } else {
173 |     if (response.options.length !== 3) {
174 |       errors.push(`Se esperaban 3 opciones, se recibieron ${response.options.length}`);
175 |     }
176 |     
177 |     response.options.forEach((option, index) => {
178 |       if (!option.summary || typeof option.summary !== 'string') {
179 |         errors.push(`Opción ${index + 1}: summary faltante o inválido`);
180 |       }
181 |     });
182 |   }
183 |   
184 |   return {
185 |     isValid: errors.length === 0,
186 |     errors
187 |   };
188 | };
189 | 
190 | // Helper para contar menciones de personajes
191 | export const analyzeCharacterPresence = (content, characters) => {
192 |   const analysis = {};
193 |   
194 |   characters.forEach(char => {
195 |     const mentions = (content.match(new RegExp(char.name, 'gi')) || []).length;
196 |     analysis[char.name] = {
197 |       mentions,
198 |       profession: char.profession,
199 |       hasHobbies: char.hobbies.some(hobby => 
200 |         content.toLowerCase().includes(hobby.toLowerCase())
201 |       )
202 |     };
203 |   });
204 |   
205 |   return analysis;
206 | };
207 | 
208 | // Payloads para Story Continuation Actions
209 | 
210 | // Payload para test de continuación con opción seleccionada
211 | export const optionContinuationPayload = {
212 |   action: 'optionContinuation',
213 |   story: mockStory,
214 |   chapters: mockChapters,
215 |   selectedOptionSummary: "La pequeña criatura espacial emite sonidos curiosos. Los amigos intentan descubrir si puede hablar o necesita algo.",
216 |   language: 'es',
217 |   childAge: 7
218 | };
219 | 
220 | // Payload para test de continuación libre
221 | export const freeContinuationPayload = {
222 |   action: 'freeContinuation',
223 |   story: mockStory,
224 |   chapters: mockChapters,
225 |   language: 'es',
226 |   childAge: 7
227 | };
228 | 
229 | // Payload para test de continuación dirigida
230 | export const directedContinuationPayload = {
231 |   action: 'directedContinuation',
232 |   story: mockStory,
233 |   chapters: mockChapters,
234 |   userDirection: "Los tres amigos descubren que la criatura espacial puede hablar y les cuenta que viene de un planeta lejano donde necesitan ayuda urgente.",
235 |   language: 'es',
236 |   childAge: 7
237 | };
238 | 
239 | console.log('📦 Test data loaded successfully');
240 | console.log(`🎭 ${testCharacters.length} test characters available`);
241 | console.log(`⚙️ ${Object.keys(testConfigurations).length} test configurations ready`);
```

test-edge-functions/test-simple.js
```
1 | #!/usr/bin/env deno run --allow-env --allow-net --allow-read --allow-run
2 | // test-simple.js - Script simplificado para testear Edge Functions
3 | 
4 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
5 | import {
6 |   multipleCharactersPayload,
7 |   // singleCharacterPayload removed
8 |   mockStory,
9 |   mockChapters,
10 |   optionContinuationPayload,
11 |   freeContinuationPayload,
12 |   directedContinuationPayload,
13 |   createHeaders,
14 |   validateStoryResponse,
15 |   validateContinuationOptionsResponse,
16 |   analyzeCharacterPresence,
17 |   testCharacters
18 | } from './test-data.js';
19 | 
20 | // Variables de entorno
21 | const SUPABASE_URL = "https://vgzhkvnrutesdynrrlpm.supabase.co";
22 | const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnemhrdm5ydXRlc2R5bnJybHBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MDc4NzksImV4cCI6MjA2NzQ4Mzg3OX0.cjWfW_GdhQpiF_-hq6IcoWNEDLx2Yncqe8Bx0DqvW3E";
23 | const SUPABASE_SERVICE_ROLE_KEY = "[NECESITA_SER_CONFIGURADO_CON_SERVICE_ROLE_KEY_DEL_NUEVO_PROYECTO]";
24 | const GEMINI_API_KEY = "AIzaSyDTy4EX8f-GNIJJi1mSr5qHKtIgmPTtNYA";
25 | 
26 | // Datos de usuario real
27 | const TEST_USER_EMAIL = "4zgz2000@gmail.com";
28 | const TEST_USER_PASSWORD = "mtf2000";
29 | 
30 | // Cliente Supabase para autenticación
31 | const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
32 | 
33 | // Colores para output
34 | const colors = {
35 |   reset: '\x1b[0m',
36 |   bright: '\x1b[1m',
37 |   red: '\x1b[31m',
38 |   green: '\x1b[32m',
39 |   yellow: '\x1b[33m',
40 |   blue: '\x1b[34m',
41 |   magenta: '\x1b[35m',
42 |   cyan: '\x1b[36m'
43 | };
44 | 
45 | const log = {
46 |   info: (msg) => console.log(`${colors.blue}ℹ️  ${msg}${colors.reset}`),
47 |   success: (msg) => console.log(`${colors.green}✅ ${msg}${colors.reset}`),
48 |   error: (msg) => console.log(`${colors.red}❌ ${msg}${colors.reset}`),
49 |   warning: (msg) => console.log(`${colors.yellow}⚠️  ${msg}${colors.reset}`),
50 |   header: (msg) => console.log(`\n${colors.bright}${colors.cyan}🚀 ${msg}${colors.reset}\n`),
51 |   separator: () => console.log(`${colors.cyan}${'='.repeat(80)}${colors.reset}`)
52 | };
53 | 
54 | // Función para crear token de usuario test
55 | async function createTestUserToken() {
56 |   log.info('Obteniendo token de usuario test...');
57 | 
58 |   try {
59 |     // Usuario real de la aplicación
60 |     const testUsers = [
61 |       { email: TEST_USER_EMAIL, password: TEST_USER_PASSWORD }
62 |     ];
63 | 
64 |     for (const testUser of testUsers) {
65 |       log.info(`Intentando autenticación con: ${testUser.email}`);
66 | 
67 |       const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
68 |         email: testUser.email,
69 |         password: testUser.password,
70 |       });
71 | 
72 |       if (!signInError && signInData.session?.access_token) {
73 |         log.success(`Token obtenido exitosamente para: ${testUser.email}`);
74 |         return signInData.session.access_token;
75 |       } else {
76 |         log.warning(`Sign in falló para ${testUser.email}: ${signInError?.message}`);
77 |       }
78 |     }
79 | 
80 |     // Si todos los sign in fallan, intentar crear un usuario con timestamp para evitar rate limits
81 |     const uniqueEmail = `testuser${Date.now() % 10000}@temp.com`;
82 |     log.info(`Intentando crear nuevo usuario: ${uniqueEmail}`);
83 | 
84 |     const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
85 |       email: uniqueEmail,
86 |       password: TEST_USER_PASSWORD,
87 |     });
88 | 
89 |     if (signUpError) {
90 |       // Si falla la creación, usamos el Service Role Key como fallback
91 |       log.warning(`Creación de usuario falló: ${signUpError.message}`);
92 |       log.warning('Usando Service Role Key como fallback para testing...');
93 |       return SUPABASE_SERVICE_ROLE_KEY;
94 |     }
95 | 
96 |     if (!signUpData.session?.access_token) {
97 |       log.warning('No se pudo obtener token de sesión, usando Service Role Key...');
98 |       return SUPABASE_SERVICE_ROLE_KEY;
99 |     }
100 | 
101 |     log.success(`Token obtenido para nuevo usuario: ${uniqueEmail}`);
102 |     return signUpData.session.access_token;
103 | 
104 |   } catch (error) {
105 |     log.warning(`Error en autenticación: ${error.message}`);
106 |     log.warning('Usando Service Role Key como fallback...');
107 |     return SUPABASE_SERVICE_ROLE_KEY;
108 |   }
109 | }
110 | 
111 | // Función para hacer request a Edge Function
112 | async function callEdgeFunction(functionName, payload, userToken, verbose = false) {
113 |   const url = `${SUPABASE_URL}/functions/v1/${functionName}`;
114 | 
115 |   // Si el token es el Service Role Key, usar configuración diferente
116 |   const isServiceRoleKey = userToken === SUPABASE_SERVICE_ROLE_KEY;
117 |   const headers = {
118 |     'Authorization': `Bearer ${userToken}`,
119 |     'Content-Type': 'application/json',
120 |     'apikey': isServiceRoleKey ? SUPABASE_SERVICE_ROLE_KEY : SUPABASE_ANON_KEY
121 |   };
122 | 
123 |   if (verbose) {
124 |     log.info(`🌐 URL: ${url}`);
125 |     log.info(`📤 Payload completo: ${JSON.stringify(payload, null, 2)}`);
126 |     log.info(`🔐 Headers: ${JSON.stringify(headers, null, 2)}`);
127 |   } else {
128 |     // Mostrar siempre información clave del payload
129 |     console.log(`\n${colors.bright}📤 Payload enviado:${colors.reset}`);
130 |     console.log(`   Language: ${payload.language}`);
131 |     console.log(`   Child Age: ${payload.childAge}`);
132 |     console.log(`   Genre: ${payload.options?.genre}`);
133 |     console.log(`   Duration: ${payload.options?.duration}`);
134 |     console.log(`   Moral: ${payload.options?.moral}`);
135 | 
136 |     if (payload.options?.characters) {
137 |       console.log(`   Multiple Characters (${payload.options.characters.length}):`);
138 |       payload.options.characters.forEach((char, i) => {
139 |         console.log(`     ${i + 1}. ${char.name} (${char.profession}) - ${char.personality}`);
140 |         console.log(`        Hobbies: ${char.hobbies.join(', ')}`);
141 |       });
142 |     }
143 | 
144 |     if (payload.options?.character) {
145 |       console.log(`   Single Character: ${payload.options.character.name} (${payload.options.character.profession})`);
146 |     }
147 | 
148 |     if (payload.additionalDetails) {
149 |       console.log(`   Additional Details: ${payload.additionalDetails}`);
150 |     }
151 |     console.log('');
152 |   }
153 | 
154 |   const startTime = Date.now();
155 | 
156 |   try {
157 |     const response = await fetch(url, {
158 |       method: 'POST',
159 |       headers,
160 |       body: JSON.stringify(payload)
161 |     });
162 | 
163 |     const endTime = Date.now();
164 |     const responseTime = endTime - startTime;
165 | 
166 |     if (!response.ok) {
167 |       const errorText = await response.text();
168 |       throw new Error(`HTTP ${response.status}: ${errorText}`);
169 |     }
170 | 
171 |     const data = await response.json();
172 | 
173 |     // Logging de respuesta
174 |     if (verbose) {
175 |       log.info(`📥 Respuesta completa: ${JSON.stringify(data, null, 2)}`);
176 |     } else {
177 |       console.log(`\n${colors.bright}📥 Respuesta recibida:${colors.reset}`);
178 |       console.log(`   Título: ${data.title || 'N/A'}`);
179 |       console.log(`   Contenido (primeras 200 chars): ${(data.content || 'N/A').substring(0, 200)}...`);
180 |       if (data.options) {
181 |         console.log(`   Opciones: ${data.options.length || 0}`);
182 |       }
183 |       console.log('');
184 |     }
185 | 
186 |     return {
187 |       success: true,
188 |       data,
189 |       responseTime,
190 |       status: response.status
191 |     };
192 | 
193 |   } catch (error) {
194 |     const endTime = Date.now();
195 |     const responseTime = endTime - startTime;
196 | 
197 |     return {
198 |       success: false,
199 |       error: error.message,
200 |       responseTime,
201 |       status: null
202 |     };
203 |   }
204 | }
205 | 
206 | // Test 1: Generación de historia con múltiples personajes
207 | async function testMultipleCharacters(userToken, verbose = false) {
208 |   log.header('Test 1: Generación con 3 Personajes');
209 | 
210 |   log.info(`Personajes: ${testCharacters.map(c => `${c.name} (${c.profession})`).join(', ')}`);
211 | 
212 |   const result = await callEdgeFunction('generate-story', multipleCharactersPayload, userToken, verbose);
213 | 
214 |   if (!result.success) {
215 |     log.error(`Error: ${result.error}`);
216 |     return null;
217 |   }
218 | 
219 |   log.success(`✅ Historia generada en ${result.responseTime}ms`);
220 | 
221 |   // Validar estructura
222 |   const validation = validateStoryResponse(result.data);
223 |   if (!validation.isValid) {
224 |     log.error(`Validación fallida: ${validation.errors.join(', ')}`);
225 |     return null;
226 |   }
227 | 
228 |   // Análisis de personajes
229 |   const characterAnalysis = analyzeCharacterPresence(result.data.content, testCharacters);
230 | 
231 |   console.log(`\n${colors.bright}📊 Análisis de Personajes:${colors.reset}`);
232 |   Object.entries(characterAnalysis).forEach(([name, analysis]) => {
233 |     const status = analysis.mentions > 0 ? '✅' : '❌';
234 |     console.log(`  ${status} ${name}: ${analysis.mentions} menciones`);
235 |   });
236 | 
237 |   console.log(`\n${colors.bright}📖 Historia:${colors.reset}`);
238 |   console.log(`${colors.bright}Título:${colors.reset} ${result.data.title}`);
239 |   console.log(`\n${colors.bright}Contenido:${colors.reset}`);
240 |   console.log(result.data.content);
241 | 
242 |   return result.data;
243 | }
244 | 
245 | // testSingleCharacter removed - now using unified multiple character system
246 | 
247 | // Test 3: Opciones de continuación
248 | async function testContinuationOptions(userToken, verbose = false) {
249 |   log.header('Test 3: Opciones de Continuación');
250 | 
251 |   const payload = {
252 |     action: 'generateOptions',
253 |     story: mockStory,
254 |     chapters: mockChapters,
255 |     language: 'es',
256 |     childAge: 7
257 |   };
258 | 
259 |   const result = await callEdgeFunction('story-continuation', payload, userToken, verbose);
260 | 
261 |   if (!result.success) {
262 |     log.error(`Error: ${result.error}`);
263 |     return null;
264 |   }
265 | 
266 |   log.success(`✅ Opciones generadas en ${result.responseTime}ms`);
267 | 
268 |   const validation = validateContinuationOptionsResponse(result.data);
269 |   if (!validation.isValid) {
270 |     log.error(`Validación fallida: ${validation.errors.join(', ')}`);
271 |     return null;
272 |   }
273 | 
274 |   console.log(`\n${colors.bright}🎯 Opciones:${colors.reset}`);
275 |   result.data.options.forEach((option, index) => {
276 |     console.log(`  ${index + 1}. ${option.summary}`);
277 |   });
278 | 
279 |   return result.data;
280 | }
281 | 
282 | // Test 4: Continuación con opción seleccionada
283 | async function testOptionContinuation(userToken, verbose = false) {
284 |   log.header('Test 4: Continuación con Opción Seleccionada');
285 | 
286 |   const result = await callEdgeFunction('story-continuation', optionContinuationPayload, userToken, verbose);
287 | 
288 |   if (!result.success) {
289 |     log.error(`Error: ${result.error}`);
290 |     return null;
291 |   }
292 | 
293 |   log.success(`✅ Capítulo generado en ${result.responseTime}ms`);
294 | 
295 |   const validation = validateStoryResponse(result.data);
296 |   if (!validation.isValid) {
297 |     log.error(`Validación fallida: ${validation.errors.join(', ')}`);
298 |     return null;
299 |   }
300 | 
301 |   // Análisis de personajes en el capítulo generado
302 |   const characterAnalysis = analyzeCharacterPresence(result.data.content, testCharacters);
303 |   const charactersPresent = Object.values(characterAnalysis).filter(a => a.mentions > 0).length;
304 | 
305 |   console.log(`\n${colors.bright}📊 Análisis de Personajes en Capítulo:${colors.reset}`);
306 |   Object.entries(characterAnalysis).forEach(([name, analysis]) => {
307 |     const status = analysis.mentions > 0 ? '✅' : '❌';
308 |     console.log(`  ${status} ${name}: ${analysis.mentions} menciones`);
309 |   });
310 | 
311 |   console.log(`\n${colors.bright}📖 Capítulo Generado:${colors.reset}`);
312 |   console.log(`${colors.bright}Título:${colors.reset} ${result.data.title}`);
313 |   console.log(`\n${colors.bright}Contenido:${colors.reset}`);
314 |   console.log(result.data.content);
315 | 
316 |   if (charactersPresent >= 2) {
317 |     log.success(`Consistencia de personajes mantenida (${charactersPresent}/3 personajes presentes)`);
318 |   } else {
319 |     log.warning(`Algunos personajes podrían haberse perdido (${charactersPresent}/3 presentes)`);
320 |   }
321 | 
322 |   return result.data;
323 | }
324 | 
325 | // Test 5: Continuación libre
326 | async function testFreeContinuation(userToken, verbose = false) {
327 |   log.header('Test 5: Continuación Libre');
328 | 
329 |   const result = await callEdgeFunction('story-continuation', freeContinuationPayload, userToken, verbose);
330 | 
331 |   if (!result.success) {
332 |     log.error(`Error: ${result.error}`);
333 |     return null;
334 |   }
335 | 
336 |   log.success(`✅ Capítulo libre generado en ${result.responseTime}ms`);
337 | 
338 |   const validation = validateStoryResponse(result.data);
339 |   if (!validation.isValid) {
340 |     log.error(`Validación fallida: ${validation.errors.join(', ')}`);
341 |     return null;
342 |   }
343 | 
344 |   // Análisis de personajes
345 |   const characterAnalysis = analyzeCharacterPresence(result.data.content, testCharacters);
346 |   const charactersPresent = Object.values(characterAnalysis).filter(a => a.mentions > 0).length;
347 | 
348 |   console.log(`\n${colors.bright}📊 Análisis de Personajes:${colors.reset}`);
349 |   Object.entries(characterAnalysis).forEach(([name, analysis]) => {
350 |     const status = analysis.mentions > 0 ? '✅' : '❌';
351 |     console.log(`  ${status} ${name}: ${analysis.mentions} menciones`);
352 |   });
353 | 
354 |   console.log(`\n${colors.bright}📖 Continuación Libre:${colors.reset}`);
355 |   console.log(`${colors.bright}Título:${colors.reset} ${result.data.title}`);
356 |   console.log(`\n${colors.bright}Contenido (primeras 400 chars):${colors.reset}`);
357 |   console.log(result.data.content.substring(0, 400) + '...');
358 | 
359 |   return result.data;
360 | }
361 | 
362 | // Test 6: Continuación dirigida
363 | async function testDirectedContinuation(userToken, verbose = false) {
364 |   log.header('Test 6: Continuación Dirigida');
365 | 
366 |   log.info(`Dirección: "${directedContinuationPayload.userDirection}"`);
367 | 
368 |   const result = await callEdgeFunction('story-continuation', directedContinuationPayload, userToken, verbose);
369 | 
370 |   if (!result.success) {
371 |     log.error(`Error: ${result.error}`);
372 |     return null;
373 |   }
374 | 
375 |   log.success(`✅ Capítulo dirigido generado en ${result.responseTime}ms`);
376 | 
377 |   const validation = validateStoryResponse(result.data);
378 |   if (!validation.isValid) {
379 |     log.error(`Validación fallida: ${validation.errors.join(', ')}`);
380 |     return null;
381 |   }
382 | 
383 |   // Análisis de personajes
384 |   const characterAnalysis = analyzeCharacterPresence(result.data.content, testCharacters);
385 |   const charactersPresent = Object.values(characterAnalysis).filter(a => a.mentions > 0).length;
386 | 
387 |   console.log(`\n${colors.bright}📊 Análisis de Personajes:${colors.reset}`);
388 |   Object.entries(characterAnalysis).forEach(([name, analysis]) => {
389 |     const status = analysis.mentions > 0 ? '✅' : '❌';
390 |     console.log(`  ${status} ${name}: ${analysis.mentions} menciones`);
391 |   });
392 | 
393 |   console.log(`\n${colors.bright}📖 Continuación Dirigida:${colors.reset}`);
394 |   console.log(`${colors.bright}Título:${colors.reset} ${result.data.title}`);
395 |   console.log(`\n${colors.bright}Contenido (primeras 400 chars):${colors.reset}`);
396 |   console.log(result.data.content.substring(0, 400) + '...');
397 | 
398 |   return result.data;
399 | }
400 | 
401 | // Función principal
402 | async function main() {
403 |   const args = Deno.args;
404 |   const verbose = args.includes('--verbose') || args.includes('-v');
405 |   const testType = args[0];
406 | 
407 |   log.separator();
408 |   console.log(`${colors.bright}${colors.magenta}🧪 Test Edge Functions FantasIA${colors.reset}`);
409 |   log.separator();
410 | 
411 |   try {
412 |     // Crear token de usuario test
413 |     const userToken = await createTestUserToken();
414 |     log.separator();
415 | 
416 |     // Story Generation Tests
417 |     if (testType === 'multiple' || !testType) {
418 |       await testMultipleCharacters(userToken, verbose);
419 |       log.separator();
420 |     }
421 | 
422 |     // single character test removed - unified system handles 1-4 characters
423 | 
424 |     // Story Continuation Tests
425 |     if (testType === 'continue' || testType === 'continue-options' || !testType) {
426 |       await testContinuationOptions(userToken, verbose);
427 |       log.separator();
428 |     }
429 | 
430 |     if (testType === 'continue-selected') {
431 |       await testOptionContinuation(userToken, verbose);
432 |       log.separator();
433 |     }
434 | 
435 |     if (testType === 'continue-free') {
436 |       await testFreeContinuation(userToken, verbose);
437 |       log.separator();
438 |     }
439 | 
440 |     if (testType === 'continue-directed') {
441 |       await testDirectedContinuation(userToken, verbose);
442 |       log.separator();
443 |     }
444 | 
445 |     if (testType === 'continue-all') {
446 |       await testContinuationOptions(userToken, verbose);
447 |       log.separator();
448 |       await testOptionContinuation(userToken, verbose);
449 |       log.separator();
450 |       await testFreeContinuation(userToken, verbose);
451 |       log.separator();
452 |       await testDirectedContinuation(userToken, verbose);
453 |       log.separator();
454 |     }
455 | 
456 |     log.success('🎉 Tests completados!');
457 | 
458 |   } catch (error) {
459 |     log.error(`Error: ${error.message}`);
460 |     if (verbose) {
461 |       console.error(error.stack);
462 |     }
463 |     Deno.exit(1);
464 |   }
465 | }
466 | 
467 | // Ayuda
468 | if (Deno.args.includes('--help') || Deno.args.includes('-h')) {
469 |   console.log(`
470 | ${colors.bright}🧪 Test Edge Functions FantasIA${colors.reset}
471 | 
472 | ${colors.bright}Uso:${colors.reset}
473 |   deno run --allow-env --allow-net test-simple.js [tipo] [opciones]
474 | 
475 | ${colors.bright}📖 Story Generation:${colors.reset}
476 |   multiple              Test múltiples personajes (3 personajes)
477 |   // single command removed - unified system handles 1-4 characters
478 | 
479 | ${colors.bright}📚 Story Continuation:${colors.reset}
480 |   continue              Generar opciones de continuación (legacy)
481 |   continue-options      Generar opciones de continuación
482 |   continue-selected     Continuar con opción seleccionada
483 |   continue-free         Continuación libre
484 |   continue-directed     Continuación dirigida por usuario
485 |   continue-all          Todos los tests de continuación
486 | 
487 | ${colors.bright}🔍 Tests Completos:${colors.reset}
488 |   (vacío)               Todos los tests básicos
489 |   
490 | ${colors.bright}Opciones:${colors.reset}
491 |   --verbose, -v         Output completo con payloads y respuestas
492 |   --help, -h            Esta ayuda
493 | 
494 | ${colors.bright}🔧 Debugging - Para diagnosticar problemas:${colors.reset}
495 |   deno run --allow-env --allow-net test-simple.js multiple --verbose
496 |   deno run --allow-env --allow-net test-simple.js continue-selected --verbose
497 |   
498 |   Esto muestra:
499 |   • Payload completo enviado a la Edge Function
500 |   • Headers de autenticación
501 |   • Respuesta completa del modelo de lenguaje
502 |   • Análisis detallado de personajes
503 | 
504 | ${colors.bright}📋 Ejemplos por Funcionalidad:${colors.reset}
505 | 
506 |   ${colors.bright}Story Generation:${colors.reset}
507 |   deno run --allow-env --allow-net test-simple.js multiple
508 |   deno run --allow-env --allow-net test-simple.js multiple --verbose
509 | 
510 |   ${colors.bright}Story Continuation:${colors.reset}
511 |   deno run --allow-env --allow-net test-simple.js continue-options
512 |   deno run --allow-env --allow-net test-simple.js continue-selected
513 |   deno run --allow-env --allow-net test-simple.js continue-all --verbose
514 | 
515 |   ${colors.bright}Testing Completo:${colors.reset}
516 |   deno run --allow-env --allow-net test-simple.js
517 | `);
518 |   Deno.exit(0);
519 | }
520 | 
521 | if (import.meta.main) {
522 |   main();
523 | }
```

.vite/deps/_metadata.json
```
1 | {
2 |   "hash": "3a7d4734",
3 |   "configHash": "74516b19",
4 |   "lockfileHash": "e3b0c442",
5 |   "browserHash": "7f9c0fe1",
6 |   "optimized": {},
7 |   "chunks": {}
8 | }
```

.vite/deps/package.json
```
1 | {
2 |   "type": "module"
3 | }
```

.windsurf/rules/clauderules.md
```
1 | ---
2 | trigger: manual
3 | ---
4 | 
5 | ## Project Overview
6 | 
7 | **Fantasia** is undergoing transformation from a children's storytelling application to an adult-oriented erotic content platform. The project generates personalized stories with voice narration and interactive elements, now targeting mature audiences with sophisticated adult themes.
8 | 
9 | **Current Version**: 1.1.4  
10 | **Main Branch**: master  
11 | **Project Type**: Single Page Application (SPA)  
12 | **Target Audience**: Adults (18+)  
13 | **Content Focus**: Adult erotic literature and interactive experiences  
14 | **Language**: English (migrating from Spanish)
15 | 
16 | ## Technology Stack
17 | 
18 | ### Frontend
19 | - **React 18.3.1** with TypeScript
20 | - **Vite** for build tooling and development server
21 | - **Tailwind CSS** for styling with custom configuration
22 | - **shadcn/ui** component library (extensive Radix UI components)
23 | - **Framer Motion** for animations and transitions
24 | - **Zustand** for state management
25 | - **React Router DOM** for navigation
26 | - **React Hook Form** with Zod validation
27 | - **TanStack Query** for server state management
28 | 
29 | ### Backend & Services
30 | - **Supabase** as Backend-as-a-Service (BaaS)
31 |   - Authentication and user management
32 |   - PostgreSQL database with Row Level Security (RLS)
33 |   - Edge Functions for serverless compute
34 |   - File storage for audio and images
35 | - **OpenAI** for AI-powered story generation and TTS
36 | - **Google Generative AI** (Gemini) for story generation
37 | - **Stripe** for payment processing and subscriptions
38 | - **ElevenLabs** for voice synthesis (via API)
39 | 
40 | ### Development Tools
41 | - **TypeScript** with strict configuration
42 | - **ESLint** with React and TypeScript rules
43 | - **PostCSS** with Tailwind CSS
44 | - **PM2** for production deployment
45 | - **Bun** as package manager (with npm fallback)
46 | 
47 | ## Project Structure
48 | 
49 | ```
50 | FantasIA/
51 | ├── src/
52 | │   ├── components/           # Reusable UI components
53 | │   │   ├── ui/              # shadcn/ui components (~49 files)
54 | │   │   └── [various].tsx    # App-specific components
55 | │   ├── pages/               # Route-based page components
56 | │   ├── services/            # API integration layer
57 | │   │   ├── ai/             # AI service wrappers
58 | │   │   └── [various].ts    # Database and third-party services
59 | │   ├── store/              # Zustand state management
60 | │   │   ├── character/      # Character management
61 | │   │   ├── stories/        # Story-related state
62 | │   │   ├── user/           # User profile and auth
63 | │   │   └── core/           # Store utilities
64 | │   ├── hooks/              # Custom React hooks
65 | │   ├── lib/                # Utility functions
66 | │   ├── types/              # TypeScript type definitions
67 | │   └── config/             # App configuration
68 | ├── supabase/
69 | │   ├── functions/          # Edge Functions
70 | │   ├── migrations/         # Database migrations
71 | │   └── sql-functions/      # Database functions
72 | ├── docs/                   # Project documentation
73 | └── public/                 # Static assets
74 | ```
75 | 
76 | ## Key Features
77 | 
78 | ### Story Generation
79 | - **Personalized Adult Stories**: AI-generated erotic tales based on character preferences, kinks, and interests
80 | - **Chapter System**: Multi-chapter stories with continuation options
81 | - **Story Format Choice**: Users can choose between 'single' self-contained stories or 'episodic' stories designed for multiple chapters
82 | - **Multiple Genres**: Romance, BDSM, fantasy, contemporary, etc.
83 | - **Character Customization**: Name, gender ('male', 'female', 'non-binary'), and free-text description
84 | 
85 | ### Audio Features
86 | - **Text-to-Speech**: Professional voice narration using OpenAI TTS with sensual voices
87 | - **Multiple Voices**: Different personality-matched voices for adult content
88 | - **Audio Player**: Custom audio player with progress tracking
89 | - **Voice Preview**: Sample voices before selection
90 | 
91 | ### Image Generation
92 | - **Currently Deactivated**: Image generation functionality is temporarily disabled
93 | - **Database Ready**: The schema includes a 'cover_image_url' field in the 'stories' table for future implementation
94 | - **Planned Features**: DALL-E 3 integration for story illustrations, cover images, and character portraits
95 | 
96 | ### Adult Content Features
97 | - **Content Warnings**: Appropriate warnings for different types of adult content
98 | - **Age Verification**: Robust age verification system
99 | - **Customizable Content**: User preferences for content intensity and themes
100 | - **Privacy Controls**: Enhanced privacy features for adult content
101 | 
102 | ### User Management
103 | - **Authentication**: Supabase Auth with email/password
104 | - **Profiles**: User preferences and adult content settings
105 | - **Subscriptions**: Stripe-powered payment system
106 | - **Usage Tracking**: Story and voice credit limits
107 | 
108 | ## Development Workflow
109 | 
110 | ### Local Development
111 | ```bash
112 | # Install dependencies
113 | npm install
114 | 
115 | # Start development server
116 | npm run dev
117 | 
118 | # Build for production
119 | npm run build:prod
120 | 
121 | # Preview production build
122 | npm run start:prod
123 | ```
124 | 
125 | ### Key Commands
126 | - `npm run dev` - Start development server (localhost:8080)
127 | - `npm run build` - Build for production
128 | - `npm run lint` - Run ESLint
129 | - `npm run deploy` - Build and start production server
130 | 
131 | ### Environment Setup
132 | Required environment variables:
133 | - `VITE_SUPABASE_URL` - Supabase project URL
134 | - `VITE_SUPABASE_ANON_KEY` - Supabase anonymous key
135 | - `VITE_STRIPE_PUBLISHABLE_KEY` - Stripe publishable key
136 | - `VITE_ELEVENLABS_API_KEY` - ElevenLabs API key
137 | 
138 | ## Architecture Patterns
139 | 
140 | ### State Management
141 | - **Zustand stores** for global state
142 | - **Store separation** by domain (user, character, stories, etc.)
143 | - **Persistence** with localStorage for offline support
144 | - **Sync queue** for offline-first data handling
145 | 
146 | ### Service Layer
147 | - **Abstraction layer** between UI and backend
148 | - **Edge Function wrappers** for AI services
149 | - **Direct database access** with RLS security
150 | - **Error handling** with standardized response format
151 | 
152 | ### Component Architecture
153 | - **Atomic design** with reusable components
154 | - **Page-based routing** with React Router
155 | - **Custom hooks** for shared logic
156 | - **TypeScript** for type safety
157 | 
158 | ## Database Schema
159 | 
160 | ### Main Tables
161 | - `profiles` - User profiles with language settings and adult content preferences (free-text field for tastes, kinks, etc.)
162 | - `characters` - Simplified custom characters with only name, gender, and description
163 | - `stories` - Generated stories with metadata, including story_format ('single' or 'episodic'), flexible genre field, and cover_image_url for future use
164 | - `story_chapters` - Individual story chapters (used for stories marked as 'episodic')
165 | - `audio_files` - Generated audio recordings
166 | - `user_voices` - Voice preferences
167 | - `preset_suggestions` - Story prompt presets for generation
168 | 
169 | ### Security
170 | - **Row Level Security (RLS)** on all tables
171 | - **User-based access control**
172 | - **Secure API key management** in Edge Functions
173 | 
174 | ### SQL Documentation
175 | **IMPORTANT**: `/docs/sql_supabase.sql` is the **canonical reference** for the database schema. This is the definitive migration script that contains:
176 | - Complete table definitions and structure
177 | - All RLS policies and permissions
178 | - Database enums and constraints
179 | - The exact SQL to be executed in Supabase SQL Editor
180 | 
181 | **Development Guidelines**:
182 | - **Always refer to** `/docs/sql_supabase.sql` for any SQL-related queries or modifications
183 | - **Do NOT modify** this file unless absolutely necessary for new functionality
184 | - This script is designed to be executed in the Supabase SQL Editor to apply changes remotely
185 | - Other SQL files in `/docs/` may be outdated and should be considered legacy
186 | 
187 | Legacy files (may be outdated):
188 | - `/docs/supabase_tables.sql` - Legacy table definitions
189 | - `/docs/supabase_RLS.sql` - Legacy RLS policies
190 | 
191 | ## Testing
192 | 
193 | **Note**: Currently no test framework is configured. The project uses:
194 | - Manual testing in development
195 | - TypeScript for compile-time validation
196 | - ESLint for code quality
197 | - Production monitoring for runtime issues
198 | 
199 | ## Deployment
200 | 
201 | ### Production Setup
202 | - **PM2** for process management
203 | - **Nginx** reverse proxy (not included in repo)
204 | - **Environment variables** for configuration
205 | - **Supabase Edge Functions** for serverless compute
206 | 
207 | ### PM2 Configuration
208 | ```javascript
209 | // ecosystem.config.cjs
210 | {
211 |   name: "cuenta-cuentos",
212 |   script: "npm",
213 |   args: "run start:prod",
214 |   env: {
215 |     NODE_ENV: "production",
216 |     PORT: "8080"
217 |   }
218 | }
219 | ```
220 | 
221 | ## Development Guidelines
222 | 
223 | ### Transformation Rules
224 | 1. **Think First**: Read codebase for relevant files, write plan to tasks/todo.md
225 | 2. **Check Before Working**: Always verify plan with user before implementation
226 | 3. **High-Level Updates**: Give brief explanations of changes made
227 | 4. **Simple Changes**: Make every task as simple as possible, minimal code impact
228 | 5. **Review Documentation**: Add review section to todo.md with change summary
229 | 
230 | ### Project Transformation Context
231 | - **Content Migration**: Transform from children's stories to adult erotic content
232 | - **Language Migration**: Gradually change from Spanish to English (new features in English)
233 | - **Architecture Migration**: Replace Zustand local store with direct Supabase queries
234 | - **Simplicity Focus**: Avoid massive or complex changes, every change should be incremental
235 | 
236 | ### Code Style
237 | - **TypeScript strict mode** enabled
238 | - **ESLint** configuration with React rules
239 | - **Consistent naming** (camelCase for JS, snake_case for DB)
240 | - **Component organization** by feature/domain
241 | - **English-first approach** for new functions and components
242 | 
243 | ### Best Practices
244 | - **Prefer editing** existing files over creating new ones
245 | - **Use absolute imports** with `@/` alias
246 | - **Handle errors** gracefully with user feedback
247 | - **Implement loading states** for async operations
248 | - **Follow Tailwind CSS** utility-first approach
249 | - **Direct Supabase integration** for new features (avoid Zustand dependency)
250 | 
251 | ### State Management Migration
252 | - **Legacy**: Zustand stores with localStorage persistence
253 | - **Target**: Direct Supabase queries with real-time subscriptions
254 | - **Approach**: Gradual migration, maintain existing patterns during transition
255 | - **New Features**: Extract data directly from Supabase, don't use local stores
256 | 
257 | ## API Integration
258 | 
259 | ### Edge Functions
260 | - `generate-story` - AI adult story generation with mature themes
261 | - `story-continuation` - Story continuation options for adult narratives
262 | - `generate-audio` - Text-to-speech conversion with sensual voices
263 | - `upload-story-image` - Adult content image generation and storage (Currently Deactivated)
264 | - Stripe functions for payment processing
265 | 
266 | ### External APIs
267 | - **OpenAI** - GPT models and TTS
268 | - **Google Generative AI** - Gemini models
269 | - **Stripe** - Payment processing
270 | - **ElevenLabs** - Voice synthesis
271 | 
272 | ## Common Issues & Solutions
273 | 
274 | ### Authentication
275 | - **Race conditions** handled with auth guards
276 | - **Session management** through Supabase client
277 | - **Redirect handling** for auth callbacks
278 | 
279 | ### Performance
280 | - **Lazy loading** for route components
281 | - **Image optimization** with proper formats
282 | - **Audio streaming** for large files
283 | - **State persistence** to avoid refetching
284 | 
285 | ### Offline Support
286 | - **Sync queue** for failed operations
287 | - **localStorage persistence** for critical data
288 | - **Network detection** for connectivity changes
289 | 
290 | ## Implementation Guidelines
291 | 
292 | ### Adult Content Considerations
293 | - **Content Moderation**: Implement appropriate content filtering
294 | - **Privacy First**: Enhanced privacy features for sensitive content
295 | - **Age Verification**: Robust verification system
296 | - **Content Warnings**: Clear labeling of content types and intensity
297 | 
298 | For detailed implementation guides, see the `/docs` directory and `/tasks/todo.md`.
```

.windsurf/workflows/analizar_problema.md
```
1 | ---
2 | description: Generar un documento Markdown que detalle un problema, proponga una solución desglosada en tareas y establezca puntos de control para su seguimiento.
3 | ---
4 | 
5 | ### 1. Análisis Profundo del Problema
6 | - **Objetivo:** Entender el problema en su totalidad, incluyendo su contexto, causas raíz e impacto.
7 | - **Acciones:**
8 |     - Recopilar toda la información inicial del usuario.
9 |     - Identificar y solicitar acceso a toda la documentación, código o recursos necesarios.
10 |     - Realizar un análisis exhaustivo de los materiales proporcionados.
11 |     - Formular preguntas precisas para aclarar cualquier duda o ambigüedad.
12 |     - Sintetizar los hallazgos en una definición clara y concisa del problema.
13 | 
14 | ### 2. Diseño de la Solución
15 | - **Objetivo:** Idear y seleccionar la estrategia más efectiva para resolver el problema.
16 | - **Acciones:**
17 |     - Proponer una o más soluciones viables.
18 |     - Evaluar cada solución considerando su complejidad técnica, tiempo de implementación, riesgos y beneficios.
19 |     - Seleccionar la solución óptima y justificar claramente la elección.
20 | 
21 | ### 3. Creación del Plan de Acción
22 | - **Objetivo:** Generar un documento Markdown (`.md`) con el plan detallado.
23 | - **Acciones:**
24 |     - Estructurar el documento con las siguientes secciones:
25 |         1.  **`## Problema`**: Descripción detallada del análisis.
26 |         2.  **`## Solución Propuesta`**: Explicación de la solución elegida.
27 |         3.  **`## Plan de Tareas`**: Desglose de la solución en tareas específicas y accionables.
28 |     - Formatear el plan de tareas como una lista con checkboxes (`- [ ]`) para un fácil seguimiento.
29 | 
30 | ### 4. Validación
31 | - **Objetivo:** Asegurar que el plan esté alineado con las expectativas del usuario.
32 | - **Acciones:**
33 |     - Presentar el documento `.md` al usuario.
34 |     - Solicitar feedback y realizar los ajustes necesarios hasta obtener la aprobación final.
```

.windsurf/workflows/subirgit.md
```
1 | ---
2 | description: guardar en git y subir a github
3 | ---
4 | 
5 | 1. Ejecutar `git status` para identificar archivos añadidos, modificados o eliminados.  
6 | 2. Actualizar el fichero de estructura del proyecto /Users/miguel/Mizat Ventures/smartwrite-mentor/Documentation/estructura_proyecto.md los cambios detectados (añadir/quitar documentos). Incluir notas solo si afectan directamente a la estructura.  
7 | 3. Verificar que la rama activa es la correcta.  
8 | 4. Indexar los cambios con `git add`.  
9 | 5. Realizar el commit con un mensaje detallado que incluya:  
10 |    - Descripción de cada modificación.  
11 |    - Motivo de añadir/eliminar documentos.  
12 |    - Referencias relevantes de la conversación previa con el agente de código (si está disponible).  
13 | 6. Ejecutar `git push` para subir los cambios a GitHub.
```

docs/IMPLEMENTATIONS/IMPLEMENTACION_PERFIL_ADULTO.md
```
1 | # Implementación Completa: Nuevo Perfil del Oyente (Adulto)
2 | 
3 | ## Resumen Ejecutivo
4 | 
5 | Esta implementación migra completamente la aplicación de cuentos infantiles a una plataforma de contenido erótico para adultos, eliminando los campos legacy (`childAge`, `specialNeed`) y reemplazándolos con un sistema de preferencias adultas (`preferences`). La arquitectura se simplifica eliminando la dependencia de Zustand Store en favor de consultas directas a Supabase.
6 | 
7 | ## Estado Actual vs Objetivo
8 | 
9 | ### Estado Actual (PROBLEMÁTICO)
10 | - ❌ Base de datos ya actualizada con campo `preferences` 
11 | - ❌ Código frontend usa `childAge` y `specialNeed` (NO EXISTEN en DB)
12 | - ❌ Edge Functions esperan parámetros legacy que fallan
13 | - ❌ UI en español orientada a contenido infantil
14 | - ❌ Dependencia de Zustand Store para datos de perfil
15 | 
16 | ### Estado Objetivo
17 | - ✅ Sistema unificado usando solo campo `preferences` 
18 | - ✅ Consultas directas a Supabase sin Zustand Store
19 | - ✅ UI en inglés orientada a contenido adulto
20 | - ✅ Edge Functions adaptadas para contenido erótico
21 | - ✅ Flujo completo funcional profile → story generation
22 | 
23 | ## Implementación Detallada
24 | 
25 | ### 1. Actualización de Types y Interfaces
26 | 
27 | #### Archivo: `src/types/index.ts`
28 | 
29 | **CAMBIOS REQUERIDOS:**
30 | 
31 | ```typescript
32 | // ANTES (Legacy - NO FUNCIONA)
33 | export type ProfileSettings = {
34 |   language: string;
35 |   childAge: number;           // ❌ NO EXISTE EN DB
36 |   specialNeed?: string | null; // ❌ NO EXISTE EN DB
37 |   // ... resto de campos
38 | };
39 | 
40 | // DESPUÉS (Nuevo - Funcional)
41 | export type ProfileSettings = {
42 |   language: string;
43 |   preferences?: string | null; // ✅ Campo para gustos/fetiches adultos
44 |   // ... resto de campos (sin cambios)
45 |   stripe_customer_id?: string | null;
46 |   subscription_status?: string | null;
47 |   subscription_id?: string | null;
48 |   plan_id?: string | null;
49 |   current_period_end?: string | null;
50 |   voice_credits?: number | null;
51 |   monthly_stories_generated?: number | null;
52 |   period_start_date?: string | null;
53 |   monthly_voice_generations_used?: number | null;
54 |   has_completed_setup: boolean;
55 | };
56 | ```
57 | 
58 | **JUSTIFICACIÓN:** 
59 | - `childAge` y `specialNeed` fueron eliminados del schema SQL
60 | - `preferences` es el nuevo campo para personalización adulta
61 | - Mantiene compatibilidad con todos los demás campos existentes
62 | 
63 | ### 2. Reescritura Completa de ProfileConfigPage.tsx
64 | 
65 | #### Archivo: `src/pages/ProfileConfigPage.tsx`
66 | 
67 | **REESCRITURA COMPLETA:**
68 | 
69 | ```typescript
70 | import React, { useState, useEffect } from "react";
71 | import { useNavigate } from "react-router-dom";
72 | import { Check, Globe, User, Heart } from "lucide-react";
73 | import { motion } from "framer-motion";
74 | 
75 | // Imports de Supabase (SIN Zustand Store)
76 | import { supabase } from "@/supabaseClient";
77 | import { useToast } from "@/hooks/use-toast";
78 | 
79 | // UI Components
80 | import BackButton from "@/components/BackButton";
81 | import PageTransition from "@/components/PageTransition";
82 | import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
83 | import { Textarea } from "@/components/ui/textarea";
84 | 
85 | const ProfileConfigPage: React.FC = () => {
86 |     const navigate = useNavigate();
87 |     const { toast } = useToast();
88 | 
89 |     // Estado Local del Formulario (SOLO campos que existen en DB)
90 |     const [language, setLanguage] = useState("en");
91 |     const [preferences, setPreferences] = useState("");
92 |     const [isLoading, setIsLoading] = useState(true);
93 |     const [isSaving, setIsSaving] = useState(false);
94 |     const [currentUser, setCurrentUser] = useState<any>(null);
95 | 
96 |     // Definiciones de idiomas (INGLÉS PRIMERO)
97 |     const languages = [
98 |         { value: "en", label: "English", flag: "🇺🇸" },
99 |         { value: "es", label: "Español", flag: "🇪🇸" },
100 |         { value: "fr", label: "Français", flag: "🇫🇷" },
101 |         { value: "de", label: "Deutsch", flag: "🇩🇪" },
102 |         { value: "it", label: "Italiano", flag: "🇮🇹" }
103 |     ];
104 | 
105 |     // Cargar datos DIRECTAMENTE de Supabase (SIN Store)
106 |     useEffect(() => {
107 |         const loadProfileData = async () => {
108 |             try {
109 |                 setIsLoading(true);
110 |                 
111 |                 // 1. Verificar autenticación
112 |                 const { data: { user }, error: authError } = await supabase.auth.getUser();
113 |                 if (authError || !user) {
114 |                     toast({
115 |                         title: "Authentication Required",
116 |                         description: "Please log in to configure your profile.",
117 |                         variant: "destructive",
118 |                     });
119 |                     navigate("/login");
120 |                     return;
121 |                 }
122 |                 
123 |                 setCurrentUser(user);
124 | 
125 |                 // 2. Cargar perfil DIRECTAMENTE de la tabla profiles
126 |                 const { data: profile, error: profileError } = await supabase
127 |                     .from('profiles')
128 |                     .select('language, preferences, has_completed_setup')
129 |                     .eq('id', user.id)
130 |                     .single();
131 | 
132 |                 if (profileError) {
133 |                     console.error("Error loading profile:", profileError);
134 |                     // Usar valores por defecto para nuevo usuario
135 |                     setLanguage("en");
136 |                     setPreferences("");
137 |                 } else {
138 |                     // Cargar datos existentes
139 |                     setLanguage(profile.language || "en");
140 |                     setPreferences(profile.preferences || "");
141 |                 }
142 | 
143 |             } catch (error) {
144 |                 console.error("Error in loadProfileData:", error);
145 |                 toast({
146 |                     title: "Error",
147 |                     description: "Failed to load profile data.",
148 |                     variant: "destructive",
149 |                 });
150 |             } finally {
151 |                 setIsLoading(false);
152 |             }
153 |         };
154 | 
155 |         loadProfileData();
156 |     }, [navigate, toast]);
157 | 
158 |     // Guardar DIRECTAMENTE en Supabase (SIN Store)
159 |     const handleSubmit = async (e: React.FormEvent) => {
160 |         e.preventDefault();
161 |         
162 |         if (!currentUser) {
163 |             toast({
164 |                 title: "Error",
165 |                 description: "You must be authenticated to save your profile.",
166 |                 variant: "destructive",
167 |             });
168 |             return;
169 |         }
170 | 
171 |         setIsSaving(true);
172 |         try {
173 |             // Verificar si ya tenía setup completo
174 |             const { data: currentProfile } = await supabase
175 |                 .from('profiles')
176 |                 .select('has_completed_setup')
177 |                 .eq('id', currentUser.id)
178 |                 .single();
179 | 
180 |             const wasSetupComplete = currentProfile?.has_completed_setup || false;
181 | 
182 |             // Guardar DIRECTAMENTE en Supabase
183 |             const { error: updateError } = await supabase
184 |                 .from('profiles')
185 |                 .update({
186 |                     language: language,
187 |                     preferences: preferences.trim() || null,
188 |                     has_completed_setup: true
189 |                 })
190 |                 .eq('id', currentUser.id);
191 | 
192 |             if (updateError) {
193 |                 throw updateError;
194 |             }
195 | 
196 |             // Navegación condicional
197 |             const nextPath = wasSetupComplete ? "/home" : "/plans";
198 |             const successDescription = wasSetupComplete
199 |                 ? "Your profile has been updated successfully."
200 |                 : "Profile saved! Let's choose a plan.";
201 | 
202 |             toast({
203 |                 title: "Profile Updated!",
204 |                 description: successDescription,
205 |             });
206 |             
207 |             navigate(nextPath);
208 | 
209 |         } catch (error) {
210 |             console.error("Error saving profile:", error);
211 |             toast({
212 |                 title: "Save Error",
213 |                 description: "An error occurred while saving your profile.",
214 |                 variant: "destructive",
215 |             });
216 |         } finally {
217 |             setIsSaving(false);
218 |         }
219 |     };
220 | 
221 |     const selectedLang = languages.find(l => l.value === language);
222 | 
223 |     return (
224 |         <PageTransition>
225 |             <div
226 |                 className="min-h-screen flex flex-col items-center justify-start relative"
227 |                 style={{ backgroundColor: 'black' }}
228 |             >
229 |                 <div className="container mx-auto px-4 py-8 max-w-2xl">
230 |                     <BackButton className="absolute top-8 left-4 md:left-8" />
231 | 
232 |                     {/* Header */}
233 |                     <motion.div
234 |                         initial={{ opacity: 0, y: -10 }}
235 |                         animate={{ opacity: 1, y: 0 }}
236 |                         transition={{ duration: 0.5 }}
237 |                         className="pt-16 text-center mb-8"
238 |                     >
239 |                         <div className="inline-flex justify-center items-center w-16 h-16 rounded-full bg-[#A5D6F6]/80 border border-[#A5D6F6]/50 mb-4 shadow-lg">
240 |                             <User className="h-8 w-8 text-white" />
241 |                         </div>
242 |                         <h1 className="text-3xl font-bold mb-2 font-heading text-[#BB79D1]">Configure Your Profile</h1>
243 |                         <p className="text-[#222] text-md max-w-md mx-auto font-medium bg-white/60 rounded-xl px-4 py-2 shadow-sm">
244 |                             Personalize your experience for tailored adult content
245 |                         </p>
246 |                     </motion.div>
247 | 
248 |                     {isLoading && (
249 |                         <div className="flex justify-center py-12">
250 |                             <div className="rounded-full h-12 w-12 border-4 border-[#A5D6F6] border-t-transparent animate-spin"></div>
251 |                         </div>
252 |                     )}
253 | 
254 |                     {!isLoading && currentUser && (
255 |                         <motion.form
256 |                             initial={{ opacity: 0, y: 20 }}
257 |                             animate={{ opacity: 1, y: 0 }}
258 |                             transition={{ duration: 0.5, delay: 0.1 }}
259 |                             onSubmit={handleSubmit}
260 |                             className="space-y-8 bg-white/40 backdrop-blur-md rounded-3xl border border-[#BB79D1]/20 shadow-xl p-6"
261 |                         >
262 |                             {/* Language Select */}
263 |                             <div className="space-y-2">
264 |                                 <label htmlFor="language" className="flex items-center gap-2 text-lg font-medium mb-2 font-heading text-[#222]">
265 |                                     <div className="w-8 h-8 rounded-full bg-[#A5D6F6]/20 flex items-center justify-center">
266 |                                         <Globe className="h-4 w-4 text-[#A5D6F6]" />
267 |                                     </div>
268 |                                     <span>Story Language</span>
269 |                                 </label>
270 | 
271 |                                 <Select value={language} onValueChange={setLanguage}>
272 |                                     <SelectTrigger className="w-full bg-white/10 border-[#A5D6F6]/30 backdrop-blur-sm text-[#222] hover:bg-white/20 transition-colors h-12">
273 |                                         {selectedLang ? (
274 |                                             <div className="flex items-center">
275 |                                                 <span role="img" aria-label={selectedLang.label} className="mr-2">{selectedLang.flag}</span>
276 |                                                 {selectedLang.label}
277 |                                             </div>
278 |                                         ) : (
279 |                                             <SelectValue placeholder="Select a language..." />
280 |                                         )}
281 |                                     </SelectTrigger>
282 |                                     <SelectContent className="bg-white border-[#BB79D1]/40 shadow-xl rounded-2xl text-[#222]">
283 |                                         {languages.map((lang) => (
284 |                                             <SelectItem key={lang.value} value={lang.value} className="text-[#222] focus:bg-[#BB79D1]/20 focus:text-[#222]">
285 |                                                 <span className="flex items-center gap-3">
286 |                                                     <span className="text-xl inline-block min-w-[1.5rem]">{lang.flag}</span>
287 |                                                     <span>{lang.label}</span>
288 |                                                 </span>
289 |                                             </SelectItem>
290 |                                         ))}
291 |                                     </SelectContent>
292 |                                 </Select>
293 |                             </div>
294 | 
295 |                             {/* Preferences Text Area */}
296 |                             <div className="space-y-2 pt-2">
297 |                                 <label htmlFor="preferences" className="flex items-center gap-2 text-lg font-medium mb-2 font-heading text-[#222]">
298 |                                     <div className="w-8 h-8 rounded-full bg-[#F6A5B7]/20 flex items-center justify-center">
299 |                                         <Heart className="h-4 w-4 text-[#F6A5B7]" />
300 |                                     </div>
301 |                                     <span>Your Preferences & Interests</span>
302 |                                 </label>
303 | 
304 |                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl border border-white/20 p-4">
305 |                                     <Textarea
306 |                                         id="preferences"
307 |                                         placeholder="Describe your interests, preferences, kinks, fetishes, or specific themes you enjoy in adult content. This will help personalize your stories. (Optional but recommended for better personalization)"
308 |                                         value={preferences}
309 |                                         onChange={(e) => setPreferences(e.target.value)}
310 |                                         className="bg-transparent border-none resize-none focus:ring-0 text-[#222] placeholder:text-[#222]/60 min-h-[120px]"
311 |                                         maxLength={1000}
312 |                                     />
313 |                                     <div className="text-xs text-[#7DC4E0] mt-2">
314 |                                         {preferences.length}/1000 characters
315 |                                     </div>
316 |                                 </div>
317 |                             </div>
318 | 
319 |                             {/* Save Button */}
320 |                             <motion.button
321 |                                 whileHover={{ scale: 1.02 }}
322 |                                 whileTap={{ scale: 0.98 }}
323 |                                 type="submit"
324 |                                 disabled={isSaving || isLoading}
325 |                                 className={`w-full mt-6 py-4 px-6 rounded-xl font-medium flex items-center justify-center gap-2 shadow-lg transition-all ${
326 |                                     (isSaving || isLoading)
327 |                                         ? 'bg-gray-400/30 border-gray-400/30 text-gray-500 cursor-not-allowed'
328 |                                         : 'bg-[#BB79D1]/30 border border-[#BB79D1]/30 hover:bg-[#BB79D1]/40 text-[#222]'
329 |                                 }`}
330 |                             >
331 |                                 {isSaving ? (
332 |                                     <div className="h-5 w-5 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin mr-2"></div>
333 |                                 ) : (
334 |                                     <Check className="h-5 w-5 text-[#BB79D1]" />
335 |                                 )}
336 |                                 <span>{isSaving ? "Saving..." : "Save Profile"}</span>
337 |                             </motion.button>
338 |                         </motion.form>
339 |                     )}
340 |                 </div>
341 |             </div>
342 |         </PageTransition>
343 |     );
344 | };
345 | 
346 | export default ProfileConfigPage;
347 | ```
348 | 
349 | **CAMBIOS CLAVE:**
350 | - ❌ **Eliminado:** Dependencia de `useUserStore`
351 | - ❌ **Eliminado:** `childAge` slider y `specialNeed` select
352 | - ✅ **Añadido:** Consultas directas a Supabase con `supabase.from('profiles')`
353 | - ✅ **Añadido:** Campo `preferences` con textarea para contenido adulto
354 | - ✅ **Añadido:** UI completamente en inglés
355 | - ✅ **Añadido:** Validación de caracteres y mejor UX
356 | 
357 | ### 3. Actualización de Edge Function: generate-story
358 | 
359 | #### Archivo: `supabase/functions/generate-story/index.ts`
360 | 
361 | **CAMBIOS REQUERIDOS:**
362 | 
363 | ```typescript
364 | // LÍNEAS 119-123: Cargar perfil INCLUYENDO preferences
365 | const { data: profile, error: profileError } = await supabaseAdmin
366 |   .from('profiles')
367 |   .select('subscription_status, monthly_stories_generated, language, preferences') // ✅ AÑADIR preferences
368 |   .eq('id', userId)
369 |   .maybeSingle();
370 | 
371 | // LÍNEAS 281-287: Pasar preferences al prompt (REMOVER childAge/specialNeed)
372 | const systemPrompt = createSystemPrompt(
373 |   profile?.language || 'en',        // ✅ Usar language de DB
374 |   profile?.preferences || null      // ✅ Usar preferences de DB
375 | );
376 | const userPrompt = createUserPrompt_JsonFormat({
377 |   options: params.options,
378 |   additionalDetails: params.additionalDetails
379 | });
380 | 
381 | // ELIMINAR COMPLETAMENTE estas líneas (YA NO EXISTEN EN PARAMS):
382 | // params.childAge ❌
383 | // params.specialNeed ❌
384 | ```
385 | 
386 | #### Archivo: `supabase/functions/generate-story/prompt.ts`
387 | 
388 | **REESCRITURA COMPLETA del sistema de prompts:**
389 | 
390 | ```typescript
391 | // NUEVO createSystemPrompt para contenido adulto
392 | export function createSystemPrompt(language: string, preferences?: string | null): string {
393 |     console.log(`[Adult Content v8.0] createSystemPrompt: lang=${language}, preferences=${preferences ? 'provided' : 'none'}`);
394 | 
395 |     let base = `You are an expert writer creating personalized erotic stories for adults. Write always in ${language}, with sophisticated and sensual language appropriate for mature audiences (18+).`;
396 |     
397 |     if (preferences && preferences.trim()) {
398 |         base += ` The user has specified these preferences and interests: "${preferences.trim()}". Incorporate these elements thoughtfully and naturally into the story to create a personalized experience.`;
399 |         base += ` Guidelines for user preferences:\n`;
400 |         base += `   - **Respect Boundaries:** Only include elements that align with the specified preferences\n`;
401 |         base += `   - **Natural Integration:** Weave preferences into the plot organically, don't force them\n`;
402 |         base += `   - **Quality Focus:** Prioritize good storytelling over just including fetishes\n`;
403 |         base += `   - **Consent & Positivity:** All interactions should be consensual and positive\n`;
404 |         base += `   - **Character Development:** Use preferences to enhance character depth and relationships\n`;
405 |     } else {
406 |         base += ` Since no specific preferences were provided, create a sensual and engaging story with broad adult appeal, focusing on romance, attraction, and intimate connections.`;
407 |     }
408 |     
409 |     base += ` The story should follow a clear narrative structure: an engaging beginning that sets the mood, development with building tension and desire, and a satisfying climax and resolution.`;
410 |     base += ` Use sophisticated and evocative language that creates atmosphere and emotional connection. Focus on character development, sensual descriptions, and meaningful intimate moments.`;
411 |     base += ` Ensure all content is consensual, positive, and celebrates adult sexuality in a healthy and appealing way.`;
412 |     
413 |     return base;
414 | }
415 | 
416 | // ACTUALIZAR createUserPrompt_JsonFormat
417 | export function createUserPrompt_JsonFormat({ options, additionalDetails }: CreateUserPromptParams): string {
418 |     console.log(`[Adult Content v8.0] createUserPrompt_JsonFormat:`, options, `details=`, additionalDetails);
419 |     const storyDuration = options.duration || 'medium';
420 |     const language = options.language || 'en';
421 | 
422 |     const characters = options.characters || [];
423 |     const isMultipleCharacters = characters.length > 1;
424 | 
425 |     let request = `Create an erotic story for adults. Genre: ${options.genre}. Theme/Message: ${options.moral}. `;
426 |     
427 |     if (isMultipleCharacters) {
428 |         request += `Main Characters (${characters.length}): `;
429 |         characters.forEach((char, index) => {
430 |             request += `${index + 1}. ${char.name}`;
431 |             if (char.profession) request += `, profession: ${char.profession}`;
432 |             if (char.hobbies?.length) request += `, interests: ${char.hobbies.join(', ')}`;
433 |             if (char.personality) request += `, personality: ${char.personality}`;
434 |             if (index < characters.length - 1) request += '; ';
435 |         });
436 |         request += `.\n\n`;
437 |         
438 |         request += `**Instructions for multiple characters:**\n`;
439 |         request += `- Ensure ALL characters have significant participation in the story\n`;
440 |         request += `- Each character should contribute uniquely based on their profession, interests, and personality\n`;
441 |         request += `- Create natural and dynamic interactions between characters\n`;
442 |         request += `- Develop romantic/erotic tension and relationships between characters as appropriate\n`;
443 |         request += `- Keep the story focused and coherent despite multiple protagonists\n\n`;
444 |     } else {
445 |         const char = characters[0];
446 |         request += `Main Character: ${char.name}`;
447 |         if (char.profession) request += `, profession: ${char.profession}`;
448 |         if (char.hobbies?.length) request += `, interests: ${char.hobbies.join(', ')}`;
449 |         if (char.personality) request += `, personality: ${char.personality}`;
450 |         request += `.\n\n`;
451 |     }
452 | 
453 |     // Content and structure instructions for adult content
454 |     request += `**Content, Length and Structure Instructions:**\n`;
455 |     request += `1. **Target Duration:** '${storyDuration}'.\n`;
456 |     
457 |     if (storyDuration === 'short') request += `    * Guide (Short): ~800 tokens (~600-700 words).\n`;
458 |     else if (storyDuration === 'long') request += `    * Guide (Long): ~2150 tokens (~1600-1800 words).\n`;
459 |     else request += `    * Guide (Medium): ~1350 tokens (~1000-1200 words).\n`;
460 | 
461 |     if (additionalDetails && typeof additionalDetails === 'string' && additionalDetails.trim()) {
462 |         request += `\n**Additional user instructions:**\n${additionalDetails.trim()}\n`;
463 |     }
464 | 
465 |     request += `2. **Complete Structure:** Clear beginning, development, and satisfying conclusion.\n`;
466 |     request += `3. **Tone and Style:** Use sophisticated, sensual language that builds atmosphere and emotional connection. Create vivid scenes that engage the reader's imagination.\n`;
467 |     request += `4. **Adult Content Guidelines:** All interactions must be consensual and positive. Focus on emotional connection alongside physical attraction. Build tension and desire naturally through the narrative.\n`;
468 |     request += `5. **Character Development:** Create believable, complex characters with desires and motivations. Show their emotional journey alongside the physical story.\n`;
469 |     
470 |     request += `6. **Title:** Generate an extraordinary title (memorable, evocative, intriguing). The title should follow "Sentence case" style. The title must be written in the same language selected for the story: ${language}.\n`;
471 | 
472 |     // JSON format instructions (unchanged)
473 |     request += `\n**Response format instructions (VERY IMPORTANT!):**\n`;
474 |     request += `* You must respond with a SINGLE JSON object.\n`;
475 |     request += `* The JSON object must have exactly two keys: "title" and "content".\n`;
476 |     request += `* The "title" key value should be a string containing ONLY the generated title (ideally 4-7 words), following the title guidelines above (${language} language, "Sentence case").\n`;
477 |     request += `* The "content" key value should be a string with ALL the story content, starting directly with the first sentence of the story.\n`;
478 |     request += `* Example of expected JSON format: {"title": "An extraordinary title here", "content": "Once upon a time in a distant place..."}\n`;
479 |     request += `* Do NOT include ANYTHING before the '{' character that starts the JSON object.\n`;
480 |     request += `* Do NOT include ANYTHING after the '}' character that ends the JSON object.\n`;
481 |     request += `* Ensure the JSON is valid and complete.\n`;
482 |     request += `* Do NOT use markdown or any other formatting INSIDE the JSON strings unless it's part of the natural story text.\n`;
483 | 
484 |     return request;
485 | }
486 | ```
487 | 
488 | ### 4. Actualización de Edge Function: story-continuation
489 | 
490 | #### Archivo: `supabase/functions/story-continuation/index.ts`
491 | 
492 | **CAMBIOS REQUERIDOS:**
493 | 
494 | ```typescript
495 | // LÍNEAS 236-242: Obtener preferences del perfil en lugar de parámetros
496 | const { data: profile } = await supabaseAdmin
497 |   .from('profiles')
498 |   .select('language, preferences')
499 |   .eq('id', userId)
500 |   .single();
501 | 
502 | const language = profile?.language || story?.options?.language || 'en';
503 | const preferences = profile?.preferences || null;
504 | 
505 | // LÍNEAS 268-285: Pasar preferences a los prompts
506 | if (action === 'generateOptions') {
507 |   const optionsResponse = await generateContinuationOptions(
508 |     story as Story, 
509 |     chapters as Chapter[], 
510 |     language, 
511 |     preferences  // ✅ USAR preferences en lugar de childAge/specialNeed
512 |   );
513 |   responsePayload = optionsResponse;
514 | }
515 | 
516 | // Similar para continuaciones:
517 | const continuationPrompt = createContinuationPrompt(
518 |   action as 'freeContinuation' | 'optionContinuation' | 'directedContinuation',
519 |   story as Story,
520 |   chapters as Chapter[],
521 |   continuationContext,
522 |   language,
523 |   preferences,    // ✅ USAR preferences
524 |   storyDuration
525 | );
526 | ```
527 | 
528 | #### Archivo: `supabase/functions/story-continuation/prompt.ts`
529 | 
530 | **ACTUALIZACIÓN COMPLETA para contenido adulto:**
531 | 
532 | ```typescript
533 | // ACTUALIZAR createContinuationOptionsPrompt
534 | export function createContinuationOptionsPrompt(
535 |     story: Story,
536 |     chapters: Chapter[],
537 |     language: string = 'en',
538 |     preferences: string | null = null,  // ✅ CAMBIO: preferences en lugar de childAge/specialNeed
539 | ): string {
540 |     const functionVersion = "v8.0 (Adult Content + Preferences)";
541 |     console.log(`[Prompt Helper ${functionVersion}] createContinuationOptionsPrompt for story ID: ${story.id}, lang: ${language}`);
542 | 
543 |     let prompt = `You are a creative assistant expert in generating interesting and coherent continuations for erotic stories for adults.
544 |   Primary Story Language: ${language}. Target Audience: Adults (18+).`;
545 | 
546 |     if (preferences && preferences.trim()) {
547 |         prompt += `\nConsider the user's preferences when suggesting continuations: "${preferences.trim()}". Incorporate these elements naturally and appropriately.`;
548 |     }
549 | 
550 |     prompt += `\n\n--- COMPLETE STORY CONTEXT SO FAR ---`;
551 |     prompt += `\n\n**Original Story (General Title: "${story.title}")**`;
552 |     
553 |     // Character handling (unchanged)
554 |     const characters = story.options.characters || [];
555 |     
556 |     if (characters.length > 1) {
557 |         prompt += `\nMain Characters (${characters.length}): `;
558 |         characters.forEach((char, index) => {
559 |             prompt += `${index + 1}. ${char.name}`;
560 |             if (char.profession) prompt += ` (${char.profession})`;
561 |             if (index < characters.length - 1) prompt += ', ';
562 |         });
563 |         prompt += `.`;
564 |     } else if (characters.length === 1) {
565 |         prompt += `\nMain Character: ${characters[0].name}.`;
566 |     }
567 |     
568 |     prompt += `\n\n**Story Beginning:**\n${story.content}\n`;
569 | 
570 |     if (chapters && chapters.length > 0) {
571 |         prompt += `\n\n**Previous Chapters:**`;
572 |         chapters.forEach((chap) => {
573 |             prompt += `\n\n**Chapter ${chap.chapter_number}: "${chap.title}"**\n${chap.content}\n`;
574 |         });
575 |     }
576 |     prompt += `\n--- END OF COMPLETE CONTEXT ---\n`;
577 | 
578 |     prompt += `\n\nBased on the current state of the story (considering ALL the context provided above), generate 3 concise and attractive options to continue the erotic story. Each option should be a brief summary (10-20 words) of a possible next step in the adult adventure.`;
579 |     prompt += `\nThe options should be varied, offering different paths or approaches for continuation that maintain the erotic/romantic tension.`;
580 |     prompt += `\nEnsure the options explore clearly distinct themes or actions (for example: one option about exploring a new location, another about the introduction of a new character or element, and another about deepening intimacy or trying something new).`;
581 |     prompt += `\nThey must be written in ${language}.`;
582 | 
583 |     // JSON format instructions (unchanged)
584 |     prompt += `\n\n**Response format instructions (VERY IMPORTANT!):**`;
585 |     prompt += `\n* You must respond with a SINGLE JSON object.`;
586 |     prompt += `\n* The JSON object must have a single key called "options".`;
587 |     prompt += `\n* The value of the "options" key must be an array (list) of exactly 3 objects.`;
588 |     prompt += `\n* Each object within the "options" array must have a single key called "summary".`;
589 |     prompt += `\n* The value of the "summary" key should be a text string with the continuation option summary (10-20 words in ${language}).`;
590 |     prompt += `\n* Example of expected JSON format:`;
591 |     prompt += `\n{`;
592 |     prompt += `\n  "options": [`;
593 |     prompt += `\n    { "summary": "The character decides to explore the mysterious bedroom." },`;
594 |     prompt += `\n    { "summary": "A new romantic interest appears unexpectedly." },`;
595 |     prompt += `\n    { "summary": "The character remembers a secret fantasy to explore." }`;
596 |     prompt += `\n  ]`;
597 |     prompt += `\n}`;
598 |     prompt += `\n* Do NOT include ANYTHING before the '{' character that starts the JSON object.`;
599 |     prompt += `\n* Do NOT include ANYTHING after the '}' character that ends the JSON object.`;
600 |     prompt += `\n* Ensure the JSON is valid and complete.`;
601 | 
602 |     return prompt;
603 | }
604 | 
605 | // ACTUALIZAR createContinuationPrompt
606 | export function createContinuationPrompt(
607 |     action: 'freeContinuation' | 'optionContinuation' | 'directedContinuation',
608 |     story: Story,
609 |     chapters: Chapter[],
610 |     context: ContinuationContextType,
611 |     language: string = 'en',
612 |     preferences: string | null = null,  // ✅ CAMBIO: preferences en lugar de childAge/specialNeed
613 |     storyDuration: string = 'medium'
614 | ): string {
615 |     const functionVersion = "v8.0 (Adult Content + Preferences)";
616 |     console.log(`[Prompt Helper ${functionVersion}] createContinuationPrompt for story ID: ${story.id}, action: ${action}, lang: ${language}`);
617 | 
618 |     let prompt = `You are an expert writer continuing erotic stories for adults.
619 |   Write always in ${language}, with sophisticated and sensual language appropriate for mature audiences (18+).
620 |   The original story has a genre of '${story.options.genre}' and a main theme of '${story.options.moral}'.`;
621 | 
622 |     // Chapter length guidance
623 |     prompt += `\n\n**Chapter length guide:**`;
624 |     if (storyDuration === 'short') prompt += `\n* Short chapter: ~800 tokens (approx. 600-700 words).`;
625 |     else if (storyDuration === 'long') prompt += `\n* Long chapter: ~2150 tokens (approx. 1600-1800 words).`;
626 |     else prompt += `\n* Medium chapter: ~1350 tokens (approx. 1000-1200 words).`;
627 |     prompt += `\nThese figures are approximate and serve as reference for the expected length.`;
628 | 
629 |     if (preferences && preferences.trim()) {
630 |         prompt += `\nIncorporate the user's preferences naturally into the continuation: "${preferences.trim()}". Ensure all content remains consensual and positive while exploring these interests.`;
631 |         prompt += ` Guidelines for preferences:\n`;
632 |         prompt += `   - **Natural Integration:** Weave preferences into the plot organically\n`;
633 |         prompt += `   - **Consensual Content:** All interactions must be consensual and positive\n`;
634 |         prompt += `   - **Character Consistency:** Maintain character personalities while exploring preferences\n`;
635 |         prompt += `   - **Quality Storytelling:** Prioritize good narrative flow over just including elements\n`;
636 |     }
637 | 
638 |     // Complete context (unchanged structure, but content focus is now adult)
639 |     prompt += `\n\n--- COMPLETE STORY CONTEXT SO FAR ---`;
640 |     prompt += `\n\n**Original Story (General Title: "${story.title}")**`;
641 |     
642 |     const characters = story.options.characters || [];
643 |     
644 |     if (characters.length > 1) {
645 |         prompt += `\nMain Characters (${characters.length}): `;
646 |         characters.forEach((char, index) => {
647 |             prompt += `${index + 1}. ${char.name}`;
648 |             if (char.profession) prompt += `, Profession: ${char.profession}`;
649 |             if (char.personality) prompt += `, Personality: ${char.personality}`;
650 |             if (index < characters.length - 1) prompt += '; ';
651 |         });
652 |         prompt += `.`;
653 |         
654 |         prompt += `\n\n**IMPORTANT for multiple characters:** In this chapter, ensure all characters maintain their consistency and that each has relevant participation according to the story development and their established relationships.`;
655 |     } else if (characters.length === 1) {
656 |         const char = characters[0];
657 |         prompt += `\nMain Character: ${char.name}`;
658 |         if (char.profession) prompt += `, Profession: ${char.profession}`;
659 |         if (char.personality) prompt += `, Personality: ${char.personality}`;
660 |         prompt += `.`;
661 |     }
662 |     
663 |     prompt += `\n\n**Story Beginning:**\n${story.content}\n`;
664 | 
665 |     if (chapters && chapters.length > 0) {
666 |         prompt += `\n\n**Previous Chapters:**`;
667 |         chapters.forEach((chap) => {
668 |             prompt += `\n\n**Chapter ${chap.chapter_number}: "${chap.title}"**\n${chap.content}\n`;
669 |         });
670 |     }
671 |     prompt += `\n--- END OF COMPLETE CONTEXT ---\n`;
672 | 
673 |     prompt += `\n\n--- YOUR TASK ---`;
674 |     prompt += `\nConsidering ALL the context provided above, write the NEXT CHAPTER of this adult story.`;
675 | 
676 |     if (action === 'optionContinuation' && context.optionSummary) {
677 |         prompt += `\nThe continuation should be based on the following option chosen by the user: "${context.optionSummary}"`;
678 |     } else if (action === 'directedContinuation' && context.userDirection) {
679 |         prompt += `\nThe continuation should follow this specific direction provided by the user: "${context.userDirection}"`;
680 |     } else {
681 |         prompt += `\nContinue the story freely and creatively, maintaining coherence with previous events and characters.`;
[TRUNCATED]
```

docs/IMPLEMENTATIONS/PLAN_MIGRACION_PERSONAJES.md
```
1 | # Plan de Implementación: Migración del Sistema de Personajes
2 | 
3 | ## Resumen Ejecutivo
4 | 
5 | Este documento detalla la migración completa del sistema de personajes de **Fantasia** desde la estructura compleja actua
6 | l hacia el nuevo esquema simplificado definido en la base de datos. La migración eliminará la dependencia de Zustand Store y implementará llamadas directas a Supabase, simplificando el flujo de creación de personajes y alineándose con la transformación hacia una plataforma de contenido adulto.
7 | 
8 | ## Contexto de la Migración
9 | 
10 | ### Estado Actual (Antes)
11 | - **Estructura compleja**: Personajes con múltiples campos (name, hobbies, profession, characterType, personality, description)
12 | - **Flujo multi-step**: 6 páginas separadas para la creación de personajes
13 | - **Dependencia de Zustand**: Almacenamiento local con sincronización asíncrona
14 | - **Enfoque infantil**: Campos orientados a cuentos para niños
15 | 
16 | ### Estado Objetivo (Después)
17 | - **Estructura simplificada**: Solo 3 campos (name, gender, description)
18 | - **Flujo único**: Una sola página para creación/edición
19 | - **Llamadas directas a Supabase**: Sin dependencia de store local
20 | - **Enfoque adulto**: Descripción libre para contenido personalizado
21 | 
22 | ## Análisis del Estado Actual
23 | 
24 | ### Esquema de Base de Datos
25 | ```sql
26 | -- NUEVO ESQUEMA (Ya implementado en docs/sql_supabase.sql)
27 | CREATE TABLE public.characters (
28 |     id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
29 |     user_id uuid NOT NULL,
30 |     name text NOT NULL,
31 |     gender public.gender_options NOT NULL,  -- ENUM: 'male', 'female', 'non-binary'
32 |     description text NOT NULL,
33 |     created_at timestamp with time zone NOT NULL DEFAULT now(),
34 |     updated_at timestamp with time zone NOT NULL DEFAULT now()
35 | );
36 | ```
37 | 
38 | ### Tipos TypeScript Actuales
39 | ```typescript
40 | // ACTUAL (En src/types/index.ts)
41 | export type StoryCharacter = {
42 |   id: string;
43 |   name: string;              // ✅ MANTENER
44 |   hobbies: string[];         // ❌ ELIMINAR
45 |   description: string;       // ✅ MANTENER (expandir propósito)
46 |   profession: string;        // ❌ ELIMINAR
47 |   characterType: string;     // ❌ ELIMINAR
48 |   personality?: string;      // ❌ ELIMINAR
49 | }
50 | 
51 | // OBJETIVO (Nueva estructura)
52 | export type StoryCharacter = {
53 |   id: string;
54 |   name: string;
55 |   gender: 'male' | 'female' | 'non-binary';
56 |   description: string;
57 |   created_at?: string;
58 |   updated_at?: string;
59 | }
60 | ```
61 | 
62 | ### Páginas Actuales del Flujo
63 | 1. **`CharacterName.tsx`** - ✅ MANTENER (agregar gender)
64 | 2. **`CharacterHobbies.tsx`** - ❌ ELIMINAR COMPLETAMENTE
65 | 3. **`CharacterProfession.tsx`** - ❌ ELIMINAR COMPLETAMENTE
66 | 4. **`CharacterPersonality.tsx`** - ❌ ELIMINAR COMPLETAMENTE
67 | 5. **`CharactersManagement.tsx`** - ✅ ACTUALIZAR (simplificar UI)
68 | 6. **`CharacterSelection.tsx`** - ✅ ACTUALIZAR (nueva estructura)
69 | 
70 | ### Store Actual (Zustand)
71 | - **Ubicación**: `src/store/character/characterStore.ts`
72 | - **Problema**: Dependencia completa de localStorage y sync queue
73 | - **Solución**: Eliminar store, usar llamadas directas a Supabase
74 | 
75 | ## Plan de Implementación Detallado
76 | 
77 | ### ✅ FASE 1: Migración de Tipos y Esquemas - **COMPLETADA**
78 | 
79 | #### ✅ 1.1 Actualizar Tipos TypeScript
80 | **Archivo**: `src/types/index.ts` - **IMPLEMENTADO**
81 | 
82 | **Cambios realizados**:
83 | ```typescript
84 | // ANTES:
85 | export type StoryCharacter = {
86 |   id: string;
87 |   name: string;
88 |   hobbies: string[];
89 |   description: string;
90 |   profession: string;
91 |   characterType: string;
92 |   personality?: string;
93 | }
94 | 
95 | // DESPUÉS - IMPLEMENTADO:
96 | export type StoryCharacter = {
97 |   id: string;
98 |   name: string;
99 |   gender: 'male' | 'female' | 'non-binary';
100 |   description: string;
101 |   created_at?: string;
102 |   updated_at?: string;
103 | }
104 | 
105 | // ELIMINADOS COMPLETAMENTE:
106 | ✅ export type PartialStoryCharacter = { ... } - ELIMINADO
107 | ✅ export type HobbyOption = { ... } - ELIMINADO
108 | ```
109 | 
110 | #### ✅ 1.2 Interfaces de Store
111 | **Archivo**: `src/store/types/storeTypes.ts` - **VERIFICADO**
112 | 
113 | **Estado**:
114 | - ✅ `CharacterState` automáticamente compatible con nueva estructura StoryCharacter
115 | - ✅ Métodos del store funcionando correctamente con nuevos tipos
116 | - ✅ Sin errores de TypeScript (`npx tsc --noEmit` ejecutado exitosamente)
117 | 
118 | **⚠️ NOTA PARA PRÓXIMAS FASES**:
119 | - La interfaz `CharacterState` se mantendrá temporalmente hasta Fase 5
120 | - En Fase 5 se eliminará completamente junto con el store de Zustand
121 | - Los métodos actuales seguirán funcionando durante la migración gradual
122 | 
123 | ### ✅ FASE 2: Eliminación de Páginas Obsoletas - **COMPLETADA**
124 | 
125 | #### ✅ 2.1 Eliminar Páginas Completas - **IMPLEMENTADO**
126 | **Archivos ELIMINADOS**:
127 | - ✅ `src/pages/CharacterHobbies.tsx` - ELIMINADO
128 | - ✅ `src/pages/CharacterProfession.tsx` - ELIMINADO
129 | - ✅ `src/pages/CharacterPersonality.tsx` - ELIMINADO
130 | 
131 | #### ✅ 2.2 Actualizar Rutas - **IMPLEMENTADO**
132 | **Archivo**: `src/App.tsx` - **ACTUALIZADO**
133 | 
134 | **Cambios realizados**:
135 | - ✅ Eliminadas rutas hacia páginas obsoletas (líneas 82-84)
136 | - ✅ Eliminados imports de páginas obsoletas (líneas 19-21)
137 | - ✅ Actualizado flujo de navegación en `CharacterName.tsx`
138 | - ✅ Simplificado el path: `CharacterName` → `StoryGenre` (directo)
139 | 
140 | **⚠️ NOTAS PARA FASE 3**:
141 | - El flujo ahora va directo de nombre a género de historia
142 | - CharacterName.tsx necesita ser expandido para incluir gender y description
143 | - Navegación simplificada reduce pasos de 4 a 1
144 | - Toast actualizado: "Continuando a la selección de género..."
145 | - Verificación TypeScript: ✅ Sin errores
146 | 
147 | ### ✅ FASE 3: Refactorización de Página Principal - **COMPLETADA**
148 | 
149 | #### ✅ 3.1 Transformar CharacterName.tsx - **IMPLEMENTADO**
150 | **Archivo**: `src/pages/CharacterName.tsx` - **COMPLETADO**
151 | 
152 | **Cambios implementados**:
153 | ```typescript
154 | // ✅ FORMULARIO COMPLETO IMPLEMENTADO:
155 | const CharacterName = () => {
156 |   const [character, setCharacter] = useState({
157 |     name: '',
158 |     gender: 'male' as const,
159 |     description: ''
160 |   });
161 | 
162 |   // ✅ Llamadas directas a Supabase (sin store)
163 |   const handleSave = async () => {
164 |     const { data, error } = await supabase
165 |       .from('characters')
166 |       .insert([{
167 |         user_id: user.id,
168 |         name: character.name,
169 |         gender: character.gender,
170 |         description: character.description
171 |       }]);
172 |   };
173 | 
174 |   return (
175 |     <form>
176 |       {/* ✅ Campo nombre con validación en tiempo real */}
177 |       <Input 
178 |         value={character.name}
179 |         onChange={(e) => handleFieldChange('name', e.target.value)}
180 |         placeholder="Ej: Alex, María, Jordan..."
181 |       />
182 |       
183 |       {/* ✅ Selector de género con iconos visuales */}
184 |       <Select
185 |         value={character.gender}
186 |         onValueChange={(value) => handleFieldChange('gender', value)}
187 |       >
188 |         <SelectItem value="male">♂ Masculino</SelectItem>
189 |         <SelectItem value="female">♀ Femenino</SelectItem>
190 |         <SelectItem value="non-binary">⚧ No binario</SelectItem>
191 |       </Select>
192 |       
193 |       {/* ✅ Descripción expandida (500 caracteres) */}
194 |       <Textarea
195 |         value={character.description}
196 |         onChange={(e) => handleFieldChange('description', e.target.value)}
197 |         placeholder="Describe tu personaje: personalidad, apariencia, gustos, profesión, hobbies, preferencias, fantasias..."
198 |         maxLength={500}
199 |       />
200 |       
201 |       <Button onClick={handleSave}>Crear/Actualizar Personaje</Button>
202 |     </form>
203 |   );
204 | };
205 | ```
206 | 
207 | **Funcionalidades implementadas**:
208 | - ✅ **Eliminación de useCharacterStore**: Migración completa a llamadas directas Supabase
209 | - ✅ **Formulario unificado**: Nombre, género y descripción en una sola página
210 | - ✅ **Validaciones robustas**: En tiempo real con manejo de edge cases
211 | - ✅ **Diseño mobile-first**: Responsive optimizado para dispositivos móviles
212 | - ✅ **Estados de carga**: Loading states con spinner y feedback visual
213 | - ✅ **Manejo de errores**: Network, sesión expirada, permisos, duplicados
214 | - ✅ **Soporte edición**: Crear y editar personajes en el mismo formulario
215 | - ✅ **UX mejorada**: Toast notifications, validación visual, contador caracteres
216 | 
217 | **Verificaciones realizadas**:
218 | - ✅ TypeScript: Sin errores (`npx tsc --noEmit`)
219 | - ✅ Build: Compilación exitosa (`npm run build`)
220 | - ✅ Linter: Sin errores en archivo refactorizado
221 | - ✅ Navegación: Flujo CharacterName → StoryGenre funcional
222 | 
223 | ### FASE 4: Actualización de Gestión de Personajes
224 | 
225 | #### 4.1 Simplificar CharactersManagement.tsx
226 | **Archivo**: `src/pages/CharactersManagement.tsx`
227 | 
228 | **Cambios necesarios**:
229 | - Eliminar dependencia de `useCharacterStore`
230 | - Implementar llamadas directas a Supabase
231 | - Actualizar UI para mostrar solo name y description preview
232 | - Simplificar tarjetas de personajes
233 | 
234 | **Antes**:
235 | ```typescript
236 | // LÍNEA 156-158: Mostrando profession y characterType
237 | <p className="text-[#555] text-sm">
238 |   {character.characterType && 
239 |     `${character.characterType}${character.profession ? ` · ${character.profession}` : ''}`}
240 | </p>
241 | ```
242 | 
243 | **Después**:
244 | ```typescript
245 | // NUEVO: Mostrar preview de descripción
246 | <p className="text-[#555] text-sm line-clamp-2">
247 |   {character.description || 'Sin descripción'}
248 | </p>
249 | <p className="text-[#7DC4E0] text-xs mt-1">
250 |   {character.gender === 'male' ? 'Masculino' : 
251 |    character.gender === 'female' ? 'Femenino' : 'No binario'}
252 | </p>
253 | ```
254 | 
255 | #### 4.2 Actualizar CharacterSelection.tsx
256 | **Archivo**: `src/pages/CharacterSelection.tsx`
257 | 
258 | **Cambios necesarios**:
259 | - Eliminar dependencia de store
260 | - Implementar carga directa desde Supabase
261 | - Actualizar UI para nueva estructura
262 | - Simplificar lógica de selección
263 | 
264 | ### FASE 5: Eliminación del Store de Zustand
265 | 
266 | #### 5.1 Eliminar Character Store
267 | **Archivos a ELIMINAR**:
268 | - `src/store/character/characterStore.ts`
269 | - `src/store/character/characterValidation.ts`
270 | 
271 | #### 5.2 Crear Servicios Directos
272 | **Archivo**: `src/services/charactersService.ts` (NUEVO)
273 | 
274 | ```typescript
275 | import { supabase } from './supabase';
276 | import { StoryCharacter } from '../types';
277 | 
278 | export const charactersService = {
279 |   // Obtener personajes del usuario
280 |   async getUserCharacters(userId: string): Promise<StoryCharacter[]> {
281 |     const { data, error } = await supabase
282 |       .from('characters')
283 |       .select('*')
284 |       .eq('user_id', userId);
285 |     
286 |     if (error) throw error;
287 |     return data || [];
288 |   },
289 | 
290 |   // Crear personaje
291 |   async createCharacter(character: Omit<StoryCharacter, 'id'>): Promise<StoryCharacter> {
292 |     const { data, error } = await supabase
293 |       .from('characters')
294 |       .insert([character])
295 |       .select()
296 |       .single();
297 |     
298 |     if (error) throw error;
299 |     return data;
300 |   },
301 | 
302 |   // Actualizar personaje
303 |   async updateCharacter(id: string, updates: Partial<StoryCharacter>): Promise<StoryCharacter> {
304 |     const { data, error } = await supabase
305 |       .from('characters')
306 |       .update(updates)
307 |       .eq('id', id)
308 |       .select()
309 |       .single();
310 |     
311 |     if (error) throw error;
312 |     return data;
313 |   },
314 | 
315 |   // Eliminar personaje
316 |   async deleteCharacter(id: string): Promise<void> {
317 |     const { error } = await supabase
318 |       .from('characters')
319 |       .delete()
320 |       .eq('id', id);
321 |     
322 |     if (error) throw error;
323 |   }
324 | };
325 | ```
326 | 
327 | ### ✅ FASE 6: Actualización de Edge Functions - **COMPLETADA**
328 | 
329 | #### ✅ 6.1 Actualizar generate-story/prompt.ts - **IMPLEMENTADO**
330 | **Archivo**: `supabase/functions/generate-story/prompt.ts` - **COMPLETADO**
331 | 
332 | **Cambios implementados**:
333 | ```typescript
334 | // ✅ ACTUALIZADO (líneas 31-36):
335 | interface CharacterOptions {
336 |     name: string;
337 |     gender: 'male' | 'female' | 'non-binary';
338 |     description: string;
339 | }
340 | 
341 | // ✅ ACTUALIZADO createUserPrompt_JsonFormat (líneas 67-90):
342 | // ANTES: Referencia a profession, hobbies, personality
343 | // DESPUÉS: Solo usar name, gender, description
344 | ```
345 | 
346 | **Cambios implementados en el prompt**:
347 | ```typescript
348 | // ✅ IMPLEMENTADO - Personajes múltiples (líneas 67-71):
349 | characters.forEach((char, index) => {
350 |     request += `${index + 1}. ${char.name}`;
351 |     request += `, gender: ${char.gender}`;
352 |     request += `, description: ${char.description}`;
353 |     if (index < characters.length - 1) request += '; ';
354 | });
355 | 
356 | // ✅ IMPLEMENTADO - Personaje único (líneas 83-86):
357 | const char = characters[0];
358 | request += `Main Character: ${char.name}`;
359 | request += `, gender: ${char.gender}`;
360 | request += `, description: ${char.description}`;
361 | 
362 | // ✅ ACTUALIZADO - Instrucciones para múltiples personajes (línea 77):
363 | "Each character should contribute uniquely based on their gender and personal description"
364 | ```
365 | 
366 | #### ✅ 6.2 Actualizar story-continuation/prompt.ts - **IMPLEMENTADO**
367 | **Archivo**: `supabase/functions/story-continuation/prompt.ts` - **COMPLETADO**
368 | 
369 | **Cambios implementados**:
370 | ```typescript
371 | // ✅ ACTUALIZADO - CharacterOptions interface (líneas 6-10):
372 | export interface CharacterOptions {
373 |     name: string;
374 |     gender: 'male' | 'female' | 'non-binary';
375 |     description: string;
376 | }
377 | 
378 | // ✅ ACTUALIZADO - createContinuationOptionsPrompt (líneas 70-76):
379 | // Personajes múltiples: `${char.name} (${char.gender}, ${char.description})`
380 | // Personaje único: `${characters[0].name} (${characters[0].gender}, ${characters[0].description})`
381 | 
382 | // ✅ ACTUALIZADO - createContinuationPrompt (líneas 161-174):
383 | // Múltiples: `, Gender: ${char.gender}, Description: ${char.description}`
384 | // Único: `, Gender: ${char.gender}, Description: ${char.description}`
385 | ```
386 | 
387 | **Verificaciones realizadas**:
388 | - ✅ TypeScript: Sin errores de compilación (`npx tsc --noEmit`)
389 | - ✅ Build: Compilación exitosa de producción (`npm run build`)
390 | - ✅ Coherencia: Todas las referencias a campos obsoletos eliminadas
391 | - ✅ Funcionalidad: Edge Functions listas para usar nueva estructura de personajes
392 | 
393 | ### ✅ FASE 7: Actualización de Servicios de Generación - **COMPLETADA**
394 | 
395 | #### ✅ 7.1 Actualizar GenerateStoryService.ts - **IMPLEMENTADO**
396 | **Archivo**: `src/services/ai/GenerateStoryService.ts` - **COMPLETADO**
397 | 
398 | **Cambios implementados**:
399 | ```typescript
400 | // ✅ VALIDACIÓN DE ESTRUCTURA DE PERSONAJES (líneas 32-47):
401 | // Validate character structure to ensure compatibility with new schema
402 | if (params.options.characters && params.options.characters.length > 0) {
403 |   const validGenders = ['male', 'female', 'non-binary'];
404 |   for (const character of params.options.characters) {
405 |     if (!character.name || typeof character.name !== 'string' || character.name.trim().length === 0) {
406 |       throw new Error(`Invalid character: missing or empty name field`);
407 |     }
408 |     if (!character.gender || !validGenders.includes(character.gender)) {
409 |       throw new Error(`Invalid character "${character.name}": gender must be one of ${validGenders.join(', ')}`);
410 |     }
411 |     if (!character.description || typeof character.description !== 'string' || character.description.trim().length === 0) {
412 |       throw new Error(`Invalid character "${character.name}": missing or empty description field`);
413 |     }
414 |   }
415 |   console.log('✅ Character structure validation passed');
416 | }
417 | 
418 | // ✅ DEBUG LOGGING MEJORADO (línea 50):
419 | // ANTES: Characters (2): Alex, María
420 | // DESPUÉS: Characters (2): Alex (male), María (female)
421 | const charactersInfo = `Characters (${params.options.characters?.length || 0}): ${params.options.characters?.map(c => `${c.name} (${c.gender})`).join(', ') || 'None'}`;
422 | ```
423 | 
424 | **Funcionalidades agregadas**:
425 | - ✅ **Validación robusta**: Verificación de campos obligatorios (name, gender, description)
426 | - ✅ **Error messages descriptivos**: Mensajes específicos con nombre del personaje problemático
427 | - ✅ **Debug logging mejorado**: Incluye género en el logging para mejor trazabilidad
428 | - ✅ **Validation early exit**: Detección temprana de problemas antes del envío a Edge Functions
429 | 
430 | #### ✅ 7.2 Actualizar StoryContinuationService.ts - **IMPLEMENTADO**
431 | **Archivo**: `src/services/ai/StoryContinuationService.ts` - **COMPLETADO**
432 | 
433 | **Cambios implementados**:
434 | ```typescript
435 | // ✅ CHARACTER LOGGING CONSISTENTE (líneas 38-43):
436 | // Log character information for debugging (consistent with GenerateStoryService)
437 | if (bodyPayload.story && bodyPayload.story.options && bodyPayload.story.options.characters) {
438 |   const characters = bodyPayload.story.options.characters;
439 |   const charactersInfo = `Characters (${characters.length}): ${characters.map(c => `${c.name} (${c.gender})`).join(', ')}`;
440 |   console.log(`[StoryContinuationService] ${charactersInfo}`);
441 | }
442 | ```
443 | 
444 | **Funcionalidades agregadas**:
445 | - ✅ **Logging unificado**: Mismo formato que GenerateStoryService para consistencia
446 | - ✅ **Character tracking**: Mejor visibilidad de qué personajes se procesan en continuaciones
447 | - ✅ **Debug coherente**: Facilita el debugging cuando hay problemas en continuaciones
448 | 
449 | ### ✅ FASE 8: Actualización de UI/UX - **COMPLETADA**
450 | 
451 | #### ✅ 8.1 Mejorar Experiencia de Usuario - **IMPLEMENTADO**
452 | **Cambios de diseño implementados**:
453 | - ✅ **Formulario único más intuitivo**: CharacterName.tsx optimizado con mejor UX
454 | - ✅ **Descripción como campo principal**: Campo expandido con placeholder detallado para contenido adulto
455 | - ✅ **Selector de género visual atractivo**: Iconos mejorados (♂/♀/⚧) con labels visuales
456 | - ✅ **Preview mejorado en gestión de personajes**: Muestra gender + description en lugar de profession
457 | 
458 | #### ✅ 8.2 Mensajes y Validaciones - **IMPLEMENTADO**
459 | **Nuevas validaciones implementadas**:
460 | ```typescript
461 | // IMPLEMENTADO EN: src/services/charactersService.ts
462 | export const validateCharacter = (character: StoryCharacter): CharacterValidationResult => {
463 |   const errors: string[] = [];
464 |   const warnings: string[] = [];
465 |   let isValid = true;
466 | 
467 |   // Validate required fields
468 |   if (!character.name || character.name.trim().length === 0) {
469 |     errors.push("Name is required");
470 |     isValid = false;
471 |   } else {
472 |     // Validate name length
473 |     if (character.name.length < CHARACTER_LIMITS.MIN_NAME_LENGTH) {
474 |       errors.push(`Name must be at least ${CHARACTER_LIMITS.MIN_NAME_LENGTH} characters`);
475 |       isValid = false;
476 |     }
477 |     if (character.name.length > CHARACTER_LIMITS.MAX_NAME_LENGTH) {
478 |       errors.push(`Name cannot exceed ${CHARACTER_LIMITS.MAX_NAME_LENGTH} characters`);
479 |       isValid = false;
480 |     }
481 |   }
482 | 
483 |   // Validate gender (required in new structure)
484 |   if (!character.gender) {
485 |     errors.push("Gender is required");
486 |     isValid = false;
487 |   }
488 | 
489 |   // Validate description (required in new structure)
490 |   if (!character.description || character.description.trim().length === 0) {
491 |     errors.push("Description is required");
492 |     isValid = false;
493 |   } else if (character.description.length < 10) {
494 |     errors.push("Description must be at least 10 characters");
495 |     isValid = false;
496 |   } else if (character.description.length < 20) {
497 |     warnings.push("A more detailed description will make your character more captivating and stories more intimate");
498 |   }
499 | 
500 |   return {
501 |     isValid,
502 |     errors,
503 |     warnings
504 |   };
505 | };
506 | ```
507 | 
508 | #### ✅ 8.3 Migración de Idioma - **COMPLETADO**
509 | **Archivos migrados a inglés con contenido adulto apropiado**:
510 | - ✅ **CharacterSelection.tsx**: 
511 |   - "Choose Your Characters" 
512 |   - "Select up to 4 characters for your erotic story!"
513 |   - "For intimate tales, fewer characters create more passionate focus"
514 | - ✅ **CharactersManagement.tsx**: 
515 |   - "My Characters"
516 |   - "No description yet - add details to make them irresistible"
517 |   - "Create your first character to star in your intimate stories"
518 | - ✅ **CharacterName.tsx**: 
519 |   - "Create your custom character for unique erotic stories"
520 |   - "Describe your character: personality, appearance, desires, profession, hobbies, preferences, fantasies..."
521 |   - "The more detailed the description, the more personalized and intimate your stories will be"
522 | 
523 | #### ✅ 8.4 Eliminación Final de Zustand - **COMPLETADO**
524 | **Cambios de arquitectura implementados**:
525 | - ✅ **useStoryOptionsStore eliminado**: CharacterSelection.tsx migrado a sessionStorage
526 | - ✅ **Servicios directos**: Todas las llamadas van directamente a Supabase
527 | - ✅ **Performance optimizada**: Eliminación total de overhead de Zustand para personajes
528 | - ✅ **Navegación simplificada**: sessionStorage.setItem('selectedCharacters') para flujo de historia
529 | 
530 | #### ✅ 8.5 Limpieza de Código - **COMPLETADO**
531 | **Archivos limpiados**:
532 | - ✅ **syncService.ts**: Comentarios obsoletos de characterStore eliminados
533 | - ✅ **Imports optimizados**: Referencias a stores eliminadas eliminadas
534 | - ✅ **Verificación de build**: npm run build exitoso sin errores
535 | 
536 | **Funcionalidades implementadas**:
537 | - ✅ **Validación completa en inglés**: Mensajes de error/warning orientados a contenido adulto
538 | - ✅ **UX mejorada**: Placeholders sugestivos y apropiados para plataforma erótica
539 | - ✅ **Arquitectura limpia**: Sin dependencias de Zustand en sistema de personajes
540 | - ✅ **Build de producción**: Verificación exitosa con compilación limpia
541 | - ✅ **Mensajes adultos apropiados**: Tono sugestivo pero profesional para plataforma +18
542 | 
543 | **Impacto técnico**:
544 | - **Rendimiento**: Eliminación total de overhead de Zustand Store para personajes
545 | - **Mantenibilidad**: Código más limpio sin dependencias de estado local complejo
546 | - **Escalabilidad**: Arquitectura directa a Supabase lista para funciones en tiempo real
547 | - **UX**: Experiencia orientada a contenido adulto con mensajes apropiados
548 | 
549 | ## Consideraciones Técnicas
550 | 
551 | ### Migración de Datos
552 | - **Datos existentes**: Los personajes existentes en la base de datos necesitarán migración
553 | - **Estrategia**: Consolidar hobbies, profession y personality en el campo description
554 | - **Script de migración**: Crear script SQL para transformar datos existentes
555 | 
556 | ### Compatibilidad
557 | - **Funciones existentes**: Asegurar que las edge functions funcionen con nueva estructura
558 | - **Historias existentes**: Verificar que las historias generadas anteriormente no se vean afectadas
559 | 
560 | ### Performance
561 | - **Llamadas directas**: Eliminar overhead de Zustand store
562 | - **Tiempo real**: Considerar suscripciones en tiempo real para actualizaciones
563 | 
564 | ## Cronograma de Implementación
565 | 
566 | ### Semana 1: Preparación
567 | - [ ] Análisis completo del código existente
568 | - [ ] Backup de datos actuales
569 | - [ ] Preparación de scripts de migración
570 | 
571 | ### Semana 2: Migración de Base
572 | - [x] **Actualizar tipos TypeScript** - ✅ COMPLETADO (Fase 1)
573 | - [x] **Eliminar páginas obsoletas** - ✅ COMPLETADO (Fase 2)
574 | - [x] **Crear servicios directos** - ✅ COMPLETADO (Fase 5 - charactersService.ts)
575 | 
576 | ### Semana 3: Refactorización Principal
577 | - [x] **Transformar página de creación** - ✅ COMPLETADO (Fase 3)
578 | - [x] **Actualizar gestión de personajes** - ✅ COMPLETADO (Fase 4)
579 | - [x] **Eliminar dependencias de Zustand** - ✅ COMPLETADO (Fase 5)
580 | 
581 | ### Semana 4: Edge Functions y Testing
582 | - [x] **Actualizar edge functions** - ✅ COMPLETADO (Fase 6)
583 | - [x] **Actualizar servicios de IA** - ✅ COMPLETADO (Fase 7)
584 | - [x] **Testing completo del flujo** - ✅ COMPLETADO (Fase 7)
585 | 
586 | ### Semana 5: UI/UX y Finalización
587 | - [x] **Migración completa a inglés** - ✅ COMPLETADO (Fase 8)
588 | - [x] **Eliminación final de Zustand** - ✅ COMPLETADO (Fase 8)
589 | - [x] **Validaciones mejoradas** - ✅ COMPLETADO (Fase 8)
590 | - [x] **Build de producción verificado** - ✅ COMPLETADO (Fase 8)
591 | 
592 | ### Semana 6: Migración de Datos y Despliegue (PENDIENTE)
593 | - [ ] Migrar datos existentes
594 | - [ ] Despliegue en producción
595 | - [ ] Monitoreo y ajustes
596 | 
597 | ## Riesgos y Mitigaciones
598 | 
599 | ### Riesgo 1: Pérdida de Datos
600 | - **Mitigación**: Backup completo antes de migración
601 | - **Plan B**: Script de rollback preparado
602 | 
603 | ### Riesgo 2: Incompatibilidad con Historias Existentes
604 | - **Mitigación**: Mantener campos legacy temporalmente
605 | - **Plan B**: Script de conversión de historias
606 | 
607 | ### Riesgo 3: Problemas de Performance
608 | - **Mitigación**: Testing exhaustivo con datos reales
609 | - **Plan B**: Implementación gradual
610 | 
611 | ## Métricas de Éxito
612 | 
613 | ### Técnicas
614 | - [ ] Eliminación completa de dependencias de Zustand (CharacterName.tsx ✅ completado)
615 | - [x] **Tipos TypeScript simplificados** - ✅ COMPLETADO (reducción de 7 a 5 campos)
616 | - [x] **Llamadas directas a Supabase funcionando correctamente** - ✅ COMPLETADO (CharacterName.tsx)
617 | 
618 | ### Funcionales
619 | - [x] **Flujo de creación de personajes completado en <1 minuto** - ✅ COMPLETADO (formulario único)
620 | - [x] **Generación de historias funcionando con nueva estructura** - ✅ COMPLETADO (Edge Functions migradas)
621 | 
622 | 
623 | ### Usuario
624 | - [x] **Experiencia simplificada y más intuitiva** - ✅ COMPLETADO (CharacterName.tsx)
625 | - [x] **Tiempo de carga reducido** - ✅ COMPLETADO (eliminación overhead Zustand)
626 | - [x] **Mayor personalización mediante descripciones libres** - ✅ COMPLETADO (500 caracteres)
627 | 
628 | ## Conclusión
629 | 
630 | Esta migración representa una simplificación significativa del sistema de personajes, alineándose con la transformación de Fantasia hacia una plataforma de contenido adulto. La eliminación de la dependencia de Zustand y la implementación de llamadas directas a Supabase mejorará tanto la performance como la mantenibilidad del código.
631 | 
632 | El enfoque en una descripción libre permitirá mayor personalización y flexibilidad para los usuarios, mientras que la estructura simplificada facilitará futuras mejoras y mantenimiento del sistema.
633 | 
634 | ---
635 | 
636 | **Versión**: 1.4  
637 | **Fecha**: Enero 2025  
638 | **Autor**: Equipo de Desarrollo Fantasia  
639 | **Estado**: FASE 8 COMPLETADA - MIGRACIÓN COMPLETA 100% FINALIZADA - LISTO PARA PRODUCCIÓN
640 | 
641 | ---
642 | 
643 | ## 📋 Estado de Progreso
644 | 
645 | ### ✅ COMPLETADO
646 | - **Fase 1**: Migración de tipos y esquemas
647 |   - StoryCharacter simplificado: 7 → 5 campos
648 |   - Eliminados: PartialStoryCharacter, HobbyOption
649 |   - Verificación TypeScript exitosa
650 |   - Nueva estructura lista para siguientes fases
651 | 
652 | - **Fase 2**: Eliminación de páginas obsoletas
653 |   - ✅ CharacterHobbies.tsx - ELIMINADO (~164 líneas)
654 |   - ✅ CharacterProfession.tsx - ELIMINADO (~218 líneas)
655 |   - ✅ CharacterPersonality.tsx - ELIMINADO (~170 líneas)
656 |   - ✅ App.tsx - Rutas e imports actualizados
657 |   - ✅ CharacterName.tsx - Navegación simplificada
658 |   - ✅ Flujo reducido: 4 pasos → 1 paso
659 |   - ✅ Total eliminado: ~650 líneas de código obsoleto
660 | 
661 | - **Fase 3**: Refactorización de página principal - **COMPLETADA**
662 |   - ✅ CharacterName.tsx expandido con campos gender y description
663 |   - ✅ Formulario completo de creación/edición implementado
664 |   - ✅ Validaciones robustas y manejo de edge cases añadido
665 |   - ✅ Diseño mobile-first responsive implementado
666 |   - ✅ Integración directa con Supabase (sin Zustand)
667 |   - ✅ Estados de loading y feedback visual mejorado
668 |   - ✅ Soporte completo para crear y editar personajes
669 | 
670 | - **Fase 4**: Actualización de gestión de personajes - **EN PROGRESO**
671 |   - ✅ Actualizar CharacterSelection.tsx - **COMPLETADO**
672 |   - 🔄 Refactorizar CharactersManagement.tsx - **PENDIENTE**
673 | 
674 | ### ✅ FASE 4 PARCIALMENTE COMPLETADA - CharacterSelection.tsx
675 | 
676 | #### ✅ 4.2 Actualizar CharacterSelection.tsx - **IMPLEMENTADO**
677 | **Archivo**: `src/pages/CharacterSelection.tsx` - **COMPLETADO**
678 | 
679 | **Cambios implementados**:
680 | ```typescript
681 | // ✅ ELIMINACIÓN COMPLETA DE STORE DEPENDENCY:
682 | - Removido useCharacterStore, validateMultipleCharacterSelection, getCharacterSelectionMessage
683 | - Implementadas funciones locales equivalentes
684 | 
685 | // ✅ CARGA DIRECTA DESDE SUPABASE:
686 | const loadCharacters = async () => {
687 |   const { success, characters: loadedCharacters, error } = await getUserCharacters(user.id);
688 |   // Sin dependencia de store, llamada directa a supabase.ts
689 | };
690 | 
691 | // ✅ ESTADO LOCAL SIMPLIFICADO:
692 | const [characters, setCharacters] = useState<StoryCharacter[]>([]);
693 | const [selectedCharacters, setSelectedCharacters] = useState<StoryCharacter[]>([]);
694 | 
695 | // ✅ UI ACTUALIZADA PARA NUEVA ESTRUCTURA:
696 | - Gender indicators: ♂/♀/⚧ con labels visuales
697 | - Description preview en lugar de profession
698 | - Manejo de errores mejorado con estado de retry
699 | ```
700 | 
701 | **Funcionalidades implementadas**:
702 | - ✅ **Eliminación total de useCharacterStore**: Migración completa a getUserCharacters()
703 | - ✅ **Estado local eficiente**: characters[], selectedCharacters[], isLoading, error
704 | - ✅ **Funciones utilitarias locales**: validateMultipleCharacterSelection, getCharacterSelectionMessage
705 | - ✅ **UI actualizada**: Gender + description preview (líneas 245-260)
706 | - ✅ **Manejo de errores robusto**: Estado error con retry button
707 | - ✅ **Consistencia con nueva estructura**: gender/description en lugar de profession/characterType
708 | 
709 | **Verificaciones realizadas**:
710 | - ✅ TypeScript: Sin errores de compilación
711 | - ✅ Build: Compilación exitosa de producción
712 | - ✅ Supabase integration: getUserCharacters() y syncCharacter() actualizados
713 | - ✅ UI funcionando: Gender indicators y description preview implementados
714 | 
715 | #### ✅ 4.1 Simplificar CharactersManagement.tsx - **IMPLEMENTADO**
716 | **Archivo**: `src/pages/CharactersManagement.tsx` - **COMPLETADO**
717 | 
718 | **Cambios implementados**:
719 | ```typescript
720 | // ✅ ELIMINACIÓN COMPLETA DE STORE DEPENDENCY:
721 | - Removido useCharacterStore y todos sus métodos (loadCharactersFromSupabase, deleteCharacter, resetCharacter)
722 | - Importadas funciones directas: getUserCharacters, deleteCharacter desde services/supabase
723 | 
724 | // ✅ ESTADO LOCAL IMPLEMENTADO:
725 | const [characters, setCharacters] = useState<StoryCharacter[]>([]);
726 | const [isLoading, setIsLoading] = useState(true);
727 | const [error, setError] = useState<string | null>(null);
728 | 
729 | // ✅ CARGA DIRECTA DESDE SUPABASE:
730 | const { success, characters: loadedCharacters, error } = await getUserCharacters(user.id);
731 | // Sin dependencia de store, llamada directa igual que CharacterSelection.tsx
732 | 
733 | // ✅ UI ACTUALIZADA PARA NUEVA ESTRUCTURA:
734 | // ANTES: character.characterType + character.profession
735 | // DESPUÉS:
736 | <p className="text-[#555] text-sm line-clamp-2">
737 |   {character.description || 'Sin descripción'}
738 | </p>
739 | <p className="text-[#7DC4E0] text-xs mt-1">
740 |   {character.gender === 'male' ? '♂ Masculino' : 
741 |    character.gender === 'female' ? '♀ Femenino' : '⚧ No binario'}
742 | </p>
743 | 
744 | // ✅ ELIMINACIÓN MEJORADA CON MANEJO DE ERRORES:
745 | const { success, error: deleteError } = await deleteCharacter(characterToDelete.id);
746 | if (success) {
747 |   setCharacters(prev => prev.filter(char => char.id !== characterToDelete.id));
748 |   // Toast success
749 | } else {
750 |   // Toast error with retry option
751 | }
752 | ```
753 | 
754 | **Funcionalidades implementadas**:
755 | - ✅ **Eliminación total de useCharacterStore**: Migración completa a llamadas directas
756 | - ✅ **Estado local eficiente**: characters[], isLoading, error con useState
757 | - ✅ **Carga directa**: getUserCharacters() sin overhead de store
758 | - ✅ **Eliminación robusta**: deleteCharacter() con actualización local inmediata
759 | - ✅ **UI actualizada**: Gender indicators + description preview (líneas 154-162)
760 | - ✅ **Manejo de errores mejorado**: Estados error con retry y toast notifications
761 | - ✅ **Consistencia arquitectónica**: Mismo patrón que CharacterSelection.tsx
762 | 
763 | **Verificaciones realizadas**:
764 | - ✅ TypeScript: Sin errores de compilación
765 | - ✅ Build: Compilación exitosa de producción
766 | - ✅ Funcionalidad: Create, edit, delete funcionando correctamente
767 | - ✅ UI: Gender + description display implementado correctamente
768 | 
769 | ### ✅ FASE 4 COMPLETADA - Actualización de Gestión de Personajes
770 | 
771 | **Estado final**:
772 | - ✅ **CharacterSelection.tsx** - Migrado completamente (Fase 4.2)
773 | - ✅ **CharactersManagement.tsx** - Migrado completamente (Fase 4.1)
774 | - ✅ **getUserCharacters()** - Actualizado para nueva estructura
775 | - ✅ **deleteCharacter()** - Funcionando con llamadas directas
776 | - ✅ **syncCharacter()** - Actualizado para nueva estructura
777 | 
778 | ### ✅ FASE 5 COMPLETADA - Eliminación del Store de Zustand
779 | 
780 | **Estado final**:
781 | - ✅ **characterStore.ts y characterValidation.ts** - ELIMINADOS completamente (~600 líneas)
782 | - ✅ **charactersService.ts** - CREADO con API completa y validaciones
783 | - ✅ **userStore.ts** - Import dinámico eliminado de syncAllUserData
784 | - ✅ **storyOptionsStore.ts** - Migrado a charactersService.getSelectedCharactersByIds()
785 | - ✅ **storyGenerator.ts** - Migrado a charactersService.getUserCharacters()
786 | - ✅ **store/index.ts** - Export de characterStore eliminado
787 | - ✅ **CharacterSelection.tsx** - Funciones de validación migradas al servicio
788 | - ✅ **store/types/storeTypes.ts** - CharacterState interface eliminada
789 | 
790 | **Verificaciones exitosas**:
791 | - ✅ TypeScript: Compilación sin errores (`npx tsc --noEmit`)
[TRUNCATED]
```

docs/IMPLEMENTATIONS/PLAN_RESOLUCION_ERRORES_AUTH.md
```
1 | # Plan de Resolución: Errores de Autenticación y Perfil
2 | 
3 | **Fecha**: Enero 2025  
4 | **Prioridad**: Alta  
5 | **Estimación**: 2-3 horas  
6 | 
7 | ## Resumen Ejecutivo
8 | 
9 | Se han identificado dos errores críticos en el flujo de autenticación post-login:
10 | 
11 | 1. **Error 1**: Usuario ve página "Not Found" tras login exitoso
12 | 2. **Error 2**: Bucle infinito entre configuración de perfil y selección de planes
13 | 
14 | ## Análisis Detallado de Problemas
15 | 
16 | ### 🔍 Error 1: Página "Not Found" tras Login
17 | 
18 | **Síntomas observados en logs**:
19 | ```
20 | [Error] Failed to load resource: the server responded with a status of 406 (Not Acceptable) (profiles, line 0)
21 | [Error] Error loading profile: PGRST116 - JSON object requested, multiple (or no) rows returned
22 | ```
23 | 
24 | **Causa raíz**:
25 | - Usuario autenticado no tiene registro en tabla `profiles`
26 | - La consulta `getUserProfile()` falla con error 406/PGRST116
27 | - AuthGuard intenta redirigir a `/profile-config` pero hay inconsistencias
28 | 
29 | **Archivos afectados**:
30 | - `src/services/supabase.ts:63-70` (getUserProfile)
31 | - `src/store/user/userStore.ts:28-50` (loginUser)
32 | - `src/components/AuthGuard.tsx:42-59` (redirect logic)
33 | 
34 | ### 🔄 Error 2: Bucle entre Perfil y Planes
35 | 
36 | **Flujo problemático**:
37 | 1. Usuario completa configuración en `/profile-config`
38 | 2. Navega a `/plans` con botón "Continue with free plan"  
39 | 3. Sistema vuelve a redirigir a `/profile-config`
40 | 
41 | **Causa raíz**:
42 | - El flag `has_completed_setup` no se actualiza correctamente
43 | - Múltiples consultas asíncronas causan condiciones de carrera
44 | - Diferencia temporal entre guardar perfil y verificar autenticación
45 | 
46 | **Archivos afectados**:
47 | - `src/pages/ProfileConfigPage.tsx:127-138` (handleSubmit)
48 | - `src/store/user/userStore.ts:218-253` (checkAuth)
49 | - `src/pages/PlansPage.tsx:447-454` (continue button)
50 | 
51 | ## Plan de Implementación
52 | 
53 | ### 📋 Fase 1: Solución de Base de Datos - Opción B (15 min)
54 | 
55 | **Objetivo**: Usar funciones existentes y agregar triggers faltantes
56 | 
57 | #### Checklist:
58 | - [x] Actualizar función existente `handle_new_user()`
59 | - [x] Crear trigger faltante para nuevos usuarios
60 | - [x] Crear triggers para `updated_at` automático
61 | - [ ] Ejecutar migración para usuarios existentes sin perfil (obviar, he borrado todos los perfiles)
62 | 
63 | #### Código SQL para ejecutar en Supabase SQL Editor:
64 | 
65 | 1. **Actualizar función existente**:
66 |    ```sql
67 |    -- Modificar función existente para incluir has_completed_setup
68 |    CREATE OR REPLACE FUNCTION public.handle_new_user()
69 |    RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER AS $$
70 |    BEGIN
71 |      INSERT INTO public.profiles (id, language, has_completed_setup)
72 |      VALUES (new.id, 'en', false);
73 |      RETURN new;
74 |    END;
75 |    $$;
76 |    ```
77 | 
78 | 2. **Crear trigger para nuevos usuarios**:
79 |    ```sql
80 |    -- Crear trigger para auto-generar perfiles
81 |    CREATE TRIGGER trigger_create_profile_on_signup
82 |        AFTER INSERT ON auth.users
83 |        FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
84 |    ```
85 | 
86 | 3. **Crear triggers para updated_at**:
87 |    ```sql
88 |    -- Agregar triggers para actualizar timestamps automáticamente
89 |    CREATE TRIGGER trigger_profiles_updated_at
90 |        BEFORE UPDATE ON public.profiles
91 |        FOR EACH ROW EXECUTE FUNCTION public.update_modified_column();
92 | 
93 |    CREATE TRIGGER trigger_characters_updated_at
94 |        BEFORE UPDATE ON public.characters
95 |        FOR EACH ROW EXECUTE FUNCTION public.update_modified_column();
96 | 
97 |    CREATE TRIGGER trigger_stories_updated_at
98 |        BEFORE UPDATE ON public.stories
99 |        FOR EACH ROW EXECUTE FUNCTION public.update_modified_column();
100 | 
101 |    CREATE TRIGGER trigger_story_chapters_updated_at
102 |        BEFORE UPDATE ON public.story_chapters
103 |        FOR EACH ROW EXECUTE FUNCTION public.update_modified_column();
104 | 
105 |    CREATE TRIGGER trigger_user_voices_updated_at
106 |        BEFORE UPDATE ON public.user_voices
107 |        FOR EACH ROW EXECUTE FUNCTION public.update_modified_column();
108 |    ```
109 | 
110 | 4. **Migración para usuarios existentes**:
111 |    ```sql
112 |    -- Crear perfiles para usuarios existentes que no los tengan
113 |    INSERT INTO public.profiles (id, language, has_completed_setup, created_at, updated_at)
114 |    SELECT id, 'en', false, now(), now() 
115 |    FROM auth.users 
116 |    WHERE id NOT IN (SELECT id FROM public.profiles);
117 |    ```
118 | 
119 | ### 📋 Fase 2: Mejorar ProfileConfigPage (45 min)
120 | 
121 | **Objetivo**: Hacer el guardado de perfil más robusto
122 | 
123 | #### Checklist:
124 | - [x] Cambiar `update` por `upsert` en ProfileConfigPage
125 | - [x] Mejorar manejo de errores
126 | - [x] Agregar validación de estado antes de navegación
127 | 
128 | #### Tareas específicas:
129 | 
130 | 1. **Modificar ProfileConfigPage.tsx líneas 114-125**:
131 |    ```typescript
132 |    // Cambiar de .update() a .upsert()
133 |    const { error: updateError } = await supabase
134 |        .from('profiles')
135 |        .upsert({
136 |            id: currentUser.id,
137 |            language: language,
138 |            preferences: preferences.trim() || null,
139 |            has_completed_setup: true
140 |        }, {
141 |            onConflict: 'id'
142 |        });
143 |    ```
144 | 
145 | 2. **Agregar verificación post-guardado**:
146 |    ```typescript
147 |    // Después del upsert, verificar que se guardó correctamente
148 |    const { data: savedProfile } = await supabase
149 |        .from('profiles')
150 |        .select('has_completed_setup')
151 |        .eq('id', currentUser.id)
152 |        .single();
153 | 
154 |    if (!savedProfile?.has_completed_setup) {
155 |        throw new Error('Profile was not saved correctly');
156 |    }
157 |    ```
158 | 
159 | ### 📋 Fase 3: Optimizar UserStore (45 min)
160 | 
161 | **Objetivo**: Eliminar consultas redundantes y condiciones de carrera
162 | 
163 | #### Checklist:
164 | - [x] Reducir llamadas a `getUserProfile()`
165 | - [x] Mejorar función `checkAuth()`
166 | - [x] Agregar mejor cache de estado
167 | 
168 | #### Tareas específicas:
169 | 
170 | 1. **Simplificar userStore.ts función loginUser (líneas 28-61)**:
171 |    ```typescript
172 |    loginUser: async (user: User): Promise<void> => {
173 |        setCurrentAuthUser(user.id);
174 |        set({ user, intendedRedirectPath: null });
175 | 
176 |        try {
177 |            // Una sola consulta para cargar perfil
178 |            const { success, profile } = await getUserProfile(user.id);
179 |            
180 |            if (success && profile) {
181 |                set({ profileSettings: profile });
182 |                const redirectPath = profile.has_completed_setup ? '/home' : '/profile-config';
183 |                set({ intendedRedirectPath: redirectPath });
184 |            } else {
185 |                // Si no hay perfil, debe ir a configuración
186 |                set({ intendedRedirectPath: '/profile-config' });
187 |            }
188 | 
189 |            // Cargar otros datos en segundo plano (no bloqueante)
190 |            syncAllUserData(user.id);
191 |        } catch (error) {
192 |            console.error("Error cargando datos de usuario:", error);
193 |            set({ intendedRedirectPath: '/profile-config' });
194 |        }
195 |    }
196 |    ```
197 | 
198 | 2. **Optimizar checkAuth() (líneas 218-253)**:
199 |    ```typescript
200 |    checkAuth: async (): Promise<User | null> => {
201 |        try {
202 |            const { user, error } = await getCurrentUser();
203 | 
204 |            if (user && !error) {
205 |                set({ user });
206 |                
207 |                // Solo cargar perfil si no está en cache
208 |                const currentProfile = get().profileSettings;
209 |                if (!currentProfile || currentProfile.id !== user.id) {
210 |                    const { success, profile } = await getUserProfile(user.id);
211 |                    if (success && profile) {
212 |                        set({ profileSettings: profile });
213 |                    }
214 |                }
215 |                
216 |                return user;
217 |            } else {
218 |                set({ user: null, profileSettings: null });
219 |                return null;
220 |            }
221 |        } catch (e) {
222 |            console.error("Error en checkAuth:", e);
223 |            set({ user: null, profileSettings: null });
224 |            return null;
225 |        }
226 |    }
227 |    ```
228 | 
229 | ### 📋 Fase 4: Mejorar Manejo de Errores (30 min)
230 | 
231 | **Objetivo**: Mejor experiencia cuando hay problemas de red/base de datos
232 | 
233 | #### Checklist:
234 | - [x] Agregar mejores mensajes de error
235 | - [x] Implementar retry logic básico
236 | - [x] Mejorar UX de estados de carga
237 | 
238 | #### Tareas específicas:
239 | 
240 | 1. **Mejorar getUserProfile en supabase.ts**:
241 |    ```typescript
242 |    export const getUserProfile = async (userId: string, retries = 2): Promise<{ success: boolean, profile?: ProfileSettings, error?: any }> => {
243 |        for (let attempt = 0; attempt <= retries; attempt++) {
244 |            try {
245 |                console.log(`Requesting profile for user: ${userId} (attempt ${attempt + 1}/${retries + 1})`);
246 |                
247 |                const { data, error } = await supabase
248 |                    .from("profiles")
249 |                    .select("*")
250 |                    .eq("id", userId)
251 |                    .single();
252 | 
253 |                if (error && error.code === 'PGRST116') {
254 |                    console.log(`Profile not found for user ${userId}. This is a definitive result, no retry.`);
255 |                    return { success: false };
256 |                } else if (error) {
257 |                    console.warn(`Attempt ${attempt + 1} to fetch profile for ${userId} failed:`, error.message);
258 |                    if (attempt === retries) {
259 |                        console.error(`Final attempt to fetch profile for ${userId} failed after multiple retries.`, error);
260 |                        throw error;
261 |                    }
262 |                    await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
263 |                    continue;
264 |                }
265 | 
266 |                if (data) {
267 |                    const profile: ProfileSettings = {
268 |                        language: data.language,
269 |                        preferences: data.preferences,
270 |                        // ... resto de campos
271 |                        has_completed_setup: data.has_completed_setup,
272 |                    };
273 |                    return { success: true, profile: profile };
274 |                }
275 |            } catch (error) {
276 |                if (attempt === retries) {
277 |                    console.error(`A critical error occurred while fetching profile for ${userId}. All retries failed.`, error);
278 |                    return { success: false, error };
279 |                }
280 |            }
281 |        }
282 |        return { success: false };
283 |    };
284 |    ```
285 | 
286 | ### 📋 Fase 5: Testing y Validación (30 min)
287 | 
288 | **Objetivo**: Verificar que ambos errores están resueltos
289 | 
290 | #### Checklist de Testing:
291 | 
292 | **Test 1: Nuevo usuario**
293 | - [ ] Crear nuevo usuario
294 | - [ ] Verificar que se crea perfil automáticamente
295 | - [ ] Login exitoso → redirección a `/profile-config`
296 | - [ ] Completar perfil → redirección a `/plans`
297 | - [ ] Continuar con plan gratuito → redirección a `/home`
298 | 
299 | **Test 2: Usuario existente sin perfil**
300 | - [ ] Usuario existente hace login
301 | - [ ] Se crea perfil automáticamente si no existe
302 | - [ ] Flujo normal de configuración funciona
303 | 
304 | **Test 3: Usuario con perfil completo**
305 | - [ ] Login exitoso → redirección directa a `/home`
306 | - [ ] No pasa por configuración de perfil
307 | 
308 | **Test 4: Casos de error**
309 | - [ ] Error de red durante guardado de perfil
310 | - [ ] Retry logic funciona correctamente
311 | - [ ] Mensajes de error son claros para el usuario
312 | 
313 | #### Validación en Logs:
314 | - [ ] No más errores 406 (Not Acceptable)
315 | - [ ] No más errores PGRST116
316 | - [ ] No más consultas redundantes a profiles
317 | - [ ] Redirecciones funcionan correctamente
318 | 
319 | ## Archivos a Modificar
320 | 
321 | ### Base de Datos:
322 | - `docs/sql_supabase.sql` - Agregar trigger y migration
323 | 
324 | ### Frontend:
325 | - `src/pages/ProfileConfigPage.tsx` - Cambiar update por upsert
326 | - `src/store/user/userStore.ts` - Optimizar checkAuth y loginUser  
327 | - `src/services/supabase.ts` - Mejorar getUserProfile con retry
328 | 
329 | ## Consideraciones Importantes
330 | 
331 | 1. **Backup**: Hacer backup de la base de datos antes de ejecutar migrations
332 | 2. **RLS**: Verificar que los triggers no rompen Row Level Security
333 | 3. **Performance**: Las consultas optimizadas deben mejorar el rendimiento
334 | 4. **UX**: Los usuarios no deben notar cambios negativos en la experiencia
335 | 
336 | ## Criterios de Éxito
337 | 
338 | ✅ **Error 1 resuelto**: Usuario nunca ve página "Not Found" tras login  
339 | ✅ **Error 2 resuelto**: No hay bucle entre configuración y planes  
340 | ✅ **Performance mejorado**: Menos consultas redundantes a base de datos  
341 | ✅ **UX mejorada**: Mejor manejo de errores y estados de carga  
342 | 
343 | ---
344 | 
345 | **Nota**: Este plan se basa en el análisis de los logs del navegador y la revisión del código actual. Cada fase debe completarse y probarse antes de pasar a la siguiente.
```

src/components/AudioPlayer.tsx
```
1 | import { useState, useEffect, useRef } from "react";
2 | import { Button } from "@/components/ui/button";
3 | import { Slider } from "@/components/ui/slider";
4 | import { Play, Pause, Volume2, VolumeX } from "lucide-react";
5 | import { generateSpeech, OPENAI_VOICES, OpenAIVoiceType } from "@/services/ai/ttsService";
6 | import { cn } from "@/lib/utils";
7 | import { toast } from "sonner";
8 | 
9 | // Función auxiliar para formatear el tiempo
10 | function formatTime(seconds: number): string {
11 |   const minutes = Math.floor(seconds / 60);
12 |   const remainingSeconds = Math.floor(seconds % 60);
13 |   return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
14 | }
15 | 
16 | interface Voice {
17 |   id: string;
18 |   name: string;
19 |   description: string;
20 | }
21 | 
22 | const ELEVENLABS_MODELS = [
23 |   { id: 'eleven_multilingual_v2', name: 'Multilingüe V2', description: 'Mejor para español y otros idiomas' },
24 |   { id: 'eleven_monolingual_v1', name: 'Monolingüe V1', description: 'Mejor para inglés' },
25 |   { id: 'eleven_turbo_v2', name: 'Turbo V2', description: 'Más rápido, buena calidad' }
26 | ];
27 | 
28 | interface AudioPlayerProps {
29 |   text: string;
30 |   className?: string;
31 |   onComplete?: () => void;
32 | }
33 | 
34 | export default function AudioPlayer({ text, className, onComplete }: AudioPlayerProps) {
35 |   const [isPlaying, setIsPlaying] = useState(false);
36 |   const [isLoading, setIsLoading] = useState(false);
37 |   const [volume, setVolume] = useState(1);
38 |   const [isMuted, setIsMuted] = useState(false);
39 |   const [currentTime, setCurrentTime] = useState(0);
40 |   const [duration, setDuration] = useState(0);
41 |   const [audioUrl, setAudioUrl] = useState<string | null>(null);
42 |   const [selectedVoice, setSelectedVoice] = useState<Voice>(OPENAI_VOICES[0]);
43 |   const [selectedModel, setSelectedModel] = useState(ELEVENLABS_MODELS[0]);
44 |   const audioRef = useRef<HTMLAudioElement>(null);
45 |   const [isGenerating, setIsGenerating] = useState(false);
46 |   const [error, setError] = useState<string | null>(null);
47 | 
48 |   // Limpia los intervalos al desmontar
49 |   useEffect(() => {
50 |     return () => {
51 |       if (audioRef.current) {
52 |         audioRef.current.pause();
53 |         audioRef.current.src = '';
54 |       }
55 |       if (audioUrl) {
56 |         URL.revokeObjectURL(audioUrl);
57 |       }
58 |     };
59 |   }, [audioUrl]);
60 | 
61 |   // Maneja la actualización del tiempo
62 |   useEffect(() => {
63 |     let interval: NodeJS.Timeout;
64 |     if (isPlaying && audioRef.current) {
65 |       interval = setInterval(() => {
66 |         setCurrentTime(audioRef.current?.currentTime || 0);
67 |       }, 100);
68 |     }
69 |     return () => clearInterval(interval);
70 |   }, [isPlaying]);
71 | 
72 |   // Maneja la actualización de la duración
73 |   useEffect(() => {
74 |     if (audioRef.current) {
75 |       const handleLoadedMetadata = () => {
76 |         console.log('Audio metadata loaded, duration:', audioRef.current?.duration);
77 |         setDuration(audioRef.current?.duration || 0);
78 |       };
79 | 
80 |       audioRef.current.addEventListener('loadedmetadata', handleLoadedMetadata);
81 |       return () => {
82 |         audioRef.current?.removeEventListener('loadedmetadata', handleLoadedMetadata);
83 |       };
84 |     }
85 |   }, []);
86 | 
87 |   // Maneja la actualización de la URL del audio
88 |   useEffect(() => {
89 |     if (audioRef.current && audioUrl) {
90 |       console.log('Setting audio source:', audioUrl);
91 |       audioRef.current.src = audioUrl;
92 |       audioRef.current.load();
93 |     }
94 |   }, [audioUrl]);
95 | 
96 |   const handlePlayPause = async () => {
97 |     if (!audioUrl) {
98 |       setIsLoading(true);
99 |       try {
100 |         await handleGenerateAudio();
101 |       } catch (err) {
102 |         console.error('Error al generar audio:', err);
103 |         return;
104 |       } finally {
105 |         setIsLoading(false);
106 |       }
107 |     }
108 | 
109 |     if (audioRef.current) {
110 |       if (isPlaying) {
111 |         console.log('Pausing audio...');
112 |         audioRef.current.pause();
113 |         setIsPlaying(false);
114 |       } else {
115 |         console.log('Starting playback...');
116 |         const playPromise = audioRef.current.play();
117 |         if (playPromise !== undefined) {
118 |           playPromise
119 |             .then(() => {
120 |               console.log('Playback started successfully');
121 |               setIsPlaying(true);
122 |             })
123 |             .catch(error => {
124 |               console.error('Error starting playback:', error);
125 |               setIsPlaying(false);
126 |             });
127 |         }
128 |       }
129 |     }
130 |   };
131 | 
132 |   const handleGenerateAudio = async (): Promise<string> => {
133 |     try {
134 |       setIsGenerating(true);
135 |       setError(null);
136 |       
137 |       console.log('Generating audio with voice:', selectedVoice.id, 'and model:', selectedModel.id);
138 |       const audioBlob = await generateSpeech({
139 |         text,
140 |         voice: selectedVoice.id as OpenAIVoiceType,
141 |         model: selectedModel.id
142 |       });
143 |       
144 |       const audioObjectUrl = URL.createObjectURL(audioBlob);
145 |       console.log('Audio generated successfully, URL:', audioObjectUrl);
146 |       setAudioUrl(audioObjectUrl);
147 |       setIsGenerating(false);
148 |       return audioObjectUrl;
149 |     } catch (err) {
150 |       console.error('Error al generar audio:', err);
151 |       setError(err instanceof Error ? err.message : 'Error al generar el audio');
152 |       setIsGenerating(false);
153 |       throw err;
154 |     }
155 |   };
156 | 
157 |   const handleVoiceChange = (voiceId: string) => {
158 |     setSelectedVoice(OPENAI_VOICES.find(voice => voice.id === voiceId) || OPENAI_VOICES[0]);
159 |     setAudioUrl(null);
160 |   };
161 | 
162 |   const handleTimeUpdate = () => {
163 |     if (audioRef.current) {
164 |       setCurrentTime(audioRef.current.currentTime);
165 |     }
166 |   };
167 | 
168 |   const handleSeek = (value: number[]) => {
169 |     if (audioRef.current) {
170 |       audioRef.current.currentTime = value[0];
171 |       setCurrentTime(value[0]);
172 |     }
173 |   };
174 | 
175 |   const handleVolumeChange = (value: number[]) => {
176 |     if (audioRef.current) {
177 |       const newVolume = value[0];
178 |       audioRef.current.volume = newVolume;
179 |       setVolume(newVolume);
180 |       setIsMuted(newVolume === 0);
181 |     }
182 |   };
183 | 
184 |   const handleMuteToggle = () => {
185 |     if (audioRef.current) {
186 |       const newMutedState = !isMuted;
187 |       audioRef.current.volume = newMutedState ? 0 : volume;
188 |       setIsMuted(newMutedState);
189 |     }
190 |   };
191 | 
192 |   const handleEndedEvent = () => {
193 |     console.log('Audio ended event triggered');
194 |     setIsPlaying(false);
195 |     setCurrentTime(duration);
196 |     onComplete?.();
197 |   };
198 | 
199 |   const handlePauseEvent = () => {
200 |     console.log('Audio pause event triggered');
201 |     setIsPlaying(false);
202 |   };
203 | 
204 |   return (
205 |     <div className={cn("flex flex-col gap-4 p-4 bg-white rounded-lg shadow-md", className)}>
206 |       <div className="flex items-center gap-4">
207 |         <Button
208 |           onClick={handlePlayPause}
209 |           disabled={isLoading}
210 |           className="w-12 h-12 rounded-full"
211 |         >
212 |           {isLoading ? (
213 |             <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
214 |           ) : isPlaying ? (
215 |             <Pause className="w-6 h-6" />
216 |           ) : (
217 |             <Play className="w-6 h-6" />
218 |           )}
219 |         </Button>
220 | 
221 |         <div className="flex-1">
222 |           <div className="flex items-center gap-2">
223 |             <span className="text-sm text-gray-500">
224 |               {formatTime(currentTime)} / {formatTime(duration)}
225 |             </span>
226 |             <Slider
227 |               value={[currentTime]}
228 |               max={duration}
229 |               step={1}
230 |               onValueChange={handleSeek}
231 |               className="flex-1"
232 |             />
233 |           </div>
234 |         </div>
235 | 
236 |         <Button
237 |           variant="ghost"
238 |           size="icon"
239 |           onClick={handleMuteToggle}
240 |           className="w-10 h-10"
241 |         >
242 |           {isMuted ? (
243 |             <VolumeX className="w-5 h-5" />
244 |           ) : (
245 |             <Volume2 className="w-5 h-5" />
246 |           )}
247 |         </Button>
248 |       </div>
249 | 
250 |       <div className="flex items-center gap-4">
251 |         <select
252 |           value={selectedVoice.id}
253 |           onChange={(e) => handleVoiceChange(e.target.value)}
254 |           className="px-3 py-2 border rounded-md"
255 |         >
256 |           {OPENAI_VOICES.map((voice) => (
257 |             <option key={voice.id} value={voice.id}>
258 |               {voice.name}
259 |             </option>
260 |           ))}
261 |         </select>
262 | 
263 |         <select
264 |           value={selectedModel.id}
265 |           onChange={(e) => {
266 |             setSelectedModel(ELEVENLABS_MODELS.find(model => model.id === e.target.value) || ELEVENLABS_MODELS[0]);
267 |             setAudioUrl(null);
268 |           }}
269 |           className="px-3 py-2 border rounded-md"
270 |         >
271 |           {ELEVENLABS_MODELS.map((model) => (
272 |             <option key={model.id} value={model.id}>
273 |               {model.name}
274 |             </option>
275 |           ))}
276 |         </select>
277 |       </div>
278 | 
279 |       <audio
280 |         ref={audioRef}
281 |         onTimeUpdate={handleTimeUpdate}
282 |         onEnded={handleEndedEvent}
283 |         onPause={handlePauseEvent}
284 |         className="hidden"
285 |       />
286 |     </div>
287 |   );
288 | }
```

src/components/AuthGuard.tsx
```
1 | import { useEffect, useState } from "react";
2 | import { Navigate, useLocation, useNavigate } from "react-router-dom";
3 | import { useUserStore } from "../store/user/userStore";
4 | import { User } from "../types";
5 | 
6 | interface AuthGuardProps {
7 |   children: React.ReactNode;
8 | }
9 | 
10 | type AuthStatus = 'pending' | 'authenticated' | 'unauthenticated';
11 | 
12 | export default function AuthGuard({ children }: AuthGuardProps) {
13 |   const { checkAuth, intendedRedirectPath } = useUserStore(state => ({
14 |     checkAuth: state.checkAuth,
15 |     intendedRedirectPath: state.intendedRedirectPath,
16 |   }));
17 |   const set = useUserStore.setState;
18 | 
19 |   const [authStatus, setAuthStatus] = useState<AuthStatus>('pending');
20 |   const [checkedUser, setCheckedUser] = useState<User | null>(null);
21 | 
22 |   const location = useLocation();
23 |   const navigate = useNavigate();
24 | 
25 |   useEffect(() => {
26 |     let isMounted = true;
27 |     const verifyAuth = async () => {
28 |       console.log("AuthGuard: Verifying authentication...");
29 |       const userResult = await checkAuth();
30 |       console.log("AuthGuard: Authentication check completed. User:", userResult ? userResult.id : 'null');
31 |       if (isMounted) {
32 |         setCheckedUser(userResult);
33 |         setAuthStatus(userResult ? 'authenticated' : 'unauthenticated');
34 |       }
35 |     };
36 | 
37 |     verifyAuth();
38 | 
39 |     return () => { isMounted = false; };
40 |   }, [checkAuth]);
41 | 
42 |   useEffect(() => {
43 |     if (authStatus === 'pending') {
44 |       console.log("AuthGuard Redirect Effect: Waiting for auth check to complete...");
45 |       return;
46 |     }
47 | 
48 |     console.log(`AuthGuard Redirect Effect: Evaluating state - Status: ${authStatus}, Intended: ${intendedRedirectPath}, Current: ${location.pathname}`);
49 | 
50 |     if (intendedRedirectPath && intendedRedirectPath !== location.pathname) {
51 |       console.log(`AuthGuard Redirect Effect: Redirecting from ${location.pathname} to intended path: ${intendedRedirectPath}`);
52 |       set({ intendedRedirectPath: null });
53 |       navigate(intendedRedirectPath, { replace: true });
54 |     }
55 |     else if (intendedRedirectPath && intendedRedirectPath === location.pathname) {
56 |       console.log(`AuthGuard Redirect Effect: Already at intended path ${intendedRedirectPath}. Resetting flag.`);
57 |       set({ intendedRedirectPath: null });
58 |     }
59 |   }, [authStatus, intendedRedirectPath, location.pathname, navigate, set]);
60 | 
61 |   if (authStatus === 'pending') {
62 |     console.log(`AuthGuard Render: Auth check in progress. Showing loader.`);
63 |     return (
64 |       <div className="gradient-bg min-h-screen flex items-center justify-center">
65 |         <div className="animate-spin h-10 w-10 border-4 border-white rounded-full border-t-transparent"></div>
66 |       </div>
67 |     );
68 |   }
69 | 
70 |   if (intendedRedirectPath && intendedRedirectPath !== location.pathname) {
71 |     console.log(`AuthGuard Render: Redirect pending to ${intendedRedirectPath}. Waiting for navigation.`);
72 |     return (
73 |       <div className="gradient-bg min-h-screen flex items-center justify-center">
74 |         <div className="animate-spin h-10 w-10 border-4 border-white rounded-full border-t-transparent"></div>
75 |       </div>
76 |     );
77 |   }
78 | 
79 |   if (authStatus === 'authenticated' && checkedUser) {
80 |     console.log(`AuthGuard Render: Auth checked, user ${checkedUser.id} exists. Rendering children for ${location.pathname}.`);
81 |     return <>{children}</>;
82 |   }
83 | 
84 |   if (authStatus === 'unauthenticated') {
85 |     console.log(`AuthGuard Render: Auth checked, user not authenticated. Redirecting to /login.`);
86 |     return <Navigate to="/login" state={{ from: location }} replace />;
87 |   }
88 | 
89 |   console.warn(`AuthGuard Render: Reached unexpected state (Status: ${authStatus}, CheckedUser: ${!!checkedUser}, Intended: ${intendedRedirectPath}). Rendering null or redirecting to error.`);
90 |   return <Navigate to="/error" replace />;
91 | }
```

src/components/BackButton.tsx
```
1 | import { ChevronLeft } from "lucide-react";
2 | import { useNavigate } from "react-router-dom";
3 | 
4 | interface BackButtonProps {
5 |   onClick?: () => void;
6 |   className?: string;
7 | }
8 | 
9 | export default function BackButton({ onClick, className = "" }: BackButtonProps) {
10 |   const navigate = useNavigate();
11 |   
12 |   const handleClick = () => {
13 |     if (onClick) {
14 |       onClick();
15 |     } else {
16 |       navigate(-1);
17 |     }
18 |   };
19 |   
20 |   return (
21 |     <button 
22 |       onClick={handleClick}
23 |       className={`absolute top-6 left-6 w-12 h-12 flex items-center justify-center rounded-full bg-white shadow-lg border-2 border-[#BB79D1]/60 text-[#BB79D1] hover:bg-[#BB79D1]/10 hover:text-[#7DC4E0] focus:ring-4 focus:ring-[#BB79D1]/30 transition-all duration-300 z-20 ${className}`}
24 |       aria-label="Volver atrás"
25 |     >
26 |       <ChevronLeft size={28} />
27 |     </button>
28 |   );
29 | }
```

src/components/Footer.tsx
```
1 | import { Link } from "react-router-dom";
2 | import { APP_CONFIG } from "../config/app";
3 | 
4 | export default function Footer() {
5 |   return (
6 |     <footer className="w-full bg-white/80 py-3 md:py-4 backdrop-blur-sm mt-auto">
7 |       <div className="max-w-6xl mx-auto px-4 sm:px-6 md:px-8 flex flex-col md:flex-row justify-between items-center">
8 |         <div className="mb-2 md:mb-0">
9 |           <img src="/logo_fantasia.png" alt="Fantasia Logo" className="h-12 md:h-14" />
10 |         </div>
11 | 
12 |         <div className="text-[#555] text-xs text-center md:text-left mb-2 md:mb-0">
13 |           <div>
14 |             &copy; {new Date().getFullYear()} Fantasia. All rights reserved.
15 |           </div>
16 |           <div className="text-[#777] text-xs mt-1 text-center">
17 |             v{APP_CONFIG.version}
18 |           </div>
19 |         </div>
20 | 
21 |         <div className="mt-2 md:mt-0 flex gap-4">
22 |           <Link to={APP_CONFIG.footerLinks.terms} className="text-[#BB79D1] hover:text-[#A5D6F6] transition-colors text-sm">Términos</Link>
23 |           <Link to={APP_CONFIG.footerLinks.privacy} className="text-[#BB79D1] hover:text-[#A5D6F6] transition-colors text-sm">Privacidad</Link>
24 |           <Link to={APP_CONFIG.footerLinks.contact} className="text-[#BB79D1] hover:text-[#A5D6F6] transition-colors text-sm">Contacto</Link>
25 |           <Link to={APP_CONFIG.footerLinks.changelog} className="text-[#BB79D1] hover:text-[#A5D6F6] transition-colors text-sm">Changelog</Link>
26 |         </div>
27 |       </div>
28 |     </footer>
29 |   );
30 | } 
```

src/components/IconLoadingAnimation.tsx
```
1 | import { motion } from "framer-motion";
2 | 
3 | interface IconLoadingAnimationProps {
4 |   message?: string;
5 | }
6 | 
7 | export default function IconLoadingAnimation({ message = "Loading..." }: IconLoadingAnimationProps) {
8 |   // Variantes para la animación del icono principal
9 |   const iconVariants = {
10 |     rotate: {
11 |       rotate: [0, 10, 0, -10, 0],
12 |       y: [0, -10, 0, -5, 0],
13 |       transition: {
14 |         duration: 5,
15 |         repeat: Infinity,
16 |         ease: "easeInOut",
17 |       }
18 |     }
19 |   };
20 | 
21 |   // Variantes para las estrellas/partículas
22 |   const particleVariants = {
23 |     animate: (i: number) => ({
24 |       opacity: [0, 0.8, 0],
25 |       scale: [0.4, 1, 0.4],
26 |       y: [0, -40, 0],
27 |       x: [0, i * 15, 0],
28 |       rotate: [0, i * 30, 0],
29 |       transition: {
30 |         duration: 3,
31 |         repeat: Infinity,
32 |         delay: i * 0.2,
33 |         ease: "easeInOut",
34 |       }
35 |     })
36 |   };
37 | 
38 |   // Variantes para el brillo
39 |   const glowVariants = {
40 |     animate: {
41 |       opacity: [0.4, 0.8, 0.4],
42 |       scale: [0.9, 1.1, 0.9],
43 |       transition: {
44 |         duration: 3,
45 |         repeat: Infinity,
46 |         ease: "easeInOut",
47 |       }
48 |     }
49 |   };
50 | 
51 |   // Variantes para el texto
52 |   const textVariants = {
53 |     animate: {
54 |       opacity: [0.7, 1, 0.7],
55 |       transition: {
56 |         duration: 2,
57 |         repeat: Infinity,
58 |         ease: "easeInOut",
59 |       }
60 |     }
61 |   };
62 | 
63 |   // Crear un array para las partículas
64 |   const particles = Array.from({ length: 5 }, (_, i) => i - 2);
65 | 
66 |   return (
67 |     <div className="flex flex-col items-center justify-center space-y-8">
68 |       <div className="relative">
69 |         {/* Círculo de brillo detrás del icono */}
70 |         <motion.div
71 |           className="absolute inset-0 rounded-full bg-gradient-to-r from-[#F6A5B7]/40 to-[#BB79D1]/40 blur-md"
72 |           variants={glowVariants}
73 |           animate="animate"
74 |         />
75 |         
76 |         {/* Partículas/estrellas alrededor del icono */}
77 |         {particles.map((i) => (
78 |           <motion.div
79 |             key={i}
80 |             className="absolute top-1/2 left-1/2 w-4 h-4"
81 |             custom={i}
82 |             variants={particleVariants}
83 |             animate="animate"
84 |           >
85 |             <div className="w-full h-full bg-[#F9DA60] rounded-full" />
86 |           </motion.div>
87 |         ))}
88 |         
89 |         {/* Icono principal */}
90 |         <motion.div
91 |           className="relative z-10 w-32 h-32 flex items-center justify-center"
92 |           variants={iconVariants}
93 |           animate="rotate"
94 |         >
95 |           <img 
96 |             src="/logo_fantasia.png" 
97 |             alt="Cuenta Cuentos" 
98 |             className="w-full h-full object-contain drop-shadow-lg" 
99 |           />
100 |         </motion.div>
101 |       </div>
102 |       
103 |       {/* Mensaje de carga */}
104 |       <motion.p
105 |         className="text-xl font-medium text-[#222] bg-white/80 px-6 py-2 rounded-xl shadow-md font-heading"
106 |         variants={textVariants}
107 |         animate="animate"
108 |       >
109 |         {message}
110 |       </motion.p>
111 |     </div>
112 |   );
113 | }
```

src/components/LoadingAnimation.tsx
```
1 | 
2 | import { motion } from "framer-motion";
3 | 
4 | interface LoadingAnimationProps {
5 |   message?: string;
6 | }
7 | 
8 | export default function LoadingAnimation({ message = "Loading..." }: LoadingAnimationProps) {
9 |   return (
10 |     <div className="flex flex-col items-center justify-center space-y-6">
11 |       <motion.div
12 |         className="w-24 h-24 rounded-full bg-story-orange-400 flex items-center justify-center"
13 |         animate={{
14 |           scale: [1, 1.1, 1],
15 |           opacity: [0.7, 1, 0.7],
16 |         }}
17 |         transition={{
18 |           duration: 2,
19 |           repeat: Infinity,
20 |           ease: "easeInOut",
21 |         }}
22 |       >
23 |         <motion.div
24 |           className="w-16 h-16 rounded-full bg-story-purple-500 flex items-center justify-center"
25 |           animate={{
26 |             scale: [1, 1.15, 1],
27 |             opacity: [0.7, 1, 0.7],
28 |           }}
29 |           transition={{
30 |             duration: 2,
31 |             repeat: Infinity,
32 |             ease: "easeInOut",
33 |             delay: 0.2,
34 |           }}
35 |         >
36 |           <motion.div
37 |             className="w-8 h-8 rounded-full bg-story-blue-400"
38 |             animate={{
39 |               scale: [1, 1.2, 1],
40 |               opacity: [0.7, 1, 0.7],
41 |             }}
42 |             transition={{
43 |               duration: 2,
44 |               repeat: Infinity,
45 |               ease: "easeInOut",
46 |               delay: 0.4,
47 |             }}
48 |           />
49 |         </motion.div>
50 |       </motion.div>
51 |       
52 |       <motion.p
53 |         className="text-xl font-medium text-white"
54 |         animate={{
55 |           opacity: [0.7, 1, 0.7],
56 |         }}
57 |         transition={{
58 |           duration: 2,
59 |           repeat: Infinity,
60 |           ease: "easeInOut",
61 |         }}
62 |       >
63 |         {message}
64 |       </motion.p>
65 |     </div>
66 |   );
67 | }
```

src/components/MainLayout.tsx
```
1 | import { ReactNode } from "react";
2 | import Footer from "./Footer";
3 | 
4 | interface MainLayoutProps {
5 |   children: ReactNode;
6 |   hideFooter?: boolean;
7 | }
8 | 
9 | export default function MainLayout({ children, hideFooter = false }: MainLayoutProps) {
10 |   return (
11 |     <div className="flex flex-col min-h-screen">
12 |       <main className="flex-grow">
13 |         {children}
14 |       </main>
15 |       
16 |       {!hideFooter && <Footer />}
17 |     </div>
18 |   );
19 | } 
```

src/components/ManageSubscriptionButton.tsx
```
1 | import { useState } from 'react';
2 | import { Settings } from 'lucide-react';
3 | import { Button } from '@/components/ui/button.tsx'; 
4 | import { useToast } from '@/hooks/use-toast.ts'; 
5 | import { createCustomerPortalSession } from '../services/stripeService.ts'; 
6 | 
7 | interface ManageSubscriptionButtonProps {
8 |   className?: string;
9 | }
10 | 
11 | export default function ManageSubscriptionButton({ className = '' }: ManageSubscriptionButtonProps) {
12 |   const [isLoading, setIsLoading] = useState(false);
13 |   const { toast } = useToast();
14 | 
15 |   const handleManageSubscription = async () => {
16 |     setIsLoading(true);
17 | 
18 |     try {
19 |       // Llamada a la función del servicio (que llama a la Edge Function)
20 |       const { url, error } = await createCustomerPortalSession();
21 | 
22 |       if (error) {
23 |         // Manejo de errores específicos devueltos por el servicio
24 |         console.error("Error from createCustomerPortalSession:", error);
25 |         // Podrías querer ser más específico aquí si el servicio devuelve códigos o mensajes clave
26 |         if (error.includes('No se encontró información de cliente') || error.includes('404')) { // Ejemplo de verificación
27 |           toast({
28 |             title: "No hay suscripción activa",
29 |             description: "Necesitas tener una suscripción activa o haber realizado una compra previamente.",
30 |             variant: "destructive"
31 |           });
32 |         } else {
33 |           toast({
34 |             title: "Error al acceder al portal",
35 |             description: error, // Muestra el error devuelto por el servicio/función
36 |             variant: "destructive"
37 |           });
38 |         }
39 |       } else if (url) {
40 |         // Redirigir al Stripe Customer Portal
41 |         console.log(`Redirigiendo al Portal de Cliente de Stripe: ${url}`);
42 |         window.location.href = url;
43 |       } else {
44 |         // Caso inesperado: sin error pero sin URL
45 |         console.error("No URL received from createCustomerPortalSession");
46 |         toast({
47 |           title: "Error",
48 |           description: "No se recibió una URL válida del portal.",
49 |           variant: "destructive"
50 |         });
51 |       }
52 |     } catch (err) { // err es 'unknown'
53 |       // Manejo de errores inesperados (ej. red, error no capturado antes)
54 |       console.error("Unexpected error in handleManageSubscription:", err);
55 |       const errorMessage = "Ocurrió un error inesperado al procesar la solicitud.";
56 |       // Opcional: intentar obtener un mensaje más específico
57 |       // if (err instanceof Error) { errorMessage = err.message; }
58 |       // else if (typeof err === 'string') { errorMessage = err; }
59 |       toast({
60 |         title: "Error inesperado",
61 |         description: errorMessage,
62 |         variant: "destructive"
63 |       });
64 |     } finally {
65 |       setIsLoading(false);
66 |     }
67 |   };
68 | 
69 |   return (
70 |     <Button
71 |       onClick={handleManageSubscription}
72 |       disabled={isLoading}
73 |       className={`bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center justify-center ${className}`}
74 |     >
75 |       <Settings className="mr-2 h-5 w-5" />
76 |       {isLoading ? 'Procesando...' : 'Gestionar Suscripción'}
77 |     </Button>
78 |   );
79 | }
```

src/components/PageTransition.tsx
```
1 | 
2 | import { motion } from "framer-motion";
3 | import { ReactNode } from "react";
4 | 
5 | interface PageTransitionProps {
6 |   children: ReactNode;
7 |   className?: string;
8 | }
9 | 
10 | export default function PageTransition({ children, className = "" }: PageTransitionProps) {
11 |   return (
12 |     <motion.div
13 |       initial={{ opacity: 0, y: 20 }}
14 |       animate={{ opacity: 1, y: 0 }}
15 |       exit={{ opacity: 0, y: -20 }}
16 |       transition={{ duration: 0.5, ease: "easeInOut" }}
17 |       className={`w-full min-h-screen ${className}`}
18 |     >
19 |       {children}
20 |     </motion.div>
21 |   );
22 | }
```

src/components/PaymentButtons.tsx
```
1 | import { useState } from 'react';
2 | import { createCheckoutSession } from '../services/stripeService';
3 | import { useToast } from '@/hooks/use-toast';
4 | import { CreditCard, Sparkles } from 'lucide-react';
5 | import { Button } from '@/components/ui/button';
6 | 
7 | interface PaymentButtonsProps {
8 |   className?: string;
9 |   showBoth?: boolean; // Si es false, solo muestra el botón de premium
10 | }
11 | 
12 | export default function PaymentButtons({ className = '', showBoth = true }: PaymentButtonsProps) {
13 |   const [isLoading, setIsLoading] = useState<'premium' | 'credits' | null>(null);
14 |   const { toast } = useToast();
15 | 
16 |   const handlePurchase = async (item: 'premium' | 'credits') => {
17 |     setIsLoading(item);
18 |     
19 |     try {
20 |       const { url, error } = await createCheckoutSession(item);
21 |       
22 |       if (error) {
23 |         toast({
24 |           title: "Error al iniciar el pago",
25 |           description: error,
26 |           variant: "destructive"
27 |         });
28 |       } else if (url) {
29 |         // Redirigir a Stripe Checkout
30 |         console.log(`Redirigiendo a Stripe Checkout: ${url}`);
31 |         window.location.href = url;
32 |       } else {
33 |         toast({
34 |           title: "Error",
35 |           description: "No se recibió una URL de pago válida.",
36 |           variant: "destructive"
37 |         });
38 |       }
39 |     } catch (err) {
40 |       toast({
41 |         title: "Error inesperado",
42 |         description: "Ocurrió un error al procesar la solicitud de pago.",
43 |         variant: "destructive"
44 |       });
45 |       console.error(err);
46 |     } finally {
47 |       setIsLoading(null);
48 |     }
49 |   };
50 | 
51 |   return (
52 |     <div className={`flex ${showBoth ? 'flex-col sm:flex-row' : 'flex-col'} gap-3 ${className}`}>
53 |       <Button 
54 |         onClick={() => handlePurchase('premium')}
55 |         disabled={isLoading !== null}
56 |         className="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center justify-center"
57 |       >
58 |         <Sparkles className="mr-2 h-5 w-5" />
59 |         {isLoading === 'premium' ? 'Procesando...' : 'Suscripción Premium'}
60 |       </Button>
61 |       
62 |       {showBoth && (
63 |         <Button 
64 |           onClick={() => handlePurchase('credits')}
65 |           disabled={isLoading !== null}
66 |           className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center justify-center"
67 |         >
68 |           <CreditCard className="mr-2 h-5 w-5" />
69 |           {isLoading === 'credits' ? 'Procesando...' : 'Comprar Créditos de Voz'}
70 |         </Button>
71 |       )}
72 |     </div>
73 |   );
74 | }
```

src/components/PreviewVoiceModal.tsx
```
1 | import { Dispatch, SetStateAction, useEffect, useRef, useState } from "react";
2 | import { motion, AnimatePresence } from "framer-motion";
3 | import { X, Play, Pause } from "lucide-react";
4 | import { Slider } from "@/components/ui/slider";
5 | import { Button } from "@/components/ui/button";
6 | 
7 | interface Voice {
8 |   id: string;
9 |   name: string;
10 |   icon: React.ReactNode;
11 |   color: string;
12 |   description?: string;
13 | }
14 | 
15 | interface PreviewVoiceModalProps {
16 |   voice: Voice;
17 |   url: string;
18 |   open: boolean;
19 |   onClose: () => void;
20 | }
21 | 
22 | export function PreviewVoiceModal({
23 |   voice,
24 |   url,
25 |   open,
26 |   onClose,
27 | }: PreviewVoiceModalProps) {
28 |   const audioRef = useRef<HTMLAudioElement>(new Audio(url));
29 |   const [isPlaying, setIsPlaying] = useState(false);
30 |   const [volume, setVolume] = useState(0.8);
31 | 
32 |   // actualizar src cuando cambie la URL
33 |   useEffect(() => {
34 |     if (audioRef.current.src !== url) {
35 |       audioRef.current.pause();
36 |       audioRef.current = new Audio(url);
37 |       audioRef.current.volume = volume;
38 |       setIsPlaying(false);
39 |     }
40 |   }, [url]);
41 | 
42 |   // limpiar al desmontar
43 |   useEffect(() => {
44 |     return () => {
45 |       audioRef.current.pause();
46 |       audioRef.current.src = "";
47 |     };
48 |   }, []);
49 | 
50 |   // sincronizar volumen
51 |   useEffect(() => {
52 |     audioRef.current.volume = volume;
53 |   }, [volume]);
54 | 
55 |   const togglePlay = () => {
56 |     if (isPlaying) {
57 |       audioRef.current.pause();
58 |       setIsPlaying(false);
59 |     } else {
60 |       audioRef.current
61 |         .play()
62 |         .then(() => setIsPlaying(true))
63 |         .catch(() => /* manejar error */ null);
64 |     }
65 |   };
66 | 
67 |   return (
68 |     <AnimatePresence>
69 |       {open && (
70 |         <motion.div
71 |           className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"
72 |           initial={{ opacity: 0 }}
73 |           animate={{ opacity: 1 }}
74 |           exit={{ opacity: 0 }}
75 |         >
76 |           <motion.div
77 |             className="w-full max-w-xs bg-white rounded-2xl overflow-hidden shadow-lg"
78 |             initial={{ scale: 0.9 }}
79 |             animate={{ scale: 1 }}
80 |             exit={{ scale: 0.9 }}
81 |           >
82 |             {/* Header */}
83 |             <div className="flex justify-between items-center px-4 py-2 bg-gray-100">
84 |               <h2 className="text-lg font-semibold text-gray-800">
85 |                 Vista previa de voz
86 |               </h2>
87 |               <button onClick={onClose} className="p-1">
88 |                 <X size={20} className="text-gray-600" />
89 |               </button>
90 |             </div>
91 | 
92 |             {/* Body */}
93 |             <div className="px-6 py-8 flex flex-col items-center space-y-4">
94 |               <div
95 |                 className="text-6xl"
96 |                 style={{ color: voice.color }}
97 |               >
98 |                 {voice.icon}
99 |               </div>
100 |               <h3 className="text-xl font-medium text-gray-800">
101 |                 {voice.name}
102 |               </h3>
103 |               {voice.description && (
104 |                 <p className="text-sm text-gray-600 text-center">
105 |                   {voice.description}
106 |                 </p>
107 |               )}
108 | 
109 |               {/* Play/Pause */}
110 |               <button
111 |                 onClick={togglePlay}
112 |                 className="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center shadow-md"
113 |                 style={{ color: voice.color }}
114 |               >
115 |                 {isPlaying ? (
116 |                   <Pause size={28} />
117 |                 ) : (
118 |                   <Play size={28} />
119 |                 )}
120 |               </button>
121 | 
122 |               {/* Volume Slider */}
123 |               <div className="w-full">
124 |                 <Slider
125 |                   value={[volume]}
126 |                   step={0.01}
127 |                   max={1}
128 |                   onValueChange={(v) => setVolume(v[0])}
129 |                 />
130 |               </div>
131 | 
132 |               <Button
133 |                 variant="ghost"
134 |                 size="sm"
135 |                 onClick={onClose}
136 |               >
137 |                 Cerrar
138 |               </Button>
139 |             </div>
140 |           </motion.div>
141 |         </motion.div>
142 |       )}
143 |     </AnimatePresence>
144 |   );
145 | }
```

src/components/ProgressBar.tsx
```
1 | import { motion } from "framer-motion";
2 | 
3 | interface ProgressBarProps {
4 |   current: number;
5 |   total: number;
6 | }
7 | 
8 | export default function ProgressBar({ current, total }: ProgressBarProps) {
9 |   const progress = (current / total) * 100;
10 |   
11 |   return (
12 |     <div className="mb-8">
13 |       <div className="flex justify-between text-xs text-white/70 mb-2">
14 |         <span>Paso {current} de {total}</span>
15 |         <span>{Math.round(progress)}%</span>
16 |       </div>
17 |       <div className="h-2 w-full bg-white/10 rounded-full overflow-hidden">
18 |         <motion.div
19 |           initial={{ width: 0 }}
20 |           animate={{ width: `${progress}%` }}
21 |           transition={{ duration: 0.5, ease: "easeOut" }}
22 |           className="h-full bg-primary-orange rounded-full"
23 |         />
24 |       </div>
25 |     </div>
26 |   );
27 | } 
```

src/components/StoryAudioPlayer.tsx
```
1 | import { useState, useEffect, useRef } from "react";
2 | import { Play, Pause, X, AlertCircle } from "lucide-react";
3 | import { Button } from "@/components/ui/button";
4 | import { Slider } from "@/components/ui/slider";
5 | import { motion } from "framer-motion";
6 | import { cn } from "@/lib/utils";
7 | import { generateSpeech, OPENAI_VOICES, OpenAIVoiceType } from "@/services/ai/ttsService";
8 | import { useAudioStore } from "@/store/stories/audio/audioStore";
9 | import { useUserStore } from "@/store/user/userStore";
10 | import { toast } from "sonner";
11 | import { STORY_VOICES, PLAYBACK_SPEEDS } from "@/constants/story-voices.constant";
12 | 
13 | 
14 | // Function to format time
15 | const formatTime = (seconds: number): string => {
16 |   if (isNaN(seconds)) return "0:00";
17 |   const minutes = Math.floor(seconds / 60);
18 |   const remainingSeconds = Math.floor(seconds % 60);
19 |   return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
20 | };
21 | 
22 | interface StoryAudioPlayerProps {
23 |   text: string;
24 |   onClose: () => void;
25 | }
26 | 
27 | export default function StoryAudioPlayer({ text, onClose }: StoryAudioPlayerProps) {
28 |   const { 
29 |     addAudioToCache, 
30 |     getAudioFromCache, 
31 |     setGenerationStatus, 
32 |     getGenerationStatus,
33 |     setCurrentVoice,
34 |     getCurrentVoice
35 |   } = useAudioStore();
36 |   
37 |   const { canGenerateVoice, isPremium, getRemainingMonthlyVoiceGenerations, getAvailableVoiceCredits } = useUserStore();
38 | 
39 |   const [isPlaying, setIsPlaying] = useState(false);
40 |   const [isLoading, setIsLoading] = useState(false);
41 |   const [currentTime, setCurrentTime] = useState(0);
42 |   const [duration, setDuration] = useState(0);
43 |   const [audioUrl, setAudioUrl] = useState<string | null>(null);
44 |   const [selectedVoice, setSelectedVoice] = useState<typeof STORY_VOICES[0]>(() => {
45 |     const savedVoiceId = getCurrentVoice();
46 |     if (savedVoiceId) {
47 |       const voiceIdx = STORY_VOICES.findIndex(v => v.id === savedVoiceId);
48 |       if (voiceIdx !== -1) {
49 |         return STORY_VOICES[voiceIdx];
50 |       }
51 |     }
52 |     return STORY_VOICES[0];
53 |   });
54 |   const [playbackSpeed, setPlaybackSpeed] = useState(1);
55 |   const [showGenerationPopup, setShowGenerationPopup] = useState(false);
56 |   const [generationProgress, setGenerationProgress] = useState(0);
57 |   const audioRef = useRef<HTMLAudioElement>(null);
58 | 
59 |   // Guardar la voz seleccionada en el store
60 |   useEffect(() => {
61 |     setCurrentVoice(selectedVoice.id);
62 |   }, [selectedVoice.id, setCurrentVoice]);
63 | 
64 |   // Cleanup when component unmounts
65 |   useEffect(() => {
66 |     return () => {
67 |       if (audioRef.current) {
68 |         audioRef.current.pause();
69 |         audioRef.current.src = '';
70 |       }
71 |       if (audioUrl && !audioUrl.startsWith('blob:')) {
72 |         URL.revokeObjectURL(audioUrl);
73 |       }
74 |     };
75 |   }, [audioUrl]);
76 | 
77 |   // Update time display
78 |   useEffect(() => {
79 |     let interval: NodeJS.Timeout;
80 |     if (isPlaying && audioRef.current) {
81 |       interval = setInterval(() => {
82 |         setCurrentTime(audioRef.current?.currentTime || 0);
83 |       }, 100);
84 |     }
85 |     return () => clearInterval(interval);
86 |   }, [isPlaying]);
87 | 
88 |   // Update duration when metadata is loaded
89 |   useEffect(() => {
90 |     if (audioRef.current) {
91 |       const handleLoadedMetadata = () => {
92 |         setDuration(audioRef.current?.duration || 0);
93 |       };
94 | 
95 |       audioRef.current.addEventListener('loadedmetadata', handleLoadedMetadata);
96 |       return () => {
97 |         audioRef.current?.removeEventListener('loadedmetadata', handleLoadedMetadata);
98 |       };
99 |     }
100 |   }, []);
101 | 
102 |   // Update audio source when URL changes
103 |   useEffect(() => {
104 |     if (audioRef.current && audioUrl) {
105 |       if (audioUrl.startsWith('blob:')) {
106 |         audioRef.current.src = audioUrl;
107 |       } else {
108 |         fetch(audioUrl)
109 |           .then(response => response.blob())
110 |           .then(blob => {
111 |             const audioObjUrl = URL.createObjectURL(new Blob([blob], { type: 'audio/mp4' }));
112 |             audioRef.current.src = audioObjUrl;
113 |           });
114 |       }
115 |       audioRef.current.load();
116 |     }
117 |   }, [audioUrl]);
118 | 
119 |   // Update playback speed
120 |   useEffect(() => {
121 |     if (audioRef.current) {
122 |       audioRef.current.playbackRate = playbackSpeed;
123 |     }
124 |   }, [playbackSpeed]);
125 | 
126 |   const handlePlayPause = async () => {
127 |     if (!audioUrl) {
128 |       setShowGenerationPopup(true);
129 |       return;
130 |     }
131 | 
132 |     if (audioRef.current) {
133 |       if (isPlaying) {
134 |         audioRef.current.pause();
135 |         setIsPlaying(false);
136 |       } else {
137 |         try {
138 |           await audioRef.current.play().catch(error => {
139 |             console.error('Safari playback error:', error);
140 |             toast.error("Safari requiere interacción directa - Haz click primero en el botón");
141 |           });
142 |           setIsPlaying(true);
143 |         } catch (error) {
144 |           console.error('Error starting playback:', error);
145 |           setIsPlaying(false);
146 |           toast.error("No se pudo reproducir el audio");
147 |         }
148 |       }
149 |     }
150 |   };
151 | 
152 |   const handleGenerateAudio = async () => {
153 |     // Verificar si el usuario puede generar audio según su plan y límites
154 |     if (!canGenerateVoice()) {
155 |       const isPremiumUser = isPremium();
156 |       const remainingGenerations = getRemainingMonthlyVoiceGenerations();
157 |       const availableCredits = getAvailableVoiceCredits();
158 |       
159 |       if (isPremiumUser && remainingGenerations <= 0) {
160 |         toast.error("Has alcanzado el límite mensual de generaciones de voz para tu plan premium.");
161 |         return;
162 |       } else if (!isPremiumUser && availableCredits <= 0) {
163 |         toast.error("No tienes créditos disponibles para generar audio. Actualiza a premium para obtener más generaciones mensuales.");
164 |         return;
165 |       }
166 |     }
167 |     
168 |     try {
169 |       setIsLoading(true);
170 |       // Usamos un ID temporal para identificar la generación
171 |       const tempId = "temp-audio";
172 |       
173 |       setGenerationStatus(tempId, "chapter", 'generating', 10);
174 |       setGenerationProgress(10);
175 |       
176 |       // Simulate generation progress (in real implementation, you would get actual progress)
177 |       const progressInterval = setInterval(() => {
178 |         setGenerationProgress(prev => {
179 |           const newValue = prev + Math.random() * 15;
180 |           const progress = newValue > 90 ? 90 : newValue;
181 |           setGenerationStatus(tempId, "chapter", 'generating', progress);
182 |           return progress;
183 |         });
184 |       }, 800);
185 | 
186 |       // Mapeo de voces de la historia a las voces de OpenAI
187 |       const voiceApiMapping: {[key: string]: OpenAIVoiceType} = {
188 |         "el-sabio": "sage",
189 |         "el-capitan": "onyx",
190 |         "el-animado": "ash",
191 |         "el-elegante": "alloy",
192 |         "el-aventurero": "echo",
193 |         "el-enigmatico": "fable",
194 |         "el-risueno": "nova",
195 |         "el-tierno": "coral"
196 |       };
197 |       
198 |       // Instrucciones específicas según el tipo de narrador
199 |       const narratorInstructions: {[key: string]: string} = {
200 |         "el-sabio": "Narra con un tono grave y reflexivo, haciendo pausas significativas entre oraciones importantes.",
201 |         "el-capitan": "Narra con energía y autoridad, enfatizando las palabras de acción y aventura.",
202 |         "el-animado": "Narra con entusiasmo y diversión, variando el tono para mantener la atención de los niños.",
203 |         "el-elegante": "Narra con un tono refinado y sofisticado, articulando cada palabra con claridad.",
204 |         "el-aventurero": "Narra con emoción y dinamismo, acelerando el ritmo en los momentos de acción.",
205 |         "el-enigmatico": "Narra con un tono misterioso y pausado, generando intriga en cada frase.",
206 |         "el-risueno": "Narra con alegría y optimismo, transmitiendo positividad en la historia.",
207 |         "el-tierno": "Narra con dulzura y calidez, creando un ambiente íntimo y reconfortante."
208 |       };
209 | 
210 |       // Generar el audio con la nueva API
211 |       const audioBlob = await generateSpeech({
212 |         text,
213 |         voice: voiceApiMapping[selectedVoice.id] || "nova",
214 |         model: 'gpt-4o-mini-tts',
215 |         instructions: narratorInstructions[selectedVoice.id]
216 |       });
217 | 
218 |       // Crear URL para el blob
219 |       const audioObjUrl = URL.createObjectURL(audioBlob);
220 |       setAudioUrl(audioObjUrl);
221 |       
222 |       // Guardar en caché
223 |       addAudioToCache(tempId, "chapter", selectedVoice.id, audioObjUrl);
224 |       setGenerationStatus(tempId, "chapter", 'completed', 100);
225 |       
226 |       setShowGenerationPopup(false);
227 |       setIsPlaying(true);
228 | 
229 |       clearInterval(progressInterval);
230 |       setGenerationProgress(100);
231 | 
232 |       // Reproducir automáticamente después de la generación
233 |       if (audioRef.current) {
234 |         try {
235 |           await audioRef.current.play().catch(error => {
236 |             console.error('Safari playback error:', error);
237 |             toast.error("Safari requiere interacción directa - Haz click primero en el botón");
238 |           });
239 |           setIsPlaying(true);
240 |         } catch (error) {
241 |           console.error('Error auto-playing after generation:', error);
242 |         }
243 |       }
244 |     } catch (error) {
245 |       console.error('Error generating audio:', error);
246 |       toast.error("Error al generar el audio");
247 |       setGenerationStatus("temp-audio", "chapter", 'error', 0);
248 |     } finally {
249 |       setIsLoading(false);
250 |     }
251 |   };
252 | 
253 |   const handleSeek = (value: number[]) => {
254 |     if (audioRef.current) {
255 |       audioRef.current.currentTime = value[0];
256 |       setCurrentTime(value[0]);
257 |     }
258 |   };
259 | 
260 |   const handleVoiceChange = (voice: typeof STORY_VOICES[0]) => {
261 |     setSelectedVoice(voice);
262 |     setAudioUrl(null);
263 |   };
264 | 
265 |   const handlePlaybackSpeedChange = (speed: number) => {
266 |     setPlaybackSpeed(speed);
267 |     if (audioRef.current) {
268 |       audioRef.current.playbackRate = speed;
269 |     }
270 |   };
271 | 
272 |   const handleEndedEvent = () => {
273 |     setIsPlaying(false);
274 |     setCurrentTime(duration);
275 |   };
276 | 
277 |   const handleClose = () => {
278 |     if (isPlaying && audioRef.current) {
279 |       audioRef.current.pause();
280 |     }
281 |     onClose();
282 |   };
283 | 
284 |   return (
285 |     <motion.div
286 |       initial={{ opacity: 0, y: 20 }}
287 |       animate={{ opacity: 1, y: 0 }}
288 |       exit={{ opacity: 0, y: 20 }}
289 |       transition={{ duration: 0.3 }}
290 |       className={cn(
291 |         "w-full max-w-md mx-auto rounded-3xl overflow-hidden shadow-2xl",
292 |         selectedVoice.color
293 |       )}
294 |     >
295 |       {/* Header with title */}
296 |       <div className="px-6 pt-6 pb-2">
297 |         <div className="flex justify-between items-center">
298 |           <h2 className="text-xl font-bold text-white truncate pr-4">{}</h2>
299 |           <Button 
300 |             variant="ghost" 
301 |             size="icon" 
302 |             onClick={handleClose}
303 |             className="rounded-full text-white hover:bg-white/20"
304 |           >
305 |             <X size={24} />
306 |           </Button>
307 |         </div>
308 |       </div>
309 | 
310 |       {/* Main player area */}
311 |       <div className="bg-white/15 backdrop-blur-lg p-8 text-white">
312 |         {/* Voice indicator */}
313 |         <div className="flex items-center justify-center gap-2 mb-6">
314 |           <span className="text-4xl">{selectedVoice.icon}</span>
315 |           <div className="text-center">
316 |             <p className="text-lg font-semibold">Narrado por</p>
317 |             <p className="text-2xl font-bold">{selectedVoice.name}</p>
318 |           </div>
319 |         </div>
320 | 
321 |         {/* Play button */}
322 |         <div className="flex justify-center mb-8">
323 |           <Button
324 |             onClick={handlePlayPause}
325 |             disabled={isLoading}
326 |             className={cn(
327 |               "w-24 h-24 rounded-full border-4 border-white/30",
328 |               "flex items-center justify-center",
329 |               "bg-white/20 hover:bg-white/30 transition-all"
330 |             )}
331 |           >
332 |             {isLoading ? (
333 |               <div className="w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin" />
334 |             ) : isPlaying ? (
335 |               <Pause className="w-12 h-12" />
336 |             ) : (
337 |               <Play className="w-12 h-12 ml-2" />
338 |             )}
339 |           </Button>
340 |         </div>
341 | 
342 |         {/* Progress bar */}
343 |         <div className="mb-4">
344 |           <Slider
345 |             value={[currentTime]}
346 |             max={duration || 100}
347 |             step={0.1}
348 |             onValueChange={handleSeek}
349 |             disabled={!audioUrl}
350 |             className="mb-2"
351 |           />
352 |           <div className="flex justify-between text-sm">
353 |             <span>{formatTime(currentTime)}</span>
354 |             <span>{formatTime(duration)}</span>
355 |           </div>
356 |         </div>
357 | 
358 |         {/* Playback speed */}
359 |         <div className="mb-4">
360 |           <p className="text-sm mb-2">Velocidad de reproducción</p>
361 |           <div className="flex justify-between gap-2">
362 |             {PLAYBACK_SPEEDS.map(speed => (
363 |               <Button
364 |                 key={speed}
365 |                 variant={playbackSpeed === speed ? "default" : "outline"}
366 |                 size="sm"
367 |                 onClick={() => handlePlaybackSpeedChange(speed)}
368 |                 className={cn(
369 |                   "flex-1 rounded-full",
370 |                   playbackSpeed === speed 
371 |                     ? "bg-white/30 text-white" 
372 |                     : "bg-transparent text-white border-white/50 hover:bg-white/20"
373 |                 )}
374 |               >
375 |                 {speed}x
376 |               </Button>
377 |             ))}
378 |           </div>
379 |         </div>
380 | 
381 |         {/* Voice selector */}
382 |         <div>
383 |           <p className="text-sm mb-2">Seleccionar narrador</p>
384 |           <div className="grid grid-cols-4 gap-2 mb-4">
385 |             {STORY_VOICES.map(voice => (
386 |               <Button
387 |                 key={voice.id}
388 |                 variant="ghost"
389 |                 size="sm"
390 |                 onClick={() => handleVoiceChange(voice)}
391 |                 className={cn(
392 |                   "aspect-square p-1 flex items-center justify-center",
393 |                   "rounded-xl border-2 transition-all",
394 |                   selectedVoice.id === voice.id 
395 |                     ? "border-white bg-white/20" 
396 |                     : "border-transparent hover:border-white/50 hover:bg-white/10"
397 |                 )}
398 |                 title={voice.name}
399 |               >
400 |                 <span className="text-2xl">{voice.icon}</span>
401 |               </Button>
402 |             ))}
403 |           </div>
404 |         </div>
405 | 
406 |         {/* Return button */}
407 |         <Button
408 |           variant="outline"
409 |           className="w-full mt-4 rounded-full border-white/50 text-white hover:bg-white/20 hover:text-white"
410 |           onClick={handleClose}
411 |         >
412 |           Volver a la lectura
413 |         </Button>
414 |       </div>
415 | 
416 |       {/* Audio element (hidden) */}
417 |       <audio
418 |         ref={audioRef}
419 |         onTimeUpdate={() => setCurrentTime(audioRef.current?.currentTime || 0)}
420 |         onEnded={handleEndedEvent}
421 |         className="hidden"
422 |       />
423 | 
424 |       {/* Voice generation popup */}
425 |       {showGenerationPopup && (
426 |         <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
427 |           <motion.div
428 |             initial={{ opacity: 0, scale: 0.9 }}
429 |             animate={{ opacity: 1, scale: 1 }}
430 |             className={cn(
431 |               "w-full max-w-md rounded-3xl p-8 text-white shadow-2xl",
432 |               selectedVoice.color
433 |             )}
434 |           >
435 |             <div className="text-center mb-6">
436 |               <span className="text-5xl mb-4 inline-block">{selectedVoice.icon}</span>
437 |               <h3 className="text-2xl font-bold mb-2">{selectedVoice.name}</h3>
438 |               <p className="text-white/90 mb-6">{selectedVoice.description}</p>
439 |               
440 |               {isLoading ? (
441 |                 <>
442 |                   <div className="w-full bg-white/20 rounded-full h-2 mb-4">
443 |                     <div 
444 |                       className="bg-white h-2 rounded-full" 
445 |                       style={{ width: `${generationProgress}%` }}
446 |                     ></div>
447 |                   </div>
448 |                   <p className="text-white/80">Generando audio, por favor espera...</p>
449 |                 </>
450 |               ) : (
451 |                 <button
452 |                   onClick={handleGenerateAudio}
453 |                   disabled={isLoading || !canGenerateVoice()}
454 |                   className={cn(
455 |                     "flex items-center justify-center gap-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-full font-medium shadow-md hover:from-purple-600 hover:to-indigo-700 transition-all",
456 |                     (isLoading || !canGenerateVoice()) && "opacity-70 cursor-not-allowed"
457 |                   )}
458 |                   title={!canGenerateVoice() ? "Has alcanzado el límite de generaciones de voz" : ""}
459 |                 >
460 |                   {isLoading ? (
461 |                     <>Generando... {Math.round(generationProgress)}%</>
462 |                   ) : (
463 |                     <>
464 |                       Generar Audio
465 |                       {!canGenerateVoice() && <AlertCircle className="ml-1 h-4 w-4" />}
466 |                     </>
467 |                   )}
468 |                 </button>
469 |               )}
470 |             </div>
471 |             
472 |             {!isLoading && (
473 |               <Button
474 |                 variant="ghost"
475 |                 onClick={() => setShowGenerationPopup(false)}
476 |                 className="w-full text-white/80 hover:text-white hover:bg-white/10"
477 |               >
478 |                 Cancelar
479 |               </Button>
480 |             )}
481 |           </motion.div>
482 |         </div>
483 |       )}
484 |     </motion.div>
485 |   );
486 | }
```

src/components/StoryButton.tsx
```
1 | 
2 | import { ButtonHTMLAttributes, ReactNode } from "react";
3 | 
4 | interface StoryButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
5 |   children: ReactNode;
6 |   variant?: "primary" | "secondary";
7 |   icon?: ReactNode;
8 |   isFullWidth?: boolean;
9 | }
10 | 
11 | export default function StoryButton({ 
12 |   children, 
13 |   variant = "primary", 
14 |   icon, 
15 |   isFullWidth = false,
16 |   ...props 
17 | }: StoryButtonProps) {
18 |   return (
19 |     <button
20 |       className={`
21 |         ${variant === "primary" ? "story-btn-primary" : "story-btn-secondary"}
22 |         ${isFullWidth ? "w-full" : ""}
23 |         ${props.disabled ? "opacity-50 cursor-not-allowed" : ""}
24 |         ${props.className || ""}
25 |       `}
26 |       {...props}
27 |     >
28 |       {icon && <span className="mr-2">{icon}</span>}
29 |       {children}
30 |     </button>
31 |   );
32 | }
```

src/components/StoryChapter.tsx
```
1 | import { motion } from "framer-motion";
2 | import { StoryChapter as StoryChapterType } from "../types";
3 | 
4 | interface StoryChapterProps {
5 |   chapter: StoryChapterType;
6 |   isLatest?: boolean;
7 | }
8 | 
9 | export default function StoryChapter({ chapter, isLatest = false }: StoryChapterProps) {
10 |   return (
11 |     <motion.div
12 |       initial={{ opacity: 0, y: 20 }}
13 |       animate={{ opacity: 1, y: 0 }}
14 |       transition={{ duration: 0.5 }}
15 |       className={`${isLatest ? 'bg-white/20' : 'bg-white/15'} backdrop-blur-md rounded-3xl p-6 mb-8 text-white leading-relaxed shadow-xl`}
16 |     >
17 |       <div className="flex items-center justify-between mb-4">
18 |         <div className="flex items-center">
19 |           <div className="bg-story-orange-400 text-white text-xs font-bold rounded-full px-3 py-1 mr-3">
20 |             Capítulo {chapter.chapterNumber}
21 |           </div>
22 |           <h3 className="text-xl font-bold">{chapter.title}</h3>
23 |         </div>
24 |         <div className="text-xs text-white/60">
25 |           {new Date(chapter.createdAt).toLocaleDateString()}
26 |         </div>
27 |       </div>
28 | 
29 |       <div className="prose prose-invert max-w-none">
30 |         {chapter.content.split('\n').map((paragraph, index) => (
31 |           <p key={index} className="mb-4">{paragraph}</p>
32 |         ))}
33 |       </div>
34 |     </motion.div>
35 |   );
36 | }
```

src/components/StoryContinuationCustomInput.tsx
```
1 | import { useState } from "react";
2 | import { motion } from "framer-motion";
3 | import { ArrowLeft, Send } from "lucide-react";
4 | 
5 | interface StoryContinuationCustomInputProps {
6 |   onSubmit: (text: string) => void;
7 |   onBack: () => void;
8 |   disabled?: boolean;
9 | }
10 | 
11 | export default function StoryContinuationCustomInput({
12 |   onSubmit,
13 |   onBack,
14 |   disabled = false
15 | }: StoryContinuationCustomInputProps) {
16 |   const [userInput, setUserInput] = useState("");
17 |   const [isSubmitting, setIsSubmitting] = useState(false);
18 | 
19 |   const handleSubmit = () => {
20 |     if (!userInput.trim()) return;
21 |     
22 |     setIsSubmitting(true);
23 |     onSubmit(userInput);
24 |   };
25 | 
26 |   return (
27 |     <motion.div
28 |       initial={{ opacity: 0, y: 20 }}
29 |       animate={{ opacity: 1, y: 0 }}
30 |       transition={{ duration: 0.5 }}
31 |       className="bg-white/80 backdrop-blur-md rounded-3xl p-6 mb-8 text-[#222] leading-relaxed shadow-xl border border-[#BB79D1]/30"
32 |     >
33 |       <div className="flex items-center mb-6">
34 |         <button 
35 |           onClick={onBack}
36 |           className="mr-4 p-2 rounded-full bg-[#BB79D1]/20 hover:bg-[#BB79D1]/30 transition-all text-[#BB79D1]"
37 |         >
38 |           <ArrowLeft size={20} />
39 |         </button>
40 |         <h2 className="text-2xl font-bold text-[#BB79D1]">Describe tu continuación</h2>
41 |       </div>
42 | 
43 |       <p className="mb-4 text-[#222] font-medium">
44 |         Describe cómo te gustaría que continuara la historia. Puedes incluir nuevos personajes, 
45 |         lugares o situaciones. ¡Sé creativo!
46 |       </p>
47 | 
48 |       <textarea
49 |         value={userInput}
50 |         onChange={(e) => setUserInput(e.target.value)}
51 |         placeholder="Ejemplo: Me gustaría que el protagonista descubriera un objeto mágico que le permita..."
52 |         className="w-full h-40 p-4 rounded-xl bg-[#F6A5B7]/10 text-[#222] placeholder-[#222]/50 focus:outline-none focus:ring-2 focus:ring-[#BB79D1] resize-none mb-4 border border-[#F6A5B7]/30"
53 |         disabled={isSubmitting || disabled}
54 |       />
55 | 
56 |       <div className="flex justify-end">
57 |         <button
58 |           onClick={handleSubmit}
59 |           disabled={!userInput.trim() || isSubmitting || disabled}
60 |           className={`px-6 py-3 rounded-full font-medium flex items-center ${
61 |             !userInput.trim() || isSubmitting || disabled
62 |               ? "bg-[#BB79D1]/30 text-[#222]/50 cursor-not-allowed"
63 |               : "bg-[#BB79D1] text-white hover:bg-[#BB79D1]/90 transition-all shadow-lg"
64 |           }`}
65 |         >
66 |           {isSubmitting ? (
67 |             <div className="w-5 h-5 border-t-2 border-b-2 border-white rounded-full animate-spin mr-2" />
68 |           ) : (
69 |             <Send size={18} className="mr-2" />
70 |           )}
71 |           {isSubmitting ? "Generando..." : "Enviar"}
72 |         </button>
73 |       </div>
74 |     </motion.div>
75 |   );
76 | }
```

src/components/StoryContinuationOptions.tsx
```
1 | import { useState, useEffect } from "react";
2 | import { motion } from "framer-motion";
3 | import { ArrowRight, PenLine, Sparkles, Lightbulb, Wand2, Loader2 } from "lucide-react";
4 | 
5 | interface StoryContinuationOptionsProps {
6 |   options: { summary: string }[];
7 |   onSelectOption: (index: number) => void;
8 |   onSelectFree: () => void;
9 |   onSelectCustom: () => void;
10 |   isLoading?: boolean;
11 |   disabled?: boolean;
12 | }
13 | 
14 | export default function StoryContinuationOptions({
15 |   options = [],
16 |   onSelectOption,
17 |   onSelectFree,
18 |   onSelectCustom,
19 |   isLoading = false,
20 |   disabled = false
21 | }: StoryContinuationOptionsProps) {
22 |   const [selectedOption, setSelectedOption] = useState<number | null>(null);
23 |   const [displayOptions, setDisplayOptions] = useState<{ summary: string }[]>([]);
24 |   
25 |   // Asegurarse de que siempre tengamos 3 opciones
26 |   useEffect(() => {
27 |     const defaultOptions = [
28 |       { summary: "Buscar el tesoro escondido en el bosque." },
29 |       { summary: "Hablar con el misterioso anciano del pueblo." },
30 |       { summary: "Seguir el camino hacia las montañas nevadas." }
31 |     ];
32 |     
33 |     if (options && options.length === 3) {
34 |       setDisplayOptions(options);
35 |     } else {
36 |       console.warn("No se recibieron 3 opciones en el componente. Usando opciones predeterminadas.");
37 |       setDisplayOptions(defaultOptions);
38 |     }
39 |   }, [options]);
40 | 
41 |   const handleOptionSelect = (index: number) => {
42 |     setSelectedOption(index);
43 |     setTimeout(() => onSelectOption(index), 300);
44 |   };
45 | 
46 |   // Paleta de colores y gradientes distintos para cada opción
47 |   const optionStyles = [
48 |     { bg: "bg-[#7DC4E0]", icon: <Lightbulb className="shrink-0 mr-3" size={24} /> },
49 |     { bg: "bg-[#f7c59f]", icon: <Wand2 className="shrink-0 mr-3" size={24} /> },
50 |     { bg: "bg-[#F6A5B7]", icon: <Sparkles className="shrink-0 mr-3" size={24} /> }
51 |   ];
52 | 
53 |   return (
54 |     <div className="space-y-6">
55 |       {/* Continuar Libre Option */}
56 |       <motion.div 
57 |         initial={{ opacity: 0, y: 20 }}
58 |         animate={{ opacity: 1, y: 0 }}
59 |         transition={{ duration: 0.4, delay: 0.1 }}
60 |         whileHover={{ scale: 1.02 }}
61 |         className="w-full"
62 |       >
63 |         <button
64 |           onClick={onSelectFree}
65 |           disabled={disabled}
66 |           className={`w-full bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white rounded-2xl p-5 transition-all shadow-lg flex items-center justify-between ${disabled ? 'opacity-60 cursor-not-allowed' : ''}`}
67 |         >
68 |           <span className="text-lg font-semibold">Continuar Libre</span>
69 |           <ArrowRight size={20} />
70 |         </button>
71 |       </motion.div>
72 | 
73 |       {/* AI Options - Siempre mostrar esta sección */}
74 |       <motion.div 
75 |         initial={{ opacity: 0 }}
76 |         animate={{ opacity: 1 }}
77 |         transition={{ duration: 0.4, delay: 0.2 }}
78 |         className="space-y-2"
79 |       >
80 |         <h3 className="text-lg font-medium mb-3 text-[#222] bg-white/70 rounded-xl px-4 py-2 text-center shadow-sm">Elige una opción:</h3>
81 |         
82 |         {isLoading ? (
83 |           <div className="flex justify-center p-6 bg-white/70 rounded-xl shadow-md">
84 |             <Loader2 size={48} className="animate-spin text-[#BB79D1]" />
85 |           </div>
86 |         ) : (
87 |           displayOptions.map((option, index) => (
88 |             <motion.div 
89 |               key={index}
90 |               initial={{ opacity: 0, x: -20 }}
91 |               animate={{ opacity: 1, x: 0 }}
92 |               transition={{ duration: 0.4, delay: 0.3 + (index * 0.1) }}
93 |               whileHover={{ scale: 1.02 }}
94 |               whileTap={{ scale: 0.98 }}
95 |             >
96 |               <button
97 |                 onClick={() => handleOptionSelect(index)}
98 |                 disabled={disabled}
99 |                 className={`w-full text-left p-5 rounded-xl transition-all shadow-md flex ${optionStyles[index].bg} text-white ${disabled ? 'opacity-60 cursor-not-allowed' : ''}`}
100 |               >
101 |                 <div className="flex-1">
102 |                   <div className="flex items-start mb-2">
103 |                     {optionStyles[index].icon}
104 |                     <span className="font-medium text-lg">{`Opción ${index + 1}`}</span>
105 |                   </div>
106 |                   <p className="pl-8 text-white/90">{option.summary}</p>
107 |                 </div>
108 |                 {selectedOption === index && (
109 |                   <div className="flex items-center justify-center">
110 |                     <ArrowRight size={18} />
111 |                   </div>
112 |                 )}
113 |               </button>
114 |             </motion.div>
115 |           ))
116 |         )}
117 |       </motion.div>
118 | 
119 |       {/* Custom Option */}
120 |       <motion.div 
121 |         initial={{ opacity: 0, y: 20 }}
122 |         animate={{ opacity: 1, y: 0 }}
123 |         transition={{ duration: 0.4, delay: 0.6 }}
124 |         whileHover={{ scale: 1.02 }}
125 |       >
126 |         <button
127 |           onClick={onSelectCustom}
128 |           disabled={disabled}
129 |           className="w-full bg-white/70 hover:bg-white/90 text-[#BB79D1] rounded-xl p-5 transition-all shadow-lg flex items-center justify-center font-semibold border-2 border-[#BB79D1]/30"
130 |         >
131 |           <PenLine size={20} className="mr-3 text-[#BB79D1]" />
132 |           <span>Describir tu continuación soñada</span>
133 |         </button>
134 |       </motion.div>
135 |     </div>
136 |   );
137 | }
```

src/components/StoryOptionCard.tsx
```
1 | 
2 | import { ReactNode } from "react";
3 | 
4 | interface StoryOptionCardProps {
5 |   icon?: ReactNode;
6 |   label: string;
7 |   onClick: () => void;
8 |   selected?: boolean;
9 |   className?: string;
10 | }
11 | 
12 | export default function StoryOptionCard({ 
13 |   icon, 
14 |   label, 
15 |   onClick, 
16 |   selected = false,
17 |   className = ""
18 | }: StoryOptionCardProps) {
19 |   return (
20 |     <div 
21 |       onClick={onClick}
22 |       className={`
23 |         story-choice-card
24 |         ${selected ? 'ring-4 ring-story-orange-400 bg-white/20 shadow-lg transform scale-105' : 'hover:scale-105 hover:shadow-md transition-all duration-300'}
25 |         ${className}
26 |       `}
27 |     >
28 |       {icon && (
29 |         <div className="text-white text-3xl mb-3">
30 |           {icon}
31 |         </div>
32 |       )}
33 |       <span className="text-white text-center font-medium text-shadow">{label}</span>
34 |     </div>
35 |   );
36 | }
```

src/components/StoryPdfPreview.tsx
```
1 | import { useState, useRef, useEffect } from "react";
2 | import { Button } from "./ui/button";
3 | import { Loader2, Heart, Palette, FileText, CheckCircle, AlertCircle } from "lucide-react";
4 | import { Progress } from "./ui/progress";
5 | import { APP_CONFIG } from "../config/app";
6 | import { StoryPdfService, ImageGenerationProgress } from "../services/storyPdfService";
7 | 
8 | interface StoryPdfPreviewProps {
9 |   title: string;
10 |   author?: string;
11 |   content: string;
12 |   onClose?: () => void;
13 |   isOpen: boolean;
14 |   storyId: string;
15 |   chapterId: string;
16 | }
17 | 
18 | export default function StoryPdfPreview({
19 |   title,
20 |   author,
21 |   content,
22 |   onClose,
23 |   isOpen,
24 |   storyId,
25 |   chapterId
26 | }: StoryPdfPreviewProps) {
27 |   const [isGenerating, setIsGenerating] = useState(false);
28 |   const [isGeneratingIllustrated, setIsGeneratingIllustrated] = useState(false);
29 |   const [isValidatingImages, setIsValidatingImages] = useState(false);
30 |   const [needsImageGeneration, setNeedsImageGeneration] = useState(false);
31 |   const [showConfirmGeneration, setShowConfirmGeneration] = useState(false);
32 |   const [imageValidationResult, setImageValidationResult] = useState<{
33 |     canGenerate: boolean;
34 |     reason?: string;
35 |     missingImages?: string[];
36 |   } | null>(null);
37 |   const [generationProgress, setGenerationProgress] = useState<ImageGenerationProgress | null>(null);
38 |   const [error, setError] = useState<string | null>(null);
39 |   const [activePreview, setActivePreview] = useState<'cover' | 'content' | 'backCover'>('cover');
40 | 
41 |   // Reset states when modal opens
42 |   useEffect(() => {
43 |     if (isOpen) {
44 |       setError(null);
45 |       setNeedsImageGeneration(false);
46 |       setShowConfirmGeneration(false);
47 |       setImageValidationResult(null);
48 |       setGenerationProgress(null);
49 |     }
50 |   }, [isOpen]);
51 | 
52 |   if (!isOpen) return null;
53 | 
54 |   const handleGenerateStandard = async () => {
55 |     try {
56 |       setIsGenerating(true);
57 |       setError(null);
58 | 
59 |       // Generate standard PDF using service
60 |       const pdfBlob = await StoryPdfService.generateStandardPdf({
61 |         title,
62 |         author,
63 |         content,
64 |         storyId,
65 |         chapterId
66 |       });
67 | 
68 |       // Download PDF using service
69 |       StoryPdfService.downloadPdf(pdfBlob, title, false);
70 | 
71 |       if (onClose) onClose();
72 |     } catch (err) {
73 |       console.error('[StoryPdfPreview] Error generating standard PDF:', err);
74 |       setError('Ocurrió un error al generar el PDF. Por favor intenta nuevamente.');
75 |     } finally {
76 |       setIsGenerating(false);
77 |     }
78 |   };
79 | 
80 |   const handleGenerateIllustrated = async () => {
81 |     try {
82 |       setIsValidatingImages(true);
83 |       setError(null);
84 | 
85 |       console.log('[StoryPdfPreview] Starting illustrated story generation...');
86 | 
87 |       // Check if images exist
88 |       const validationResult = await StoryPdfService.canGenerateIllustratedPdf(storyId, chapterId);
89 |       setImageValidationResult(validationResult);
90 | 
91 |       if (validationResult.canGenerate) {
92 |         // Images exist, proceed directly with PDF generation
93 |         console.log('[StoryPdfPreview] ✅ All required images exist. Proceeding with illustrated PDF generation...');
94 |         await generateIllustratedPdfDirectly();
95 |       } else {
96 |         // Images missing, show confirmation dialog
97 |         console.log('[StoryPdfPreview] ❌ Missing images detected:', validationResult.missingImages);
98 |         setNeedsImageGeneration(true);
99 |         setShowConfirmGeneration(true);
100 |       }
101 | 
102 |     } catch (err) {
103 |       console.error('[StoryPdfPreview] Error checking images:', err);
104 |       setError('Ocurrió un error al verificar las imágenes. Por favor intenta nuevamente.');
105 |     } finally {
106 |       setIsValidatingImages(false);
107 |     }
108 |   };
109 | 
110 |   const handleConfirmImageGeneration = async () => {
111 |     try {
112 |       setShowConfirmGeneration(false);
113 |       setIsGeneratingIllustrated(true);
114 | 
115 |       console.log('[StoryPdfPreview] User confirmed image generation. Starting complete illustrated PDF process...');
116 | 
117 |       // Generate illustrated PDF with automatic image generation and progress tracking
118 |       const pdfBlob = await StoryPdfService.generateCompleteIllustratedPdf({
119 |         title,
120 |         author,
121 |         content,
122 |         storyId,
123 |         chapterId,
124 |         onProgress: (progress) => {
125 |           setGenerationProgress(progress);
126 |         }
127 |       });
128 | 
129 |       // Download illustrated PDF
130 |       StoryPdfService.downloadPdf(pdfBlob, title, true);
131 | 
132 |       if (onClose) onClose();
133 | 
134 |     } catch (err) {
135 |       console.error('[StoryPdfPreview] Error generating complete illustrated PDF:', err);
136 |       setError('Ocurrió un error al generar el cuento ilustrado. Por favor intenta nuevamente.');
137 |     } finally {
138 |       setIsGeneratingIllustrated(false);
139 |       setGenerationProgress(null);
140 |     }
141 |   };
142 | 
143 |   const generateIllustratedPdfDirectly = async () => {
144 |     try {
145 |       setIsGeneratingIllustrated(true);
146 | 
147 |       // Validate required images exist in storage using service
148 |       const imageValidation = await StoryPdfService.validateRequiredImages(storyId, chapterId);
149 | 
150 |       if (!imageValidation.allValid) {
151 |         setError(`Faltan imágenes necesarias: ${imageValidation.missingImages.join(', ')}. Por favor, genera las imágenes del cuento primero.`);
152 |         return;
153 |       }
154 | 
155 |       console.log('[StoryPdfPreview] ✅ All required images validated. Proceeding with illustrated PDF generation...');
156 | 
157 |       // Generate illustrated PDF with validated image URLs
158 |       const pdfBlob = await StoryPdfService.generateIllustratedPdf({
159 |         title,
160 |         author,
161 |         content,
162 |         storyId,
163 |         chapterId,
164 |         imageUrls: {
165 |           cover: imageValidation.imageUrls!.cover!,
166 |           scene_1: imageValidation.imageUrls!.scene_1!,
167 |           scene_2: imageValidation.imageUrls!.scene_2!
168 |         }
169 |       });
170 | 
171 |       // Download illustrated PDF
172 |       StoryPdfService.downloadPdf(pdfBlob, title, true);
173 | 
174 |       if (onClose) onClose();
175 | 
176 |     } catch (err) {
177 |       console.error('[StoryPdfPreview] Error generating illustrated story:', err);
178 |       setError('Ocurrió un error al generar el cuento ilustrado. Por favor intenta nuevamente.');
179 |     } finally {
180 |       setIsGeneratingIllustrated(false);
181 |     }
182 |   };
183 | 
184 |   const handleCancelGeneration = () => {
185 |     setShowConfirmGeneration(false);
186 |     setNeedsImageGeneration(false);
187 |     setImageValidationResult(null);
188 |   };
189 | 
190 |   return (
191 |     <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70">
192 |       <div className="bg-white rounded-xl w-full max-w-lg overflow-hidden shadow-2xl">
193 |         {/* Cabecera */}
194 |         <div className="p-4 bg-[#BB79D1] text-white">
195 |           <h2 className="text-xl font-bold">Generar versión imprimible</h2>
196 |         </div>
197 | 
198 |         {/* Cuerpo */}
199 |         <div className="p-6">
200 |           {/* Selector de vista previa */}
201 |           <div className="flex justify-center space-x-3 mb-4">
202 |             <button
203 |               className={`px-4 py-1 rounded-full transition-all ${activePreview === 'cover'
204 |                 ? 'bg-[#BB79D1] text-white'
205 |                 : 'bg-gray-100 hover:bg-gray-200'}`}
206 |               onClick={() => setActivePreview('cover')}
207 |             >
208 |               Portada
209 |             </button>
210 |             <button
211 |               className={`px-4 py-1 rounded-full transition-all ${activePreview === 'content'
212 |                 ? 'bg-[#BB79D1] text-white'
213 |                 : 'bg-gray-100 hover:bg-gray-200'}`}
214 |               onClick={() => setActivePreview('content')}
215 |             >
216 |               Contenido
217 |             </button>
218 |             <button
219 |               className={`px-4 py-1 rounded-full transition-all ${activePreview === 'backCover'
220 |                 ? 'bg-[#BB79D1] text-white'
221 |                 : 'bg-gray-100 hover:bg-gray-200'}`}
222 |               onClick={() => setActivePreview('backCover')}
223 |             >
224 |               Contraportada
225 |             </button>
226 |           </div>
227 | 
228 |           {/* Vista previa según la selección */}
229 |           {activePreview === 'cover' && (
230 |             <div className="mb-6 bg-[#fff6e0] p-4 rounded-lg border border-amber-200 h-80 flex flex-col justify-center">
231 |               <div className="text-center">
232 |                 <img
233 |                   src="/logo_fantasia.png"
234 |                   alt={APP_CONFIG.name}
235 |                   className="h-16 mx-auto mb-4"
236 |                 />
237 |                 <h3 className="text-xl font-bold text-[#BB79D1] mb-1">{title}</h3>
238 |                 {author && (
239 |                   <p className="text-gray-600 italic">por {author}</p>
240 |                 )}
241 |               </div>
242 |             </div>
243 |           )}
244 | 
245 |           {activePreview === 'content' && (
246 |             <div className="mb-6 bg-[#fff6e0] p-4 rounded-lg border border-amber-200">
247 |               <p className="text-sm text-gray-600 mb-2">
248 |                 Vista previa del contenido:
249 |               </p>
250 | 
251 |               <div className="max-h-64 overflow-y-auto text-base border border-amber-100 p-3 rounded bg-white">
252 |                 {content.split("\n").slice(0, 5).map((paragraph, i) => (
253 |                   <p key={i} className="mb-2 font-bold text-[#ce9789]">
254 |                     {paragraph || "..."}
255 |                   </p>
256 |                 ))}
257 |                 {content.split("\n").length > 5 && (
258 |                   <p className="text-gray-400 italic text-sm text-center mt-2">
259 |                     (más contenido no mostrado en la vista previa)
260 |                   </p>
261 |                 )}
262 |               </div>
263 |             </div>
264 |           )}
265 | 
266 |           {activePreview === 'backCover' && (
267 |             <div className="mb-6 bg-[#fff6e0] p-4 rounded-lg border border-amber-200 h-80 flex flex-col justify-center">
268 |               <div className="text-center">
269 |                 <img
270 |                   src="/logo_fantasia.png"
271 |                   alt={APP_CONFIG.name}
272 |                   className="h-16 mx-auto mb-6"
273 |                 />
274 |                 <p className="text-[#BB79D1] font-bold mb-1 text-base">
275 |                   Generado con <Heart className="inline h-4 w-4 mx-0.5 fill-[#BB79D1]" /> por
276 |                 </p>
277 |                 <h3 className="text-2xl font-bold text-[#ce9789] mb-4">{APP_CONFIG.name}!</h3>
278 |                 <p className="text-gray-500 text-sm">{new Date().getFullYear()}</p>
279 |               </div>
280 |             </div>
281 |           )}
282 | 
283 |           {/* Progress Bar y Confirmation Dialog - COMENTADOS PARA DEMO */}
284 |           {/* 
285 |           {generationProgress && (
286 |             <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
287 |               <div className="flex items-center mb-2">
288 |                 <Loader2 className="mr-2 h-4 w-4 animate-spin text-blue-600" />
289 |                 <span className="text-sm font-medium text-blue-800">
290 |                   {generationProgress.currentStep}
291 |                 </span>
292 |               </div>
293 |               <Progress value={generationProgress.progress} className="mb-2" />
294 |               <div className="text-xs text-blue-600">
295 |                 {generationProgress.progress.toFixed(0)}% completado
296 |                 {generationProgress.currentImageType && (
297 |                   <span className="ml-2">• {generationProgress.currentImageType}</span>
298 |                 )}
299 |               </div>
300 |             </div>
301 |           )}
302 | 
303 |           {showConfirmGeneration && imageValidationResult && !imageValidationResult.canGenerate && (
304 |             <div className="mb-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
305 |               <div className="flex items-start">
306 |                 <AlertCircle className="h-5 w-5 text-orange-600 mr-3 mt-0.5 flex-shrink-0" />
307 |                 <div className="flex-1">
308 |                   <h4 className="font-medium text-orange-800 mb-2">
309 |                     Generación de imágenes requerida
310 |                   </h4>
311 |                   <p className="text-sm text-orange-700 mb-3">
312 |                     Para generar el cuento ilustrado necesitamos llenarlo de magia con imágenes y color. 
313 |                   </p>
314 |                   <p className="text-sm text-orange-700 mb-4">
315 |                     Este proceso puede tomar 2-3 minutos. ¿Deseas continuar?
316 |                   </p>
317 |                   <div className="flex space-x-3">
318 |                     <Button
319 |                       onClick={handleConfirmImageGeneration}
320 |                       disabled={isGeneratingIllustrated}
321 |                       className="bg-orange-600 hover:bg-orange-700 text-white"
322 |                       size="sm"
323 |                     >
324 |                       <CheckCircle className="h-4 w-4 mr-2" />
325 |                       Sí, generar imágenes
326 |                     </Button>
327 |                     <Button
328 |                       onClick={handleCancelGeneration}
329 |                       variant="outline"
330 |                       size="sm"
331 |                     >
332 |                       Cancelar
333 |                     </Button>
334 |                   </div>
335 |                 </div>
336 |               </div>
337 |             </div>
338 |           )}
339 |           */}
340 | 
341 |           {error && (
342 |             <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg">
343 |               {error}
344 |             </div>
345 |           )}
346 | 
347 |           {/* Opciones de generación */}
348 |           <div className="mb-4">
349 |             <h3 className="text-lg font-semibold mb-3 text-gray-800">Generar PDF:</h3>
350 | 
351 |             {/* Opción 1: Formato FantasIA */}
352 |             <div className="mb-3 p-4 border border-pink-200 rounded-lg bg-pink-50">
353 |               <div className="flex items-center justify-between">
354 |                 <div className="flex-1">
355 |                   <div className="flex items-center mb-2">
356 |                     <FileText className="h-5 w-5 text-pink-600 mr-2" />
357 |                     <h4 className="font-semibold text-pink-800">Cuento Formato Fantasia!</h4>
358 |                     <span className="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
359 |                       GRATIS
360 |                     </span>
361 |                   </div>
362 |                   <p className="text-sm text-pink-700">
363 |                     PDF con el formato tradicional de Fantasia (solo texto)
364 |                   </p>
365 |                 </div>
366 |                 <Button
367 |                   onClick={handleGenerateStandard}
368 |                   disabled={isGenerating}
369 |                   className="ml-4 bg-[#F6A5B7] hover:bg-[#F6A5B7]/90"
370 |                 >
371 |                   {isGenerating ? (
372 |                     <>
373 |                       <Loader2 className="mr-2 h-4 w-4 animate-spin" />
374 |                       Generando...
375 |                     </>
376 |                   ) : (
377 |                     <>Generar</>
378 |                   )}
379 |                 </Button>
380 |               </div>
381 |             </div>
382 | 
383 |             {/* Opción 2: Cuento Ilustrado - COMENTADO PARA DEMO */}
384 |             {/* 
385 |             <div className="p-4 border border-purple-200 rounded-lg bg-purple-50">
386 |               <div className="flex items-center justify-between">
387 |                 <div className="flex-1">
388 |                   <div className="flex items-center mb-2">
389 |                     <Palette className="h-5 w-5 text-purple-600 mr-2" />
390 |                     <h4 className="font-semibold text-purple-800">Cuento Ilustrado</h4>
391 |                     <span className="ml-2 px-2 py-1 bg-purple-100 text-purple-800 text-xs font-medium rounded-full">
392 |                       8,99€
393 |                     </span>
394 |                   </div>
395 |                   <p className="text-sm text-purple-700">
396 |                     PDF con imágenes generadas por IA que ilustran el cuento
397 |                   </p>
398 |                 </div>
399 |                 <Button
400 |                   onClick={handleGenerateIllustrated}
401 |                   disabled={isGeneratingIllustrated || isGenerating || isValidatingImages || showConfirmGeneration}
402 |                   className="ml-4 bg-purple-600 hover:bg-purple-700"
403 |                 >
404 |                   {isValidatingImages ? (
405 |                     <>
406 |                       <Loader2 className="mr-2 h-4 w-4 animate-spin" />
407 |                       Validando...
408 |                     </>
409 |                   ) : isGeneratingIllustrated ? (
410 |                     <>
411 |                       <Loader2 className="mr-2 h-4 w-4 animate-spin" />
412 |                       Generando...
413 |                     </>
414 |                   ) : (
415 |                     <>Generar</>
416 |                   )}
417 |                 </Button>
418 |               </div>
419 |             </div>
420 |             */}
421 |           </div>
422 | 
423 |           <div className="flex justify-end">
424 |             <Button
425 |               variant="outline"
426 |               onClick={onClose}
427 |               disabled={isGenerating}
428 |             >
429 |               Cancelar
430 |             </Button>
431 |           </div>
432 |         </div>
433 |       </div>
434 |     </div>
435 |   );
436 | }
437 | 
438 | // NOTA: Las siguientes funciones están temporalmente comentadas para la demo
439 | // pero siguen disponibles para cuando se reactive la funcionalidad ilustrada:
440 | // - handleGenerateIllustrated
441 | // - handleConfirmImageGeneration
442 | // - generateIllustratedPdfDirectly
443 | // - handleCancelGeneration
444 | // - Estados: isGeneratingIllustrated, isValidatingImages, needsImageGeneration, 
445 | //   showConfirmGeneration, imageValidationResult, generationProgress
```

src/components/VoiceSettings.tsx
```
1 | import { useState, useEffect } from 'react';
2 | import { Volume2, ChevronDown, AlertCircle } from 'lucide-react';
3 | import { getAvailableVoices } from '../services/ai/ttsService';
4 | import { useUserStore } from '../store/user/userStore';
5 | 
6 | interface Voice {
7 |   id: string;
8 |   description: string;
9 | }
10 | 
11 | interface VoiceSettingsProps {
12 |   onSettingsChange: (settings: {
13 |     voiceId: string;
14 |   }) => void;
15 |   className?: string;
16 | }
17 | 
18 | export default function VoiceSettings({ onSettingsChange, className = '' }: VoiceSettingsProps) {
19 |   const [isOpen, setIsOpen] = useState(false);
20 |   const [voices, setVoices] = useState<Voice[]>([]);
21 |   const [selectedVoice, setSelectedVoice] = useState<Voice | null>(null);
22 |   const [isLoading, setIsLoading] = useState(true);
23 |   
24 |   // Obtener selectores del userStore
25 |   const { 
26 |     isPremium, 
27 |     canGenerateVoice, 
28 |     getRemainingMonthlyVoiceGenerations, 
29 |     getAvailableVoiceCredits 
30 |   } = useUserStore();
31 | 
32 |   // Cargar las voces disponibles
33 |   useEffect(() => {
34 |     const loadVoices = async () => {
35 |       setIsLoading(true);
36 |       try {
37 |         const availableVoices = await getAvailableVoices();
38 |         setVoices(availableVoices);
39 |         
40 |         // Seleccionar la primera voz por defecto
41 |         const defaultVoice = availableVoices[0];
42 |         setSelectedVoice(defaultVoice);
43 |         
44 |         onSettingsChange({
45 |           voiceId: defaultVoice.id
46 |         });
47 |       } catch (error) {
48 |         console.error('Error cargando voces:', error);
49 |       } finally {
50 |         setIsLoading(false);
51 |       }
52 |     };
53 |     
54 |     loadVoices();
55 |   }, []);
56 | 
57 |   const handleVoiceChange = (voice: Voice) => {
58 |     setSelectedVoice(voice);
59 |     onSettingsChange({
60 |       voiceId: voice.id
61 |     });
62 |     setIsOpen(false);
63 |   };
64 | 
65 |   const toggleSettings = () => {
66 |     setIsOpen(!isOpen);
67 |   };
68 | 
69 |   // Obtener información de límites
70 |   const remainingMonthly = getRemainingMonthlyVoiceGenerations();
71 |   const availableCredits = getAvailableVoiceCredits();
72 |   const canGenerate = canGenerateVoice();
73 | 
74 |   return (
75 |     <div className={`voice-settings ${className}`}>
76 |       <div className="text-center mb-2 text-white/90 text-sm font-medium">
77 |         Personalizar narración
78 |       </div>
79 |       
80 |       <div className="mb-6 relative">
81 |         <button
82 |           onClick={toggleSettings}
83 |           className="w-full flex items-center justify-between p-4 bg-white/10 hover:bg-white/15 rounded-xl text-white text-sm backdrop-blur-md focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
84 |           disabled={isLoading || !selectedVoice}
85 |         >
86 |           <div className="flex items-center gap-2">
87 |             <Volume2 size={18} className="text-purple-200" />
88 |             <span>{selectedVoice?.description || 'Cargando voces...'}</span>
89 |           </div>
90 |           <ChevronDown size={18} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} />
91 |         </button>
92 |         
93 |         {isOpen && (
94 |           <div className="absolute mt-1 w-full rounded-xl p-2 bg-white/10 backdrop-blur-xl z-10 animate-fadeIn shadow-xl">
95 |             {voices.map((voice) => (
96 |               <button
97 |                 key={voice.id}
98 |                 onClick={() => handleVoiceChange(voice)}
99 |                 className={`w-full text-left p-3 my-1 rounded-lg flex items-center transition-colors hover:bg-white/10 ${
100 |                   selectedVoice?.id === voice.id ? 'bg-white/20 font-medium' : ''
101 |                 }`}
102 |               >
103 |                 <span className={`h-2 w-2 rounded-full mr-3 ${voice.description.includes('Femenina') ? 'bg-pink-400' : 'bg-blue-400'}`}></span>
104 |                 {voice.description}
105 |               </button>
106 |             ))}
107 |           </div>
108 |         )}
109 |       </div>
110 |       
111 |       {/* Información de límites de generación de voz */}
112 |       {isPremium() ? (
113 |         <div className="text-center text-sm text-white/80">
114 |           {canGenerate ? (
115 |             <div className="flex flex-col gap-1">
116 |               <div className="font-medium text-green-300">
117 |                 {remainingMonthly > 0 ? (
118 |                   <span>Te quedan {remainingMonthly} generaciones gratuitas</span>
119 |                 ) : (
120 |                   <span>Has usado todas tus generaciones mensuales</span>
121 |                 )}
122 |               </div>
123 |               {availableCredits > 0 && (
124 |                 <div className="text-purple-300">
125 |                   Tienes {availableCredits} créditos adicionales
126 |                 </div>
127 |               )}
128 |             </div>
129 |           ) : (
130 |             <div className="flex items-center justify-center gap-2 text-amber-300">
131 |               <AlertCircle size={16} />
132 |               <span>Necesitas comprar más créditos para generar audio</span>
133 |             </div>
134 |           )}
135 |         </div>
136 |       ) : (
137 |         <div className="text-center text-sm text-amber-300 flex items-center justify-center gap-2">
138 |           <AlertCircle size={16} />
139 |           <span>Necesitas una suscripción premium para narrar historias</span>
140 |         </div>
141 |       )}
142 |     </div>
143 |   );
144 | }
```

src/components/WaveForm.tsx
```
1 | import { useEffect, useRef } from "react";
2 | 
3 | interface WaveFormProps {
4 |   isPlaying: boolean;
5 |   color: string;
6 |   intensity?: number;
7 | }
8 | 
9 | function hexToRgb(hex: string) {
10 |   const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
11 |   return result
12 |     ? {
13 |         r: parseInt(result[1], 16),
14 |         g: parseInt(result[2], 16),
15 |         b: parseInt(result[3], 16)
16 |       }
17 |     : null;
18 | }
19 | 
20 | export const WaveForm = ({ isPlaying, color, intensity = 0.5 }: WaveFormProps) => {
21 |   const canvasRef = useRef<HTMLCanvasElement>(null);
22 |   const animationRef = useRef<number | null>(null);
23 |   const intensityRef = useRef(intensity);
24 | 
25 |   useEffect(() => {
26 |     intensityRef.current = intensity;
27 |   }, [intensity]);
28 | 
29 |   useEffect(() => {
30 |     const canvas = canvasRef.current;
31 |     if (!canvas) return;
32 | 
33 |     const ctx = canvas.getContext('2d');
34 |     if (!ctx) return;
35 | 
36 |     const dpr = window.devicePixelRatio || 1;
37 |     const parentWidth = canvas.parentElement?.clientWidth || window.innerWidth;
38 |     const parentHeight = canvas.parentElement?.clientHeight || 300;
39 | 
40 |     canvas.width = parentWidth * dpr;
41 |     canvas.height = parentHeight * dpr;
42 |     canvas.style.width = `${parentWidth}px`;
43 |     canvas.style.height = `${parentHeight}px`;
44 | 
45 |     ctx.scale(dpr, dpr);
46 | 
47 |     // Handle window resize
48 |     const handleResize = () => {
49 |       const parentWidth = canvas.parentElement?.clientWidth || window.innerWidth;
50 |       const parentHeight = canvas.parentElement?.clientHeight || 300;
51 | 
52 |       canvas.width = parentWidth * dpr;
53 |       canvas.height = parentHeight * dpr;
54 |       canvas.style.width = `${parentWidth}px`;
55 |       canvas.style.height = `${parentHeight}px`;
56 | 
57 |       ctx.scale(dpr, dpr);
58 |     };
59 | 
60 |     window.addEventListener('resize', handleResize);
61 | 
62 |     const rgb = hexToRgb(color);
63 | 
64 |     // Number of particles
65 |     const particleCount = 30;
66 |     const particles: {
67 |       x: number;
68 |       y: number;
69 |       radius: number;
70 |       originalRadius: number;
71 |       speed: number;
72 |       angle: number;
73 |       opacity: number;
74 |       pulseSpeed: number;
75 |     }[] = [];
76 | 
77 |     // Initialize particles
78 |     for (let i = 0; i < particleCount; i++) {
79 |       const centerX = canvas.width / dpr / 2;
80 |       const centerY = canvas.height / dpr / 2;
81 | 
82 |       // Create particles in circular pattern around center
83 |       const angle = Math.random() * Math.PI * 2;
84 |       const distance = 20 + Math.random() * (Math.min(centerX, centerY) * 0.6);
85 | 
86 |       particles.push({
87 |         x: centerX + Math.cos(angle) * distance,
88 |         y: centerY + Math.sin(angle) * distance,
89 |         radius: 5 + Math.random() * 20,
90 |         originalRadius: 5 + Math.random() * 20,
91 |         speed: 0.2 + Math.random() * 0.5,
92 |         angle: Math.random() * Math.PI * 2,
93 |         opacity: 0.2 + Math.random() * 0.3,
94 |         pulseSpeed: 0.01 + Math.random() * 0.03
95 |       });
96 |     }
97 | 
98 |     let phase = 0;
99 | 
100 |     // Animation loop
101 |     const animate = () => {
102 |       if (!canvas || !ctx) return;
103 | 
104 |       // Clear canvas with a subtle background
105 |       ctx.fillStyle = rgb ?
106 |         `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.05)` :
107 |         'rgba(100, 100, 255, 0.05)';
108 |       ctx.fillRect(0, 0, canvas.width / dpr, canvas.height / dpr);
109 | 
110 |       // Update phase
111 |       phase += isPlaying ? 0.02 : 0.005;
112 | 
113 |       // Center coordinates
114 |       const centerX = canvas.width / dpr / 2;
115 |       const centerY = canvas.height / dpr / 2;
116 | 
117 |       // Draw central pulsing circle
118 |       const basePulse = isPlaying ?
119 |         0.6 + Math.sin(phase * 2) * 0.2 * intensityRef.current :
120 |         0.7 + Math.sin(phase) * 0.1;
121 | 
122 |       const mainRadius = Math.min(centerX, centerY) * 0.3 * basePulse;
123 | 
124 |       // Central glow
125 |       const gradient = ctx.createRadialGradient(
126 |         centerX, centerY, 0,
127 |         centerX, centerY, mainRadius * 2
128 |       );
129 | 
130 |       if (rgb) {
131 |         gradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${isPlaying ? 0.3 : 0.15})`);
132 |         gradient.addColorStop(0.5, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${isPlaying ? 0.1 : 0.05})`);
133 |         gradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0)`);
134 |       } else {
135 |         gradient.addColorStop(0, `rgba(100, 100, 255, ${isPlaying ? 0.3 : 0.15})`);
136 |         gradient.addColorStop(0.5, `rgba(100, 100, 255, ${isPlaying ? 0.1 : 0.05})`);
137 |         gradient.addColorStop(1, 'rgba(100, 100, 255, 0)');
138 |       }
139 | 
140 |       ctx.fillStyle = gradient;
141 |       ctx.beginPath();
142 |       ctx.arc(centerX, centerY, mainRadius * 2, 0, Math.PI * 2);
143 |       ctx.fill();
144 | 
145 |       // Draw main circle
146 |       ctx.beginPath();
147 |       ctx.arc(centerX, centerY, mainRadius, 0, Math.PI * 2);
148 |       ctx.fillStyle = rgb ?
149 |         `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${isPlaying ? 0.4 : 0.2})` :
150 |         `rgba(100, 100, 255, ${isPlaying ? 0.4 : 0.2})`;
151 |       ctx.fill();
152 | 
153 |       // Draw and update particles
154 |       particles.forEach((particle, index) => {
155 |         // Create orbital movement
156 |         if (isPlaying) {
157 |           // More dynamic movement when playing
158 |           particle.angle += particle.speed * 0.02;
159 | 
160 |           // Pulse radius based on audio intensity
161 |           const pulseIntensity = intensityRef.current *
162 |             (0.5 + 0.5 * Math.sin(phase * 3 + index * 0.2));
163 | 
164 |           particle.radius = particle.originalRadius *
165 |             (0.8 + 0.4 * pulseIntensity * Math.sin(phase * particle.pulseSpeed * 10));
166 | 
167 |           // Dynamic opacity based on audio intensity
168 |           particle.opacity = 0.2 + 0.3 * intensityRef.current * Math.sin(phase * 2 + index * 0.1);
169 |         } else {
170 |           // Slower, more subtle movement when paused
171 |           particle.angle += particle.speed * 0.005;
172 | 
173 |           // Gentle pulsing when paused
174 |           particle.radius = particle.originalRadius * (0.9 + 0.1 * Math.sin(phase + index * 0.1));
175 |           particle.opacity = 0.1 + 0.1 * Math.sin(phase * 0.5 + index * 0.05);
176 |         }
177 | 
178 |         // Calculate particle position based on orbital movement
179 |         const orbitRadius = 20 + index % 3 * 40;
180 |         const orbitX = centerX + Math.cos(particle.angle) * orbitRadius;
181 |         const orbitY = centerY + Math.sin(particle.angle) * orbitRadius;
182 | 
183 |         // Add some wobble to the orbit
184 |         const wobble = isPlaying ?
185 |           Math.sin(phase * 2 + index) * 5 * intensityRef.current :
186 |           Math.sin(phase + index) * 2;
187 | 
188 |         particle.x = orbitX + wobble * Math.cos(particle.angle * 2);
189 |         particle.y = orbitY + wobble * Math.sin(particle.angle * 3);
190 | 
191 |         // Draw particle with gradient
192 |         const particleGradient = ctx.createRadialGradient(
193 |           particle.x, particle.y, 0,
194 |           particle.x, particle.y, particle.radius
195 |         );
196 | 
197 |         if (rgb) {
198 |           particleGradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${particle.opacity})`);
199 |           particleGradient.addColorStop(0.6, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${particle.opacity * 0.5})`);
200 |           particleGradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0)`);
201 |         } else {
202 |           particleGradient.addColorStop(0, `rgba(100, 100, 255, ${particle.opacity})`);
203 |           particleGradient.addColorStop(0.6, `rgba(100, 100, 255, ${particle.opacity * 0.5})`);
204 |           particleGradient.addColorStop(1, 'rgba(100, 100, 255, 0)');
205 |         }
206 | 
207 |         ctx.beginPath();
208 |         ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
209 |         ctx.fillStyle = particleGradient;
210 |         ctx.fill();
211 | 
212 |         // Occasionally connect particles with lines when playing
213 |         if (isPlaying && Math.random() > 0.97) {
214 |           const nearestParticleIndex = (index + 1) % particles.length;
215 |           const nearestParticle = particles[nearestParticleIndex];
216 | 
217 |           ctx.beginPath();
218 |           ctx.moveTo(particle.x, particle.y);
219 |           ctx.lineTo(nearestParticle.x, nearestParticle.y);
220 |           ctx.strokeStyle = rgb ?
221 |             `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)` :
222 |             'rgba(100, 100, 255, 0.2)';
223 |           ctx.lineWidth = 1;
224 |           ctx.stroke();
225 |         }
226 |       });
227 | 
228 |       animationRef.current = requestAnimationFrame(animate);
229 |     };
230 | 
231 |     // Start animation
232 |     animate();
233 | 
234 |     // Cleanup function
235 |     return () => {
236 |       if (animationRef.current) {
237 |         cancelAnimationFrame(animationRef.current);
238 |       }
239 |       window.removeEventListener('resize', handleResize);
240 |     };
241 |   }, [isPlaying, color]);
242 | 
243 |   return (
244 |     <canvas
245 |       ref={canvasRef}
246 |       className="absolute top-0 left-0 w-full h-full"
247 |     />
248 |   );
249 | };
250 | 
251 | export default WaveForm; 
```

src/config/app.ts
```
1 | /**
2 |  * Configuración global de la aplicación
3 |  * Este archivo contiene parámetros y configuraciones globales que pueden ser utilizados en toda la app
4 |  */
5 | 
6 | export const APP_CONFIG = {
7 |   /**
8 |    * Versión actual de la aplicación
9 |    * Formato: major.minor.patch
10 |    */
11 |   version: '1.1.3',
12 | 
13 |   /**
14 |    * Nombre de la aplicación
15 |    */
16 |   name: 'Fantasia',
17 |   
18 |   /**
19 |    * URL del sitio web
20 |    */
21 |   websiteUrl: 'https://fantasia.app',
22 |   
23 |   /**
24 |    * Enlaces de redes sociales
25 |    */
26 |   socialLinks: {
27 |     twitter: 'https://twitter.com/fantasia_app',
28 |     instagram: 'https://instagram.com/fantasia_app',
29 |     facebook: 'https://facebook.com/fantasiaapp'
30 |   },
31 | 
32 |   /**
33 |    * URLs del footer
34 |    */
35 |   footerLinks: {
36 |     terms: '/terms',
37 |     privacy: '/privacy-policy',
38 |     contact: '/contact',
39 |     changelog: '/changelog'
40 |   }
41 | }; 
```

src/constants/story-images.constant.ts
```
1 | export const SYSTEM_PROMPT_BASE = `Quiero generar tres imágenes a partir de el siguiente cuento que posea las siguientes caráterísticas: **Estilo de la imagen, artístico en acuarela**: La idea es que el diseño de las imágenes parezcan hechas a mano, pintadas en acuarela o creyón, para mantener un estilo de dibujo de cuento tradicional. **Deben mantener el mismo estilos las imágenes**: Se debe mantener una concordancia en las imagenes generadas, con el fin de que mantenga una linea histórica del cuento. **Contenido del cuento para la idea**: Tomaremos el contenido del cuento para crear cuatro imágenes, una imagen para la "PORTADA", dos imágenes de las ESCENAS mas importante del cuento con la misma estética y que siga la misma línea del personaje principal.`
2 | 
3 | export const IMAGES_TYPE = {
4 |     COVER: "cover",
5 |     SCENE_1: "scene_1",
6 |     SCENE_2: "scene_2",
7 |     CHARACTER: "character",
8 | }
```

src/constants/story-voices.constant.ts
```
1 | export const STORY_VOICES = [
2 |     {
3 |       id: "el-sabio",
4 |       name: "El Sabio",
5 |       description: "Voz grave y serena, ideal para transmitir conocimiento.",
6 |       color: "#a5d6f6", // Indigo-600
7 |       gradientFrom: "#6366f1", // Indigo-500
8 |       gradientTo: "#3730a3", // Indigo-800
9 |       speed: 0.50,
10 |       icon: "📚",
11 |       preview: "📚 El Sabio: “Hola, soy El Sabio, con mi voz grave y serena te acompañaré en este viaje de conocimiento.”",
12 |       instructions: "El Sabio: Velocidad 0.50; pausa 250 ms antes y después de frases clave; entonación descendente al final de oraciones; Lee este texto con acento castellano muy marcado propias de un hablante nativo de España; añadir susurro de hojas al 10 % de volumen; realzar 100–300 Hz y atenuar >6 kHz; inhalaciones sutiles antes de pasajes largos."
13 |     },
14 |   
15 |     {
16 |       id: "la-hada",
17 |       name: "La Hada",
18 |       description: "Voz suave y dulce, perfecta para historias emocionales y de aprendizaje.",
19 |       color: "#f6a5b7", // Rose-600
20 |       gradientFrom: "#f43f5e", // Rose-500
21 |       gradientTo: "#be123c", // Rose-700
22 |       speed: 1.00,
23 |       icon: "👸",
24 |       preview: "👸 La Hada: “Soy La Hada, mi voz suave y dulce te envolverá en cada emoción y enseñanza.”",
25 |       instructions: "La Hada: Velocidad 1.00; pausas de 150 ms tras frases emotivas; subir tono en picos emocionales y alargar vocales ‘a’ y ‘o’; Lee este texto con acento castellano muy marcado propias de un hablante nativo de España; campanillas al 8 % de volumen; realzar 3–6 kHz; respiraciones antes de frases conmovedoras."
26 |     },
27 |   
28 |     {
29 |       id: "el-animado",
30 |       name: "El Animado",
31 |       description: "Voz aguda y caricaturesca, ideal para historias divertidas.",
32 |       color: "#f7c59f", // Green-600
33 |       gradientFrom: "#22c55e", // Green-500
34 |       gradientTo: "#16a34a", // Green-700
35 |       speed: 1.20,
36 |       icon: "🎭",
37 |       preview: "🎭 El Animado: “¡Ey, qué tal! Soy El Animado, con mi tono alegre y caricaturesco haré de esta historia una fiesta.”",
38 |       instructions: "El Animado: Velocidad 1.20; pausas de 100 ms entre frases; cambios rápidos de entonación en exclamaciones y preguntas; Lee este texto con acento castellano muy marcado propias de un hablante nativo de España; risas y aplausos al 12 % de volumen; realzar 1–2 kHz; inhalaciones cortas antes de exclamaciones."
39 |     }
40 |   ];
41 |   
42 | export const SYSTEM_PROMPT = "Eres un narrador profesional de cuentos infantiles en castellano de España, con pronunciación clara de la z como /θ/ y la s como /s/. Adapta tu ritmo y entonación al personaje";
43 | 
44 | export const CUSTOM_VOICE_MAPPING = {
45 |   "el-sabio": "ash",
46 |   "la-hada": "sage",
47 |   "el-animado": "ballad",
48 | };
49 | 
50 | export const PREVIEW_FILES: Record<string, string> = {
51 |   "el-sabio": "/previews/sabio.mp3",
52 |   "la-hada": "/previews/hada.mp3",
53 |   "el-animado": "/previews/animado.mp3"
54 | };
55 | 
56 | export const PLAYBACK_SPEEDS = [0.75, 1, 1.25, 1.5, 1.75, 2];
```

src/hooks/use-mobile.tsx
```
1 | import * as React from "react"
2 | 
3 | const MOBILE_BREAKPOINT = 768
4 | 
5 | export function useIsMobile() {
6 |   const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)
7 | 
8 |   React.useEffect(() => {
9 |     const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
10 |     const onChange = () => {
11 |       setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
12 |     }
13 |     mql.addEventListener("change", onChange)
14 |     setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
15 |     return () => mql.removeEventListener("change", onChange)
16 |   }, [])
17 | 
18 |   return !!isMobile
19 | }
```

src/hooks/use-toast.ts
```
1 | import * as React from "react"
2 | 
3 | import type {
4 |   ToastActionElement,
5 |   ToastProps,
6 | } from "@/components/ui/toast"
7 | 
8 | const TOAST_LIMIT = 1
9 | const TOAST_REMOVE_DELAY = 1000000
10 | 
11 | type ToasterToast = ToastProps & {
12 |   id: string
13 |   title?: React.ReactNode
14 |   description?: React.ReactNode
15 |   action?: ToastActionElement
16 | }
17 | 
18 | const actionTypes = {
19 |   ADD_TOAST: "ADD_TOAST",
20 |   UPDATE_TOAST: "UPDATE_TOAST",
21 |   DISMISS_TOAST: "DISMISS_TOAST",
22 |   REMOVE_TOAST: "REMOVE_TOAST",
23 | } as const
24 | 
25 | let count = 0
26 | 
27 | function genId() {
28 |   count = (count + 1) % Number.MAX_SAFE_INTEGER
29 |   return count.toString()
30 | }
31 | 
32 | type ActionType = typeof actionTypes
33 | 
34 | type Action =
35 |   | {
36 |       type: ActionType["ADD_TOAST"]
37 |       toast: ToasterToast
38 |     }
39 |   | {
40 |       type: ActionType["UPDATE_TOAST"]
41 |       toast: Partial<ToasterToast>
42 |     }
43 |   | {
44 |       type: ActionType["DISMISS_TOAST"]
45 |       toastId?: ToasterToast["id"]
46 |     }
47 |   | {
48 |       type: ActionType["REMOVE_TOAST"]
49 |       toastId?: ToasterToast["id"]
50 |     }
51 | 
52 | interface State {
53 |   toasts: ToasterToast[]
54 | }
55 | 
56 | const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()
57 | 
58 | const addToRemoveQueue = (toastId: string) => {
59 |   if (toastTimeouts.has(toastId)) {
60 |     return
61 |   }
62 | 
63 |   const timeout = setTimeout(() => {
64 |     toastTimeouts.delete(toastId)
65 |     dispatch({
66 |       type: "REMOVE_TOAST",
67 |       toastId: toastId,
68 |     })
69 |   }, TOAST_REMOVE_DELAY)
70 | 
71 |   toastTimeouts.set(toastId, timeout)
72 | }
73 | 
74 | export const reducer = (state: State, action: Action): State => {
75 |   switch (action.type) {
76 |     case "ADD_TOAST":
77 |       return {
78 |         ...state,
79 |         toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
80 |       }
81 | 
82 |     case "UPDATE_TOAST":
83 |       return {
84 |         ...state,
85 |         toasts: state.toasts.map((t) =>
86 |           t.id === action.toast.id ? { ...t, ...action.toast } : t
87 |         ),
88 |       }
89 | 
90 |     case "DISMISS_TOAST": {
91 |       const { toastId } = action
92 | 
93 |       // ! Side effects ! - This could be extracted into a dismissToast() action,
94 |       // but I'll keep it here for simplicity
95 |       if (toastId) {
96 |         addToRemoveQueue(toastId)
97 |       } else {
98 |         state.toasts.forEach((toast) => {
99 |           addToRemoveQueue(toast.id)
100 |         })
101 |       }
102 | 
103 |       return {
104 |         ...state,
105 |         toasts: state.toasts.map((t) =>
106 |           t.id === toastId || toastId === undefined
107 |             ? {
108 |                 ...t,
109 |                 open: false,
110 |               }
111 |             : t
112 |         ),
113 |       }
114 |     }
115 |     case "REMOVE_TOAST":
116 |       if (action.toastId === undefined) {
117 |         return {
118 |           ...state,
119 |           toasts: [],
120 |         }
121 |       }
122 |       return {
123 |         ...state,
124 |         toasts: state.toasts.filter((t) => t.id !== action.toastId),
125 |       }
126 |   }
127 | }
128 | 
129 | const listeners: Array<(state: State) => void> = []
130 | 
131 | let memoryState: State = { toasts: [] }
132 | 
133 | function dispatch(action: Action) {
134 |   memoryState = reducer(memoryState, action)
135 |   listeners.forEach((listener) => {
136 |     listener(memoryState)
137 |   })
138 | }
139 | 
140 | type Toast = Omit<ToasterToast, "id">
141 | 
142 | function toast({ ...props }: Toast) {
143 |   const id = genId()
144 | 
145 |   const update = (props: ToasterToast) =>
146 |     dispatch({
147 |       type: "UPDATE_TOAST",
148 |       toast: { ...props, id },
149 |     })
150 |   const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })
151 | 
152 |   dispatch({
153 |     type: "ADD_TOAST",
154 |     toast: {
155 |       ...props,
156 |       id,
157 |       open: true,
158 |       onOpenChange: (open) => {
159 |         if (!open) dismiss()
160 |       },
161 |     },
162 |   })
163 | 
164 |   return {
165 |     id: id,
166 |     dismiss,
167 |     update,
168 |   }
169 | }
170 | 
171 | function useToast() {
172 |   const [state, setState] = React.useState<State>(memoryState)
173 | 
174 |   React.useEffect(() => {
175 |     listeners.push(setState)
176 |     return () => {
177 |       const index = listeners.indexOf(setState)
178 |       if (index > -1) {
179 |         listeners.splice(index, 1)
180 |       }
181 |     }
182 |   }, [state])
183 | 
184 |   return {
185 |     ...state,
186 |     toast,
187 |     dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
188 |   }
189 | }
190 | 
191 | export { useToast, toast }
```

src/hooks/useChangelog.ts
```
1 | import { useState, useEffect } from 'react';
2 | import { parseChangelog, type ChangelogEntry } from '@/lib/utils';
3 | import changelogContent from '../../CHANGELOG.md?raw';
4 | 
5 | interface UseChangelogReturn {
6 |   changelogData: ChangelogEntry[];
7 |   isLoading: boolean;
8 |   error: string | null;
9 | }
10 | 
11 | export function useChangelog(): UseChangelogReturn {
12 |   const [changelogData, setChangelogData] = useState<ChangelogEntry[]>([]);
13 |   const [isLoading, setIsLoading] = useState(true);
14 |   const [error, setError] = useState<string | null>(null);
15 | 
16 |   useEffect(() => {
17 |     const loadChangelog = async () => {
18 |       try {
19 |         setIsLoading(true);
20 |         setError(null);
21 |         
22 |         // Parsear el contenido del archivo CHANGELOG.md
23 |         const parsedData = parseChangelog(changelogContent);
24 |         setChangelogData(parsedData);
25 |       } catch (err) {
26 |         console.error('Error parsing changelog:', err);
27 |         setError(err instanceof Error ? err.message : 'Error desconocido al cargar el changelog');
28 |         setChangelogData([]);
29 |       } finally {
30 |         setIsLoading(false);
31 |       }
32 |     };
33 | 
34 |     loadChangelog();
35 |   }, []);
36 | 
37 |   return {
38 |     changelogData,
39 |     isLoading,
40 |     error
41 |   };
42 | } 
```

src/lib/utils.ts
```
1 | import { clsx, type ClassValue } from "clsx"
2 | import { twMerge } from "tailwind-merge"
3 | import { toast } from "sonner"
4 | 
5 | export function cn(...inputs: ClassValue[]) {
6 |   return twMerge(clsx(inputs))
7 | }
8 | 
9 | export function parseTextToParagraphs(content: string): string[] {
10 |   return content
11 |     .split('\n')
12 |     .map(paragraph => paragraph.trim())
13 |     .filter(paragraph => paragraph.length > 0);
14 | }
15 | 
16 | let lastToastId: string | number | null = null;
17 | let lastToastMessage: string | null = null;
18 | 
19 | export const toastManager = {
20 |   show: (type: 'success' | 'error' | 'info' | 'warning', message: string, description?: string, force = false) => {
21 |     if (!force && lastToastMessage === message) {
22 |       return lastToastId;
23 |     }
24 | 
25 |     if (lastToastId) {
26 |       toast.dismiss(lastToastId);
27 |     }
28 | 
29 |     let toastId: string | number;
30 |     
31 |     switch (type) {
32 |       case 'success':
33 |         toastId = toast.success(message, description ? { description } : undefined);
34 |         break;
35 |       case 'error':
36 |         toastId = toast.error(message, description ? { description } : undefined);
37 |         break;
38 |       case 'info':
39 |         toastId = toast.info(message, description ? { description } : undefined);
40 |         break;
41 |       case 'warning':
42 |         toastId = toast.warning(message, description ? { description } : undefined);
43 |         break;
44 |       default:
45 |         toastId = toast(message, description ? { description } : undefined);
46 |     }
47 | 
48 |     lastToastId = toastId;
49 |     lastToastMessage = message;
50 |     
51 |     return toastId;
52 |   },
53 |   
54 |   clear: () => {
55 |     if (lastToastId) {
56 |       toast.dismiss(lastToastId);
57 |       lastToastId = null;
58 |       lastToastMessage = null;
59 |     }
60 |   },
61 |   
62 |   clearAll: () => {
63 |     toast.dismiss();
64 |     lastToastId = null;
65 |     lastToastMessage = null;
66 |   }
67 | };
68 | 
69 | // Interfaces para el changelog
70 | export interface ChangelogEntry {
71 |   version: string;
72 |   date: string;
73 |   features?: string[];
74 |   improvements?: string[];
75 |   technical?: string[];
76 |   fixes?: string[];
77 | }
78 | 
79 | // Parser del changelog markdown
80 | export function parseChangelog(markdownContent: string): ChangelogEntry[] {
81 |   const entries: ChangelogEntry[] = [];
82 |   const lines = markdownContent.split('\n');
83 |   
84 |   let currentEntry: Partial<ChangelogEntry> | null = null;
85 |   let currentSection: 'features' | 'improvements' | 'technical' | 'fixes' | null = null;
86 |   
87 |   for (const line of lines) {
88 |     const trimmedLine = line.trim();
89 |     
90 |     // Saltar líneas vacías o que no son relevantes
91 |     if (!trimmedLine || trimmedLine.startsWith('#') && !trimmedLine.startsWith('##')) {
92 |       continue;
93 |     }
94 |     
95 |     // Detectar nueva versión (formato: ## [1.1.3] - 2024-12-19)
96 |     const versionMatch = trimmedLine.match(/^##\s*\[([^\]]+)\]\s*-\s*(.+)$/);
97 |     if (versionMatch) {
98 |       // Guardar entry anterior si existe
99 |       if (currentEntry && currentEntry.version && currentEntry.date) {
100 |         entries.push(currentEntry as ChangelogEntry);
101 |       }
102 |       
103 |       // Crear nueva entry
104 |       currentEntry = {
105 |         version: versionMatch[1],
106 |         date: versionMatch[2].trim(),
107 |       };
108 |       currentSection = null;
109 |       continue;
110 |     }
111 |     
112 |     // Detectar secciones (### Mejoras, ### Cambios Técnicos, etc.)
113 |     const sectionMatch = trimmedLine.match(/^###\s*(.+)$/);
114 |     if (sectionMatch && currentEntry) {
115 |       const sectionTitle = sectionMatch[1].toLowerCase();
116 |       
117 |       if (sectionTitle.includes('mejoras') || sectionTitle.includes('improvements')) {
118 |         currentSection = 'improvements';
119 |         currentEntry.improvements = [];
120 |       } else if (sectionTitle.includes('técnicos') || sectionTitle.includes('cambios técnicos') || sectionTitle.includes('technical')) {
121 |         currentSection = 'technical';
122 |         currentEntry.technical = [];
123 |       } else if (sectionTitle.includes('correcciones') || sectionTitle.includes('fix') || sectionTitle.includes('bugs')) {
124 |         currentSection = 'fixes';
125 |         currentEntry.fixes = [];
126 |       } else if (sectionTitle.includes('añadido') || sectionTitle.includes('funcionalidades') || sectionTitle.includes('features') || sectionTitle.includes('nuevo')) {
127 |         currentSection = 'features';
128 |         currentEntry.features = [];
129 |       }
130 |       continue;
131 |     }
132 |     
133 |     // Detectar items de lista (- **item**: descripción o - item)
134 |     const listItemMatch = trimmedLine.match(/^-\s*(.+)$/);
135 |     if (listItemMatch && currentEntry && currentSection) {
136 |       let itemText = listItemMatch[1];
137 |       
138 |       // Limpiar markdown (quitar ** y otros formatos)
139 |       itemText = itemText
140 |         .replace(/\*\*(.*?)\*\*/g, '$1') // bold
141 |         .replace(/`(.*?)`/g, '$1') // code
142 |         .replace(/\[(.*?)\]\(.*?\)/g, '$1') // links
143 |         .trim();
144 |       
145 |       // Solo agregar si no está vacío después de limpiar
146 |       if (itemText) {
147 |         const targetArray = currentEntry[currentSection];
148 |         if (Array.isArray(targetArray)) {
149 |           targetArray.push(itemText);
150 |         }
151 |       }
152 |     }
153 |   }
154 |   
155 |   // Agregar la última entry si existe
156 |   if (currentEntry && currentEntry.version && currentEntry.date) {
157 |     entries.push(currentEntry as ChangelogEntry);
158 |   }
159 |   
160 |   return entries;
161 | }
```

src/services/charactersService.ts
```
1 | import { supabase } from './supabase';
2 | import { StoryCharacter } from '../types';
3 | import { getUserCharacters, syncCharacter, deleteCharacter as deleteSupabaseCharacter } from './supabase';
4 | 
5 | // Validation constants
6 | export const CHARACTER_LIMITS = {
7 |   MIN_CHARACTERS: 1,
8 |   MAX_CHARACTERS: 4,
9 |   MAX_NAME_LENGTH: 50,
10 |   MIN_NAME_LENGTH: 2,
11 | } as const;
12 | 
13 | // Validation types
14 | export interface CharacterValidationResult {
15 |   isValid: boolean;
16 |   errors: string[];
17 |   warnings: string[];
18 | }
19 | 
20 | export interface CharacterSelectionValidationResult extends CharacterValidationResult {
21 |   canSelectMore: boolean;
22 |   selectionCount: number;
23 | }
24 | 
25 | /**
26 |  * Validates an individual character
27 |  */
28 | export const validateCharacter = (character: StoryCharacter): CharacterValidationResult => {
29 |   const errors: string[] = [];
30 |   const warnings: string[] = [];
31 |   let isValid = true;
32 | 
33 |   // Validate required fields
34 |   if (!character.name || character.name.trim().length === 0) {
35 |     errors.push("Name is required");
36 |     isValid = false;
37 |   } else {
38 |     // Validate name length
39 |     if (character.name.length < CHARACTER_LIMITS.MIN_NAME_LENGTH) {
40 |       errors.push(`Name must be at least ${CHARACTER_LIMITS.MIN_NAME_LENGTH} characters`);
41 |       isValid = false;
42 |     }
43 |     if (character.name.length > CHARACTER_LIMITS.MAX_NAME_LENGTH) {
44 |       errors.push(`Name cannot exceed ${CHARACTER_LIMITS.MAX_NAME_LENGTH} characters`);
45 |       isValid = false;
46 |     }
47 |   }
48 | 
49 |   // Validate gender (required in new structure)
50 |   if (!character.gender) {
51 |     errors.push("Gender is required");
52 |     isValid = false;
53 |   }
54 | 
55 |   // Validate description (required in new structure)
56 |   if (!character.description || character.description.trim().length === 0) {
57 |     errors.push("Description is required");
58 |     isValid = false;
59 |   } else if (character.description.length < 10) {
60 |     errors.push("Description must be at least 10 characters");
61 |     isValid = false;
62 |   } else if (character.description.length < 20) {
63 |     warnings.push("A more detailed description will make your character more captivating and stories more intimate");
64 |   }
65 | 
66 |   return {
67 |     isValid,
68 |     errors,
69 |     warnings
70 |   };
71 | };
72 | 
73 | /**
74 |  * Validates if a character can be selected
75 |  */
76 | export const validateCharacterSelection = (
77 |   currentSelection: StoryCharacter[],
78 |   characterToSelect: StoryCharacter
79 | ): CharacterSelectionValidationResult => {
80 |   const errors: string[] = [];
81 |   const warnings: string[] = [];
82 |   let isValid = true;
83 | 
84 |   // Check maximum limit
85 |   if (currentSelection.length >= CHARACTER_LIMITS.MAX_CHARACTERS) {
86 |     errors.push(`Maximum ${CHARACTER_LIMITS.MAX_CHARACTERS} characters allowed`);
87 |     isValid = false;
88 |   }
89 | 
90 |   // Check if character is already selected
91 |   if (currentSelection.some(char => char.id === characterToSelect.id)) {
92 |     errors.push("This character is already selected");
93 |     isValid = false;
94 |   }
95 | 
96 |   // Validate the character itself
97 |   const characterValidation = validateCharacter(characterToSelect);
98 |   if (!characterValidation.isValid) {
99 |     errors.push(...characterValidation.errors);
100 |     isValid = false;
101 |   }
102 | 
103 |   // Warning for stories with many characters
104 |   if (currentSelection.length >= 2) {
105 |     warnings.push("For intimate stories, fewer characters allow each one to shine more in your fantasy");
106 |   }
107 | 
108 |   return {
109 |     isValid,
110 |     errors,
111 |     warnings,
112 |     canSelectMore: currentSelection.length < CHARACTER_LIMITS.MAX_CHARACTERS - 1,
113 |     selectionCount: currentSelection.length + (isValid ? 1 : 0)
114 |   };
115 | };
116 | 
117 | /**
118 |  * Validates multiple character selection
119 |  */
120 | export const validateMultipleCharacterSelection = (
121 |   characters: StoryCharacter[]
122 | ): CharacterSelectionValidationResult => {
123 |   const errors: string[] = [];
124 |   const warnings: string[] = [];
125 |   let isValid = true;
126 | 
127 |   // Check limits
128 |   if (characters.length < CHARACTER_LIMITS.MIN_CHARACTERS) {
129 |     errors.push(`You must select at least ${CHARACTER_LIMITS.MIN_CHARACTERS} character`);
130 |     isValid = false;
131 |   }
132 | 
133 |   if (characters.length > CHARACTER_LIMITS.MAX_CHARACTERS) {
134 |     errors.push(`Maximum ${CHARACTER_LIMITS.MAX_CHARACTERS} characters allowed`);
135 |     isValid = false;
136 |   }
137 | 
138 |   // Check for duplicates
139 |   const uniqueIds = new Set(characters.map(char => char.id));
140 |   if (uniqueIds.size !== characters.length) {
141 |     errors.push("Duplicate characters are not allowed");
142 |     isValid = false;
143 |   }
144 | 
145 |   // Validate each character individually
146 |   for (const character of characters) {
147 |     const charValidation = validateCharacter(character);
148 |     if (!charValidation.isValid) {
149 |       errors.push(`Character "${character.name}": ${charValidation.errors.join(", ")}`);
150 |       isValid = false;
151 |     }
152 |   }
153 | 
154 |   // Warnings based on character count
155 |   if (characters.length >= 3) {
156 |     warnings.push("✨ With 3+ characters, your story will be rich and passionate, but may be longer");
157 |   } else if (characters.length === 2) {
158 |     warnings.push("✨ Perfect! Two characters create dynamic and intimate encounters");
159 |   }
160 | 
161 |   return {
162 |     isValid,
163 |     errors,
164 |     warnings,
165 |     canSelectMore: characters.length < CHARACTER_LIMITS.MAX_CHARACTERS,
166 |     selectionCount: characters.length
167 |   };
168 | };
169 | 
170 | /**
171 |  * Validates if a story can be generated with the selected characters
172 |  */
173 | export const validateStoryGeneration = (characters: StoryCharacter[]): CharacterValidationResult => {
174 |   if (characters.length === 0) {
175 |     return {
176 |       isValid: false,
177 |       errors: ["You must select at least one character to generate your story"],
178 |       warnings: []
179 |     };
180 |   }
181 | 
182 |   // Use multiple selection validation
183 |   const validation = validateMultipleCharacterSelection(characters);
184 | 
185 |   return {
186 |     isValid: validation.isValid,
187 |     errors: validation.errors,
188 |     warnings: validation.warnings
189 |   };
190 | };
191 | 
192 | /**
193 |  * Gets the recommended message based on character count
194 |  */
195 | export const getCharacterSelectionMessage = (count: number): string => {
196 |   switch (count) {
197 |     case 0:
198 |       return "✨ Select up to 4 characters for your erotic story!";
199 |     case 1:
200 |       return "✨ Great start! You can add up to 3 more characters for steamy encounters";
201 |     case 2:
202 |       return "✨ Perfect! This combination will create dynamic and passionate moments";
203 |     case 3:
204 |       return "✨ Amazing! Your story will be incredibly rich with these 3 characters";
205 |     case 4:
206 |       return "✨ Maximum reached! These 4 characters will create an epic erotic adventure";
207 |     default:
208 |       return "✨ For intimate stories, fewer characters allow each one to shine in your fantasy";
209 |   }
210 | };
211 | 
212 | /**
213 |  * Characters Service - Main API for character operations
214 |  */
215 | export const charactersService = {
216 |   // Get user's characters
217 |   async getUserCharacters(userId: string): Promise<StoryCharacter[]> {
218 |     const { success, characters, error } = await getUserCharacters(userId);
219 |     
220 |     if (!success) {
221 |       console.error('Error fetching characters:', error);
222 |       throw new Error(error?.message || 'Error fetching characters');
223 |     }
224 |     
225 |     return characters || [];
226 |   },
227 | 
228 |   // Create a new character
229 |   async createCharacter(userId: string, character: Omit<StoryCharacter, 'id'>): Promise<StoryCharacter> {
230 |     const characterData = {
231 |       ...character,
232 |       user_id: userId
233 |     };
234 | 
235 |     const { success, error } = await syncCharacter(userId, characterData as StoryCharacter);
236 |     
237 |     if (!success) {
238 |       console.error('Error creating character:', error);
239 |       throw new Error(error?.message || 'Error creating character');
240 |     }
241 |     
242 |     // Return the character with generated ID
243 |     return {
244 |       id: characterData.id || '',
245 |       ...character
246 |     };
247 |   },
248 | 
249 |   // Update an existing character
250 |   async updateCharacter(userId: string, characterId: string, updates: Partial<StoryCharacter>): Promise<StoryCharacter> {
251 |     const { success, error } = await syncCharacter(userId, { id: characterId, ...updates } as StoryCharacter);
252 |     
253 |     if (!success) {
254 |       console.error('Error updating character:', error);
255 |       throw new Error(error?.message || 'Error updating character');
256 |     }
257 |     
258 |     return { id: characterId, ...updates } as StoryCharacter;
259 |   },
260 | 
261 |   // Delete a character
262 |   async deleteCharacter(characterId: string): Promise<void> {
263 |     const { success, error } = await deleteSupabaseCharacter(characterId);
264 |     
265 |     if (!success) {
266 |       console.error('Error deleting character:', error);
267 |       throw new Error(error?.message || 'Error deleting character');
268 |     }
269 |   },
270 | 
271 |   // Validation helpers
272 |   validateCharacter,
273 |   validateCharacterSelection,
274 |   validateMultipleCharacterSelection,
275 |   validateStoryGeneration,
276 |   getCharacterSelectionMessage,
277 |   
278 |   // Character selection utilities
279 |   isCharacterSelected: (characterId: string, selectedCharacters: StoryCharacter[]): boolean => {
280 |     return selectedCharacters.some(char => char.id === characterId);
281 |   },
282 | 
283 |   canSelectMoreCharacters: (selectedCharacters: StoryCharacter[]): boolean => {
284 |     return selectedCharacters.length < CHARACTER_LIMITS.MAX_CHARACTERS;
285 |   },
286 | 
287 |   getSelectedCharactersByIds: (characterIds: string[], allCharacters: StoryCharacter[]): StoryCharacter[] => {
288 |     return characterIds
289 |       .map(id => allCharacters.find(char => char.id === id))
290 |       .filter((char): char is StoryCharacter => char !== undefined);
291 |   },
292 | 
293 |   // Constants
294 |   CHARACTER_LIMITS
295 | };
```

src/services/pdfService.ts
```
1 | import jsPDF from 'jspdf';
2 | import html2canvas from 'html2canvas';
3 | import { APP_CONFIG } from '../config/app';
4 | 
5 | interface StoryPDFOptions {
6 |   title: string;
7 |   author?: string;
8 |   content: string;
9 |   coverImageUrl?: string;
10 | }
11 | 
12 | /**
13 |  * Servicio para la generación de PDFs de cuentos
14 |  */
15 | export const PdfService = {
16 |   /**
17 |    * Genera un PDF con una portada personalizada y el contenido del cuento
18 |    * @param options Opciones para la generación del PDF
19 |    * @returns Promise que resuelve con un Blob del PDF generado
20 |    */
21 |   async generateStoryPdf(options: StoryPDFOptions): Promise<Blob> {
22 |     const { title, author, content } = options;
23 |     const pdf = new jsPDF('p', 'mm', 'a4');
24 |     const pageWidth = pdf.internal.pageSize.getWidth();
25 |     const pageHeight = pdf.internal.pageSize.getHeight();
26 | 
27 |     // Colores y estilos
28 |     const backgroundColor = '#fff6e0';
29 |     const textColor = '#ce9789'; // Color más amigable para niños
30 |     const titleColor = '#BB79D1';
31 | 
32 |     // Agregar la portada
33 |     await this.addCoverPage(pdf, title, author);
34 | 
35 |     // Agregar el contenido
36 |     await this.addContentPages(pdf, content, backgroundColor, textColor, title);
37 | 
38 |     // Agregar contraportada
39 |     await this.addBackCoverPage(pdf);
40 | 
41 |     // Añadir pie de página a todas las páginas
42 |     const totalPages = pdf.getNumberOfPages ? pdf.getNumberOfPages() : pdf.internal.pages.length - 1;
43 |     for (let i = 1; i <= totalPages; i++) {
44 |       pdf.setPage(i);
45 |       this.addFooter(pdf, i, totalPages);
46 |     }
47 | 
48 |     return pdf.output('blob');
49 |   },
50 | 
51 |   /**
52 |    * Crea la portada del PDF
53 |    */
54 |   async addCoverPage(pdf: jsPDF, title: string, author?: string): Promise<void> {
55 |     const pageWidth = pdf.internal.pageSize.getWidth();
56 |     const pageHeight = pdf.internal.pageSize.getHeight();
57 | 
58 |     // Establecer el fondo de la portada
59 |     pdf.setFillColor(255, 246, 224); // #fff6e0 en RGB
60 |     pdf.rect(0, 0, pageWidth, pageHeight, 'F');
61 | 
62 |     // Cargar la imagen de fondo
63 |     try {
64 |       // Simulamos cargar la imagen de fondo usando html2canvas
65 |       const backgroundDiv = document.createElement('div');
66 |       backgroundDiv.style.backgroundImage = 'url(/fondo_png.png)';
67 |       backgroundDiv.style.backgroundSize = 'cover';
68 |       backgroundDiv.style.width = '210mm';
69 |       backgroundDiv.style.height = '297mm';
70 |       document.body.appendChild(backgroundDiv);
71 | 
72 |       const canvas = await html2canvas(backgroundDiv, {
73 |         scale: 2,
74 |         logging: false,
75 |         useCORS: true
76 |       });
77 | 
78 |       document.body.removeChild(backgroundDiv);
79 | 
80 |       // Agregar imagen de fondo con opacidad
81 |       const imgData = canvas.toDataURL('image/png');
82 |       // Usar método alternativo para manejar la opacidad
83 |       const opacity = 0.15;
84 |       // Las versiones más nuevas de jsPDF tienen globalAlpha en options
85 |       try {
86 |         // Intentar primero con la versión más nueva de la API
87 |         pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight, undefined, 'FAST', 0);
88 |       } catch (e) {
89 |         // Si falla, intentar con la API estándar
90 |         pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);
91 |       }
92 |     } catch (error) {
93 |       console.error('Error al cargar la imagen de fondo:', error);
94 |     }
95 | 
96 |     // Agregar el logo
97 |     try {
98 |       const logo = new Image();
99 |       logo.src = '/logo_fantasia.png';
100 | 
101 |       // Esperar a que el logo se cargue
102 |       await new Promise<void>((resolve) => {
103 |         logo.onload = () => resolve();
104 |         logo.onerror = () => {
105 |           console.error('Error al cargar el logo');
106 |           resolve();
107 |         };
108 |       });
109 | 
110 |       // Crear un canvas temporal para el logo
111 |       const logoCanvas = document.createElement('canvas');
112 |       const logoWidth = 60; // ancho en mm
113 |       const logoHeight = (logo.height / logo.width) * logoWidth;
114 | 
115 |       logoCanvas.width = logo.width;
116 |       logoCanvas.height = logo.height;
117 |       const ctx = logoCanvas.getContext('2d');
118 |       if (ctx) {  // Verificar que el contexto no sea null
119 |         ctx.drawImage(logo, 0, 0, logo.width, logo.height);
120 | 
121 |         const logoData = logoCanvas.toDataURL('image/png');
122 |         pdf.addImage(logoData, 'PNG', (pageWidth - logoWidth) / 2, 40, logoWidth, logoHeight);
123 |       }
124 |     } catch (error) {
125 |       console.error('Error al cargar el logo:', error);
126 |     }
127 | 
128 |     // Añadir el título
129 |     pdf.setFont('helvetica', 'bold');
130 |     pdf.setTextColor('#BB79D1'); // Morado de la marca
131 | 
132 |     // Ajustar el tamaño de la fuente según la longitud del título
133 |     const titleFontSize = Math.min(32, 1000 / title.length);
134 |     pdf.setFontSize(titleFontSize);
135 | 
136 |     const titleWidth = pdf.getStringUnitWidth(title) * titleFontSize / pdf.internal.scaleFactor;
137 |     const titleX = (pageWidth - titleWidth) / 2;
138 | 
139 |     // Agregar título
140 |     pdf.text(title, pageWidth / 2, pageHeight / 2, { align: 'center' });
141 | 
142 |     // Agregar autor si existe
143 |     if (author) {
144 |       pdf.setFont('helvetica', 'italic');
145 |       pdf.setTextColor('#555555');
146 |       pdf.setFontSize(12);
147 |       pdf.text(`por ${author}`, pageWidth / 2, pageHeight / 2 + 15, { align: 'center' });
148 |     }
149 | 
150 |     // Agregar fecha de generación
151 |     const currentDate = new Date().toLocaleDateString();
152 |     pdf.setFont('helvetica', 'normal');
153 |     pdf.setFontSize(10);
154 |     pdf.setTextColor('#777777');
155 |     pdf.text(`Generado por ${APP_CONFIG.name}!`, pageWidth / 2, pageHeight - 20, { align: 'center' });
156 |   },
157 | 
158 |   /**
159 |    * Agrega las páginas con el contenido del cuento
160 |    */
161 |   async addContentPages(pdf: jsPDF, content: string, backgroundColor: string, textColor: string, title: string): Promise<void> {
162 |     // Añadir una nueva página para el contenido
163 |     pdf.addPage();
164 | 
165 |     const pageWidth = pdf.internal.pageSize.getWidth();
166 |     const pageHeight = pdf.internal.pageSize.getHeight();
167 | 
168 |     // Establecer el color de fondo blanco para las páginas de contenido
169 |     pdf.setFillColor(255, 255, 255); // Blanco
170 |     pdf.rect(0, 0, pageWidth, pageHeight, 'F');
171 | 
172 |     // Añadir encabezado con logo y título
173 |     await this.addHeaderToPage(pdf, title);
174 | 
175 |     // Configurar estilos de texto para el contenido - más grande y negrita para niños
176 |     pdf.setFont('helvetica', 'bold');
177 |     pdf.setFontSize(16); // Letra más grande para mejor legibilidad infantil
178 |     pdf.setTextColor(textColor);
179 | 
180 |     // Márgenes
181 |     const margin = 25; // Márgenes más amplios para mejor experiencia de lectura
182 |     const effectiveWidth = pageWidth - 2 * margin;
183 | 
184 |     // Dividir el contenido en párrafos
185 |     const paragraphs = content.split('\n\n');
186 |     if (paragraphs.length === 1) {
187 |       // Si solo hay un párrafo, dividir por saltos de línea simples
188 |       paragraphs.splice(0, 1, ...content.split('\n'));
189 |     }
190 | 
191 |     // Contador para llevar la posición Y actual
192 |     let yPos = margin + 20; // Aumentamos el margen superior para dar espacio al encabezado
193 | 
194 |     // Iterar sobre cada párrafo
195 |     for (const paragraph of paragraphs) {
196 |       if (paragraph.trim() === '') continue;
197 | 
198 |       // Dividir el texto en líneas para que quepa dentro de la página
199 |       const lines = pdf.splitTextToSize(paragraph, effectiveWidth);
200 | 
201 |       // Verificar si necesitamos una nueva página para este párrafo
202 |       if (yPos + lines.length * 9 > pageHeight - margin) {
203 |         pdf.addPage();
204 |         pdf.setFillColor(255, 255, 255); // Fondo blanco para las nuevas páginas de contenido
205 |         pdf.rect(0, 0, pageWidth, pageHeight, 'F');
206 | 
207 |         // Añadir encabezado en la nueva página
208 |         await this.addHeaderToPage(pdf, title);
209 | 
210 |         // Importante: restaurar el color del texto después de añadir el encabezado
211 |         pdf.setFont('helvetica', 'bold');
212 |         pdf.setFontSize(16);
213 |         pdf.setTextColor(textColor); // Restauramos el color original para el contenido
214 | 
215 |         yPos = margin + 20; // Reiniciar posición Y considerando espacio para el encabezado
216 |       }
217 | 
218 |       // Agregar las líneas del párrafo
219 |       pdf.text(lines, margin, yPos);
220 | 
221 |       // Actualizar la posición Y para el siguiente párrafo con menos espaciado
222 |       yPos += lines.length * 9 + 3; // Reducido el espaciado entre párrafos
223 |     }
224 |   },
225 | 
226 |   /**
227 |    * Agrega un encabezado a la página actual con logo en miniatura y título
228 |    */
229 |   async addHeaderToPage(pdf: jsPDF, title: string): Promise<void> {
230 |     const pageWidth = pdf.internal.pageSize.getWidth();
231 | 
232 |     // Añadir logo en miniatura
233 |     try {
234 |       const logo = new Image();
235 |       logo.src = '/logo_fantasia.png';
236 | 
237 |       // Esperar a que el logo se cargue
238 |       await new Promise<void>((resolve) => {
239 |         logo.onload = () => resolve();
240 |         logo.onerror = () => {
241 |           console.error('Error al cargar el logo para el encabezado');
242 |           resolve();
243 |         };
244 |       });
245 | 
246 |       // Crear un canvas temporal para el logo
247 |       const logoCanvas = document.createElement('canvas');
248 |       const logoWidth = 15; // ancho en mm (más pequeño para el encabezado)
249 |       const logoHeight = (logo.height / logo.width) * logoWidth;
250 | 
251 |       logoCanvas.width = logo.width;
252 |       logoCanvas.height = logo.height;
253 |       const ctx = logoCanvas.getContext('2d');
254 |       if (ctx) {
255 |         ctx.drawImage(logo, 0, 0, logo.width, logo.height);
256 | 
257 |         const logoData = logoCanvas.toDataURL('image/png');
258 | 
259 |         // Posicionar logo en esquina superior izquierda con un margen
260 |         pdf.addImage(logoData, 'PNG', 10, 10, logoWidth, logoHeight);
261 |       }
262 |     } catch (error) {
263 |       console.error('Error al añadir logo al encabezado:', error);
264 |     }
265 | 
266 |     // Añadir título en esquina superior derecha
267 |     if (title) {
268 |       // Configurar estilo infantil y amigable para el encabezado
269 |       pdf.setFont('helvetica', 'bold'); // Cambiar a negrita para mejor legibilidad infantil
270 |       pdf.setFontSize(12); // Ligeramente más grande
271 |       pdf.setTextColor('#BB79D1'); // Color de marca Fantasia
272 | 
273 |       // Truncar título si es muy largo
274 |       let displayTitle = title;
275 |       if (displayTitle.length > 30) {
276 |         displayTitle = displayTitle.substring(0, 27) + '...';
277 |       }
278 | 
279 |       // Dibujar un fondo suave para el título
280 |       const titleWidth = pdf.getStringUnitWidth(displayTitle) * 12 / pdf.internal.scaleFactor;
281 |       const padding = 3; // Padding en mm
282 | 
283 |       pdf.setFillColor(240, 248, 255); // Fondo azul muy suave para mejor contraste en fondo blanco
284 |       pdf.roundedRect(pageWidth - titleWidth - 20, 8, titleWidth + 10, 10, 2, 2, 'F');
285 | 
286 |       // Posicionar en esquina superior derecha con fondo
287 |       pdf.text(displayTitle, pageWidth - 15, 15, { align: 'right' });
288 |     }
289 |   },
290 | 
291 |   /**
292 |    * Agrega una contraportada al PDF con logo y texto de cierre
293 |    */
294 |   async addBackCoverPage(pdf: jsPDF): Promise<void> {
295 |     pdf.addPage();
296 |     const pageWidth = pdf.internal.pageSize.getWidth();
297 |     const pageHeight = pdf.internal.pageSize.getHeight();
298 | 
299 |     // Establecer el fondo de la contraportada
300 |     pdf.setFillColor(255, 246, 224); // #fff6e0 en RGB
301 |     pdf.rect(0, 0, pageWidth, pageHeight, 'F');
302 | 
303 |     // Cargar la imagen de fondo con baja opacidad
304 |     try {
305 |       // Simulamos cargar la imagen de fondo usando html2canvas
306 |       const backgroundDiv = document.createElement('div');
307 |       backgroundDiv.style.backgroundImage = 'url(/fondo_png.png)';
308 |       backgroundDiv.style.backgroundSize = 'cover';
309 |       backgroundDiv.style.width = '210mm';
310 |       backgroundDiv.style.height = '297mm';
311 |       document.body.appendChild(backgroundDiv);
312 | 
313 |       const canvas = await html2canvas(backgroundDiv, {
314 |         scale: 2,
315 |         logging: false,
316 |         useCORS: true
317 |       });
318 | 
319 |       document.body.removeChild(backgroundDiv);
320 | 
321 |       // Agregar imagen de fondo con opacidad
322 |       const imgData = canvas.toDataURL('image/png');
323 |       try {
324 |         pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight, undefined, 'FAST', 0);
325 |       } catch (e) {
326 |         pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);
327 |       }
328 |     } catch (error) {
329 |       console.error('Error al cargar la imagen de fondo:', error);
330 |     }
331 | 
332 |     // Agregar el logo
333 |     try {
334 |       const logo = new Image();
335 |       logo.src = '/logo_fantasia.png';
336 | 
337 |       // Esperar a que el logo se cargue
338 |       await new Promise<void>((resolve) => {
339 |         logo.onload = () => resolve();
340 |         logo.onerror = () => {
341 |           console.error('Error al cargar el logo');
342 |           resolve();
343 |         };
344 |       });
345 | 
346 |       // Crear un canvas temporal para el logo
347 |       const logoCanvas = document.createElement('canvas');
348 |       const logoWidth = 50; // ancho en mm
349 |       const logoHeight = (logo.height / logo.width) * logoWidth;
350 | 
351 |       logoCanvas.width = logo.width;
352 |       logoCanvas.height = logo.height;
353 |       const ctx = logoCanvas.getContext('2d');
354 |       if (ctx) {
355 |         ctx.drawImage(logo, 0, 0, logo.width, logo.height);
356 | 
357 |         const logoData = logoCanvas.toDataURL('image/png');
358 |         pdf.addImage(logoData, 'PNG', (pageWidth - logoWidth) / 2, pageHeight / 3 - 25, logoWidth, logoHeight);
359 |       }
360 |     } catch (error) {
361 |       console.error('Error al cargar el logo:', error);
362 |     }
363 | 
364 |     pdf.setFont('helvetica', 'bold');
365 |     pdf.setTextColor('#BB79D1');
366 |     pdf.setFontSize(18);
367 |     pdf.text(`Generado por ${APP_CONFIG.name}!`, pageWidth / 2, pageHeight / 2 - 10, { align: 'center' });
368 | 
369 |     // Agregar año actual
370 |     const currentYear = new Date().getFullYear().toString();
371 |     pdf.setFontSize(14);
372 |     pdf.setFont('helvetica', 'normal');
373 |     pdf.setTextColor('#777777');
374 |     pdf.text(currentYear, pageWidth / 2, pageHeight / 2 + 30, { align: 'center' });
375 |   },
376 | 
377 |   /**
378 |    * Añade un pie de página a la página actual
379 |    */
380 |   addFooter(pdf: jsPDF, currentPage: number, totalPages: number): void {
381 |     const pageWidth = pdf.internal.pageSize.getWidth();
382 |     const pageHeight = pdf.internal.pageSize.getHeight();
383 | 
384 |     pdf.setFontSize(8);
385 |     pdf.setTextColor('#777777');
386 | 
387 |     // Agregar número de página
388 |     pdf.text(`${currentPage} / ${totalPages}`, pageWidth - 20, pageHeight - 10);
389 | 
390 |     // Agregar nombre de la aplicación y versión
391 |     pdf.text(`${APP_CONFIG.name} v${APP_CONFIG.version}`, 20, pageHeight - 10);
392 |   },
393 | 
394 |   /**
395 |    * Descarga el PDF generado
396 |    */
397 |   downloadPdf(blob: Blob, filename: string): void {
398 |     const url = URL.createObjectURL(blob);
399 |     const link = document.createElement('a');
400 |     link.href = url;
401 |     link.download = filename.endsWith('.pdf') ? filename : `${filename}.pdf`;
402 |     document.body.appendChild(link);
403 |     link.click();
404 |     document.body.removeChild(link);
405 |     URL.revokeObjectURL(url);
406 |   }
407 | }; 
```

src/services/storyPdfService.ts
```
1 | import { supabase } from '../supabaseClient';
2 | import { IMAGES_TYPE } from '../constants/story-images.constant';
3 | import { PdfService } from './pdfService';
4 | import { ImageGenerationService } from './ai/imageGenerationService';
5 | import jsPDF from 'jspdf';
6 | import { APP_CONFIG } from '../config/app';
7 | 
8 | interface ImageValidationResult {
9 |   cover: boolean;
10 |   scene_1: boolean;
11 |   scene_2: boolean;
12 |   allValid: boolean;
13 |   missingImages: string[];
14 |   imageUrls?: {
15 |     cover?: string;
16 |     scene_1?: string;
17 |     scene_2?: string;
18 |   };
19 | }
20 | 
21 | interface StoryPdfGenerationOptions {
22 |   title: string;
23 |   author?: string;
24 |   content: string;
25 |   storyId: string;
26 |   chapterId: string;
27 | }
28 | 
29 | interface IllustratedPdfGenerationOptions extends StoryPdfGenerationOptions {
30 |   imageUrls: {
31 |     cover: string;
32 |     scene_1: string;
33 |     scene_2: string;
34 |   };
35 | }
36 | 
37 | /**
38 |  * Interface for progress tracking during image generation
39 |  */
40 | export interface ImageGenerationProgress {
41 |   currentStep: string;
42 |   currentImageType?: string;
43 |   completedImages: number;
44 |   totalImages: number;
45 |   progress: number; // 0-100
46 | }
47 | 
48 | /**
49 |  * Interface for complete illustrated PDF generation with automatic image generation
50 |  */
51 | interface CompleteIllustratedPdfOptions extends StoryPdfGenerationOptions {
52 |   onProgress?: (progress: ImageGenerationProgress) => void;
53 | }
54 | 
55 | /**
56 |  * Service for handling story PDF generation with image validation and illustrated PDF creation
57 |  */
58 | export class StoryPdfService {
59 |   private static readonly REQUIRED_IMAGES = [IMAGES_TYPE.COVER, IMAGES_TYPE.SCENE_1, IMAGES_TYPE.SCENE_2];
60 |   private static readonly IMAGE_BUCKET = 'images-stories';
61 | 
62 | 
63 | 
64 |   /**
65 |    * Validates that all required images exist in Supabase storage for illustrated PDF generation
66 |    * @param storyId Story identifier
67 |    * @param chapterId Chapter identifier
68 |    * @returns Promise with validation results and image URLs if available
69 |    */
70 |   static async validateRequiredImages(storyId: string, chapterId: string): Promise<ImageValidationResult> {
71 |     const validationResult: ImageValidationResult = {
72 |       cover: false,
73 |       scene_1: false,
74 |       scene_2: false,
75 |       allValid: false,
76 |       missingImages: [],
77 |       imageUrls: {}
78 |     };
79 | 
80 |     try {
81 |       console.log('[StoryPdfService] Validating images for story:', storyId, 'chapter:', chapterId);
82 | 
83 |       for (const imageType of this.REQUIRED_IMAGES) {
84 |         const imagePath = `${storyId}/${chapterId}/${imageType}.jpeg`;
85 |         
86 |         // Get public URL from Supabase storage
87 |         const { data } = supabase.storage
88 |           .from(this.IMAGE_BUCKET)
89 |           .getPublicUrl(imagePath);
90 | 
91 |         if (data?.publicUrl) {
92 |           // Validate image accessibility with HTTP HEAD request
93 |           try {
94 |             const response = await fetch(data.publicUrl, { method: 'HEAD' });
95 |             if (response.ok) {
96 |               validationResult[imageType as keyof Omit<ImageValidationResult, 'allValid' | 'missingImages' | 'imageUrls'>] = true;
97 |               validationResult.imageUrls![imageType as keyof NonNullable<ImageValidationResult['imageUrls']>] = data.publicUrl;
98 |               console.log(`[StoryPdfService] ✅ Found ${imageType}: ${data.publicUrl}`);
99 |             } else {
100 |               console.log(`[StoryPdfService] ❌ Image ${imageType} not accessible:`, response.status);
101 |               validationResult.missingImages.push(this.getImageDisplayName(imageType));
102 |             }
103 |           } catch (fetchError) {
104 |             console.log(`[StoryPdfService] ❌ Error accessing ${imageType}:`, fetchError);
105 |             validationResult.missingImages.push(this.getImageDisplayName(imageType));
106 |           }
107 |         } else {
108 |           console.log(`[StoryPdfService] ❌ No public URL for ${imageType}`);
109 |           validationResult.missingImages.push(this.getImageDisplayName(imageType));
110 |         }
111 |       }
112 | 
113 |       validationResult.allValid = validationResult.cover && validationResult.scene_1 && validationResult.scene_2;
114 |       console.log('[StoryPdfService] Image validation results:', validationResult);
115 |       
116 |       return validationResult;
117 |     } catch (error) {
118 |       console.error('[StoryPdfService] Error validating images:', error);
119 |       // Return all images as missing on error
120 |       validationResult.missingImages = this.REQUIRED_IMAGES.map(this.getImageDisplayName);
121 |       return validationResult;
122 |     }
123 |   }
124 | 
125 |   /**
126 |    * Generates standard Fantasia format PDF (text only)
127 |    * @param options PDF generation options
128 |    * @returns Promise with generated PDF blob
129 |    */
130 |   static async generateStandardPdf(options: StoryPdfGenerationOptions): Promise<Blob> {
131 |     try {
132 |       console.log('[StoryPdfService] Generating standard PDF for:', options.title);
133 |       
134 |       const pdfBlob = await PdfService.generateStoryPdf({
135 |         title: options.title,
136 |         author: options.author,
137 |         content: options.content
138 |       });
139 |       
140 |       console.log('[StoryPdfService] Standard PDF generated successfully');
141 |       return pdfBlob;
142 |     } catch (error) {
143 |       console.error('[StoryPdfService] Error generating standard PDF:', error);
144 |       throw new Error(`Failed to generate standard PDF: ${error instanceof Error ? error.message : 'Unknown error'}`);
145 |     }
146 |   }
147 | 
148 |   /**
149 |    * Generates illustrated PDF with images from storage
150 |    * @param options Illustrated PDF generation options with image URLs
151 |    * @returns Promise with generated PDF blob
152 |    */
153 |   static async generateIllustratedPdf(options: IllustratedPdfGenerationOptions): Promise<Blob> {
154 |     try {
155 |       console.log('[StoryPdfService] Generating illustrated PDF for:', options.title);
156 |       console.log('[StoryPdfService] Image URLs for PDF:', options.imageUrls);
157 |       
158 |       const pdf = new jsPDF('p', 'mm', 'a4');
159 |       const pageWidth = pdf.internal.pageSize.getWidth();
160 |       const pageHeight = pdf.internal.pageSize.getHeight();
161 |       
162 |       // Colors and styles for children's book
163 |       const textColor = '#2c3e50'; // Darker text for better readability over images
164 |       const titleColor = '#BB79D1';
165 |       
166 |       // Convert image URLs to base64 data URLs
167 |       const coverImageData = await this.loadImageAsDataUrl(options.imageUrls.cover);
168 |       const scene1ImageData = await this.loadImageAsDataUrl(options.imageUrls.scene_1);
169 |       const scene2ImageData = await this.loadImageAsDataUrl(options.imageUrls.scene_2);
170 |       
171 |       // Add illustrated cover page
172 |       await this.addIllustratedCoverPage(pdf, options.title, options.author, coverImageData);
173 |       
174 |       // Add illustrated content pages
175 |       await this.addIllustratedContentPages(
176 |         pdf, 
177 |         options.content, 
178 |         textColor, 
179 |         options.title,
180 |         scene1ImageData,
181 |         scene2ImageData
182 |       );
183 |       
184 |       // Add back cover (same as standard)
185 |       await this.addBackCoverPage(pdf);
186 |       
187 |       // Add footer to all pages
188 |       const totalPages = pdf.getNumberOfPages ? pdf.getNumberOfPages() : pdf.internal.pages.length - 1;
189 |       for (let i = 1; i <= totalPages; i++) {
190 |         pdf.setPage(i);
191 |         this.addFooter(pdf, i, totalPages);
192 |       }
193 |       
194 |       console.log('[StoryPdfService] Illustrated PDF generated successfully');
195 |       return pdf.output('blob');
196 |     } catch (error) {
197 |       console.error('[StoryPdfService] Error generating illustrated PDF:', error);
198 |       throw new Error(`Failed to generate illustrated PDF: ${error instanceof Error ? error.message : 'Unknown error'}`);
199 |     }
200 |   }
201 | 
202 |   /**
203 |    * Downloads a PDF blob with appropriate filename
204 |    * @param pdfBlob PDF blob to download
205 |    * @param title Story title for filename
206 |    * @param isIllustrated Whether this is an illustrated PDF
207 |    */
208 |   static downloadPdf(pdfBlob: Blob, title: string, isIllustrated: boolean = false): void {
209 |     try {
210 |       const safeName = title.toLowerCase().replace(/[^a-z0-9]/g, '-');
211 |       const prefix = isIllustrated ? 'fantasia-cuento-ilustrado' : 'fantasia-cuento';
212 |       const filename = `${prefix}-${safeName}.pdf`;
213 |       
214 |       PdfService.downloadPdf(pdfBlob, filename);
215 |       console.log(`[StoryPdfService] PDF downloaded: ${filename}`);
216 |     } catch (error) {
217 |       console.error('[StoryPdfService] Error downloading PDF:', error);
218 |       throw new Error(`Failed to download PDF: ${error instanceof Error ? error.message : 'Unknown error'}`);
219 |     }
220 |   }
221 | 
222 |   /**
223 |    * Gets human-readable display name for image type
224 |    * @param imageType Technical image type identifier
225 |    * @returns Human-readable name in Spanish
226 |    */
227 |   private static getImageDisplayName(imageType: string): string {
228 |     const displayNames: Record<string, string> = {
229 |       [IMAGES_TYPE.COVER]: 'Portada',
230 |       [IMAGES_TYPE.SCENE_1]: 'Escena 1',
231 |       [IMAGES_TYPE.SCENE_2]: 'Escena 2',
232 |       [IMAGES_TYPE.CHARACTER]: 'Personaje'
233 |     };
234 |     
235 |     return displayNames[imageType] || imageType;
236 |   }
237 | 
238 |   /**
239 |    * Validates if illustrated PDF generation is possible for given story
240 |    * @param storyId Story identifier
241 |    * @param chapterId Chapter identifier
242 |    * @returns Promise with validation result and details
243 |    */
244 |   static async canGenerateIllustratedPdf(storyId: string, chapterId: string): Promise<{
245 |     canGenerate: boolean;
246 |     reason?: string;
247 |     missingImages?: string[];
248 |   }> {
249 |     try {
250 |       const validation = await this.validateRequiredImages(storyId, chapterId);
251 |       
252 |       if (validation.allValid) {
253 |         return { canGenerate: true };
254 |       } else {
255 |         return {
256 |           canGenerate: false,
257 |           reason: `Faltan imágenes necesarias: ${validation.missingImages.join(', ')}`,
258 |           missingImages: validation.missingImages
259 |         };
260 |       }
261 |     } catch (error) {
262 |       console.error('[StoryPdfService] Error checking illustrated PDF capability:', error);
263 |       return {
264 |         canGenerate: false,
265 |         reason: 'Error al verificar las imágenes disponibles'
266 |       };
267 |     }
268 |   }
269 | 
270 |   /**
271 |    * Loads an image from URL and converts it to base64 data URL
272 |    * @param imageUrl Public URL of the image
273 |    * @returns Promise with base64 data URL
274 |    */
275 |   private static async loadImageAsDataUrl(imageUrl: string): Promise<string> {
276 |     try {
277 |       console.log('[StoryPdfService] Loading image from URL:', imageUrl);
278 |       
279 |       return new Promise((resolve, reject) => {
280 |         const img = new Image();
281 |         img.crossOrigin = 'anonymous'; // Enable CORS
282 |         
283 |         img.onload = () => {
284 |           try {
285 |             // Create canvas to convert image to base64
286 |             const canvas = document.createElement('canvas');
287 |             const ctx = canvas.getContext('2d');
288 |             
289 |             if (!ctx) {
290 |               reject(new Error('Could not get canvas context'));
291 |               return;
292 |             }
293 |             
294 |             canvas.width = img.width;
295 |             canvas.height = img.height;
296 |             
297 |             // Draw image on canvas
298 |             ctx.drawImage(img, 0, 0);
299 |             
300 |             // Convert to data URL
301 |             const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
302 |             console.log('[StoryPdfService] Image loaded and converted to data URL');
303 |             resolve(dataUrl);
304 |           } catch (error) {
305 |             console.error('[StoryPdfService] Error converting image to data URL:', error);
306 |             reject(error);
307 |           }
308 |         };
309 |         
310 |         img.onerror = () => {
311 |           console.error('[StoryPdfService] Error loading image from URL:', imageUrl);
312 |           reject(new Error(`Failed to load image from URL: ${imageUrl}`));
313 |         };
314 |         
315 |         img.src = imageUrl;
316 |       });
317 |     } catch (error) {
318 |       console.error('[StoryPdfService] Error in loadImageAsDataUrl:', error);
319 |       throw error;
320 |     }
321 |   }
322 | 
323 |     /**
324 |    * Creates an illustrated cover page using the cover image
325 |    * @param pdf jsPDF instance
326 |    * @param title Story title
327 |    * @param author Story author
328 |    * @param coverImageData Base64 image data
329 |    */
330 |   private static async addIllustratedCoverPage(pdf: jsPDF, title: string, author?: string, coverImageData?: string): Promise<void> {
331 |     const pageWidth = pdf.internal.pageSize.getWidth();
332 |     const pageHeight = pdf.internal.pageSize.getHeight();
333 |     
334 |     try {
335 |       if (coverImageData) {
336 |         // Add cover image as full background - no overlays, image contains the title
337 |         pdf.addImage(coverImageData, 'JPEG', 0, 0, pageWidth, pageHeight);
338 |         
339 |         // Only add Fantasia logo in corner for branding
340 |         await this.addLogoToPage(pdf, 15, 15, 25);
341 |       } else {
342 |         // Fallback to standard cover if image fails
343 |         pdf.setFillColor(255, 246, 224);
344 |         pdf.rect(0, 0, pageWidth, pageHeight, 'F');
345 |         
346 |         // If image fails, show title as fallback
347 |         pdf.setFont('helvetica', 'bold');
348 |         pdf.setTextColor('#BB79D1');
349 |         const titleFontSize = Math.min(28, 800 / title.length);
350 |         pdf.setFontSize(titleFontSize);
351 |         pdf.text(title, pageWidth / 2, pageHeight / 2, { align: 'center' });
352 |         
353 |         if (author) {
354 |           pdf.setFont('helvetica', 'italic');
355 |           pdf.setFontSize(14);
356 |           pdf.setTextColor('#555555');
357 |           pdf.text(`por ${author}`, pageWidth / 2, pageHeight / 2 + 20, { align: 'center' });
358 |         }
359 |         
360 |         await this.addLogoToPage(pdf, 15, 15, 30);
361 |       }
362 |       
363 |     } catch (error) {
364 |       console.error('[StoryPdfService] Error creating illustrated cover:', error);
365 |       // Fallback to standard background on error
366 |       pdf.setFillColor(255, 246, 224);
367 |       pdf.rect(0, 0, pageWidth, pageHeight, 'F');
368 |     }
369 |   }
370 | 
371 |   /**
372 |    * Creates illustrated content pages with scene backgrounds
373 |    * @param pdf jsPDF instance
374 |    * @param content Story content
375 |    * @param textColor Text color
376 |    * @param title Story title
377 |    * @param scene1ImageData Scene 1 image data
378 |    * @param scene2ImageData Scene 2 image data
379 |    */
380 |   private static async addIllustratedContentPages(
381 |     pdf: jsPDF,
382 |     content: string,
383 |     textColor: string,
384 |     title: string,
385 |     scene1ImageData: string,
386 |     scene2ImageData: string
387 |   ): Promise<void> {
388 |     const pageWidth = pdf.internal.pageSize.getWidth();
389 |     const pageHeight = pdf.internal.pageSize.getHeight();
390 |     const margin = 20;
391 |     const effectiveWidth = pageWidth - 2 * margin;
392 |     
393 |     // Split content into paragraphs
394 |     const paragraphs = content.split('\n\n').filter(p => p.trim() !== '');
395 |     if (paragraphs.length === 1) {
396 |       paragraphs.splice(0, 1, ...content.split('\n').filter(p => p.trim() !== ''));
397 |     }
398 |     
399 |     // Pre-calculate approximate number of pages needed for proper image distribution
400 |     const estimatedTotalPages = this.estimateRequiredPages(content, pageWidth, pageHeight, margin);
401 |     const scene1Pages = Math.ceil(estimatedTotalPages / 2); // First half uses scene_1
402 |     
403 |     console.log(`[StoryPdfService] Estimated pages: ${estimatedTotalPages}, Scene1 pages: ${scene1Pages}, Scene2 pages: ${estimatedTotalPages - scene1Pages}`);
404 |     
405 |     let paragraphIndex = 0;
406 |     let pageIndex = 0;
407 |     
408 |     // Process all paragraphs, creating pages as needed
409 |     while (paragraphIndex < paragraphs.length) {
410 |       pdf.addPage();
411 |       
412 |       // Determine which background image to use (first half scene_1, second half scene_2)
413 |       const useScene1 = pageIndex < scene1Pages;
414 |       const backgroundImage = useScene1 ? scene1ImageData : scene2ImageData;
415 |       
416 |       console.log(`[StoryPdfService] Page ${pageIndex + 1}: Using ${useScene1 ? 'scene_1' : 'scene_2'}`);
417 |       
418 |              // Add background image - clean, no overlays
419 |        try {
420 |          pdf.addImage(backgroundImage, 'JPEG', 0, 0, pageWidth, pageHeight);
421 |        } catch (error) {
422 |          console.error('[StoryPdfService] Error adding background image:', error);
423 |          // Fallback to white background
424 |          pdf.setFillColor(255, 255, 255);
425 |          pdf.rect(0, 0, pageWidth, pageHeight, 'F');
426 |        }
427 |       
428 |       // Add header with logo and title
429 |       await this.addHeaderToPage(pdf, title);
430 |       
431 |              // Configure text style for children's book - clean black text over images
432 |        pdf.setFont('helvetica', 'bold');
433 |        pdf.setFontSize(22); // Large text for children's book readability over images
434 |        pdf.setTextColor('#000000'); // Pure black for maximum contrast
435 |        
436 |        // Add paragraphs to this page with varied positioning
437 |        let yPos = margin + 30; // Space for header
438 |        
439 |        // Process paragraphs until we run out of space or paragraphs
440 |        while (paragraphIndex < paragraphs.length) {
441 |          const paragraph = paragraphs[paragraphIndex];
442 |          
443 |          // Add some randomness to text positioning for children's book feel
444 |          const randomOffset = (Math.random() - 0.5) * 10; // ±5mm random offset
445 |          const adjustedMargin = Math.max(15, Math.min(25, margin + randomOffset));
446 |          const adjustedWidth = pageWidth - 2 * adjustedMargin;
447 |          
448 |          // Split text to fit width
449 |          const lines = pdf.splitTextToSize(paragraph, adjustedWidth);
450 |          
451 |          // Check if paragraph fits on current page (adjusted for larger text)
452 |          if (yPos + lines.length * 15 + 25 > pageHeight - margin) {
453 |            // Paragraph doesn't fit, leave it for next page
454 |            break;
455 |          }
456 |          
457 |          // Add paragraph text with white border for better visibility over images
458 |          this.drawTextWithWhiteBorder(pdf, lines, adjustedMargin, yPos);
459 |          
460 |          // Update position for next paragraph with more spacing for larger text
461 |          yPos += lines.length * 15 + 25; // Extra space between paragraphs for 22pt text
462 |          paragraphIndex++;
463 |        }
464 |        
465 |        // Move to next page
466 |        pageIndex++;
467 |     }
468 |   }
469 | 
470 |   /**
471 |    * Adds back cover page (reuses standard logic from PdfService)
472 |    */
473 |   private static async addBackCoverPage(pdf: jsPDF): Promise<void> {
474 |     pdf.addPage();
475 |     const pageWidth = pdf.internal.pageSize.getWidth();
476 |     const pageHeight = pdf.internal.pageSize.getHeight();
477 |     
478 |     // Set background color
479 |     pdf.setFillColor(255, 246, 224);
480 |     pdf.rect(0, 0, pageWidth, pageHeight, 'F');
481 |     
482 |     // Add logo
483 |     await this.addLogoToPage(pdf, (pageWidth - 50) / 2, pageHeight / 3 - 25, 50);
484 |     
485 |     // Add Fantasia text
486 |     pdf.setFont('helvetica', 'bold');
487 |     pdf.setTextColor('#BB79D1');
488 |     pdf.setFontSize(18);
489 |     pdf.text(`Generado por ${APP_CONFIG.name}!`, pageWidth / 2, pageHeight / 2 - 10, { align: 'center' });
490 |     
491 |     // Add current year
492 |     const currentYear = new Date().getFullYear().toString();
493 |     pdf.setFontSize(14);
494 |     pdf.setFont('helvetica', 'normal');
495 |     pdf.setTextColor('#777777');
496 |     pdf.text(currentYear, pageWidth / 2, pageHeight / 2 + 30, { align: 'center' });
497 |   }
498 | 
499 |      /**
500 |     * Adds header with logo and title to current page
501 |     */
502 |    private static async addHeaderToPage(pdf: jsPDF, title: string): Promise<void> {
503 |      const pageWidth = pdf.internal.pageSize.getWidth();
504 |      
505 |      // Add logo
506 |      await this.addLogoToPage(pdf, 10, 10, 15);
507 |      
508 |      // Add title - clean text without background for illustrated version
509 |      if (title) {
510 |        pdf.setFont('helvetica', 'bold');
511 |        pdf.setFontSize(14); // Slightly larger to match increased content text
512 |        pdf.setTextColor('#000000'); // Black text for visibility over images
513 |        
514 |        let displayTitle = title;
515 |        if (displayTitle.length > 30) {
516 |          displayTitle = displayTitle.substring(0, 27) + '...';
517 |        }
518 |        
519 |        // Text with white border for visibility over image
520 |        this.drawTextWithWhiteBorder(pdf, displayTitle, pageWidth - 15, 15, { align: 'right' });
521 |      }
522 |    }
523 | 
524 |   /**
525 |    * Adds Fantasia logo to specified position
526 |    */
527 |   private static async addLogoToPage(pdf: jsPDF, x: number, y: number, width: number): Promise<void> {
528 |     try {
529 |       const logo = new Image();
530 |       logo.src = '/logo_fantasia.png';
531 |       
532 |       await new Promise<void>((resolve) => {
533 |         logo.onload = () => {
534 |           try {
535 |             const canvas = document.createElement('canvas');
536 |             const height = (logo.height / logo.width) * width;
537 |             
538 |             canvas.width = logo.width;
539 |             canvas.height = logo.height;
540 |             const ctx = canvas.getContext('2d');
541 |             
542 |             if (ctx) {
543 |               ctx.drawImage(logo, 0, 0, logo.width, logo.height);
544 |               const logoData = canvas.toDataURL('image/png');
545 |               pdf.addImage(logoData, 'PNG', x, y, width, height);
546 |             }
547 |           } catch (error) {
548 |             console.error('[StoryPdfService] Error processing logo:', error);
549 |           }
550 |           resolve();
551 |         };
552 |         
553 |         logo.onerror = () => {
554 |           console.error('[StoryPdfService] Error loading logo');
555 |           resolve();
556 |         };
557 |       });
558 |     } catch (error) {
559 |       console.error('[StoryPdfService] Error adding logo:', error);
560 |     }
561 |   }
562 | 
563 |   /**
564 |    * Adds footer to current page
565 |    */
566 |   private static addFooter(pdf: jsPDF, currentPage: number, totalPages: number): void {
567 |     const pageWidth = pdf.internal.pageSize.getWidth();
568 |     const pageHeight = pdf.internal.pageSize.getHeight();
569 |     
570 |     pdf.setFontSize(8);
571 |     pdf.setTextColor('#777777');
572 |     
573 |     // Add page number
574 |     pdf.text(`${currentPage} / ${totalPages}`, pageWidth - 20, pageHeight - 10);
575 |     
576 |     // Add app name and version
577 |     pdf.text(`${APP_CONFIG.name} v${APP_CONFIG.version}`, 20, pageHeight - 10);
578 |   }
579 | 
580 |   /**
581 |    * Estimates the number of pages required for the given content
582 |    * @param content Story content
583 |    * @param pageWidth PDF page width
584 |    * @param pageHeight PDF page height
585 |    * @param margin Page margin
586 |    * @returns Estimated number of pages
587 |    */
588 |   private static estimateRequiredPages(content: string, pageWidth: number, pageHeight: number, margin: number): number {
589 |     // Split content into paragraphs like in the actual generation
590 |     const paragraphs = content.split('\n\n').filter(p => p.trim() !== '');
591 |     let finalParagraphs = paragraphs;
592 |     
593 |     if (paragraphs.length === 1) {
594 |       finalParagraphs = content.split('\n').filter(p => p.trim() !== '');
595 |     }
596 |     
597 |     // Estimate based on content length and typical paragraph distribution
598 |     const averageCharsPerLine = 70; // Approximate characters per line at 22pt font
599 |     const linesPerPage = 12; // Conservative estimate for illustrated pages (with header space and larger text)
600 |     const charsPerPage = averageCharsPerLine * linesPerPage;
601 |     
602 |     const totalChars = content.length;
603 |     const estimatedPages = Math.max(1, Math.ceil(totalChars / charsPerPage));
604 |     
605 |     // Also estimate based on paragraph count (minimum 2-3 paragraphs per page)
606 |     const paragraphBasedPages = Math.ceil(finalParagraphs.length / 2.5);
607 |     
608 |     // Use the higher estimate to be conservative
609 |     const finalEstimate = Math.max(estimatedPages, paragraphBasedPages);
610 |     
611 |     console.log(`[StoryPdfService] Content estimation - Chars: ${totalChars}, Paragraphs: ${finalParagraphs.length}, Estimated pages: ${finalEstimate}`);
612 |     
613 |     return finalEstimate;
614 |   }
615 | 
616 |   /**
617 |    * Draws text with white outline/stroke for better visibility over images
618 |    * @param pdf jsPDF instance
619 |    * @param text Text to draw
620 |    * @param x X position
621 |    * @param y Y position
622 |    * @param options Text options
623 |    */
624 |   private static drawTextWithWhiteBorder(
625 |     pdf: jsPDF, 
626 |     text: string | string[], 
627 |     x: number, 
628 |     y: number, 
629 |     options?: { align?: 'left' | 'center' | 'right' }
630 |   ): void {
631 |     const borderWidth = 0.5; // White border width
632 |     
633 |     // Draw white border by drawing text multiple times with slight offsets
634 |     const offsets = [
635 |       [-borderWidth, -borderWidth], [0, -borderWidth], [borderWidth, -borderWidth],
636 |       [-borderWidth, 0], [borderWidth, 0],
637 |       [-borderWidth, borderWidth], [0, borderWidth], [borderWidth, borderWidth]
638 |     ];
639 |     
640 |     // Draw white outline
641 |     pdf.setTextColor('#FFFFFF');
642 |     offsets.forEach(([offsetX, offsetY]) => {
643 |       pdf.text(text, x + offsetX, y + offsetY, options);
644 |     });
645 |     
646 |     // Draw black text on top
647 |     pdf.setTextColor('#000000');
648 |     pdf.text(text, x, y, options);
649 |   }
650 | 
651 |   /**
652 |    * Generates illustrated PDF with automatic image generation if needed
653 |    * @param options Complete illustrated PDF options with progress callback
654 |    * @returns Promise with generated PDF blob
655 |    */
656 |   static async generateCompleteIllustratedPdf(options: CompleteIllustratedPdfOptions): Promise<Blob> {
657 |     const { title, author, content, storyId, chapterId, onProgress } = options;
658 |     
659 |     try {
660 |       console.log('[StoryPdfService] Starting complete illustrated PDF generation for:', title);
661 |       
662 |       // Step 1: Validate existing images
663 |       onProgress?.({
664 |         currentStep: 'Validando imágenes existentes...',
665 |         completedImages: 0,
666 |         totalImages: 3,
667 |         progress: 5
668 |       });
669 |       
670 |       const imageValidation = await this.validateRequiredImages(storyId, chapterId);
671 |       
672 |       let imageUrls: { cover: string; scene_1: string; scene_2: string };
673 |       
674 |       if (!imageValidation.allValid) {
675 |         console.log('[StoryPdfService] Missing images detected, generating them...');
676 |         
677 |         // Step 2: Generate missing images with progress tracking
678 |         onProgress?.({
679 |           currentStep: 'Generando imágenes del cuento...',
680 |           completedImages: 0,
681 |           totalImages: 3,
682 |           progress: 10
683 |         });
684 |         
685 |         const generationResult = await this.generateImagesWithProgress(
686 |           { title, content, storyId, chapterId },
687 |           onProgress
688 |         );
689 |         
690 |         if (!generationResult.success || !generationResult.imageUrls) {
691 |           throw new Error(`Failed to generate required images: ${generationResult.error}`);
692 |         }
693 |         
694 |         imageUrls = generationResult.imageUrls;
695 |       } else {
696 |         console.log('[StoryPdfService] All images exist, proceeding with PDF generation...');
697 |         imageUrls = {
698 |           cover: imageValidation.imageUrls!.cover!,
699 |           scene_1: imageValidation.imageUrls!.scene_1!,
700 |           scene_2: imageValidation.imageUrls!.scene_2!
701 |         };
702 |       }
703 |       
704 |       // Step 3: Generate illustrated PDF
705 |       onProgress?.({
706 |         currentStep: 'Generando PDF ilustrado...',
707 |         completedImages: 3,
708 |         totalImages: 3,
709 |         progress: 85
710 |       });
711 |       
712 |       const pdfBlob = await this.generateIllustratedPdf({
713 |         title,
714 |         author,
715 |         content,
716 |         storyId,
717 |         chapterId,
718 |         imageUrls
719 |       });
720 |       
721 |       onProgress?.({
722 |         currentStep: 'PDF generado exitosamente',
723 |         completedImages: 3,
724 |         totalImages: 3,
725 |         progress: 100
726 |       });
727 |       
728 |       console.log('[StoryPdfService] Complete illustrated PDF generated successfully');
729 |       return pdfBlob;
730 |       
731 |     } catch (error) {
732 |       console.error('[StoryPdfService] Error generating complete illustrated PDF:', error);
733 |       throw new Error(`Failed to generate illustrated PDF: ${error instanceof Error ? error.message : 'Unknown error'}`);
734 |     }
735 |   }
736 | 
737 |   /**
738 |    * Generates all required images with progress tracking
739 |    * @param options Image generation options
740 |    * @param onProgress Progress callback function
741 |    * @returns Promise with generation result and image URLs
742 |    */
743 |   private static async generateImagesWithProgress(
744 |     options: { title: string; content: string; storyId: string; chapterId: string },
745 |     onProgress?: (progress: ImageGenerationProgress) => void
746 |   ): Promise<{ success: boolean; imageUrls?: { cover: string; scene_1: string; scene_2: string }; error?: string }> {
747 |     try {
748 |       const { title, content, storyId, chapterId } = options;
749 |       
750 |       console.log('[StoryPdfService] Generating images with progress tracking...');
751 |       
752 |       // Update progress for generation start
753 |       onProgress?.({
754 |         currentStep: 'Iniciando generación de imágenes...',
755 |         completedImages: 0,
756 |         totalImages: 3,
757 |         progress: 20
758 |       });
759 |       
760 |       // Incremental progress simulation based on 35 seconds max generation time
761 |       let currentProgress = 20;
762 |       const maxTime = 35000; // 35 seconds max
763 |       const targetProgress = 75; // Target progress when images are generated
764 |       const progressIncrement = (targetProgress - 20) / (maxTime / 1000); // Progress per second
765 |       
766 |       const progressInterval = setInterval(() => {
767 |         currentProgress = Math.min(targetProgress, currentProgress + progressIncrement);
768 |         onProgress?.({
769 |           currentStep: 'Generando imágenes con IA...',
770 |           completedImages: 0,
771 |           totalImages: 3,
772 |           progress: Math.round(currentProgress)
773 |         });
774 |       }, 1000); // Update every second
775 |       
776 |       try {
777 |         // Use the ImageGenerationService to generate all images
778 |         const result = await ImageGenerationService.generateStoryImages({
779 |           title,
780 |           content,
781 |           storyId,
782 |           chapterId
783 |         });
784 |         
785 |         clearInterval(progressInterval);
786 |         
787 |         if (!result.success || result.images.length === 0) {
788 |           return {
789 |             success: false,
790 |             error: result.error || 'No images were generated'
791 |           };
792 |         }
793 |         
794 |         // Map results to image URLs
795 |         const imageUrls: { cover?: string; scene_1?: string; scene_2?: string } = {};
796 |         
797 |         result.images.forEach(img => {
798 |           if (img.type === IMAGES_TYPE.COVER) {
799 |             imageUrls.cover = img.url;
800 |           } else if (img.type === IMAGES_TYPE.SCENE_1) {
801 |             imageUrls.scene_1 = img.url;
802 |           } else if (img.type === IMAGES_TYPE.SCENE_2) {
803 |             imageUrls.scene_2 = img.url;
804 |           }
805 |         });
806 |         
807 |         // Validate we have all required images
808 |         const hasAllImages = imageUrls.cover && imageUrls.scene_1 && imageUrls.scene_2;
809 |         
810 |         if (!hasAllImages) {
811 |           const missingImages: string[] = [];
812 |           if (!imageUrls.cover) missingImages.push('Portada');
813 |           if (!imageUrls.scene_1) missingImages.push('Escena 1');
814 |           if (!imageUrls.scene_2) missingImages.push('Escena 2');
815 |           
816 |           return {
817 |             success: false,
818 |             error: `Faltan imágenes: ${missingImages.join(', ')}`
819 |           };
820 |         }
821 |         
822 |         onProgress?.({
823 |           currentStep: 'Imágenes generadas exitosamente',
824 |           completedImages: 3,
825 |           totalImages: 3,
826 |           progress: 80
827 |         });
828 |         
829 |         return {
830 |           success: true,
831 |           imageUrls: {
832 |             cover: imageUrls.cover!,
833 |             scene_1: imageUrls.scene_1!,
834 |             scene_2: imageUrls.scene_2!
835 |           }
836 |         };
837 |         
838 |       } catch (error) {
839 |         clearInterval(progressInterval);
840 |         throw error;
841 |       }
842 |       
843 |     } catch (error) {
844 |       console.error('[StoryPdfService] Error generating images with progress:', error);
845 |       return {
846 |         success: false,
847 |         error: error instanceof Error ? error.message : 'Unknown error'
848 |       };
849 |     }
850 |   }
851 | } 
```

src/services/stripeService.ts
```
1 | import { loadStripe, Stripe } from '@stripe/stripe-js';
2 | 
3 | // Singleton pattern para cargar Stripe.js solo una vez
4 | let stripePromise: Promise<Stripe | null>;
5 | 
6 | /**
7 |  * Obtiene la instancia de Stripe.js inicializada con la clave publicable
8 |  * @returns Promise con la instancia de Stripe o null si hay error
9 |  */
10 | export const getStripe = (): Promise<Stripe | null> => {
11 |   if (!stripePromise) {
12 |     const publishableKey = import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY;
13 |     if (!publishableKey) {
14 |       console.error("VITE_STRIPE_PUBLISHABLE_KEY no está configurada en .env");
15 |       // Retorna una promesa rechazada o null, dependiendo de cómo quieras manejarlo
16 |       return Promise.resolve(null);
17 |     }
18 |     stripePromise = loadStripe(publishableKey);
19 |   }
20 |   return stripePromise;
21 | };
22 | 
23 | /**
24 |  * Crea una sesión de checkout llamando a la Edge Function de Supabase
25 |  * @param item Tipo de item a comprar ('premium' para suscripción o 'credits' para créditos de voz)
26 |  * @returns Objeto con la URL de checkout o un mensaje de error
27 |  */
28 | export interface CheckoutSessionResponse {
29 |   url?: string;
30 |   error?: string;
31 | }
32 | 
33 | export const createCheckoutSession = async (
34 |   item: 'premium' | 'credits'
35 | ): Promise<CheckoutSessionResponse> => {
36 |   console.log(`Solicitando sesión de checkout para: ${item}`);
37 | 
38 |   try {
39 |     // 1. Obtener la sesión actual de Supabase para el token
40 |     // Añadir extensión .ts
41 |     const { supabase } = await import('../supabaseClient.ts');
42 |     const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
43 | 
44 |     if (sessionError || !sessionData?.session) {
45 |       console.error('Error al obtener la sesión de Supabase o usuario no autenticado:', sessionError);
46 |       return { error: 'Usuario no autenticado o error de sesión.' };
47 |     }
48 | 
49 |     const token = sessionData.session.access_token;
50 |     const anonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
51 | 
52 |     if (!anonKey) {
53 |       console.error("VITE_SUPABASE_ANON_KEY no está configurada.");
54 |       return { error: "Error de configuración del cliente." };
55 |     }
56 | 
57 |     // 2. Llamar a la Edge Function usando fetch
58 |     const response = await fetch(
59 |       `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/create-checkout-session`,
60 |       {
61 |         method: 'POST',
62 |         headers: {
63 |           'Authorization': `Bearer ${token}`,
64 |           'Content-Type': 'application/json',
65 |           'apikey': anonKey,
66 |         },
67 |         body: JSON.stringify({ item }),
68 |       }
69 |     );
70 | 
71 |     const responseData = await response.json();
72 | 
73 |     if (!response.ok) {
74 |       console.error('Error en la respuesta de la Edge Function (create-checkout-session):', responseData);
75 |       // Usar el mensaje de error de la respuesta si existe, si no, un genérico
76 |       throw new Error(responseData.error || `Error ${response.status} del servidor`);
77 |     }
78 | 
79 |     console.log('URL de checkout recibida:', responseData.url);
80 |     return { url: responseData.url };
81 | 
82 |   } catch (error) { // error es 'unknown'
83 |     console.error('Error al llamar a la función create-checkout-session:', error);
84 |     // Manejo seguro del tipo 'unknown'
85 |     let errorMessage = 'Error desconocido al iniciar el pago.';
86 |     if (error instanceof Error) {
87 |         errorMessage = error.message;
88 |     } else if (typeof error === 'string') {
89 |         errorMessage = error;
90 |     }
91 |     return { error: `No se pudo iniciar el pago: ${errorMessage}` };
92 |   }
93 | };
94 | 
95 | /**
96 |  * Crea una sesión del portal de cliente de Stripe para gestionar suscripciones
97 |  * @returns Objeto con la URL del portal o un mensaje de error
98 |  */
99 | export interface CustomerPortalSessionResponse {
100 |   url?: string;
101 |   error?: string;
102 | }
103 | 
104 | export const createCustomerPortalSession = async (): Promise<CustomerPortalSessionResponse> => {
105 |   console.log('Solicitando sesión del portal de cliente de Stripe');
106 | 
107 |   try {
108 |     // 1. Obtener la sesión actual de Supabase para el token
109 |     // Añadir extensión .ts
110 |     const { supabase } = await import('../supabaseClient.ts');
111 |     const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
112 | 
113 |     if (sessionError || !sessionData?.session) {
114 |       console.error('Error al obtener la sesión de Supabase o usuario no autenticado:', sessionError);
115 |       return { error: 'Usuario no autenticado o error de sesión.' };
116 |     }
117 | 
118 |     const token = sessionData.session.access_token;
119 |     const anonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
120 | 
121 |     if (!anonKey) {
122 |       console.error("VITE_SUPABASE_ANON_KEY no está configurada.");
123 |       return { error: "Error de configuración del cliente." };
124 |     }
125 | 
126 |     // 2. Llamar a la Edge Function usando fetch
127 |     const response = await fetch(
128 |       `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/create-customer-portal-session`,
129 |       {
130 |         method: 'POST',
131 |         headers: {
132 |           'Authorization': `Bearer ${token}`,
133 |           'Content-Type': 'application/json',
134 |           'apikey': anonKey,
135 |         }
136 |         // No necesita body
137 |       }
138 |     );
139 | 
140 |     const responseData = await response.json();
141 | 
142 |     if (!response.ok) {
143 |       console.error('Error en la respuesta de la Edge Function (create-customer-portal-session):', responseData);
144 |       // Usar el mensaje de error de la respuesta si existe
145 |       throw new Error(responseData.error || `Error ${response.status} del servidor`);
146 |     }
147 | 
148 |     console.log('URL del portal de cliente recibida:', responseData.url);
149 |     return { url: responseData.url };
150 | 
151 |   } catch (error) { // error es 'unknown'
152 |     console.error('Error al llamar a la función create-customer-portal-session:', error);
153 |     // Manejo seguro del tipo 'unknown'
154 |     let errorMessage = 'Error desconocido al acceder al portal.';
155 |     if (error instanceof Error) {
156 |         errorMessage = error.message;
157 |     } else if (typeof error === 'string') {
158 |         errorMessage = error;
159 |     }
160 |     return { error: `No se pudo acceder al portal de cliente: ${errorMessage}` };
161 |   }
162 | };
```

src/services/supabase.ts
```
1 | // Importa los tipos necesarios
2 | import {
3 |     ProfileSettings,
4 |     Story,
5 |     StoryChapter,
6 |     StoryCharacter,
7 | } from "../types";
8 | 
9 | // --- Importa la instancia ÚNICA del cliente Supabase ---
10 | import { supabase } from "../supabaseClient"; // Ajusta esta ruta si es necesario
11 | 
12 | // --- Listener de Auth (Opcional, solo para logging) ---
13 | // Ya no inicializamos el cliente aquí, solo usamos el importado.
14 | supabase.auth.onAuthStateChange((event, session) => {
15 |     if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
16 |         console.log('Evento Auth en supabase.ts:', event, '- Usuario:', session?.user?.id);
17 |     } else if (event === 'SIGNED_OUT') {
18 |         console.log('Evento Auth en supabase.ts: SIGNED_OUT');
19 |     }
20 | });
21 | 
22 | // --- Funciones de Perfil ---
23 | 
24 | export const syncUserProfile = async (
25 |     userId: string,
26 |     // Renombramos el parámetro para claridad y ajustamos tipo
27 |     dataToSync: Partial<ProfileSettings> & { [key: string]: any },
28 | ): Promise<{ success: boolean; error?: any }> => {
29 |     try {
30 |         console.log(`[syncUserProfile_DEBUG] Attempting to sync for user ${userId} with data:`, dataToSync);
31 | 
32 |         // Preparamos los datos para upsert, asegurando que 'id' y 'updated_at' están presentes
33 |         const upsertData = {
34 |             id: userId,             // ID es necesario para upsert
35 |             ...dataToSync,         // Usamos directamente los datos mapeados (ej. child_age, special_need)
36 |             updated_at: new Date(), // Siempre actualizamos la fecha
37 |         };
38 | 
39 |         // Opcional: Asegurarse de que special_need sea null si es undefined, aunque upsert debería manejarlo
40 |         // Corregido: Usar notación de corchetes para evitar error de linting con snake_case
41 |         if (upsertData['special_need'] === undefined) {
42 |             upsertData['special_need'] = null;
43 |         }
44 | 
45 |         const { error } = await supabase
46 |             .from("profiles")
47 |             .upsert(upsertData); // <<< Pasamos el objeto correcto a upsert
48 | 
49 |         if (error) {
50 |             console.error("Error sincronizando perfil (posible RLS):", error);
51 |             throw error; // Re-lanzar para el catch general
52 |         }
53 |         console.log(`[syncUserProfile_DEBUG] Profile synced successfully for user ${userId}`);
54 |         return { success: true };
55 |     } catch (error) {
56 |         console.error("Fallo general en syncUserProfile:", error);
57 |         // Asegurarse de devolver un objeto Error estándar
58 |         const errorMessage = error instanceof Error ? error.message : String(error);
59 |         return { success: false, error: new Error(errorMessage) };
60 |     }
61 | };
62 | 
63 | export const getUserProfile = async (userId: string, retries = 2): Promise<{ success: boolean, profile?: ProfileSettings, error?: any }> => {
64 |     for (let attempt = 0; attempt <= retries; attempt++) {
65 |         try {
66 |             console.log(`Requesting profile for user: ${userId} (attempt ${attempt + 1}/${retries + 1})`);
67 | 
68 |             const { data, error } = await supabase
69 |                 .from("profiles")
70 |                 .select("*")
71 |                 .eq("id", userId)
72 |                 .single();
73 | 
74 |             if (error && error.code === 'PGRST116') {
75 |                 console.log(`Profile not found for user ${userId}. This is a definitive result, no retry.`);
76 |                 return { success: false }; // No profile is not a transient error
77 |             } else if (error) {
78 |                 console.warn(`Attempt ${attempt + 1} to fetch profile for ${userId} failed:`, error.message);
79 |                 if (attempt === retries) {
80 |                     console.error(`Final attempt to fetch profile for ${userId} failed after multiple retries.`, error);
81 |                     throw error; // Throw final error to be caught by the outer block
82 |                 }
83 |                 // Wait with exponential backoff before retrying
84 |                 await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
85 |                 continue; // Next attempt
86 |             }
87 | 
88 |             if (data) {
89 |                 console.log(`Successfully fetched profile data for user ${userId}.`);
90 |                 const profile: ProfileSettings = {
91 |                     language: data.language,
92 |                     preferences: data.preferences,
93 |                     stripe_customer_id: data.stripe_customer_id,
94 |                     subscription_status: data.subscription_status,
95 |                     subscription_id: data.subscription_id,
96 |                     plan_id: data.plan_id,
97 |                     current_period_end: data.current_period_end,
98 |                     voice_credits: data.voice_credits,
99 |                     monthly_stories_generated: data.monthly_stories_generated,
100 |                     monthly_voice_generations_used: data.monthly_voice_generations_used,
101 |                     has_completed_setup: data.has_completed_setup,
102 |                 };
103 |                 return { success: true, profile: profile };
104 |             }
105 | 
106 |             // This case should ideally not be reached if a profile is always created on sign-up
107 |             console.warn(`Unexpectedly found no profile data for user ${userId} without an error.`);
108 |             return { success: false };
109 | 
110 |         } catch (error) {
111 |             if (attempt === retries) {
112 |                 console.error(`A critical error occurred while fetching profile for ${userId}. All retries failed.`, error);
113 |                 return { success: false, error };
114 |             }
115 |             // Wait before the next attempt in case of a thrown error
116 |             await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
117 |         }
118 |     }
119 |     // This is returned if all retries fail
120 |     return { success: false, error: new Error('All attempts to fetch the profile have failed.') };
121 | };
122 | 
123 | // --- Funciones de Personajes ---
124 | 
125 | export const syncCharacter = async (
126 |     userId: string,
127 |     character: StoryCharacter,
128 | ): Promise<{ success: boolean; error?: any }> => {
129 |     try {
130 |         console.log(`[DEBUG] Sincronizando personaje "${character.name}" (ID: ${character.id}) para usuario ${userId}`);
131 |         const { data: existingChar, error: queryError } = await supabase
132 |             .from("characters")
133 |             .select("id, user_id")
134 |             .eq("id", character.id)
135 |             .maybeSingle();
136 | 
137 |         if (queryError) {
138 |             console.error(`[DEBUG] Error al verificar existencia del personaje:`, queryError);
139 |             throw queryError;
140 |         }
141 | 
142 |         const characterData = {
143 |             id: character.id,
144 |             user_id: userId,
145 |             name: character.name,
146 |             gender: character.gender,
147 |             description: character.description,
148 |             updated_at: new Date(),
149 |         };
150 | 
151 |         let result;
152 |         if (existingChar) {
153 |             console.log(`[DEBUG] Personaje ${character.id} existe. Actualizando.`);
154 |             if (existingChar.user_id !== userId) {
155 |                 console.error(`[DEBUG] ¡Error de seguridad! Intento de modificar personaje ${character.id} de otro usuario.`);
156 |                 return { success: false, error: new Error('No tienes permiso para modificar este personaje') };
157 |             }
158 |             result = await supabase
159 |                 .from("characters")
160 |                 .update(characterData)
161 |                 .eq("id", character.id);
162 |         } else {
163 |             console.log(`[DEBUG] Creando nuevo personaje con ID: ${character.id}`);
164 |             result = await supabase
165 |                 .from("characters")
166 |                 .insert(characterData);
167 |         }
168 | 
169 |         const { error } = result;
170 |         if (error) {
171 |             console.error(`[DEBUG] Error en operación upsert de personaje (posible RLS):`, error);
172 |             throw error;
173 |         }
174 | 
175 |         console.log(`[DEBUG] Personaje "${character.name}" guardado exitosamente.`);
176 |         return { success: true };
177 |     } catch (error) {
178 |         console.error("[DEBUG] Fallo general en syncCharacter:", error);
179 |         return { success: false, error };
180 |     }
181 | };
182 | 
183 | export const getUserCharacters = async (userId: string): Promise<{ success: boolean; characters?: StoryCharacter[]; error?: any }> => {
184 |     // --- CORREGIDO: Eliminada la consulta ineficiente ---
185 |     try {
186 |         console.log(`[DEBUG] Consultando personajes para usuario ${userId}`);
187 |         const { data, error } = await supabase
188 |             .from("characters")
189 |             .select("*") // Consulta correcta y única
190 |             .eq("user_id", userId);
191 | 
192 |         if (error) {
193 |             console.error(`[DEBUG] Error en consulta de personajes (posible RLS):`, error);
194 |             throw error;
195 |         }
196 | 
197 |         console.log(`[DEBUG] Personajes encontrados: ${data?.length || 0}`);
198 |         const characters: StoryCharacter[] = data ? data.map((char) => ({
199 |             id: char.id,
200 |             name: char.name,
201 |             gender: char.gender,
202 |             description: char.description || '',
203 |             created_at: char.created_at,
204 |             updated_at: char.updated_at,
205 |         })) : [];
206 | 
207 |         return { success: true, characters: characters };
208 |     } catch (error) {
209 |         console.error("Fallo general en getUserCharacters:", error);
210 |         return { success: false, error };
211 |     }
212 | };
213 | 
214 | export const deleteCharacter = async (characterId: string): Promise<{ success: boolean; error?: any }> => {
215 |     try {
216 |         const { data: { user } } = await supabase.auth.getUser();
217 |         if (!user) {
218 |             return { success: false, error: new Error('No autenticado') };
219 |         }
220 |         const userId = user.id;
221 | 
222 |         const { data: characterData, error: queryError } = await supabase
223 |             .from("characters")
224 |             .select("user_id")
225 |             .eq("id", characterId)
226 |             .maybeSingle();
227 | 
228 |         if (queryError) {
229 |             console.error("Error verificando propiedad:", queryError);
230 |             return { success: false, error: queryError };
231 |         }
232 |         if (!characterData) {
233 |             console.warn(`Personaje ${characterId} no encontrado para eliminar.`);
234 |             return { success: false, error: new Error('Personaje no encontrado') };
235 |         }
236 |         if (characterData.user_id !== userId) {
237 |             console.error(`Seguridad: Usuario ${userId} intentó eliminar personaje ${characterId} de ${characterData.user_id}`);
238 |             return { success: false, error: new Error('Permiso denegado') };
239 |         }
240 | 
241 |         const { error } = await supabase
242 |             .from("characters")
243 |             .delete()
244 |             .eq("id", characterId);
245 | 
246 |         if (error) {
247 |             console.error("Error eliminando personaje (RLS?):", error);
248 |             throw error;
249 |         }
250 |         return { success: true };
251 |     } catch (error) {
252 |         console.error("Fallo general en deleteCharacter:", error);
253 |         return { success: false, error };
254 |     }
255 | };
256 | 
257 | // --- Funciones de Historias ---
258 | 
259 | export const syncStory = async (userId: string, story: Story): Promise<{ success: boolean; error?: any }> => {
260 |     try {
261 |         console.log(`Sincronizando historia ${story.id} para usuario ${userId}`);
262 |         const storyData = {
263 |             id: story.id,
264 |             user_id: userId,
265 |             title: story.title,
266 |             content: story.content,
267 |             audio_url: story.audioUrl,
268 |             genre: story.options.genre,
269 |             story_format: story.options.format,
270 |             character_id: story.options.characters[0]?.id, // Primary character (first selected)
271 |             additional_details: story.additional_details,
272 |             updated_at: new Date(),
273 |         };
274 |         const { error } = await supabase.from("stories").upsert(storyData);
275 |         if (error) {
276 |             console.error(`Error al sincronizar historia ${story.id} (RLS?):`, error);
277 |             throw error;
278 |         }
279 |         console.log(`Historia ${story.id} sincronizada.`);
280 |         return { success: true };
281 |     } catch (error) {
282 |         console.error("Fallo general en syncStory:", error);
283 |         return { success: false, error };
284 |     }
285 | };
286 | 
287 | export const getUserStories = async (userId: string): Promise<{ success: boolean; stories?: Story[]; error?: any }> => {
288 |     try {
289 |         console.log(`Buscando historias para usuario ${userId}`);
290 |         const { data, error } = await supabase
291 |             .from("stories")
292 |             .select(`*, characters (*)`)
293 |             .eq("user_id", userId)
294 |             .order('created_at', { ascending: false }); // Ordenar por más reciente
295 | 
296 |         if (error) {
297 |             console.error("Error obteniendo historias (RLS?):", error);
298 |             throw error;
299 |         }
300 | 
301 |         const stories: Story[] = data ? data.map((story) => {
302 |             const characterData = story.characters;
303 |             console.log(`[getUserStories_DEBUG] DB raw title for story ${story.id}: "${story.title}"`); // <-- ADD THIS
304 | 
305 |             return {
306 |                 id: story.id,
307 |                 title: story.title || "Historia sin título",
308 |                 content: story.content,
309 |                 audioUrl: story.audio_url,
310 |                 options: {
311 |                     genre: story.genre,
312 |                     format: story.story_format,
313 |                     characters: [
314 |                         {
315 |                             id: characterData?.id || 'deleted_character',
316 |                             name: characterData?.name || 'Personaje Eliminado',
317 |                             gender: characterData?.gender || 'non-binary',
318 |                             hobbies: characterData?.hobbies || [],
319 |                             description: characterData?.description || '',
320 |                             profession: characterData?.profession || '',
321 |                             characterType: characterData?.character_type || '',
322 |                             personality: characterData?.personality || '',
323 |                         }
324 |                     ],
325 |                 },
326 |                 createdAt: story.created_at,
327 |                 additional_details: story.additional_details, // <-- Incluir aquí
328 |             };
329 |         }) : [];
330 | 
331 |         console.log(`Encontradas ${stories.length} historias`);
332 |         return { success: true, stories: stories };
333 |     } catch (error) {
334 |         console.error("Fallo general en getUserStories:", error);
335 |         return { success: false, error };
336 |     }
337 | };
338 | 
339 | /**
340 |  * Obtiene el número de capítulos existentes para una historia específica.
341 |  */
342 | export const getChapterCountForStory = async (storyId: string): Promise<{ count: number; error: Error | null }> => {
343 |     try {
344 |         const { count, error } = await supabase
345 |             .from('story_chapters')
346 |             .select('*', { count: 'exact', head: true }) // Solo necesitamos el conteo
347 |             .eq('story_id', storyId);
348 | 
349 |         if (error) {
350 |             console.error('Error al contar capítulos:', error);
351 |             return { count: 0, error };
352 |         }
353 | 
354 |         return { count: count ?? 0, error: null }; // Devuelve 0 si count es null
355 | 
356 |     } catch (error: any) {
357 |         console.error('Error inesperado al contar capítulos:', error);
358 |         return { count: 0, error };
359 |     }
360 | };
361 | 
362 | // --- Funciones para Capítulos ---
363 | 
364 | export const syncChapter = async (chapter: StoryChapter, storyId: string): Promise<{ success: boolean; error?: any }> => {
365 |     console.log("🚀 ~ syncChapter ~ chapter:", chapter)
366 |     try {
367 |         const { error } = await supabase
368 |             .from("story_chapters")
369 |             .upsert({
370 |                 id: chapter.id,
371 |                 story_id: storyId,
372 |                 chapter_number: chapter.chapterNumber,
373 |                 title: chapter.title,
374 |                 content: chapter.content,
375 |                 generation_method: chapter.generationMethod,
376 |                 custom_input: chapter.customInput,
377 |                 updated_at: new Date(),
378 |             });
379 |         if (error) {
380 |             console.error("Error sincronizando capítulo (RLS/FK?):", error);
381 |             throw error;
382 |         }
383 |         return { success: true };
384 |     } catch (error) {
385 |         console.error("Fallo general en syncChapter:", error);
386 |         return { success: false, error };
387 |     }
388 | };
389 | 
390 | export const getStoryChapters = async (storyId: string): Promise<{ success: boolean; chapters?: StoryChapter[]; error?: any }> => {
391 |     try {
392 |         const { data, error } = await supabase
393 |             .from("story_chapters")
394 |             .select("*")
395 |             .eq("story_id", storyId)
396 |             .order('chapter_number', { ascending: true });
397 | 
398 |         if (error) {
399 |             console.error("Error obteniendo capítulos (RLS/FK?):", error);
400 |             throw error;
401 |         }
402 |         const chapters: StoryChapter[] = data ? data.map((chapter) => ({
403 |             id: chapter.id,
404 |             chapterNumber: chapter.chapter_number,
405 |             title: chapter.title,
406 |             content: chapter.content,
407 |             createdAt: chapter.created_at,
408 |             generationMethod: chapter.generation_method,
409 |             customInput: chapter.custom_input,
410 |         })) : [];
411 |         return { success: true, chapters: chapters };
412 |     } catch (error) {
413 |         console.error("Fallo general en getStoryChapters:", error);
414 |         return { success: false, error };
415 |     }
416 | };
417 | 
418 | // --- Funciones para Archivos de Audio ---
419 | 
420 | export const syncAudioFile = async (
421 |     userId: string,
422 |     storyId: string,
423 |     chapterId: string | number,
424 |     voiceId: string,
425 |     audioUrl: string,
426 | ): Promise<{ success: boolean; error?: any }> => {
427 |     try {
428 |         const { error } = await supabase
429 |             .from("audio_files")
430 |             .upsert({
431 |                 user_id: userId,
432 |                 story_id: storyId,
433 |                 chapter_id: chapterId,
434 |                 voice_id: voiceId,
435 |                 url: audioUrl,
436 |             });
437 |         if (error) {
438 |             console.error("Error sincronizando archivo de audio (RLS/FK?):", error);
439 |             throw error;
440 |         }
441 |         return { success: true };
442 |     } catch (error) {
443 |         console.error("Fallo general en syncAudioFile:", error);
444 |         return { success: false, error };
445 |     }
446 | };
447 | 
448 | export const getUserAudios = async (userId: string): Promise<{ success: boolean; audios?: any[]; error?: any }> => { // Ajustar tipo 'audios' si tienes uno específico
449 |     try {
450 |         const { data, error } = await supabase
451 |             .from("audio_files")
452 |             .select("*")
453 |             .eq("user_id", userId);
454 | 
455 |         if (error) {
456 |             console.error("Error obteniendo archivos de audio (RLS?):", error);
457 |             throw error;
458 |         }
459 |         const audios = data || [];
460 |         return { success: true, audios: audios };
461 |     } catch (error) {
462 |         console.error("Fallo general en getUserAudios:", error);
463 |         return { success: false, error };
464 |     }
465 | };
466 | 
467 | // --- Funciones para Preferencias de Voz ---
468 | 
469 | export const setCurrentVoice = async (userId: string, voiceId: string): Promise<{ success: boolean; error?: any }> => {
470 |     try {
471 |         // Paso 1: Resetear la voz actual
472 |         await supabase
473 |             .from("user_voices")
474 |             .update({ is_current: false })
475 |             .eq("user_id", userId)
476 |             .eq("is_current", true);
477 | 
478 |         // Paso 2: Establecer la nueva voz actual
479 |         const { error } = await supabase
480 |             .from("user_voices")
481 |             .upsert({
482 |                 user_id: userId,
483 |                 voice_id: voiceId,
484 |                 is_current: true,
485 |                 updated_at: new Date(),
486 |             });
487 |         if (error) {
488 |             console.error("Error en upsert de voz actual (RLS?):", error);
489 |             throw error;
490 |         }
491 |         return { success: true };
492 |     } catch (error) {
493 |         console.error("Fallo general en setCurrentVoice:", error);
494 |         return { success: false, error };
495 |     }
496 | };
497 | 
498 | export const getCurrentVoice = async (userId: string): Promise<{ success: boolean; voiceId?: string | null; error?: any }> => {
499 |     try {
500 |         const { data, error } = await supabase
501 |             .from("user_voices")
502 |             .select("voice_id")
503 |             .eq("user_id", userId)
504 |             .eq("is_current", true)
505 |             .maybeSingle();
506 | 
507 |         if (error) {
508 |             console.error("Error obteniendo voz actual (RLS?):", error);
509 |             throw error;
510 |         }
511 |         return { success: true, voiceId: data?.voice_id || null };
512 |     } catch (error) {
513 |         console.error("Fallo general en getCurrentVoice:", error);
514 |         return { success: false, error };
515 |     }
516 | };
517 | 
518 | 
519 | // --- Servicio de Cola de Sincronización ---
520 | // (Se mantiene la versión mejorada con re-encolado)
521 | interface SyncQueueItem {
522 |     table: string;
523 |     operation: "insert" | "update" | "delete";
524 |     data: any;
525 |     timestamp: number;
526 | }
527 | 
528 | class SyncQueueService {
529 |     private static instance: SyncQueueService;
530 |     private queue: SyncQueueItem[] = [];
531 |     private isProcessing = false;
532 |     private readonly STORAGE_KEY = "sync_queue";
533 | 
534 |     private constructor() {
535 |         this.loadQueue();
536 |         if (typeof window !== "undefined" && !window.hasOwnProperty('_syncQueueListenerAdded')) {
537 |             window.addEventListener("online", () => this.processQueue());
538 |             (window as any)._syncQueueListenerAdded = true;
539 |         }
540 |     }
541 | 
542 |     static getInstance(): SyncQueueService {
543 |         if (!SyncQueueService.instance) {
544 |             SyncQueueService.instance = new SyncQueueService();
545 |         }
546 |         return SyncQueueService.instance;
547 |     }
548 | 
549 |     private loadQueue() {
550 |         if (typeof localStorage === 'undefined') return;
551 |         try {
552 |             const savedQueue = localStorage.getItem(this.STORAGE_KEY);
553 |             if (savedQueue) {
554 |                 this.queue = JSON.parse(savedQueue);
555 |                 console.log(`Cola de sincronización cargada con ${this.queue.length} elementos.`);
556 |             }
557 |         } catch (error) {
558 |             console.error("Error cargando cola de sincronización:", error);
559 |             this.queue = [];
560 |         }
561 |     }
562 | 
563 |     private saveQueue() {
564 |         if (typeof localStorage === 'undefined') return;
565 |         try {
566 |             localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.queue));
567 |         } catch (error) {
568 |             console.error("Error guardando cola de sincronización:", error);
569 |         }
570 |     }
571 | 
572 |     addToQueue(table: string, operation: "insert" | "update" | "delete", data: any,) {
573 |         console.log(`Añadiendo a cola: ${operation} en ${table}`, data);
574 |         this.queue.push({ table, operation, data, timestamp: Date.now() });
575 |         this.saveQueue();
576 |         if (typeof navigator !== 'undefined' && navigator.onLine) {
577 |             this.processQueue();
578 |         }
579 |     }
580 | 
581 |     async processQueue() {
582 |         if (this.isProcessing || this.queue.length === 0 || (typeof navigator !== 'undefined' && !navigator.onLine)) {
583 |             if (this.isProcessing) console.log("Cola ya en proceso.");
584 |             return;
585 |         }
586 |         console.log(`Procesando cola: ${this.queue.length} elementos.`);
587 |         this.isProcessing = true;
588 |         const itemsToProcess = [...this.queue];
589 |         this.queue = [];
590 |         this.saveQueue();
591 |         const failedItems: SyncQueueItem[] = [];
592 | 
593 |         try {
594 |             for (const item of itemsToProcess) {
595 |                 let success = false;
596 |                 console.log(`Procesando: ${item.operation} en ${item.table}`); // No loguear item.data por defecto (puede ser grande)
597 |                 try {
598 |                     let operationError = null;
599 |                     switch (item.operation) {
600 |                         case "insert":
601 |                         case "update":
602 |                             const { error } = await supabase.from(item.table).upsert(item.data);
603 |                             operationError = error;
604 |                             break;
605 |                         case "delete":
606 |                             if (!item.data?.id) {
607 |                                 console.error("Datos para DELETE sin ID:", item);
608 |                                 operationError = new Error("Datos para DELETE sin ID");
609 |                                 break;
610 |                             }
611 |                             const { error: deleteError } = await supabase.from(item.table).delete().eq("id", item.data.id);
612 |                             operationError = deleteError;
613 |                             break;
614 |                     }
615 |                     if (operationError) {
616 |                         console.error(`Error procesando item [${item.operation} ${item.table}]:`, operationError);
617 |                     } else {
618 |                         console.log(`Item procesado: ${item.operation} ${item.table}`);
619 |                         success = true;
620 |                     }
621 |                 } catch (processingError) {
622 |                     console.error(`Error inesperado procesando item:`, processingError);
623 |                 }
624 |                 if (!success) failedItems.push(item);
625 |             }
626 |         } finally {
627 |             if (failedItems.length > 0) {
628 |                 console.warn(`Re-encolando ${failedItems.length} elementos fallidos.`);
629 |                 this.queue = [...failedItems, ...this.queue];
630 |                 this.saveQueue();
631 |             }
632 |             console.log(`Procesamiento de cola finalizado. Pendientes: ${this.queue.length}`);
633 |             this.isProcessing = false;
634 |         }
635 |     }
636 |     getQueueLength(): number { return this.queue.length; }
637 | }
638 | 
639 | export const syncQueue = SyncQueueService.getInstance();
```

src/services/syncService.ts
```
1 | import { useUserStore } from "../store/user/userStore";
2 | import { supabase } from "../supabaseClient";
3 | 
4 | /**
5 |  * Servicio para INICIAR la sincronización de datos del usuario con Supabase
6 |  * delegando la carga real al userStore.
7 |  */
8 | export const syncUserData = async (): Promise<boolean> => {
9 |     console.log("Intentando iniciar sincronización de datos...");
10 |     try {
11 |         // 1. Verificar conexión (ligero y útil)
12 |         if (typeof navigator !== 'undefined' && !navigator.onLine) {
13 |             console.log("Offline. Sincronización pospuesta.");
14 |             return false;
15 |         }
16 | 
17 |         // 2. Verificar si hay una sesión activa usando el cliente Supabase
18 |         // Esto es más directo que llamar a getCurrentUser de supabaseAuth
19 |         const { data: { session }, error: sessionError } = await supabase.auth.getSession();
20 | 
21 |         if (sessionError) {
22 |             console.error("Error al obtener la sesión:", sessionError.message);
23 |             // Considerar si llamar a checkAuth aquí para limpiar el estado local si falla
24 |             // await useUserStore.getState().checkAuth();
25 |             return false;
26 |         }
27 | 
28 |         if (!session || !session.user) {
29 |             console.log("No hay sesión de usuario activa, no se inicia sincronización.");
30 |             // Si no hay sesión, checkAuth se encargará de poner el estado de usuario a null
31 |             // No necesitamos hacer nada más aquí, la UI reaccionará al estado nulo del userStore
32 |             // Opcionalmente, puedes llamar a checkAuth para asegurar limpieza:
33 |             // await useUserStore.getState().checkAuth();
34 |             return false;
35 |         }
36 | 
37 |         const userId = session.user.id;
38 |         console.log(`Sesión activa detectada para usuario ${userId}. Iniciando proceso checkAuth/sync.`);
39 | 
40 |         // 3. Disparar el proceso de carga centralizado en userStore
41 |         // checkAuth() AHORA es responsable de:
42 |         //    a) Confirmar la sesión (ya lo hicimos, pero checkAuth lo reconfirma)
43 |         //    b) Llamar a getUserProfile para obtener datos de perfil (incluyendo Stripe/límites)
44 |         //    c) Actualizar userStore.user y userStore.profileSettings
45 |         //    d) Llamar a syncAllUserData(userId) DENTRO de userStore
46 |         //    e) syncAllUserData llamará a los load...FromSupabase de los otros stores.
47 |         const checkAuthSuccessful = await useUserStore.getState().checkAuth();
48 | 
49 |         if (checkAuthSuccessful) {
50 |             console.log("Proceso checkAuth completado exitosamente. La carga de datos debería estar en curso o finalizada por userStore.");
51 |             return true;
52 |         } else {
53 |             // checkAuth devuelve false si no hay usuario o si hubo un error interno en checkAuth.
54 |             console.warn("checkAuth() devolvió false. La sincronización podría no haberse completado.");
55 |             return false;
56 |         }
57 | 
58 |     } catch (error) {
59 |         // Captura errores generales que podrían ocurrir en este flujo
60 |         console.error("Error inesperado en syncUserData:", error);
61 |         return false;
62 |     }
63 | };
64 | 
65 | /**
66 |  * Escuchar cambios en la conectividad para sincronizar
67 |  * cuando el usuario vuelve a estar online.
68 |  */
69 | export const initSyncListeners = () => {
70 |     // Solo ejecutar en el cliente
71 |     if (typeof window !== "undefined" && !window.hasOwnProperty('_syncListenersInitialized')) {
72 |         console.log("Inicializando listeners de conectividad...");
73 |         // Sincronizar cuando vuelve la conexión
74 |         window.addEventListener("online", () => {
75 |             console.log("Evento 'online' detectado, intentando sincronizar datos...");
76 |             syncUserData(); // Llama a la función refactorizada
77 |         });
78 |         // Sincronizar cuando cambia el estado de visibilidad (útil si la pestaña estuvo inactiva)
79 |         document.addEventListener('visibilitychange', () => {
80 |             if (document.visibilityState === 'visible') {
81 |                 console.log("Pestaña visible, intentando sincronizar datos...");
82 |                 syncUserData();
83 |             }
84 |         });
85 |         // Añadir un flag para evitar duplicar listeners si esta función se llama más de una vez
86 |         (window as any)._syncListenersInitialized = true;
87 |     } else if (typeof window !== "undefined") {
88 |         console.log("Listeners de conectividad ya inicializados.");
89 |     }
90 | };
91 | 
92 | /**
93 |  * Inicializar el servicio de sincronización.
94 |  * Esta función debe llamarse UNA SOLA VEZ al inicio de la aplicación.
95 |  */
96 | export const initSyncService = () => {
97 |     // Iniciar listeners de conexión y visibilidad
98 |     initSyncListeners();
99 | 
100 |     console.log("Servicio de sincronización inicializado.");
101 | 
102 |     // Intentar sincronización inicial inmediatamente si hay conexión
103 |     // syncUserData ya verifica la conexión internamente.
104 |     console.log("Intentando sincronización inicial...");
105 |     syncUserData();
106 | 
107 | };
```

src/store/index.ts
```
1 | // Exportación de los stores individuales
2 | export * from './user/userStore';
3 | // Character store eliminado - usar charactersService en su lugar
4 | export * from './storyOptions/storyOptionsStore';
5 | export * from './stories/storiesStore';
6 | export * from './stories/chapters/chaptersStore';
7 | export * from './stories/audio/audioStore';
8 | 
9 | // Exportación del generador de historias
10 | export * from './stories/storyGenerator'; 
```

supabase/.branches/_current_branch
```
1 | main
```

src/pages/AuthCallback.tsx
```
1 | import { useEffect, useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { useUserStore } from "../store/user/userStore";
4 | import { supabase } from "../supabaseClient";
5 | import { getUserProfile } from "../services/supabase";
6 | 
7 | export default function AuthCallback() {
8 |   const navigate = useNavigate();
9 |   const { loginUser, hasCompletedProfile } = useUserStore();
10 |   const [error, setError] = useState<string | null>(null);
11 | 
12 |   useEffect(() => {
13 |     const handleAuthCallback = async () => {
14 |       try {
15 |         // Obtener datos de la redirección de OAuth
16 |         const { data, error } = await supabase.auth.getSession();
17 | 
18 |         if (error) {
19 |           console.error("Error en el callback de autenticación:", error.message);
20 |           setError(error.message);
21 |           setTimeout(() => navigate("/login"), 3000);
22 |           return;
23 |         }
24 | 
25 |         if (data?.session?.user) {
26 |           // Usuario autenticado correctamente
27 |           const userId = data.session.user.id;
28 |           
29 |           loginUser({
30 |             id: userId,
31 |             email: data.session.user.email || "",
32 |           });
33 |           
34 |           try {
35 |             // Verificar si el usuario ya tiene un perfil configurado
36 |             const { success, profile } = await getUserProfile(userId);
37 |             
38 |             if (success && profile) {
39 |               // Si ya tiene perfil, redirigir a la página principal
40 |               navigate("/home");
41 |             } else {
42 |               // Si no tiene perfil, redirigir a la configuración de perfil
43 |               navigate("/profile");
44 |             }
45 |           } catch (profileError) {
46 |             console.error("Error al verificar perfil:", profileError);
47 |             // En caso de error, mandamos a la configuración por seguridad
48 |             navigate("/profile");
49 |           }
50 |         } else {
51 |           // No hay sesión, redirigir al login
52 |           navigate("/login");
53 |         }
54 |       } catch (err) {
55 |         console.error("Error inesperado en callback:", err);
56 |         setError("Ocurrió un error inesperado");
57 |         setTimeout(() => navigate("/login"), 3000);
58 |       }
59 |     };
60 | 
61 |     handleAuthCallback();
62 |   }, [navigate, loginUser]);
63 | 
64 |   return (
65 |     <div className="gradient-bg min-h-screen flex flex-col items-center justify-center p-6">
66 |       <div className="glass-card p-8 w-full max-w-md text-center">
67 |         {error ? (
68 |           <>
69 |             <h2 className="text-2xl font-bold text-white mb-4">Error de autenticación</h2>
70 |             <p className="text-white/80 mb-4">{error}</p>
71 |             <p className="text-white/60">Redirigiendo al inicio de sesión...</p>
72 |           </>
73 |         ) : (
74 |           <>
75 |             <div className="animate-spin h-12 w-12 border-4 border-white rounded-full border-t-transparent mx-auto mb-6"></div>
76 |             <h2 className="text-2xl font-bold text-white mb-4">Autenticando...</h2>
77 |             <p className="text-white/80">Estamos verificando tu información</p>
78 |           </>
79 |         )}
80 |       </div>
81 |     </div>
82 |   );
83 | } 
```

src/pages/CharacterName.tsx
```
1 | import React, { useState, useEffect } from "react";
2 | import { useNavigate, useLocation } from "react-router-dom";
3 | import { User, AlertCircle, Users, Edit3 } from "lucide-react";
4 | import { motion } from "framer-motion";
5 | import { supabase } from "@/supabaseClient";
6 | import { useIsMobile } from "@/hooks/use-mobile";
7 | import { StoryCharacter } from "@/types";
8 | import BackButton from "../components/BackButton";
9 | import PageTransition from "../components/PageTransition";
10 | import { Input } from "@/components/ui/input";
11 | import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
12 | import { Textarea } from "@/components/ui/textarea";
13 | import { toast } from "sonner";
14 | 
15 | // Define a type for the window with the nameTimeout property
16 | declare global {
17 |   interface Window {
18 |     nameTimeout: NodeJS.Timeout | undefined;
19 |   }
20 | }
21 | 
22 | export default function CharacterName() {
23 |   const navigate = useNavigate();
24 |   const location = useLocation();
25 |   const isMobile = useIsMobile();
26 |   
27 |   // Obtener los parámetros de la URL
28 |   const searchParams = new URLSearchParams(location.search);
29 |   const fromManagement = searchParams.get('from') === 'management';
30 |   const actionCreate = searchParams.get('action') === 'create';
31 |   const editCharacterId = searchParams.get('edit');
32 |   
33 |   // Estado para el personaje y validaciones
34 |   const [character, setCharacter] = useState({
35 |     name: '',
36 |     gender: 'male' as const,
37 |     description: ''
38 |   });
39 |   const [editingCharacter, setEditingCharacter] = useState<StoryCharacter | null>(null);
40 |   const [savedCharacters, setSavedCharacters] = useState<StoryCharacter[]>([]);
41 |   const [loading, setLoading] = useState(false);
42 |   const [errors, setErrors] = useState<{[key: string]: string}>({});
43 |   const [isFocused, setIsFocused] = useState(false);
44 |   const [hasTyped, setHasTyped] = useState(false);
45 |   
46 |   // Cargar datos iniciales
47 |   useEffect(() => {
48 |     const loadInitialData = async () => {
49 |       try {
50 |         const { data: { user } } = await supabase.auth.getUser();
51 |         if (!user) {
52 |           navigate('/login');
53 |           return;
54 |         }
55 | 
56 |         // Cargar personajes guardados
57 |         const { data: characters } = await supabase
58 |           .from('characters')
59 |           .select('*')
60 |           .eq('user_id', user.id);
61 |         
62 |         setSavedCharacters(characters || []);
63 | 
64 |         // Si estamos editando, cargar datos del personaje
65 |         if (editCharacterId) {
66 |           const editChar = characters?.find(char => char.id === editCharacterId);
67 |           if (editChar) {
68 |             setEditingCharacter(editChar);
69 |             setCharacter({
70 |               name: editChar.name,
71 |               gender: editChar.gender,
72 |               description: editChar.description
73 |             });
74 |           }
75 |         }
76 |       } catch (error) {
77 |         console.error('Error loading initial data:', error);
78 |         toast.error('Error cargando datos');
79 |       }
80 |     };
81 | 
82 |     loadInitialData();
83 |   }, [editCharacterId, navigate]);
84 | 
85 |   // Validar formulario
86 |   const validateForm = () => {
87 |     const newErrors: {[key: string]: string} = {};
88 |     
89 |     if (!character.name.trim()) {
90 |       newErrors.name = 'Name is required';
91 |     } else if (character.name.length < 2) {
92 |       newErrors.name = 'Name must be at least 2 characters';
93 |     } else if (checkNameExists(character.name)) {
94 |       newErrors.name = `You already have a character named "${character.name}"`;
95 |     }
96 |     
97 |     if (!character.description.trim()) {
98 |       newErrors.description = 'Description is required';
99 |     } else if (character.description.length < 10) {
100 |       newErrors.description = 'Description must be at least 10 characters';
101 |     }
102 |     
103 |     setErrors(newErrors);
104 |     return Object.keys(newErrors).length === 0;
105 |   };
106 | 
107 |   // Verificar si el nombre ya existe
108 |   const checkNameExists = (nameToCheck: string): boolean => {
109 |     if (!nameToCheck.trim()) return false;
110 |     
111 |     return savedCharacters.some(
112 |       char => char.name.toLowerCase() === nameToCheck.toLowerCase() && 
113 |               char.id !== editingCharacter?.id
114 |     );
115 |   };
116 |   
117 |   // Manejar guardado del personaje
118 |   const handleSave = async () => {
119 |     if (!validateForm()) return;
120 |     
121 |     setLoading(true);
122 |     try {
123 |       // Verificar conexión de red
124 |       if (!navigator.onLine) {
125 |         toast.error('No internet connection', {
126 |           description: 'Check your connection and try again'
127 |         });
128 |         return;
129 |       }
130 | 
131 |       const { data: { user }, error: userError } = await supabase.auth.getUser();
132 |       if (userError || !user) {
133 |         toast.error('Session expired', {
134 |           description: 'Please log in again'
135 |         });
136 |         navigate('/login');
137 |         return;
138 |       }
139 | 
140 |       let result;
141 |       if (editingCharacter) {
142 |         // Verificar que el personaje aún existe y pertenece al usuario
143 |         const { data: existingChar } = await supabase
144 |           .from('characters')
145 |           .select('user_id')
146 |           .eq('id', editingCharacter.id)
147 |           .single();
148 |         
149 |         if (!existingChar) {
150 |           toast.error('Character not found', {
151 |             description: 'The character may have been deleted'
152 |           });
153 |           navigate('/characters-management');
154 |           return;
155 |         }
156 |         
157 |         if (existingChar.user_id !== user.id) {
158 |           toast.error('No permissions', {
159 |             description: 'You cannot edit this character'
160 |           });
161 |           navigate('/characters-management');
162 |           return;
163 |         }
164 | 
165 |         // Actualizar personaje existente
166 |         result = await supabase
167 |           .from('characters')
168 |           .update({
169 |             name: character.name,
170 |             gender: character.gender,
171 |             description: character.description,
172 |             updated_at: new Date().toISOString()
173 |           })
174 |           .eq('id', editingCharacter.id)
175 |           .select()
176 |           .single();
177 |       } else {
178 |         // Crear nuevo personaje
179 |         result = await supabase
180 |           .from('characters')
181 |           .insert({
182 |             user_id: user.id,
183 |             name: character.name,
184 |             gender: character.gender,
185 |             description: character.description
186 |           })
187 |           .select()
188 |           .single();
189 |       }
190 | 
191 |       if (result.error) {
192 |         console.error('Supabase error:', result.error);
193 |         
194 |         // Manejar errores específicos
195 |         if (result.error.code === '23505') {
196 |           toast.error('Nombre duplicado', {
197 |             description: 'Ya tienes un personaje con ese nombre'
198 |           });
199 |           setErrors({ name: 'Ya tienes un personaje con ese nombre' });
200 |           return;
201 |         }
202 |         
203 |         throw result.error;
204 |       }
205 | 
206 |       toast.success(editingCharacter ? "¡Personaje actualizado!" : "¡Personaje creado!", {
207 |         duration: 1500,
208 |         description: "Continuando a la selección de género..."
209 |       });
210 | 
211 |       // Navegar a la selección de género
212 |       setTimeout(() => {
213 |         const params = new URLSearchParams();
214 |         if (fromManagement) params.set('from', 'management');
215 |         if (actionCreate) params.set('action', 'create');
216 |         if (editCharacterId) params.set('edit', editCharacterId);
217 |         navigate(`/story-genre${params.toString() ? '?' + params.toString() : ''}`);
218 |       }, 1000);
219 | 
220 |     } catch (error: any) {
221 |       console.error('Error saving character:', error);
222 |       
223 |       // Manejar diferentes tipos de errores
224 |       if (error.message?.includes('network')) {
225 |         toast.error('Error de conexión', {
226 |           description: 'Verifica tu conexión a internet'
227 |         });
228 |       } else if (error.message?.includes('timeout')) {
229 |         toast.error('Tiempo de espera agotado', {
230 |           description: 'El servidor tardó demasiado en responder'
231 |         });
232 |       } else {
233 |         toast.error('Error guardando personaje', {
234 |           description: 'Intenta nuevamente o contacta soporte'
235 |         });
236 |       }
237 |     } finally {
238 |       setLoading(false);
239 |     }
240 |   };
241 | 
242 |   const handleSubmit = (e: React.FormEvent) => {
243 |     e.preventDefault();
244 |     handleSave();
245 |   };
246 |   
247 |   // Manejar cambios en los campos
248 |   const handleFieldChange = (field: keyof typeof character, value: string) => {
249 |     setCharacter(prev => ({ ...prev, [field]: value }));
250 |     
251 |     // Limpiar errores del campo cuando el usuario escribe
252 |     if (errors[field]) {
253 |       setErrors(prev => ({ ...prev, [field]: '' }));
254 |     }
255 |     
256 |     // Validación en tiempo real para el nombre
257 |     if (field === 'name' && value.trim()) {
258 |       if (checkNameExists(value)) {
259 |         setErrors(prev => ({ ...prev, name: `You already have a character named "${value}"` }));
260 |       }
261 |     }
262 |     
263 |     if (!hasTyped && value.length > 0) {
264 |       setHasTyped(true);
265 |     }
266 |   };
267 |   
268 |   const handleKeyDown = (e: React.KeyboardEvent) => {
269 |     if (e.key === "Enter" && e.ctrlKey) {
270 |       e.preventDefault();
271 |       handleSave();
272 |     }
273 |   };
274 |   
275 |   // Efecto para limpiar timeouts
276 |   useEffect(() => {
277 |     return () => {
278 |       clearTimeout(window.nameTimeout);
279 |     };
280 |   }, []);
281 | 
282 |   // Efecto para manejar el estado online/offline
283 |   useEffect(() => {
284 |     const handleOnlineStatusChange = () => {
285 |       if (!navigator.onLine) {
286 |         toast.error('Sin conexión a internet', {
287 |           description: 'Algunas funciones pueden no estar disponibles'
288 |         });
289 |       }
290 |     };
291 | 
292 |     window.addEventListener('online', handleOnlineStatusChange);
293 |     window.addEventListener('offline', handleOnlineStatusChange);
294 | 
295 |     return () => {
296 |       window.removeEventListener('online', handleOnlineStatusChange);
297 |       window.removeEventListener('offline', handleOnlineStatusChange);
298 |     };
299 |   }, []);
300 |   
301 |   return (
302 |     <PageTransition>
303 |       <div 
304 |         className="min-h-screen flex flex-col items-center justify-center p-6"
305 |         style={{
306 |           backgroundColor: 'black',
307 |         }}
308 |       >
309 |         <BackButton />
310 |         
311 |         <div className="w-full max-w-md flex flex-col items-center">
312 |           <motion.div
313 |             initial={{ scale: 0.8, opacity: 0 }}
314 |             animate={{ scale: 1, opacity: 1 }}
315 |             transition={{ duration: 0.5 }}
316 |             className="w-24 h-24 rounded-full bg-[#7DC4E0]/20 border-2 border-[#7DC4E0]/40 flex items-center justify-center mb-6 shadow-md"
317 |           >
318 |             {editingCharacter ? (
319 |               <Edit3 size={40} className="text-[#7DC4E0]" />
320 |             ) : (
321 |               <Users size={40} className="text-[#7DC4E0]" />
322 |             )}
323 |           </motion.div>
324 |           
325 |           <h1 className="text-3xl font-bold text-[#BB79D1] mb-6 text-center font-heading drop-shadow-lg">
326 |             {editingCharacter ? 'Edit Character' : 'Create Character'}
327 |           </h1>
328 |           
329 |           <p className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-8 font-medium shadow-sm">
330 |             {editingCharacter ? 'Modify your character\'s intimate details' : 'Create your custom character for unique erotic stories'}
331 |           </p>
332 |           
333 |           <form onSubmit={handleSubmit} className="w-full space-y-6">
334 |             {/* Name field */}
335 |             <div className="space-y-2">
336 |               <label className="text-sm font-medium text-[#BB79D1] flex items-center gap-2">
337 |                 <User size={16} />
338 |                 Character name
339 |               </label>
340 |               <div className={`relative transition-all duration-300 ease-in-out ${isFocused ? 'scale-105' : 'scale-100'}`}>
341 |                 <Input 
342 |                   value={character.name}
343 |                   onChange={(e) => handleFieldChange('name', e.target.value)}
344 |                   onFocus={() => setIsFocused(true)}
345 |                   onBlur={() => setIsFocused(false)}
346 |                   onKeyDown={handleKeyDown}
347 |                   placeholder="Ej: Alex, María, Jordan..."
348 |                   className={`text-lg h-14 font-medium rounded-xl shadow-md transition-all ${
349 |                     errors.name 
350 |                       ? 'border-[#F6A5B7] text-[#F6A5B7] bg-[#F6A5B7]/10' 
351 |                       : 'text-[#222] bg-white/90 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-2 focus:ring-[#BB79D1]/20'
352 |                   } placeholder:text-[#BB79D1]/50`}
353 |                   autoFocus
354 |                   disabled={loading}
355 |                 />
356 |                 {errors.name && (
357 |                   <div className="mt-2 flex items-center text-[#F6A5B7] gap-2 p-2 bg-white/80 rounded-lg border border-[#F6A5B7]/30 shadow-sm">
358 |                     <AlertCircle size={16} />
359 |                     <span className="text-sm font-medium">{errors.name}</span>
360 |                   </div>
361 |                 )}
362 |               </div>
363 |             </div>
364 | 
365 |             {/* Gender selector */}
366 |             <div className="space-y-2">
367 |               <label className="text-sm font-medium text-[#BB79D1] flex items-center gap-2">
368 |                 <Users size={16} />
369 |                 Character gender
370 |               </label>
371 |               <Select
372 |                 value={character.gender}
373 |                 onValueChange={(value) => handleFieldChange('gender', value)}
374 |                 disabled={loading}
375 |               >
376 |                 <SelectTrigger className={`h-14 text-lg font-medium rounded-xl shadow-md bg-white/90 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-2 focus:ring-[#BB79D1]/20 ${loading ? 'opacity-50' : ''}`}>
377 |                   <SelectValue placeholder="Select gender" />
378 |                 </SelectTrigger>
379 |                 <SelectContent>
380 |                   <SelectItem value="male" className="text-lg py-3">
381 |                     <div className="flex items-center gap-2">
382 |                       <span className="text-blue-600">♂</span>
383 |                       Male
384 |                     </div>
385 |                   </SelectItem>
386 |                   <SelectItem value="female" className="text-lg py-3">
387 |                     <div className="flex items-center gap-2">
388 |                       <span className="text-pink-600">♀</span>
389 |                       Female
390 |                     </div>
391 |                   </SelectItem>
392 |                   <SelectItem value="non-binary" className="text-lg py-3">
393 |                     <div className="flex items-center gap-2">
394 |                       <span className="text-purple-600">⚧</span>
395 |                       Non-binary
396 |                     </div>
397 |                   </SelectItem>
398 |                 </SelectContent>
399 |               </Select>
400 |             </div>
401 | 
402 |             {/* Description field */}
403 |             <div className="space-y-2">
404 |               <label className="text-sm font-medium text-[#BB79D1] flex items-center gap-2">
405 |                 <Edit3 size={16} />
406 |                 Character description
407 |               </label>
408 |               <div className="relative">
409 |                 <Textarea
410 |                   value={character.description}
411 |                   onChange={(e) => {
412 |                     if (e.target.value.length <= 500) {
413 |                       handleFieldChange('description', e.target.value);
414 |                     }
415 |                   }}
416 |                   placeholder="Describe your character: personality, appearance, desires, profession, hobbies, preferences, fantasies..."
417 |                   className={`min-h-[120px] text-base font-medium rounded-xl shadow-md transition-all resize-none ${
418 |                     errors.description 
419 |                       ? 'border-[#F6A5B7] text-[#F6A5B7] bg-[#F6A5B7]/10' 
420 |                       : 'text-[#222] bg-white/90 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-2 focus:ring-[#BB79D1]/20'
421 |                   } placeholder:text-[#BB79D1]/50`}
422 |                   disabled={loading}
423 |                   onKeyDown={handleKeyDown}
424 |                   maxLength={500}
425 |                 />
426 |                 <div className="absolute bottom-3 right-3 text-xs text-[#BB79D1]/60 bg-white/80 rounded px-2 py-1">
427 |                   {character.description.length}/500
428 |                 </div>
429 |                 {errors.description && (
430 |                   <div className="mt-2 flex items-center text-[#F6A5B7] gap-2 p-2 bg-white/80 rounded-lg border border-[#F6A5B7]/30 shadow-sm">
431 |                     <AlertCircle size={16} />
432 |                     <span className="text-sm font-medium">{errors.description}</span>
433 |                   </div>
434 |                 )}
435 |               </div>
436 |               <p className="text-xs text-[#7DC4E0] bg-white/60 rounded-lg px-3 py-2">
437 |                 ✨ The more detailed the description, the more personalized and intimate your stories will be
438 |               </p>
439 |             </div>
440 |             
441 |             {/* Buttons */}
442 |             <div className={`flex gap-4 w-full ${isMobile ? 'flex-col' : 'flex-row'}`}>
443 |               <button
444 |                 type="button"
445 |                 onClick={() => navigate(fromManagement ? "/characters-management" : "/character-selection")}
446 |                 className={`${isMobile ? 'w-full' : 'w-[48%]'} text-lg py-4 shadow-md hover:shadow-lg transition-all rounded-2xl font-medium bg-white/70 hover:bg-white/90 text-[#BB79D1] border border-[#BB79D1]/30 disabled:opacity-50`}
447 |                 disabled={loading}
448 |               >
449 |                 Back
450 |               </button>
451 |               
452 |               <button
453 |                 type="submit"
454 |                 className={`${isMobile ? 'w-full' : 'w-[48%]'} text-lg py-4 shadow-md hover:shadow-lg transition-all bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white rounded-2xl font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2`}
455 |                 disabled={loading || !character.name.trim() || !character.description.trim()}
456 |               >
457 |                 {loading ? (
458 |                   <>
459 |                     <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
460 |                     Saving...
461 |                   </>
462 |                 ) : (
463 |                   <>
464 |                     {editingCharacter ? 'Update' : 'Create'} Character
465 |                   </>
466 |                 )}
467 |               </button>
468 |             </div>
469 |           </form>
470 |         </div>
471 |       </div>
472 |     </PageTransition>
473 |   );
474 | }
```

src/pages/CharacterSelection.tsx
```
1 | import { useNavigate } from "react-router-dom";
2 | import { Plus, User, Users, UserCheck } from "lucide-react";
3 | import BackButton from "../components/BackButton";
4 | import StoryButton from "../components/StoryButton";
5 | import PageTransition from "../components/PageTransition";
6 | import { Checkbox } from "../components/ui/checkbox";
7 | import { Badge } from "../components/ui/badge";
8 | import { motion } from "framer-motion";
9 | import React, { useEffect, useState } from "react";
10 | import { useUserStore } from "../store/user/userStore";
11 | import { getUserCharacters } from "../services/supabase";
12 | import { StoryCharacter } from "../types";
13 | import { charactersService } from "../services/charactersService";
14 | 
15 | export default function CharacterSelection() {
16 |   const navigate = useNavigate();
17 |   const { user } = useUserStore();
18 |   
19 |   // Local state for characters and selection
20 |   const [characters, setCharacters] = useState<StoryCharacter[]>([]);
21 |   const [selectedCharacters, setSelectedCharacters] = useState<StoryCharacter[]>([]);
22 |   const [isLoading, setIsLoading] = useState(true);
23 |   const [error, setError] = useState<string | null>(null);
24 |   
25 |   // Helper functions
26 |   const isCharacterSelected = (characterId: string): boolean => {
27 |     return selectedCharacters.some(char => char.id === characterId);
28 |   };
29 |   
30 |   const canSelectMoreCharacters = (): boolean => {
31 |     return selectedCharacters.length < 4;
32 |   };
33 |   
34 |   const toggleCharacterSelection = (characterId: string) => {
35 |     const character = characters.find(char => char.id === characterId);
36 |     if (!character) return;
37 |     
38 |     if (isCharacterSelected(characterId)) {
39 |       // Remove character from selection
40 |       setSelectedCharacters(prev => prev.filter(char => char.id !== characterId));
41 |     } else {
42 |       // Add character to selection (if under limit)
43 |       if (canSelectMoreCharacters()) {
44 |         setSelectedCharacters(prev => [...prev, character]);
45 |       }
46 |     }
47 |   };
48 |   
49 |   const clearSelectedCharacters = () => {
50 |     setSelectedCharacters([]);
51 |   };
52 | 
53 |   // Load characters from Supabase directly
54 |   useEffect(() => {
55 |     const loadCharacters = async () => {
56 |       console.log("[DEBUG] CharacterSelection montado - cargando personajes directamente desde Supabase");
57 |       setIsLoading(true);
58 |       setError(null);
59 | 
60 |       if (!user) {
61 |         console.error("[DEBUG] No hay usuario autenticado para cargar personajes");
62 |         setError("No hay usuario autenticado");
63 |         setIsLoading(false);
64 |         return;
65 |       }
66 | 
67 |       try {
68 |         const { success, characters: loadedCharacters, error: loadError } = await getUserCharacters(user.id);
69 |         
70 |         if (success && loadedCharacters) {
71 |           setCharacters(loadedCharacters);
72 |           console.log(`[DEBUG] Loaded ${loadedCharacters.length} characters for user ${user.id}`);
73 |         } else {
74 |           console.error("[DEBUG] Error loading characters:", loadError);
75 |           setError("Error loading characters");
76 |         }
77 |       } catch (err) {
78 |         console.error("[DEBUG] Unexpected error loading characters:", err);
79 |         setError("Unexpected error loading characters");
80 |       } finally {
81 |         setIsLoading(false);
82 |       }
83 |     };
84 | 
85 |     loadCharacters();
86 |   }, [user]);
87 | 
88 |   // Log available characters
89 |   useEffect(() => {
90 |     console.log(`CharacterSelection has ${characters.length} available characters:`,
91 |       characters.map(char => `${char.name} (${char.id})`));
92 |   }, [characters]);
93 | 
94 |   const handleSelectCharacter = (characterId: string) => {
95 |     // Always use multiple selection mode - just toggle, don't navigate automatically
96 |     toggleCharacterSelection(characterId);
97 |   };
98 | 
99 |   const handleContinueWithSelection = () => {
100 |     // Validate selection
101 |     const validation = charactersService.validateMultipleCharacterSelection(selectedCharacters);
102 | 
103 |     if (!validation.isValid) {
104 |       console.warn("Invalid selection:", validation.errors);
105 |       return;
106 |     }
107 | 
108 |     // Store selected characters in sessionStorage for the story generation flow
109 |     sessionStorage.setItem('selectedCharacters', JSON.stringify(selectedCharacters));
110 |     navigate("/story-genre");
111 |   };
112 | 
113 |   const handleCreateNewCharacter = () => {
114 |     // Navigate to character creation page
115 |     navigate("/character-name?action=create");
116 |   };
117 | 
118 |   const container = {
119 |     hidden: { opacity: 0 },
120 |     show: {
121 |       opacity: 1,
122 |       transition: {
123 |         staggerChildren: 0.1
124 |       }
125 |     }
126 |   };
127 | 
128 |   const item = {
129 |     hidden: { y: 20, opacity: 0 },
130 |     show: { y: 0, opacity: 1 }
131 |   };
132 | 
133 |   return (
134 |     <PageTransition>
135 |       <div
136 |         className="min-h-screen flex flex-col items-center justify-center relative"
137 |         style={{
138 |           backgroundColor: 'black',
139 |         }}
140 |       >
141 |         <BackButton />
142 | 
143 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
144 |           <h1 className="text-3xl font-bold text-[#BB79D1] text-center mb-4 font-heading drop-shadow-lg">
145 |             Choose Your Characters
146 |           </h1>
147 | 
148 |           <p className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-6 font-medium shadow-sm">
149 |             ✨ Select up to 4 characters for your erotic story! For intimate tales, fewer characters create more passionate focus.
150 |           </p>
151 | 
152 |           {/* Selection counter */}
153 |           {selectedCharacters.length > 0 && (
154 |             <div className="flex justify-center mb-6">
155 |               <div className="flex items-center gap-3 px-4 py-2 bg-white/70 rounded-xl border-2 border-[#BB79D1]/60 shadow-sm">
156 |                 <Users size={20} className="text-[#BB79D1]" />
157 |                 <span className="text-[#222] font-medium">
158 |                   {selectedCharacters.length}/4 characters selected
159 |                 </span>
160 |               </div>
161 |             </div>
162 |           )}
163 | 
164 |           {/* Selection message */}
165 |           <div className="text-center mb-4">
166 |             <p className="text-[#555] bg-white/60 rounded-lg px-3 py-2 text-sm">
167 |               {charactersService.getCharacterSelectionMessage(selectedCharacters.length)}
168 |             </p>
169 |           </div>
170 | 
171 |           {isLoading ? (
172 |             <div className="text-center bg-white/70 rounded-xl p-4 shadow-md mb-8">
173 |               <div className="text-[#BB79D1] font-medium">Loading characters...</div>
174 |             </div>
175 |           ) : error ? (
176 |             <div className="text-center bg-white/70 rounded-xl p-4 shadow-md mb-8">
177 |               <div className="text-red-500 font-medium">{error}</div>
178 |               <button 
179 |                 onClick={() => window.location.reload()} 
180 |                 className="mt-2 text-[#BB79D1] underline"
181 |               >
182 |                 Retry
183 |               </button>
184 |             </div>
185 |           ) : (
186 |             <>
187 |               <motion.div
188 |                 variants={container}
189 |                 initial="hidden"
190 |                 animate="show"
191 |                 className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8"
192 |               >
193 |                 <motion.div variants={item}>
194 |                   <div
195 |                     onClick={handleCreateNewCharacter}
196 |                     className="flex flex-col items-center justify-center p-6 h-40 cursor-pointer
197 |                       bg-white/70 rounded-2xl border-2 border-[#F6A5B7]/60
198 |                       hover:bg-[#F6A5B7]/10 hover:scale-105 hover:shadow-md
199 |                       transition-all duration-300"
200 |                   >
201 |                     <Plus size={40} className="text-[#F6A5B7] mb-2" />
202 |                     <span className="text-[#222] text-center font-medium">Create New</span>
203 |                   </div>
204 |                 </motion.div>
205 | 
206 |                 {characters.map((character) => {
207 |                   const isSelected = isCharacterSelected(character.id);
208 |                   const canSelect = canSelectMoreCharacters() || isCharacterSelected(character.id);
209 |                   
210 |                   // Gender icon mapping
211 |                   const genderIcon = character.gender === 'male' ? '♂' : character.gender === 'female' ? '♀' : '⚧';
212 |                   const genderText = character.gender === 'male' ? 'Male' : character.gender === 'female' ? 'Female' : 'Non-binary';
213 | 
214 |                   return (
215 |                     <motion.div key={character.id} variants={item}>
216 |                       <div
217 |                         onClick={() => canSelect && handleSelectCharacter(character.id)}
218 |                         className={`
219 |                           relative flex flex-col items-center justify-center p-6 h-40 cursor-pointer
220 |                           bg-white/70 rounded-2xl border-2 transition-all duration-300
221 |                           ${isSelected
222 |                             ? 'border-[#BB79D1]/80 bg-[#BB79D1]/20 ring-4 ring-[#BB79D1]/50 shadow-lg transform scale-105'
223 |                             : 'border-[#7DC4E0]/60 hover:bg-[#7DC4E0]/10 hover:scale-105 hover:shadow-md'}
224 |                           ${!canSelect ? 'opacity-50 cursor-not-allowed' : ''}
225 |                         `}
226 |                       >
227 |                         {/* Always visible checkbox */}
228 |                         <div className="absolute top-2 right-2">
229 |                           <Checkbox
230 |                             checked={isCharacterSelected(character.id)}
231 |                             onCheckedChange={(checked) => {
232 |                               if (canSelect) {
233 |                                 handleSelectCharacter(character.id);
234 |                               }
235 |                             }}
236 |                             className="w-5 h-5 border-2 border-[#BB79D1] data-[state=checked]:bg-[#BB79D1] data-[state=checked]:border-[#BB79D1]"
237 |                           />
238 |                         </div>
239 | 
240 |                         {/* Character icon */}
241 |                         {isSelected ? (
242 |                           <UserCheck size={40} className="text-[#BB79D1] mb-2" />
243 |                         ) : (
244 |                           <User size={40} className="text-[#7DC4E0] mb-2" />
245 |                         )}
246 | 
247 |                         <span className="text-[#222] text-center font-medium">{character.name}</span>
248 |                         <div className="text-center">
249 |                           <span className="text-[#7DC4E0] text-xs font-medium">{genderIcon} {genderText}</span>
250 |                           <p className="text-[#555] text-xs mt-1 line-clamp-2">
251 |                             {character.description || 'No description'}
252 |                           </p>
253 |                         </div>
254 | 
255 |                         {/* Selected badge */}
256 |                         {isCharacterSelected(character.id) && (
257 |                           <Badge className="absolute -top-2 -left-2 bg-[#BB79D1] text-white text-xs">
258 |                             ✓
259 |                           </Badge>
260 |                         )}
261 |                       </div>
262 |                     </motion.div>
263 |                   );
264 |                 })}
265 |               </motion.div>
266 | 
267 |               {characters.length === 0 && (
268 |                 <div className="text-center bg-white/70 rounded-xl p-4 shadow-md mb-8">
269 |                   <div className="text-[#555] font-medium">You don't have any saved characters. Create a new one!</div>
270 |                 </div>
271 |               )}
272 | 
273 |               {characters.length > 0 && (
274 |                 <div className="flex flex-col items-center gap-4">
275 |                   {/* Clear selection button */}
276 |                   {selectedCharacters.length > 0 && (
277 |                     <div className="flex gap-2">
278 |                       <button
279 |                         onClick={clearSelectedCharacters}
280 |                         className="px-4 py-2 text-sm bg-white/70 border border-[#7DC4E0]/60 rounded-lg
281 |                           hover:bg-[#7DC4E0]/10 transition-all duration-200 text-[#555]"
282 |                       >
283 |                         Clear Selection
284 |                       </button>
285 |                     </div>
286 |                   )}
287 | 
288 |                   {/* Continue button */}
289 |                   <div className="flex justify-center w-full">
290 |                     <StoryButton
291 |                       onClick={handleContinueWithSelection}
292 |                       isFullWidth={false}
293 |                       disabled={selectedCharacters.length === 0}
294 |                       className="w-full max-w-xs py-4 rounded-2xl text-white text-lg font-semibold shadow-lg bg-[#BB79D1] hover:bg-[#BB79D1]/90 border-2 border-[#BB79D1]/50 transition-all duration-200"
295 |                     >
296 |                       {selectedCharacters.length === 0
297 |                         ? "Select at least one character"
298 |                         : `Continue with ${selectedCharacters.length} character${selectedCharacters.length !== 1 ? 's' : ''}`
299 |                       }
300 |                     </StoryButton>
301 |                   </div>
302 |                 </div>
303 |               )}
304 |             </>
305 |           )}
306 |         </div>
307 |       </div>
308 |     </PageTransition>
309 |   );
310 | }
```

src/pages/CharactersManagement.tsx
```
1 | import { useNavigate } from "react-router-dom";
2 | import { User, Plus, Edit, Trash2, ArrowLeft } from "lucide-react";
3 | import React, { useEffect, useState } from "react";
4 | import { useUserStore } from "../store/user/userStore";
5 | import PageTransition from "../components/PageTransition";
6 | import StoryButton from "../components/StoryButton";
7 | import { motion } from "framer-motion";
8 | import BackButton from "../components/BackButton";
9 | import { useToast } from "@/hooks/use-toast";
10 | import { StoryCharacter } from "../types";
11 | import { getUserCharacters, deleteCharacter } from "../services/supabase";
12 | 
13 | export default function CharactersManagement() {
14 |   const navigate = useNavigate();
15 |   const { user } = useUserStore();
16 |   
17 |   // Local state management
18 |   const [characters, setCharacters] = useState<StoryCharacter[]>([]);
19 |   const [isLoading, setIsLoading] = useState(true);
20 |   const [error, setError] = useState<string | null>(null);
21 |   const [characterToDelete, setCharacterToDelete] = useState<StoryCharacter | null>(null);
22 |   const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
23 |   const { toast } = useToast();
24 | 
25 |   // Load characters directly from Supabase
26 |   useEffect(() => {
27 |     const loadCharacters = async () => {
28 |       console.log("[DEBUG] CharactersManagement mounted - loading characters directly from Supabase");
29 |       setIsLoading(true);
30 |       setError(null);
31 | 
32 |       if (!user) {
33 |         console.error("[DEBUG] No authenticated user to load characters");
34 |         setError("No authenticated user");
35 |         setIsLoading(false);
36 |         return;
37 |       }
38 | 
39 |       try {
40 |         const { success, characters: loadedCharacters, error: loadError } = await getUserCharacters(user.id);
41 |         
42 |         if (success && loadedCharacters) {
43 |           setCharacters(loadedCharacters);
44 |           console.log(`[DEBUG] Loaded ${loadedCharacters.length} characters for user ${user.id}`);
45 |         } else {
46 |           console.error("[DEBUG] Error loading characters:", loadError);
47 |           setError("Error loading characters");
48 |         }
49 |       } catch (err) {
50 |         console.error("[DEBUG] Unexpected error loading characters:", err);
51 |         setError("Unexpected error loading characters");
52 |       } finally {
53 |         setIsLoading(false);
54 |       }
55 |     };
56 | 
57 |     loadCharacters();
58 |   }, [user]);
59 | 
60 |   const handleCreateNewCharacter = () => {
61 |     // Navigate to character creation page
62 |     navigate("/character-name?from=management");
63 |   };
64 | 
65 |   const handleEditCharacter = (characterId: string) => {
66 |     // Navegar directamente con el ID del personaje para editar
67 |     navigate(`/character-name?from=management&edit=${characterId}`);
68 |   };
69 | 
70 |   const handleDeleteClick = (character: StoryCharacter) => {
71 |     setCharacterToDelete(character);
72 |     setShowDeleteConfirm(true);
73 |   };
74 | 
75 |   const confirmDelete = async () => {
76 |     if (characterToDelete) {
77 |       try {
78 |         const { success, error: deleteError } = await deleteCharacter(characterToDelete.id);
79 |         
80 |         if (success) {
81 |           // Remove character from local state
82 |           setCharacters(prev => prev.filter(char => char.id !== characterToDelete.id));
83 |           
84 |           toast({
85 |             title: "Character deleted",
86 |             description: `Character ${characterToDelete.name} has been removed from your collection`,
87 |           });
88 |         } else {
89 |           console.error("[DEBUG] Error eliminando personaje:", deleteError);
90 |           toast({
91 |             title: "Error",
92 |             description: "Could not delete character. Please try again.",
93 |             variant: "destructive",
94 |           });
95 |         }
96 |       } catch (err) {
97 |         console.error("[DEBUG] Error inesperado eliminando personaje:", err);
98 |         toast({
99 |           title: "Error",
100 |           description: "Unexpected error deleting character",
101 |           variant: "destructive",
102 |         });
103 |       } finally {
104 |         setShowDeleteConfirm(false);
105 |         setCharacterToDelete(null);
106 |       }
107 |     }
108 |   };
109 | 
110 |   const cancelDelete = () => {
111 |     setShowDeleteConfirm(false);
112 |     setCharacterToDelete(null);
113 |   };
114 | 
115 |   const container = {
116 |     hidden: { opacity: 0 },
117 |     show: {
118 |       opacity: 1,
119 |       transition: {
120 |         staggerChildren: 0.1
121 |       }
122 |     }
123 |   };
124 |   
125 |   const item = {
126 |     hidden: { y: 20, opacity: 0 },
127 |     show: { y: 0, opacity: 1 }
128 |   };
129 | 
130 |   return (
131 |     <PageTransition>
132 |       <div
133 |         className="min-h-screen flex flex-col items-center justify-center relative overflow-auto"
134 |         style={{
135 |           backgroundColor: 'black',
136 |         }}
137 |       >
138 |         <BackButton onClick={() => navigate("/home")} />
139 |         
140 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
141 |           <h1 className="text-3xl font-bold text-[#BB79D1] text-center mb-6 font-heading drop-shadow-lg">
142 |             My Characters
143 |           </h1>
144 |           
145 |           <div className="mb-8">
146 |             <button 
147 |               onClick={handleCreateNewCharacter}
148 |               className="w-full bg-[#F6A5B7] hover:bg-[#F6A5B7]/80 text-white font-semibold py-4 px-6 rounded-2xl shadow-lg flex items-center justify-center gap-3 transition-all duration-200 text-lg"
149 |             >
150 |               <Plus size={24} className="text-white" />
151 |               Create New Character
152 |             </button>
153 |           </div>
154 |           
155 |           {isLoading ? (
156 |             <div className="flex justify-center my-8 bg-white/70 rounded-xl p-6 shadow-md">
157 |               <div className="animate-spin h-10 w-10 border-4 border-[#BB79D1] rounded-full border-t-transparent"></div>
158 |             </div>
159 |           ) : error ? (
160 |             <div className="text-center bg-white/70 rounded-xl p-4 shadow-md mb-8">
161 |               <div className="text-red-500 font-medium">{error}</div>
162 |               <button 
163 |                 onClick={() => window.location.reload()} 
164 |                 className="mt-2 text-[#BB79D1] underline"
165 |               >
166 |                 Retry
167 |               </button>
168 |             </div>
169 |           ) : (
170 |             <>
171 |               {characters.length === 0 ? (
172 |                 <div className="bg-white/80 rounded-xl p-8 text-center text-[#222] shadow-md">
173 |                   <User size={48} className="mx-auto mb-4 text-[#BB79D1] opacity-70" />
174 |                   <h3 className="text-xl font-semibold mb-2 text-[#222]">No characters yet</h3>
175 |                   <p className="text-[#555] mb-6">
176 |                     Create your first character to star in your intimate stories
177 |                   </p>
178 |                   <StoryButton 
179 |                     onClick={handleCreateNewCharacter}
180 |                     variant="secondary"
181 |                     icon={<Plus size={16} />}
182 |                     className="bg-[#F6A5B7] hover:bg-[#F6A5B7]/80 text-white font-semibold py-2 px-4 rounded-xl shadow-md transition-all duration-200"
183 |                   >
184 |                     Create Character
185 |                   </StoryButton>
186 |                 </div>
187 |               ) : (
188 |                 <motion.div 
189 |                   variants={container}
190 |                   initial="hidden"
191 |                   animate="show"
192 |                   className="space-y-4"
193 |                 >
194 |                   {characters.map((character) => (
195 |                     <motion.div key={character.id} variants={item}>
196 |                       <div className="bg-white/80 rounded-xl p-4 flex items-center shadow-md">
197 |                         <div className="w-12 h-12 rounded-full bg-[#7DC4E0]/20 border-2 border-[#7DC4E0]/40 flex items-center justify-center mr-4 flex-shrink-0">
198 |                           <User size={24} className="text-[#7DC4E0]" />
199 |                         </div>
200 |                         <div className="flex-grow mr-4">
201 |                           <h3 className="text-[#222] font-semibold text-lg">{character.name}</h3>
202 |                           <p className="text-[#555] text-sm line-clamp-2">
203 |                             {character.description || 'No description yet - add details to make them irresistible'}
204 |                           </p>
205 |                           <p className="text-[#7DC4E0] text-xs mt-1">
206 |                             {character.gender === 'male' ? '♂ Male' : 
207 |                              character.gender === 'female' ? '♀ Female' : '⚧ Non-binary'}
208 |                           </p>
209 |                         </div>
210 |                         <div className="flex gap-2">
211 |                           <button 
212 |                             onClick={() => handleEditCharacter(character.id)}
213 |                             className="w-10 h-10 rounded-full bg-white/70 hover:bg-[#BB79D1]/20 flex items-center justify-center text-[#BB79D1] border border-[#BB79D1]/30 transition-colors shadow-sm"
214 |                             aria-label="Editar"
215 |                           >
216 |                             <Edit size={16} />
217 |                           </button>
218 |                           <button 
219 |                             onClick={() => handleDeleteClick(character)}
220 |                             className="w-10 h-10 rounded-full bg-white/70 hover:bg-[#F6A5B7]/20 flex items-center justify-center text-[#F6A5B7] hover:text-[#F6A5B7] border border-[#F6A5B7]/30 transition-colors shadow-sm"
221 |                             aria-label="Eliminar"
222 |                           >
223 |                             <Trash2 size={16} />
224 |                           </button>
225 |                         </div>
226 |                       </div>
227 |                     </motion.div>
228 |                   ))}
229 |                 </motion.div>
230 |               )}
231 |             </>
232 |           )}
233 |         </div>
234 | 
235 |         {/* Delete confirmation modal */}
236 |         {showDeleteConfirm && characterToDelete && (
237 |           <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 px-4">
238 |             <motion.div 
239 |               initial={{ scale: 0.9, opacity: 0 }}
240 |               animate={{ scale: 1, opacity: 1 }}
241 |               className="bg-white/90 rounded-xl p-6 max-w-md w-full shadow-lg"
242 |             >
243 |               <h3 className="text-xl font-semibold text-[#BB79D1] mb-2">Delete character</h3>
244 |               <p className="text-[#222] mb-6">
245 |                 Are you sure you want to delete <span className="font-medium text-[#BB79D1]">{characterToDelete.name}</span>? 
246 |                 This action cannot be undone.
247 |               </p>
248 |               <div className="flex gap-3">
249 |                 <button
250 |                   onClick={cancelDelete}
251 |                   className="flex-1 py-2 px-4 bg-white/80 rounded-xl text-[#222] font-medium hover:bg-white/90 transition-colors border border-[#BB79D1]/30 shadow-sm"
252 |                 >
253 |                   Cancel
254 |                 </button>
255 |                 <button
256 |                   onClick={confirmDelete}
257 |                   className="flex-1 py-2 px-4 bg-[#F6A5B7] rounded-xl text-white font-medium hover:bg-[#F6A5B7]/80 transition-colors shadow-sm"
258 |                 >
259 |                   Delete
260 |                 </button>
261 |               </div>
262 |             </motion.div>
263 |           </div>
264 |         )}
265 |       </div>
266 |     </PageTransition>
267 |   );
268 | }
```

src/pages/Contact.tsx
```
1 | import React from 'react';
2 | import { useNavigate } from 'react-router-dom';
3 | import { Button } from "@/components/ui/button";
4 | import PageTransition from "../components/PageTransition";
5 | import { Mail, MapPin, Heart } from 'lucide-react';
6 | 
7 | const Contact: React.FC = () => {
8 |   const navigate = useNavigate();
9 | 
10 |   return (
11 |     <PageTransition>
12 |       <div
13 |         className="min-h-screen flex flex-col"
14 |         style={{
15 |           backgroundColor: 'black',
16 |         }}
17 |       >
18 |         <div className="container mx-auto py-8 px-4 flex-1 overflow-auto">
19 |           <div className="max-w-4xl mx-auto">
20 |             <div className="text-center mb-6">
21 |               <h1 className="text-3xl font-bold text-[#222]">Contacto</h1>
22 |             </div>
23 | 
24 |             <div className="space-y-8 bg-white/80 p-8 rounded-2xl backdrop-blur-sm shadow-lg">
25 |               <div className="flex flex-col items-center text-center space-y-8">
26 |                 <div className="flex flex-col items-center">
27 |                   <Mail className="h-10 w-10 text-[#BB79D1] mb-2" />
28 |                   <h2 className="text-xl font-bold text-[#555]">Correo electrónico</h2>
29 |                   <a
30 |                     href="mailto:hello@fantasia.app"
31 |                     className="text-lg text-[#BB79D1] hover:text-[#A5D6F6] transition-colors"
32 |                   >
33 |                     hello@fantasia.app
34 |                   </a>
35 |                 </div>
36 | 
37 |                 <div className="flex flex-col items-center">
38 |                   <MapPin className="h-10 w-10 text-[#BB79D1] mb-2" />
39 |                   <h2 className="text-xl font-bold text-[#555]">Ubicación</h2>
40 |                   <p className="text-lg">Zaragoza, España</p>
41 |                 </div>
42 | 
43 |                 <div className="pt-8 border-t border-gray-200/50 w-3/4 mx-auto">
44 |                   <div className="flex flex-col items-center">
45 |                     <div className="flex items-center mb-2">
46 |                       <span className="text-xl font-bold text-[#555] mr-2">Hecho con</span>
47 |                       <Heart className="h-6 w-6 text-[#F6A5B7] fill-[#F6A5B7]" />
48 |                       <span className="text-xl font-bold text-[#555] ml-2">por:</span>
49 |                     </div>
50 |                     <p className="text-lg text-center">
51 |                     </p>
52 |                   </div>
53 |                 </div>
54 |               </div>
55 |             </div>
56 | 
57 |             <div className="flex justify-center mt-6">
58 |               <Button
59 |                 variant="default"
60 |                 onClick={() => navigate(-1)}
61 |                 className="min-w-32"
62 |               >
63 |                 Volver
64 |               </Button>
65 |             </div>
66 |           </div>
67 |         </div>
68 |       </div>
69 |     </PageTransition>
70 |   );
71 | };
72 | 
73 | export default Contact; 
```

src/pages/ErrorPage.tsx
```
1 | import { useLocation, useNavigate } from "react-router-dom";
2 | import { RefreshCw, Home } from "lucide-react";
3 | import PageTransition from "../components/PageTransition";
4 | 
5 | export default function ErrorPage() {
6 |   const location = useLocation();
7 |   const navigate = useNavigate();
8 |   const error = location.state?.error || "Algo salió mal";
9 | 
10 |   const tryAgain = () => {
11 |     navigate(-1);
12 |   };
13 | 
14 |   return (
15 |     <PageTransition>
16 |       <div
17 |         className="min-h-screen flex flex-col items-center justify-center p-6"
18 |         style={{
19 |           backgroundColor: 'black',
20 |         }}
21 |       >
22 |         <div className="w-full max-w-md bg-white/90 rounded-3xl shadow-lg overflow-hidden">
23 |           <div className="p-8 flex flex-col items-center">
24 |             <div className="w-24 h-24 rounded-full bg-[#F9DA60]/20 flex items-center justify-center mb-6">
25 |               <svg width="44" height="44" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
26 |                 <path d="M12 9V13" stroke="#F9DA60" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
27 |                 <path d="M12 17.0195V17" stroke="#F9DA60" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
28 |                 <path d="M10.1708 3.61232L1.97534 17.001C1.02535 18.5413 2.17321 20.501 3.97914 20.501H20.0209C21.8268 20.501 22.9746 18.5413 22.0246 17.001L13.8292 3.61232C12.8708 2.05984 11.1292 2.05984 10.1708 3.61232Z" stroke="#F9DA60" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
29 |               </svg>
30 |             </div>
31 | 
32 |             <h1 className="text-3xl font-bold text-[#222] mb-4 text-center">
33 |               ¡Ups! Ocurrió un error
34 |             </h1>
35 | 
36 |             <p className="text-[#333] mb-10 text-center">
37 |               Nuestros asistentes de Fantasia! están teniendo problemas para crear tu historia. Por favor, inténtalo de nuevo.
38 |             </p>
39 | 
40 |             <div className="w-full">
41 |               <button
42 |                 onClick={tryAgain}
43 |                 className="w-full flex items-center justify-center gap-2 bg-[#BB79D1] hover:bg-[#BB79D1]/90 text-white rounded-full py-4 font-semibold text-lg mb-4"
44 |               >
45 |                 <RefreshCw className="animate-spin-slow" size={20} />
46 |                 Intentar nuevamente
47 |               </button>
48 | 
49 |               <button
50 |                 onClick={() => navigate("/home")}
51 |                 className="w-full flex items-center justify-center gap-2 bg-[#BB79D1] hover:bg-[#BB79D1]/90 text-white rounded-full py-4 font-semibold text-lg"
52 |               >
53 |                 <Home size={20} />
54 |                 Volver al inicio
55 |               </button>
56 |             </div>
57 |           </div>
58 |         </div>
59 |       </div>
60 |     </PageTransition>
61 |   );
62 | }
```

src/pages/GeneratingStory.tsx
```
1 | import { useEffect } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { motion } from "framer-motion";
4 | import { generateStory } from "../store/stories/storyGenerator";
5 | import { useStoriesStore } from "../store/stories/storiesStore";
6 | import { useStoryOptionsStore } from "../store/storyOptions/storyOptionsStore";
7 | import IconLoadingAnimation from "../components/IconLoadingAnimation";
8 | import PageTransition from "../components/PageTransition";
9 | 
10 | export default function GeneratingStory() {
11 |   const navigate = useNavigate();
12 |   const { currentStoryOptions } = useStoryOptionsStore();
13 |   
14 |   useEffect(() => {
15 |     const generate = async () => {
16 |       try {
17 |         const story = await generateStory(currentStoryOptions);
18 |         navigate(`/story/${story.id}`);
19 |       } catch (error) {
20 |         console.error("Error generating story:", error);
21 |         navigate("/error", { state: { error } });
22 |       }
23 |     };
24 |     
25 |     generate();
26 |   }, []);
27 |   
28 |   return (
29 |     <PageTransition>
30 |       <div 
31 |         className="min-h-screen flex flex-col items-center justify-center p-6"
32 |         style={{
33 |           backgroundColor: 'black',
34 |         }}
35 |       >
36 |         <div className="w-full max-w-md flex flex-col items-center justify-center">
37 |           <motion.div
38 |             initial={{ opacity: 0, scale: 0.8 }}
39 |             animate={{ opacity: 1, scale: 1 }}
40 |             transition={{ duration: 0.5 }}
41 |             className="mb-10"
42 |           >
43 |             <IconLoadingAnimation message="Creating your story..." />
44 |           </motion.div>
45 |           
46 |           <motion.div
47 |             initial={{ opacity: 0 }}
48 |             animate={{ opacity: 1 }}
49 |             transition={{ delay: 1, duration: 1 }}
50 |             className="bg-white/70 text-[#222] p-4 rounded-xl max-w-sm text-center shadow-md"
51 |           >
52 |             <p className="font-medium">We're personalizing a magical story especially for you...</p>
53 |             
54 |             <div className="mt-4 grid grid-cols-3 gap-2">
55 |               {currentStoryOptions.characters && currentStoryOptions.characters.length > 0 && (
56 |                 <div className="bg-[#7DC4E0]/20 p-2 rounded-lg border border-[#7DC4E0]/30">
57 |                   <p className="text-xs font-semibold text-[#7DC4E0]">Characters ({currentStoryOptions.characters.length})</p>
58 |                   <p className="text-sm truncate">
59 |                     {currentStoryOptions.characters.map(char => char.name).join(', ')}
60 |                   </p>
61 |                 </div>
62 |               )}
63 |               
64 |               {currentStoryOptions.genre && (
65 |                 <div className="bg-[#BB79D1]/20 p-2 rounded-lg border border-[#BB79D1]/30">
66 |                   <p className="text-xs font-semibold text-[#BB79D1]">Genre</p>
67 |                   <p className="text-sm truncate">{currentStoryOptions.genre}</p>
68 |                 </div>
69 |               )}
70 |               
71 |               {currentStoryOptions.format && (
72 |                 <div className="bg-[#F9DA60]/20 p-2 rounded-lg border border-[#F9DA60]/30">
73 |                   <p className="text-xs font-semibold text-[#F9DA60]">Format</p>
74 |                   <p className="text-sm truncate">
75 |                     {currentStoryOptions.format === 'single' ? 'Complete Story' : 'By Chapters'}
76 |                   </p>
77 |                 </div>
78 |               )}
79 |             </div>
80 |           </motion.div>
81 | 
82 |           {/* Nuevo cuadro de aviso */}
83 |           <motion.div
84 |             initial={{ opacity: 0 }}
85 |             animate={{ opacity: 1 }}
86 |             transition={{ delay: 1.5, duration: 1 }}
87 |             className="mt-6 bg-white/70 text-[#222] p-4 rounded-xl max-w-sm text-center shadow-md"
88 |           >
89 |             <p className="font-medium">
90 |               Your story is almost ready! To keep the magic going, please don't leave this page while it's being created. ✨
91 |             </p>
92 |           </motion.div>
93 |         </div>
94 |       </div>
95 |     </PageTransition>
96 |   );
97 | }
```

src/pages/Home.tsx
```
1 | import React, { useEffect } from 'react';
2 | import { useNavigate, Link } from "react-router-dom";
3 | import { Settings, User, Star, ChevronRight } from "lucide-react";
4 | import { motion } from "framer-motion";
5 | import { supabase } from '@/supabaseClient';
6 | import { useStoriesStore } from "../store/stories/storiesStore";
7 | import PageTransition from "../components/PageTransition";
8 | import { useToast } from "@/hooks/use-toast";
9 | 
10 | export default function Home() {
11 |   const navigate = useNavigate();
12 |   const { generatedStories } = useStoriesStore(); // Mantener para las historias
13 |   const { toast } = useToast();
14 |   const [isLoading, setIsLoading] = React.useState(true);
15 |   const [profile, setProfile] = React.useState<{ has_completed_setup: boolean; subscription_status: string | null; } | null>(null);
16 | 
17 |   // TODO: Estos valores deberían venir del perfil
18 |   const canCreateStory = () => true; 
19 |   const getRemainingMonthlyStories = () => 10;
20 | 
21 |   useEffect(() => {
22 |     const checkProfile = async () => {
23 |       const { data: { user } } = await supabase.auth.getUser();
24 |       if (!user) {
25 |         navigate("/login", { replace: true });
26 |         return;
27 |       }
28 | 
29 |       const { data: userProfile, error } = await supabase
30 |         .from('profiles')
31 |         .select('has_completed_setup, subscription_status')
32 |         .eq('id', user.id)
33 |         .single();
34 | 
35 |       if (error || !userProfile) {
36 |         console.error('Error fetching profile, redirecting to config:', error);
37 |         navigate("/profile-config", { replace: true });
38 |         return;
39 |       }
40 | 
41 |       if (!userProfile.has_completed_setup) {
42 |         navigate("/profile-config", { replace: true });
43 |         return;
44 |       }
45 | 
46 |       setProfile(userProfile);
47 |       setIsLoading(false);
48 |     };
49 | 
50 |     checkProfile();
51 |   }, [navigate]);
52 | 
53 |   if (isLoading) {
54 |     return (
55 |       <div className="gradient-bg min-h-screen flex items-center justify-center">
56 |         <div className="animate-spin h-10 w-10 border-4 border-white rounded-full border-t-transparent"></div>
57 |       </div>
58 |     );
59 |   }
60 | 
61 | 
62 |   const handleNewStory = () => {
63 |     // TODO: La lógica de canCreateStory debe ser implementada con el perfil cargado
64 |     if (canCreateStory()) {
65 |       navigate("/character-selection");
66 |     } else {
67 |       toast({
68 |         title: "Límite de historias alcanzado",
69 |         description: profile?.subscription_status === 'active'
70 |           ? "Has alcanzado el límite de historias para tu plan premium. Contacta con soporte para más información."
71 |           : `Has alcanzado el límite mensual de historias gratuitas. Actualiza a premium para crear más historias.`,
72 |         variant: "destructive",
73 |       });
74 |     }
75 |   };
76 | 
77 |   const premiumUser = profile?.subscription_status === 'active';
78 |   const subscriptionText = premiumUser ? 'Premium' : 'Free';
79 | 
80 |   return (
81 |     <PageTransition>
82 |       <div
83 |         className="relative min-h-screen flex flex-col items-center justify-center p-0"
84 |         style={{
85 |           backgroundColor: 'black',
86 |         }}
87 |       >
88 |         {/* Botones superiores */}
89 |         <div className="absolute top-6 right-6 flex gap-3 z-10">
90 |           <Link
91 |             to="/plans"
92 |             className={`flex items-center gap-2 px-3 py-1.5 rounded-xl shadow-md text-xs font-semibold transition-all duration-200 bg-white/70 hover:bg-white/90 text-pink-500`}
93 |             aria-label="Ver planes y suscripción"
94 |           >
95 |             <img src="/logo_fantasia.png" alt="icono free/premium" className="h-5 w-5" />
96 |             <span>{subscriptionText}</span>
97 |             <ChevronRight className="h-3.5 w-3.5 opacity-75" />
98 |           </Link>
99 |           <Link
100 |             to="/profile-config"
101 |             className="w-9 h-9 rounded-full bg-white/70 flex items-center justify-center text-pink-500 hover:bg-white/90 transition-all shadow-md"
102 |             aria-label="Configuración de Perfil"
103 |           >
104 |             <User className="h-5 w-5" />
105 |           </Link>
106 |           <Link
107 |             to="/settings"
108 |             className="w-9 h-9 rounded-full bg-white/70 flex items-center justify-center text-pink-500 hover:bg-white/90 transition-all shadow-md"
109 |             aria-label="Ajustes"
110 |           >
111 |             <Settings className="h-5 w-5" />
112 |           </Link>
113 |         </div>
114 | 
115 |         {/* Logo y título */}
116 |         <div className="flex flex-col items-center mt-10 mb-8 select-none">
117 |           <img src="/logo_fantasia.png" alt="Fantasia Logo" className="w-80 max-w-md mx-auto mb-4 drop-shadow-xl" />
118 |         </div>
119 | 
120 |         {/* Botones principales */}
121 |         <div className="flex flex-col items-center w-full max-w-xs gap-5 -mt-4">
122 |           <button
123 |             className={`w-full py-4 rounded-2xl text-lg font-semibold shadow-lg transition-all duration-200 ${canCreateStory()
124 |                 ? "bg-[#f6a5b7] hover:bg-[#fbb6ce] text-white"
125 |                 : "bg-[#f6a5b7]/50 text-white/90 cursor-not-allowed"
126 |               }`}
127 |             onClick={handleNewStory}
128 |             // disabled={!canCreateStory()}
129 |             title={!canCreateStory() ? `Te quedan ${getRemainingMonthlyStories()} historias este mes` : ""}
130 |           >
131 |             Generar una Nueva Historia
132 |           </button>
133 |           <button
134 |             className="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg transition-all duration-200 bg-[#f7c59f] hover:bg-[#ffd7ba]"
135 |             onClick={() => navigate("/characters-management")}
136 |           >
137 |             Mis Personajes
138 |           </button>
139 |           {generatedStories.length > 0 && (
140 |             <button
141 |               className="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg transition-all duration-200 bg-[#a5d6f6] hover:bg-[#c8e6fa]"
142 |               onClick={() => navigate("/stories")}
143 |             >
144 |               Mis Historias
145 |             </button>
146 |           )}
147 |         </div>
148 |       </div>
149 |     </PageTransition>
150 |   );
151 | }
```

src/pages/Index.tsx
```
1 | // Update this page (the content is just a fallback if you fail to update the page)
2 | 
3 | const Index = () => {
4 |   return (
5 |     <div className="min-h-screen flex items-center justify-center bg-gray-100">
6 |       <div className="text-center">
7 |         <h1 className="text-4xl font-bold mb-4">Welcome to Your Blank App</h1>
8 |         <p className="text-xl text-gray-600">Start building your amazing project here!</p>
9 |       </div>
10 |     </div>
11 |   );
12 | };
13 | 
14 | export default Index;
```

src/pages/Login.tsx
```
1 | import { useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { Mail, Lock, Eye, EyeOff } from "lucide-react";
4 | import { useUserStore } from "../store/user/userStore";
5 | import { Input } from "@/components/ui/input";
6 | import { Form, FormControl, FormField, FormItem } from "@/components/ui/form";
7 | import { useForm } from "react-hook-form";
8 | import PageTransition from "../components/PageTransition";
9 | import { useToast } from "@/hooks/use-toast";
10 | import { login, requestPasswordReset, signInWithGoogle } from "../supabaseAuth";
11 | import { getUserProfile } from "../services/supabase";
12 | 
13 | export default function Login() {
14 |   const navigate = useNavigate();
15 |   const { loginUser } = useUserStore();
16 |   const { toast } = useToast();
17 |   const [showPassword, setShowPassword] = useState(false);
18 |   const [rememberSession, setRememberSession] = useState(false);
19 |   const [isLoading, setIsLoading] = useState(false);
20 |   const [isGoogleLoading, setIsGoogleLoading] = useState(false);
21 | 
22 |   const form = useForm({
23 |     defaultValues: {
24 |       email: "",
25 |       password: ""
26 |     }
27 |   });
28 | 
29 |   const handleLogin = async (data: { email: string; password: string }) => {
30 |     try {
31 |       setIsLoading(true);
32 |       const { user, error } = await login(data.email, data.password);
33 | 
34 |       if (error) {
35 |         toast({
36 |           title: "Error de inicio de sesión",
37 |           description: error.message,
38 |           variant: "destructive"
39 |         });
40 |         return;
41 |       }
42 | 
43 |       if (user) {
44 |         loginUser(user);
45 | 
46 |         toast({
47 |           title: "Inicio de sesión exitoso",
48 |           description: "¡Bienvenido de nuevo!",
49 |         });
50 | 
51 |         try {
52 |           // Verificar si el usuario ya tiene un perfil configurado
53 |           const { success, profile } = await getUserProfile(user.id);
54 | 
55 |           if (success && profile) {
56 |             // Si ya tiene perfil, redirigir a la página principal
57 |             navigate("/home");
58 |           } else {
59 |             // Si no tiene perfil, redirigir a la configuración de perfil
60 |             navigate("/profile");
61 |           }
62 |         } catch (profileError) {
63 |           console.error("Error al verificar perfil:", profileError);
64 |           // En caso de error, mandamos a la configuración por seguridad
65 |           navigate("/profile");
66 |         }
67 |       } else {
68 |         toast({
69 |           title: "Error de inicio de sesión",
70 |           description: "Credenciales inválidas",
71 |           variant: "destructive"
72 |         });
73 |       }
74 |     } catch (err) {
75 |       toast({
76 |         title: "Error inesperado",
77 |         description: "Ha ocurrido un error inesperado",
78 |         variant: "destructive"
79 |       });
80 |       console.error(err);
81 |     } finally {
82 |       setIsLoading(false);
83 |     }
84 |   };
85 | 
86 |   const handleGoogleLogin = async () => {
87 |     try {
88 |       setIsGoogleLoading(true);
89 |       const { error } = await signInWithGoogle();
90 | 
91 |       if (error) {
92 |         toast({
93 |           title: "Error al iniciar sesión con Google",
94 |           description: error.message,
95 |           variant: "destructive"
96 |         });
97 |       }
98 |     } catch (err) {
99 |       toast({
100 |         title: "Error inesperado",
101 |         description: "Ha ocurrido un error al iniciar sesión con Google",
102 |         variant: "destructive"
103 |       });
104 |       console.error(err);
105 |     } finally {
106 |       setIsGoogleLoading(false);
107 |     }
108 |   };
109 | 
110 |   const handleForgotPassword = async () => {
111 |     const email = form.getValues("email");
112 |     if (!email) {
113 |       toast({
114 |         title: "Email requerido",
115 |         description: "Por favor ingresa tu correo electrónico para restablecer la contraseña",
116 |         variant: "destructive"
117 |       });
118 |       return;
119 |     }
120 | 
121 |     try {
122 |       setIsLoading(true);
123 |       const { error } = await requestPasswordReset(email);
124 | 
125 |       if (error) {
126 |         toast({
127 |           title: "Error al solicitar restablecimiento",
128 |           description: error.message,
129 |           variant: "destructive"
130 |         });
131 |         return;
132 |       }
133 | 
134 |       toast({
135 |         title: "Solicitud enviada",
136 |         description: "Revisa tu correo electrónico para restablecer tu contraseña",
137 |       });
138 |     } catch (err) {
139 |       toast({
140 |         title: "Error inesperado",
141 |         description: "Ha ocurrido un error inesperado",
142 |         variant: "destructive"
143 |       });
144 |       console.error(err);
145 |     } finally {
146 |       setIsLoading(false);
147 |     }
148 |   };
149 | 
150 |   const togglePasswordVisibility = () => setShowPassword(!showPassword);
151 | 
152 |   return (
153 |     <PageTransition>
154 |       <div
155 |         className="min-h-screen flex flex-col items-center justify-center p-6"
156 |         style={{
157 |           backgroundColor: 'black',
158 |         }}
159 |       >
160 |         <div className="w-full max-w-md bg-white/70 rounded-3xl p-8 shadow-lg border border-[#BB79D1]/20">
161 |           <div className="flex justify-center mb-6">
162 |             <img src="/logo_fantasia.png" alt="Fantasia Logo" className="w-48 max-w-full" />
163 |           </div>
164 | 
165 |           <Form {...form}>
166 |             <form
167 |               onSubmit={form.handleSubmit(handleLogin)}
168 |               className="space-y-5"
169 |             >
170 |               <FormField
171 |                 control={form.control}
172 |                 name="email"
173 |                 render={({ field }) => (
174 |                   <FormItem>
175 |                     <div className="relative">
176 |                       <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1]" size={20} />
177 |                       <FormControl>
178 |                         <Input
179 |                           placeholder="Correo electrónico"
180 |                           className="pl-10 py-6 rounded-xl bg-white/80 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-1 focus:ring-[#BB79D1] text-[#333]"
181 |                           type="email"
182 |                           {...field}
183 |                           required
184 |                         />
185 |                       </FormControl>
186 |                     </div>
187 |                   </FormItem>
188 |                 )}
189 |               />
190 | 
191 |               <FormField
192 |                 control={form.control}
193 |                 name="password"
194 |                 render={({ field }) => (
195 |                   <FormItem>
196 |                     <div className="relative">
197 |                       <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1]" size={20} />
198 |                       <FormControl>
199 |                         <Input
200 |                           placeholder="Contraseña"
201 |                           className="pl-10 pr-10 py-6 rounded-xl bg-white/80 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-1 focus:ring-[#BB79D1] text-[#333]"
202 |                           type={showPassword ? "text" : "password"}
203 |                           {...field}
204 |                           required
205 |                         />
206 |                       </FormControl>
207 |                       <button
208 |                         type="button"
209 |                         onClick={togglePasswordVisibility}
210 |                         className="absolute right-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1] hover:text-[#A5D6F6] transition-colors"
211 |                       >
212 |                         {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
213 |                       </button>
214 |                     </div>
215 |                   </FormItem>
216 |                 )}
217 |               />
218 | 
219 |               <div className="flex items-center justify-between">
220 |                 <label className="flex items-center space-x-2 cursor-pointer">
221 |                   <input
222 |                     type="checkbox"
223 |                     checked={rememberSession}
224 |                     onChange={() => setRememberSession(!rememberSession)}
225 |                     className="rounded text-[#F6A5B7] focus:ring-[#F6A5B7] border-[#BB79D1]/30"
226 |                   />
227 |                   <span className="text-sm text-[#555]">Recordar sesión</span>
228 |                 </label>
229 | 
230 |                 <button
231 |                   type="button"
232 |                   onClick={handleForgotPassword}
233 |                   className="text-sm text-[#BB79D1] hover:text-[#A5D6F6] hover:underline transition-colors"
234 |                 >
235 |                   ¿Olvidaste tu contraseña?
236 |                 </button>
237 |               </div>
238 | 
239 |               <button
240 |                 type="submit"
241 |                 disabled={isLoading}
242 |                 className="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg transition-all duration-200 bg-[#F6A5B7] hover:bg-[#F6A5B7]/80 active:bg-[#F6A5B7]/90 disabled:opacity-60 disabled:cursor-not-allowed"
243 |               >
244 |                 {isLoading ? "Iniciando sesión..." : "Iniciar Sesión"}
245 |               </button>
246 | 
247 | 
248 |               <div className="relative flex items-center my-4">
249 |                 <div className="flex-grow border-t border-[#BB79D1]/20"></div>
250 |                 <span className="mx-4 flex-shrink text-[#555] text-sm">O continúa con</span>
251 |                 <div className="flex-grow border-t border-[#BB79D1]/20"></div>
252 |               </div>
253 |               <button
254 |                 type="button"
255 |                 onClick={handleGoogleLogin}
256 |                 disabled={isGoogleLoading}
257 |                 className="w-full flex items-center justify-center gap-2 bg-white text-[#333] rounded-xl py-3 hover:bg-gray-100 transition-colors duration-300 border border-[#BB79D1]/20 shadow-md"
258 |               >
259 |                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px">
260 |                   <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" />
261 |                   <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" />
262 |                   <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" />
263 |                   <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z" />
264 |                 </svg>
265 |                 {isGoogleLoading ? "Conectando..." : "Iniciar sesión con Google"}
266 |               </button>
267 | 
268 |               <div className="text-center mt-5">
269 |                 <span className="text-[#555] text-sm">¿No tienes una cuenta? </span>
270 |                 <button
271 |                   type="button"
272 |                   onClick={() => navigate("/signup")}
273 |                   className="text-[#BB79D1] font-semibold text-sm hover:underline"
274 |                 >
275 |                   Registrarse
276 |                 </button>
277 |               </div>
278 |             </form>
279 |           </Form>
280 |         </div>
281 |       </div>
282 |     </PageTransition>
283 |   );
284 | }
```

src/pages/NotFound.tsx
```
1 | import { useNavigate } from "react-router-dom";
2 | import { Home } from "lucide-react";
3 | import PageTransition from "../components/PageTransition";
4 | 
5 | export default function NotFound() {
6 |   const navigate = useNavigate();
7 | 
8 |   return (
9 |     <PageTransition>
10 |       <div
11 |         className="min-h-screen flex flex-col items-center justify-center p-6"
12 |         style={{
13 |           backgroundColor: 'black',
14 |         }}
15 |       >
16 |         <div className="w-full max-w-md bg-white/90 rounded-3xl shadow-lg overflow-hidden">
17 |           <div className="p-8 flex flex-col items-center">
18 |             <div className="w-24 h-24 rounded-full bg-[#BB79D1]/20 flex items-center justify-center mb-6">
19 |               <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
20 |                 <path d="M14 2.5L14 6.5C14 7.05 14.45 7.5 15 7.5L19 7.5" stroke="#BB79D1" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
21 |                 <path d="M6 13.5V12.9C6 11.0297 6 10.0945 6.43597 9.4453C6.81947 8.87762 7.37762 8.45322 8.0453 8.21675C8.69945 8 9.51292 8 11.1398 8C11.6462 8 11.8994 8 12.1174 8.01666C12.3293 8.03261 12.5139 8.06577 12.6904 8.11391C12.86 8.16 13.0145 8.22462 13.3235 8.35385V8.35385C13.6195 8.47809 13.7675 8.54021 13.8789 8.63C13.9832 8.71405 14.0701 8.81649 14.1353 8.93149C14.2042 9.053 14.2457 9.19648 14.3287 9.48345L14.5 10.0001" stroke="#BB79D1" strokeWidth="1.5" strokeLinecap="round" />
22 |                 <path d="M14.5 14.5L15.5 14.5" stroke="#BB79D1" strokeWidth="1.5" strokeLinecap="round" />
23 |                 <path d="M9 18.5H12" stroke="#BB79D1" strokeWidth="1.5" strokeLinecap="round" />
24 |                 <path d="M13.5 21H8.2C7.07989 21 6.51984 21 6.09202 20.782C5.71569 20.5903 5.40973 20.2843 5.21799 19.908C5 19.4802 5 18.9201 5 17.8V6.2C5 5.07989 5 4.51984 5.21799 4.09202C5.40973 3.71569 5.71569 3.40973 6.09202 3.21799C6.51984 3 7.07989 3 8.2 3H11.4C11.9601 3 12.2401 3 12.5056 3.10899C12.7477 3.20487 12.9667 3.35345 13.1465 3.54254C13.3469 3.75596 13.4869 4.04931 13.7672 4.63602L15.4471 8.20775C15.6038 8.52143 15.6822 8.67827 15.7385 8.84087C15.789 8.98529 15.825 9.13516 15.8465 9.2873C15.8705 9.45552 15.8705 9.62661 15.8705 9.9688V17.8C15.8705 18.9201 15.8705 19.4802 15.6525 19.908C15.4608 20.2843 15.1548 20.5903 14.7785 20.782C14.3507 21 13.7906 21 12.6705 21" stroke="#BB79D1" strokeWidth="1.5" strokeLinecap="round" />
25 |               </svg>
26 |             </div>
27 | 
28 |             <h1 className="text-3xl font-bold text-[#222] mb-4 text-center">
29 |               Página no encontrada
30 |             </h1>
31 | 
32 |             <p className="text-[#333] mb-10 text-center">
33 |               Parece que te has aventurado a un lugar que no existe en nuestro mundo mágico.
34 |             </p>
35 | 
36 |             <button
37 |               onClick={() => navigate("/")}
38 |               className="w-full flex items-center justify-center gap-2 bg-[#BB79D1] hover:bg-[#BB79D1]/90 text-white rounded-full py-4 font-semibold text-lg"
39 |             >
40 |               <Home size={20} />
41 |               Volver al inicio
42 |             </button>
43 |           </div>
44 |         </div>
45 |       </div>
46 |     </PageTransition>
47 |   );
48 | }
```

src/pages/PaymentCancel.tsx
```
1 | import { useEffect, useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { ArrowLeft } from "lucide-react";
4 | import PageTransition from "../components/PageTransition";
5 | 
6 | export default function PaymentCancel() {
7 |   const navigate = useNavigate();
8 |   const [timeLeft, setTimeLeft] = useState(5);
9 | 
10 |   useEffect(() => {
11 |     // Automatically redirect after 5 seconds
12 |     if (timeLeft > 0) {
13 |       const timer = setTimeout(() => {
14 |         setTimeLeft(timeLeft - 1);
15 |       }, 1000);
16 |       return () => clearTimeout(timer);
17 |     } else {
18 |       navigate("/profile");
19 |     }
20 |   }, [timeLeft, navigate]);
21 | 
22 |   return (
23 |     <PageTransition>
24 |       <div
25 |         className="min-h-screen flex flex-col items-center justify-center p-4"
26 |         style={{
27 |           backgroundColor: 'black',
28 |         }}
29 |       >
30 |         <div className="w-full max-w-md bg-white/90 rounded-3xl shadow-lg overflow-hidden">
31 |           <div className="p-8 flex flex-col items-center">
32 |             <div className="p-3 bg-[#F6A5B7]/20 rounded-full mb-6">
33 |               <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
34 |                 <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#F6A5B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
35 |                 <path d="M12 8V12" stroke="#F6A5B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
36 |                 <path d="M12 16H12.01" stroke="#F6A5B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
37 |               </svg>
38 |             </div>
39 | 
40 |             <h1 className="text-2xl font-bold text-[#222] mb-4 text-center">Pago Cancelado</h1>
41 | 
42 |             <p className="text-[#333] text-center mb-4">
43 |               Has cancelado el proceso de pago. No se ha realizado ningún cargo a tu cuenta.
44 |             </p>
45 | 
46 |             <p className="text-[#333] mb-8 text-center">
47 |               Serás redirigido a tu perfil en <span className="font-bold text-[#F6A5B7]">{timeLeft}</span> segundos.
48 |             </p>
49 | 
50 |             <button
51 |               onClick={() => navigate("/profile")}
52 |               className="w-full flex items-center justify-center gap-2 bg-[#BB79D1] hover:bg-[#BB79D1]/90 text-white rounded-full py-4 font-semibold text-lg"
53 |             >
54 |               <ArrowLeft size={20} />
55 |               Volver a mi Perfil
56 |             </button>
57 |           </div>
58 |         </div>
59 |       </div>
60 |     </PageTransition>
61 |   );
62 | }
```

src/pages/PaymentSuccess.tsx
```
1 | import { useEffect, useState } from "react";
2 | import { useLocation, useNavigate } from "react-router-dom";
3 | import { Home } from "lucide-react";
4 | import { motion } from "framer-motion";
5 | import PageTransition from "../components/PageTransition";
6 | 
7 | export default function PaymentSuccess() {
8 |   const location = useLocation();
9 |   const navigate = useNavigate();
10 |   const [sessionId, setSessionId] = useState<string | null>(null);
11 | 
12 |   useEffect(() => {
13 |     // Extraer session_id de la URL
14 |     const queryParams = new URLSearchParams(location.search);
15 |     const sessionIdParam = queryParams.get('session_id');
16 | 
17 |     if (sessionIdParam) {
18 |       console.log("ID de sesión de Stripe:", sessionIdParam);
19 |       setSessionId(sessionIdParam);
20 |     }
21 |   }, [location]);
22 | 
23 |   return (
24 |     <PageTransition>
25 |       <div
26 |         className="min-h-screen flex flex-col items-center justify-center p-6"
27 |         style={{
28 |           backgroundColor: 'black',
29 |         }}
30 |       >
31 |         <div className="w-full max-w-md bg-white/90 rounded-3xl shadow-lg overflow-hidden">
32 |           <div className="p-8 flex flex-col items-center">
33 |             <div className="w-24 h-24 mx-auto rounded-full bg-[#A5D6F6]/20 flex items-center justify-center mb-6">
34 |               <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
35 |                 <path d="M30 5C16.2 5 5 16.2 5 30C5 43.8 16.2 55 30 55C43.8 55 55 43.8 55 30C55 16.2 43.8 5 30 5ZM30 50C18.95 50 10 41.05 10 30C10 18.95 18.95 10 30 10C41.05 10 50 18.95 50 30C50 41.05 41.05 50 30 50ZM42.5 20L27.5 35L20 27.5L16.25 31.25L27.5 42.5L46.25 23.75L42.5 20Z" fill="#A5D6F6" />
36 |               </svg>
37 |             </div>
38 | 
39 |             <h1 className="text-3xl font-bold text-[#222] mb-4">
40 |               ¡Pago Exitoso!
41 |             </h1>
42 | 
43 |             <p className="text-[#333] text-lg mb-12">
44 |               Gracias por tu compra. Tu cuenta se actualizará en breve.
45 |             </p>
46 | 
47 |             <button
48 |               onClick={() => navigate('/home')}
49 |               className="w-full flex items-center justify-center gap-2 bg-[#BB79D1] hover:bg-[#BB79D1]/90 text-white rounded-full py-4 font-semibold text-lg"
50 |             >
51 |               <Home size={20} />
52 |               Volver al inicio
53 |             </button>
54 |           </div>
55 |         </div>
56 |       </div>
57 |     </PageTransition>
58 |   );
59 | }
```

src/pages/PlansPage.tsx
```
1 | import React, { useState, useEffect } from 'react';
2 | import { useNavigate, Link, useLocation } from 'react-router-dom';
3 | import { useUserStore } from '@/store/user/userStore'; // Adjust path if needed
4 | import { supabase } from '@/supabaseClient'; // Adjust path if needed
5 | import { useToast } from '@/hooks/use-toast'; // Adjust path if needed
6 | import PageTransition from '@/components/PageTransition'; // Adjust path if needed
7 | import BackButton from '@/components/BackButton';
8 | import { motion } from 'framer-motion';
9 | import {
10 |     Star,
11 |     BookOpen,
12 |     TrendingUp,
13 |     Mic,
14 |     CheckCircle,
15 |     XCircle,
16 |     ChevronRight,
17 |     ChevronLeft,
18 |     Sparkles,
19 |     CreditCard,
20 |     Settings,
21 |     AlertTriangle,
22 |     Euro
23 | } from 'lucide-react';
24 | 
25 | const PlansPage: React.FC = () => {
26 |     const navigate = useNavigate();
27 |     const location = useLocation();
28 |     const { toast } = useToast();
29 |     const { profileSettings, isPremium } = useUserStore(
30 |         (state) => ({
31 |             profileSettings: state.profileSettings,
32 |             isPremium: state.isPremium,
33 |         })
34 |     );
35 | 
36 |     const [isCheckoutLoading, setIsCheckoutLoading] = useState(false);
37 |     const [isPortalLoading, setIsPortalLoading] = useState(false);
38 |     const [activeTab, setActiveTab] = useState<'comparison' | 'details'>(isPremium() ? 'details' : 'comparison');
39 |     const [activePlan, setActivePlan] = useState<'free' | 'premium'>(isPremium() ? 'premium' : 'free');
40 | 
41 |     // Handle tab query parameter
42 |     useEffect(() => {
43 |         const queryParams = new URLSearchParams(location.search);
44 |         const tabParam = queryParams.get('tab');
45 |         if (tabParam === 'premium') {
46 |             setActivePlan('premium');
47 |         } else if (tabParam === 'free') {
48 |             setActivePlan('free');
49 |         }
50 |     }, [location.search]);
51 | 
52 |     const handleCheckout = async (item: 'premium' | 'credits') => {
53 |         setIsCheckoutLoading(true);
54 |         try {
55 |             const { data, error } = await supabase.functions.invoke('create-checkout-session', {
56 |                 body: JSON.stringify({ item }),
57 |             });
58 | 
59 |             if (error) throw error;
60 | 
61 |             if (data?.url) {
62 |                 window.location.href = data.url;
63 |             } else {
64 |                 throw new Error('No se recibió URL de checkout.');
65 |             }
66 |         } catch (error: Error | unknown) {
67 |             console.error(`Error creating ${item} checkout session:`, error);
68 |             toast({ title: 'Error', description: `No se pudo iniciar el pago: ${error instanceof Error ? error.message : 'Error desconocido'}`, variant: 'destructive' });
69 |             setIsCheckoutLoading(false);
70 |         } // No finally needed as page redirects on success
71 |     };
72 | 
73 |     const handleManageSubscription = async () => {
74 |         if (!profileSettings?.stripe_customer_id) {
75 |             toast({ title: 'Error', description: 'No se encontró información de cliente para gestionar la suscripción.', variant: 'destructive' });
76 |             return;
77 |         }
78 | 
79 |         setIsPortalLoading(true);
80 |         try {
81 |             const { data, error } = await supabase.functions.invoke('create-customer-portal-session');
82 | 
83 |             if (error) throw error;
84 | 
85 |             if (data?.url) {
86 |                 window.location.href = data.url;
87 |             } else {
88 |                 throw new Error('No se recibió URL del portal de cliente.');
89 |             }
90 |         } catch (error: Error | unknown) {
91 |             console.error("Error creating customer portal session:", error);
92 |             toast({ title: 'Error', description: `No se pudo redirigir a la gestión de suscripción: ${error instanceof Error ? error.message : 'Error desconocido'}`, variant: 'destructive' });
93 |             setIsPortalLoading(false);
94 |         } // No finally block needed for isLoading as page redirects on success
95 |     };
96 | 
97 |     const premiumUser = isPremium();
98 | 
99 |     // Define features for comparison table (updated per requirements)
100 |     const features = [
101 |         { name: 'Historias Generadas', free: '10 / mes', premium: 'Ilimitadas', icon: BookOpen, limited: true },
102 |         { name: 'Continuaciones por Historia', free: '1', premium: 'Ilimitadas', icon: TrendingUp, limited: true },
103 |         { name: 'Narración con Voz (IA)', free: 'Si (2 / mes)', premium: 'Sí (20/mes incl.)', icon: Mic, limited: true },
104 |         { name: 'Retos Creativos', free: 'Ilimitados', premium: 'Ilimitados', icon: CheckCircle, limited: false },
105 |     ];
106 | 
107 |     return (
108 |         <PageTransition>
109 |             <div
110 |                 className="relative min-h-screen flex flex-col items-center justify-start p-0"
111 |                 style={{
112 |                     backgroundColor: 'black',
113 |                 }}
114 |             >
115 |                 {/* Logo y cabecera - Reducido espacio */}
116 |                 <div className="flex flex-col items-center mt-4 mb-0 select-none">
117 |                     <img src="/logo_fantasia.png" alt="Fantasia Logo" className="w-60 max-w-xs mx-auto mb-0 drop-shadow-xl" />
118 |                 </div>
119 |                 <div className="container mx-auto px-4 py-0 max-w-4xl">
120 |                     {/* Back button */}
121 |                     <BackButton className="absolute top-8 left-4 md:left-8" />
122 |                     {/* Premium User View */}
123 |                     {premiumUser && (
124 |                         <div className="pt-0 flex flex-col min-h-[80vh] justify-between">
125 |                             <div>
126 |                                 <motion.div
127 |                                     initial={{ opacity: 0, y: -10 }}
128 |                                     animate={{ opacity: 1, y: 0 }}
129 |                                     transition={{ duration: 0.5 }}
130 |                                     className="text-center mb-6"
131 |                                 >
132 |                                     <div className="inline-flex justify-center items-center w-16 h-16 rounded-full bg-[#F9DA60] mb-2">
133 |                                         <Star className="h-8 w-8 text-[#BB79D1]" />
134 |                                     </div>
135 |                                     <h1 className="text-3xl md:text-4xl font-bold mb-2 font-heading text-[#BB79D1]">Plan Premium Activo</h1>
136 |                                     <p className="text-[#7DC4E0] text-lg">Disfruta de todas las funciones sin límites</p>
137 |                                 </motion.div>
138 |                                 <div className="grid md:grid-cols-2 gap-6 mt-8">
139 |                                     {/* Card: Buy Voice Credits */}
140 |                                     <motion.div
141 |                                         initial={{ opacity: 0, y: 20 }}
142 |                                         animate={{ opacity: 1, y: 0 }}
143 |                                         transition={{ duration: 0.5, delay: 0.1 }}
144 |                                         className="bg-white/40 backdrop-blur-md rounded-3xl overflow-hidden shadow-xl border border-[#A5D6F6]/30"
145 |                                     >
146 |                                         <div className="p-6">
147 |                                             <div className="flex items-center gap-3 mb-4">
148 |                                                 <div className="w-10 h-10 rounded-full bg-[#A5D6F6]/40 flex items-center justify-center">
149 |                                                     <Mic className="h-5 w-5 text-[#7DC4E0]" />
150 |                                                 </div>
151 |                                                 <div>
152 |                                                     <h3 className="font-bold text-xl font-heading text-[#BB79D1]">Créditos de Voz</h3>
153 |                                                     <p className="text-[#7DC4E0] text-sm">Amplía tus narraciones</p>
154 |                                                 </div>
155 |                                             </div>
156 |                                             <div className="mb-6">
157 |                                                 <div className="flex justify-between items-center mb-2">
158 |                                                     <span className="text-[#BB79D1]">Disponibles:</span>
159 |                                                     <span className="font-mono font-bold text-lg text-[#7DC4E0]">{profileSettings?.voice_credits || 0}</span>
160 |                                                 </div>
161 |                                                 <div className="h-2 bg-[#E6B7D9]/40 rounded-full overflow-hidden">
162 |                                                     <div className="h-full bg-gradient-to-r from-[#7DC4E0] to-[#BB79D1]"
163 |                                                         style={{ width: `${Math.min(100, ((profileSettings?.voice_credits || 0) / 20) * 100)}%` }}></div>
164 |                                                 </div>
165 |                                             </div>
166 |                                             <button
167 |                                                 onClick={() => handleCheckout('credits')}
168 |                                                 disabled={isCheckoutLoading}
169 |                                                 className="w-full py-3 px-4 bg-[#A5D6F6]/70 border border-[#A5D6F6]/60 hover:bg-[#A5D6F6] text-white rounded-2xl font-medium flex justify-center items-center gap-2 shadow-lg transform transition-transform duration-200 hover:scale-[1.02] active:scale-[0.98]"
170 |                                             >
171 |                                                 {isCheckoutLoading ? (
172 |                                                     <div className="h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
173 |                                                 ) : (
174 |                                                     <>
175 |                                                         <CreditCard className="h-4 w-4" />
176 |                                                         <span>Comprar Créditos</span>
177 |                                                     </>
178 |                                                 )}
179 |                                             </button>
180 |                                         </div>
181 |                                     </motion.div>
182 |                                     {/* Card: Manage Subscription */}
183 |                                     <motion.div
184 |                                         initial={{ opacity: 0, y: 20 }}
185 |                                         animate={{ opacity: 1, y: 0 }}
186 |                                         transition={{ duration: 0.5, delay: 0.2 }}
187 |                                         className="bg-white/40 backdrop-blur-md rounded-3xl overflow-hidden shadow-xl border border-[#F9DA60]/30"
188 |                                     >
189 |                                         <div className="p-6">
190 |                                             <div className="flex items-center gap-3 mb-4">
191 |                                                 <div className="w-10 h-10 rounded-full bg-[#F9DA60]/40 flex items-center justify-center">
192 |                                                     <Star className="h-5 w-5 text-[#F9DA60]" />
193 |                                                 </div>
194 |                                                 <div>
195 |                                                     <h3 className="font-bold text-xl font-heading text-[#BB79D1]">Suscripción Premium</h3>
196 |                                                     <p className="text-[#7DC4E0] text-sm">Administra tu plan</p>
197 |                                                 </div>
198 |                                             </div>
199 |                                             <div className="space-y-4 mb-6">
200 |                                                 <div className="bg-white/70 rounded-lg p-3 flex justify-between items-center border border-[#F9DA60]/30">
201 |                                                     <span className="text-[#222] font-medium">Estado:</span>
202 |                                                     <span className="font-bold text-[#F9DA60] bg-[#F9DA60]/20 px-3 py-1 rounded-full border border-[#F9DA60]/30">Activo</span>
203 |                                                 </div>
204 |                                                 <div className="bg-[#F6A5B7]/10 rounded-lg p-3 flex justify-between items-center">
205 |                                                     <span className="text-[#BB79D1]">Beneficios:</span>
206 |                                                     <span className="font-medium text-[#BB79D1]">Todos los incluidos</span>
207 |                                                 </div>
208 |                                             </div>
209 |                                             <button
210 |                                                 onClick={handleManageSubscription}
211 |                                                 disabled={isPortalLoading}
212 |                                                 className="flex items-center justify-between w-full py-3 px-4 bg-[#F9DA60]/60 border border-[#F9DA60]/40 hover:bg-[#F9DA60]/80 text-[#BB79D1] rounded-2xl font-medium transition-all shadow-md hover:shadow-lg"
213 |                                             >
214 |                                                 <div className="flex items-center gap-2">
215 |                                                     <Settings className="h-4 w-4" />
216 |                                                     <span>Gestionar Suscripción</span>
217 |                                                 </div>
218 |                                                 {isPortalLoading ? (
219 |                                                     <div className="h-4 w-4 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin"></div>
220 |                                                 ) : (
221 |                                                     <ChevronRight className="h-4 w-4" />
222 |                                                 )}
223 |                                             </button>
224 |                                         </div>
225 |                                     </motion.div>
226 |                                 </div>
227 |                                 {/* Bottom Premium Features Reminder */}
228 |                                 <motion.div
229 |                                     initial={{ opacity: 0, y: 20 }}
230 |                                     animate={{ opacity: 1, y: 0 }}
231 |                                     transition={{ duration: 0.5, delay: 0.3 }}
232 |                                     className="mt-8 bg-white/60 backdrop-blur-md rounded-3xl p-5 border border-[#F9DA60]/40 shadow-lg"
233 |                                 >
234 |                                     <h3 className="font-bold text-xl mb-4 flex items-center gap-2 font-heading text-[#BB79D1]">
235 |                                         <Sparkles className="h-6 w-6 text-[#F9DA60]" />
236 |                                         <span>Beneficios Premium Activos</span>
237 |                                     </h3>
238 |                                     <ul className="grid grid-cols-1 md:grid-cols-2 gap-4">
239 |                                         {features.map((feature, i) => (
240 |                                             <li key={i} className="flex items-center gap-3 bg-white/70 p-3 rounded-xl border border-[#BB79D1]/10 shadow-sm">
241 |                                                 <CheckCircle className="h-6 w-6 text-green-500 flex-shrink-0" />
242 |                                                 <div>
243 |                                                     <div className="flex items-center gap-2">
244 |                                                         <feature.icon className="h-4 w-4 text-[#7DC4E0]" />
245 |                                                         <span className="font-bold text-[#222]">{feature.name}</span>
246 |                                                     </div>
247 |                                                     <span className="text-sm font-medium text-[#BB79D1]">{feature.premium}</span>
248 |                                                 </div>
249 |                                             </li>
250 |                                         ))}
251 |                                     </ul>
252 |                                 </motion.div>
253 |                                 {/* Botón para ir a la app */}
254 |                                 <motion.div
255 |                                     initial={{ opacity: 0 }}
256 |                                     animate={{ opacity: 1 }}
257 |                                     transition={{ duration: 0.5, delay: 0.4 }}
258 |                                     className="mt-8 mb-14 text-center"
259 |                                 >
260 |                                     <Link
261 |                                         to="/home"
262 |                                         className="inline-block py-3 px-6 bg-[#BB79D1] hover:bg-[#A37AC2] text-white rounded-2xl font-medium flex items-center justify-center gap-2 shadow-lg transform transition-transform duration-200 hover:scale-[1.02] active:scale-[0.98] mx-auto"
263 |                                     >
264 |                                         <BookOpen className="h-5 w-5" />
265 |                                         <span>Ir a la aplicación</span>
266 |                                     </Link>
267 |                                 </motion.div>
268 |                             </div>
269 |                         </div>
270 |                     )}
271 |                     {/* Free User View */}
272 |                     {!premiumUser && (
273 |                         <div className="pt-0 flex flex-col min-h-[80vh] justify-between">
274 |                             <div>
275 |                                 {/* Header */}
276 |                                 <motion.div
277 |                                     initial={{ opacity: 0, y: -10 }}
278 |                                     animate={{ opacity: 1, y: 0 }}
279 |                                     transition={{ duration: 0.5 }}
280 |                                     className="text-center mb-4"
281 |                                 >
282 |                                     <h1 className="text-3xl md:text-4xl font-bold mb-1 font-heading text-[#BB79D1]">Desbloquea tu Creatividad</h1>
283 |                                     <p className="text-[#7DC4E0] text-lg mx-auto max-w-xl">
284 |                                         Compara los planes y elige la mejor experiencia para tus historias
285 |                                     </p>
286 |                                 </motion.div>
287 |                                 {/* Plan Toggle */}
288 |                                 <div className="flex justify-center mb-4">
289 |                                     <motion.div
290 |                                         initial={{ opacity: 0, y: 10 }}
291 |                                         animate={{ opacity: 1, y: 0 }}
292 |                                         transition={{ duration: 0.5, delay: 0.1 }}
293 |                                         className="bg-white/40 backdrop-blur-md rounded-full p-1 inline-flex"
294 |                                     >
295 |                                         <button
296 |                                             onClick={() => setActivePlan('free')}
297 |                                             className={`py-2 px-5 md:px-8 rounded-full transition-colors flex items-center gap-2 ${activePlan === 'free'
298 |                                                 ? 'bg-[#F6A5B7]/60 text-white font-medium'
299 |                                                 : 'text-[#BB79D1] hover:text-white'
300 |                                                 }`}
301 |                                         >
302 |                                             <span>Free</span>
303 |                                         </button>
304 |                                         <button
305 |                                             onClick={() => setActivePlan('premium')}
306 |                                             className={`py-2 px-5 md:px-8 rounded-full transition-colors flex items-center gap-2 relative ${activePlan === 'premium'
307 |                                                 ? 'bg-gradient-to-r from-[#F9DA60] to-[#F9DA60]/80 text-white font-medium'
308 |                                                 : 'text-[#BB79D1] hover:text-white'
309 |                                                 }`}
310 |                                         >
311 |                                             <Star className="h-4 w-4" />
312 |                                             <span>Premium</span>
313 |                                             <span className="absolute -top-2 -right-2 bg-[#F6A5B7] text-white text-xs font-bold py-0.5 px-2 rounded-full shadow-md">Próximamente</span>
314 |                                         </button>
315 |                                     </motion.div>
316 |                                 </div>
317 |                                 {/* Features by Plan */}
318 |                                 <motion.div
319 |                                     initial={{ opacity: 0, y: 20 }}
320 |                                     animate={{ opacity: 1, y: 0 }}
321 |                                     transition={{ duration: 0.5, delay: 0.2 }}
322 |                                     className="max-w-2xl mx-auto"
323 |                                 >
324 |                                     {/* Active Plan Card */}
325 |                                     <div className="bg-white/70 backdrop-blur-md rounded-3xl overflow-hidden shadow-xl border border-[#BB79D1]/20 mb-6">
326 |                                         {/* Plan Header - Mejorada legibilidad */}
327 |                                         <div className={`p-6 ${activePlan === 'premium'
328 |                                             ? 'bg-[#F9DA60]/20 border-b border-[#F9DA60]/40'
329 |                                             : 'bg-[#F6A5B7]/20 border-b border-[#BB79D1]/20'
330 |                                             }`}>
331 |                                             <div className="flex justify-between items-center">
332 |                                                 <h2 className="text-2xl font-bold flex items-center gap-2 font-heading text-[#BB79D1]">
333 |                                                     {activePlan === 'premium' && <Star className="h-5 w-5 text-[#F9DA60]" />}
334 |                                                     Plan {activePlan === 'premium' ? 'Premium' : 'Free'}
335 |                                                 </h2>
336 |                                                 {activePlan === 'premium' && (
337 |                                                     <span className="bg-[#F6A5B7] text-white px-3 py-1 rounded-full text-sm font-bold">
338 |                                                         Próximamente
339 |                                                     </span>
340 |                                                 )}
341 |                                             </div>
342 |                                             {activePlan === 'premium' ? (
343 |                                                 <>
344 |                                                     <p className="text-[#BB79D1] mt-1 font-medium">Creatividad sin límites para tus historias</p>
345 |                                                     <div className="flex items-center mt-3 bg-white/70 p-3 rounded-xl justify-between border border-[#F9DA60]">
346 |                                                         <div className="flex items-center gap-2">
347 |                                                             <Euro className="h-5 w-5 text-[#F9DA60]" />
348 |                                                             <span className="text-[#222] font-medium">Precio:</span>
349 |                                                         </div>
350 |                                                         <div className="font-bold text-xl text-[#BB79D1] flex items-center gap-1">
351 |                                                             <span>10€</span>
352 |                                                             <span className="text-sm font-normal text-[#222] opacity-80">/mes</span>
353 |                                                         </div>
354 |                                                     </div>
355 |                                                 </>
356 |                                             ) : (
357 |                                                 <p className="text-[#7DC4E0] mt-1">Perfecto para comenzar a explorar</p>
358 |                                             )}
359 |                                         </div>
360 | 
361 |                                         {/* Premium "Hazte Premium" button - Only shown on premium tab */}
362 |                                         {activePlan === 'premium' && (
363 |                                             <div className="p-6 pt-4 pb-0">
364 |                                                 <button
365 |                                                     disabled={true}
366 |                                                     className="w-full py-3 px-6 bg-gradient-to-r from-[#F9DA60]/60 to-[#F9DA60]/40 text-[#BB79D1] rounded-2xl font-bold flex justify-center items-center gap-2 shadow-lg cursor-not-allowed relative overflow-hidden"
367 |                                                 >
368 |                                                     <Star className="h-5 w-5" />
369 |                                                     <span>Hazte Premium Ahora</span>
370 |                                                 </button>
371 |                                                 <p className="text-center text-sm text-[#BB79D1] mt-3 font-medium">Estamos trabajando para ofrecerte esta opción muy pronto</p>
372 |                                             </div>
373 |                                         )}
374 | 
375 |                                         {/* Features List - Consistent style for both tabs */}
376 |                                         <div className="p-6">
377 |                                             <h3 className="font-bold text-lg mb-4 flex items-center gap-2 font-heading text-[#BB79D1]">
378 |                                                 <Sparkles className="h-5 w-5 text-[#F9DA60]" />
379 |                                                 <span>{activePlan === 'premium' ? 'Beneficios Premium' : 'Características del plan'}</span>
380 |                                             </h3>
381 | 
382 |                                             <ul className="space-y-3">
383 |                                                 {features.map((feature, index) => (
384 |                                                     <li key={index} className="bg-white/60 p-3 rounded-lg border border-[#BB79D1]/10 shadow-sm">
385 |                                                         <div className="flex items-center gap-3">
386 |                                                             <div className="flex-shrink-0">
387 |                                                                 {activePlan === 'premium' ? (
388 |                                                                     feature.premium === 'No' ? (
389 |                                                                         <XCircle className="h-5 w-5 text-red-400" />
390 |                                                                     ) : (
391 |                                                                         <CheckCircle className="h-5 w-5 text-green-500" />
392 |                                                                     )
393 |                                                                 ) : (
394 |                                                                     feature.free === 'No' ? (
395 |                                                                         <XCircle className="h-5 w-5 text-red-400" />
396 |                                                                     ) : (
397 |                                                                         feature.limited ? (
398 |                                                                             <AlertTriangle className="h-5 w-5 text-[#F9DA60]" />
399 |                                                                         ) : (
400 |                                                                             <CheckCircle className="h-5 w-5 text-green-500" />
401 |                                                                         )
402 |                                                                     )
403 |                                                                 )}
404 |                                                             </div>
405 |                                                             <div>
406 |                                                                 <div className="flex items-center gap-2">
407 |                                                                     <feature.icon className="h-4 w-4 text-[#7DC4E0]" />
408 |                                                                     <span className="font-bold text-[#222]">{feature.name}</span>
409 |                                                                 </div>
410 |                                                                 <div className="text-sm font-medium text-[#444]">
411 |                                                                     {activePlan === 'premium' ? feature.premium : feature.free}
412 |                                                                     {activePlan === 'free' && feature.limited && (
413 |                                                                         <span className="text-xs text-[#BB79D1] ml-1 font-bold">(limitado)</span>
414 |                                                                     )}
415 |                                                                 </div>
416 |                                                             </div>
417 |                                                         </div>
418 |                                                     </li>
419 |                                                 ))}
420 |                                             </ul>
421 |                                         </div>
422 |                                     </div>
423 |                                 </motion.div>
424 |                             </div>
425 |                             {/* Botones de navegación entre planes - Con espacio abajo */}
426 |                             <div className="flex flex-col md:flex-row justify-center gap-4 mb-10">
427 |                                 {activePlan === 'free' && (
428 |                                     <button
429 |                                         onClick={() => setActivePlan('premium')}
430 |                                         className="py-3 px-8 bg-gradient-to-r from-[#F6A5B7] to-[#BB79D1] text-white rounded-2xl font-bold shadow-lg flex items-center gap-2 transition-all duration-200 hover:scale-105 hover:bg-[#BB79D1]/90"
431 |                                     >
432 |                                         <Star className="h-5 w-5" />
433 |                                         <span>Ver plan Premium</span>
434 |                                         <ChevronRight className="h-4 w-4" />
435 |                                     </button>
436 |                                 )}
437 |                                 {activePlan === 'premium' && (
438 |                                     <button
439 |                                         onClick={() => setActivePlan('free')}
440 |                                         className="py-3 px-8 bg-[#A5D6F6]/70 text-[#BB79D1] rounded-2xl font-bold shadow-lg flex items-center gap-2 transition-all duration-200 hover:scale-105 hover:bg-[#BB79D1]/20"
441 |                                     >
442 |                                         <ChevronLeft className="h-4 w-4" />
443 |                                         <span>Ver plan Free</span>
444 |                                     </button>
445 |                                 )}
446 |                                 {/* Botón para continuar gratis */}
447 |                                 {activePlan === 'free' && (
448 |                                     <Link
449 |                                         to="/home"
450 |                                         className="py-3 px-8 bg-transparent border border-[#BB79D1]/50 hover:bg-[#BB79D1]/10 text-[#BB79D1] rounded-2xl font-bold transition-all shadow-sm hover:shadow-md flex items-center gap-2"
451 |                                     >
452 |                                         Continuar con el plan gratuito
453 |                                     </Link>
454 |                                 )}
455 |                             </div>
456 |                         </div>
457 |                     )}
458 |                 </div>
459 |             </div>
460 |         </PageTransition>
461 |     );
462 | };
463 | 
464 | export default PlansPage;
```

src/pages/PrivacyPolicy.tsx
```
1 | import React from 'react';
2 | import { useNavigate } from 'react-router-dom';
3 | import { Button } from "@/components/ui/button";
4 | import PageTransition from "../components/PageTransition";
5 | 
6 | const PrivacyPolicy: React.FC = () => {
7 |   const navigate = useNavigate();
8 | 
9 |   return (
10 |     <PageTransition>
11 |       <div 
12 |         className="min-h-screen flex flex-col"
13 |         style={{
14 |           backgroundColor: 'black',
15 |         }}
16 |       >
17 |         <div className="container mx-auto py-8 px-4 flex-1 overflow-auto">
18 |           <div className="max-w-4xl mx-auto">
19 |             <div className="text-center mb-6">
20 |               <h1 className="text-3xl font-bold text-[#222]">POLÍTICA DE PRIVACIDAD DE Fantasia!</h1>
21 |               <p className="text-sm text-[#555] mt-2">Última actualización: 23 de abril de 2025</p>
22 |             </div>
23 | 
24 |             <div className="space-y-6 bg-white/80 p-8 rounded-2xl backdrop-blur-sm shadow-lg">
25 |               <p className="font-medium">
26 |                 Resumen de privacidad: En Fantasia! valoramos tu confianza y nos comprometemos a proteger tus datos personales. Recopilamos únicamente la información imprescindible para ofrecerte nuestro servicio de generación de cuentos infantiles con Inteligencia Artificial, la almacenamos bajo estrictas medidas de seguridad y te damos control absoluto sobre su uso. A continuación, te explicamos de forma clara y transparente cómo tratamos tus datos.
27 |               </p>
28 | 
29 |               <div>
30 |                 <h2 className="text-xl font-bold text-[#BB79D1]">1. RESPONSABLE DEL TRATAMIENTO</h2>
31 |                 <p className="mt-2">
32 |                   Fantasia! (en adelante, "Fantasia!"), con domicilio en Zaragoza, España, y correo electrónico de contacto hola@fantasia.app, es la entidad responsable del tratamiento de tus datos personales cuando utilizas la plataforma Fantasia!.
33 |                 </p>
34 |               </div>
35 | 
36 |               <div>
37 |                 <h2 className="text-xl font-bold text-[#BB79D1]">2. ¿QUÉ DATOS RECOPILAMOS Y POR QUÉ?</h2>
38 |                 <p className="mt-2 font-medium">2.1 Datos facilitados por el Usuario</p>
39 |                 <p className="mt-2">
40 |                   Registro: nombre, dirección de correo electrónico, contraseña.
41 |                 </p>
42 |                 <p className="mt-2">
43 |                   Perfil y preferencias: edad del niño o niña, temas favoritos, idioma y estilo de cuento.
44 |                 </p>
45 |                 <p className="mt-2">
46 |                   Comunicación: mensajes o consultas que envíes a través de nuestro formulario o correo.
47 |                 </p>
48 |                 
49 |                 <p className="mt-4 font-medium">2.2 Datos técnicos y de uso</p>
50 |                 <p className="mt-2">
51 |                   Dirección IP, tipo de navegador, dispositivo, sistema operativo.
52 |                 </p>
53 |                 <p className="mt-2">
54 |                   Páginas visitadas, duración de la sesión, acciones realizadas (generación, edición, descarga de cuentos).
55 |                 </p>
56 |                 <p className="mt-2">
57 |                   Cookies y tecnologías similares para mejorar la experiencia y personalizar contenidos.
58 |                 </p>
59 |               </div>
60 | 
61 |               <div>
62 |                 <h2 className="text-xl font-bold text-[#BB79D1]">3. FINALIDADES DEL TRATAMIENTO</h2>
63 |                 <p className="mt-2">
64 |                   Utilizamos tus datos para:
65 |                 </p>
66 |                 <p className="mt-2">
67 |                   Gestionar tu cuenta y acceso a Fantasia!.
68 |                 </p>
69 |                 <p className="mt-2">
70 |                   Generar, guardar y entregar por email los cuentos infantiles que solicites.
71 |                 </p>
72 |                 <p className="mt-2">
73 |                   Enviar notificaciones por correo electrónico sobre el estado de tus creaciones, novedades y mejoras de la plataforma.
74 |                 </p>
75 |                 <p className="mt-2">
76 |                   Prestar soporte técnico y atención al cliente.
77 |                 </p>
78 |                 <p className="mt-2">
79 |                   Cumplir con obligaciones legales y de seguridad.
80 |                 </p>
81 |               </div>
82 | 
83 |               <div>
84 |                 <h2 className="text-xl font-bold text-[#BB79D1]">4. COOKIES Y TECNOLOGÍAS SIMILARES</h2>
85 |                 <p className="mt-2">
86 |                   Para optimizar tu experiencia y analizar el uso de Fantasia!, empleamos cookies propias y de terceros. Puedes gestionar o desactivar las cookies desde la configuración de tu navegador; ten en cuenta que ello podría afectar la funcionalidad del servicio. Consulta nuestra Política de Cookies para más información.
87 |                 </p>
88 |               </div>
89 | 
90 |               <div>
91 |                 <h2 className="text-xl font-bold text-[#BB79D1]">5. SEGURIDAD DE TUS DATOS</h2>
92 |                 <p className="mt-2">
93 |                   Implementamos medidas técnicas y organizativas (cifrado HTTPS, controles de acceso, backups) para proteger tus datos contra accesos no autorizados, alteraciones o pérdida. Recomendamos cerrar sesión cuando uses dispositivos compartidos y mantener tu contraseña en un lugar seguro.
94 |                 </p>
95 |               </div>
96 | 
97 |               <div>
98 |                 <h2 className="text-xl font-bold text-[#BB79D1]">6. ENLACES A TERCEROS</h2>
99 |                 <p className="mt-2">
100 |                   Fantasia! puede incluir enlaces a sitios web o servicios de terceros. No somos responsables de las prácticas de privacidad ni del contenido de estas webs externas, por lo que te aconsejamos leer sus propias políticas de privacidad.
101 |                 </p>
102 |               </div>
103 | 
104 |               <div>
105 |                 <h2 className="text-xl font-bold text-[#BB79D1]">7. TUS DERECHOS Y CÓMO EJERCERLOS</h2>
106 |                 <p className="mt-2">
107 |                   Tienes derecho a:
108 |                 </p>
109 |                 <p className="mt-2">
110 |                   Acceder a tus datos personales.
111 |                 </p>
112 |                 <p className="mt-2">
113 |                   Rectificar datos inexactos o incompletos.
114 |                 </p>
115 |                 <p className="mt-2">
116 |                   Eliminar tus datos (derecho al olvido).
117 |                 </p>
118 |                 <p className="mt-2">
119 |                   Limitar u oponerte a ciertos tratamientos.
120 |                 </p>
121 |                 <p className="mt-2">
122 |                   Portabilidad de tus datos.
123 |                 </p>
124 |                 <p className="mt-2">
125 |                   Retirar tu consentimiento en cualquier momento, sin que ello afecte la licitud del tratamiento previo.
126 |                 </p>
127 |                 <p className="mt-4">
128 |                   Para ejercerlos, puedes:
129 |                 </p>
130 |                 <p className="mt-2">
131 |                   Acceder a tu perfil y modificar tus datos.
132 |                 </p>
133 |                 <p className="mt-2">
134 |                   Enviar un email a hola@fantasia.app con asunto "Protección de Datos" e indicando claramente qué derecho deseas ejercer.
135 |                 </p>
136 |               </div>
137 | 
138 |               <div>
139 |                 <h2 className="text-xl font-bold text-[#BB79D1]">8. USO DEL SERVICIO POR MENORES</h2>
140 |                 <p className="mt-2">
141 |                   Fantasia! está pensado para la creación de cuentos infantiles a iniciativa de un adulto responsable. Los menores de 14 años deberán contar con el consentimiento de su padre, madre o tutor legal para la recogida y tratamiento de sus datos.
142 |                 </p>
143 |               </div>
144 | 
145 |               <div>
146 |                 <h2 className="text-xl font-bold text-[#BB79D1]">9. CONSERVACIÓN DE LOS DATOS</h2>
147 |                 <p className="mt-2">
148 |                   Conservaremos tus datos mientras mantengas una cuenta activa en Fantasia! y, una vez cancelada, durante el tiempo necesario para cumplir con obligaciones legales (p. ej., fiscales), salvo que solicites su supresión antes.
149 |                 </p>
150 |               </div>
151 | 
152 |               <div>
153 |                 <h2 className="text-xl font-bold text-[#BB79D1]">10. CAMBIOS EN ESTA POLÍTICA</h2>
154 |                 <p className="mt-2">
155 |                   Podemos actualizar esta Política de Privacidad para adaptarla a novedades legales o mejoras de servicio. Te informaremos de los cambios relevantes a través de un aviso en la plataforma o por correo electrónico antes de que entren en vigor.
156 |                 </p>
157 |               </div>
158 | 
159 |               <div>
160 |                 <h2 className="text-xl font-bold text-[#BB79D1]">11. CONTACTO Y RECLAMACIONES</h2>
161 |                 <p className="mt-2">
162 |                   Si tienes dudas, consultas o reclamaciones sobre el tratamiento de tus datos, puedes escribirnos a hola@fantasia.app. También tienes derecho a presentar una reclamación ante la Agencia Española de Protección de Datos si consideras que tus derechos no se han atendido correctamente.
163 |                 </p>
164 |               </div>
165 | 
166 |               <p className="italic">
167 |                 Gracias por confiar en Fantasia! Tu privacidad y la de los más pequeños son nuestra máxima prioridad.
168 |               </p>
169 |             </div>
170 |             
171 |             <div className="flex justify-center mt-6">
172 |               <Button 
173 |                 variant="default" 
174 |                 onClick={() => navigate(-1)}
175 |                 className="min-w-32"
176 |               >
177 |                 Volver
178 |               </Button>
179 |             </div>
180 |           </div>
181 |         </div>
182 |       </div>
183 |     </PageTransition>
184 |   );
185 | };
186 | 
187 | export default PrivacyPolicy; 
```

src/pages/ProfileConfigPage.tsx
```
1 | import React, { useState, useEffect } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { Check, Globe, User, Heart } from "lucide-react";
4 | import { motion } from "framer-motion";
5 | 
6 | // Imports de Supabase (SIN Zustand Store)
7 | import { supabase } from "@/supabaseClient";
8 | import { useToast } from "@/hooks/use-toast";
9 | 
10 | // UI Components
11 | import BackButton from "@/components/BackButton";
12 | import PageTransition from "@/components/PageTransition";
13 | import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
14 | import { Textarea } from "@/components/ui/textarea";
15 | 
16 | const ProfileConfigPage: React.FC = () => {
17 |     const navigate = useNavigate();
18 |     const { toast } = useToast();
19 | 
20 |     // Estado Local del Formulario (SOLO campos que existen en DB)
21 |     const [language, setLanguage] = useState("en");
22 |     const [preferences, setPreferences] = useState("");
23 |     const [isLoading, setIsLoading] = useState(true);
24 |     const [isSaving, setIsSaving] = useState(false);
25 |     const [currentUser, setCurrentUser] = useState<any>(null);
26 | 
27 |     // Definiciones de idiomas (INGLÉS PRIMERO)
28 |     const languages = [
29 |         { value: "en", label: "English", flag: "🇺🇸" },
30 |         { value: "es", label: "Español", flag: "🇪🇸" },
31 |         { value: "fr", label: "Français", flag: "🇫🇷" },
32 |         { value: "de", label: "Deutsch", flag: "🇩🇪" },
33 |         { value: "it", label: "Italiano", flag: "🇮🇹" }
34 |     ];
35 | 
36 |     // Cargar datos DIRECTAMENTE de Supabase (SIN Store)
37 |     useEffect(() => {
38 |         const loadProfileData = async () => {
39 |             try {
40 |                 setIsLoading(true);
41 |                 
42 |                 // 1. Verificar autenticación
43 |                 const { data: { user }, error: authError } = await supabase.auth.getUser();
44 |                 if (authError || !user) {
45 |                     toast({
46 |                         title: "Authentication Required",
47 |                         description: "Please log in to configure your profile.",
48 |                         variant: "destructive",
49 |                     });
50 |                     navigate("/login");
51 |                     return;
52 |                 }
53 |                 
54 |                 setCurrentUser(user);
55 | 
56 |                 // 2. Cargar perfil DIRECTAMENTE de la tabla profiles
57 |                 const { data: profile, error: profileError } = await supabase
58 |                     .from('profiles')
59 |                     .select('language, preferences, has_completed_setup')
60 |                     .eq('id', user.id)
61 |                     .single();
62 | 
63 |                 if (profileError) {
64 |                     console.error("Error loading profile:", profileError);
65 |                     // Usar valores por defecto para nuevo usuario
66 |                     setLanguage("en");
67 |                     setPreferences("");
68 |                 } else {
69 |                     // Cargar datos existentes
70 |                     setLanguage(profile.language || "en");
71 |                     setPreferences(profile.preferences || "");
72 |                 }
73 | 
74 |             } catch (error) {
75 |                 console.error("Error in loadProfileData:", error);
76 |                 toast({
77 |                     title: "Error",
78 |                     description: "Failed to load profile data.",
79 |                     variant: "destructive",
80 |                 });
81 |             } finally {
82 |                 setIsLoading(false);
83 |             }
84 |         };
85 | 
86 |         loadProfileData();
87 |     }, [navigate, toast]);
88 | 
89 |     // Guardar DIRECTAMENTE en Supabase (SIN Store)
90 |     const handleSubmit = async (e: React.FormEvent) => {
91 |         e.preventDefault();
92 |         
93 |         if (!currentUser) {
94 |             toast({
95 |                 title: "Error",
96 |                 description: "You must be authenticated to save your profile.",
97 |                 variant: "destructive",
98 |             });
99 |             return;
100 |         }
101 | 
102 |         setIsSaving(true);
103 |         try {
104 |             // Verificar si ya tenía setup completo
105 |             const { data: currentProfile } = await supabase
106 |                 .from('profiles')
107 |                 .select('has_completed_setup')
108 |                 .eq('id', currentUser.id)
109 |                 .single();
110 | 
111 |             const wasSetupComplete = currentProfile?.has_completed_setup || false;
112 | 
113 |             // Guardar DIRECTAMENTE en Supabase
114 |             // Cambiar de .update() a .upsert() como indica la Fase 2 del plan
115 |             const { error: upsertError } = await supabase
116 |                 .from('profiles')
117 |                 .upsert({
118 |                     id: currentUser.id,
119 |                     language: language,
120 |                     preferences: preferences.trim() || null,
121 |                     has_completed_setup: true
122 |                 }, {
123 |                     onConflict: 'id'
124 |                 });
125 | 
126 |             if (upsertError) {
127 |                 throw upsertError;
128 |             }
129 | 
130 |             // Después del upsert, verificar que se guardó correctamente
131 |             const { data: savedProfile, error: verifyError } = await supabase
132 |                 .from('profiles')
133 |                 .select('has_completed_setup')
134 |                 .eq('id', currentUser.id)
135 |                 .single();
136 | 
137 |             if (verifyError || !savedProfile?.has_completed_setup) {
138 |                 console.error("Verification failed after upsert:", verifyError);
139 |                 throw new Error('Profile was not saved correctly. Please try again.');
140 |             }
141 | 
142 |             // Navegación condicional
143 |             const nextPath = wasSetupComplete ? "/home" : "/plans";
144 |             const successDescription = wasSetupComplete
145 |                 ? "Your profile has been updated successfully."
146 |                 : "Profile saved! Let's choose a plan.";
147 | 
148 |             toast({
149 |                 title: "Profile Updated!",
150 |                 description: successDescription,
151 |             });
152 |             
153 |             navigate(nextPath);
154 | 
155 |         } catch (error) {
156 |             console.error("Error saving profile:", error);
157 |             toast({
158 |                 title: "Save Error",
159 |                 description: "An error occurred while saving your profile.",
160 |                 variant: "destructive",
161 |             });
162 |         } finally {
163 |             setIsSaving(false);
164 |         }
165 |     };
166 | 
167 |     const selectedLang = languages.find(l => l.value === language);
168 | 
169 |     return (
170 |         <PageTransition>
171 |             <div
172 |                 className="min-h-screen flex flex-col items-center justify-start relative"
173 |                 style={{ backgroundColor: 'black' }}
174 |             >
175 |                 <div className="container mx-auto px-4 py-8 max-w-2xl">
176 |                     <BackButton className="absolute top-8 left-4 md:left-8" />
177 | 
178 |                     {/* Header */}
179 |                     <motion.div
180 |                         initial={{ opacity: 0, y: -10 }}
181 |                         animate={{ opacity: 1, y: 0 }}
182 |                         transition={{ duration: 0.5 }}
183 |                         className="pt-16 text-center mb-8"
184 |                     >
185 |                         <div className="inline-flex justify-center items-center w-16 h-16 rounded-full bg-[#A5D6F6]/80 border border-[#A5D6F6]/50 mb-4 shadow-lg">
186 |                             <User className="h-8 w-8 text-white" />
187 |                         </div>
188 |                         <h1 className="text-3xl font-bold mb-2 font-heading text-[#BB79D1]">Configure Your Profile</h1>
189 |                         <p className="text-[#222] text-md max-w-md mx-auto font-medium bg-white/60 rounded-xl px-4 py-2 shadow-sm">
190 |                             Personalize your experience for tailored adult content
191 |                         </p>
192 |                     </motion.div>
193 | 
194 |                     {isLoading && (
195 |                         <div className="flex justify-center py-12">
196 |                             <div className="rounded-full h-12 w-12 border-4 border-[#A5D6F6] border-t-transparent animate-spin"></div>
197 |                         </div>
198 |                     )}
199 | 
200 |                     {!isLoading && currentUser && (
201 |                         <motion.form
202 |                             initial={{ opacity: 0, y: 20 }}
203 |                             animate={{ opacity: 1, y: 0 }}
204 |                             transition={{ duration: 0.5, delay: 0.1 }}
205 |                             onSubmit={handleSubmit}
206 |                             className="space-y-8 bg-white/40 backdrop-blur-md rounded-3xl border border-[#BB79D1]/20 shadow-xl p-6"
207 |                         >
208 |                             {/* Language Select */}
209 |                             <div className="space-y-2">
210 |                                 <label htmlFor="language" className="flex items-center gap-2 text-lg font-medium mb-2 font-heading text-[#222]">
211 |                                     <div className="w-8 h-8 rounded-full bg-[#A5D6F6]/20 flex items-center justify-center">
212 |                                         <Globe className="h-4 w-4 text-[#A5D6F6]" />
213 |                                     </div>
214 |                                     <span>Story Language</span>
215 |                                 </label>
216 | 
217 |                                 <Select value={language} onValueChange={setLanguage}>
218 |                                     <SelectTrigger className="w-full bg-white/10 border-[#A5D6F6]/30 backdrop-blur-sm text-[#222] hover:bg-white/20 transition-colors h-12">
219 |                                         {selectedLang ? (
220 |                                             <div className="flex items-center">
221 |                                                 <span role="img" aria-label={selectedLang.label} className="mr-2">{selectedLang.flag}</span>
222 |                                                 {selectedLang.label}
223 |                                             </div>
224 |                                         ) : (
225 |                                             <SelectValue placeholder="Select a language..." />
226 |                                         )}
227 |                                     </SelectTrigger>
228 |                                     <SelectContent className="bg-white border-[#BB79D1]/40 shadow-xl rounded-2xl text-[#222]">
229 |                                         {languages.map((lang) => (
230 |                                             <SelectItem key={lang.value} value={lang.value} className="text-[#222] focus:bg-[#BB79D1]/20 focus:text-[#222]">
231 |                                                 <span className="flex items-center gap-3">
232 |                                                     <span className="text-xl inline-block min-w-[1.5rem]">{lang.flag}</span>
233 |                                                     <span>{lang.label}</span>
234 |                                                 </span>
235 |                                             </SelectItem>
236 |                                         ))}
237 |                                     </SelectContent>
238 |                                 </Select>
239 |                             </div>
240 | 
241 |                             {/* Preferences Text Area */}
242 |                             <div className="space-y-2 pt-2">
243 |                                 <label htmlFor="preferences" className="flex items-center gap-2 text-lg font-medium mb-2 font-heading text-[#222]">
244 |                                     <div className="w-8 h-8 rounded-full bg-[#F6A5B7]/20 flex items-center justify-center">
245 |                                         <Heart className="h-4 w-4 text-[#F6A5B7]" />
246 |                                     </div>
247 |                                     <span>Your Preferences & Interests</span>
248 |                                 </label>
249 | 
250 |                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl border border-white/20 p-4">
251 |                                     <Textarea
252 |                                         id="preferences"
253 |                                         placeholder="Describe your interests, preferences, kinks, fetishes, or specific themes you enjoy in adult content. This will help personalize your stories. (Optional but recommended for better personalization)"
254 |                                         value={preferences}
255 |                                         onChange={(e) => setPreferences(e.target.value)}
256 |                                         className="bg-transparent border-none resize-none focus:ring-0 text-[#222] placeholder:text-[#222]/60 min-h-[120px]"
257 |                                         maxLength={1000}
258 |                                     />
259 |                                     <div className="text-xs text-[#7DC4E0] mt-2">
260 |                                         {preferences.length}/1000 characters
261 |                                     </div>
262 |                                 </div>
263 |                             </div>
264 | 
265 |                             {/* Save Button */}
266 |                             <motion.button
267 |                                 whileHover={{ scale: 1.02 }}
268 |                                 whileTap={{ scale: 0.98 }}
269 |                                 type="submit"
270 |                                 disabled={isSaving || isLoading}
271 |                                 className={`w-full mt-6 py-4 px-6 rounded-xl font-medium flex items-center justify-center gap-2 shadow-lg transition-all ${
272 |                                     (isSaving || isLoading)
273 |                                         ? 'bg-gray-400/30 border-gray-400/30 text-gray-500 cursor-not-allowed'
274 |                                         : 'bg-[#BB79D1]/30 border border-[#BB79D1]/30 hover:bg-[#BB79D1]/40 text-[#222]'
275 |                                 }`}
276 |                             >
277 |                                 {isSaving ? (
278 |                                     <div className="h-5 w-5 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin mr-2"></div>
279 |                                 ) : (
280 |                                     <Check className="h-5 w-5 text-[#BB79D1]" />
281 |                                 )}
282 |                                 <span>{isSaving ? "Saving..." : "Save Profile"}</span>
283 |                             </motion.button>
284 |                         </motion.form>
285 |                     )}
286 |                 </div>
287 |             </div>
288 |         </PageTransition>
289 |     );
290 | };
291 | 
292 | export default ProfileConfigPage;
```

src/pages/SavedStories.tsx
```
1 | import { useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { Book, Calendar, ChevronDown, ChevronRight, Bookmark, User, Clock, SortAsc, SortDesc, Filter } from "lucide-react";
4 | import { motion, AnimatePresence } from "framer-motion";
5 | import { useStoriesStore } from "../store/stories/storiesStore";
6 | import { useChaptersStore } from "../store/stories/chapters/chaptersStore";
7 | import BackButton from "../components/BackButton";
8 | import PageTransition from "../components/PageTransition";
9 | import { StoryWithChapters } from "../types";
10 | 
11 | export default function SavedStories() {
12 |   const navigate = useNavigate();
13 |   const { generatedStories } = useStoriesStore();
14 |   const { getChaptersByStoryId } = useChaptersStore();
15 |   const [expandedStories, setExpandedStories] = useState<{[key: string]: boolean}>({});
16 |   const [sortOrder, setSortOrder] = useState<'newest' | 'oldest'>('newest');
17 |   
18 |   const formatDate = (dateString: string) => {
19 |     const date = new Date(dateString);
20 |     return new Intl.DateTimeFormat('es-ES', { 
21 |       year: 'numeric', 
22 |       month: 'short', 
23 |       day: 'numeric' 
24 |     }).format(date);
25 |   };
26 |   
27 |   const container = {
28 |     hidden: { opacity: 0 },
29 |     show: {
30 |       opacity: 1,
31 |       transition: {
32 |         staggerChildren: 0.1
33 |       }
34 |     }
35 |   };
36 |   
37 |   const item = {
38 |     hidden: { y: 20, opacity: 0 },
39 |     show: { y: 0, opacity: 1 }
40 |   };
41 | 
42 |   const toggleExpand = (storyId: string) => {
43 |     setExpandedStories(prev => ({
44 |       ...prev,
45 |       [storyId]: !prev[storyId]
46 |     }));
47 |   };
48 | 
49 |   const toggleSortOrder = () => {
50 |     setSortOrder(prev => prev === 'newest' ? 'oldest' : 'newest');
51 |   };
52 | 
53 |   // Group stories that have chapters
54 |   const storiesWithChaptersInfo = generatedStories.map(story => {
55 |     const chapters = getChaptersByStoryId(story.id);
56 |     return {
57 |       ...story,
58 |       hasMultipleChapters: chapters.length > 1,
59 |       chaptersCount: chapters.length,
60 |       chapters
61 |     } as StoryWithChapters;
62 |   });
63 |   
64 |   // Sort stories based on sort order
65 |   const sortedStories = [...storiesWithChaptersInfo].sort((a, b) => {
66 |     const dateA = new Date(a.createdAt).getTime();
67 |     const dateB = new Date(b.createdAt).getTime();
68 |     return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
69 |   });
70 |   
71 |   return (
72 |     <PageTransition>
73 |       <div
74 |         className="min-h-screen flex flex-col items-center justify-center relative"
75 |         style={{
76 |           backgroundColor: 'black',
77 |         }}
78 |       >
79 |         <BackButton />
80 |         
81 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
82 |           <h1 className="text-3xl font-bold text-[#BB79D1] text-center mb-4 font-heading drop-shadow-lg">
83 |             Mis Historias
84 |           </h1>
85 |           
86 |           {storiesWithChaptersInfo.length > 0 && (
87 |             <div 
88 |               className="flex justify-center mb-6 bg-white/70 rounded-xl p-1 max-w-xs mx-auto shadow-md"
89 |               onClick={toggleSortOrder}
90 |             >
91 |               <button className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${sortOrder === 'newest' ? 'bg-[#BB79D1] text-white shadow-md' : 'hover:bg-white/80 text-[#222]'}`}>
92 |                 <SortDesc size={16} />
93 |                 <span>Más recientes</span>
94 |               </button>
95 |               <button className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${sortOrder === 'oldest' ? 'bg-[#BB79D1] text-white shadow-md' : 'hover:bg-white/80 text-[#222]'}`}>
96 |                 <SortAsc size={16} />
97 |                 <span>Más antiguas</span>
98 |               </button>
99 |             </div>
100 |           )}
101 |           
102 |           {sortedStories.length === 0 ? (
103 |             <div className="text-center bg-white/70 rounded-xl p-6 shadow-md">
104 |               <p className="text-[#222] font-medium">No tienes historias guardadas.</p>
105 |             </div>
106 |           ) : (
107 |             <motion.div
108 |               variants={container}
109 |               initial="hidden"
110 |               animate="show"
111 |               className="space-y-4"
112 |             >
113 |               {sortedStories.map((story) => (
114 |                 <motion.div
115 |                   key={story.id}
116 |                   variants={item}
117 |                   className="bg-white/80 rounded-xl overflow-hidden shadow-md"
118 |                 >
119 |                   <div 
120 |                     className="story-card p-4 cursor-pointer hover:bg-white/90 transition-all"
121 |                     onClick={() => story.hasMultipleChapters 
122 |                       ? toggleExpand(story.id) 
123 |                       : navigate(`/story/${story.id}`)}
124 |                   >
125 |                     <div className="flex items-center">
126 |                       <div className="w-12 h-12 rounded-full bg-[#F6A5B7]/20 flex items-center justify-center mr-4 shrink-0 border-2 border-[#F6A5B7]/40">
127 |                         <Book size={20} className="text-[#F6A5B7]" />
128 |                       </div>
129 |                       <div className="flex-1 min-w-0">
130 |                         <h3 className="text-[#222] font-semibold text-lg truncate">{story.title}</h3>
131 |                         <div className="flex items-center text-[#555] text-sm">
132 |                           <Calendar size={14} className="mr-1 shrink-0" />
133 |                           <span className="mr-3">{formatDate(story.createdAt)}</span>
134 |                           {story.hasMultipleChapters && (
135 |                             <span className="text-[#BB79D1] flex items-center">
136 |                               <Bookmark size={14} className="mr-1" />
137 |                               {story.chaptersCount} capítulos
138 |                             </span>
139 |                           )}
140 |                         </div>
141 |                       </div>
142 |                       {story.hasMultipleChapters && (
143 |                         <div className="ml-2">
144 |                           {expandedStories[story.id] ? (
145 |                             <ChevronDown size={20} className="text-[#BB79D1]" />
146 |                           ) : (
147 |                             <ChevronRight size={20} className="text-[#BB79D1]" />
148 |                           )}
149 |                         </div>
150 |                       )}
151 |                     </div>
152 |                     
153 |                     {/* Character info */}
154 |                     <div className="mt-3 pt-3 border-t border-[#BB79D1]/10 flex items-center">
155 |                       <div className="bg-[#7DC4E0]/20 h-8 w-8 rounded-full flex items-center justify-center mr-2 border border-[#7DC4E0]/40">
156 |                         <User size={14} className="text-[#7DC4E0]" />
157 |                       </div>
158 |                       <div className="text-[#222] text-sm flex-1">
159 |                         <span className="font-medium">
160 |                           {story.options.characters?.map(char => char.name).join(', ') || "Sin personajes"}
161 |                         </span>
162 |                         {story.options.characters && story.options.characters.length > 0 && story.options.characters[0].profession && (
163 |                           <span className="ml-2 text-[#555]">• {story.options.characters[0].profession}</span>
164 |                         )}
165 |                       </div>
166 |                       <div className="flex gap-2">
167 |                         {story.options.genre && (
168 |                           <div className="px-2 py-1 text-xs rounded-full bg-[#BB79D1]/10 text-[#BB79D1] border border-[#BB79D1]/30">
169 |                             {story.options.genre}
170 |                           </div>
171 |                         )}
172 |                         <div className="px-2 py-1 text-xs rounded-full bg-[#F9DA60]/20 text-[#222] border border-[#F9DA60]/40 flex items-center gap-1">
173 |                           <Clock size={11} className="text-[#F9DA60]" />
174 |                           {story.options.format === 'single' ? 'Complete' : 'Chapters'}
175 |                         </div>
176 |                       </div>
177 |                     </div>
178 |                   </div>
179 |                   
180 |                   {/* Chapters list for expanded stories */}
181 |                   <AnimatePresence>
182 |                     {story.hasMultipleChapters && expandedStories[story.id] && (
183 |                       <motion.div
184 |                         initial={{ height: 0, opacity: 0 }}
185 |                         animate={{ height: "auto", opacity: 1 }}
186 |                         exit={{ height: 0, opacity: 0 }}
187 |                         transition={{ duration: 0.3 }}
188 |                         className="overflow-hidden"
189 |                       >
190 |                         <div className="bg-[#F6A5B7]/5 border-t border-[#F6A5B7]/10">
191 |                           {story.chapters.map((chapter, index) => (
192 |                             <div 
193 |                               key={`${story.id}-chapter-${index}`}
194 |                               className="px-4 py-3 border-b border-[#F6A5B7]/5 last:border-b-0 hover:bg-[#F6A5B7]/10 cursor-pointer"
195 |                               onClick={() => navigate(`/story/${story.id}?chapter=${index}`)}
196 |                             >
197 |                               <div className="flex items-center">
198 |                                 <div className="w-8 h-8 rounded-full bg-[#BB79D1]/20 flex items-center justify-center mr-3 shrink-0 border border-[#BB79D1]/30">
199 |                                   <span className="text-sm text-[#BB79D1] font-medium">
200 |                                     {index + 1}
201 |                                   </span>
202 |                                 </div>
203 |                                 <div>
204 |                                   <h4 className="text-[#222] font-medium">
205 |                                     {chapter.title || `Capítulo ${index + 1}`}
206 |                                   </h4>
207 |                                   <span className="text-[#555] text-xs">
208 |                                     {formatDate(chapter.createdAt)}
209 |                                   </span>
210 |                                 </div>
211 |                               </div>
212 |                             </div>
213 |                           ))}
214 |                         </div>
215 |                       </motion.div>
216 |                     )}
217 |                   </AnimatePresence>
218 |                 </motion.div>
219 |               ))}
220 |             </motion.div>
221 |           )}
222 |         </div>
223 |       </div>
224 |     </PageTransition>
225 |   );
226 | }
```

src/pages/SettingsPage.tsx
```
1 | import React, { useState } from 'react';
2 | import { useNavigate, Link } from 'react-router-dom';
3 | import { useUserStore } from '@/store/user/userStore'; // Adjust path if needed
4 | import { supabase } from '@/supabaseClient'; // Adjust path if needed
5 | import { useToast } from '@/hooks/use-toast'; // Adjust path if needed
6 | import PageTransition from '@/components/PageTransition'; // Adjust path if needed
7 | import BackButton from '@/components/BackButton';
8 | import { motion } from 'framer-motion';
9 | import {
10 |     Settings,
11 |     User,
12 |     CreditCard,
13 |     LogOut,
14 |     BookOpen,
15 |     CalendarClock,
16 |     AlertTriangle,
17 |     Star,
18 |     ChevronRight,
19 |     Mail,
20 |     Mic,
21 |     Euro
22 | } from 'lucide-react';
23 | 
24 | const SettingsPage: React.FC = () => {
25 |     const navigate = useNavigate();
26 |     const { toast } = useToast();
27 |     const { user, profileSettings, logoutUser, isPremium } = useUserStore(
28 |         (state) => ({
29 |             user: state.user,
30 |             profileSettings: state.profileSettings,
31 |             logoutUser: state.logoutUser,
32 |             isPremium: state.isPremium, // Assuming isPremium selector exists
33 |         })
34 |     );
35 | 
36 |     const [isPortalLoading, setIsPortalLoading] = useState(false);
37 |     const [isLogoutLoading, setIsLogoutLoading] = useState(false);
38 |     const [isCheckoutLoading, setIsCheckoutLoading] = useState(false);
39 | 
40 |     // --- Voice Credits Constants ---
41 |     const PREMIUM_MONTHLY_VOICE_ALLOWANCE = 20; // O usa el valor correcto si es diferente
42 |     const VOICE_CREDITS_PACKAGE_AMOUNT = 20; // O usa el valor correcto si es diferente
43 |     const VOICE_CREDITS_PACKAGE_PRICE_EUR = 10; // O usa el valor correcto si es diferente
44 | 
45 |     const handleLogout = async () => {
46 |         setIsLogoutLoading(true);
47 |         try {
48 |             await logoutUser();
49 |             // logoutUser should handle redirect internally, but navigate as a fallback
50 |             navigate('/');
51 |             toast({ title: 'Sesión cerrada', description: 'Has cerrado sesión correctamente.' });
52 |         } catch (error) {
53 |             console.error("Error during logout:", error);
54 |             toast({ title: 'Error', description: 'No se pudo cerrar sesión.', variant: 'destructive' });
55 |             setIsLogoutLoading(false);
56 |         }
57 |     };
58 | 
59 |     const handleCheckout = async (item: 'premium' | 'credits') => {
60 |         setIsCheckoutLoading(true);
61 |         try {
62 |             const { data, error } = await supabase.functions.invoke('create-checkout-session', {
63 |                 body: JSON.stringify({ item }),
64 |             });
65 | 
66 |             if (error) throw error;
67 | 
68 |             if (data?.url) {
69 |                 window.location.href = data.url;
70 |             } else {
71 |                 throw new Error('No se recibió URL de checkout.');
72 |             }
73 |         } catch (error: any) {
74 |             console.error(`Error creating ${item} checkout session:`, error);
75 |             toast({ title: 'Error', description: `No se pudo iniciar el pago: ${error.message}`, variant: 'destructive' });
76 |             setIsCheckoutLoading(false);
77 |         }
78 |     };
79 | 
80 |     const handleManageSubscription = async () => {
81 |         if (!profileSettings?.stripe_customer_id) {
82 |             toast({ title: 'Error', description: 'No se encontró información de cliente para gestionar la suscripción.', variant: 'destructive' });
83 |             return;
84 |         }
85 | 
86 |         setIsPortalLoading(true);
87 |         try {
88 |             const { data, error } = await supabase.functions.invoke('create-customer-portal-session');
89 | 
90 |             if (error) throw error;
91 | 
92 |             if (data?.url) {
93 |                 window.location.href = data.url;
94 |             } else {
95 |                 throw new Error('No se recibió URL del portal de cliente.');
96 |             }
97 |         } catch (error: any) {
98 |             console.error("Error creating customer portal session:", error);
99 |             toast({ title: 'Error', description: `No se pudo redirigir a la gestión de suscripción: ${error.message}`, variant: 'destructive' });
100 |             setIsPortalLoading(false);
101 |         } // No finally block needed for isLoading as page redirects on success
102 |     };
103 | 
104 |     if (!user || !profileSettings) {
105 |         // Optional: Show a loading state or redirect if data isn't ready
106 |         return (
107 |             <PageTransition>
108 |                 <div className="min-h-screen gradient-bg flex justify-center items-center p-6">
109 |                     <div className="rounded-full h-12 w-12 border-4 border-brand-blue border-t-transparent animate-spin"></div>
110 |                 </div>
111 |             </PageTransition>
112 |         );
113 |     }
114 | 
115 |     const premiumUser = isPremium(); // Call the selector
116 | 
117 |     // --- Calculate Reset Date String --- BEGIN
118 |     let resetDateString = "Fecha no disponible"; // Default
119 | 
120 |     if (premiumUser) {
121 |         // Premium: Use current_period_end
122 |         const endDateISO = profileSettings?.current_period_end;
123 |         if (endDateISO) {
124 |             try {
125 |                 const endDate = new Date(endDateISO);
126 |                 resetDateString = new Intl.DateTimeFormat('es-ES', {
127 |                     day: 'numeric',
128 |                     month: 'long',
129 |                     // year: 'numeric' // Optional: add year if needed
130 |                 }).format(endDate);
131 |                 resetDateString = `el ${resetDateString}`;
132 |             } catch (e) {
133 |                 console.error("Error formateando current_period_end:", e);
134 |                 resetDateString = "Error al formatear fecha";
135 |             }
136 |         } else {
137 |             console.warn("Usuario premium sin current_period_end en profileSettings.");
138 |             resetDateString = "en el próximo ciclo de facturación";
139 |         }
140 |     } else {
141 |         // Free: Static message
142 |         resetDateString = "el día 1 del próximo mes";
143 |     }
144 |     // --- Calculate Reset Date String --- END
145 | 
146 |     return (
147 |         <PageTransition>
148 |             <div
149 |                 className="min-h-screen flex flex-col items-center justify-start bg-[#FFF6FA] relative"
150 |                 style={{
151 |                     backgroundColor: 'black',
152 |                 }}
153 |             >
154 |                 {/* Logo centrado arriba */}
155 |                 <div className="flex flex-col items-center mt-6 mb-2 select-none">
156 |                     <img src="/logo_fantasia.png" alt="Fantasia Logo" className="w-48 max-w-xs mx-auto mb-2 drop-shadow-xl" />
157 |                 </div>
158 |                 <div className="container mx-auto px-4 py-2 max-w-2xl">
159 |                     {/* Back button */}
160 |                     <BackButton className="absolute top-8 left-4 md:left-8" />
161 | 
162 |                     {/* Header */}
163 |                     <motion.div
164 |                         initial={{ opacity: 0, y: -10 }}
165 |                         animate={{ opacity: 1, y: 0 }}
166 |                         transition={{ duration: 0.5 }}
167 |                         className="text-center mb-6"
168 |                     >
169 |                         <div className="inline-flex justify-center items-center w-16 h-16 rounded-full bg-[#BB79D1]/80 border border-[#BB79D1]/50 mb-2 shadow-lg">
170 |                             <Settings className="h-8 w-8 text-white" />
171 |                         </div>
172 |                         <h1 className="text-3xl font-bold font-heading text-[#BB79D1]">Ajustes</h1>
173 |                     </motion.div>
174 | 
175 |                     {/* Account Section */}
176 |                     <motion.div
177 |                         initial={{ opacity: 0, y: 20 }}
178 |                         animate={{ opacity: 1, y: 0 }}
179 |                         transition={{ duration: 0.5, delay: 0.1 }}
180 |                         className="bg-white/40 backdrop-blur-md rounded-3xl border border-[#BB79D1]/20 shadow-xl overflow-hidden mb-5"
181 |                     >
182 |                         <div className="p-5 border-b border-[#BB79D1]/10 flex items-center gap-3">
183 |                             <div className="w-10 h-10 rounded-full bg-[#A5D6F6]/20 flex items-center justify-center">
184 |                                 <User className="h-5 w-5 text-[#A5D6F6]" />
185 |                             </div>
186 |                             <h2 className="text-xl font-semibold font-heading text-[#BB79D1]">Cuenta</h2>
187 |                         </div>
188 |                         <div className="p-5">
189 |                             <div className="flex items-center p-2">
190 |                                 <Mail className="h-5 w-5 text-[#BB79D1]/80 mr-3" />
191 |                                 <div className="flex-1">
192 |                                     <div className="text-sm text-[#BB79D1]/80 mb-1">Email</div>
193 |                                     <div className="font-medium text-[#BB79D1]">{user.email}</div>
194 |                                 </div>
195 |                             </div>
196 |                         </div>
197 |                     </motion.div>
198 | 
199 |                     {/* Plan & Billing Section */}
200 |                     <motion.div
201 |                         initial={{ opacity: 0, y: 20 }}
202 |                         animate={{ opacity: 1, y: 0 }}
203 |                         transition={{ duration: 0.5, delay: 0.2 }}
204 |                         className="bg-white/40 backdrop-blur-md rounded-3xl border border-[#F9DA60]/20 shadow-xl overflow-hidden mb-5"
205 |                     >
206 |                         <div className="p-5 border-b border-[#F9DA60]/10 flex items-center gap-3">
207 |                             <div className="w-10 h-10 rounded-full bg-[#F9DA60]/20 flex items-center justify-center">
208 |                                 <CreditCard className="h-5 w-5 text-[#F9DA60]" />
209 |                             </div>
210 |                             <h2 className="text-xl font-semibold font-heading text-[#BB79D1]">Plan y Facturación</h2>
211 |                         </div>
212 |                         <div className="p-5">
213 |                             <div className="flex items-center justify-between p-2 border-b border-[#BB79D1]/10 pb-4 mb-4">
214 |                                 <div className="flex items-center">
215 |                                     <div className="text-md text-[#BB79D1]">Plan Actual:</div>
216 |                                 </div>
217 |                                 <div className={`px-3 py-1 rounded-full font-semibold text-sm ${premiumUser
218 |                                     ? 'bg-gradient-to-r from-[#F9DA60]/30 to-[#F9DA60]/40 text-[#BB79D1] border border-[#F9DA60]/30'
219 |                                     : 'bg-[#BB79D1]/20 text-[#BB79D1] border border-[#BB79D1]/30'
220 |                                     }`}>
221 |                                     {premiumUser ? 'Premium' : 'Free'}
222 |                                 </div>
223 |                             </div>
224 | 
225 |                             {/* Free User Content */}
226 |                             {!premiumUser && (
227 |                                 <div className="space-y-5">
228 |                                     {/* Story Limits */}
229 |                                     <div className="bg-white/70 rounded-2xl p-4 mb-2 border border-[#BB79D1]/30 shadow-sm">
230 |                                         <div className="flex items-center gap-3 mb-2">
231 |                                             <div className="w-10 h-10 rounded-full bg-[#BB79D1]/20 flex items-center justify-center">
232 |                                                 <BookOpen className="h-5 w-5 text-[#BB79D1]" />
233 |                                             </div>
234 |                                             <div>
235 |                                                 <h3 className="font-bold text-lg text-[#222]">Historias restantes este mes</h3>
236 |                                                 <p className="text-[#7DC4E0] text-sm">Cuentos que puedes crear</p>
237 |                                             </div>
238 |                                         </div>
239 |                                         <div className="flex justify-between items-center mb-2 px-2">
240 |                                             <span className="text-[#222] font-medium">Disponibles:</span>
241 |                                             <span className="font-mono font-bold text-xl text-[#F6A5B7]">{profileSettings.monthly_stories_generated !== undefined ? Math.max(0, 10 - profileSettings.monthly_stories_generated) : 'N/A'}</span>
242 |                                         </div>
243 |                                         <div className="text-sm text-white mt-3 flex items-center bg-[#F6A5B7] p-2 rounded-lg">
244 |                                             <CalendarClock className="h-4 w-4 mr-2 text-white" />
245 |                                             <span>El límite se reiniciará a 10 historias {resetDateString}</span>
246 |                                         </div>
247 |                                     </div>
248 | 
249 |                                     {/* Voice Credits */}
250 |                                     <div className="bg-white/70 rounded-2xl p-4 border border-[#A5D6F6]/30 shadow-sm">
251 |                                         <div className="flex items-center gap-3 mb-2">
252 |                                             <div className="w-10 h-10 rounded-full bg-[#A5D6F6]/20 flex items-center justify-center">
253 |                                                 <Mic className="h-5 w-5 text-[#A5D6F6]" />
254 |                                             </div>
255 |                                             <div>
256 |                                                 <h3 className="font-bold text-lg text-[#222]">Créditos de voz disponibles</h3>
257 |                                                 <p className="text-[#7DC4E0] text-sm">Para narrar tus cuentos</p>
258 |                                             </div>
259 |                                         </div>
260 |                                         <div className="flex justify-between items-center mb-2 px-2">
261 |                                             <span className="text-[#222] font-medium">Disponibles:</span>
262 |                                             <span className="font-mono font-bold text-xl text-[#A5D6F6]">{profileSettings.voice_credits || 0}</span>
263 |                                         </div>
264 | 
265 |                                         {/* Botón Comprar Créditos Voz (Free user) */}
266 |                                         <button
267 |                                             onClick={() => handleCheckout('credits')}
268 |                                             // disabled={isCheckoutLoading || isPortalLoading}
269 |                                             disabled={true}
270 |                                             className="flex items-center justify-between w-full py-3 px-4 mt-3 bg-[#A5D6F6]/40 rounded-xl shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
271 |                                         >
272 |                                             <div className="flex items-center gap-2 text-[#BB79D1] font-bold">
273 |                                                 <CreditCard className="h-4 w-4" />
274 |                                                 <span>Comprar 20 créditos más por 10€</span>
275 |                                             </div>
276 |                                             {isCheckoutLoading ? (
277 |                                                 <div className="h-4 w-4 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin"></div>
278 |                                             ) : (
279 |                                                 <ChevronRight className="h-4 w-4 text-white" />
280 |                                             )}
281 |                                         </button>
282 |                                     </div>
283 | 
284 |                                     {/* Botón Ver Planes */}
285 |                                     <div className="border-t border-[#BB79D1]/10 pt-4">
286 |                                         <Link
287 |                                             to="/plans?tab=premium"
288 |                                             className="flex items-center justify-between w-full py-3 px-4 bg-[#f7c59f]/40 border border-[#f7c59f]/30 hover:bg-[#f7c59f]/60 text-white rounded-2xl font-bold transition-all shadow-md hover:shadow-lg"
289 |                                         >
290 |                                             <div className="flex items-center gap-2">
291 |                                                 <Star className="h-4 w-4" />
292 |                                                 <span>Ver Plan Premium</span>
293 |                                             </div>
294 |                                             <ChevronRight className="h-4 w-4" />
295 |                                         </Link>
296 |                                     </div>
297 |                                 </div>
298 |                             )}
299 | 
300 |                             {/* Premium User Content */}
301 |                             {premiumUser && (
302 |                                 <div className="space-y-5">
303 |                                     {/* Voice Credits Section Separada */}
304 |                                     <div className="bg-white/70 rounded-2xl p-4 border border-[#A5D6F6]/30 shadow-sm">
305 |                                         <div className="flex items-center gap-3 mb-2">
306 |                                             <div className="w-10 h-10 rounded-full bg-[#A5D6F6]/20 flex items-center justify-center">
307 |                                                 <Mic className="h-5 w-5 text-[#A5D6F6]" />
308 |                                             </div>
309 |                                             <div>
310 |                                                 <h3 className="font-bold text-lg text-[#222]">Créditos de voz disponibles</h3>
311 |                                                 <p className="text-[#7DC4E0] text-sm">Para narrar tus cuentos</p>
312 |                                             </div>
313 |                                         </div>
314 |                                         {/* Créditos del plan mensual */}
315 |                                         <div className="flex justify-between items-center px-2">
316 |                                             <span className="text-[#222] font-medium">Del plan este mes:</span>
317 |                                             <span className="font-mono font-bold text-lg text-[#A5D6F6]">
318 |                                                 {profileSettings.monthly_voice_generations_used !== undefined
319 |                                                     ? Math.max(0, PREMIUM_MONTHLY_VOICE_ALLOWANCE - profileSettings.monthly_voice_generations_used)
320 |                                                     : 'N/A'}
321 |                                                 {' / '}{PREMIUM_MONTHLY_VOICE_ALLOWANCE}
322 |                                             </span>
323 |                                         </div>
324 |                                         {/* Créditos comprados adicionales */}
325 |                                         <div className="flex justify-between items-center mt-1 px-2 pt-2 border-t border-[#A5D6F6]/20">
326 |                                             <span className="text-[#222] font-medium">Adicionales comprados:</span>
327 |                                             <span className="font-mono font-bold text-lg text-[#A5D6F6]">
328 |                                                 {profileSettings.voice_credits ?? 0}
329 |                                             </span>
330 |                                         </div>
331 |                                         {/* Texto explicativo actualizado */}
332 |                                         <div className="text-sm text-white mt-3 flex items-center bg-[#A5D6F6] p-2 rounded-lg">
333 |                                             <CalendarClock className="h-4 w-4 mr-2 text-white" />
334 |                                             <span>Recibes {PREMIUM_MONTHLY_VOICE_ALLOWANCE} narraciones con tu plan cada mes (próximo reinicio {resetDateString}). Los créditos que compres se añaden a tu cuenta, no caducan, y se utilizan cuando agotes los de tu plan.</span>
335 |                                         </div>
336 |                                         {/* Botón Comprar Créditos Voz (Premium user) */}
337 |                                         <button
338 |                                             onClick={() => handleCheckout('credits')}
339 |                                             disabled={isCheckoutLoading}
340 |                                             className="flex items-center justify-between w-full py-3 px-4 mt-3 bg-[#A5D6F6]/40 rounded-xl shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
341 |                                         >
342 |                                             <div className="flex items-center gap-2 text-white font-bold">
343 |                                                 <CreditCard className="h-4 w-4" />
344 |                                                 <span>Comprar {VOICE_CREDITS_PACKAGE_AMOUNT} créditos más por {VOICE_CREDITS_PACKAGE_PRICE_EUR}€</span>
345 |                                             </div>
346 |                                             {isCheckoutLoading ? (
347 |                                                 <div className="h-4 w-4 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin"></div>
348 |                                             ) : (
349 |                                                 <ChevronRight className="h-4 w-4 text-white" />
350 |                                             )}
351 |                                         </button>
352 |                                     </div>
353 |                                     {/* Gestionar Suscripción (sin cambios) */}
354 |                                     {profileSettings.stripe_customer_id && (
355 |                                         <div className="border-t border-[#BB79D1]/10 pt-4">
356 |                                             <button
357 |                                                 onClick={handleManageSubscription}
358 |                                                 disabled={isPortalLoading}
359 |                                                 className="flex items-center justify-between w-full py-3 px-4 bg-[#f7c59f]/40 border border-[#f7c59f]/30 hover:bg-[#f7c59f]/60 text-white rounded-2xl font-bold transition-all shadow-md hover:shadow-lg"
360 |                                             >
361 |                                                 {isPortalLoading ? (
362 |                                                     <div className="h-5 w-5 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin"></div>
363 |                                                 ) : (
364 |                                                     <div className="flex items-center gap-2">
365 |                                                         <Settings className="h-4 w-4" />
366 |                                                         <span>Gestionar Suscripción</span>
367 |                                                     </div>
368 |                                                 )}
369 |                                                 <ChevronRight className="h-4 w-4" />
370 |                                             </button>
371 |                                         </div>
372 |                                     )}
373 |                                 </div>
374 |                             )}
375 |                         </div>
376 |                     </motion.div>
377 | 
378 |                     {/* General Section */}
379 |                     <motion.div
380 |                         initial={{ opacity: 0, y: 20 }}
381 |                         animate={{ opacity: 1, y: 0 }}
382 |                         transition={{ duration: 0.5, delay: 0.3 }}
383 |                         className="bg-white/40 backdrop-blur-md rounded-3xl border border-[#BB79D1]/20 shadow-xl overflow-hidden mb-10"
384 |                     >
385 |                         <div className="p-5 border-b border-[#BB79D1]/10 flex items-center gap-3">
386 |                             <div className="w-10 h-10 rounded-full bg-[#BB79D1]/20 flex items-center justify-center">
387 |                                 <Settings className="h-5 w-5 text-[#BB79D1]" />
388 |                             </div>
389 |                             <h2 className="text-xl font-semibold font-heading text-[#BB79D1]">General</h2>
390 |                         </div>
391 |                         <div className="p-5">
392 |                             <button
393 |                                 onClick={handleLogout}
394 |                                 disabled={isLogoutLoading}
395 |                                 className="flex items-center justify-center w-full py-3 px-4 bg-[#F6A5B7] hover:bg-[#BB79D1] text-white rounded-2xl font-bold gap-2 transition-colors shadow-md"
396 |                             >
397 |                                 {isLogoutLoading ? (
398 |                                     <div className="h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
399 |                                 ) : (
400 |                                     <>
401 |                                         <LogOut className="h-4 w-4" />
402 |                                         <span>Cerrar Sesión</span>
403 |                                     </>
404 |                                 )}
405 |                             </button>
406 |                         </div>
407 |                     </motion.div>
408 |                 </div>
409 |             </div>
410 |         </PageTransition>
411 |     );
412 | };
413 | 
414 | export default SettingsPage;
```

src/pages/Signup.tsx
```
1 | import { useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { Mail, Lock, Eye, EyeOff } from "lucide-react";
4 | import { Input } from "@/components/ui/input";
5 | import { Form, FormControl, FormField, FormItem, FormMessage } from "@/components/ui/form";
6 | import { useForm } from "react-hook-form";
7 | import StoryButton from "../components/StoryButton";
8 | import PageTransition from "../components/PageTransition";
9 | import { useToast } from "@/hooks/use-toast";
10 | import BackButton from "../components/BackButton";
11 | import { signUp, signInWithGoogle } from "../supabaseAuth";
12 | 
13 | export default function Signup() {
14 |   const navigate = useNavigate();
15 |   const { toast } = useToast();
16 |   const [showPassword, setShowPassword] = useState(false);
17 |   const [showConfirmPassword, setShowConfirmPassword] = useState(false);
18 |   const [isLoading, setIsLoading] = useState(false);
19 |   const [isGoogleLoading, setIsGoogleLoading] = useState(false);
20 | 
21 |   const form = useForm({
22 |     defaultValues: {
23 |       email: "",
24 |       password: "",
25 |       confirmPassword: ""
26 |     }
27 |   });
28 | 
29 |   const handleSignup = async (data: { email: string; password: string; confirmPassword: string }) => {
30 |     if (!data.email || !data.password || !data.confirmPassword) {
31 |       toast({
32 |         title: "Error en el registro",
33 |         description: "Por favor, completa todos los campos",
34 |         variant: "destructive"
35 |       });
36 |       return;
37 |     }
38 | 
39 |     if (data.password !== data.confirmPassword) {
40 |       toast({
41 |         title: "Error en el registro",
42 |         description: "Las contraseñas no coinciden",
43 |         variant: "destructive"
44 |       });
45 |       return;
46 |     }
47 | 
48 |     try {
49 |       setIsLoading(true);
50 |       const { user, error } = await signUp(data.email, data.password);
51 | 
52 |       if (error) {
53 |         toast({
54 |           title: "Error en el registro",
55 |           description: error.message,
56 |           variant: "destructive"
57 |         });
58 |         return;
59 |       }
60 | 
61 |       if (user) {
62 |         toast({
63 |           title: "Registro exitoso",
64 |           description: "¡Tu cuenta ha sido creada!",
65 |         });
66 |         // Redirigir a la página de login después de un registro exitoso
67 |         setTimeout(() => {
68 |           navigate("/signup-success");
69 |         }, 2000);
70 |       } else {
71 |         toast({
72 |           title: "Error en el registro",
73 |           description: "No se pudo crear la cuenta",
74 |           variant: "destructive"
75 |         });
76 |       }
77 |     } catch (err) {
78 |       toast({
79 |         title: "Error inesperado",
80 |         description: "Ha ocurrido un error inesperado",
81 |         variant: "destructive"
82 |       });
83 |       console.error(err);
84 |     } finally {
85 |       setIsLoading(false);
86 |     }
87 |   };
88 | 
89 |   const handleGoogleSignup = async () => {
90 |     try {
91 |       setIsGoogleLoading(true);
92 |       const { error } = await signInWithGoogle();
93 | 
94 |       if (error) {
95 |         toast({
96 |           title: "Error al registrarse con Google",
97 |           description: error.message,
98 |           variant: "destructive"
99 |         });
100 |       }
101 |     } catch (err) {
102 |       toast({
103 |         title: "Error inesperado",
104 |         description: "Ha ocurrido un error al registrarse con Google",
105 |         variant: "destructive"
106 |       });
107 |       console.error(err);
108 |     } finally {
109 |       setIsGoogleLoading(false);
110 |     }
111 |   };
112 | 
113 |   const togglePasswordVisibility = () => setShowPassword(!showPassword);
114 |   const toggleConfirmPasswordVisibility = () => setShowConfirmPassword(!showConfirmPassword);
115 | 
116 |   return (
117 |     <PageTransition>
118 |       <div
119 |         className="min-h-screen flex flex-col items-center justify-center p-6"
120 |         style={{
121 |           backgroundColor: 'black',
122 |         }}
123 |       >
124 |         <div className="absolute top-4 left-4 z-10">
125 |           <BackButton />
126 |         </div>
127 | 
128 |         <div className="w-full max-w-md bg-white/70 rounded-3xl p-8 shadow-lg border border-[#BB79D1]/20">
129 |           <div className="flex justify-center mb-6">
130 |             <img src="/logo_fantasia.png" alt="Fantasia Logo" className="w-48 max-w-full" />
131 |           </div>
132 | 
133 |           <h1 className="text-3xl font-bold text-[#222] mb-6 text-center">
134 |             Crear Cuenta
135 |           </h1>
136 | 
137 |           <Form {...form}>
138 |             <form
139 |               onSubmit={form.handleSubmit(handleSignup)}
140 |               className="space-y-5"
141 |             >
142 |               <FormField
143 |                 control={form.control}
144 |                 name="email"
145 |                 render={({ field }) => (
146 |                   <FormItem>
147 |                     <div className="relative">
148 |                       <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1]" size={20} />
149 |                       <FormControl>
150 |                         <Input
151 |                           placeholder="Correo electrónico"
152 |                           className="pl-10 py-6 rounded-xl bg-white/80 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-1 focus:ring-[#BB79D1] text-[#333]"
153 |                           type="email"
154 |                           {...field}
155 |                           required
156 |                         />
157 |                       </FormControl>
158 |                     </div>
159 |                     <FormMessage className="text-red-500" />
160 |                   </FormItem>
161 |                 )}
162 |               />
163 | 
164 |               <FormField
165 |                 control={form.control}
166 |                 name="password"
167 |                 render={({ field }) => (
168 |                   <FormItem>
169 |                     <div className="relative">
170 |                       <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1]" size={20} />
171 |                       <FormControl>
172 |                         <Input
173 |                           placeholder="Contraseña"
174 |                           className="pl-10 pr-10 py-6 rounded-xl bg-white/80 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-1 focus:ring-[#BB79D1] text-[#333]"
175 |                           type={showPassword ? "text" : "password"}
176 |                           {...field}
177 |                           required
178 |                         />
179 |                       </FormControl>
180 |                       <button
181 |                         type="button"
182 |                         onClick={togglePasswordVisibility}
183 |                         className="absolute right-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1] hover:text-[#A5D6F6] transition-colors"
184 |                       >
185 |                         {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
186 |                       </button>
187 |                     </div>
188 |                     <FormMessage className="text-red-500" />
189 |                   </FormItem>
190 |                 )}
191 |               />
192 | 
193 |               <FormField
194 |                 control={form.control}
195 |                 name="confirmPassword"
196 |                 render={({ field }) => (
197 |                   <FormItem>
198 |                     <div className="relative">
199 |                       <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1]" size={20} />
200 |                       <FormControl>
201 |                         <Input
202 |                           placeholder="Confirmar contraseña"
203 |                           className="pl-10 pr-10 py-6 rounded-xl bg-white/80 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-1 focus:ring-[#BB79D1] text-[#333]"
204 |                           type={showConfirmPassword ? "text" : "password"}
205 |                           {...field}
206 |                           required
207 |                         />
208 |                       </FormControl>
209 |                       <button
210 |                         type="button"
211 |                         onClick={toggleConfirmPasswordVisibility}
212 |                         className="absolute right-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1] hover:text-[#A5D6F6] transition-colors"
213 |                       >
214 |                         {showConfirmPassword ? <EyeOff size={20} /> : <Eye size={20} />}
215 |                       </button>
216 |                     </div>
217 |                     <FormMessage className="text-red-500" />
218 |                   </FormItem>
219 |                 )}
220 |               />
221 | 
222 |               <button
223 |                 type="submit"
224 |                 disabled={isLoading}
225 |                 className="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg transition-all duration-200 bg-[#F6A5B7] hover:bg-[#F6A5B7]/80 active:bg-[#F6A5B7]/90 disabled:opacity-60 disabled:cursor-not-allowed"
226 |               >
227 |                 {isLoading ? "Creando cuenta..." : "Crear Cuenta"}
228 |               </button>
229 | 
230 |               <div className="relative flex items-center my-4">
231 |                 <div className="flex-grow border-t border-[#BB79D1]/20"></div>
232 |                 <span className="mx-4 flex-shrink text-[#555] text-sm">O regístrate con</span>
233 |                 <div className="flex-grow border-t border-[#BB79D1]/20"></div>
234 |               </div>
235 | 
236 |               <button
237 |                 type="button"
238 |                 onClick={handleGoogleSignup}
239 |                 disabled={isGoogleLoading}
240 |                 className="w-full flex items-center justify-center gap-2 bg-white text-[#333] rounded-xl py-3 hover:bg-gray-100 transition-colors duration-300 border border-[#BB79D1]/20 shadow-md"
241 |               >
242 |                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px">
243 |                   <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" />
244 |                   <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" />
245 |                   <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" />
246 |                   <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z" />
247 |                 </svg>
248 |                 {isGoogleLoading ? "Conectando..." : "Registrarse con Google"}
249 |               </button>
250 | 
251 |               <div className="text-center mt-5">
252 |                 <span className="text-[#555] text-sm">¿Ya tienes una cuenta? </span>
253 |                 <button
254 |                   type="button"
255 |                   onClick={() => navigate("/login")}
256 |                   className="text-[#BB79D1] font-semibold text-sm hover:underline"
257 |                 >
258 |                   Iniciar Sesión
259 |                 </button>
260 |               </div>
261 |             </form>
262 |           </Form>
263 |         </div>
264 |       </div>
265 |     </PageTransition>
266 |   );
267 | }
```

src/pages/SignupSuccess.tsx
```
1 | import { useNavigate } from "react-router-dom";
2 | import { CheckCircle } from "lucide-react";
3 | import PageTransition from "../components/PageTransition";
4 | import StoryButton from "../components/StoryButton";
5 | 
6 | export default function SignupSuccess() {
7 |   const navigate = useNavigate();
8 | 
9 |   return (
10 |     <PageTransition>
11 |       <div
12 |         className="min-h-screen flex flex-col items-center justify-center p-6"
13 |         style={{
14 |           backgroundColor: 'black',
15 |         }}
16 |       >
17 |         <div className="w-full max-w-md bg-white/70 rounded-3xl p-8 shadow-lg border border-[#BB79D1]/20 flex flex-col items-center">
18 |           <div className="flex justify-center mb-6">
19 |             <img src="/logo_fantasia.png" alt="Fantasia Logo" className="w-48 max-w-full" />
20 |           </div>
21 | 
22 |           <CheckCircle className="h-24 w-24 text-[#BB79D1] mb-4" />
23 | 
24 |           <h1 className="text-3xl font-bold text-[#222] mb-4 text-center">
25 |             ¡Registro Exitoso!
26 |           </h1>
27 | 
28 |           <p className="text-[#555] text-center mb-8">
29 |             Tu cuenta ha sido creada correctamente. Por favor, revisa tu correo electrónico para confirmar tu registro.
30 |           </p>
31 | 
32 |           <div className="w-full max-w-xs">
33 |             <button
34 |               onClick={() => navigate("/login")}
35 |               className="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg transition-all duration-200 bg-[#F6A5B7] hover:bg-[#F6A5B7]/80 active:bg-[#F6A5B7]/90"
36 |             >
37 |               Ir a Iniciar Sesión
38 |             </button>
39 |           </div>
40 |         </div>
41 |       </div>
42 |     </PageTransition>
43 |   );
44 | } 
```

src/pages/StoryAudioPage.tsx
```
1 | import { useState, useEffect, useRef } from "react";
2 | import { useParams, useNavigate } from "react-router-dom";
3 | import { motion, AnimatePresence } from "framer-motion";
4 | import { Play, Pause, ChevronLeft, ChevronRight, ArrowLeft, Trash2, Brush } from "lucide-react";
5 | import { Button } from "@/components/ui/button";
6 | import { Slider } from "@/components/ui/slider";
7 | import { generateSpeech } from "@/services/ai/ttsService";
8 | import { useStoriesStore } from "../store/stories/storiesStore";
9 | import { useChaptersStore } from "../store/stories/chapters/chaptersStore";
10 | import { useAudioStore } from "../store/stories/audio/audioStore";
11 | import { toast } from "sonner";
12 | import WaveForm from "@/components/WaveForm";
13 | import { STORY_VOICES, PLAYBACK_SPEEDS, CUSTOM_VOICE_MAPPING, PREVIEW_FILES } from "@/constants/story-voices.constant";
14 | import { PreviewVoiceModal } from "@/components/PreviewVoiceModal";
15 | import { createClient, SupabaseClient } from '@supabase/supabase-js';
16 | import { Howl } from 'howler';
17 | import { useUserStore } from "../store/user/userStore";
18 | import { toastManager } from "@/lib/utils";
19 | 
20 | // Configuración del cliente de Supabase
21 | const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
22 | const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
23 | const user = useUserStore.getState().user;
24 | 
25 | if (!supabaseUrl || !supabaseAnonKey) {
26 |   console.error("Supabase URL or Anon Key is missing. Check your .env file.");
27 |   // Podrías lanzar un error o manejar esto de alguna manera
28 | }
29 | 
30 | const supabase: SupabaseClient | null = supabaseUrl && supabaseAnonKey ? createClient(supabaseUrl, supabaseAnonKey) : null;
31 | 
32 | // Playback speeds
33 | 
34 | 
35 | // Audio Wave Loading Animation Component
36 | const AudioWaveLoading = ({ color = "#fff" }) => {
37 |   return (
38 |     <div className="flex items-center justify-center gap-1.5">
39 |       {[1, 2, 3, 4, 5].map((bar) => (
40 |         <motion.div
41 |           key={bar}
42 |           className="w-2 bg-white rounded-full"
43 |           initial={{ height: 10 }}
44 |           animate={{
45 |             height: [10, 32, 10],
46 |             opacity: [0.4, 1, 0.4]
47 |           }}
48 |           transition={{
49 |             duration: 0.8,
50 |             repeat: Infinity,
51 |             delay: bar * 0.15,
52 |             ease: "easeInOut"
53 |           }}
54 |           style={{ backgroundColor: color }}
55 |         />
56 |       ))}
57 |     </div>
58 |   );
59 | };
60 | 
61 | // Format time helper
62 | const formatTime = (seconds: number): string => {
63 |   if (isNaN(seconds)) return "0:00";
64 |   const minutes = Math.floor(seconds / 60);
65 |   const remainingSeconds = Math.floor(seconds % 60);
66 |   return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
67 | };
68 | 
69 | export default function StoryAudioPage() {
70 |   const { storyId, chapterId } = useParams<{ storyId: string, chapterId?: string }>();
71 |   const navigate = useNavigate();
72 |   const { getStoryById } = useStoriesStore();
73 |   const { getChaptersByStoryId, loadChaptersFromSupabase } = useChaptersStore();
74 |   const {
75 |     setGenerationStatus,
76 |     getGenerationStatus,
77 |     setCurrentVoice,
78 |     getCurrentVoice,
79 |   } = useAudioStore();
80 | 
81 |   const [isPlaying, setIsPlaying] = useState(false);
82 |   const [isLoading, setIsLoading] = useState(false);
83 |   const [currentTime, setCurrentTime] = useState(0);
84 |   const [duration, setDuration] = useState(0);
85 |   const [audioUrl, setAudioUrl] = useState<string | null>(null);
86 |   const [voiceIndex, setVoiceIndex] = useState(0);
87 |   const [playbackSpeedIndex, setPlaybackSpeedIndex] = useState(1); // Default to 1x (index 1)
88 |   const [showGenerationPopup, setShowGenerationPopup] = useState(false);
89 |   const [generationProgress, setGenerationProgress] = useState(0);
90 |   const [audioIntensity, setAudioIntensity] = useState(0.5);
91 |   
92 |   // Referencia a la instancia de Howler
93 |   const howlRef = useRef<Howl | null>(null);
94 |   
95 |   // Timer para actualizar currentTime
96 |   const timerRef = useRef<NodeJS.Timeout | null>(null);
97 |   
98 |   // Referencia para análisis de audio (visualización)
99 |   const audioContextRef = useRef<AudioContext | null>(null);
100 |   const analyserRef = useRef<AnalyserNode | null>(null);
101 |   const dataArrayRef = useRef<Uint8Array | null>(null);
102 | 
103 |   // Get selected voice and playback speed
104 |   const selectedVoice = STORY_VOICES[voiceIndex];
105 |   const playbackSpeed = PLAYBACK_SPEEDS[playbackSpeedIndex];
106 | 
107 |   const [showPreviewModal, setShowPreviewModal] = useState(false);
108 |   const [previewUrl, setPreviewUrl] = useState<string | null>(null);
109 |   
110 |   // Set currentVoice in store when it changes
111 |   useEffect(() => {
112 |     setCurrentVoice(selectedVoice.id);
113 |   }, [selectedVoice.id, setCurrentVoice]);
114 | 
115 |   // Initialize voice from store if available
116 |   useEffect(() => {
117 |     const savedVoice = getCurrentVoice();
118 |     if (savedVoice) {
119 |       const voiceIdx = STORY_VOICES.findIndex(v => v.id === savedVoice);
120 |       if (voiceIdx !== -1) {
121 |         setVoiceIndex(voiceIdx);
122 |       }
123 |     }
124 |   }, [getCurrentVoice]);
125 | 
126 |   // Load story data
127 |   useEffect(() => {
128 |     if (storyId) {
129 |       // Cargar la historia como ya lo haces
130 |       const story = getStoryById(storyId);
131 |       if (!story) {
132 |         navigate("/not-found");
133 |         return;
134 |       }
135 |       
136 |       // Añadir carga de capítulos frescos
137 |       loadChaptersFromSupabase(storyId).catch(() => 
138 |         toast.error("Error cargando capítulos")
139 |       );
140 |     }
141 |   }, [storyId, navigate, getStoryById, loadChaptersFromSupabase]);
142 | 
143 |   // Get story content
144 |   const story = storyId ? getStoryById(storyId) : null;
145 |   const chapters = storyId ? getChaptersByStoryId(storyId) : [];
146 |   const currentChapterIndex = chapterId ? parseInt(chapterId, 10) : 0;
147 | 
148 |   // If no valid chapter or story, use a placeholder
149 |   const title = chapters.length > 0 && currentChapterIndex < chapters.length
150 |     ? chapters[currentChapterIndex].title || story?.title
151 |     : story?.title || "Historia";
152 | 
153 |   const content = chapters.length > 0 && currentChapterIndex < chapters.length
154 |     ? chapters[currentChapterIndex].content
155 |     : story?.content || "";
156 | 
157 |   // Estado para controlar si ya se mostró un toast para la combinación actual
158 |   const [lastAudioState, setLastAudioState] = useState<{
159 |     storyId: string | null;
160 |     chapterIndex: number | null;
161 |     voiceId: string | null;
162 |     hasAudio: boolean | null;
163 |   }>({
164 |     storyId: null,
165 |     chapterIndex: null,
166 |     voiceId: null,
167 |     hasAudio: null
168 |   });
169 | 
170 |   // Nueva función para obtener audio desde Supabase
171 |   const getAudioFromSupabase = async (storyIdToFetch: string, chapterIdx: number, voiceIdToFetch: string) => {
172 |     if (!supabase) {
173 |       console.error("Cliente Supabase no inicializado.");
174 |       return null;
175 |     }
176 |     if (!chapters[chapterIdx]) {
177 |       return null;
178 |     }
179 | 
180 |     const chapter = chapters[chapterIdx];
181 |     if (!chapter || !chapter.id) {
182 |       return null;
183 |     }
184 | 
185 |     try {
186 |       // Buscar en la tabla chapter_audio_files
187 |       const { data, error } = await supabase
188 |         .from('audio_files')
189 |         .select('*')
190 |         .eq('chapter_id', chapter.id)
191 |         .eq('voice_id', voiceIdToFetch)
192 |         .eq('user_id', user.id || '')
193 |         .maybeSingle();
194 | 
195 |       if (error && error.code !== 'PGRST116') {
196 |         console.error('Error al buscar audio existente:', error.message);
197 |         return null;
198 |       }
199 | 
200 |       // Si encontramos el registro en la base de datos, usar su public_url
201 |       if (data && data.public_url) {
202 |         return data.public_url;
203 |       }
204 |       
205 |       // Si no se encontró el audio, verificar si existe físicamente en Storage
206 |       const expectedPath = `${storyIdToFetch}/${chapter.id}/${voiceIdToFetch}.mp3`;
207 |       
208 |       // Verificar si el archivo existe realmente en el bucket antes de devolver la URL
209 |       const { data: existsData, error: existsError } = await supabase.storage
210 |         .from('narrations')
211 |         .list(storyIdToFetch, {
212 |           search: `${chapter.id}/${voiceIdToFetch}.mp3`
213 |         });
214 |         
215 |       if (existsError) {
216 |         console.error('Error al verificar existencia del archivo:', existsError);
217 |         return null;
218 |       }
219 |       
220 |       
221 |       // Solo si el archivo existe realmente, devolver la URL pública
222 |       if (existsData && existsData.length > 0) {
223 |         const { data: fileData } = await supabase.storage
224 |           .from('narrations')
225 |           .getPublicUrl(expectedPath);
226 |         
227 |         if (fileData && fileData.publicUrl) {
228 |           return fileData.publicUrl;
229 |         }
230 |       }
231 |       
232 |       return null;
233 |     } catch (e) {
234 |       console.error('Error al buscar audio existente:', e);
235 |       return null;
236 |     }
237 |   };
238 | 
239 |   // Efecto para cargar audio existente con control de toasts mejorado
240 |   useEffect(() => {
241 |     const loadAudio = async () => {
242 |       if (!storyId || currentChapterIndex === undefined || !selectedVoice || chapters.length === 0 || !chapters[currentChapterIndex]) {
243 |         setAudioUrl(null);
244 |         return;
245 |       }
246 | 
247 |       const chapter = chapters[currentChapterIndex];
248 |       if (!chapter?.id) {
249 |         setAudioUrl(null);
250 |         return;
251 |       }
252 | 
253 |       // Verificar si ya procesamos esta combinación para evitar toasts duplicados
254 |       const currentState = {
255 |         storyId,
256 |         chapterIndex: currentChapterIndex,
257 |         voiceId: selectedVoice.id,
258 |         hasAudio: null
259 |       };
260 | 
261 |       const isNewCombination = (
262 |         lastAudioState.storyId !== currentState.storyId ||
263 |         lastAudioState.chapterIndex !== currentState.chapterIndex ||
264 |         lastAudioState.voiceId !== currentState.voiceId
265 |       );
266 | 
267 |       if (!isNewCombination) {
268 |         return; // No hacer nada si es la misma combinación
269 |       }
270 | 
271 |       setIsLoading(true);
272 |       setAudioUrl(null);
273 |       
274 |       // Limpiar toasts previos solo cuando cambiamos de combinación
275 |       toastManager.clear();
276 | 
277 |       try {
278 |         const url = await getAudioFromSupabase(storyId, currentChapterIndex, selectedVoice.id);
279 |         
280 |         const newStateWithAudio = {
281 |           ...currentState,
282 |           hasAudio: !!url
283 |         };
284 |         
285 |         setLastAudioState(newStateWithAudio);
286 |         
287 |         if (url) {
288 |           setAudioUrl(url);
289 |           // Solo mostrar toast de éxito si es una nueva combinación
290 |           if (isNewCombination) {
291 |             toastManager.show('success', "Audio cargado correctamente");
292 |           }
293 |         } else {
294 |           setAudioUrl(null);
295 |           // Solo mostrar toast de info si es una nueva combinación
296 |           if (isNewCombination) {
297 |             toastManager.show('info', "No hay audio grabado para esta voz y capítulo");
298 |           }
299 |         }
300 |       } catch (error) {
301 |         console.error('Error loading audio:', error);
302 |         setAudioUrl(null);
303 |         setLastAudioState({
304 |           ...currentState,
305 |           hasAudio: false
306 |         });
307 |         
308 |         if (isNewCombination) {
309 |           toastManager.show('error', "Error al cargar el audio");
310 |         }
311 |       } finally {
312 |         setIsLoading(false);
313 |       }
314 |     };
315 | 
316 |     loadAudio();
317 |   }, [storyId, currentChapterIndex, selectedVoice?.id, chapters]);
318 | 
319 | 
320 |   // Configurar Howler cuando cambia el audioUrl
321 |   useEffect(() => {
322 |     // Limpiar instancia anterior
323 |     if (howlRef.current) {
324 |       howlRef.current.unload();
325 |       howlRef.current = null;
326 |     }
327 | 
328 |     // Limpiar timer de actualización
329 |     if (timerRef.current) {
330 |       clearInterval(timerRef.current);
331 |       timerRef.current = null;
332 |     }
333 | 
334 |     if (!audioUrl) return;
335 | 
336 |     setIsLoading(true);
337 | 
338 |     // Crear nueva instancia de Howl
339 |     const howl = new Howl({
340 |       src: [audioUrl],
341 |       html5: true, // Mejor para streaming
342 |       preload: true,
343 |       format: ['mp3'],
344 |       onload: () => {
345 |         setIsLoading(false);
346 |         setDuration(howl.duration());
347 |       },
348 |       onloaderror: () => {
349 |         setIsLoading(false);
350 |         toastManager.show('error', "No se pudo cargar el audio", "Posible problema de CORS o formato");
351 |       },
352 |       onplay: () => {
353 |         setIsPlaying(true);
354 |         
355 |         // Actualizar la posición cada 100ms durante la reproducción
356 |         if (timerRef.current) clearInterval(timerRef.current);
357 |         timerRef.current = setInterval(() => {
358 |           if (howlRef.current) {
359 |             setCurrentTime(howlRef.current.seek() as number);
360 |           }
361 |         }, 100);
362 |       },
363 |       onpause: () => {
364 |         setIsPlaying(false);
365 |         if (timerRef.current) {
366 |           clearInterval(timerRef.current);
367 |           timerRef.current = null;
368 |         }
369 |       },
370 |       onstop: () => {
371 |         setIsPlaying(false);
372 |         if (timerRef.current) {
373 |           clearInterval(timerRef.current);
374 |           timerRef.current = null;
375 |         }
376 |       },
377 |       onend: () => {
378 |         setIsPlaying(false);
379 |         setCurrentTime(howl.duration());
380 |         if (timerRef.current) {
381 |           clearInterval(timerRef.current);
382 |           timerRef.current = null;
383 |         }
384 |       },
385 |       onseek: () => {
386 |         // Actualizar el tiempo cuando se busca manualmente
387 |         if (howlRef.current) {
388 |           setCurrentTime(howlRef.current.seek() as number);
389 |         }
390 |       }
391 |     });
392 | 
393 |     // Establecer velocidad de reproducción
394 |     howl.rate(playbackSpeed);
395 |     
396 |     // Guardar referencia
397 |     howlRef.current = howl;
398 |   }, [audioUrl]);
399 | 
400 |   // Actualizar velocidad de reproducción cuando cambia
401 |   useEffect(() => {
402 |     if (howlRef.current) {
403 |       howlRef.current.rate(playbackSpeed);
404 |     }
405 |   }, [playbackSpeed]);
406 | 
407 |   // Limpiar recursos al desmontar
408 |   useEffect(() => {
409 |     return () => {
410 |       if (howlRef.current) {
411 |         howlRef.current.unload();
412 |       }
413 |       if (timerRef.current) {
414 |         clearInterval(timerRef.current);
415 |       }
416 |       if (audioContextRef.current && audioContextRef.current.state !== 'closed') {
417 |         audioContextRef.current.close();
418 |       }
419 |     };
420 |   }, []);
421 | 
422 |   const handlePreviewVoice = (voiceId: string) => {
423 |    
424 |     const url = PREVIEW_FILES[voiceId];
425 |     if (!url) {
426 |       toastManager.show('error', "Vista previa no disponible para esta voz");
427 |       return;
428 |     }
429 |     setPreviewUrl(url);
430 |     setShowPreviewModal(true);
431 |   };
432 | 
433 |   // Handle voice change with arrow navigation
434 |   const handlePreviousVoice = () => {
435 |     toastManager.clear(); // Limpiar toasts al cambiar voz
436 |     setVoiceIndex((prev) => (prev === 0 ? STORY_VOICES.length - 1 : prev - 1));
437 |   };
438 | 
439 |   const handleNextVoice = () => {
440 |     toastManager.clear(); // Limpiar toasts al cambiar voz
441 |     setVoiceIndex((prev) => (prev === STORY_VOICES.length - 1 ? 0 : prev + 1));
442 |   };
443 | 
444 |   // Handle playback speed change - cycle through speeds
445 |   const handleSpeedChange = () => {
446 |     setPlaybackSpeedIndex((prev) => (prev === PLAYBACK_SPEEDS.length - 1 ? 0 : prev + 1));
447 |   };
448 | 
449 |   // Manejo de play/pause con Howler
450 |   const handlePlayPause = () => {
451 |     if (!audioUrl) {
452 |       setShowGenerationPopup(true);
453 |       return;
454 |     }
455 | 
456 |     if (!howlRef.current) {
457 |       toastManager.show('error', "Reproductor no inicializado");
458 |       return;
459 |     }
460 | 
461 |     if (isPlaying) {
462 |       howlRef.current.pause();
463 |     } else {
464 |       howlRef.current.play();
465 |     }
466 |   };
467 | 
468 |   // Manejar el avance/retroceso en el slider
469 |   const handleSeek = (value: number[]) => {
470 |     if (!howlRef.current) return;
471 |     
472 |     const seekTime = value[0];
473 |     howlRef.current.seek(seekTime);
474 |     setCurrentTime(seekTime);
475 |   };
476 | 
477 |   const handleEndedEvent = () => {
478 |     setIsPlaying(false);
479 |     setCurrentTime(duration);
480 |   };
481 | 
482 |   // Generar audio
483 |   const handleGenerateAudio = async () => {
484 |     try {
485 |       setIsLoading(true);
486 |       setGenerationStatus(storyId || '', currentChapterIndex, 'generating', 10);
487 |       setGenerationProgress(10);
488 | 
489 |       // Simular progreso
490 |       const progressInterval = setInterval(() => {
491 |         setGenerationProgress(prev => {
492 |           const newValue = prev + Math.random() * 15;
493 |           const progress = newValue > 90 ? 90 : newValue;
494 |           setGenerationStatus(storyId || '', currentChapterIndex, 'generating', progress);
495 |           return progress;
496 |         });
497 |       }, 800);
498 | 
499 |       // Validar capítulo actual
500 |       const chapter = chapters[currentChapterIndex];
501 |       if (!chapter || !chapter.id) {
502 |         toast.error("Error: No se pudo identificar el capítulo");
503 |         setIsLoading(false);
504 |         setShowGenerationPopup(false);
505 |         clearInterval(progressInterval);
506 |         setGenerationStatus(storyId || '', currentChapterIndex, 'error', 0);
507 |         return;
508 |       }
509 | 
510 |       // Liberar URL anterior y howl
511 |       if (audioUrl) {
512 |         setAudioUrl(null);
513 |       }
514 |       if (howlRef.current) {
515 |         howlRef.current.unload();
516 |         howlRef.current = null;
517 |       }
518 | 
519 |       // Mapeo de voces para OpenAI
520 |       const mappedVoice = CUSTOM_VOICE_MAPPING[selectedVoice.id] || 'nova';
521 |       
522 |       // Generar audio con OpenAI TTS
523 |       const audioBlob = await generateSpeech({
524 |         text: content,
525 |         voice: mappedVoice,
526 |         model: 'gpt-4o-mini-tts',
527 |         instructions: selectedVoice.instructions
528 |       });
529 | 
530 |       // Preparar para subir a Supabase
531 |       const audioFile = new File([audioBlob], `${selectedVoice.id}_audio.mp3`, { type: 'audio/mpeg' });
532 | 
533 |       const formData = new FormData();
534 |       formData.append('userId', user.id || '');
535 |       formData.append('chapterId', chapter.id);
536 |       formData.append('voiceId', selectedVoice.id);
537 |       formData.append('audioFile', audioFile);
538 |       formData.append('storyId', storyId || '');
539 |       
540 |       // Indicar fase de subida
541 |       setGenerationStatus(storyId || '', currentChapterIndex, 'generating', 95);
542 | 
543 |       if (!supabase) {
544 |         toast.error("Cliente Supabase no inicializado");
545 |         setIsLoading(false);
546 |         setShowGenerationPopup(false);
547 |         clearInterval(progressInterval);
548 |         setGenerationStatus(storyId || '', currentChapterIndex, 'error', 0);
549 |         return;
550 |       }
551 | 
552 |       // Invocar Edge Function para subir audio
553 |       const { data: functionResponse, error: functionError } = await supabase.functions.invoke(
554 |         'upload-chapter-audio',
555 |         { body: formData }
556 |       );
557 | 
558 |       clearInterval(progressInterval);
559 | 
560 |       if (functionError) {
561 |         toast.error(`Error al subir el audio: ${functionError.message || 'Error desconocido'}`);
562 |         setGenerationStatus(storyId || '', currentChapterIndex, 'error', 0);
563 |         setIsLoading(false);
564 |         setShowGenerationPopup(false);
565 |         return;
566 |       }
567 | 
568 |       if (functionResponse && functionResponse.publicUrl) {
569 |         setAudioUrl(functionResponse.publicUrl);
570 |         setGenerationStatus(storyId || '', currentChapterIndex, 'completed', 100);
571 |         setShowGenerationPopup(false);
572 |         setGenerationProgress(100);
573 |         toast.success("Audio generado y guardado");
574 |       } else {
575 |         toast.error("Error al procesar la respuesta del servidor");
576 |         setGenerationStatus(storyId || '', currentChapterIndex, 'error', 0);
577 |       }
578 |       
579 |     } catch (error) {
580 |       toast.error(`Error: ${error instanceof Error ? error.message : 'Problema desconocido'}`);
581 |       setGenerationStatus(storyId || '', currentChapterIndex, 'error', 0);
582 |     } finally {
583 |       setIsLoading(false);
584 |       setShowGenerationPopup(false);
585 |     }
586 |   };
587 | 
588 |   // Eliminar funciones de manejo de caché local
589 |   const handleCleanAllAudio = () => {
590 |     if (howlRef.current) {
591 |       howlRef.current.pause();
592 |       howlRef.current.unload();
593 |       howlRef.current = null;
594 |     }
595 |     
596 |     if (audioUrl) {
597 |       setAudioUrl(null);
598 |     }
599 |     
600 |     setIsPlaying(false);
601 |   };
602 | 
603 |   return (
604 |     <div
605 |       className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden"
606 |       style={{
607 |         backgroundColor: 'black',
608 |       }}
609 |     >
610 |       {/* Overlay con el color de la voz seleccionada para mantener la identidad visual */}
611 |       <div 
612 |         className="absolute inset-0 z-0 opacity-70"
613 |         style={{ backgroundColor: selectedVoice.color }}
614 |       />
615 |       
616 |       {/* Content container with podcast player design */}
617 |       <div className="relative z-10 w-full max-w-sm rounded-3xl overflow-hidden bg-white/10 backdrop-blur-md shadow-2xl">
618 |         {/* Header with podcast title - Restructured for better title visibility */}
619 |         <div className="p-5 flex flex-col space-y-3">
620 |           {/* Back button and title row - removed width constraints */}
621 |           <div className="flex items-center space-x-3">
622 |             <button
623 |               onClick={() => navigate(`/story/${storyId}`)}
624 |               className="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-all flex-shrink-0"
625 |             >
626 |               <ArrowLeft size={20} className="text-gray-800" />
627 |             </button>
628 |             <h1 className="text-lg font-semibold text-gray-800 flex-grow">
629 |               {title}
630 |             </h1>
631 |             {/* <button
632 |               onClick={async () => {
633 |                 if (storyId) {
634 |                   toast.info("Refrescando datos de capítulos...");
635 |                   try {
636 |                     await loadChaptersFromSupabase(storyId);
637 |                     toast.success("Capítulos actualizados.");
638 |                   } catch (error) {
639 |                     toast.error("Error al actualizar capítulos.");
640 |                   }
641 |                 }
642 |               }}
643 |               title="Refrescar capítulos"
644 |               className="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-all flex-shrink-0"
645 |             >
646 |               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-800">
647 |                 <path d="M21 2v6h-6"></path>
648 |                 <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
649 |                 <path d="M3 12a9 9 0 0 0 6.7 15L13 22"></path>
650 |                 <path d="M14.3 19.1L21 22v-6"></path>
651 |               </svg>
652 |             </button> */}
653 |           </div>
654 |         </div>
655 | 
656 |         {/* Main content */}
657 |         <div className="relative aspect-square overflow-hidden">
658 |           {/* Waveform background */}
659 |           <div className="absolute inset-0">
660 |             <WaveForm
661 |               isPlaying={isPlaying}
662 |               color={selectedVoice.color}
663 |               intensity={audioIntensity}
664 |             />
665 |           </div>
666 | 
667 |           {/* Center content with play button */}
668 |           <div className="absolute inset-0 flex flex-col items-center justify-center">
669 |             {/* Narrator indicator - small and subtle */}
670 |             <div className="mb-4 text-center w-32">
671 |               <span className="text-lg opacity-80 text-gray-800">{selectedVoice.icon}</span>
672 |               <p className="text-xs font-medium text-gray-800/80">{selectedVoice.name}</p>
673 |             </div>
674 | 
675 |             {/* Play button */}
676 |             <button
677 |               onClick={handlePlayPause}
678 |               disabled={isLoading}
679 |               className="w-20 h-20 rounded-full bg-white flex items-center justify-center shadow-lg focus:outline-none hover:scale-105 transition-transform"
680 |             >
681 |               {isLoading ? (
682 |                 <AudioWaveLoading color={selectedVoice.color} />
683 |               ) : isPlaying ? (
684 |                 <Pause className="w-10 h-10" style={{ color: selectedVoice.color }} />
685 |               ) : (
686 |                 <Play className="w-10 h-10 ml-1" style={{ color: selectedVoice.color }} />
687 |               )}
688 |             </button>
689 | 
690 |             {/* Time display */}
691 |             <div className="mt-8 text-center">
692 |               <p className="text-sm font-medium text-gray-800/80">
693 |                 {formatTime(currentTime)} / {formatTime(duration || 0)}
694 |               </p>
695 |             </div>
696 |           </div>
697 |         </div>
698 | 
699 |         {/* Controls section */}
700 |         <div className="px-5 pt-4 pb-5 bg-black/10">
701 |           {/* Progress bar */}
702 |           <Slider
703 |             value={[currentTime]}
704 |             max={duration || 100}
705 |             step={0.1}
706 |             onValueChange={handleSeek}
707 |             disabled={!audioUrl}
708 |             className="mb-5"
709 |           />
710 | 
711 |           {/* Botón para escuchar al narrador */}
712 |           <button
713 |             onClick={() => handlePreviewVoice(selectedVoice.id)}
714 |             className="w-full flex items-center justify-center py-2.5 px-4 rounded-full text-sm font-medium bg-white/20 text-gray-800 hover:bg-white/30 mt-0 mb-4 transition-all"
715 |           >
716 |             <Play size={18} className="mr-2 text-gray-800" />
717 |             Voz de la narración
718 |           </button>
719 | 
720 |           {/* Voice selector - moved to top of controls for better visibility */}
721 |           <div className="mb-4 flex justify-center items-center bg-white/10 py-2 px-3 rounded-full">
722 |             <button
723 |               onClick={handlePreviousVoice}
724 |               className="p-2 text-gray-800/80 hover:text-gray-800 flex-shrink-0"
725 |             >
726 |               <ChevronLeft size={22} />
727 |             </button>
728 |             <div className="flex flex-col items-center mx-3 flex-grow">
729 |               <span className="text-xl opacity-80 text-gray-800">{selectedVoice.icon}</span>
730 |               <span className="text-sm font-medium text-gray-800/90">{selectedVoice.name}</span>
731 |             </div>
732 |             <button
733 |               onClick={handleNextVoice}
734 |               className="p-2 text-gray-800/80 hover:text-gray-800 flex-shrink-0"
735 |             >
736 |               <ChevronRight size={22} />
737 |             </button>
738 |           </div>
739 | 
740 |           {/* Bottom controls row */}
741 |           <div className="flex justify-between items-center">
742 |             {/* Return to reading button - enlarged */}
743 |             <button
744 |               onClick={() => navigate(`/story/${storyId}`)}
745 |               className="py-2.5 px-5 rounded-full text-sm font-medium bg-white/20 text-gray-800 hover:bg-white/30 flex-grow-0"
746 |             >
747 |               Volver a la lectura
748 |             </button>
749 |             
750 |             {/* Playback speed - enlarged */}
751 |             <button
752 |               onClick={handleSpeedChange}
753 |               className="py-2.5 px-5 rounded-full text-sm font-medium bg-white/20 text-gray-800 hover:bg-white/30 ml-3"
754 |             >
755 |               {playbackSpeed}x
756 |             </button>
757 |           </div>
758 |         </div>
759 |       </div>
760 | 
761 |       {/* Voice generation popup */}
762 |       {showGenerationPopup && (
763 |         <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-6">
764 |           <motion.div
765 |             initial={{ opacity: 0, scale: 0.9 }}
766 |             animate={{ opacity: 1, scale: 1 }}
767 |             className="w-full max-w-sm rounded-3xl p-6 text-white shadow-2xl"
768 |             style={{ backgroundColor: selectedVoice.color }}
769 |           >
770 |             <div className="text-center mb-4">
771 |               <span className="text-5xl mb-4 inline-block">{selectedVoice.icon}</span>
772 |               <h3 className="text-xl font-bold mb-2">{selectedVoice.name}</h3>
773 |               <p className="text-gray-800 mb-5 text-sm">{selectedVoice.description}</p>
774 | 
775 |               {isLoading ? (
776 |                 <>
777 |                   <div className="w-full bg-white/20 rounded-full h-2 mb-3">
778 |                     <div
779 |                       className="bg-white h-2 rounded-full transition-all duration-300"
780 |                       style={{ width: `${generationProgress}%` }}
781 |                     ></div>
782 |                   </div>
783 |                   <p className="text-gray-800 text-sm">Generando audio, por favor espera...</p>
784 |                 </>
785 |               ) : (
786 |                 <button
787 |                   onClick={handleGenerateAudio}
788 |                   className="w-full py-3 rounded-full bg-white/20 hover:bg-white/30 text-gray-800"
789 |                 >
790 |                   Generar Audio
791 |                 </button>
792 |               )}
793 |             </div>
794 | 
795 |             {!isLoading && (
796 |               <button
797 |                 onClick={() => setShowGenerationPopup(false)}
798 |                 className="w-full py-2 text-gray-800/80 hover:text-gray-800 hover:bg-white/10 text-sm"
799 |               >
800 |                 Cancelar
801 |               </button>
802 |             )}
803 |           </motion.div>
804 |         </div>
805 |       )}
806 |       {previewUrl && (
807 |         <PreviewVoiceModal
808 |           voice={selectedVoice}
809 |           url={previewUrl}
810 |           open={showPreviewModal}
811 |           onClose={() => {
812 |             setShowPreviewModal(false);
813 |             setPreviewUrl(null);
814 |           }}
815 |         />
816 |       )}
817 |     </div>
818 |   );
819 | }
```

src/pages/StoryContinuation.tsx
```
1 | // src/pages/StoryContinuation.tsx
2 | // VERSIÓN CORREGIDA para manejar la respuesta { content, title } del servicio
3 | 
4 | import React, { useState, useEffect, useCallback } from "react";
5 | import { useParams, useNavigate, useLocation } from "react-router-dom";
6 | import { motion } from "framer-motion";
7 | import { BookOpen } from "lucide-react";
8 | import { useStoriesStore } from "../store/stories/storiesStore";
9 | import { useChaptersStore } from "../store/stories/chapters/chaptersStore";
10 | import { useUserStore } from "../store/user/userStore";
11 | import BackButton from "../components/BackButton";
12 | import PageTransition from "../components/PageTransition";
13 | import StoryContinuationOptions from "../components/StoryContinuationOptions";
14 | import StoryContinuationCustomInput from "../components/StoryContinuationCustomInput";
15 | import { toast } from "sonner";
16 | import { Story, StoryChapter as StoryChapterType } from "../types";
17 | import { StoryContinuationService } from "../services/ai/StoryContinuationService";
18 | import { generateId } from "../store/core/utils";
19 | import IconLoadingAnimation from "../components/IconLoadingAnimation";
20 | 
21 | export default function StoryContinuation() {
22 |   const { storyId } = useParams<{ storyId: string }>();
23 |   const navigate = useNavigate();
24 |   const location = useLocation();
25 |   const { getStoryById } = useStoriesStore();
26 |   const { getChaptersByStoryId, addChapter } = useChaptersStore();
27 |   const { canContinueStory } = useUserStore();
28 | 
29 |   const [isLoading, setIsLoading] = useState(false);
30 |   const [isLoadingOptions, setIsLoadingOptions] = useState(false);
31 |   const [showCustomInput, setShowCustomInput] = useState(false);
32 |   const [continuationOptions, setContinuationOptions] = useState<{ summary: string }[]>([]);
33 |   const [story, setStory] = useState<Story | null>(null);
34 |   const [chapters, setChapters] = useState<StoryChapterType[]>([]);
35 |   const [shouldGenerateOptions, setShouldGenerateOptions] = useState(true);
36 |   const [isAllowedToContinue, setIsAllowedToContinue] = useState(true);
37 | 
38 |   useEffect(() => {
39 |     if (!storyId) {
40 |       navigate("/home");
41 |       return;
42 |     }
43 | 
44 |     const fetchedStory = getStoryById(storyId);
45 |     if (!fetchedStory) {
46 |       toast.error("Historia no encontrada");
47 |       navigate("/saved-stories");
48 |       return;
49 |     }
50 |     setStory(fetchedStory);
51 | 
52 |     const existingChapters = getChaptersByStoryId(storyId);
53 |     let currentChapters: StoryChapterType[];
54 | 
55 |     if (existingChapters.length === 0 && fetchedStory.content) {
56 |       const initialChapter: StoryChapterType = {
57 |         chapterNumber: 1,
58 |         title: fetchedStory.title || "Capítulo 1",
59 |         content: fetchedStory.content,
60 |         createdAt: fetchedStory.createdAt,
61 |       };
62 |       currentChapters = [initialChapter];
63 |     } else {
64 |       currentChapters = existingChapters;
65 |     }
66 |     setChapters(currentChapters);
67 | 
68 |     const allowed = canContinueStory(storyId);
69 |     setIsAllowedToContinue(allowed);
70 |     if (!allowed) {
71 |       toast.info("Has alcanzado el límite de continuación gratuita para esta historia.");
72 |     }
73 | 
74 |   }, [storyId, getStoryById, getChaptersByStoryId, navigate, canContinueStory]);
75 | 
76 |   useEffect(() => {
77 |     if (isAllowedToContinue) {
78 |       setShouldGenerateOptions(true);
79 |     }
80 |   }, [location.search, isAllowedToContinue]);
81 | 
82 |   const generateOptions = useCallback(async () => {
83 |     if (!story || chapters.length === 0 || !isAllowedToContinue) return;
84 | 
85 |     console.log(`Generating options for story ${story.id}`);
86 |     setIsLoadingOptions(true);
87 |     setContinuationOptions([]);
88 |     try {
89 |       const response = await StoryContinuationService.generateContinuationOptions(
90 |         story, 
91 |         chapters
92 |       );
93 |       if (response?.options?.length === 3) {
94 |         setContinuationOptions(response.options);
95 |       } else {
96 |         console.warn("generateOptions: No se recibieron 3 opciones válidas. Usando defaults.");
97 |         throw new Error("Fallback");
98 |       }
99 |     } catch (error) {
100 |       console.error("Error generating continuation options:", error);
101 |       toast.error("No se pudieron generar las opciones. Intenta de nuevo.");
102 |       setContinuationOptions([
103 |         { summary: "Explorar el misterioso jardín." },
104 |         { summary: "Seguir al pájaro parlanchín." },
105 |         { summary: "Preguntar al viejo árbol sabio." }
106 |       ]);
107 |     } finally {
108 |       setIsLoadingOptions(false);
109 |     }
110 |   }, [story, chapters, isAllowedToContinue]);
111 | 
112 |   useEffect(() => {
113 |     if (story && chapters.length > 0 && shouldGenerateOptions && isAllowedToContinue) {
114 |       generateOptions();
115 |       setShouldGenerateOptions(false);
116 |     }
117 |   }, [chapters, story, shouldGenerateOptions, generateOptions, isAllowedToContinue]);
118 | 
119 |   const handleGenerateAndSaveChapter = useCallback(async (
120 |     generationPromise: Promise<{ content: string; title: string }>,
121 |     generationMethod: StoryChapterType['generationMethod'],
122 |     customInput?: string
123 |   ) => {
124 |     if (!story || !storyId || !isAllowedToContinue) {
125 |       toast.error("No puedes continuar esta historia (límite alcanzado).");
126 |       return;
127 |     }
128 | 
129 |     setIsLoading(true);
130 |     toast.loading("Generando continuación...");
131 | 
132 |     try {
133 |       const nextChapterNumber = chapters.length + 1;
134 |       const { content, title } = await generationPromise;
135 | 
136 |       const newChapter: StoryChapterType = {
137 |         chapterNumber: nextChapterNumber,
138 |         title: title || `Capítulo ${nextChapterNumber}`,
139 |         content: content,
140 |         createdAt: new Date().toISOString(),
141 |         generationMethod: generationMethod,
142 |         ...(customInput && { customInput: customInput })
143 |       };
144 | 
145 |       await addChapter(storyId, newChapter);
146 | 
147 |       const updatedChapters = [...chapters, newChapter];
148 |       setChapters(updatedChapters);
149 | 
150 |       toast.dismiss();
151 |       toast.success("¡Continuación generada con éxito!");
152 | 
153 |       setShouldGenerateOptions(true);
154 | 
155 |       navigate(`/story/${storyId}?chapter=${newChapter.chapterNumber - 1}`);
156 | 
157 |     } catch (error: any) {
158 |       console.error("Error al generar continuación:", error);
159 |       toast.dismiss();
160 |       toast.error("Error al generar la continuación", {
161 |         description: error?.message || "Inténtalo de nuevo.",
162 |       });
163 |     } finally {
164 |       setIsLoading(false);
165 |     }
166 |   }, [story, storyId, isAllowedToContinue, addChapter, chapters, navigate]);
167 | 
168 |   const handleSelectFree = () => {
169 |     if (!story) return; // Añadir guarda por si acaso
170 |     // Obtener el estado MÁS ACTUAL de los capítulos ANTES de enviar
171 |     const currentChaptersFromStore = useChaptersStore.getState().getChaptersByStoryId(story.id);
172 |     console.log(`[StoryContinuation] Passing ${currentChaptersFromStore.length} chapters to freeContinuation service.`);
173 | 
174 |     handleGenerateAndSaveChapter(
175 |       // Pasar los capítulos correctos del store
176 |       StoryContinuationService.generateFreeContinuation(story, currentChaptersFromStore),
177 |       "free"
178 |     );
179 |   };
180 | 
181 |   const handleSelectOption = (index: number) => {
182 |     if (!story) return; // Añadir guarda
183 |     const selectedOptionSummary = continuationOptions[index]?.summary;
184 |     if (!selectedOptionSummary) {
185 |       toast.error("Opción seleccionada no válida.");
186 |       return;
187 |     }
188 |     // Obtener el estado MÁS ACTUAL de los capítulos ANTES de enviar
189 |     const currentChaptersFromStore = useChaptersStore.getState().getChaptersByStoryId(story.id);
190 |     console.log(`[StoryContinuation] Passing ${currentChaptersFromStore.length} chapters to optionContinuation service.`);
191 | 
192 |     handleGenerateAndSaveChapter(
193 |       // Pasar los capítulos correctos del store
194 |       StoryContinuationService.generateOptionContinuation(story, currentChaptersFromStore, selectedOptionSummary),
195 |       `option${index + 1}` as "option1" | "option2" | "option3"
196 |     );
197 |   };
198 | 
199 |   const handleCustomContinuation = (userDirection: string) => {
200 |     if (!story) return; // Añadir guarda
201 |     setShowCustomInput(false);
202 |     // Obtener el estado MÁS ACTUAL de los capítulos ANTES de enviar
203 |     const currentChaptersFromStore = useChaptersStore.getState().getChaptersByStoryId(story.id);
204 |     console.log(`[StoryContinuation] Passing ${currentChaptersFromStore.length} chapters to directedContinuation service.`);
205 | 
206 |     handleGenerateAndSaveChapter(
207 |       // Pasar los capítulos correctos del store
208 |       StoryContinuationService.generateDirectedContinuation(story, currentChaptersFromStore, userDirection),
209 |       "custom",
210 |       userDirection
211 |     );
212 |   };
213 | 
214 |   if (isLoading) {
215 |     return (
216 |       <PageTransition>
217 |         <div
218 |           className="min-h-screen flex flex-col items-center justify-center p-6"
219 |           style={{
220 |             backgroundImage: "url(/fondo_png.png)",
221 |             backgroundSize: "cover",
222 |             backgroundPosition: "center",
223 |             backgroundRepeat: "no-repeat",
224 |           }}
225 |         >
226 |           <div className="w-full max-w-md flex flex-col items-center justify-center">
227 |             <motion.div
228 |               initial={{ opacity: 0, scale: 0.8 }}
229 |               animate={{ opacity: 1, scale: 1 }}
230 |               transition={{ duration: 0.5 }}
231 |               className="mb-10"
232 |             >
233 |               <IconLoadingAnimation message="Generando continuación..." />
234 |             </motion.div>
235 | 
236 |             <motion.div
237 |               initial={{ opacity: 0 }}
238 |               animate={{ opacity: 1 }}
239 |               transition={{ delay: 1, duration: 1 }}
240 |               className="bg-white/70 text-[#222] p-4 rounded-xl max-w-sm text-center shadow-md"
241 |             >
242 |               <p className="font-medium">Estamos personalizando una continuación mágica para tu historia...</p>
243 | 
244 |               <div className="mt-4 grid grid-cols-3 gap-2">
245 |                 {story?.options?.characters && story.options.characters.length > 0 && (
246 |                   <div className="bg-[#7DC4E0]/20 p-2 rounded-lg border border-[#7DC4E0]/30">
247 |                     <p className="text-xs font-semibold text-[#7DC4E0]">Personajes ({story.options.characters.length})</p>
248 |                     <p className="text-sm truncate">
249 |                       {story.options.characters.map(char => char.name).join(', ')}
250 |                     </p>
251 |                   </div>
252 |                 )}
253 | 
254 |                 {story?.options?.genre && (
255 |                   <div className="bg-[#BB79D1]/20 p-2 rounded-lg border border-[#BB79D1]/30">
256 |                     <p className="text-xs font-semibold text-[#BB79D1]">Género</p>
257 |                     <p className="text-sm truncate">{story.options.genre}</p>
258 |                   </div>
259 |                 )}
260 | 
261 |                 {story?.options?.format && (
262 |                   <div className="bg-[#F9DA60]/20 p-2 rounded-lg border border-[#F9DA60]/30">
263 |                     <p className="text-xs font-semibold text-[#F9DA60]">Format</p>
264 |                     <p className="text-sm truncate">
265 |                       {story.options.format === 'single' ? 'Complete Story' : 'By Chapters'}
266 |                     </p>
267 |                   </div>
268 |                 )}
269 |               </div>
270 |             </motion.div>
271 |           </div>
272 |         </div>
273 |       </PageTransition>
274 |     );
275 |   }
276 | 
277 |   return (
278 |     <PageTransition>
279 |       <div
280 |         className="min-h-screen flex flex-col items-center justify-center relative"
281 |         style={{
282 |           backgroundColor: 'black',
283 |         }}
284 |       >
285 |         <BackButton
286 |           onClick={() => {
287 |             if (showCustomInput) {
288 |               setShowCustomInput(false);
289 |             } else {
290 |               navigate(`/story/${storyId}?chapter=${chapters.length > 0 ? chapters.length - 1 : 0}`);
291 |             }
292 |           }}
293 |         />
294 | 
295 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
296 |           {chapters.length > 0 && (
297 |             <motion.div
298 |               initial={{ opacity: 0, y: -10 }}
299 |               animate={{ opacity: 1, y: 0 }}
300 |               transition={{ duration: 0.3 }}
301 |               className="bg-white/70 rounded-xl p-4 mb-4 text-[#222] shadow-md"
302 |             >
303 |               <div className="flex items-center">
304 |                 <BookOpen size={20} className="mr-2 text-[#BB79D1]" />
305 |                 <h2 className="text-lg font-medium truncate" title={chapters[chapters.length - 1].title || `Capítulo ${chapters.length}`}>
306 |                   Continuando: {chapters[chapters.length - 1].title || `Capítulo ${chapters.length}`}
307 |                 </h2>
308 |               </div>
309 |             </motion.div>
310 |           )}
311 | 
312 |           <motion.h1
313 |             initial={{ opacity: 0, y: -10 }}
314 |             animate={{ opacity: 1, y: 0 }}
315 |             transition={{ duration: 0.3, delay: 0.1 }}
316 |             className="text-3xl font-bold text-[#BB79D1] text-center mb-4 font-heading drop-shadow-lg"
317 |           >
318 |             ¿Cómo quieres que continúe?
319 |           </motion.h1>
320 | 
321 |           <motion.p
322 |             initial={{ opacity: 0, y: -10 }}
323 |             animate={{ opacity: 1, y: 0 }}
324 |             transition={{ duration: 0.3, delay: 0.2 }}
325 |             className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-6 font-medium shadow-sm"
326 |           >
327 |             Elige una opción para continuar tu historia
328 |           </motion.p>
329 | 
330 |           <motion.div
331 |             initial={{ opacity: 0, y: 20 }}
332 |             animate={{ opacity: 1, y: 0 }}
333 |             transition={{ duration: 0.4, delay: 0.3 }}
334 |           >
335 |             {!showCustomInput ? (
336 |               <StoryContinuationOptions
337 |                 options={continuationOptions}
338 |                 onSelectOption={handleSelectOption}
339 |                 onSelectFree={handleSelectFree}
340 |                 onSelectCustom={() => setShowCustomInput(true)}
341 |                 isLoading={isLoadingOptions}
342 |                 disabled={!isAllowedToContinue}
343 |               />
344 |             ) : (
345 |               <StoryContinuationCustomInput
346 |                 onSubmit={handleCustomContinuation}
347 |                 onBack={() => setShowCustomInput(false)}
348 |                 disabled={!isAllowedToContinue}
349 |               />
350 |             )}
351 |           </motion.div>
352 | 
353 |           {!isAllowedToContinue && chapters.length > 0 && (
354 |             <motion.div
355 |               initial={{ opacity: 0 }}
356 |               animate={{ opacity: 1 }}
357 |               transition={{ duration: 0.3, delay: 0.4 }}
358 |               className="text-center bg-white/70 rounded-xl p-4 mt-6 shadow-md border-2 border-[#F6A5B7]/30"
359 |             >
360 |               <p className="text-[#F6A5B7] font-semibold">
361 |                 Has alcanzado el límite de continuación gratuita para esta historia. ¡Considera hacerte Premium para continuaciones ilimitadas!
362 |               </p>
363 |             </motion.div>
364 |           )}
365 |         </div>
366 |       </div>
367 |     </PageTransition>
368 |   );
369 | }
```

src/pages/StoryDetailsInput.tsx
```
1 | import React, { useState, useEffect, useCallback } from 'react';
2 | import { useNavigate } from 'react-router-dom';
3 | import { motion } from 'framer-motion';
4 | import { useStoryOptionsStore } from '../store/storyOptions/storyOptionsStore';
5 | import PageTransition from '../components/PageTransition';
6 | import BackButton from '../components/BackButton';
7 | import StoryButton from '../components/StoryButton';
8 | import { supabase } from '../supabaseClient';
9 | import type { PresetSuggestion, StoryFormat } from '../types';
10 | import { RefreshCw, Sparkles } from 'lucide-react';
11 | 
12 | const StoryDetailsInput: React.FC = () => {
13 |   const [detailsText, setDetailsText] = useState('');
14 |   const [format, setFormatState] = useState<StoryFormat>('episodic'); // Default to episodic
15 |   const { setAdditionalDetails, setFormat } = useStoryOptionsStore();
16 |   const navigate = useNavigate();
17 | 
18 |   // --- State for Presets ---
19 |   const [presets, setPresets] = useState<PresetSuggestion[]>([]);
20 |   const [allPresets, setAllPresets] = useState<PresetSuggestion[]>([]);
21 |   const [isLoadingPresets, setIsLoadingPresets] = useState<boolean>(true);
22 | 
23 |   // --- Function to fetch all presets ---
24 |   const fetchAndStoreAllPresets = useCallback(async () => {
25 |     setIsLoadingPresets(true);
26 |     try {
27 |       const { data, error } = await supabase
28 |         .from('preset_suggestions')
29 |         .select('id, text_prompt')
30 |         .eq('is_active', true);
31 | 
32 |       if (error) {
33 |         console.error('Error fetching presets:', error.message);
34 |       } else if (data) {
35 |         setAllPresets(data);
36 |       }
37 |     } catch (err) {
38 |       console.error('Unexpected error fetching presets:', err);
39 |     } finally {
40 |       setIsLoadingPresets(false);
41 |     }
42 |   }, []);
43 | 
44 |   // --- Function to select 3 random presets ---
45 |   const selectRandomPresets = useCallback(() => {
46 |     if (allPresets.length < 3) {
47 |       setPresets(allPresets);
48 |       return;
49 |     }
50 | 
51 |     // Simple shuffle and take 3
52 |     const shuffled = [...allPresets].sort(() => 0.5 - Math.random());
53 |     setPresets(shuffled.slice(0, 3));
54 |   }, [allPresets]);
55 | 
56 |   // --- Effect to load all presets on mount ---
57 |   useEffect(() => {
58 |     fetchAndStoreAllPresets();
59 |   }, [fetchAndStoreAllPresets]);
60 | 
61 |   // --- Effect to select initial random presets ---
62 |   useEffect(() => {
63 |     if (allPresets.length > 0) {
64 |       selectRandomPresets();
65 |     }
66 |   }, [allPresets, selectRandomPresets]);
67 | 
68 |   // --- Handler to generate the story ---
69 |   const handleGenerate = () => {
70 |     // Pass details only if the textarea has content
71 |     if (detailsText.trim()) {
72 |       setAdditionalDetails(detailsText.trim());
73 |     } else {
74 |       setAdditionalDetails(undefined); // Treat as skipped if empty
75 |     }
76 |     
77 |     // Set the selected format in the store
78 |     setFormat(format);
79 |     
80 |     navigate('/generating'); // Navigate to the generation screen
81 |   };
82 | 
83 |   // --- Handler to apply a preset to the textarea ---
84 |   const handlePresetClick = (text: string) => {
85 |     setDetailsText(text);
86 |   };
87 | 
88 |   // Page element animations
89 |   const fadeIn = {
90 |     hidden: { opacity: 0, y: 10 },
91 |     visible: { opacity: 1, y: 0, transition: { duration: 0.3 } }
92 |   };
93 | 
94 |   // Preset animation
95 |   const container = {
96 |     hidden: { opacity: 0 },
97 |     show: {
98 |       opacity: 1,
99 |       transition: {
100 |         staggerChildren: 0.05
101 |       }
102 |     }
103 |   };
104 | 
105 |   const item = {
106 |     hidden: { y: 10, opacity: 0 },
107 |     show: { y: 0, opacity: 1 }
108 |   };
109 | 
110 |   return (
111 |     <PageTransition>
112 |       <div
113 |         className="min-h-screen flex flex-col items-center justify-center relative"
114 |         style={{
115 |           backgroundColor: 'black',
116 |         }}
117 |       >
118 |         <BackButton />
119 |         
120 |         <div className="w-full max-w-3xl mx-auto flex flex-col items-center p-4">
121 |           {/* Animated title and subtitle */}
122 |           <motion.h1
123 |             initial={{ y: -20, opacity: 0 }}
124 |             animate={{ y: 0, opacity: 1 }}
125 |             transition={{ duration: 0.5 }}
126 |             className="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-4 font-heading bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500"
127 |           >
128 |             Any <span className="text-pink-400">juicy details</span>? 🤫
129 |           </motion.h1>
130 | 
131 |           <motion.p
132 |             initial={{ y: -20, opacity: 0 }}
133 |             animate={{ y: 0, opacity: 1 }}
134 |             transition={{ duration: 0.5, delay: 0.2 }}
135 |             className="text-lg text-gray-300 text-center mb-10 max-w-xl"
136 |           >
137 |             Spice up your story with some extra instructions or wild ideas! 🌶️
138 |           </motion.p>
139 | 
140 |           {/* "Optional Step" Badge */}
141 |           <motion.div
142 |             className="flex justify-center mb-2"
143 |             variants={fadeIn}
144 |             initial="hidden"
145 |             animate="visible"
146 |             transition={{ delay: 0.15 }}
147 |           >
148 |             <span className="inline-flex items-center px-4 py-1 rounded-full text-sm font-semibold bg-gray-800/80 border border-gray-700 text-violet-300 shadow-sm">
149 |               <Sparkles className="w-4 h-4 mr-1.5 text-violet-400" />
150 |               Optional, but fun! ✨
151 |             </span>
152 |           </motion.div>
153 |           
154 |           {/* Presets Section */}
155 |           <motion.div
156 |             className="mb-4 w-full"
157 |             variants={fadeIn}
158 |             initial="hidden"
159 |             animate="visible"
160 |             transition={{ delay: 0.2 }}
161 |           >
162 |             <div className="flex items-center justify-between mb-3 w-full">
163 |               <p className="text-center text-gray-400">Need some inspo? 😉</p>
164 |               <button
165 |                 onClick={selectRandomPresets}
166 |                 disabled={isLoadingPresets || allPresets.length < 3}
167 |                 className="text-violet-400 hover:text-violet-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm flex items-center bg-gray-800/80 px-3 py-1 rounded-full shadow-sm border border-gray-700"
168 |               >
169 |                 <RefreshCw size={14} className="mr-1.5" />
170 |                 New Ideas
171 |               </button>
172 |             </div>
173 | 
174 |             <motion.div 
175 |               variants={container}
176 |               initial="hidden"
177 |               animate="show"
178 |               className="grid grid-cols-1 md:grid-cols-3 gap-4 w-full mb-8"
179 |             >
180 |               {isLoadingPresets ? (
181 |                 <div className="col-span-full flex justify-center items-center p-4 h-24 rounded-lg bg-gray-800/50 border-2 border-gray-700">
182 |                   <div className="animate-pulse flex space-x-2">
183 |                     <div className="h-2.5 w-2.5 bg-violet-400/60 rounded-full"></div>
184 |                     <div className="h-2.5 w-2.5 bg-violet-400/60 rounded-full animation-delay-200"></div>
185 |                     <div className="h-2.5 w-2.5 bg-violet-400/60 rounded-full animation-delay-400"></div>
186 |                   </div>
187 |                 </div>
188 |               ) : presets.length > 0 ? (
189 |                 presets.map((preset) => (
190 |                   <motion.div key={preset.id} variants={item}>
191 |                     <button
192 |                       onClick={() => handlePresetClick(preset.text_prompt)}
193 |                       className="w-full text-center p-3 h-24 rounded-lg bg-gray-800/50 border-2 border-gray-700 text-gray-300 text-sm hover:border-violet-500 hover:bg-gray-700/70 transition-all shadow-sm hover:shadow-lg"
194 |                     >
195 |                       {preset.text_prompt}
196 |                     </button>
197 |                   </motion.div>
198 |                 ))
199 |               ) : (
200 |                 <div className="col-span-full text-center text-gray-400 text-sm italic p-4 h-24 rounded-lg bg-gray-800/50 border-2 border-gray-700">
201 |                   No suggestions available right now. Get creative! 💡
202 |                 </div>
203 |               )}
204 |             </motion.div>
205 |           </motion.div>
206 |           
207 |           {/* Format Selector */}
208 |           <motion.div
209 |             className="mb-6 w-full"
210 |             variants={fadeIn}
211 |             initial="hidden"
212 |             animate="visible"
213 |             transition={{ delay: 0.3 }}
214 |           >
215 |             <p className="text-gray-400 text-center mb-3">Choose your story format 📚</p>
216 |             <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
217 |               <button
218 |                 onClick={() => setFormatState('episodic')}
219 |                 className={`p-4 rounded-lg border-2 transition-all ${
220 |                   format === 'episodic' 
221 |                     ? 'border-violet-500 bg-violet-500/20 ring-2 ring-violet-500/50' 
222 |                     : 'border-gray-700 bg-gray-800/50 hover:border-violet-400 hover:bg-violet-400/10'
223 |                 }`}
224 |               >
225 |                 <span className="block font-semibold text-violet-300 mb-1">By Chapters</span>
226 |                 <span className="text-sm text-gray-400">Story with open ending for continuation</span>
227 |               </button>
228 |               
229 |               <button
230 |                 onClick={() => setFormatState('single')}
231 |                 className={`p-4 rounded-lg border-2 transition-all ${
232 |                   format === 'single' 
233 |                     ? 'border-pink-500 bg-pink-500/20 ring-2 ring-pink-500/50' 
234 |                     : 'border-gray-700 bg-gray-800/50 hover:border-pink-400 hover:bg-pink-400/10'
235 |                 }`}
236 |               >
237 |                 <span className="block font-semibold text-pink-300 mb-1">Complete Story</span>
238 |                 <span className="text-sm text-gray-400">Full story with beginning, middle, and end</span>
239 |               </button>
240 |             </div>
241 |           </motion.div>
242 |           
243 |           {/* Animated Textarea Container */} 
244 |           <motion.div
245 |             className="mb-6 w-full"
246 |             variants={fadeIn}
247 |             initial="hidden"
248 |             animate="visible"
249 |             transition={{ delay: 0.35 }}
250 |           >
251 |             <textarea
252 |               id="storyDetailsTextarea"
253 |               value={detailsText}
254 |               onChange={(e) => setDetailsText(e.target.value)}
255 |               placeholder="Drop your brilliant ideas here, or pick a suggestion from above... ✨"
256 |               className="w-full p-4 bg-gray-900 border-2 border-gray-700 rounded-lg text-white placeholder:text-gray-500 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-all h-32 resize-none"
257 |             />
258 |           </motion.div>
259 |           
260 |           {/* Generate Story Button */} 
261 |           <div className="w-full max-w-xs mt-6">
262 |             <StoryButton
263 |               onClick={handleGenerate}
264 |               className="w-full"
265 |             >
266 |               Let's make magic! 🪄
267 |             </StoryButton>
268 |           </div>
269 |         </div>
270 |       </div>
271 |     </PageTransition>
272 |   );
273 | };
274 | 
275 | export default StoryDetailsInput;
276 | 
```

src/pages/StoryGenre.tsx
```
1 | import React, { useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { motion } from "framer-motion";
4 | import { useStoryOptionsStore } from "../store/storyOptions/storyOptionsStore";
5 | import BackButton from "../components/BackButton";
6 | import StoryButton from "../components/StoryButton";
7 | import PageTransition from "../components/PageTransition";
8 | import { Input } from "../components/ui/input";
9 | import { cn } from "../lib/utils";
10 | 
11 | const suggestedGenres = [
12 |   { id: "erotic-romance", name: "Erotic Romance", icon: "💘" },
13 |   { id: "bdsm", name: "BDSM", icon: "⛓️" },
14 |   { id: "paranormal-erotica", name: "Paranormal Erotica", icon: "👻" },
15 |   { id: "lgbtq+", name: "LGBTQ+", icon: "🏳️‍🌈" },
16 |   { id: "sci-fi-erotica", name: "Sci-Fi Erotica", icon: "👽" },
17 |   { id: "taboo-forbidden", name: "Taboo / Forbidden", icon: "🤫" },
18 | ];
19 | 
20 | export default function StoryGenre() {
21 |   const navigate = useNavigate();
22 |   const { currentStoryOptions, setGenre } = useStoryOptionsStore();
23 |   const [customGenre, setCustomGenre] = useState("");
24 | 
25 |   const selectedGenre = currentStoryOptions.genre || "";
26 | 
27 |   const handleSelectGenre = (genre: string) => {
28 |     setGenre(genre);
29 |     setCustomGenre(""); // Clear custom input when a suggestion is picked
30 |   };
31 | 
32 |   const handleCustomGenreChange = (e: React.ChangeEvent<HTMLInputElement>) => {
33 |     const value = e.target.value;
34 |     setCustomGenre(value);
35 |     setGenre(value); // Update the store with the custom value
36 |   };
37 | 
38 |   const handleContinue = () => {
39 |     navigate("/story-details-input");
40 |   };
41 | 
42 |   const container = {
43 |     hidden: { opacity: 0 },
44 |     show: {
45 |       opacity: 1,
46 |       transition: { staggerChildren: 0.07 },
47 |     },
48 |   };
49 | 
50 |   const item = {
51 |     hidden: { y: 20, opacity: 0 },
52 |     show: { y: 0, opacity: 1 },
53 |   };
54 | 
55 |   return (
56 |     <PageTransition>
57 |       <div className="min-h-screen flex flex-col items-center justify-center bg-black text-white p-4">
58 |         <BackButton />
59 | 
60 |         <div className="w-full max-w-3xl mx-auto flex flex-col items-center">
61 |           <motion.h1
62 |             initial={{ y: -20, opacity: 0 }}
63 |             animate={{ y: 0, opacity: 1 }}
64 |             transition={{ duration: 0.5 }}
65 |             className="text-3xl sm:text-4xl md:text-5xl font-bold text-center mb-4 font-heading bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500"
66 |           >
67 |             Choose your story's vibe
68 |           </motion.h1>
69 | 
70 |           <motion.p
71 |             initial={{ y: -20, opacity: 0 }}
72 |             animate={{ y: 0, opacity: 1 }}
73 |             transition={{ duration: 0.5, delay: 0.2 }}
74 |             className="text-lg text-gray-300 text-center mb-10 max-w-xl"
75 |           >
76 |             Pick a genre or type your own. This will set the mood and style for your narrative. Let's get spicy! 🔥
77 |           </motion.p>
78 | 
79 |           <motion.div
80 |             variants={container}
81 |             initial="hidden"
82 |             animate="show"
83 |             className="grid grid-cols-2 md:grid-cols-3 gap-4 w-full mb-8"
84 |           >
85 |             {suggestedGenres.map((genre) => (
86 |               <motion.div
87 |                 key={genre.id}
88 |                 variants={item}
89 |                 onClick={() => handleSelectGenre(genre.name)}
90 |                 className={cn(
91 |                   "flex flex-col items-center justify-center p-4 h-32 rounded-lg cursor-pointer border-2 transition-all duration-300",
92 |                   selectedGenre === genre.name
93 |                     ? "bg-violet-800/50 border-violet-400 scale-105 shadow-lg shadow-violet-500/30"
94 |                     : "bg-gray-800/50 border-gray-700 hover:border-violet-500 hover:bg-gray-700/70"
95 |                 )}
96 |               >
97 |                 <span className="text-4xl mb-2">{genre.icon}</span>
98 |                 <span className="text-center font-medium text-gray-200">{genre.name}</span>
99 |               </motion.div>
100 |             ))}
101 |           </motion.div>
102 | 
103 |           <motion.div
104 |             initial={{ opacity: 0 }}
105 |             animate={{ opacity: 1 }}
106 |             transition={{ delay: 0.5 }}
107 |             className="w-full max-w-md mb-10"
108 |           >
109 |             <p className="text-center text-gray-400 mb-3">Or, walk on the wild side and create your own:</p>
110 |             <Input
111 |               type="text"
112 |               placeholder="e.g., Dark Comedy, Psychological Thriller..."
113 |               value={customGenre}
114 |               onChange={handleCustomGenreChange}
115 |               className="w-full bg-gray-900 border-2 border-gray-700 rounded-lg text-center text-white placeholder:text-gray-500 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-all"
116 |             />
117 |           </motion.div>
118 | 
119 |           <div className="w-full max-w-xs">
120 |             <StoryButton
121 |               onClick={handleContinue}
122 |               disabled={!selectedGenre}
123 |               className="w-full"
124 |             >
125 |               Continue
126 |             </StoryButton>
127 |           </div>
128 |         </div>
129 |       </div>
130 |     </PageTransition>
131 |   );
132 | }
```

src/pages/StoryViewer.tsx
```
1 | // src/pages/StoryViewer.tsx
2 | // VERSIÓN CORREGIDA: Maneja {content, title} y usa selectores de límites
3 | 
4 | import React, { useState, useEffect } from "react";
5 | import { useParams, useNavigate, useLocation } from "react-router-dom";
6 | import { Share, Volume2, Home, BookOpen, ChevronLeft, ChevronRight, AlertCircle, FileDown } from "lucide-react";
7 | import { motion } from "framer-motion";
8 | import { useStoriesStore } from "../store/stories/storiesStore";
9 | import { useChaptersStore } from "../store/stories/chapters/chaptersStore";
10 | import { useUserStore } from "../store/user/userStore"; // Importar para los selectores de límites
11 | import BackButton from "../components/BackButton";
12 | import PageTransition from "../components/PageTransition";
13 | import { toast } from "sonner"; // Asegurarse que toast está importado
14 | import { StoryChapter, Story } from "../types"; // Importar Story
15 | import { parseTextToParagraphs } from '@/lib/utils';
16 | import { generateId } from "../store/core/utils";
17 | import StoryPdfPreview from "../components/StoryPdfPreview";
18 | 
19 | export default function StoryViewer() {
20 |   const { storyId } = useParams<{ storyId: string }>();
21 |   const navigate = useNavigate();
22 |   const location = useLocation();
23 |   const { getStoryById, isLoadingStories } = useStoriesStore(state => ({
24 |     getStoryById: state.getStoryById,
25 |     isLoadingStories: state.isLoadingStories,
26 |   }));
27 |   const { getChaptersByStoryId } = useChaptersStore();
28 |   // --- Obtener selectores de límites/permisos del userStore ---
29 |   const { canContinueStory, canGenerateVoice } = useUserStore();
30 | 
31 |   // Estado local
32 |   const [currentChapterIndex, setCurrentChapterIndex] = useState(0);
33 |   const [chapters, setChapters] = useState<StoryChapter[]>([]);
34 |   const [story, setStory] = useState<Story | null>(null); // Para pasar al servicio de desafío/continuación
35 |   const [showPdfPreview, setShowPdfPreview] = useState(false);
36 | 
37 |   // --- Permisos derivados del store ---
38 |   // Estos se actualizan reactivamente si el estado del userStore cambia
39 |   const isAllowedToContinue = storyId ? canContinueStory(storyId) : false;
40 |   const isAllowedToGenerateVoice = canGenerateVoice();
41 | 
42 |   // --- Cálculo para saber si es el último capítulo ---
43 |   const isLastChapter = chapters.length > 0 && currentChapterIndex === chapters.length - 1;
44 | 
45 |   // --- Efecto para cargar historia y capítulos ---
46 |   useEffect(() => {
47 |     if (!storyId) { navigate("/home", { replace: true }); return; }
48 | 
49 |     // Esperar a que las historias terminen de cargarse
50 |     if (isLoadingStories) {
51 |       return;
52 |     }
53 | 
54 |     const fetchedStory = getStoryById(storyId);
55 | 
56 |     if (!fetchedStory) {
57 |       navigate("/not-found", { replace: true });
58 |       return;
59 |     }
60 |     setStory(fetchedStory);
61 |     
62 |     const storyChapters = getChaptersByStoryId(storyId);
63 |     let chaptersToSet: StoryChapter[];
64 |     if (storyChapters.length === 0 && fetchedStory.content) {
65 |       chaptersToSet = [{
66 |         id: generateId(),
67 |         chapterNumber: 1,
68 |         title: fetchedStory.title || "Capítulo 1",
69 |         content: fetchedStory.content,
70 |         createdAt: fetchedStory.createdAt
71 |       }];
72 |     } else {
73 |       chaptersToSet = [...storyChapters].sort((a, b) => a.chapterNumber - b.chapterNumber);
74 |     }
75 |     setChapters(chaptersToSet);
76 | 
77 |     const searchParams = new URLSearchParams(location.search);
78 |     const chapterParam = searchParams.get('chapter');
79 |     let initialIndex = chaptersToSet.length > 0 ? chaptersToSet.length - 1 : 0;
80 |     if (chapterParam !== null) {
81 |       const chapterIndex = parseInt(chapterParam, 10);
82 |       if (!isNaN(chapterIndex) && chapterIndex >= 0 && chapterIndex < chaptersToSet.length) {
83 |         initialIndex = chapterIndex;
84 |       }
85 |     }
86 |     setCurrentChapterIndex(initialIndex);
87 | 
88 |   }, [storyId, location.search, getStoryById, getChaptersByStoryId, navigate, isLoadingStories]);
89 | 
90 |   if (isLoadingStories) {
91 |     return <div className="gradient-bg min-h-screen flex items-center justify-center text-white">Cargando historia...</div>;
92 |   }
93 | 
94 |   if (!story) {
95 |     return <div className="gradient-bg min-h-screen flex items-center justify-center text-white">Historia no encontrada. Redirigiendo...</div>;
96 |   }
97 | 
98 | 
99 |   // --- Manejadores de Acciones ---
100 |   const handleShare = async () => {
101 |     const shareUrl = window.location.href; // URL actual incluyendo el capítulo
102 |     const shareTitle = story?.title || "Mi Historia Fantasia!";
103 |     const shareText = chapters.length > 0 ? chapters[currentChapterIndex]?.title : "Echa un vistazo a esta historia";
104 | 
105 |     if (navigator.share) {
106 |       try {
107 |         await navigator.share({
108 |           title: shareTitle,
109 |           text: shareText,
110 |           url: shareUrl,
111 |         });
112 |         toast.success("¡Historia compartida!");
113 |       } catch (error) {
114 |         console.error("Error al compartir:", error);
115 |         toast.error("No se pudo compartir", { description: "El navegador canceló la acción o hubo un error." });
116 |       }
117 |     } else {
118 |       // Fallback: Copiar al portapapeles
119 |       try {
120 |         await navigator.clipboard.writeText(shareUrl);
121 |         toast.info("Enlace copiado al portapapeles", {
122 |           description: "Puedes pegarlo para compartir la historia."
123 |         });
124 |       } catch (err) {
125 |         console.error('Error al copiar al portapapeles:', err);
126 |         toast.error("No se pudo copiar el enlace", {
127 |           description: "Tu navegador no soporta esta función o hubo un error."
128 |         });
129 |       }
130 |     }
131 |   };
132 | 
133 |   const handlePrint = () => {
134 |     // Mostrar el modal de generación de PDF en lugar de la impresión del navegador
135 |     setShowPdfPreview(true);
136 |   };
137 | 
138 |   const toggleAudioPlayer = () => {
139 |     // Usar el estado derivado isAllowedToGenerateVoice
140 |     if (isAllowedToGenerateVoice) {
141 |       navigate(`/story/${storyId}/audio/${currentChapterIndex}`);
142 |     } else {
143 |       toast.error("Límite de voz alcanzado", {
144 |         description: "No tienes generaciones de voz gratuitas o créditos disponibles."
145 |       });
146 |     }
147 |   };
148 | 
149 | 
150 |   // --- Manejadores de Navegación de Capítulos ---
151 |   const handlePreviousChapter = () => {
152 |     if (currentChapterIndex > 0) setCurrentChapterIndex(currentChapterIndex - 1);
153 |   };
154 |   const handleNextChapter = () => {
155 |     if (currentChapterIndex < chapters.length - 1) setCurrentChapterIndex(currentChapterIndex + 1);
156 |   };
157 |   // --- Fin Navegación Capítulos ---
158 | 
159 |   // --- Manejador para el botón de atrás ---
160 |   const handleGoBack = () => {
161 |     navigate('/'); // Navegar explícitamente a la página de inicio
162 |   };
163 | 
164 |   // --- *** INICIO: Lógica de Continuación MODIFICADA *** ---
165 |   const goToContinuationPage = () => {
166 |     // Usa el estado derivado isAllowedToContinue
167 |     if (isAllowedToContinue) {
168 |       // Navega a la PÁGINA de continuación, no genera aquí
169 |       navigate(`/story/${storyId}/continue?refresh=${Date.now()}`);
170 |     } else {
171 |       toast.error("Límite de continuación alcanzado", {
172 |         description: "Solo puedes añadir una continuación gratuita por historia."
173 |       });
174 |     }
175 |   };
176 | 
177 |   // --- *** FIN: Lógica de Continuación MODIFICADA *** ---
178 | 
179 |   // --- Renderizado ---
180 |   const currentChapter = chapters[currentChapterIndex];
181 | 
182 |   if (!currentChapter) {
183 |     // Manejar caso donde el índice es inválido (aunque useEffect debería prevenirlo)
184 |     return <div className="gradient-bg min-h-screen flex items-center justify-center text-white">Error: Capítulo no encontrado.</div>;
185 |   }
186 | 
187 |   return (
188 |     <PageTransition>
189 |       <div
190 |         className="min-h-screen relative pb-24 flex flex-col items-center justify-start bg-black"
191 |       >
192 |         {/* Botón de Volver atrás */}
193 |         <BackButton onClick={handleGoBack} />
194 | 
195 |         <div className="absolute top-6 right-6 flex space-x-2 z-10">
196 |           <button
197 |             onClick={handleShare}
198 |             className="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md border border-white/20 flex items-center justify-center text-[#BB79D1] hover:bg-white/40 hover:scale-105 active:scale-95 transition-all shadow-md"
199 |             aria-label="Compartir"
200 |           >
201 |             <Share className="h-5 w-5" />
202 |           </button>
203 |           <button
204 |             onClick={handlePrint}
205 |             className="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md border border-white/20 flex items-center justify-center text-[#BB79D1] hover:bg-white/40 hover:scale-105 active:scale-95 transition-all shadow-md"
206 |             aria-label="Generar PDF"
207 |             title="Generar PDF del cuento"
208 |           >
209 |             <FileDown className="h-5 w-5" />
210 |           </button>
211 |         </div>
212 | 
213 |         <div className="w-full max-w-2xl mx-auto pt-20 px-2 sm:px-6 flex-1 flex flex-col">
214 |           {/* Título del Capítulo/Historia */}
215 |           <motion.h1
216 |             initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.1 }}
217 |             className="text-2xl sm:text-3xl font-bold text-center mb-4 text-[#BB79D1] drop-shadow-lg px-2"
218 |             title={currentChapter.title || story.title}
219 |           >
220 |             {chapters.length > 1 ? `Cap. ${currentChapterIndex + 1}: ` : ''}
221 |             {currentChapter.title || story.title || "Historia sin título"}
222 |           </motion.h1>
223 | 
224 |           {/* Contenido Principal (Historia) */}
225 |           {
226 |             <motion.div
227 |               initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.2 }}
228 |               className="bg-white/80 rounded-2xl p-4 sm:p-8 mb-6 text-[#222] leading-relaxed text-base sm:text-lg shadow-lg max-w-full"
229 |               style={{ minHeight: '40vh' }}
230 |             >
231 |               {parseTextToParagraphs(currentChapter.content).map((paragraph, index) => (
232 |                 <p key={index} className="mb-4 last:mb-0 text-[1.08em] break-words">
233 |                   {paragraph}
234 |                 </p>
235 |               ))}
236 |             </motion.div>
237 |           }
238 | 
239 |           {/* --- Barra de Acciones Inferior --- */}
240 |           <motion.div
241 |               initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.3 }}
242 |               className="mt-4 sm:mt-8"
243 |             >
244 |               {/* Navegación entre Capítulos */}
245 |               <div className="flex justify-between items-center mb-4 px-1 sm:px-2">
246 |                 <button onClick={handlePreviousChapter} disabled={currentChapterIndex === 0} className="text-[#BB79D1] bg-white/70 hover:bg-[#F6A5B7]/20 rounded-xl px-3 py-2 text-sm font-semibold shadow disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-1 transition-all">
247 |                   <ChevronLeft size={18} /> Anterior
248 |                 </button>
249 |                 <span className="text-[#222] text-base sm:text-lg font-bold select-none drop-shadow-sm bg-white/70 px-3 py-1 rounded-xl shadow-sm">
250 |                   Capítulo {currentChapterIndex + 1} / {chapters.length}
251 |                 </span>
252 |                 <button onClick={handleNextChapter} disabled={currentChapterIndex === chapters.length - 1} className="text-[#BB79D1] bg-white/70 hover:bg-[#F6A5B7]/20 rounded-xl px-3 py-2 text-sm font-semibold shadow disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-1 transition-all">
253 |                   Siguiente <ChevronRight size={18} />
254 |                 </button>
255 |               </div>
256 | 
257 |               {/* Botones de Acción Principales */}
258 |               <div className="flex flex-col items-center space-y-4 sm:space-y-5">
259 |                 {/* Primera fila: Continuar Historia */}
260 |                 <div className="flex flex-col sm:flex-row gap-4 sm:gap-6 justify-center items-center w-full">
261 |                   <button
262 |                     onClick={goToContinuationPage}
263 |                     // Deshabilitado si NO se permite continuar (plan) O si NO es el último capítulo
264 |                     disabled={!isAllowedToContinue || !isLastChapter}
265 |                     className={`flex items-center justify-center px-5 sm:px-6 py-3 sm:py-4 rounded-2xl font-semibold transition-all shadow-lg text-base sm:text-lg w-full sm:w-auto ${isAllowedToContinue && isLastChapter ? 'bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white active:bg-[#E6B7D9] focus:bg-[#E6B7D9]' : 'bg-gray-300 cursor-not-allowed text-gray-500'}`}
266 |                     // Título dinámico según la razón de la deshabilitación
267 |                     title={
268 |                       !isAllowedToContinue
269 |                         ? "Límite de continuación gratuita alcanzado"
270 |                         : !isLastChapter
271 |                         ? "Solo puedes continuar desde el último capítulo"
272 |                         : "Continuar la historia"
273 |                     }
274 |                   >
275 |                     <BookOpen size={22} className="mr-2" />
276 |                     Continuar Historia
277 |                   </button>
278 |                 </div>
279 | 
280 |                 {/* Segunda fila: Narrar */}
281 |                 <button
282 |                   onClick={toggleAudioPlayer}
283 |                   disabled={!isAllowedToGenerateVoice}
284 |                   className={`flex items-center justify-center px-5 sm:px-6 py-3 sm:py-4 rounded-2xl font-semibold transition-all shadow-lg text-base sm:text-lg w-full sm:w-64 ${isAllowedToGenerateVoice ? 'bg-[#f7c59f] hover:bg-[#ffd7ba] text-white active:bg-[#ffd7ba] focus:bg-[#ffd7ba]' : 'bg-gray-300 cursor-not-allowed text-gray-500'}`}
285 |                   title={!isAllowedToGenerateVoice ? "Límite de voz o créditos agotados" : "Escuchar narración"}
286 |                 >
287 |                   <Volume2 size={22} className="mr-2" />
288 |                   Narrar
289 |                   {!isAllowedToGenerateVoice && <AlertCircle className="ml-1 h-4 w-4" />}
290 |                 </button>
291 | 
292 |                 {/* Tercera fila: Volver al Inicio */}
293 |                 <button
294 |                   onClick={() => navigate("/home")}
295 |                   className="flex items-center justify-center px-5 sm:px-6 py-2.5 sm:py-3 rounded-2xl font-semibold bg-white/60 hover:bg-white/80 text-[#BB79D1] transition-all shadow w-full sm:w-48 text-base"
296 |                 >
297 |                   <Home size={18} className="mr-2" /> Volver al Inicio
298 |                 </button>
299 |               </div>
300 |             </motion.div>
301 |         </div> {/* Fin container */}
302 | 
303 |         {/* Modal de generación de PDF */}
304 |         <StoryPdfPreview
305 |           isOpen={showPdfPreview}
306 |           onClose={() => setShowPdfPreview(false)}
307 |           title={currentChapter?.title || story?.title || "Tu cuento Fantasia!"}
308 |           content={currentChapter?.content || ""}
309 |           storyId={storyId!}
310 |           chapterId={currentChapter?.id || "1"}
311 |         />
312 |       </div> {/* Fin fondo */}
313 |     </PageTransition>
314 |   );
315 | }
316 | 
```

src/pages/TermsAndConditions.tsx
```
1 | import React from 'react';
2 | import { useNavigate } from 'react-router-dom';
3 | import { Button } from "@/components/ui/button";
4 | import PageTransition from "../components/PageTransition";
5 | 
6 | const TermsAndConditions: React.FC = () => {
7 |   const navigate = useNavigate();
8 | 
9 |   return (
10 |     <PageTransition>
11 |       <div 
12 |         className="min-h-screen flex flex-col"
13 |         style={{
14 |           backgroundColor: 'black',
15 |         }}
16 |       >
17 |         <div className="container mx-auto py-8 px-4 flex-1 overflow-auto">
18 |           <div className="max-w-4xl mx-auto">
19 |             <div className="text-center mb-6">
20 |               <h1 className="text-3xl font-bold text-[#222]">TÉRMINOS Y CONDICIONES DE USO – USUARIOS DE FANTASIA!</h1>
21 |               <p className="text-sm text-[#555] mt-2">Última actualización: 23 de abril de 2025</p>
22 |             </div>
23 | 
24 |             <div className="space-y-6 bg-white/80 p-8 rounded-2xl backdrop-blur-sm shadow-lg">
25 |               <p>
26 |                 Estos Términos y Condiciones regulan el acceso, la navegación y el uso de los servicios ofrecidos a través de la plataforma "Fantasia!" (en adelante, la "Plataforma"), titularidad de Fantasia!, con domicilio en Zaragoza, España, y correo electrónico de contacto hola@fantasia.app.
27 |               </p>
28 | 
29 |               <div>
30 |                 <h2 className="text-xl font-bold text-[#BB79D1]">1. OBJETO</h2>
31 |                 <p className="mt-2">
32 |                   Estos Términos establecen los derechos y obligaciones de los Usuarios y de Fantasia! respecto al acceso y uso de la Plataforma, que permite la generación de cuentos infantiles mediante Inteligencia Artificial.
33 |                 </p>
34 |               </div>
35 | 
36 |               <div>
37 |                 <h2 className="text-xl font-bold text-[#BB79D1]">2. DESCRIPCIÓN DEL SERVICIO</h2>
38 |                 <p className="mt-2">
39 |                   Fantasia! es una aplicación web diseñada para crear, editar y escuchar cuentos infantiles personalizados, aprovechando tecnologías de IA. El Usuario puede:
40 |                 </p>
41 |                 <p className="mt-2">
42 |                   Generar relatos a partir de parámetros (edad, tema, estilo).
43 |                 </p>
44 |                 <p className="mt-2">
45 |                   Guardar y gestionar su biblioteca de historias.
46 |                 </p>
47 |                 <p className="mt-2">
48 |                   Recibir notificaciones por correo electrónico con enlaces a sus creaciones.
49 |                 </p>
50 |               </div>
51 | 
52 |               <div>
53 |                 <h2 className="text-xl font-bold text-[#BB79D1]">3. ACCESO Y REGISTRO</h2>
54 |                 <p className="mt-2">
55 |                   Cuenta de Usuario: Para utilizar Fantasia! es necesario registrarse facilitando un email válido y una contraseña.
56 |                 </p>
57 |                 <p className="mt-2">
58 |                   Veracidad de los Datos: El Usuario garantiza que la información proporcionada es veraz y actual. En caso de modificación, deberá actualizar sus datos en su perfil.
59 |                 </p>
60 |                 <p className="mt-2">
61 |                   Edad Mínima: Solo pueden registrarse mayores de 14 años. Los menores deberán contar con el consentimiento de su padre, madre o tutor legal.
62 |                 </p>
63 |               </div>
64 | 
65 |               <div>
66 |                 <h2 className="text-xl font-bold text-[#BB79D1]">4. LICENCIA DE USO</h2>
67 |                 <p className="mt-2">
68 |                   Fantasia! otorga al Usuario una licencia limitada, revocable, no exclusiva e intransferible para uso personal y no comercial de la Plataforma.
69 |                   Queda prohibido:
70 |                 </p>
71 |                 <p className="mt-2">
72 |                   Copiar, distribuir o modificar el software de la Plataforma.
73 |                 </p>
74 |                 <p className="mt-2">
75 |                   Descompilar, realizar ingeniería inversa o extraer código.
76 |                 </p>
77 |                 <p className="mt-2">
78 |                   Compartir credenciales de acceso con terceros.
79 |                 </p>
80 |                 <p className="mt-2">
81 |                   Hacer un uso comercial de los servicios sin autorización expresa por escrito.
82 |                 </p>
83 |               </div>
84 | 
85 |               <div>
86 |                 <h2 className="text-xl font-bold text-[#BB79D1]">5. CUENTA, CONTRASEÑA Y SEGURIDAD</h2>
87 |                 <p className="mt-2">
88 |                   El Usuario es responsable de mantener la confidencialidad de su contraseña y de todas las actividades que se realicen bajo su cuenta. En caso de uso no autorizado, deberá notificarlo de inmediato a hola@fantasia.app.
89 |                 </p>
90 |               </div>
91 | 
92 |               <div>
93 |                 <h2 className="text-xl font-bold text-[#BB79D1]">6. NOTIFICACIONES</h2>
94 |                 <p className="mt-2">
95 |                   Todas las comunicaciones e información relevante (novedades, enlaces de descarga, cambios en estos Términos) se enviarán al correo electrónico registrado. El Usuario debe mantenerlo actualizado.
96 |                 </p>
97 |               </div>
98 | 
99 |               <div>
100 |                 <h2 className="text-xl font-bold text-[#BB79D1]">7. REQUISITOS TÉCNICOS</h2>
101 |                 <p className="mt-2">
102 |                   Para acceder a Fantasia! se requiere:
103 |                 </p>
104 |                 <p className="mt-2">
105 |                   Dispositivo con conexión a Internet.
106 |                 </p>
107 |                 <p className="mt-2">
108 |                   Navegador web actualizado (Chrome, Firefox, Edge, Safari).
109 |                   Fantasia! no garantiza el correcto funcionamiento en navegadores o dispositivos no compatibles.
110 |                 </p>
111 |               </div>
112 | 
113 |               <div>
114 |                 <h2 className="text-xl font-bold text-[#BB79D1]">8. PROPIEDAD INTELECTUAL</h2>
115 |                 <p className="mt-2">
116 |                   Relatos Generados: El Usuario conservará todos los derechos de propiedad intelectual sobre los cuentos que genere. Fantasia! no reivindica derechos sobre dichos contenidos.
117 |                 </p>
118 |                 <p className="mt-2">
119 |                   Plataforma y Contenidos: El software, diseño, logos, marcas y documentación de Fantasia! son propiedad exclusiva de Fantasia! y están protegidos por la normativa de propiedad intelectual. Queda prohibido su uso sin autorización.
120 |                 </p>
121 |               </div>
122 | 
123 |               <div>
124 |                 <h2 className="text-xl font-bold text-[#BB79D1]">9. EXENCIÓN DE GARANTÍAS Y LIMITACIÓN DE RESPONSABILIDAD</h2>
125 |                 <p className="mt-2">
126 |                   Fantasia! proporciona la Plataforma "tal cual" y "según disponibilidad".
127 |                 </p>
128 |                 <p className="mt-2">
129 |                   No garantiza la continuidad, puntualidad o ausencia de errores.
130 |                 </p>
131 |                 <p className="mt-2">
132 |                   No será responsable de daños directos o indirectos derivados del uso o imposibilidad de uso de la Plataforma, ni de la pérdida de datos.
133 |                 </p>
134 |               </div>
135 | 
136 |               <div>
137 |                 <h2 className="text-xl font-bold text-[#BB79D1]">10. POLÍTICA DE PRIVACIDAD</h2>
138 |                 <p className="mt-2">
139 |                   El tratamiento de datos personales se realiza conforme a la Política de Privacidad disponible en nuestra web. El Usuario puede ejercer sus derechos de acceso, rectificación, supresión y oposición enviando un email a hola@fantasia.app.
140 |                 </p>
141 |               </div>
142 | 
143 |               <div>
144 |                 <h2 className="text-xl font-bold text-[#BB79D1]">11. MODIFICACIONES DE LOS TÉRMINOS</h2>
145 |                 <p className="mt-2">
146 |                   Fantasia! se reserva el derecho de modificar estos Términos en cualquier momento. Los cambios se notificarán por correo electrónico o mediante aviso en la Plataforma. Si el Usuario no está de acuerdo, podrá cancelar su cuenta y dejar de usar el servicio.
147 |                 </p>
148 |               </div>
149 | 
150 |               <div>
151 |                 <h2 className="text-xl font-bold text-[#BB79D1]">12. LEY APLICABLE Y JURISDICCIÓN</h2>
152 |                 <p className="mt-2">
153 |                   Estos Términos se rigen por la legislación española. Para cualquier controversia, las partes se someten a la jurisdicción de los Juzgados y Tribunales de Zaragoza (España), con renuncia a cualquier otro fuero.
154 |                 </p>
155 |               </div>
156 | 
157 |               <p className="italic">
158 |                 Gracias por elegir Fantasia! Estamos aquí para acompañarte en la creación de historias inolvidables.
159 |               </p>
160 |             </div>
161 |             
162 |             <div className="flex justify-center mt-6">
163 |               <Button 
164 |                 variant="default" 
165 |                 onClick={() => navigate(-1)}
166 |                 className="min-w-32"
167 |               >
168 |                 Volver
169 |               </Button>
170 |             </div>
171 |           </div>
172 |         </div>
173 |       </div>
174 |     </PageTransition>
175 |   );
176 | };
177 | 
178 | export default TermsAndConditions; 
```

src/pages/Welcome.tsx
```
1 | import { motion } from "framer-motion";
2 | import { BookOpen, Sparkles, Headphones, Brain, LogIn, UserPlus, Star, Gift, Zap } from "lucide-react";
3 | import { useNavigate, Link } from "react-router-dom";
4 | import { useEffect, useState } from "react";
5 | import PageTransition from "../components/PageTransition";
6 | import { useUserStore } from "../store/user/userStore";
7 | 
8 | interface FeatureCardProps {
9 |   icon: React.ReactNode;
10 |   title: string;
11 |   description: string;
12 |   color: string;
13 | }
14 | 
15 | export default function Welcome() {
16 |   const navigate = useNavigate();
17 |   const { checkAuth, user } = useUserStore();
18 |   const [isLoading, setIsLoading] = useState(true);
19 | 
20 |   useEffect(() => {
21 |     const checkAuthentication = async () => {
22 |       try {
23 |         const isAuthenticated = await checkAuth();
24 |         if (isAuthenticated) {
25 |           navigate("/home");
26 |         }
27 |       } catch (error) {
28 |         console.error("Error checking authentication:", error);
29 |       } finally {
30 |         setIsLoading(false);
31 |       }
32 |     };
33 | 
34 |     checkAuthentication();
35 |   }, [checkAuth, navigate]);
36 | 
37 |   if (isLoading) {
38 |     return (
39 |       <div
40 |         className="min-h-screen flex items-center justify-center"
41 |         style={{
42 |           backgroundColor: 'black',
43 |         }}
44 |       >
45 |         <div className="w-16 h-16 rounded-full bg-white/30 flex items-center justify-center p-3 backdrop-blur-sm">
46 |           <div className="animate-spin h-full w-full border-4 border-[#F6A5B7] rounded-full border-t-transparent"></div>
47 |         </div>
48 |       </div>
49 |     );
50 |   }
51 | 
52 |   return (
53 |     <PageTransition>
54 |       <div
55 |         className="min-h-screen flex flex-col items-center overflow-auto"
56 |         style={{
57 |           backgroundColor: 'black',
58 |         }}
59 |       >
60 |         <header className="w-full max-w-6xl px-4 sm:px-6 md:px-8 py-3 flex items-center justify-between">
61 |           <div className="flex items-center">
62 |             <img src="/logo_fantasia.png" alt="Fantasia Logo" className="h-20 md:h-24" />
63 |           </div>
64 |           <div className="flex gap-3">
65 |             <button
66 |               onClick={() => navigate("/login")}
67 |               className="py-2 px-4 rounded-xl text-[#333] font-medium bg-white/80 hover:bg-white transition-all duration-200 shadow-md"
68 |             >
69 |               Iniciar Sesión
70 |             </button>
71 |             <button
72 |               onClick={() => navigate("/signup")}
73 |               className="py-2 px-4 rounded-xl text-white font-medium bg-[#F6A5B7] hover:bg-[#F6A5B7]/90 transition-all duration-200 shadow-md"
74 |             >
75 |               Registrarse
76 |             </button>
77 |           </div>
78 |         </header>
79 | 
80 |         <main className="w-full max-w-6xl px-4 sm:px-6 md:px-8 py-6 md:py-8 flex flex-col items-center">
81 |           {/* Hero Section */}
82 |           <motion.div
83 |             initial={{ y: 20, opacity: 0 }}
84 |             animate={{ y: 0, opacity: 1 }}
85 |             transition={{ duration: 0.8, ease: "easeOut" }}
86 |             className="text-center mb-10 md:mb-12"
87 |           >
88 |             <h1 className="text-4xl md:text-5xl lg:text-6xl font-bold mb-4 text-[#222]">
89 |               Historias mágicas <span className="text-[#BB79D1]">personalizadas</span>
90 |             </h1>
91 |             <p className="text-lg md:text-xl text-[#333] max-w-2xl mx-auto mb-8">
92 |               Crea cuentos únicos adaptados a los gustos y personalidad de cada niño, con narración de voz y retos educativos.
93 |             </p>
94 |             <motion.div
95 |               initial={{ y: 20, opacity: 0 }}
96 |               animate={{ y: 0, opacity: 1 }}
97 |               transition={{ duration: 0.8, delay: 0.4, ease: "easeOut" }}
98 |               className="flex flex-col sm:flex-row gap-4 justify-center"
99 |             >
100 |               <button
101 |                 onClick={() => navigate("/signup")}
102 |                 className="py-3 px-8 rounded-2xl text-white text-lg font-semibold bg-[#F6A5B7] hover:bg-[#F6A5B7]/90 transition-all duration-200 shadow-lg flex items-center justify-center gap-2"
103 |               >
104 |                 <BookOpen size={20} />
105 |                 <span>CREAR MI PRIMERA HISTORIA</span>
106 |               </button>
107 |             </motion.div>
108 |           </motion.div>
109 | 
110 |           {/* Features Section */}
111 |           <motion.div
112 |             initial={{ y: 20, opacity: 0 }}
113 |             animate={{ y: 0, opacity: 1 }}
114 |             transition={{ duration: 0.8, delay: 0.6, ease: "easeOut" }}
115 |             className="w-full mb-12"
116 |           >
117 |             <h2 className="text-2xl md:text-3xl font-bold text-center mb-8 text-[#222]">
118 |               ¿Qué hace especial a <span className="text-[#BB79D1]">Fantasia</span>?
119 |             </h2>
120 | 
121 |             <div className="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
122 |               <FeatureCard
123 |                 icon={<Sparkles className="w-6 h-6" />}
124 |                 title="Historias Personalizadas"
125 |                 description="Cuentos adaptados a los gustos, edad y personalidad de cada niño."
126 |                 color="#F6A5B7"
127 |               />
128 |               <FeatureCard
129 |                 icon={<Headphones className="w-6 h-6" />}
130 |                 title="Narración de Voz"
131 |                 description="Narraciones profesionales que dan vida a cada historia."
132 |                 color="#7DC4E0"
133 |               />
134 |               <FeatureCard
135 |                 icon={<Brain className="w-6 h-6" />}
136 |                 title="Retos Educativos"
137 |                 description="Mejora la lectura, matemáticas e idiomas con juegos divertidos."
138 |                 color="#BB79D1"
139 |               />
140 |             </div>
141 |           </motion.div>
142 | 
143 |           {/* Benefits Section */}
144 |           <motion.div
145 |             initial={{ y: 20, opacity: 0 }}
146 |             animate={{ y: 0, opacity: 1 }}
147 |             transition={{ duration: 0.8, delay: 0.8, ease: "easeOut" }}
148 |             className="w-full mb-12 bg-white/70 rounded-3xl p-8 shadow-lg border border-[#BB79D1]/20"
149 |           >
150 |             <h2 className="text-2xl md:text-3xl font-bold text-center mb-8 text-[#222]">
151 |               Beneficios para toda la familia
152 |             </h2>
153 | 
154 |             <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
155 |               <BenefitItem
156 |                 icon={<Star className="text-[#F9DA60]" size={24} />}
157 |                 title="Fomenta la imaginación"
158 |                 description="Historias que estimulan la creatividad y el pensamiento."
159 |               />
160 |               <BenefitItem
161 |                 icon={<BookOpen className="text-[#F6A5B7]" size={24} />}
162 |                 title="Mejora la lectura"
163 |                 description="Desarrolla habilidades de comprensión y vocabulario."
164 |               />
165 |               <BenefitItem
166 |                 icon={<Gift className="text-[#BB79D1]" size={24} />}
167 |                 title="Momentos especiales"
168 |                 description="Crea recuerdos únicos con historias personalizadas."
169 |               />
170 |               <BenefitItem
171 |                 icon={<Zap className="text-[#7DC4E0]" size={24} />}
172 |                 title="Aprendizaje divertido"
173 |                 description="Retos educativos integrados en cada historia."
174 |               />
175 |               <BenefitItem
176 |                 icon={<Brain className="text-[#F6A5B7]" size={24} />}
177 |                 title="Desarrollo cognitivo"
178 |                 description="Estimula el pensamiento crítico y la resolución de problemas."
179 |               />
180 |               <BenefitItem
181 |                 icon={<Sparkles className="text-[#F9DA60]" size={24} />}
182 |                 title="Personalización total"
183 |                 description="Adapta cada historia a los intereses del niño."
184 |               />
185 |             </div>
186 |           </motion.div>
187 |         </main>
188 |       </div>
189 |     </PageTransition>
190 |   );
191 | }
192 | 
193 | function FeatureCard({ icon, title, description, color }: FeatureCardProps) {
194 |   return (
195 |     <div className="bg-white/70 rounded-2xl p-6 shadow-lg border border-[#BB79D1]/20 h-full transition-all duration-300 hover:shadow-xl hover:transform hover:scale-105">
196 |       <div className="flex items-center mb-4">
197 |         <div
198 |           className="w-12 h-12 rounded-full flex items-center justify-center mr-4"
199 |           style={{ backgroundColor: `${color}30` }}
200 |         >
201 |           <div className="text-[#333]" style={{ color }}>
202 |             {icon}
203 |           </div>
204 |         </div>
205 |         <h3 className="text-xl font-semibold text-[#333]">{title}</h3>
206 |       </div>
207 |       <p className="text-[#555]">{description}</p>
208 |     </div>
209 |   );
210 | }
211 | 
212 | function BenefitItem({ icon, title, description }: { icon: React.ReactNode; title: string; description: string }) {
213 |   return (
214 |     <div className="flex items-start">
215 |       <div className="mr-4 mt-1">
216 |         {icon}
217 |       </div>
218 |       <div>
219 |         <h4 className="text-lg font-semibold text-[#333] mb-1">{title}</h4>
220 |         <p className="text-[#555]">{description}</p>
221 |       </div>
222 |     </div>
223 |   );
224 | }
```

src/types/index.ts
```
1 | export type ProfileSettings = {
2 |   // --- DATOS PRINCIPALES ---
3 |   // Muestra estos campos en gris oscuro (#222) sobre fondo claro para máxima legibilidad
4 |   language: string; // Idioma preferido del usuario
5 |   preferences?: string | null; // Gustos, fetiches y preferencias para contenido adulto personalizado
6 | 
7 |   // --- CAMPOS DE STRIPE ---
8 |   // Datos sensibles, mostrar en gris oscuro o azul claro solo si es info secundaria
9 |   stripe_customer_id?: string | null;
10 |   subscription_status?: string | null; // Estado de la suscripción (destacar si es "activa" o "cancelada")
11 |   subscription_id?: string | null;
12 |   plan_id?: string | null;
13 |   current_period_end?: string | null; // Fecha de renovación, mostrar en gris oscuro o azul claro
14 | 
15 |   // --- LÍMITES Y CRÉDITOS ---
16 |   // Mostrar estos campos en tarjetas con fondo blanco translúcido y texto destacado:
17 |   // - Números/acento: color de la paleta (ej. rosa #F6A5B7 para "8 / 10")
18 |   // - Texto principal: gris oscuro (#222)
19 |   // - Descripciones: azul claro (#7DC4E0)
20 |   voice_credits?: number | null; // Créditos de voz restantes
21 |   monthly_stories_generated?: number | null; // Historias generadas este mes
22 |   period_start_date?: string | null;
23 |   monthly_voice_generations_used?: number | null; // Usos de voz este mes
24 | 
25 |   // --- OTROS ---
26 |   has_completed_setup: boolean; // Mostrar como check visual, icono en color de la paleta
27 | };
28 | 
29 | export type StoryFormat = 'single' | 'episodic';
30 | 
31 | export type StoryCharacter = {
32 |   id: string;
33 |   name: string;
34 |   gender: 'male' | 'female' | 'non-binary';
35 |   description: string;
36 |   created_at?: string;
37 |   updated_at?: string;
38 | }
39 | 
40 | 
41 | export type StoryOptions = {
42 |   characters: StoryCharacter[];  // Unified: array de personajes (1-4)
43 |   genre: string;
44 |   format: StoryFormat;  // ← CAMBIO: era 'duration'
45 |   language?: string;
46 |   userProvidedContext?: string;
47 | }
48 | 
49 | export type Story = {
50 |   id: string;
51 |   title: string;
52 |   content: string;
53 |   audioUrl?: string;
54 |   options: StoryOptions;
55 |   createdAt: string;
56 |   additional_details?: string | null;
57 | }
58 | 
59 | export type User = {
60 |   email: string;
61 |   id: string;
62 | }
63 | 
64 | 
65 | export type StoryChapter = {
66 |   id: string;
67 |   chapterNumber: number;
68 |   title: string;
69 |   content: string;
70 |   createdAt: string;
71 |   generationMethod?: 'free' | 'option1' | 'option2' | 'option3' | 'custom';
72 |   customInput?: string; // Only if generationMethod is 'custom'
73 | };
74 | 
75 | export type StoryWithChapters = {
76 |   id: string;
77 |   title: string;
78 |   content: string;
79 |   audioUrl?: string;
80 |   options: StoryOptions;
81 |   createdAt: string;
82 |   additional_details?: string | null;
83 |   chapters: StoryChapter[];
84 |   hasMultipleChapters?: boolean;
85 |   chaptersCount?: number;
86 | };
87 | 
88 | export type PresetSuggestion = {
89 |   id: number; // Supabase bigint maps to number in JS/TS if not excessively large
90 |   text_prompt: string;
91 | };
```

src/types/jsx.d.ts
```
1 | import React from 'react';
2 | 
3 | declare global {
4 |   namespace JSX {
5 |     interface IntrinsicElements {
6 |       div: React.DetailedHTMLProps<React.HTMLAttributes<HTMLDivElement>, HTMLDivElement>;
7 |       span: React.DetailedHTMLProps<React.HTMLAttributes<HTMLSpanElement>, HTMLSpanElement>;
8 |       button: React.DetailedHTMLProps<React.ButtonHTMLAttributes<HTMLButtonElement>, HTMLButtonElement>;
9 |       input: React.DetailedHTMLProps<React.InputHTMLAttributes<HTMLInputElement>, HTMLInputElement>;
10 |       select: React.DetailedHTMLProps<React.SelectHTMLAttributes<HTMLSelectElement>, HTMLSelectElement>;
11 |       option: React.DetailedHTMLProps<React.OptionHTMLAttributes<HTMLOptionElement>, HTMLOptionElement>;
12 |       label: React.DetailedHTMLProps<React.LabelHTMLAttributes<HTMLLabelElement>, HTMLLabelElement>;
13 |       audio: React.DetailedHTMLProps<React.AudioHTMLAttributes<HTMLAudioElement>, HTMLAudioElement>;
14 |       img: React.DetailedHTMLProps<React.ImgHTMLAttributes<HTMLImageElement>, HTMLImageElement>;
15 |       p: React.DetailedHTMLProps<React.HTMLAttributes<HTMLParagraphElement>, HTMLParagraphElement>;
16 |       h1: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
17 |       h2: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
18 |       h3: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
19 |       h4: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
20 |       h5: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
21 |       h6: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
22 |     }
23 |   }
24 | } 
```

supabase/functions/deno.jsonc
```
1 | // supabase/edge-functions/deno.jsonc
2 | {
3 |     "compilerOptions": {
4 |         "allowJs": true,
5 |         "lib": [
6 |             "deno.window",
7 |             "deno.unstable"
8 |         ], // Añade las libs que necesiten tus funciones
9 |         "strict": true
10 |         // No necesitas "jsx" aquí si no usas JSX en las funciones
11 |     },
12 |     "imports": {
13 |         // Define aquí alias específicos si los necesitas DENTRO de las funciones
14 |         // Ejemplo: "shared/": "./_shared/"
15 |         "stripe": "https://esm.sh/stripe@14.13.0?target=deno",
16 |         "supabase": "https://esm.sh/@supabase/supabase-js@2.39.8",
17 |         "jose": "https://deno.land/x/jose@v5.6.3/index.ts"
18 |         // ...otros imports comunes para tus funciones...
19 |     }
20 |     // Puedes añadir config de lint/fmt si quieres usarlos específicamente aquí
21 | }
```

supabase/functions/deno.lock
```
1 | {
2 |   "version": "5",
3 |   "specifiers": {
4 |     "npm:@google/generative-ai@*": "0.24.1",
5 |     "npm:@types/node@*": "22.12.0",
6 |     "npm:uuid@9.0.0": "9.0.0"
7 |   },
8 |   "npm": {
9 |     "@google/generative-ai@0.24.1": {
10 |       "integrity": "sha512-MqO+MLfM6kjxcKoy0p1wRzG3b4ZZXtPI+z2IE26UogS2Cm/XHO+7gGRBh6gcJsOiIVoH93UwKvW4HdgiOZCy9Q=="
11 |     },
12 |     "@types/node@22.12.0": {
13 |       "integrity": "sha512-Fll2FZ1riMjNmlmJOdAyY5pUbkftXslB5DgEzlIuNaiWhXd00FhWxVC/r4yV/4wBb9JfImTu+jiSvXTkJ7F/gA==",
14 |       "dependencies": [
15 |         "undici-types"
16 |       ]
17 |     },
18 |     "undici-types@6.20.0": {
19 |       "integrity": "sha512-Ny6QZ2Nju20vw1SRHe3d9jVu6gJ+4e3+MMpqu7pqE5HT6WsTSlce++GQmK5UXS8mzV8DSYHrQH+Xrf2jVcuKNg=="
20 |     },
21 |     "uuid@9.0.0": {
22 |       "integrity": "sha512-MXcSTerfPa4uqyzStbRoTgt5XIe3x5+42+q1sDuy3R5MDk66URdLMOZe5aPX/SQd+kuYAh0FdP/pO28IkQyTeg==",
23 |       "bin": true
24 |     }
25 |   },
26 |   "redirects": {
27 |     "https://esm.sh/@supabase/node-fetch@^2.6.14?target=denonext": "https://esm.sh/@supabase/node-fetch@2.6.15?target=denonext",
28 |     "https://esm.sh/@types/ws@~8.18.1/index.d.mts": "https://esm.sh/@types/ws@8.18.1/index.d.mts",
29 |     "https://esm.sh/bufferutil@^4.0.1?target=denonext": "https://esm.sh/bufferutil@4.0.9?target=denonext",
30 |     "https://esm.sh/node-gyp-build@^4.3.0?target=denonext": "https://esm.sh/node-gyp-build@4.8.4?target=denonext",
31 |     "https://esm.sh/tr46@~0.0.3?target=denonext": "https://esm.sh/tr46@0.0.3?target=denonext",
32 |     "https://esm.sh/utf-8-validate@%3E=5.0.2?target=denonext": "https://esm.sh/utf-8-validate@6.0.5?target=denonext",
33 |     "https://esm.sh/webidl-conversions@^3.0.0?target=denonext": "https://esm.sh/webidl-conversions@3.0.1?target=denonext",
34 |     "https://esm.sh/whatwg-url@^5.0.0?target=denonext": "https://esm.sh/whatwg-url@5.0.0?target=denonext",
35 |     "https://esm.sh/ws@^8.14.2?target=denonext": "https://esm.sh/ws@8.18.2?target=denonext"
36 |   },
37 |   "remote": {
38 |     "https://deno.land/std@0.177.0/async/abortable.ts": "73acfb3ed7261ce0d930dbe89e43db8d34e017b063cf0eaa7d215477bf53442e",
39 |     "https://deno.land/std@0.177.0/async/deadline.ts": "c5facb0b404eede83e38bd2717ea8ab34faa2ffb20ef87fd261fcba32ba307aa",
40 |     "https://deno.land/std@0.177.0/async/debounce.ts": "adab11d04ca38d699444ac8a9d9856b4155e8dda2afd07ce78276c01ea5a4332",
41 |     "https://deno.land/std@0.177.0/async/deferred.ts": "42790112f36a75a57db4a96d33974a936deb7b04d25c6084a9fa8a49f135def8",
42 |     "https://deno.land/std@0.177.0/async/delay.ts": "73aa04cec034c84fc748c7be49bb15cac3dd43a57174bfdb7a4aec22c248f0dd",
43 |     "https://deno.land/std@0.177.0/async/mod.ts": "f04344fa21738e5ad6bea37a6bfffd57c617c2d372bb9f9dcfd118a1b622e576",
44 |     "https://deno.land/std@0.177.0/async/mux_async_iterator.ts": "70c7f2ee4e9466161350473ad61cac0b9f115cff4c552eaa7ef9d50c4cbb4cc9",
45 |     "https://deno.land/std@0.177.0/async/pool.ts": "fd082bd4aaf26445909889435a5c74334c017847842ec035739b4ae637ae8260",
46 |     "https://deno.land/std@0.177.0/async/retry.ts": "5efa3ba450ac0c07a40a82e2df296287b5013755d232049efd7ea2244f15b20f",
47 |     "https://deno.land/std@0.177.0/async/tee.ts": "47e42d35f622650b02234d43803d0383a89eb4387e1b83b5a40106d18ae36757",
48 |     "https://deno.land/std@0.177.0/http/server.ts": "cbb17b594651215ba95c01a395700684e569c165a567e4e04bba327f41197433",
49 |     "https://esm.sh/@supabase/functions-js@2.1.5/denonext/functions-js.mjs": "e6c31ad2262a84ed55da33f4a253a9ec5cd5cc41a6b4393b5ab9b0a108a2e9a8",
50 |     "https://esm.sh/@supabase/gotrue-js@2.62.2/denonext/gotrue-js.mjs": "d3dd1c95a023b518efab9fc1fb8fa172458864a4e0f4a95b5e77f8a0df526054",
51 |     "https://esm.sh/@supabase/node-fetch@2.6.15/denonext/node-fetch.mjs": "0bae9052231f4f6dbccc7234d05ea96923dbf967be12f402764580b6bf9f713d",
52 |     "https://esm.sh/@supabase/node-fetch@2.6.15?target=denonext": "4d28c4ad97328403184353f68434f2b6973971507919e9150297413664919cf3",
53 |     "https://esm.sh/@supabase/postgrest-js@1.9.2/denonext/postgrest-js.mjs": "216c149bc04130518774d10fcf2df5d1c1369d985fee7fe942840f6f77459e27",
54 |     "https://esm.sh/@supabase/realtime-js@2.9.3/denonext/realtime-js.mjs": "aac782e4fcf8d2e2f4b2592f566a0324b19b0262a2938a0c8ce546c681faef14",
55 |     "https://esm.sh/@supabase/storage-js@2.5.5/denonext/storage-js.mjs": "a952ba6fdc889a4ae8d671ce4d1a152702c1caa3158eb2269a0208b091856075",
56 |     "https://esm.sh/@supabase/supabase-js@2.39.8": "5cb81f5217dda9564abd7d7d6211484d30441d41a113954d5904bcd0ef1007e0",
57 |     "https://esm.sh/@supabase/supabase-js@2.39.8/denonext/supabase-js.mjs": "1a4d0e38fed110fef252639a51247066a642e855794bea026efb26e5ed55abd8",
58 |     "https://esm.sh/bufferutil@4.0.9/denonext/bufferutil.mjs": "13dca4d5bb2c68cbe119f880fa3bd785b9a81a8e02e0834dae604b4b85295cd8",
59 |     "https://esm.sh/bufferutil@4.0.9?target=denonext": "e32574569ab438facfcc3f412c659b0719bbf05477136ca176938c9a3ac45125",
60 |     "https://esm.sh/node-gyp-build@4.8.4/denonext/node-gyp-build.mjs": "9a86f2d044fc77bd60aaa3d697c2ba1b818da5fb1b9aaeedec59a40b8e908803",
61 |     "https://esm.sh/node-gyp-build@4.8.4?target=denonext": "261a6cedf1fdbf159798141ba1e2311ac1510682c5c8b55dacc8cf5fdee4aa06",
62 |     "https://esm.sh/tr46@0.0.3/denonext/tr46.mjs": "5753ec0a99414f4055f0c1f97691100f13d88e48a8443b00aebb90a512785fa2",
63 |     "https://esm.sh/tr46@0.0.3?target=denonext": "19cb9be0f0d418a0c3abb81f2df31f080e9540a04e43b0f699bce1149cba0cbb",
64 |     "https://esm.sh/utf-8-validate@6.0.5/denonext/utf-8-validate.mjs": "66b8ea532a0c745068f5b96ddb1bae332c3036703243541d2e89e66331974d98",
65 |     "https://esm.sh/utf-8-validate@6.0.5?target=denonext": "071bc33ba1a58297e23a34d69dd589fd06df04b0f373b382ff5da544a623f271",
66 |     "https://esm.sh/webidl-conversions@3.0.1/denonext/webidl-conversions.mjs": "54b5c2d50a294853c4ccebf9d5ed8988c94f4e24e463d84ec859a866ea5fafec",
67 |     "https://esm.sh/webidl-conversions@3.0.1?target=denonext": "4e20318d50528084616c79d7b3f6e7f0fe7b6d09013bd01b3974d7448d767e29",
68 |     "https://esm.sh/whatwg-url@5.0.0/denonext/whatwg-url.mjs": "29b16d74ee72624c915745bbd25b617cfd2248c6af0f5120d131e232a9a9af79",
69 |     "https://esm.sh/whatwg-url@5.0.0?target=denonext": "f001a2cadf81312d214ca330033f474e74d81a003e21e8c5d70a1f46dc97b02d",
70 |     "https://esm.sh/ws@8.18.2/denonext/ws.mjs": "b9211ecb1511b09f418c1330920c66800b66710b2cd2997b64b7e0525bd895d2",
71 |     "https://esm.sh/ws@8.18.2?target=denonext": "2ee7b1bb11543dda3e7e1c685ad8599b6f18aea785302374c3def5da468a1e51"
72 |   }
73 | }
```

supabase/migrations/20230901000000_init_db.sql
```
1 | -- Habilitar la extensión para generar UUIDs
2 | CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
3 | 
4 | -- Tabla de perfiles de usuario
5 | CREATE TABLE public.profiles (
6 |   id UUID REFERENCES auth.users(id) PRIMARY KEY,
7 |   language TEXT NOT NULL,
8 |   child_age INT NOT NULL,
9 |   special_need TEXT,
10 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
11 |   updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
12 | );
13 | 
14 | -- Tabla de personajes
15 | CREATE TABLE public.characters (
16 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
17 |   user_id UUID REFERENCES auth.users(id) NOT NULL,
18 |   name TEXT NOT NULL,
19 |   hobbies TEXT[] NOT NULL,
20 |   description TEXT NOT NULL,
21 |   profession TEXT NOT NULL,
22 |   character_type TEXT NOT NULL,
23 |   personality TEXT,
24 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
25 |   updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
26 | );
27 | 
28 | -- Tabla de historias
29 | CREATE TABLE public.stories (
30 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
31 |   user_id UUID REFERENCES auth.users(id) NOT NULL,
32 |   title TEXT NOT NULL,
33 |   content TEXT NOT NULL,
34 |   audio_url TEXT,
35 |   image_url TEXT,
36 |   moral TEXT,
37 |   genre TEXT,
38 |   duration TEXT NOT NULL,
39 |   character_id UUID REFERENCES public.characters(id) NOT NULL,
40 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
41 |   updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
42 | );
43 | 
44 | -- Tabla de capítulos
45 | CREATE TABLE public.story_chapters (
46 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
47 |   story_id UUID REFERENCES public.stories(id) NOT NULL,
48 |   chapter_number INT NOT NULL,
49 |   title TEXT NOT NULL,
50 |   content TEXT NOT NULL,
51 |   generation_method TEXT,
52 |   custom_input TEXT,
53 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
54 |   updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
55 | );
56 | 
57 | -- Tabla de archivos de audio
58 | CREATE TABLE public.audio_files (
59 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
60 |   user_id UUID REFERENCES auth.users(id) NOT NULL,
61 |   story_id UUID REFERENCES public.stories(id),
62 |   chapter_id UUID REFERENCES public.story_chapters(id),
63 |   voice_id TEXT NOT NULL,
64 |   url TEXT NOT NULL,
65 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
66 | );
67 | 
68 | -- Tabla de preferencias de voz del usuario
69 | CREATE TABLE public.user_voices (
70 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
71 |   user_id UUID REFERENCES auth.users(id) NOT NULL,
72 |   voice_id TEXT NOT NULL,
73 |   is_current BOOLEAN DEFAULT FALSE,
74 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
75 |   updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
76 | );
77 | 
78 | -- Habilitar RLS (Row Level Security) en todas las tablas
79 | ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
80 | ALTER TABLE public.characters ENABLE ROW LEVEL SECURITY;
81 | ALTER TABLE public.stories ENABLE ROW LEVEL SECURITY;
82 | ALTER TABLE public.story_chapters ENABLE ROW LEVEL SECURITY;
83 | ALTER TABLE public.audio_files ENABLE ROW LEVEL SECURITY;
84 | ALTER TABLE public.user_voices ENABLE ROW LEVEL SECURITY;
85 | 
86 | -- Políticas RLS para perfiles
87 | CREATE POLICY "Los usuarios pueden ver su propio perfil" ON public.profiles
88 |   FOR SELECT USING (auth.uid() = id);
89 | CREATE POLICY "Los usuarios pueden crear su propio perfil" ON public.profiles
90 |   FOR INSERT WITH CHECK (auth.uid() = id);
91 | CREATE POLICY "Los usuarios pueden actualizar su propio perfil" ON public.profiles
92 |   FOR UPDATE USING (auth.uid() = id);
93 | 
94 | -- Políticas RLS para personajes
95 | CREATE POLICY "Los usuarios pueden ver sus propios personajes" ON public.characters
96 |   FOR SELECT USING (auth.uid() = user_id);
97 | CREATE POLICY "Los usuarios pueden crear sus propios personajes" ON public.characters
98 |   FOR INSERT WITH CHECK (auth.uid() = user_id);
99 | CREATE POLICY "Los usuarios pueden actualizar sus propios personajes" ON public.characters
100 |   FOR UPDATE USING (auth.uid() = user_id);
101 | CREATE POLICY "Los usuarios pueden eliminar sus propios personajes" ON public.characters
102 |   FOR DELETE USING (auth.uid() = user_id);
103 | 
104 | -- Políticas RLS para historias
105 | CREATE POLICY "Los usuarios pueden ver sus propias historias" ON public.stories
106 |   FOR SELECT USING (auth.uid() = user_id);
107 | CREATE POLICY "Los usuarios pueden crear sus propias historias" ON public.stories
108 |   FOR INSERT WITH CHECK (auth.uid() = user_id);
109 | CREATE POLICY "Los usuarios pueden actualizar sus propias historias" ON public.stories
110 |   FOR UPDATE USING (auth.uid() = user_id);
111 | CREATE POLICY "Los usuarios pueden eliminar sus propias historias" ON public.stories
112 |   FOR DELETE USING (auth.uid() = user_id);
113 | 
114 | -- Políticas RLS para capítulos
115 | CREATE POLICY "Los usuarios pueden ver capítulos de sus historias" ON public.story_chapters
116 |   FOR SELECT USING (auth.uid() IN (
117 |     SELECT user_id FROM public.stories WHERE id = story_id
118 |   ));
119 | CREATE POLICY "Los usuarios pueden crear capítulos en sus historias" ON public.story_chapters
120 |   FOR INSERT WITH CHECK (auth.uid() IN (
121 |     SELECT user_id FROM public.stories WHERE id = story_id
122 |   ));
123 | CREATE POLICY "Los usuarios pueden actualizar capítulos de sus historias" ON public.story_chapters
124 |   FOR UPDATE USING (auth.uid() IN (
125 |     SELECT user_id FROM public.stories WHERE id = story_id
126 |   ));
127 | CREATE POLICY "Los usuarios pueden eliminar capítulos de sus historias" ON public.story_chapters
128 |   FOR DELETE USING (auth.uid() IN (
129 |     SELECT user_id FROM public.stories WHERE id = story_id
130 |   ));
131 | 
132 | -- Políticas RLS para archivos de audio
133 | CREATE POLICY "Los usuarios pueden ver sus archivos de audio" ON public.audio_files
134 |   FOR SELECT USING (auth.uid() = user_id);
135 | CREATE POLICY "Los usuarios pueden crear sus archivos de audio" ON public.audio_files
136 |   FOR INSERT WITH CHECK (auth.uid() = user_id);
137 | CREATE POLICY "Los usuarios pueden actualizar sus archivos de audio" ON public.audio_files
138 |   FOR UPDATE USING (auth.uid() = user_id);
139 | CREATE POLICY "Los usuarios pueden eliminar sus archivos de audio" ON public.audio_files
140 |   FOR DELETE USING (auth.uid() = user_id);
141 | 
142 | -- Políticas RLS para preferencias de voz
143 | CREATE POLICY "Los usuarios pueden ver sus preferencias de voz" ON public.user_voices
144 |   FOR SELECT USING (auth.uid() = user_id);
145 | CREATE POLICY "Los usuarios pueden crear sus preferencias de voz" ON public.user_voices
146 |   FOR INSERT WITH CHECK (auth.uid() = user_id);
147 | CREATE POLICY "Los usuarios pueden actualizar sus preferencias de voz" ON public.user_voices
148 |   FOR UPDATE USING (auth.uid() = user_id);
149 | CREATE POLICY "Los usuarios pueden eliminar sus preferencias de voz" ON public.user_voices
150 |   FOR DELETE USING (auth.uid() = user_id);
151 | 
152 | -- Creación de funciones y triggers para actualizar automáticamente 'updated_at'
153 | CREATE OR REPLACE FUNCTION update_modified_column()
154 | RETURNS TRIGGER AS $
155 | BEGIN
156 |    NEW.updated_at = NOW();
157 |    RETURN NEW;
158 | END;
159 | $ LANGUAGE 'plpgsql';
160 | 
161 | -- Triggers para actualizar updated_at en cada tabla
162 | CREATE TRIGGER update_profiles_modtime
163 |   BEFORE UPDATE ON public.profiles
164 |   FOR EACH ROW EXECUTE PROCEDURE update_modified_column();
165 | 
166 | CREATE TRIGGER update_characters_modtime
167 |   BEFORE UPDATE ON public.characters
168 |   FOR EACH ROW EXECUTE PROCEDURE update_modified_column();
169 | 
170 | CREATE TRIGGER update_stories_modtime
171 |   BEFORE UPDATE ON public.stories
172 |   FOR EACH ROW EXECUTE PROCEDURE update_modified_column();
173 | 
174 | CREATE TRIGGER update_story_chapters_modtime
175 |   BEFORE UPDATE ON public.story_chapters
176 |   FOR EACH ROW EXECUTE PROCEDURE update_modified_column();
177 | 
178 | CREATE TRIGGER update_user_voices_modtime
179 |   BEFORE UPDATE ON public.user_voices
180 |   FOR EACH ROW EXECUTE PROCEDURE update_modified_column(); 
```

supabase/migrations/20231027103000_schedule_monthly_reset.sql
```
1 | -- Activar pg_cron si es necesario
2 | CREATE EXTENSION IF NOT EXISTS pg_cron WITH SCHEMA extensions;
3 | 
4 | -- Programar el job para ejecutar la función de reseteo
5 | -- Ejecuta a las 00:00 del día 1 de cada mes
6 | SELECT cron.schedule(
7 |     'monthly_story_reset',
8 |     '0 0 1 * *',
9 |    $$ SELECT public.reset_monthly_story_counts(); $$
10 | );
```

src/components/ui/accordion.tsx
```
1 | import * as React from "react"
2 | import * as AccordionPrimitive from "@radix-ui/react-accordion"
3 | import { ChevronDown } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const Accordion = AccordionPrimitive.Root
8 | 
9 | const AccordionItem = React.forwardRef<
10 |   React.ElementRef<typeof AccordionPrimitive.Item>,
11 |   React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
12 | >(({ className, ...props }, ref) => (
13 |   <AccordionPrimitive.Item
14 |     ref={ref}
15 |     className={cn("border-b", className)}
16 |     {...props}
17 |   />
18 | ))
19 | AccordionItem.displayName = "AccordionItem"
20 | 
21 | const AccordionTrigger = React.forwardRef<
22 |   React.ElementRef<typeof AccordionPrimitive.Trigger>,
23 |   React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
24 | >(({ className, children, ...props }, ref) => (
25 |   <AccordionPrimitive.Header className="flex">
26 |     <AccordionPrimitive.Trigger
27 |       ref={ref}
28 |       className={cn(
29 |         "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
30 |         className
31 |       )}
32 |       {...props}
33 |     >
34 |       {children}
35 |       <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
36 |     </AccordionPrimitive.Trigger>
37 |   </AccordionPrimitive.Header>
38 | ))
39 | AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName
40 | 
41 | const AccordionContent = React.forwardRef<
42 |   React.ElementRef<typeof AccordionPrimitive.Content>,
43 |   React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
44 | >(({ className, children, ...props }, ref) => (
45 |   <AccordionPrimitive.Content
46 |     ref={ref}
47 |     className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
48 |     {...props}
49 |   >
50 |     <div className={cn("pb-4 pt-0", className)}>{children}</div>
51 |   </AccordionPrimitive.Content>
52 | ))
53 | 
54 | AccordionContent.displayName = AccordionPrimitive.Content.displayName
55 | 
56 | export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
```

src/components/ui/alert-dialog.tsx
```
1 | import * as React from "react"
2 | import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"
3 | 
4 | import { cn } from "@/lib/utils"
5 | import { buttonVariants } from "@/components/ui/button"
6 | 
7 | const AlertDialog = AlertDialogPrimitive.Root
8 | 
9 | const AlertDialogTrigger = AlertDialogPrimitive.Trigger
10 | 
11 | const AlertDialogPortal = AlertDialogPrimitive.Portal
12 | 
13 | const AlertDialogOverlay = React.forwardRef<
14 |   React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
15 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
16 | >(({ className, ...props }, ref) => (
17 |   <AlertDialogPrimitive.Overlay
18 |     className={cn(
19 |       "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
20 |       className
21 |     )}
22 |     {...props}
23 |     ref={ref}
24 |   />
25 | ))
26 | AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName
27 | 
28 | const AlertDialogContent = React.forwardRef<
29 |   React.ElementRef<typeof AlertDialogPrimitive.Content>,
30 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
31 | >(({ className, ...props }, ref) => (
32 |   <AlertDialogPortal>
33 |     <AlertDialogOverlay />
34 |     <AlertDialogPrimitive.Content
35 |       ref={ref}
36 |       className={cn(
37 |         "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
38 |         className
39 |       )}
40 |       {...props}
41 |     />
42 |   </AlertDialogPortal>
43 | ))
44 | AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName
45 | 
46 | const AlertDialogHeader = ({
47 |   className,
48 |   ...props
49 | }: React.HTMLAttributes<HTMLDivElement>) => (
50 |   <div
51 |     className={cn(
52 |       "flex flex-col space-y-2 text-center sm:text-left",
53 |       className
54 |     )}
55 |     {...props}
56 |   />
57 | )
58 | AlertDialogHeader.displayName = "AlertDialogHeader"
59 | 
60 | const AlertDialogFooter = ({
61 |   className,
62 |   ...props
63 | }: React.HTMLAttributes<HTMLDivElement>) => (
64 |   <div
65 |     className={cn(
66 |       "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
67 |       className
68 |     )}
69 |     {...props}
70 |   />
71 | )
72 | AlertDialogFooter.displayName = "AlertDialogFooter"
73 | 
74 | const AlertDialogTitle = React.forwardRef<
75 |   React.ElementRef<typeof AlertDialogPrimitive.Title>,
76 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
77 | >(({ className, ...props }, ref) => (
78 |   <AlertDialogPrimitive.Title
79 |     ref={ref}
80 |     className={cn("text-lg font-semibold", className)}
81 |     {...props}
82 |   />
83 | ))
84 | AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName
85 | 
86 | const AlertDialogDescription = React.forwardRef<
87 |   React.ElementRef<typeof AlertDialogPrimitive.Description>,
88 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
89 | >(({ className, ...props }, ref) => (
90 |   <AlertDialogPrimitive.Description
91 |     ref={ref}
92 |     className={cn("text-sm text-muted-foreground", className)}
93 |     {...props}
94 |   />
95 | ))
96 | AlertDialogDescription.displayName =
97 |   AlertDialogPrimitive.Description.displayName
98 | 
99 | const AlertDialogAction = React.forwardRef<
100 |   React.ElementRef<typeof AlertDialogPrimitive.Action>,
101 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
102 | >(({ className, ...props }, ref) => (
103 |   <AlertDialogPrimitive.Action
104 |     ref={ref}
105 |     className={cn(buttonVariants(), className)}
106 |     {...props}
107 |   />
108 | ))
109 | AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName
110 | 
111 | const AlertDialogCancel = React.forwardRef<
112 |   React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
113 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
114 | >(({ className, ...props }, ref) => (
115 |   <AlertDialogPrimitive.Cancel
116 |     ref={ref}
117 |     className={cn(
118 |       buttonVariants({ variant: "outline" }),
119 |       "mt-2 sm:mt-0",
120 |       className
121 |     )}
122 |     {...props}
123 |   />
124 | ))
125 | AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName
126 | 
127 | export {
128 |   AlertDialog,
129 |   AlertDialogPortal,
130 |   AlertDialogOverlay,
131 |   AlertDialogTrigger,
132 |   AlertDialogContent,
133 |   AlertDialogHeader,
134 |   AlertDialogFooter,
135 |   AlertDialogTitle,
136 |   AlertDialogDescription,
137 |   AlertDialogAction,
138 |   AlertDialogCancel,
139 | }
```

src/components/ui/alert.tsx
```
1 | import * as React from "react"
2 | import { cva, type VariantProps } from "class-variance-authority"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const alertVariants = cva(
7 |   "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
8 |   {
9 |     variants: {
10 |       variant: {
11 |         default: "bg-background text-foreground",
12 |         destructive:
13 |           "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
14 |       },
15 |     },
16 |     defaultVariants: {
17 |       variant: "default",
18 |     },
19 |   }
20 | )
21 | 
22 | const Alert = React.forwardRef<
23 |   HTMLDivElement,
24 |   React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
25 | >(({ className, variant, ...props }, ref) => (
26 |   <div
27 |     ref={ref}
28 |     role="alert"
29 |     className={cn(alertVariants({ variant }), className)}
30 |     {...props}
31 |   />
32 | ))
33 | Alert.displayName = "Alert"
34 | 
35 | const AlertTitle = React.forwardRef<
36 |   HTMLParagraphElement,
37 |   React.HTMLAttributes<HTMLHeadingElement>
38 | >(({ className, ...props }, ref) => (
39 |   <h5
40 |     ref={ref}
41 |     className={cn("mb-1 font-medium leading-none tracking-tight", className)}
42 |     {...props}
43 |   />
44 | ))
45 | AlertTitle.displayName = "AlertTitle"
46 | 
47 | const AlertDescription = React.forwardRef<
48 |   HTMLParagraphElement,
49 |   React.HTMLAttributes<HTMLParagraphElement>
50 | >(({ className, ...props }, ref) => (
51 |   <div
52 |     ref={ref}
53 |     className={cn("text-sm [&_p]:leading-relaxed", className)}
54 |     {...props}
55 |   />
56 | ))
57 | AlertDescription.displayName = "AlertDescription"
58 | 
59 | export { Alert, AlertTitle, AlertDescription }
```

src/components/ui/aspect-ratio.tsx
```
1 | import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio"
2 | 
3 | const AspectRatio = AspectRatioPrimitive.Root
4 | 
5 | export { AspectRatio }
```

src/components/ui/avatar.tsx
```
1 | import * as React from "react"
2 | import * as AvatarPrimitive from "@radix-ui/react-avatar"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Avatar = React.forwardRef<
7 |   React.ElementRef<typeof AvatarPrimitive.Root>,
8 |   React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
9 | >(({ className, ...props }, ref) => (
10 |   <AvatarPrimitive.Root
11 |     ref={ref}
12 |     className={cn(
13 |       "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
14 |       className
15 |     )}
16 |     {...props}
17 |   />
18 | ))
19 | Avatar.displayName = AvatarPrimitive.Root.displayName
20 | 
21 | const AvatarImage = React.forwardRef<
22 |   React.ElementRef<typeof AvatarPrimitive.Image>,
23 |   React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
24 | >(({ className, ...props }, ref) => (
25 |   <AvatarPrimitive.Image
26 |     ref={ref}
27 |     className={cn("aspect-square h-full w-full", className)}
28 |     {...props}
29 |   />
30 | ))
31 | AvatarImage.displayName = AvatarPrimitive.Image.displayName
32 | 
33 | const AvatarFallback = React.forwardRef<
34 |   React.ElementRef<typeof AvatarPrimitive.Fallback>,
35 |   React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
36 | >(({ className, ...props }, ref) => (
37 |   <AvatarPrimitive.Fallback
38 |     ref={ref}
39 |     className={cn(
40 |       "flex h-full w-full items-center justify-center rounded-full bg-muted",
41 |       className
42 |     )}
43 |     {...props}
44 |   />
45 | ))
46 | AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName
47 | 
48 | export { Avatar, AvatarImage, AvatarFallback }
```

src/components/ui/badge.tsx
```
1 | import * as React from "react"
2 | import { cva, type VariantProps } from "class-variance-authority"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const badgeVariants = cva(
7 |   "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
8 |   {
9 |     variants: {
10 |       variant: {
11 |         default:
12 |           "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
13 |         secondary:
14 |           "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
15 |         destructive:
16 |           "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
17 |         outline: "text-foreground",
18 |       },
19 |     },
20 |     defaultVariants: {
21 |       variant: "default",
22 |     },
23 |   }
24 | )
25 | 
26 | export interface BadgeProps
27 |   extends React.HTMLAttributes<HTMLDivElement>,
28 |     VariantProps<typeof badgeVariants> {}
29 | 
30 | function Badge({ className, variant, ...props }: BadgeProps) {
31 |   return (
32 |     <div className={cn(badgeVariants({ variant }), className)} {...props} />
33 |   )
34 | }
35 | 
36 | export { Badge, badgeVariants }
```

src/components/ui/breadcrumb.tsx
```
1 | import * as React from "react"
2 | import { Slot } from "@radix-ui/react-slot"
3 | import { ChevronRight, MoreHorizontal } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const Breadcrumb = React.forwardRef<
8 |   HTMLElement,
9 |   React.ComponentPropsWithoutRef<"nav"> & {
10 |     separator?: React.ReactNode
11 |   }
12 | >(({ ...props }, ref) => <nav ref={ref} aria-label="breadcrumb" {...props} />)
13 | Breadcrumb.displayName = "Breadcrumb"
14 | 
15 | const BreadcrumbList = React.forwardRef<
16 |   HTMLOListElement,
17 |   React.ComponentPropsWithoutRef<"ol">
18 | >(({ className, ...props }, ref) => (
19 |   <ol
20 |     ref={ref}
21 |     className={cn(
22 |       "flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",
23 |       className
24 |     )}
25 |     {...props}
26 |   />
27 | ))
28 | BreadcrumbList.displayName = "BreadcrumbList"
29 | 
30 | const BreadcrumbItem = React.forwardRef<
31 |   HTMLLIElement,
32 |   React.ComponentPropsWithoutRef<"li">
33 | >(({ className, ...props }, ref) => (
34 |   <li
35 |     ref={ref}
36 |     className={cn("inline-flex items-center gap-1.5", className)}
37 |     {...props}
38 |   />
39 | ))
40 | BreadcrumbItem.displayName = "BreadcrumbItem"
41 | 
42 | const BreadcrumbLink = React.forwardRef<
43 |   HTMLAnchorElement,
44 |   React.ComponentPropsWithoutRef<"a"> & {
45 |     asChild?: boolean
46 |   }
47 | >(({ asChild, className, ...props }, ref) => {
48 |   const Comp = asChild ? Slot : "a"
49 | 
50 |   return (
51 |     <Comp
52 |       ref={ref}
53 |       className={cn("transition-colors hover:text-foreground", className)}
54 |       {...props}
55 |     />
56 |   )
57 | })
58 | BreadcrumbLink.displayName = "BreadcrumbLink"
59 | 
60 | const BreadcrumbPage = React.forwardRef<
61 |   HTMLSpanElement,
62 |   React.ComponentPropsWithoutRef<"span">
63 | >(({ className, ...props }, ref) => (
64 |   <span
65 |     ref={ref}
66 |     role="link"
67 |     aria-disabled="true"
68 |     aria-current="page"
69 |     className={cn("font-normal text-foreground", className)}
70 |     {...props}
71 |   />
72 | ))
73 | BreadcrumbPage.displayName = "BreadcrumbPage"
74 | 
75 | const BreadcrumbSeparator = ({
76 |   children,
77 |   className,
78 |   ...props
79 | }: React.ComponentProps<"li">) => (
80 |   <li
81 |     role="presentation"
82 |     aria-hidden="true"
83 |     className={cn("[&>svg]:size-3.5", className)}
84 |     {...props}
85 |   >
86 |     {children ?? <ChevronRight />}
87 |   </li>
88 | )
89 | BreadcrumbSeparator.displayName = "BreadcrumbSeparator"
90 | 
91 | const BreadcrumbEllipsis = ({
92 |   className,
93 |   ...props
94 | }: React.ComponentProps<"span">) => (
95 |   <span
96 |     role="presentation"
97 |     aria-hidden="true"
98 |     className={cn("flex h-9 w-9 items-center justify-center", className)}
99 |     {...props}
100 |   >
101 |     <MoreHorizontal className="h-4 w-4" />
102 |     <span className="sr-only">More</span>
103 |   </span>
104 | )
105 | BreadcrumbEllipsis.displayName = "BreadcrumbElipssis"
106 | 
107 | export {
108 |   Breadcrumb,
109 |   BreadcrumbList,
110 |   BreadcrumbItem,
111 |   BreadcrumbLink,
112 |   BreadcrumbPage,
113 |   BreadcrumbSeparator,
114 |   BreadcrumbEllipsis,
115 | }
```

src/components/ui/button.tsx
```
1 | import * as React from "react"
2 | import { Slot } from "@radix-ui/react-slot"
3 | import { cva, type VariantProps } from "class-variance-authority"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const buttonVariants = cva(
8 |   "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
9 |   {
10 |     variants: {
11 |       variant: {
12 |         default: "bg-primary text-primary-foreground hover:bg-primary/90",
13 |         destructive:
14 |           "bg-destructive text-destructive-foreground hover:bg-destructive/90",
15 |         outline:
16 |           "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
17 |         secondary:
18 |           "bg-secondary text-secondary-foreground hover:bg-secondary/80",
19 |         ghost: "hover:bg-accent hover:text-accent-foreground",
20 |         link: "text-primary underline-offset-4 hover:underline",
21 |       },
22 |       size: {
23 |         default: "h-10 px-4 py-2",
24 |         sm: "h-9 rounded-md px-3",
25 |         lg: "h-11 rounded-md px-8",
26 |         icon: "h-10 w-10",
27 |       },
28 |     },
29 |     defaultVariants: {
30 |       variant: "default",
31 |       size: "default",
32 |     },
33 |   }
34 | )
35 | 
36 | export interface ButtonProps
37 |   extends React.ButtonHTMLAttributes<HTMLButtonElement>,
38 |     VariantProps<typeof buttonVariants> {
39 |   asChild?: boolean
40 | }
41 | 
42 | const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
43 |   ({ className, variant, size, asChild = false, ...props }, ref) => {
44 |     const Comp = asChild ? Slot : "button"
45 |     return (
46 |       <Comp
47 |         className={cn(buttonVariants({ variant, size, className }))}
48 |         ref={ref}
49 |         {...props}
50 |       />
51 |     )
52 |   }
53 | )
54 | Button.displayName = "Button"
55 | 
56 | export { Button, buttonVariants }
```

src/components/ui/calendar.tsx
```
1 | import * as React from "react";
2 | import { ChevronLeft, ChevronRight } from "lucide-react";
3 | import { DayPicker } from "react-day-picker";
4 | 
5 | import { cn } from "@/lib/utils";
6 | import { buttonVariants } from "@/components/ui/button";
7 | 
8 | export type CalendarProps = React.ComponentProps<typeof DayPicker>;
9 | 
10 | function Calendar({
11 |   className,
12 |   classNames,
13 |   showOutsideDays = true,
14 |   ...props
15 | }: CalendarProps) {
16 |   return (
17 |     <DayPicker
18 |       showOutsideDays={showOutsideDays}
19 |       className={cn("p-3", className)}
20 |       classNames={{
21 |         months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
22 |         month: "space-y-4",
23 |         caption: "flex justify-center pt-1 relative items-center",
24 |         caption_label: "text-sm font-medium",
25 |         nav: "space-x-1 flex items-center",
26 |         nav_button: cn(
27 |           buttonVariants({ variant: "outline" }),
28 |           "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
29 |         ),
30 |         nav_button_previous: "absolute left-1",
31 |         nav_button_next: "absolute right-1",
32 |         table: "w-full border-collapse space-y-1",
33 |         head_row: "flex",
34 |         head_cell:
35 |           "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
36 |         row: "flex w-full mt-2",
37 |         cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
38 |         day: cn(
39 |           buttonVariants({ variant: "ghost" }),
40 |           "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
41 |         ),
42 |         day_range_end: "day-range-end",
43 |         day_selected:
44 |           "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
45 |         day_today: "bg-accent text-accent-foreground",
46 |         day_outside:
47 |           "day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",
48 |         day_disabled: "text-muted-foreground opacity-50",
49 |         day_range_middle:
50 |           "aria-selected:bg-accent aria-selected:text-accent-foreground",
51 |         day_hidden: "invisible",
52 |         ...classNames,
53 |       }}
54 |       components={{
55 |         IconLeft: ({ ..._props }) => <ChevronLeft className="h-4 w-4" />,
56 |         IconRight: ({ ..._props }) => <ChevronRight className="h-4 w-4" />,
57 |       }}
58 |       {...props}
59 |     />
60 |   );
61 | }
62 | Calendar.displayName = "Calendar";
63 | 
64 | export { Calendar };
```

src/components/ui/card.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | const Card = React.forwardRef<
6 |   HTMLDivElement,
7 |   React.HTMLAttributes<HTMLDivElement>
8 | >(({ className, ...props }, ref) => (
9 |   <div
10 |     ref={ref}
11 |     className={cn(
12 |       "rounded-lg border bg-card text-card-foreground shadow-sm",
13 |       className
14 |     )}
15 |     {...props}
16 |   />
17 | ))
18 | Card.displayName = "Card"
19 | 
20 | const CardHeader = React.forwardRef<
21 |   HTMLDivElement,
22 |   React.HTMLAttributes<HTMLDivElement>
23 | >(({ className, ...props }, ref) => (
24 |   <div
25 |     ref={ref}
26 |     className={cn("flex flex-col space-y-1.5 p-6", className)}
27 |     {...props}
28 |   />
29 | ))
30 | CardHeader.displayName = "CardHeader"
31 | 
32 | const CardTitle = React.forwardRef<
33 |   HTMLParagraphElement,
34 |   React.HTMLAttributes<HTMLHeadingElement>
35 | >(({ className, ...props }, ref) => (
36 |   <h3
37 |     ref={ref}
38 |     className={cn(
39 |       "text-2xl font-semibold leading-none tracking-tight",
40 |       className
41 |     )}
42 |     {...props}
43 |   />
44 | ))
45 | CardTitle.displayName = "CardTitle"
46 | 
47 | const CardDescription = React.forwardRef<
48 |   HTMLParagraphElement,
49 |   React.HTMLAttributes<HTMLParagraphElement>
50 | >(({ className, ...props }, ref) => (
51 |   <p
52 |     ref={ref}
53 |     className={cn("text-sm text-muted-foreground", className)}
54 |     {...props}
55 |   />
56 | ))
57 | CardDescription.displayName = "CardDescription"
58 | 
59 | const CardContent = React.forwardRef<
60 |   HTMLDivElement,
61 |   React.HTMLAttributes<HTMLDivElement>
62 | >(({ className, ...props }, ref) => (
63 |   <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
64 | ))
65 | CardContent.displayName = "CardContent"
66 | 
67 | const CardFooter = React.forwardRef<
68 |   HTMLDivElement,
69 |   React.HTMLAttributes<HTMLDivElement>
70 | >(({ className, ...props }, ref) => (
71 |   <div
72 |     ref={ref}
73 |     className={cn("flex items-center p-6 pt-0", className)}
74 |     {...props}
75 |   />
76 | ))
77 | CardFooter.displayName = "CardFooter"
78 | 
79 | export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
```

src/components/ui/carousel.tsx
```
1 | import * as React from "react"
2 | import useEmblaCarousel, {
3 |   type UseEmblaCarouselType,
4 | } from "embla-carousel-react"
5 | import { ArrowLeft, ArrowRight } from "lucide-react"
6 | 
7 | import { cn } from "@/lib/utils"
8 | import { Button } from "@/components/ui/button"
9 | 
10 | type CarouselApi = UseEmblaCarouselType[1]
11 | type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
12 | type CarouselOptions = UseCarouselParameters[0]
13 | type CarouselPlugin = UseCarouselParameters[1]
14 | 
15 | type CarouselProps = {
16 |   opts?: CarouselOptions
17 |   plugins?: CarouselPlugin
18 |   orientation?: "horizontal" | "vertical"
19 |   setApi?: (api: CarouselApi) => void
20 | }
21 | 
22 | type CarouselContextProps = {
23 |   carouselRef: ReturnType<typeof useEmblaCarousel>[0]
24 |   api: ReturnType<typeof useEmblaCarousel>[1]
25 |   scrollPrev: () => void
26 |   scrollNext: () => void
27 |   canScrollPrev: boolean
28 |   canScrollNext: boolean
29 | } & CarouselProps
30 | 
31 | const CarouselContext = React.createContext<CarouselContextProps | null>(null)
32 | 
33 | function useCarousel() {
34 |   const context = React.useContext(CarouselContext)
35 | 
36 |   if (!context) {
37 |     throw new Error("useCarousel must be used within a <Carousel />")
38 |   }
39 | 
40 |   return context
41 | }
42 | 
43 | const Carousel = React.forwardRef<
44 |   HTMLDivElement,
45 |   React.HTMLAttributes<HTMLDivElement> & CarouselProps
46 | >(
47 |   (
48 |     {
49 |       orientation = "horizontal",
50 |       opts,
51 |       setApi,
52 |       plugins,
53 |       className,
54 |       children,
55 |       ...props
56 |     },
57 |     ref
58 |   ) => {
59 |     const [carouselRef, api] = useEmblaCarousel(
60 |       {
61 |         ...opts,
62 |         axis: orientation === "horizontal" ? "x" : "y",
63 |       },
64 |       plugins
65 |     )
66 |     const [canScrollPrev, setCanScrollPrev] = React.useState(false)
67 |     const [canScrollNext, setCanScrollNext] = React.useState(false)
68 | 
69 |     const onSelect = React.useCallback((api: CarouselApi) => {
70 |       if (!api) {
71 |         return
72 |       }
73 | 
74 |       setCanScrollPrev(api.canScrollPrev())
75 |       setCanScrollNext(api.canScrollNext())
76 |     }, [])
77 | 
78 |     const scrollPrev = React.useCallback(() => {
79 |       api?.scrollPrev()
80 |     }, [api])
81 | 
82 |     const scrollNext = React.useCallback(() => {
83 |       api?.scrollNext()
84 |     }, [api])
85 | 
86 |     const handleKeyDown = React.useCallback(
87 |       (event: React.KeyboardEvent<HTMLDivElement>) => {
88 |         if (event.key === "ArrowLeft") {
89 |           event.preventDefault()
90 |           scrollPrev()
91 |         } else if (event.key === "ArrowRight") {
92 |           event.preventDefault()
93 |           scrollNext()
94 |         }
95 |       },
96 |       [scrollPrev, scrollNext]
97 |     )
98 | 
99 |     React.useEffect(() => {
100 |       if (!api || !setApi) {
101 |         return
102 |       }
103 | 
104 |       setApi(api)
105 |     }, [api, setApi])
106 | 
107 |     React.useEffect(() => {
108 |       if (!api) {
109 |         return
110 |       }
111 | 
112 |       onSelect(api)
113 |       api.on("reInit", onSelect)
114 |       api.on("select", onSelect)
115 | 
116 |       return () => {
117 |         api?.off("select", onSelect)
118 |       }
119 |     }, [api, onSelect])
120 | 
121 |     return (
122 |       <CarouselContext.Provider
123 |         value={{
124 |           carouselRef,
125 |           api: api,
126 |           opts,
127 |           orientation:
128 |             orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
129 |           scrollPrev,
130 |           scrollNext,
131 |           canScrollPrev,
132 |           canScrollNext,
133 |         }}
134 |       >
135 |         <div
136 |           ref={ref}
137 |           onKeyDownCapture={handleKeyDown}
138 |           className={cn("relative", className)}
139 |           role="region"
140 |           aria-roledescription="carousel"
141 |           {...props}
142 |         >
143 |           {children}
144 |         </div>
145 |       </CarouselContext.Provider>
146 |     )
147 |   }
148 | )
149 | Carousel.displayName = "Carousel"
150 | 
151 | const CarouselContent = React.forwardRef<
152 |   HTMLDivElement,
153 |   React.HTMLAttributes<HTMLDivElement>
154 | >(({ className, ...props }, ref) => {
155 |   const { carouselRef, orientation } = useCarousel()
156 | 
157 |   return (
158 |     <div ref={carouselRef} className="overflow-hidden">
159 |       <div
160 |         ref={ref}
161 |         className={cn(
162 |           "flex",
163 |           orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
164 |           className
165 |         )}
166 |         {...props}
167 |       />
168 |     </div>
169 |   )
170 | })
171 | CarouselContent.displayName = "CarouselContent"
172 | 
173 | const CarouselItem = React.forwardRef<
174 |   HTMLDivElement,
175 |   React.HTMLAttributes<HTMLDivElement>
176 | >(({ className, ...props }, ref) => {
177 |   const { orientation } = useCarousel()
178 | 
179 |   return (
180 |     <div
181 |       ref={ref}
182 |       role="group"
183 |       aria-roledescription="slide"
184 |       className={cn(
185 |         "min-w-0 shrink-0 grow-0 basis-full",
186 |         orientation === "horizontal" ? "pl-4" : "pt-4",
187 |         className
188 |       )}
189 |       {...props}
190 |     />
191 |   )
192 | })
193 | CarouselItem.displayName = "CarouselItem"
194 | 
195 | const CarouselPrevious = React.forwardRef<
196 |   HTMLButtonElement,
197 |   React.ComponentProps<typeof Button>
198 | >(({ className, variant = "outline", size = "icon", ...props }, ref) => {
199 |   const { orientation, scrollPrev, canScrollPrev } = useCarousel()
200 | 
201 |   return (
202 |     <Button
203 |       ref={ref}
204 |       variant={variant}
205 |       size={size}
206 |       className={cn(
207 |         "absolute  h-8 w-8 rounded-full",
208 |         orientation === "horizontal"
209 |           ? "-left-12 top-1/2 -translate-y-1/2"
210 |           : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
211 |         className
212 |       )}
213 |       disabled={!canScrollPrev}
214 |       onClick={scrollPrev}
215 |       {...props}
216 |     >
217 |       <ArrowLeft className="h-4 w-4" />
218 |       <span className="sr-only">Previous slide</span>
219 |     </Button>
220 |   )
221 | })
222 | CarouselPrevious.displayName = "CarouselPrevious"
223 | 
224 | const CarouselNext = React.forwardRef<
225 |   HTMLButtonElement,
226 |   React.ComponentProps<typeof Button>
227 | >(({ className, variant = "outline", size = "icon", ...props }, ref) => {
228 |   const { orientation, scrollNext, canScrollNext } = useCarousel()
229 | 
230 |   return (
231 |     <Button
232 |       ref={ref}
233 |       variant={variant}
234 |       size={size}
235 |       className={cn(
236 |         "absolute h-8 w-8 rounded-full",
237 |         orientation === "horizontal"
238 |           ? "-right-12 top-1/2 -translate-y-1/2"
239 |           : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
240 |         className
241 |       )}
242 |       disabled={!canScrollNext}
243 |       onClick={scrollNext}
244 |       {...props}
245 |     >
246 |       <ArrowRight className="h-4 w-4" />
247 |       <span className="sr-only">Next slide</span>
248 |     </Button>
249 |   )
250 | })
251 | CarouselNext.displayName = "CarouselNext"
252 | 
253 | export {
254 |   type CarouselApi,
255 |   Carousel,
256 |   CarouselContent,
257 |   CarouselItem,
258 |   CarouselPrevious,
259 |   CarouselNext,
260 | }
```

src/components/ui/chart.tsx
```
1 | import * as React from "react"
2 | import * as RechartsPrimitive from "recharts"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | // Format: { THEME_NAME: CSS_SELECTOR }
7 | const THEMES = { light: "", dark: ".dark" } as const
8 | 
9 | export type ChartConfig = {
10 |   [k in string]: {
11 |     label?: React.ReactNode
12 |     icon?: React.ComponentType
13 |   } & (
14 |     | { color?: string; theme?: never }
15 |     | { color?: never; theme: Record<keyof typeof THEMES, string> }
16 |   )
17 | }
18 | 
19 | type ChartContextProps = {
20 |   config: ChartConfig
21 | }
22 | 
23 | const ChartContext = React.createContext<ChartContextProps | null>(null)
24 | 
25 | function useChart() {
26 |   const context = React.useContext(ChartContext)
27 | 
28 |   if (!context) {
29 |     throw new Error("useChart must be used within a <ChartContainer />")
30 |   }
31 | 
32 |   return context
33 | }
34 | 
35 | const ChartContainer = React.forwardRef<
36 |   HTMLDivElement,
37 |   React.ComponentProps<"div"> & {
38 |     config: ChartConfig
39 |     children: React.ComponentProps<
40 |       typeof RechartsPrimitive.ResponsiveContainer
41 |     >["children"]
42 |   }
43 | >(({ id, className, children, config, ...props }, ref) => {
44 |   const uniqueId = React.useId()
45 |   const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`
46 | 
47 |   return (
48 |     <ChartContext.Provider value={{ config }}>
49 |       <div
50 |         data-chart={chartId}
51 |         ref={ref}
52 |         className={cn(
53 |           "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
54 |           className
55 |         )}
56 |         {...props}
57 |       >
58 |         <ChartStyle id={chartId} config={config} />
59 |         <RechartsPrimitive.ResponsiveContainer>
60 |           {children}
61 |         </RechartsPrimitive.ResponsiveContainer>
62 |       </div>
63 |     </ChartContext.Provider>
64 |   )
65 | })
66 | ChartContainer.displayName = "Chart"
67 | 
68 | const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
69 |   const colorConfig = Object.entries(config).filter(
70 |     ([_, config]) => config.theme || config.color
71 |   )
72 | 
73 |   if (!colorConfig.length) {
74 |     return null
75 |   }
76 | 
77 |   return (
78 |     <style
79 |       dangerouslySetInnerHTML={{
80 |         __html: Object.entries(THEMES)
81 |           .map(
82 |             ([theme, prefix]) => `
83 | ${prefix} [data-chart=${id}] {
84 | ${colorConfig
85 |   .map(([key, itemConfig]) => {
86 |     const color =
87 |       itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
88 |       itemConfig.color
89 |     return color ? `  --color-${key}: ${color};` : null
90 |   })
91 |   .join("\n")}
92 | }
93 | `
94 |           )
95 |           .join("\n"),
96 |       }}
97 |     />
98 |   )
99 | }
100 | 
101 | const ChartTooltip = RechartsPrimitive.Tooltip
102 | 
103 | const ChartTooltipContent = React.forwardRef<
104 |   HTMLDivElement,
105 |   React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
106 |     React.ComponentProps<"div"> & {
107 |       hideLabel?: boolean
108 |       hideIndicator?: boolean
109 |       indicator?: "line" | "dot" | "dashed"
110 |       nameKey?: string
111 |       labelKey?: string
112 |     }
113 | >(
114 |   (
115 |     {
116 |       active,
117 |       payload,
118 |       className,
119 |       indicator = "dot",
120 |       hideLabel = false,
121 |       hideIndicator = false,
122 |       label,
123 |       labelFormatter,
124 |       labelClassName,
125 |       formatter,
126 |       color,
127 |       nameKey,
128 |       labelKey,
129 |     },
130 |     ref
131 |   ) => {
132 |     const { config } = useChart()
133 | 
134 |     const tooltipLabel = React.useMemo(() => {
135 |       if (hideLabel || !payload?.length) {
136 |         return null
137 |       }
138 | 
139 |       const [item] = payload
140 |       const key = `${labelKey || item.dataKey || item.name || "value"}`
141 |       const itemConfig = getPayloadConfigFromPayload(config, item, key)
142 |       const value =
143 |         !labelKey && typeof label === "string"
144 |           ? config[label as keyof typeof config]?.label || label
145 |           : itemConfig?.label
146 | 
147 |       if (labelFormatter) {
148 |         return (
149 |           <div className={cn("font-medium", labelClassName)}>
150 |             {labelFormatter(value, payload)}
151 |           </div>
152 |         )
153 |       }
154 | 
155 |       if (!value) {
156 |         return null
157 |       }
158 | 
159 |       return <div className={cn("font-medium", labelClassName)}>{value}</div>
160 |     }, [
161 |       label,
162 |       labelFormatter,
163 |       payload,
164 |       hideLabel,
165 |       labelClassName,
166 |       config,
167 |       labelKey,
168 |     ])
169 | 
170 |     if (!active || !payload?.length) {
171 |       return null
172 |     }
173 | 
174 |     const nestLabel = payload.length === 1 && indicator !== "dot"
175 | 
176 |     return (
177 |       <div
178 |         ref={ref}
179 |         className={cn(
180 |           "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
181 |           className
182 |         )}
183 |       >
184 |         {!nestLabel ? tooltipLabel : null}
185 |         <div className="grid gap-1.5">
186 |           {payload.map((item, index) => {
187 |             const key = `${nameKey || item.name || item.dataKey || "value"}`
188 |             const itemConfig = getPayloadConfigFromPayload(config, item, key)
189 |             const indicatorColor = color || item.payload.fill || item.color
190 | 
191 |             return (
192 |               <div
193 |                 key={item.dataKey}
194 |                 className={cn(
195 |                   "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
196 |                   indicator === "dot" && "items-center"
197 |                 )}
198 |               >
199 |                 {formatter && item?.value !== undefined && item.name ? (
200 |                   formatter(item.value, item.name, item, index, item.payload)
201 |                 ) : (
202 |                   <>
203 |                     {itemConfig?.icon ? (
204 |                       <itemConfig.icon />
205 |                     ) : (
206 |                       !hideIndicator && (
207 |                         <div
208 |                           className={cn(
209 |                             "shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",
210 |                             {
211 |                               "h-2.5 w-2.5": indicator === "dot",
212 |                               "w-1": indicator === "line",
213 |                               "w-0 border-[1.5px] border-dashed bg-transparent":
214 |                                 indicator === "dashed",
215 |                               "my-0.5": nestLabel && indicator === "dashed",
216 |                             }
217 |                           )}
218 |                           style={
219 |                             {
220 |                               "--color-bg": indicatorColor,
221 |                               "--color-border": indicatorColor,
222 |                             } as React.CSSProperties
223 |                           }
224 |                         />
225 |                       )
226 |                     )}
227 |                     <div
228 |                       className={cn(
229 |                         "flex flex-1 justify-between leading-none",
230 |                         nestLabel ? "items-end" : "items-center"
231 |                       )}
232 |                     >
233 |                       <div className="grid gap-1.5">
234 |                         {nestLabel ? tooltipLabel : null}
235 |                         <span className="text-muted-foreground">
236 |                           {itemConfig?.label || item.name}
237 |                         </span>
238 |                       </div>
239 |                       {item.value && (
240 |                         <span className="font-mono font-medium tabular-nums text-foreground">
241 |                           {item.value.toLocaleString()}
242 |                         </span>
243 |                       )}
244 |                     </div>
245 |                   </>
246 |                 )}
247 |               </div>
248 |             )
249 |           })}
250 |         </div>
251 |       </div>
252 |     )
253 |   }
254 | )
255 | ChartTooltipContent.displayName = "ChartTooltip"
256 | 
257 | const ChartLegend = RechartsPrimitive.Legend
258 | 
259 | const ChartLegendContent = React.forwardRef<
260 |   HTMLDivElement,
261 |   React.ComponentProps<"div"> &
262 |     Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
263 |       hideIcon?: boolean
264 |       nameKey?: string
265 |     }
266 | >(
267 |   (
268 |     { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
269 |     ref
270 |   ) => {
271 |     const { config } = useChart()
272 | 
273 |     if (!payload?.length) {
274 |       return null
275 |     }
276 | 
277 |     return (
278 |       <div
279 |         ref={ref}
280 |         className={cn(
281 |           "flex items-center justify-center gap-4",
282 |           verticalAlign === "top" ? "pb-3" : "pt-3",
283 |           className
284 |         )}
285 |       >
286 |         {payload.map((item) => {
287 |           const key = `${nameKey || item.dataKey || "value"}`
288 |           const itemConfig = getPayloadConfigFromPayload(config, item, key)
289 | 
290 |           return (
291 |             <div
292 |               key={item.value}
293 |               className={cn(
294 |                 "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
295 |               )}
296 |             >
297 |               {itemConfig?.icon && !hideIcon ? (
298 |                 <itemConfig.icon />
299 |               ) : (
300 |                 <div
301 |                   className="h-2 w-2 shrink-0 rounded-[2px]"
302 |                   style={{
303 |                     backgroundColor: item.color,
304 |                   }}
305 |                 />
306 |               )}
307 |               {itemConfig?.label}
308 |             </div>
309 |           )
310 |         })}
311 |       </div>
312 |     )
313 |   }
314 | )
315 | ChartLegendContent.displayName = "ChartLegend"
316 | 
317 | // Helper to extract item config from a payload.
318 | function getPayloadConfigFromPayload(
319 |   config: ChartConfig,
320 |   payload: unknown,
321 |   key: string
322 | ) {
323 |   if (typeof payload !== "object" || payload === null) {
324 |     return undefined
325 |   }
326 | 
327 |   const payloadPayload =
328 |     "payload" in payload &&
329 |     typeof payload.payload === "object" &&
330 |     payload.payload !== null
331 |       ? payload.payload
332 |       : undefined
333 | 
334 |   let configLabelKey: string = key
335 | 
336 |   if (
337 |     key in payload &&
338 |     typeof payload[key as keyof typeof payload] === "string"
339 |   ) {
340 |     configLabelKey = payload[key as keyof typeof payload] as string
341 |   } else if (
342 |     payloadPayload &&
343 |     key in payloadPayload &&
344 |     typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
345 |   ) {
346 |     configLabelKey = payloadPayload[
347 |       key as keyof typeof payloadPayload
348 |     ] as string
349 |   }
350 | 
351 |   return configLabelKey in config
352 |     ? config[configLabelKey]
353 |     : config[key as keyof typeof config]
354 | }
355 | 
356 | export {
357 |   ChartContainer,
358 |   ChartTooltip,
359 |   ChartTooltipContent,
360 |   ChartLegend,
361 |   ChartLegendContent,
362 |   ChartStyle,
363 | }
```

src/components/ui/checkbox.tsx
```
1 | import * as React from "react"
2 | import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
3 | import { Check } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const Checkbox = React.forwardRef<
8 |   React.ElementRef<typeof CheckboxPrimitive.Root>,
9 |   React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
10 | >(({ className, ...props }, ref) => (
11 |   <CheckboxPrimitive.Root
12 |     ref={ref}
13 |     className={cn(
14 |       "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
15 |       className
16 |     )}
17 |     {...props}
18 |   >
19 |     <CheckboxPrimitive.Indicator
20 |       className={cn("flex items-center justify-center text-current")}
21 |     >
22 |       <Check className="h-4 w-4" />
23 |     </CheckboxPrimitive.Indicator>
24 |   </CheckboxPrimitive.Root>
25 | ))
26 | Checkbox.displayName = CheckboxPrimitive.Root.displayName
27 | 
28 | export { Checkbox }
```

src/components/ui/collapsible.tsx
```
1 | import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"
2 | 
3 | const Collapsible = CollapsiblePrimitive.Root
4 | 
5 | const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger
6 | 
7 | const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent
8 | 
9 | export { Collapsible, CollapsibleTrigger, CollapsibleContent }
```

src/components/ui/command.tsx
```
1 | import * as React from "react"
2 | import { type DialogProps } from "@radix-ui/react-dialog"
3 | import { Command as CommandPrimitive } from "cmdk"
4 | import { Search } from "lucide-react"
5 | 
6 | import { cn } from "@/lib/utils"
7 | import { Dialog, DialogContent } from "@/components/ui/dialog"
8 | 
9 | const Command = React.forwardRef<
10 |   React.ElementRef<typeof CommandPrimitive>,
11 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive>
12 | >(({ className, ...props }, ref) => (
13 |   <CommandPrimitive
14 |     ref={ref}
15 |     className={cn(
16 |       "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
17 |       className
18 |     )}
19 |     {...props}
20 |   />
21 | ))
22 | Command.displayName = CommandPrimitive.displayName
23 | 
24 | interface CommandDialogProps extends DialogProps {}
25 | 
26 | const CommandDialog = ({ children, ...props }: CommandDialogProps) => {
27 |   return (
28 |     <Dialog {...props}>
29 |       <DialogContent className="overflow-hidden p-0 shadow-lg">
30 |         <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
31 |           {children}
32 |         </Command>
33 |       </DialogContent>
34 |     </Dialog>
35 |   )
36 | }
37 | 
38 | const CommandInput = React.forwardRef<
39 |   React.ElementRef<typeof CommandPrimitive.Input>,
40 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
41 | >(({ className, ...props }, ref) => (
42 |   <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
43 |     <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
44 |     <CommandPrimitive.Input
45 |       ref={ref}
46 |       className={cn(
47 |         "flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
48 |         className
49 |       )}
50 |       {...props}
51 |     />
52 |   </div>
53 | ))
54 | 
55 | CommandInput.displayName = CommandPrimitive.Input.displayName
56 | 
57 | const CommandList = React.forwardRef<
58 |   React.ElementRef<typeof CommandPrimitive.List>,
59 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
60 | >(({ className, ...props }, ref) => (
61 |   <CommandPrimitive.List
62 |     ref={ref}
63 |     className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
64 |     {...props}
65 |   />
66 | ))
67 | 
68 | CommandList.displayName = CommandPrimitive.List.displayName
69 | 
70 | const CommandEmpty = React.forwardRef<
71 |   React.ElementRef<typeof CommandPrimitive.Empty>,
72 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
73 | >((props, ref) => (
74 |   <CommandPrimitive.Empty
75 |     ref={ref}
76 |     className="py-6 text-center text-sm"
77 |     {...props}
78 |   />
79 | ))
80 | 
81 | CommandEmpty.displayName = CommandPrimitive.Empty.displayName
82 | 
83 | const CommandGroup = React.forwardRef<
84 |   React.ElementRef<typeof CommandPrimitive.Group>,
85 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
86 | >(({ className, ...props }, ref) => (
87 |   <CommandPrimitive.Group
88 |     ref={ref}
89 |     className={cn(
90 |       "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
91 |       className
92 |     )}
93 |     {...props}
94 |   />
95 | ))
96 | 
97 | CommandGroup.displayName = CommandPrimitive.Group.displayName
98 | 
99 | const CommandSeparator = React.forwardRef<
100 |   React.ElementRef<typeof CommandPrimitive.Separator>,
101 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
102 | >(({ className, ...props }, ref) => (
103 |   <CommandPrimitive.Separator
104 |     ref={ref}
105 |     className={cn("-mx-1 h-px bg-border", className)}
106 |     {...props}
107 |   />
108 | ))
109 | CommandSeparator.displayName = CommandPrimitive.Separator.displayName
110 | 
111 | const CommandItem = React.forwardRef<
112 |   React.ElementRef<typeof CommandPrimitive.Item>,
113 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
114 | >(({ className, ...props }, ref) => (
115 |   <CommandPrimitive.Item
116 |     ref={ref}
117 |     className={cn(
118 |       "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",
119 |       className
120 |     )}
121 |     {...props}
122 |   />
123 | ))
124 | 
125 | CommandItem.displayName = CommandPrimitive.Item.displayName
126 | 
127 | const CommandShortcut = ({
128 |   className,
129 |   ...props
130 | }: React.HTMLAttributes<HTMLSpanElement>) => {
131 |   return (
132 |     <span
133 |       className={cn(
134 |         "ml-auto text-xs tracking-widest text-muted-foreground",
135 |         className
136 |       )}
137 |       {...props}
138 |     />
139 |   )
140 | }
141 | CommandShortcut.displayName = "CommandShortcut"
142 | 
143 | export {
144 |   Command,
145 |   CommandDialog,
146 |   CommandInput,
147 |   CommandList,
148 |   CommandEmpty,
149 |   CommandGroup,
150 |   CommandItem,
151 |   CommandShortcut,
152 |   CommandSeparator,
153 | }
```

src/components/ui/context-menu.tsx
```
1 | import * as React from "react"
2 | import * as ContextMenuPrimitive from "@radix-ui/react-context-menu"
3 | import { Check, ChevronRight, Circle } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const ContextMenu = ContextMenuPrimitive.Root
8 | 
9 | const ContextMenuTrigger = ContextMenuPrimitive.Trigger
10 | 
11 | const ContextMenuGroup = ContextMenuPrimitive.Group
12 | 
13 | const ContextMenuPortal = ContextMenuPrimitive.Portal
14 | 
15 | const ContextMenuSub = ContextMenuPrimitive.Sub
16 | 
17 | const ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup
18 | 
19 | const ContextMenuSubTrigger = React.forwardRef<
20 |   React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,
21 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {
22 |     inset?: boolean
23 |   }
24 | >(({ className, inset, children, ...props }, ref) => (
25 |   <ContextMenuPrimitive.SubTrigger
26 |     ref={ref}
27 |     className={cn(
28 |       "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
29 |       inset && "pl-8",
30 |       className
31 |     )}
32 |     {...props}
33 |   >
34 |     {children}
35 |     <ChevronRight className="ml-auto h-4 w-4" />
36 |   </ContextMenuPrimitive.SubTrigger>
37 | ))
38 | ContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName
39 | 
40 | const ContextMenuSubContent = React.forwardRef<
41 |   React.ElementRef<typeof ContextMenuPrimitive.SubContent>,
42 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>
43 | >(({ className, ...props }, ref) => (
44 |   <ContextMenuPrimitive.SubContent
45 |     ref={ref}
46 |     className={cn(
47 |       "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
48 |       className
49 |     )}
50 |     {...props}
51 |   />
52 | ))
53 | ContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName
54 | 
55 | const ContextMenuContent = React.forwardRef<
56 |   React.ElementRef<typeof ContextMenuPrimitive.Content>,
57 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>
58 | >(({ className, ...props }, ref) => (
59 |   <ContextMenuPrimitive.Portal>
60 |     <ContextMenuPrimitive.Content
61 |       ref={ref}
62 |       className={cn(
63 |         "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
64 |         className
65 |       )}
66 |       {...props}
67 |     />
68 |   </ContextMenuPrimitive.Portal>
69 | ))
70 | ContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName
71 | 
72 | const ContextMenuItem = React.forwardRef<
73 |   React.ElementRef<typeof ContextMenuPrimitive.Item>,
74 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {
75 |     inset?: boolean
76 |   }
77 | >(({ className, inset, ...props }, ref) => (
78 |   <ContextMenuPrimitive.Item
79 |     ref={ref}
80 |     className={cn(
81 |       "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
82 |       inset && "pl-8",
83 |       className
84 |     )}
85 |     {...props}
86 |   />
87 | ))
88 | ContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName
89 | 
90 | const ContextMenuCheckboxItem = React.forwardRef<
91 |   React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,
92 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>
93 | >(({ className, children, checked, ...props }, ref) => (
94 |   <ContextMenuPrimitive.CheckboxItem
95 |     ref={ref}
96 |     className={cn(
97 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
98 |       className
99 |     )}
100 |     checked={checked}
101 |     {...props}
102 |   >
103 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
104 |       <ContextMenuPrimitive.ItemIndicator>
105 |         <Check className="h-4 w-4" />
106 |       </ContextMenuPrimitive.ItemIndicator>
107 |     </span>
108 |     {children}
109 |   </ContextMenuPrimitive.CheckboxItem>
110 | ))
111 | ContextMenuCheckboxItem.displayName =
112 |   ContextMenuPrimitive.CheckboxItem.displayName
113 | 
114 | const ContextMenuRadioItem = React.forwardRef<
115 |   React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,
116 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>
117 | >(({ className, children, ...props }, ref) => (
118 |   <ContextMenuPrimitive.RadioItem
119 |     ref={ref}
120 |     className={cn(
121 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
122 |       className
123 |     )}
124 |     {...props}
125 |   >
126 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
127 |       <ContextMenuPrimitive.ItemIndicator>
128 |         <Circle className="h-2 w-2 fill-current" />
129 |       </ContextMenuPrimitive.ItemIndicator>
130 |     </span>
131 |     {children}
132 |   </ContextMenuPrimitive.RadioItem>
133 | ))
134 | ContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName
135 | 
136 | const ContextMenuLabel = React.forwardRef<
137 |   React.ElementRef<typeof ContextMenuPrimitive.Label>,
138 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {
139 |     inset?: boolean
140 |   }
141 | >(({ className, inset, ...props }, ref) => (
142 |   <ContextMenuPrimitive.Label
143 |     ref={ref}
144 |     className={cn(
145 |       "px-2 py-1.5 text-sm font-semibold text-foreground",
146 |       inset && "pl-8",
147 |       className
148 |     )}
149 |     {...props}
150 |   />
151 | ))
152 | ContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName
153 | 
154 | const ContextMenuSeparator = React.forwardRef<
155 |   React.ElementRef<typeof ContextMenuPrimitive.Separator>,
156 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>
157 | >(({ className, ...props }, ref) => (
158 |   <ContextMenuPrimitive.Separator
159 |     ref={ref}
160 |     className={cn("-mx-1 my-1 h-px bg-border", className)}
161 |     {...props}
162 |   />
163 | ))
164 | ContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName
165 | 
166 | const ContextMenuShortcut = ({
167 |   className,
168 |   ...props
169 | }: React.HTMLAttributes<HTMLSpanElement>) => {
170 |   return (
171 |     <span
172 |       className={cn(
173 |         "ml-auto text-xs tracking-widest text-muted-foreground",
174 |         className
175 |       )}
176 |       {...props}
177 |     />
178 |   )
179 | }
180 | ContextMenuShortcut.displayName = "ContextMenuShortcut"
181 | 
182 | export {
183 |   ContextMenu,
184 |   ContextMenuTrigger,
185 |   ContextMenuContent,
186 |   ContextMenuItem,
187 |   ContextMenuCheckboxItem,
188 |   ContextMenuRadioItem,
189 |   ContextMenuLabel,
190 |   ContextMenuSeparator,
191 |   ContextMenuShortcut,
192 |   ContextMenuGroup,
193 |   ContextMenuPortal,
194 |   ContextMenuSub,
195 |   ContextMenuSubContent,
196 |   ContextMenuSubTrigger,
197 |   ContextMenuRadioGroup,
198 | }
```

src/components/ui/dialog.tsx
```
1 | import * as React from "react"
2 | import * as DialogPrimitive from "@radix-ui/react-dialog"
3 | import { X } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const Dialog = DialogPrimitive.Root
8 | 
9 | const DialogTrigger = DialogPrimitive.Trigger
10 | 
11 | const DialogPortal = DialogPrimitive.Portal
12 | 
13 | const DialogClose = DialogPrimitive.Close
14 | 
15 | const DialogOverlay = React.forwardRef<
16 |   React.ElementRef<typeof DialogPrimitive.Overlay>,
17 |   React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
18 | >(({ className, ...props }, ref) => (
19 |   <DialogPrimitive.Overlay
20 |     ref={ref}
21 |     className={cn(
22 |       "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
23 |       className
24 |     )}
25 |     {...props}
26 |   />
27 | ))
28 | DialogOverlay.displayName = DialogPrimitive.Overlay.displayName
29 | 
30 | const DialogContent = React.forwardRef<
31 |   React.ElementRef<typeof DialogPrimitive.Content>,
32 |   React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
33 | >(({ className, children, ...props }, ref) => (
34 |   <DialogPortal>
35 |     <DialogOverlay />
36 |     <DialogPrimitive.Content
37 |       ref={ref}
38 |       className={cn(
39 |         "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
40 |         className
41 |       )}
42 |       {...props}
43 |     >
44 |       {children}
45 |       <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
46 |         <X className="h-4 w-4" />
47 |         <span className="sr-only">Close</span>
48 |       </DialogPrimitive.Close>
49 |     </DialogPrimitive.Content>
50 |   </DialogPortal>
51 | ))
52 | DialogContent.displayName = DialogPrimitive.Content.displayName
53 | 
54 | const DialogHeader = ({
55 |   className,
56 |   ...props
57 | }: React.HTMLAttributes<HTMLDivElement>) => (
58 |   <div
59 |     className={cn(
60 |       "flex flex-col space-y-1.5 text-center sm:text-left",
61 |       className
62 |     )}
63 |     {...props}
64 |   />
65 | )
66 | DialogHeader.displayName = "DialogHeader"
67 | 
68 | const DialogFooter = ({
69 |   className,
70 |   ...props
71 | }: React.HTMLAttributes<HTMLDivElement>) => (
72 |   <div
73 |     className={cn(
74 |       "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
75 |       className
76 |     )}
77 |     {...props}
78 |   />
79 | )
80 | DialogFooter.displayName = "DialogFooter"
81 | 
82 | const DialogTitle = React.forwardRef<
83 |   React.ElementRef<typeof DialogPrimitive.Title>,
84 |   React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
85 | >(({ className, ...props }, ref) => (
86 |   <DialogPrimitive.Title
87 |     ref={ref}
88 |     className={cn(
89 |       "text-lg font-semibold leading-none tracking-tight",
90 |       className
91 |     )}
92 |     {...props}
93 |   />
94 | ))
95 | DialogTitle.displayName = DialogPrimitive.Title.displayName
96 | 
97 | const DialogDescription = React.forwardRef<
98 |   React.ElementRef<typeof DialogPrimitive.Description>,
99 |   React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
100 | >(({ className, ...props }, ref) => (
101 |   <DialogPrimitive.Description
102 |     ref={ref}
103 |     className={cn("text-sm text-muted-foreground", className)}
104 |     {...props}
105 |   />
106 | ))
107 | DialogDescription.displayName = DialogPrimitive.Description.displayName
108 | 
109 | export {
110 |   Dialog,
111 |   DialogPortal,
112 |   DialogOverlay,
113 |   DialogClose,
114 |   DialogTrigger,
115 |   DialogContent,
116 |   DialogHeader,
117 |   DialogFooter,
118 |   DialogTitle,
119 |   DialogDescription,
120 | }
```

src/components/ui/drawer.tsx
```
1 | import * as React from "react"
2 | import { Drawer as DrawerPrimitive } from "vaul"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Drawer = ({
7 |   shouldScaleBackground = true,
8 |   ...props
9 | }: React.ComponentProps<typeof DrawerPrimitive.Root>) => (
10 |   <DrawerPrimitive.Root
11 |     shouldScaleBackground={shouldScaleBackground}
12 |     {...props}
13 |   />
14 | )
15 | Drawer.displayName = "Drawer"
16 | 
17 | const DrawerTrigger = DrawerPrimitive.Trigger
18 | 
19 | const DrawerPortal = DrawerPrimitive.Portal
20 | 
21 | const DrawerClose = DrawerPrimitive.Close
22 | 
23 | const DrawerOverlay = React.forwardRef<
24 |   React.ElementRef<typeof DrawerPrimitive.Overlay>,
25 |   React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>
26 | >(({ className, ...props }, ref) => (
27 |   <DrawerPrimitive.Overlay
28 |     ref={ref}
29 |     className={cn("fixed inset-0 z-50 bg-black/80", className)}
30 |     {...props}
31 |   />
32 | ))
33 | DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName
34 | 
35 | const DrawerContent = React.forwardRef<
36 |   React.ElementRef<typeof DrawerPrimitive.Content>,
37 |   React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>
38 | >(({ className, children, ...props }, ref) => (
39 |   <DrawerPortal>
40 |     <DrawerOverlay />
41 |     <DrawerPrimitive.Content
42 |       ref={ref}
43 |       className={cn(
44 |         "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
45 |         className
46 |       )}
47 |       {...props}
48 |     >
49 |       <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
50 |       {children}
51 |     </DrawerPrimitive.Content>
52 |   </DrawerPortal>
53 | ))
54 | DrawerContent.displayName = "DrawerContent"
55 | 
56 | const DrawerHeader = ({
57 |   className,
58 |   ...props
59 | }: React.HTMLAttributes<HTMLDivElement>) => (
60 |   <div
61 |     className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)}
62 |     {...props}
63 |   />
64 | )
65 | DrawerHeader.displayName = "DrawerHeader"
66 | 
67 | const DrawerFooter = ({
68 |   className,
69 |   ...props
70 | }: React.HTMLAttributes<HTMLDivElement>) => (
71 |   <div
72 |     className={cn("mt-auto flex flex-col gap-2 p-4", className)}
73 |     {...props}
74 |   />
75 | )
76 | DrawerFooter.displayName = "DrawerFooter"
77 | 
78 | const DrawerTitle = React.forwardRef<
79 |   React.ElementRef<typeof DrawerPrimitive.Title>,
80 |   React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>
81 | >(({ className, ...props }, ref) => (
82 |   <DrawerPrimitive.Title
83 |     ref={ref}
84 |     className={cn(
85 |       "text-lg font-semibold leading-none tracking-tight",
86 |       className
87 |     )}
88 |     {...props}
89 |   />
90 | ))
91 | DrawerTitle.displayName = DrawerPrimitive.Title.displayName
92 | 
93 | const DrawerDescription = React.forwardRef<
94 |   React.ElementRef<typeof DrawerPrimitive.Description>,
95 |   React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>
96 | >(({ className, ...props }, ref) => (
97 |   <DrawerPrimitive.Description
98 |     ref={ref}
99 |     className={cn("text-sm text-muted-foreground", className)}
100 |     {...props}
101 |   />
102 | ))
103 | DrawerDescription.displayName = DrawerPrimitive.Description.displayName
104 | 
105 | export {
106 |   Drawer,
107 |   DrawerPortal,
108 |   DrawerOverlay,
109 |   DrawerTrigger,
110 |   DrawerClose,
111 |   DrawerContent,
112 |   DrawerHeader,
113 |   DrawerFooter,
114 |   DrawerTitle,
115 |   DrawerDescription,
116 | }
```

src/components/ui/dropdown-menu.tsx
```
1 | import * as React from "react"
2 | import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
3 | import { Check, ChevronRight, Circle } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const DropdownMenu = DropdownMenuPrimitive.Root
8 | 
9 | const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger
10 | 
11 | const DropdownMenuGroup = DropdownMenuPrimitive.Group
12 | 
13 | const DropdownMenuPortal = DropdownMenuPrimitive.Portal
14 | 
15 | const DropdownMenuSub = DropdownMenuPrimitive.Sub
16 | 
17 | const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup
18 | 
19 | const DropdownMenuSubTrigger = React.forwardRef<
20 |   React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
21 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
22 |     inset?: boolean
23 |   }
24 | >(({ className, inset, children, ...props }, ref) => (
25 |   <DropdownMenuPrimitive.SubTrigger
26 |     ref={ref}
27 |     className={cn(
28 |       "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",
29 |       inset && "pl-8",
30 |       className
31 |     )}
32 |     {...props}
33 |   >
34 |     {children}
35 |     <ChevronRight className="ml-auto h-4 w-4" />
36 |   </DropdownMenuPrimitive.SubTrigger>
37 | ))
38 | DropdownMenuSubTrigger.displayName =
39 |   DropdownMenuPrimitive.SubTrigger.displayName
40 | 
41 | const DropdownMenuSubContent = React.forwardRef<
42 |   React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
43 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
44 | >(({ className, ...props }, ref) => (
45 |   <DropdownMenuPrimitive.SubContent
46 |     ref={ref}
47 |     className={cn(
48 |       "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
49 |       className
50 |     )}
51 |     {...props}
52 |   />
53 | ))
54 | DropdownMenuSubContent.displayName =
55 |   DropdownMenuPrimitive.SubContent.displayName
56 | 
57 | const DropdownMenuContent = React.forwardRef<
58 |   React.ElementRef<typeof DropdownMenuPrimitive.Content>,
59 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
60 | >(({ className, sideOffset = 4, ...props }, ref) => (
61 |   <DropdownMenuPrimitive.Portal>
62 |     <DropdownMenuPrimitive.Content
63 |       ref={ref}
64 |       sideOffset={sideOffset}
65 |       className={cn(
66 |         "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
67 |         className
68 |       )}
69 |       {...props}
70 |     />
71 |   </DropdownMenuPrimitive.Portal>
72 | ))
73 | DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName
74 | 
75 | const DropdownMenuItem = React.forwardRef<
76 |   React.ElementRef<typeof DropdownMenuPrimitive.Item>,
77 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
78 |     inset?: boolean
79 |   }
80 | >(({ className, inset, ...props }, ref) => (
81 |   <DropdownMenuPrimitive.Item
82 |     ref={ref}
83 |     className={cn(
84 |       "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
85 |       inset && "pl-8",
86 |       className
87 |     )}
88 |     {...props}
89 |   />
90 | ))
91 | DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName
92 | 
93 | const DropdownMenuCheckboxItem = React.forwardRef<
94 |   React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
95 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
96 | >(({ className, children, checked, ...props }, ref) => (
97 |   <DropdownMenuPrimitive.CheckboxItem
98 |     ref={ref}
99 |     className={cn(
100 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
101 |       className
102 |     )}
103 |     checked={checked}
104 |     {...props}
105 |   >
106 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
107 |       <DropdownMenuPrimitive.ItemIndicator>
108 |         <Check className="h-4 w-4" />
109 |       </DropdownMenuPrimitive.ItemIndicator>
110 |     </span>
111 |     {children}
112 |   </DropdownMenuPrimitive.CheckboxItem>
113 | ))
114 | DropdownMenuCheckboxItem.displayName =
115 |   DropdownMenuPrimitive.CheckboxItem.displayName
116 | 
117 | const DropdownMenuRadioItem = React.forwardRef<
118 |   React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
119 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
120 | >(({ className, children, ...props }, ref) => (
121 |   <DropdownMenuPrimitive.RadioItem
122 |     ref={ref}
123 |     className={cn(
124 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
125 |       className
126 |     )}
127 |     {...props}
128 |   >
129 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
130 |       <DropdownMenuPrimitive.ItemIndicator>
131 |         <Circle className="h-2 w-2 fill-current" />
132 |       </DropdownMenuPrimitive.ItemIndicator>
133 |     </span>
134 |     {children}
135 |   </DropdownMenuPrimitive.RadioItem>
136 | ))
137 | DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName
138 | 
139 | const DropdownMenuLabel = React.forwardRef<
140 |   React.ElementRef<typeof DropdownMenuPrimitive.Label>,
141 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
142 |     inset?: boolean
143 |   }
144 | >(({ className, inset, ...props }, ref) => (
145 |   <DropdownMenuPrimitive.Label
146 |     ref={ref}
147 |     className={cn(
148 |       "px-2 py-1.5 text-sm font-semibold",
149 |       inset && "pl-8",
150 |       className
151 |     )}
152 |     {...props}
153 |   />
154 | ))
155 | DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName
156 | 
157 | const DropdownMenuSeparator = React.forwardRef<
158 |   React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
159 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
160 | >(({ className, ...props }, ref) => (
161 |   <DropdownMenuPrimitive.Separator
162 |     ref={ref}
163 |     className={cn("-mx-1 my-1 h-px bg-muted", className)}
164 |     {...props}
165 |   />
166 | ))
167 | DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName
168 | 
169 | const DropdownMenuShortcut = ({
170 |   className,
171 |   ...props
172 | }: React.HTMLAttributes<HTMLSpanElement>) => {
173 |   return (
174 |     <span
175 |       className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
176 |       {...props}
177 |     />
178 |   )
179 | }
180 | DropdownMenuShortcut.displayName = "DropdownMenuShortcut"
181 | 
182 | export {
183 |   DropdownMenu,
184 |   DropdownMenuTrigger,
185 |   DropdownMenuContent,
186 |   DropdownMenuItem,
187 |   DropdownMenuCheckboxItem,
188 |   DropdownMenuRadioItem,
189 |   DropdownMenuLabel,
190 |   DropdownMenuSeparator,
191 |   DropdownMenuShortcut,
192 |   DropdownMenuGroup,
193 |   DropdownMenuPortal,
194 |   DropdownMenuSub,
195 |   DropdownMenuSubContent,
196 |   DropdownMenuSubTrigger,
197 |   DropdownMenuRadioGroup,
198 | }
```

src/components/ui/form.tsx
```
1 | import * as React from "react"
2 | import * as LabelPrimitive from "@radix-ui/react-label"
3 | import { Slot } from "@radix-ui/react-slot"
4 | import {
5 |   Controller,
6 |   ControllerProps,
7 |   FieldPath,
8 |   FieldValues,
9 |   FormProvider,
10 |   useFormContext,
11 | } from "react-hook-form"
12 | 
13 | import { cn } from "@/lib/utils"
14 | import { Label } from "@/components/ui/label"
15 | 
16 | const Form = FormProvider
17 | 
18 | type FormFieldContextValue<
19 |   TFieldValues extends FieldValues = FieldValues,
20 |   TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
21 | > = {
22 |   name: TName
23 | }
24 | 
25 | const FormFieldContext = React.createContext<FormFieldContextValue>(
26 |   {} as FormFieldContextValue
27 | )
28 | 
29 | const FormField = <
30 |   TFieldValues extends FieldValues = FieldValues,
31 |   TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
32 | >({
33 |   ...props
34 | }: ControllerProps<TFieldValues, TName>) => {
35 |   return (
36 |     <FormFieldContext.Provider value={{ name: props.name }}>
37 |       <Controller {...props} />
38 |     </FormFieldContext.Provider>
39 |   )
40 | }
41 | 
42 | const useFormField = () => {
43 |   const fieldContext = React.useContext(FormFieldContext)
44 |   const itemContext = React.useContext(FormItemContext)
45 |   const { getFieldState, formState } = useFormContext()
46 | 
47 |   const fieldState = getFieldState(fieldContext.name, formState)
48 | 
49 |   if (!fieldContext) {
50 |     throw new Error("useFormField should be used within <FormField>")
51 |   }
52 | 
53 |   const { id } = itemContext
54 | 
55 |   return {
56 |     id,
57 |     name: fieldContext.name,
58 |     formItemId: `${id}-form-item`,
59 |     formDescriptionId: `${id}-form-item-description`,
60 |     formMessageId: `${id}-form-item-message`,
61 |     ...fieldState,
62 |   }
63 | }
64 | 
65 | type FormItemContextValue = {
66 |   id: string
67 | }
68 | 
69 | const FormItemContext = React.createContext<FormItemContextValue>(
70 |   {} as FormItemContextValue
71 | )
72 | 
73 | const FormItem = React.forwardRef<
74 |   HTMLDivElement,
75 |   React.HTMLAttributes<HTMLDivElement>
76 | >(({ className, ...props }, ref) => {
77 |   const id = React.useId()
78 | 
79 |   return (
80 |     <FormItemContext.Provider value={{ id }}>
81 |       <div ref={ref} className={cn("space-y-2", className)} {...props} />
82 |     </FormItemContext.Provider>
83 |   )
84 | })
85 | FormItem.displayName = "FormItem"
86 | 
87 | const FormLabel = React.forwardRef<
88 |   React.ElementRef<typeof LabelPrimitive.Root>,
89 |   React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
90 | >(({ className, ...props }, ref) => {
91 |   const { error, formItemId } = useFormField()
92 | 
93 |   return (
94 |     <Label
95 |       ref={ref}
96 |       className={cn(error && "text-destructive", className)}
97 |       htmlFor={formItemId}
98 |       {...props}
99 |     />
100 |   )
101 | })
102 | FormLabel.displayName = "FormLabel"
103 | 
104 | const FormControl = React.forwardRef<
105 |   React.ElementRef<typeof Slot>,
106 |   React.ComponentPropsWithoutRef<typeof Slot>
107 | >(({ ...props }, ref) => {
108 |   const { error, formItemId, formDescriptionId, formMessageId } = useFormField()
109 | 
110 |   return (
111 |     <Slot
112 |       ref={ref}
113 |       id={formItemId}
114 |       aria-describedby={
115 |         !error
116 |           ? `${formDescriptionId}`
117 |           : `${formDescriptionId} ${formMessageId}`
118 |       }
119 |       aria-invalid={!!error}
120 |       {...props}
121 |     />
122 |   )
123 | })
124 | FormControl.displayName = "FormControl"
125 | 
126 | const FormDescription = React.forwardRef<
127 |   HTMLParagraphElement,
128 |   React.HTMLAttributes<HTMLParagraphElement>
129 | >(({ className, ...props }, ref) => {
130 |   const { formDescriptionId } = useFormField()
131 | 
132 |   return (
133 |     <p
134 |       ref={ref}
135 |       id={formDescriptionId}
136 |       className={cn("text-sm text-muted-foreground", className)}
137 |       {...props}
138 |     />
139 |   )
140 | })
141 | FormDescription.displayName = "FormDescription"
142 | 
143 | const FormMessage = React.forwardRef<
144 |   HTMLParagraphElement,
145 |   React.HTMLAttributes<HTMLParagraphElement>
146 | >(({ className, children, ...props }, ref) => {
147 |   const { error, formMessageId } = useFormField()
148 |   const body = error ? String(error?.message) : children
149 | 
150 |   if (!body) {
151 |     return null
152 |   }
153 | 
154 |   return (
155 |     <p
156 |       ref={ref}
157 |       id={formMessageId}
158 |       className={cn("text-sm font-medium text-destructive", className)}
159 |       {...props}
160 |     >
161 |       {body}
162 |     </p>
163 |   )
164 | })
165 | FormMessage.displayName = "FormMessage"
166 | 
167 | export {
168 |   useFormField,
169 |   Form,
170 |   FormItem,
171 |   FormLabel,
172 |   FormControl,
173 |   FormDescription,
174 |   FormMessage,
175 |   FormField,
176 | }
```

src/components/ui/hover-card.tsx
```
1 | import * as React from "react"
2 | import * as HoverCardPrimitive from "@radix-ui/react-hover-card"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const HoverCard = HoverCardPrimitive.Root
7 | 
8 | const HoverCardTrigger = HoverCardPrimitive.Trigger
9 | 
10 | const HoverCardContent = React.forwardRef<
11 |   React.ElementRef<typeof HoverCardPrimitive.Content>,
12 |   React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>
13 | >(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
14 |   <HoverCardPrimitive.Content
15 |     ref={ref}
16 |     align={align}
17 |     sideOffset={sideOffset}
18 |     className={cn(
19 |       "z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
20 |       className
21 |     )}
22 |     {...props}
23 |   />
24 | ))
25 | HoverCardContent.displayName = HoverCardPrimitive.Content.displayName
26 | 
27 | export { HoverCard, HoverCardTrigger, HoverCardContent }
```

src/components/ui/input-otp.tsx
```
1 | import * as React from "react"
2 | import { OTPInput, OTPInputContext } from "input-otp"
3 | import { Dot } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const InputOTP = React.forwardRef<
8 |   React.ElementRef<typeof OTPInput>,
9 |   React.ComponentPropsWithoutRef<typeof OTPInput>
10 | >(({ className, containerClassName, ...props }, ref) => (
11 |   <OTPInput
12 |     ref={ref}
13 |     containerClassName={cn(
14 |       "flex items-center gap-2 has-[:disabled]:opacity-50",
15 |       containerClassName
16 |     )}
17 |     className={cn("disabled:cursor-not-allowed", className)}
18 |     {...props}
19 |   />
20 | ))
21 | InputOTP.displayName = "InputOTP"
22 | 
23 | const InputOTPGroup = React.forwardRef<
24 |   React.ElementRef<"div">,
25 |   React.ComponentPropsWithoutRef<"div">
26 | >(({ className, ...props }, ref) => (
27 |   <div ref={ref} className={cn("flex items-center", className)} {...props} />
28 | ))
29 | InputOTPGroup.displayName = "InputOTPGroup"
30 | 
31 | const InputOTPSlot = React.forwardRef<
32 |   React.ElementRef<"div">,
33 |   React.ComponentPropsWithoutRef<"div"> & { index: number }
34 | >(({ index, className, ...props }, ref) => {
35 |   const inputOTPContext = React.useContext(OTPInputContext)
36 |   const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]
37 | 
38 |   return (
39 |     <div
40 |       ref={ref}
41 |       className={cn(
42 |         "relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",
43 |         isActive && "z-10 ring-2 ring-ring ring-offset-background",
44 |         className
45 |       )}
46 |       {...props}
47 |     >
48 |       {char}
49 |       {hasFakeCaret && (
50 |         <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
51 |           <div className="h-4 w-px animate-caret-blink bg-foreground duration-1000" />
52 |         </div>
53 |       )}
54 |     </div>
55 |   )
56 | })
57 | InputOTPSlot.displayName = "InputOTPSlot"
58 | 
59 | const InputOTPSeparator = React.forwardRef<
60 |   React.ElementRef<"div">,
61 |   React.ComponentPropsWithoutRef<"div">
62 | >(({ ...props }, ref) => (
63 |   <div ref={ref} role="separator" {...props}>
64 |     <Dot />
65 |   </div>
66 | ))
67 | InputOTPSeparator.displayName = "InputOTPSeparator"
68 | 
69 | export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }
```

src/components/ui/input.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
6 |   ({ className, type, ...props }, ref) => {
7 |     return (
8 |       <input
9 |         type={type}
10 |         className={cn(
11 |           "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
12 |           className
13 |         )}
14 |         ref={ref}
15 |         {...props}
16 |       />
17 |     )
18 |   }
19 | )
20 | Input.displayName = "Input"
21 | 
22 | export { Input }
```

src/components/ui/label.tsx
```
1 | import * as React from "react"
2 | import * as LabelPrimitive from "@radix-ui/react-label"
3 | import { cva, type VariantProps } from "class-variance-authority"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const labelVariants = cva(
8 |   "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
9 | )
10 | 
11 | const Label = React.forwardRef<
12 |   React.ElementRef<typeof LabelPrimitive.Root>,
13 |   React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
14 |     VariantProps<typeof labelVariants>
15 | >(({ className, ...props }, ref) => (
16 |   <LabelPrimitive.Root
17 |     ref={ref}
18 |     className={cn(labelVariants(), className)}
19 |     {...props}
20 |   />
21 | ))
22 | Label.displayName = LabelPrimitive.Root.displayName
23 | 
24 | export { Label }
```

src/components/ui/menubar.tsx
```
1 | import * as React from "react"
2 | import * as MenubarPrimitive from "@radix-ui/react-menubar"
3 | import { Check, ChevronRight, Circle } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const MenubarMenu = MenubarPrimitive.Menu
8 | 
9 | const MenubarGroup = MenubarPrimitive.Group
10 | 
11 | const MenubarPortal = MenubarPrimitive.Portal
12 | 
13 | const MenubarSub = MenubarPrimitive.Sub
14 | 
15 | const MenubarRadioGroup = MenubarPrimitive.RadioGroup
16 | 
17 | const Menubar = React.forwardRef<
18 |   React.ElementRef<typeof MenubarPrimitive.Root>,
19 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
20 | >(({ className, ...props }, ref) => (
21 |   <MenubarPrimitive.Root
22 |     ref={ref}
23 |     className={cn(
24 |       "flex h-10 items-center space-x-1 rounded-md border bg-background p-1",
25 |       className
26 |     )}
27 |     {...props}
28 |   />
29 | ))
30 | Menubar.displayName = MenubarPrimitive.Root.displayName
31 | 
32 | const MenubarTrigger = React.forwardRef<
33 |   React.ElementRef<typeof MenubarPrimitive.Trigger>,
34 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
35 | >(({ className, ...props }, ref) => (
36 |   <MenubarPrimitive.Trigger
37 |     ref={ref}
38 |     className={cn(
39 |       "flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
40 |       className
41 |     )}
42 |     {...props}
43 |   />
44 | ))
45 | MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName
46 | 
47 | const MenubarSubTrigger = React.forwardRef<
48 |   React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
49 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
50 |     inset?: boolean
51 |   }
52 | >(({ className, inset, children, ...props }, ref) => (
53 |   <MenubarPrimitive.SubTrigger
54 |     ref={ref}
55 |     className={cn(
56 |       "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
57 |       inset && "pl-8",
58 |       className
59 |     )}
60 |     {...props}
61 |   >
62 |     {children}
63 |     <ChevronRight className="ml-auto h-4 w-4" />
64 |   </MenubarPrimitive.SubTrigger>
65 | ))
66 | MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName
67 | 
68 | const MenubarSubContent = React.forwardRef<
69 |   React.ElementRef<typeof MenubarPrimitive.SubContent>,
70 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
71 | >(({ className, ...props }, ref) => (
72 |   <MenubarPrimitive.SubContent
73 |     ref={ref}
74 |     className={cn(
75 |       "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
76 |       className
77 |     )}
78 |     {...props}
79 |   />
80 | ))
81 | MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName
82 | 
83 | const MenubarContent = React.forwardRef<
84 |   React.ElementRef<typeof MenubarPrimitive.Content>,
85 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
86 | >(
87 |   (
88 |     { className, align = "start", alignOffset = -4, sideOffset = 8, ...props },
89 |     ref
90 |   ) => (
91 |     <MenubarPrimitive.Portal>
92 |       <MenubarPrimitive.Content
93 |         ref={ref}
94 |         align={align}
95 |         alignOffset={alignOffset}
96 |         sideOffset={sideOffset}
97 |         className={cn(
98 |           "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
99 |           className
100 |         )}
101 |         {...props}
102 |       />
103 |     </MenubarPrimitive.Portal>
104 |   )
105 | )
106 | MenubarContent.displayName = MenubarPrimitive.Content.displayName
107 | 
108 | const MenubarItem = React.forwardRef<
109 |   React.ElementRef<typeof MenubarPrimitive.Item>,
110 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
111 |     inset?: boolean
112 |   }
113 | >(({ className, inset, ...props }, ref) => (
114 |   <MenubarPrimitive.Item
115 |     ref={ref}
116 |     className={cn(
117 |       "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
118 |       inset && "pl-8",
119 |       className
120 |     )}
121 |     {...props}
122 |   />
123 | ))
124 | MenubarItem.displayName = MenubarPrimitive.Item.displayName
125 | 
126 | const MenubarCheckboxItem = React.forwardRef<
127 |   React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
128 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
129 | >(({ className, children, checked, ...props }, ref) => (
130 |   <MenubarPrimitive.CheckboxItem
131 |     ref={ref}
132 |     className={cn(
133 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
134 |       className
135 |     )}
136 |     checked={checked}
137 |     {...props}
138 |   >
139 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
140 |       <MenubarPrimitive.ItemIndicator>
141 |         <Check className="h-4 w-4" />
142 |       </MenubarPrimitive.ItemIndicator>
143 |     </span>
144 |     {children}
145 |   </MenubarPrimitive.CheckboxItem>
146 | ))
147 | MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName
148 | 
149 | const MenubarRadioItem = React.forwardRef<
150 |   React.ElementRef<typeof MenubarPrimitive.RadioItem>,
151 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
152 | >(({ className, children, ...props }, ref) => (
153 |   <MenubarPrimitive.RadioItem
154 |     ref={ref}
155 |     className={cn(
156 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
157 |       className
158 |     )}
159 |     {...props}
160 |   >
161 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
162 |       <MenubarPrimitive.ItemIndicator>
163 |         <Circle className="h-2 w-2 fill-current" />
164 |       </MenubarPrimitive.ItemIndicator>
165 |     </span>
166 |     {children}
167 |   </MenubarPrimitive.RadioItem>
168 | ))
169 | MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName
170 | 
171 | const MenubarLabel = React.forwardRef<
172 |   React.ElementRef<typeof MenubarPrimitive.Label>,
173 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
174 |     inset?: boolean
175 |   }
176 | >(({ className, inset, ...props }, ref) => (
177 |   <MenubarPrimitive.Label
178 |     ref={ref}
179 |     className={cn(
180 |       "px-2 py-1.5 text-sm font-semibold",
181 |       inset && "pl-8",
182 |       className
183 |     )}
184 |     {...props}
185 |   />
186 | ))
187 | MenubarLabel.displayName = MenubarPrimitive.Label.displayName
188 | 
189 | const MenubarSeparator = React.forwardRef<
190 |   React.ElementRef<typeof MenubarPrimitive.Separator>,
191 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
192 | >(({ className, ...props }, ref) => (
193 |   <MenubarPrimitive.Separator
194 |     ref={ref}
195 |     className={cn("-mx-1 my-1 h-px bg-muted", className)}
196 |     {...props}
197 |   />
198 | ))
199 | MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName
200 | 
201 | const MenubarShortcut = ({
202 |   className,
203 |   ...props
204 | }: React.HTMLAttributes<HTMLSpanElement>) => {
205 |   return (
206 |     <span
207 |       className={cn(
208 |         "ml-auto text-xs tracking-widest text-muted-foreground",
209 |         className
210 |       )}
211 |       {...props}
212 |     />
213 |   )
214 | }
215 | MenubarShortcut.displayname = "MenubarShortcut"
216 | 
217 | export {
218 |   Menubar,
219 |   MenubarMenu,
220 |   MenubarTrigger,
221 |   MenubarContent,
222 |   MenubarItem,
223 |   MenubarSeparator,
224 |   MenubarLabel,
225 |   MenubarCheckboxItem,
226 |   MenubarRadioGroup,
227 |   MenubarRadioItem,
228 |   MenubarPortal,
229 |   MenubarSubContent,
230 |   MenubarSubTrigger,
231 |   MenubarGroup,
232 |   MenubarSub,
233 |   MenubarShortcut,
234 | }
```

src/components/ui/navigation-menu.tsx
```
1 | import * as React from "react"
2 | import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu"
3 | import { cva } from "class-variance-authority"
4 | import { ChevronDown } from "lucide-react"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | const NavigationMenu = React.forwardRef<
9 |   React.ElementRef<typeof NavigationMenuPrimitive.Root>,
10 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>
11 | >(({ className, children, ...props }, ref) => (
12 |   <NavigationMenuPrimitive.Root
13 |     ref={ref}
14 |     className={cn(
15 |       "relative z-10 flex max-w-max flex-1 items-center justify-center",
16 |       className
17 |     )}
18 |     {...props}
19 |   >
20 |     {children}
21 |     <NavigationMenuViewport />
22 |   </NavigationMenuPrimitive.Root>
23 | ))
24 | NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName
25 | 
26 | const NavigationMenuList = React.forwardRef<
27 |   React.ElementRef<typeof NavigationMenuPrimitive.List>,
28 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>
29 | >(({ className, ...props }, ref) => (
30 |   <NavigationMenuPrimitive.List
31 |     ref={ref}
32 |     className={cn(
33 |       "group flex flex-1 list-none items-center justify-center space-x-1",
34 |       className
35 |     )}
36 |     {...props}
37 |   />
38 | ))
39 | NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName
40 | 
41 | const NavigationMenuItem = NavigationMenuPrimitive.Item
42 | 
43 | const navigationMenuTriggerStyle = cva(
44 |   "group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50"
45 | )
46 | 
47 | const NavigationMenuTrigger = React.forwardRef<
48 |   React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,
49 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>
50 | >(({ className, children, ...props }, ref) => (
51 |   <NavigationMenuPrimitive.Trigger
52 |     ref={ref}
53 |     className={cn(navigationMenuTriggerStyle(), "group", className)}
54 |     {...props}
55 |   >
56 |     {children}{" "}
57 |     <ChevronDown
58 |       className="relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180"
59 |       aria-hidden="true"
60 |     />
61 |   </NavigationMenuPrimitive.Trigger>
62 | ))
63 | NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName
64 | 
65 | const NavigationMenuContent = React.forwardRef<
66 |   React.ElementRef<typeof NavigationMenuPrimitive.Content>,
67 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>
68 | >(({ className, ...props }, ref) => (
69 |   <NavigationMenuPrimitive.Content
70 |     ref={ref}
71 |     className={cn(
72 |       "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto ",
73 |       className
74 |     )}
75 |     {...props}
76 |   />
77 | ))
78 | NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName
79 | 
80 | const NavigationMenuLink = NavigationMenuPrimitive.Link
81 | 
82 | const NavigationMenuViewport = React.forwardRef<
83 |   React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,
84 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>
85 | >(({ className, ...props }, ref) => (
86 |   <div className={cn("absolute left-0 top-full flex justify-center")}>
87 |     <NavigationMenuPrimitive.Viewport
88 |       className={cn(
89 |         "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]",
90 |         className
91 |       )}
92 |       ref={ref}
93 |       {...props}
94 |     />
95 |   </div>
96 | ))
97 | NavigationMenuViewport.displayName =
98 |   NavigationMenuPrimitive.Viewport.displayName
99 | 
100 | const NavigationMenuIndicator = React.forwardRef<
101 |   React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,
102 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>
103 | >(({ className, ...props }, ref) => (
104 |   <NavigationMenuPrimitive.Indicator
105 |     ref={ref}
106 |     className={cn(
107 |       "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
108 |       className
109 |     )}
110 |     {...props}
111 |   >
112 |     <div className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
113 |   </NavigationMenuPrimitive.Indicator>
114 | ))
115 | NavigationMenuIndicator.displayName =
116 |   NavigationMenuPrimitive.Indicator.displayName
117 | 
118 | export {
119 |   navigationMenuTriggerStyle,
120 |   NavigationMenu,
121 |   NavigationMenuList,
122 |   NavigationMenuItem,
123 |   NavigationMenuContent,
124 |   NavigationMenuTrigger,
125 |   NavigationMenuLink,
126 |   NavigationMenuIndicator,
127 |   NavigationMenuViewport,
128 | }
```

src/components/ui/pagination.tsx
```
1 | import * as React from "react"
2 | import { ChevronLeft, ChevronRight, MoreHorizontal } from "lucide-react"
3 | 
4 | import { cn } from "@/lib/utils"
5 | import { ButtonProps, buttonVariants } from "@/components/ui/button"
6 | 
7 | const Pagination = ({ className, ...props }: React.ComponentProps<"nav">) => (
8 |   <nav
9 |     role="navigation"
10 |     aria-label="pagination"
11 |     className={cn("mx-auto flex w-full justify-center", className)}
12 |     {...props}
13 |   />
14 | )
15 | Pagination.displayName = "Pagination"
16 | 
17 | const PaginationContent = React.forwardRef<
18 |   HTMLUListElement,
19 |   React.ComponentProps<"ul">
20 | >(({ className, ...props }, ref) => (
21 |   <ul
22 |     ref={ref}
23 |     className={cn("flex flex-row items-center gap-1", className)}
24 |     {...props}
25 |   />
26 | ))
27 | PaginationContent.displayName = "PaginationContent"
28 | 
29 | const PaginationItem = React.forwardRef<
30 |   HTMLLIElement,
31 |   React.ComponentProps<"li">
32 | >(({ className, ...props }, ref) => (
33 |   <li ref={ref} className={cn("", className)} {...props} />
34 | ))
35 | PaginationItem.displayName = "PaginationItem"
36 | 
37 | type PaginationLinkProps = {
38 |   isActive?: boolean
39 | } & Pick<ButtonProps, "size"> &
40 |   React.ComponentProps<"a">
41 | 
42 | const PaginationLink = ({
43 |   className,
44 |   isActive,
45 |   size = "icon",
46 |   ...props
47 | }: PaginationLinkProps) => (
48 |   <a
49 |     aria-current={isActive ? "page" : undefined}
50 |     className={cn(
51 |       buttonVariants({
52 |         variant: isActive ? "outline" : "ghost",
53 |         size,
54 |       }),
55 |       className
56 |     )}
57 |     {...props}
58 |   />
59 | )
60 | PaginationLink.displayName = "PaginationLink"
61 | 
62 | const PaginationPrevious = ({
63 |   className,
64 |   ...props
65 | }: React.ComponentProps<typeof PaginationLink>) => (
66 |   <PaginationLink
67 |     aria-label="Go to previous page"
68 |     size="default"
69 |     className={cn("gap-1 pl-2.5", className)}
70 |     {...props}
71 |   >
72 |     <ChevronLeft className="h-4 w-4" />
73 |     <span>Previous</span>
74 |   </PaginationLink>
75 | )
76 | PaginationPrevious.displayName = "PaginationPrevious"
77 | 
78 | const PaginationNext = ({
79 |   className,
80 |   ...props
81 | }: React.ComponentProps<typeof PaginationLink>) => (
82 |   <PaginationLink
83 |     aria-label="Go to next page"
84 |     size="default"
85 |     className={cn("gap-1 pr-2.5", className)}
86 |     {...props}
87 |   >
88 |     <span>Next</span>
89 |     <ChevronRight className="h-4 w-4" />
90 |   </PaginationLink>
91 | )
92 | PaginationNext.displayName = "PaginationNext"
93 | 
94 | const PaginationEllipsis = ({
95 |   className,
96 |   ...props
97 | }: React.ComponentProps<"span">) => (
98 |   <span
99 |     aria-hidden
100 |     className={cn("flex h-9 w-9 items-center justify-center", className)}
101 |     {...props}
102 |   >
103 |     <MoreHorizontal className="h-4 w-4" />
104 |     <span className="sr-only">More pages</span>
105 |   </span>
106 | )
107 | PaginationEllipsis.displayName = "PaginationEllipsis"
108 | 
109 | export {
110 |   Pagination,
111 |   PaginationContent,
112 |   PaginationEllipsis,
113 |   PaginationItem,
114 |   PaginationLink,
115 |   PaginationNext,
116 |   PaginationPrevious,
117 | }
```

src/components/ui/popover.tsx
```
1 | import * as React from "react"
2 | import * as PopoverPrimitive from "@radix-ui/react-popover"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Popover = PopoverPrimitive.Root
7 | 
8 | const PopoverTrigger = PopoverPrimitive.Trigger
9 | 
10 | const PopoverContent = React.forwardRef<
11 |   React.ElementRef<typeof PopoverPrimitive.Content>,
12 |   React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
13 | >(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
14 |   <PopoverPrimitive.Portal>
15 |     <PopoverPrimitive.Content
16 |       ref={ref}
17 |       align={align}
18 |       sideOffset={sideOffset}
19 |       className={cn(
20 |         "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
21 |         className
22 |       )}
23 |       {...props}
24 |     />
25 |   </PopoverPrimitive.Portal>
26 | ))
27 | PopoverContent.displayName = PopoverPrimitive.Content.displayName
28 | 
29 | export { Popover, PopoverTrigger, PopoverContent }
```

src/components/ui/progress.tsx
```
1 | import * as React from "react"
2 | import * as ProgressPrimitive from "@radix-ui/react-progress"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Progress = React.forwardRef<
7 |   React.ElementRef<typeof ProgressPrimitive.Root>,
8 |   React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
9 | >(({ className, value, ...props }, ref) => (
10 |   <ProgressPrimitive.Root
11 |     ref={ref}
12 |     className={cn(
13 |       "relative h-4 w-full overflow-hidden rounded-full bg-secondary",
14 |       className
15 |     )}
16 |     {...props}
17 |   >
18 |     <ProgressPrimitive.Indicator
19 |       className="h-full w-full flex-1 bg-primary transition-all"
20 |       style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
21 |     />
22 |   </ProgressPrimitive.Root>
23 | ))
24 | Progress.displayName = ProgressPrimitive.Root.displayName
25 | 
26 | export { Progress }
```

src/components/ui/radio-group.tsx
```
1 | import * as React from "react"
2 | import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
3 | import { Circle } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const RadioGroup = React.forwardRef<
8 |   React.ElementRef<typeof RadioGroupPrimitive.Root>,
9 |   React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
10 | >(({ className, ...props }, ref) => {
11 |   return (
12 |     <RadioGroupPrimitive.Root
13 |       className={cn("grid gap-2", className)}
14 |       {...props}
15 |       ref={ref}
16 |     />
17 |   )
18 | })
19 | RadioGroup.displayName = RadioGroupPrimitive.Root.displayName
20 | 
21 | const RadioGroupItem = React.forwardRef<
22 |   React.ElementRef<typeof RadioGroupPrimitive.Item>,
23 |   React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
24 | >(({ className, ...props }, ref) => {
25 |   return (
26 |     <RadioGroupPrimitive.Item
27 |       ref={ref}
28 |       className={cn(
29 |         "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
30 |         className
31 |       )}
32 |       {...props}
33 |     >
34 |       <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
35 |         <Circle className="h-2.5 w-2.5 fill-current text-current" />
36 |       </RadioGroupPrimitive.Indicator>
37 |     </RadioGroupPrimitive.Item>
38 |   )
39 | })
40 | RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName
41 | 
42 | export { RadioGroup, RadioGroupItem }
```

src/components/ui/resizable.tsx
```
1 | import { GripVertical } from "lucide-react"
2 | import * as ResizablePrimitive from "react-resizable-panels"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const ResizablePanelGroup = ({
7 |   className,
8 |   ...props
9 | }: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (
10 |   <ResizablePrimitive.PanelGroup
11 |     className={cn(
12 |       "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
13 |       className
14 |     )}
15 |     {...props}
16 |   />
17 | )
18 | 
19 | const ResizablePanel = ResizablePrimitive.Panel
20 | 
21 | const ResizableHandle = ({
22 |   withHandle,
23 |   className,
24 |   ...props
25 | }: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
26 |   withHandle?: boolean
27 | }) => (
28 |   <ResizablePrimitive.PanelResizeHandle
29 |     className={cn(
30 |       "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
31 |       className
32 |     )}
33 |     {...props}
34 |   >
35 |     {withHandle && (
36 |       <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
37 |         <GripVertical className="h-2.5 w-2.5" />
38 |       </div>
39 |     )}
40 |   </ResizablePrimitive.PanelResizeHandle>
41 | )
42 | 
43 | export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

src/components/ui/scroll-area.tsx
```
1 | import * as React from "react"
2 | import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const ScrollArea = React.forwardRef<
7 |   React.ElementRef<typeof ScrollAreaPrimitive.Root>,
8 |   React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
9 | >(({ className, children, ...props }, ref) => (
10 |   <ScrollAreaPrimitive.Root
11 |     ref={ref}
12 |     className={cn("relative overflow-hidden", className)}
13 |     {...props}
14 |   >
15 |     <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
16 |       {children}
17 |     </ScrollAreaPrimitive.Viewport>
18 |     <ScrollBar />
19 |     <ScrollAreaPrimitive.Corner />
20 |   </ScrollAreaPrimitive.Root>
21 | ))
22 | ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName
23 | 
24 | const ScrollBar = React.forwardRef<
25 |   React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
26 |   React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
27 | >(({ className, orientation = "vertical", ...props }, ref) => (
28 |   <ScrollAreaPrimitive.ScrollAreaScrollbar
29 |     ref={ref}
30 |     orientation={orientation}
31 |     className={cn(
32 |       "flex touch-none select-none transition-colors",
33 |       orientation === "vertical" &&
34 |         "h-full w-2.5 border-l border-l-transparent p-[1px]",
35 |       orientation === "horizontal" &&
36 |         "h-2.5 flex-col border-t border-t-transparent p-[1px]",
37 |       className
38 |     )}
39 |     {...props}
40 |   >
41 |     <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
42 |   </ScrollAreaPrimitive.ScrollAreaScrollbar>
43 | ))
44 | ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName
45 | 
46 | export { ScrollArea, ScrollBar }
```

src/components/ui/select.tsx
```
1 | import * as React from "react"
2 | import * as SelectPrimitive from "@radix-ui/react-select"
3 | import { Check, ChevronDown, ChevronUp } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const Select = SelectPrimitive.Root
8 | 
9 | const SelectGroup = SelectPrimitive.Group
10 | 
11 | const SelectValue = SelectPrimitive.Value
12 | 
13 | const SelectTrigger = React.forwardRef<
14 |   React.ElementRef<typeof SelectPrimitive.Trigger>,
15 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
16 | >(({ className, children, ...props }, ref) => (
17 |   <SelectPrimitive.Trigger
18 |     ref={ref}
19 |     className={cn(
20 |       "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
21 |       className
22 |     )}
23 |     {...props}
24 |   >
25 |     {children}
26 |     <SelectPrimitive.Icon asChild>
27 |       <ChevronDown className="h-4 w-4 opacity-50" />
28 |     </SelectPrimitive.Icon>
29 |   </SelectPrimitive.Trigger>
30 | ))
31 | SelectTrigger.displayName = SelectPrimitive.Trigger.displayName
32 | 
33 | const SelectScrollUpButton = React.forwardRef<
34 |   React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
35 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
36 | >(({ className, ...props }, ref) => (
37 |   <SelectPrimitive.ScrollUpButton
38 |     ref={ref}
39 |     className={cn(
40 |       "flex cursor-default items-center justify-center py-1",
41 |       className
42 |     )}
43 |     {...props}
44 |   >
45 |     <ChevronUp className="h-4 w-4" />
46 |   </SelectPrimitive.ScrollUpButton>
47 | ))
48 | SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName
49 | 
50 | const SelectScrollDownButton = React.forwardRef<
51 |   React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
52 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
53 | >(({ className, ...props }, ref) => (
54 |   <SelectPrimitive.ScrollDownButton
55 |     ref={ref}
56 |     className={cn(
57 |       "flex cursor-default items-center justify-center py-1",
58 |       className
59 |     )}
60 |     {...props}
61 |   >
62 |     <ChevronDown className="h-4 w-4" />
63 |   </SelectPrimitive.ScrollDownButton>
64 | ))
65 | SelectScrollDownButton.displayName =
66 |   SelectPrimitive.ScrollDownButton.displayName
67 | 
68 | const SelectContent = React.forwardRef<
69 |   React.ElementRef<typeof SelectPrimitive.Content>,
70 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
71 | >(({ className, children, position = "popper", ...props }, ref) => (
72 |   <SelectPrimitive.Portal>
73 |     <SelectPrimitive.Content
74 |       ref={ref}
75 |       className={cn(
76 |         "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-white text-gray-900 shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
77 |         position === "popper" &&
78 |           "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
79 |         className
80 |       )}
81 |       position={position}
82 |       {...props}
83 |     >
84 |       <SelectScrollUpButton />
85 |       <SelectPrimitive.Viewport
86 |         className={cn(
87 |           "p-1",
88 |           position === "popper" &&
89 |             "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
90 |         )}
91 |       >
92 |         {children}
93 |       </SelectPrimitive.Viewport>
94 |       <SelectScrollDownButton />
95 |     </SelectPrimitive.Content>
96 |   </SelectPrimitive.Portal>
97 | ))
98 | SelectContent.displayName = SelectPrimitive.Content.displayName
99 | 
100 | const SelectLabel = React.forwardRef<
101 |   React.ElementRef<typeof SelectPrimitive.Label>,
102 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
103 | >(({ className, ...props }, ref) => (
104 |   <SelectPrimitive.Label
105 |     ref={ref}
106 |     className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
107 |     {...props}
108 |   />
109 | ))
110 | SelectLabel.displayName = SelectPrimitive.Label.displayName
111 | 
112 | const SelectItem = React.forwardRef<
113 |   React.ElementRef<typeof SelectPrimitive.Item>,
114 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
115 | >(({ className, children, ...props }, ref) => (
116 |   <SelectPrimitive.Item
117 |     ref={ref}
118 |     className={cn(
119 |       "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm text-black font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
120 |       className
121 |     )}
122 |     {...props}
123 |   >
124 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
125 |       <SelectPrimitive.ItemIndicator>
126 |         <Check className="h-4 w-4" />
127 |       </SelectPrimitive.ItemIndicator>
128 |     </span>
129 | 
130 |     <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
131 |   </SelectPrimitive.Item>
132 | ))
133 | SelectItem.displayName = SelectPrimitive.Item.displayName
134 | 
135 | const SelectSeparator = React.forwardRef<
136 |   React.ElementRef<typeof SelectPrimitive.Separator>,
137 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
138 | >(({ className, ...props }, ref) => (
139 |   <SelectPrimitive.Separator
140 |     ref={ref}
141 |     className={cn("-mx-1 my-1 h-px bg-muted", className)}
142 |     {...props}
143 |   />
144 | ))
145 | SelectSeparator.displayName = SelectPrimitive.Separator.displayName
146 | 
147 | export {
148 |   Select,
149 |   SelectGroup,
150 |   SelectValue,
151 |   SelectTrigger,
152 |   SelectContent,
153 |   SelectLabel,
154 |   SelectItem,
155 |   SelectSeparator,
156 |   SelectScrollUpButton,
157 |   SelectScrollDownButton,
158 | }
```

src/components/ui/separator.tsx
```
1 | import * as React from "react"
2 | import * as SeparatorPrimitive from "@radix-ui/react-separator"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Separator = React.forwardRef<
7 |   React.ElementRef<typeof SeparatorPrimitive.Root>,
8 |   React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
9 | >(
10 |   (
11 |     { className, orientation = "horizontal", decorative = true, ...props },
12 |     ref
13 |   ) => (
14 |     <SeparatorPrimitive.Root
15 |       ref={ref}
16 |       decorative={decorative}
17 |       orientation={orientation}
18 |       className={cn(
19 |         "shrink-0 bg-border",
20 |         orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
21 |         className
22 |       )}
23 |       {...props}
24 |     />
25 |   )
26 | )
27 | Separator.displayName = SeparatorPrimitive.Root.displayName
28 | 
29 | export { Separator }
```

src/components/ui/sheet.tsx
```
1 | import * as SheetPrimitive from "@radix-ui/react-dialog"
2 | import { cva, type VariantProps } from "class-variance-authority"
3 | import { X } from "lucide-react"
4 | import * as React from "react"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | const Sheet = SheetPrimitive.Root
9 | 
10 | const SheetTrigger = SheetPrimitive.Trigger
11 | 
12 | const SheetClose = SheetPrimitive.Close
13 | 
14 | const SheetPortal = SheetPrimitive.Portal
15 | 
16 | const SheetOverlay = React.forwardRef<
17 |   React.ElementRef<typeof SheetPrimitive.Overlay>,
18 |   React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
19 | >(({ className, ...props }, ref) => (
20 |   <SheetPrimitive.Overlay
21 |     className={cn(
22 |       "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
23 |       className
24 |     )}
25 |     {...props}
26 |     ref={ref}
27 |   />
28 | ))
29 | SheetOverlay.displayName = SheetPrimitive.Overlay.displayName
30 | 
31 | const sheetVariants = cva(
32 |   "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
33 |   {
34 |     variants: {
35 |       side: {
36 |         top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
37 |         bottom:
38 |           "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
39 |         left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
40 |         right:
41 |           "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
42 |       },
43 |     },
44 |     defaultVariants: {
45 |       side: "right",
46 |     },
47 |   }
48 | )
49 | 
50 | interface SheetContentProps
51 |   extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
52 |   VariantProps<typeof sheetVariants> { }
53 | 
54 | const SheetContent = React.forwardRef<
55 |   React.ElementRef<typeof SheetPrimitive.Content>,
56 |   SheetContentProps
57 | >(({ side = "right", className, children, ...props }, ref) => (
58 |   <SheetPortal>
59 |     <SheetOverlay />
60 |     <SheetPrimitive.Content
61 |       ref={ref}
62 |       className={cn(sheetVariants({ side }), className)}
63 |       {...props}
64 |     >
65 |       {children}
66 |       <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
67 |         <X className="h-4 w-4" />
68 |         <span className="sr-only">Close</span>
69 |       </SheetPrimitive.Close>
70 |     </SheetPrimitive.Content>
71 |   </SheetPortal>
72 | ))
73 | SheetContent.displayName = SheetPrimitive.Content.displayName
74 | 
75 | const SheetHeader = ({
76 |   className,
77 |   ...props
78 | }: React.HTMLAttributes<HTMLDivElement>) => (
79 |   <div
80 |     className={cn(
81 |       "flex flex-col space-y-2 text-center sm:text-left",
82 |       className
83 |     )}
84 |     {...props}
85 |   />
86 | )
87 | SheetHeader.displayName = "SheetHeader"
88 | 
89 | const SheetFooter = ({
90 |   className,
91 |   ...props
92 | }: React.HTMLAttributes<HTMLDivElement>) => (
93 |   <div
94 |     className={cn(
95 |       "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
96 |       className
97 |     )}
98 |     {...props}
99 |   />
100 | )
101 | SheetFooter.displayName = "SheetFooter"
102 | 
103 | const SheetTitle = React.forwardRef<
104 |   React.ElementRef<typeof SheetPrimitive.Title>,
105 |   React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
106 | >(({ className, ...props }, ref) => (
107 |   <SheetPrimitive.Title
108 |     ref={ref}
109 |     className={cn("text-lg font-semibold text-foreground", className)}
110 |     {...props}
111 |   />
112 | ))
113 | SheetTitle.displayName = SheetPrimitive.Title.displayName
114 | 
115 | const SheetDescription = React.forwardRef<
116 |   React.ElementRef<typeof SheetPrimitive.Description>,
117 |   React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
118 | >(({ className, ...props }, ref) => (
119 |   <SheetPrimitive.Description
120 |     ref={ref}
121 |     className={cn("text-sm text-muted-foreground", className)}
122 |     {...props}
123 |   />
124 | ))
125 | SheetDescription.displayName = SheetPrimitive.Description.displayName
126 | 
127 | export {
128 |   Sheet, SheetClose,
129 |   SheetContent, SheetDescription, SheetFooter, SheetHeader, SheetOverlay, SheetPortal, SheetTitle, SheetTrigger
130 | }
131 | 
```

src/components/ui/sidebar.tsx
```
1 | import * as React from "react"
2 | import { Slot } from "@radix-ui/react-slot"
3 | import { VariantProps, cva } from "class-variance-authority"
4 | import { PanelLeft } from "lucide-react"
5 | 
6 | import { useIsMobile } from "@/hooks/use-mobile"
7 | import { cn } from "@/lib/utils"
8 | import { Button } from "@/components/ui/button"
9 | import { Input } from "@/components/ui/input"
10 | import { Separator } from "@/components/ui/separator"
11 | import { Sheet, SheetContent } from "@/components/ui/sheet"
12 | import { Skeleton } from "@/components/ui/skeleton"
13 | import {
14 |   Tooltip,
15 |   TooltipContent,
16 |   TooltipProvider,
17 |   TooltipTrigger,
18 | } from "@/components/ui/tooltip"
19 | 
20 | const SIDEBAR_COOKIE_NAME = "sidebar:state"
21 | const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
22 | const SIDEBAR_WIDTH = "16rem"
23 | const SIDEBAR_WIDTH_MOBILE = "18rem"
24 | const SIDEBAR_WIDTH_ICON = "3rem"
25 | const SIDEBAR_KEYBOARD_SHORTCUT = "b"
26 | 
27 | type SidebarContext = {
28 |   state: "expanded" | "collapsed"
29 |   open: boolean
30 |   setOpen: (open: boolean) => void
31 |   openMobile: boolean
32 |   setOpenMobile: (open: boolean) => void
33 |   isMobile: boolean
34 |   toggleSidebar: () => void
35 | }
36 | 
37 | const SidebarContext = React.createContext<SidebarContext | null>(null)
38 | 
39 | function useSidebar() {
40 |   const context = React.useContext(SidebarContext)
41 |   if (!context) {
42 |     throw new Error("useSidebar must be used within a SidebarProvider.")
43 |   }
44 | 
45 |   return context
46 | }
47 | 
48 | const SidebarProvider = React.forwardRef<
49 |   HTMLDivElement,
50 |   React.ComponentProps<"div"> & {
51 |     defaultOpen?: boolean
52 |     open?: boolean
53 |     onOpenChange?: (open: boolean) => void
54 |   }
55 | >(
56 |   (
57 |     {
58 |       defaultOpen = true,
59 |       open: openProp,
60 |       onOpenChange: setOpenProp,
61 |       className,
62 |       style,
63 |       children,
64 |       ...props
65 |     },
66 |     ref
67 |   ) => {
68 |     const isMobile = useIsMobile()
69 |     const [openMobile, setOpenMobile] = React.useState(false)
70 | 
71 |     // This is the internal state of the sidebar.
72 |     // We use openProp and setOpenProp for control from outside the component.
73 |     const [_open, _setOpen] = React.useState(defaultOpen)
74 |     const open = openProp ?? _open
75 |     const setOpen = React.useCallback(
76 |       (value: boolean | ((value: boolean) => boolean)) => {
77 |         const openState = typeof value === "function" ? value(open) : value
78 |         if (setOpenProp) {
79 |           setOpenProp(openState)
80 |         } else {
81 |           _setOpen(openState)
82 |         }
83 | 
84 |         // This sets the cookie to keep the sidebar state.
85 |         document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
86 |       },
87 |       [setOpenProp, open]
88 |     )
89 | 
90 |     // Helper to toggle the sidebar.
91 |     const toggleSidebar = React.useCallback(() => {
92 |       return isMobile
93 |         ? setOpenMobile((open) => !open)
94 |         : setOpen((open) => !open)
95 |     }, [isMobile, setOpen, setOpenMobile])
96 | 
97 |     // Adds a keyboard shortcut to toggle the sidebar.
98 |     React.useEffect(() => {
99 |       const handleKeyDown = (event: KeyboardEvent) => {
100 |         if (
101 |           event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
102 |           (event.metaKey || event.ctrlKey)
103 |         ) {
104 |           event.preventDefault()
105 |           toggleSidebar()
106 |         }
107 |       }
108 | 
109 |       window.addEventListener("keydown", handleKeyDown)
110 |       return () => window.removeEventListener("keydown", handleKeyDown)
111 |     }, [toggleSidebar])
112 | 
113 |     // We add a state so that we can do data-state="expanded" or "collapsed".
114 |     // This makes it easier to style the sidebar with Tailwind classes.
115 |     const state = open ? "expanded" : "collapsed"
116 | 
117 |     const contextValue = React.useMemo<SidebarContext>(
118 |       () => ({
119 |         state,
120 |         open,
121 |         setOpen,
122 |         isMobile,
123 |         openMobile,
124 |         setOpenMobile,
125 |         toggleSidebar,
126 |       }),
127 |       [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
128 |     )
129 | 
130 |     return (
131 |       <SidebarContext.Provider value={contextValue}>
132 |         <TooltipProvider delayDuration={0}>
133 |           <div
134 |             style={
135 |               {
136 |                 "--sidebar-width": SIDEBAR_WIDTH,
137 |                 "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
138 |                 ...style,
139 |               } as React.CSSProperties
140 |             }
141 |             className={cn(
142 |               "group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",
143 |               className
144 |             )}
145 |             ref={ref}
146 |             {...props}
147 |           >
148 |             {children}
149 |           </div>
150 |         </TooltipProvider>
151 |       </SidebarContext.Provider>
152 |     )
153 |   }
154 | )
155 | SidebarProvider.displayName = "SidebarProvider"
156 | 
157 | const Sidebar = React.forwardRef<
158 |   HTMLDivElement,
159 |   React.ComponentProps<"div"> & {
160 |     side?: "left" | "right"
161 |     variant?: "sidebar" | "floating" | "inset"
162 |     collapsible?: "offcanvas" | "icon" | "none"
163 |   }
164 | >(
165 |   (
166 |     {
167 |       side = "left",
168 |       variant = "sidebar",
169 |       collapsible = "offcanvas",
170 |       className,
171 |       children,
172 |       ...props
173 |     },
174 |     ref
175 |   ) => {
176 |     const { isMobile, state, openMobile, setOpenMobile } = useSidebar()
177 | 
178 |     if (collapsible === "none") {
179 |       return (
180 |         <div
181 |           className={cn(
182 |             "flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",
183 |             className
184 |           )}
185 |           ref={ref}
186 |           {...props}
187 |         >
188 |           {children}
189 |         </div>
190 |       )
191 |     }
192 | 
193 |     if (isMobile) {
194 |       return (
195 |         <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
196 |           <SheetContent
197 |             data-sidebar="sidebar"
198 |             data-mobile="true"
199 |             className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
200 |             style={
201 |               {
202 |                 "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
203 |               } as React.CSSProperties
204 |             }
205 |             side={side}
206 |           >
207 |             <div className="flex h-full w-full flex-col">{children}</div>
208 |           </SheetContent>
209 |         </Sheet>
210 |       )
211 |     }
212 | 
213 |     return (
214 |       <div
215 |         ref={ref}
216 |         className="group peer hidden md:block text-sidebar-foreground"
217 |         data-state={state}
218 |         data-collapsible={state === "collapsed" ? collapsible : ""}
219 |         data-variant={variant}
220 |         data-side={side}
221 |       >
222 |         {/* This is what handles the sidebar gap on desktop */}
223 |         <div
224 |           className={cn(
225 |             "duration-200 relative h-svh w-[--sidebar-width] bg-transparent transition-[width] ease-linear",
226 |             "group-data-[collapsible=offcanvas]:w-0",
227 |             "group-data-[side=right]:rotate-180",
228 |             variant === "floating" || variant === "inset"
229 |               ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
230 |               : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]"
231 |           )}
232 |         />
233 |         <div
234 |           className={cn(
235 |             "duration-200 fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex",
236 |             side === "left"
237 |               ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
238 |               : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
239 |             // Adjust the padding for floating and inset variants.
240 |             variant === "floating" || variant === "inset"
241 |               ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
242 |               : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
243 |             className
244 |           )}
245 |           {...props}
246 |         >
247 |           <div
248 |             data-sidebar="sidebar"
249 |             className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow"
250 |           >
251 |             {children}
252 |           </div>
253 |         </div>
254 |       </div>
255 |     )
256 |   }
257 | )
258 | Sidebar.displayName = "Sidebar"
259 | 
260 | const SidebarTrigger = React.forwardRef<
261 |   React.ElementRef<typeof Button>,
262 |   React.ComponentProps<typeof Button>
263 | >(({ className, onClick, ...props }, ref) => {
264 |   const { toggleSidebar } = useSidebar()
265 | 
266 |   return (
267 |     <Button
268 |       ref={ref}
269 |       data-sidebar="trigger"
270 |       variant="ghost"
271 |       size="icon"
272 |       className={cn("h-7 w-7", className)}
273 |       onClick={(event) => {
274 |         onClick?.(event)
275 |         toggleSidebar()
276 |       }}
277 |       {...props}
278 |     >
279 |       <PanelLeft />
280 |       <span className="sr-only">Toggle Sidebar</span>
281 |     </Button>
282 |   )
283 | })
284 | SidebarTrigger.displayName = "SidebarTrigger"
285 | 
286 | const SidebarRail = React.forwardRef<
287 |   HTMLButtonElement,
288 |   React.ComponentProps<"button">
289 | >(({ className, ...props }, ref) => {
290 |   const { toggleSidebar } = useSidebar()
291 | 
292 |   return (
293 |     <button
294 |       ref={ref}
295 |       data-sidebar="rail"
296 |       aria-label="Toggle Sidebar"
297 |       tabIndex={-1}
298 |       onClick={toggleSidebar}
299 |       title="Toggle Sidebar"
300 |       className={cn(
301 |         "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex",
302 |         "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
303 |         "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
304 |         "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
305 |         "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
306 |         "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
307 |         className
308 |       )}
309 |       {...props}
310 |     />
311 |   )
312 | })
313 | SidebarRail.displayName = "SidebarRail"
314 | 
315 | const SidebarInset = React.forwardRef<
316 |   HTMLDivElement,
317 |   React.ComponentProps<"main">
318 | >(({ className, ...props }, ref) => {
319 |   return (
320 |     <main
321 |       ref={ref}
322 |       className={cn(
323 |         "relative flex min-h-svh flex-1 flex-col bg-background",
324 |         "peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
325 |         className
326 |       )}
327 |       {...props}
328 |     />
329 |   )
330 | })
331 | SidebarInset.displayName = "SidebarInset"
332 | 
333 | const SidebarInput = React.forwardRef<
334 |   React.ElementRef<typeof Input>,
335 |   React.ComponentProps<typeof Input>
336 | >(({ className, ...props }, ref) => {
337 |   return (
338 |     <Input
339 |       ref={ref}
340 |       data-sidebar="input"
341 |       className={cn(
342 |         "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
343 |         className
344 |       )}
345 |       {...props}
346 |     />
347 |   )
348 | })
349 | SidebarInput.displayName = "SidebarInput"
350 | 
351 | const SidebarHeader = React.forwardRef<
352 |   HTMLDivElement,
353 |   React.ComponentProps<"div">
354 | >(({ className, ...props }, ref) => {
355 |   return (
356 |     <div
357 |       ref={ref}
358 |       data-sidebar="header"
359 |       className={cn("flex flex-col gap-2 p-2", className)}
360 |       {...props}
361 |     />
362 |   )
363 | })
364 | SidebarHeader.displayName = "SidebarHeader"
365 | 
366 | const SidebarFooter = React.forwardRef<
367 |   HTMLDivElement,
368 |   React.ComponentProps<"div">
369 | >(({ className, ...props }, ref) => {
370 |   return (
371 |     <div
372 |       ref={ref}
373 |       data-sidebar="footer"
374 |       className={cn("flex flex-col gap-2 p-2", className)}
375 |       {...props}
376 |     />
377 |   )
378 | })
379 | SidebarFooter.displayName = "SidebarFooter"
380 | 
381 | const SidebarSeparator = React.forwardRef<
382 |   React.ElementRef<typeof Separator>,
383 |   React.ComponentProps<typeof Separator>
384 | >(({ className, ...props }, ref) => {
385 |   return (
386 |     <Separator
387 |       ref={ref}
388 |       data-sidebar="separator"
389 |       className={cn("mx-2 w-auto bg-sidebar-border", className)}
390 |       {...props}
391 |     />
392 |   )
393 | })
394 | SidebarSeparator.displayName = "SidebarSeparator"
395 | 
396 | const SidebarContent = React.forwardRef<
397 |   HTMLDivElement,
398 |   React.ComponentProps<"div">
399 | >(({ className, ...props }, ref) => {
400 |   return (
401 |     <div
402 |       ref={ref}
403 |       data-sidebar="content"
404 |       className={cn(
405 |         "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
406 |         className
407 |       )}
408 |       {...props}
409 |     />
410 |   )
411 | })
412 | SidebarContent.displayName = "SidebarContent"
413 | 
414 | const SidebarGroup = React.forwardRef<
415 |   HTMLDivElement,
416 |   React.ComponentProps<"div">
417 | >(({ className, ...props }, ref) => {
418 |   return (
419 |     <div
420 |       ref={ref}
421 |       data-sidebar="group"
422 |       className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
423 |       {...props}
424 |     />
425 |   )
426 | })
427 | SidebarGroup.displayName = "SidebarGroup"
428 | 
429 | const SidebarGroupLabel = React.forwardRef<
430 |   HTMLDivElement,
431 |   React.ComponentProps<"div"> & { asChild?: boolean }
432 | >(({ className, asChild = false, ...props }, ref) => {
433 |   const Comp = asChild ? Slot : "div"
434 | 
435 |   return (
436 |     <Comp
437 |       ref={ref}
438 |       data-sidebar="group-label"
439 |       className={cn(
440 |         "duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
441 |         "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
442 |         className
443 |       )}
444 |       {...props}
445 |     />
446 |   )
447 | })
448 | SidebarGroupLabel.displayName = "SidebarGroupLabel"
449 | 
450 | const SidebarGroupAction = React.forwardRef<
451 |   HTMLButtonElement,
452 |   React.ComponentProps<"button"> & { asChild?: boolean }
453 | >(({ className, asChild = false, ...props }, ref) => {
454 |   const Comp = asChild ? Slot : "button"
455 | 
456 |   return (
457 |     <Comp
458 |       ref={ref}
459 |       data-sidebar="group-action"
460 |       className={cn(
461 |         "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
462 |         // Increases the hit area of the button on mobile.
463 |         "after:absolute after:-inset-2 after:md:hidden",
464 |         "group-data-[collapsible=icon]:hidden",
465 |         className
466 |       )}
467 |       {...props}
468 |     />
469 |   )
470 | })
471 | SidebarGroupAction.displayName = "SidebarGroupAction"
472 | 
473 | const SidebarGroupContent = React.forwardRef<
474 |   HTMLDivElement,
475 |   React.ComponentProps<"div">
476 | >(({ className, ...props }, ref) => (
477 |   <div
478 |     ref={ref}
479 |     data-sidebar="group-content"
480 |     className={cn("w-full text-sm", className)}
481 |     {...props}
482 |   />
483 | ))
484 | SidebarGroupContent.displayName = "SidebarGroupContent"
485 | 
486 | const SidebarMenu = React.forwardRef<
487 |   HTMLUListElement,
488 |   React.ComponentProps<"ul">
489 | >(({ className, ...props }, ref) => (
490 |   <ul
491 |     ref={ref}
492 |     data-sidebar="menu"
493 |     className={cn("flex w-full min-w-0 flex-col gap-1", className)}
494 |     {...props}
495 |   />
496 | ))
497 | SidebarMenu.displayName = "SidebarMenu"
498 | 
499 | const SidebarMenuItem = React.forwardRef<
500 |   HTMLLIElement,
501 |   React.ComponentProps<"li">
502 | >(({ className, ...props }, ref) => (
503 |   <li
504 |     ref={ref}
505 |     data-sidebar="menu-item"
506 |     className={cn("group/menu-item relative", className)}
507 |     {...props}
508 |   />
509 | ))
510 | SidebarMenuItem.displayName = "SidebarMenuItem"
511 | 
512 | const sidebarMenuButtonVariants = cva(
513 |   "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
514 |   {
515 |     variants: {
516 |       variant: {
517 |         default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
518 |         outline:
519 |           "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
520 |       },
521 |       size: {
522 |         default: "h-8 text-sm",
523 |         sm: "h-7 text-xs",
524 |         lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
525 |       },
526 |     },
527 |     defaultVariants: {
528 |       variant: "default",
529 |       size: "default",
530 |     },
531 |   }
532 | )
533 | 
534 | const SidebarMenuButton = React.forwardRef<
535 |   HTMLButtonElement,
536 |   React.ComponentProps<"button"> & {
537 |     asChild?: boolean
538 |     isActive?: boolean
539 |     tooltip?: string | React.ComponentProps<typeof TooltipContent>
540 |   } & VariantProps<typeof sidebarMenuButtonVariants>
541 | >(
542 |   (
543 |     {
544 |       asChild = false,
545 |       isActive = false,
546 |       variant = "default",
547 |       size = "default",
548 |       tooltip,
549 |       className,
550 |       ...props
551 |     },
552 |     ref
553 |   ) => {
554 |     const Comp = asChild ? Slot : "button"
555 |     const { isMobile, state } = useSidebar()
556 | 
557 |     const button = (
558 |       <Comp
559 |         ref={ref}
560 |         data-sidebar="menu-button"
561 |         data-size={size}
562 |         data-active={isActive}
563 |         className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
564 |         {...props}
565 |       />
566 |     )
567 | 
568 |     if (!tooltip) {
569 |       return button
570 |     }
571 | 
572 |     if (typeof tooltip === "string") {
573 |       tooltip = {
574 |         children: tooltip,
575 |       }
576 |     }
577 | 
578 |     return (
579 |       <Tooltip>
580 |         <TooltipTrigger asChild>{button}</TooltipTrigger>
581 |         <TooltipContent
582 |           side="right"
583 |           align="center"
584 |           hidden={state !== "collapsed" || isMobile}
585 |           {...tooltip}
586 |         />
587 |       </Tooltip>
588 |     )
589 |   }
590 | )
591 | SidebarMenuButton.displayName = "SidebarMenuButton"
592 | 
593 | const SidebarMenuAction = React.forwardRef<
594 |   HTMLButtonElement,
595 |   React.ComponentProps<"button"> & {
596 |     asChild?: boolean
597 |     showOnHover?: boolean
598 |   }
599 | >(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
600 |   const Comp = asChild ? Slot : "button"
601 | 
602 |   return (
603 |     <Comp
604 |       ref={ref}
605 |       data-sidebar="menu-action"
606 |       className={cn(
607 |         "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0",
608 |         // Increases the hit area of the button on mobile.
609 |         "after:absolute after:-inset-2 after:md:hidden",
610 |         "peer-data-[size=sm]/menu-button:top-1",
611 |         "peer-data-[size=default]/menu-button:top-1.5",
612 |         "peer-data-[size=lg]/menu-button:top-2.5",
613 |         "group-data-[collapsible=icon]:hidden",
614 |         showOnHover &&
615 |           "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
616 |         className
617 |       )}
618 |       {...props}
619 |     />
620 |   )
621 | })
622 | SidebarMenuAction.displayName = "SidebarMenuAction"
623 | 
624 | const SidebarMenuBadge = React.forwardRef<
625 |   HTMLDivElement,
626 |   React.ComponentProps<"div">
627 | >(({ className, ...props }, ref) => (
628 |   <div
629 |     ref={ref}
630 |     data-sidebar="menu-badge"
631 |     className={cn(
632 |       "absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none",
633 |       "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
634 |       "peer-data-[size=sm]/menu-button:top-1",
635 |       "peer-data-[size=default]/menu-button:top-1.5",
636 |       "peer-data-[size=lg]/menu-button:top-2.5",
637 |       "group-data-[collapsible=icon]:hidden",
638 |       className
639 |     )}
640 |     {...props}
641 |   />
642 | ))
643 | SidebarMenuBadge.displayName = "SidebarMenuBadge"
644 | 
645 | const SidebarMenuSkeleton = React.forwardRef<
646 |   HTMLDivElement,
647 |   React.ComponentProps<"div"> & {
648 |     showIcon?: boolean
649 |   }
650 | >(({ className, showIcon = false, ...props }, ref) => {
651 |   // Random width between 50 to 90%.
652 |   const width = React.useMemo(() => {
653 |     return `${Math.floor(Math.random() * 40) + 50}%`
654 |   }, [])
655 | 
656 |   return (
657 |     <div
658 |       ref={ref}
659 |       data-sidebar="menu-skeleton"
660 |       className={cn("rounded-md h-8 flex gap-2 px-2 items-center", className)}
661 |       {...props}
662 |     >
663 |       {showIcon && (
664 |         <Skeleton
665 |           className="size-4 rounded-md"
666 |           data-sidebar="menu-skeleton-icon"
667 |         />
668 |       )}
669 |       <Skeleton
670 |         className="h-4 flex-1 max-w-[--skeleton-width]"
671 |         data-sidebar="menu-skeleton-text"
672 |         style={
673 |           {
674 |             "--skeleton-width": width,
675 |           } as React.CSSProperties
676 |         }
677 |       />
678 |     </div>
679 |   )
680 | })
681 | SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton"
682 | 
683 | const SidebarMenuSub = React.forwardRef<
684 |   HTMLUListElement,
685 |   React.ComponentProps<"ul">
686 | >(({ className, ...props }, ref) => (
687 |   <ul
688 |     ref={ref}
689 |     data-sidebar="menu-sub"
690 |     className={cn(
691 |       "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
692 |       "group-data-[collapsible=icon]:hidden",
693 |       className
694 |     )}
695 |     {...props}
696 |   />
697 | ))
698 | SidebarMenuSub.displayName = "SidebarMenuSub"
699 | 
700 | const SidebarMenuSubItem = React.forwardRef<
701 |   HTMLLIElement,
702 |   React.ComponentProps<"li">
703 | >(({ ...props }, ref) => <li ref={ref} {...props} />)
704 | SidebarMenuSubItem.displayName = "SidebarMenuSubItem"
705 | 
706 | const SidebarMenuSubButton = React.forwardRef<
707 |   HTMLAnchorElement,
708 |   React.ComponentProps<"a"> & {
709 |     asChild?: boolean
710 |     size?: "sm" | "md"
711 |     isActive?: boolean
712 |   }
713 | >(({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
714 |   const Comp = asChild ? Slot : "a"
715 | 
716 |   return (
717 |     <Comp
718 |       ref={ref}
719 |       data-sidebar="menu-sub-button"
720 |       data-size={size}
721 |       data-active={isActive}
722 |       className={cn(
723 |         "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
724 |         "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
725 |         size === "sm" && "text-xs",
726 |         size === "md" && "text-sm",
727 |         "group-data-[collapsible=icon]:hidden",
728 |         className
729 |       )}
730 |       {...props}
731 |     />
732 |   )
733 | })
734 | SidebarMenuSubButton.displayName = "SidebarMenuSubButton"
735 | 
736 | export {
737 |   Sidebar,
738 |   SidebarContent,
739 |   SidebarFooter,
740 |   SidebarGroup,
741 |   SidebarGroupAction,
742 |   SidebarGroupContent,
743 |   SidebarGroupLabel,
744 |   SidebarHeader,
745 |   SidebarInput,
746 |   SidebarInset,
747 |   SidebarMenu,
748 |   SidebarMenuAction,
749 |   SidebarMenuBadge,
750 |   SidebarMenuButton,
751 |   SidebarMenuItem,
752 |   SidebarMenuSkeleton,
753 |   SidebarMenuSub,
754 |   SidebarMenuSubButton,
755 |   SidebarMenuSubItem,
756 |   SidebarProvider,
757 |   SidebarRail,
758 |   SidebarSeparator,
759 |   SidebarTrigger,
760 |   useSidebar,
761 | }
```

src/components/ui/skeleton.tsx
```
1 | import { cn } from "@/lib/utils"
2 | 
3 | function Skeleton({
4 |   className,
5 |   ...props
6 | }: React.HTMLAttributes<HTMLDivElement>) {
7 |   return (
8 |     <div
9 |       className={cn("animate-pulse rounded-md bg-muted", className)}
10 |       {...props}
11 |     />
12 |   )
13 | }
14 | 
15 | export { Skeleton }
```

src/components/ui/slider.tsx
```
1 | import * as React from "react"
2 | import * as SliderPrimitive from "@radix-ui/react-slider"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Slider = React.forwardRef<
7 |   React.ElementRef<typeof SliderPrimitive.Root>,
8 |   React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
9 | >(({ className, ...props }, ref) => (
10 |   <SliderPrimitive.Root
11 |     ref={ref}
12 |     className={cn(
13 |       "relative flex w-full touch-none select-none items-center",
14 |       className
15 |     )}
16 |     {...props}
17 |   >
18 |     <SliderPrimitive.Track className="relative h-3 w-full grow overflow-hidden rounded-full bg-secondary">
19 |       <SliderPrimitive.Range className="absolute h-full bg-story-orange-400" />
20 |     </SliderPrimitive.Track>
21 |     <SliderPrimitive.Thumb className="block h-8 w-8 rounded-full border-4 border-story-orange-400 bg-white drop-shadow-md ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
22 |   </SliderPrimitive.Root>
23 | ))
24 | Slider.displayName = SliderPrimitive.Root.displayName
25 | 
26 | export { Slider }
```

src/components/ui/sonner.tsx
```
1 | import { useTheme } from "next-themes"
2 | import { Toaster as Sonner } from "sonner"
3 | 
4 | type ToasterProps = React.ComponentProps<typeof Sonner>
5 | 
6 | const Toaster = ({ ...props }: ToasterProps) => {
7 |   const { theme = "system" } = useTheme()
8 | 
9 |   return (
10 |     <Sonner
11 |       theme={theme as ToasterProps["theme"]}
12 |       className="toaster group"
13 |       toastOptions={{
14 |         classNames: {
15 |           toast:
16 |             "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
17 |           description: "group-[.toast]:text-muted-foreground",
18 |           actionButton:
19 |             "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
20 |           cancelButton:
21 |             "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
22 |         },
23 |       }}
24 |       {...props}
25 |     />
26 |   )
27 | }
28 | 
29 | export { Toaster }
```

src/components/ui/switch.tsx
```
1 | import * as React from "react"
2 | import * as SwitchPrimitives from "@radix-ui/react-switch"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Switch = React.forwardRef<
7 |   React.ElementRef<typeof SwitchPrimitives.Root>,
8 |   React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
9 | >(({ className, ...props }, ref) => (
10 |   <SwitchPrimitives.Root
11 |     className={cn(
12 |       "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
13 |       className
14 |     )}
15 |     {...props}
16 |     ref={ref}
17 |   >
18 |     <SwitchPrimitives.Thumb
19 |       className={cn(
20 |         "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"
21 |       )}
22 |     />
23 |   </SwitchPrimitives.Root>
24 | ))
25 | Switch.displayName = SwitchPrimitives.Root.displayName
26 | 
27 | export { Switch }
```

src/components/ui/table.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | const Table = React.forwardRef<
6 |   HTMLTableElement,
7 |   React.HTMLAttributes<HTMLTableElement>
8 | >(({ className, ...props }, ref) => (
9 |   <div className="relative w-full overflow-auto">
10 |     <table
11 |       ref={ref}
12 |       className={cn("w-full caption-bottom text-sm", className)}
13 |       {...props}
14 |     />
15 |   </div>
16 | ))
17 | Table.displayName = "Table"
18 | 
19 | const TableHeader = React.forwardRef<
20 |   HTMLTableSectionElement,
21 |   React.HTMLAttributes<HTMLTableSectionElement>
22 | >(({ className, ...props }, ref) => (
23 |   <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
24 | ))
25 | TableHeader.displayName = "TableHeader"
26 | 
27 | const TableBody = React.forwardRef<
28 |   HTMLTableSectionElement,
29 |   React.HTMLAttributes<HTMLTableSectionElement>
30 | >(({ className, ...props }, ref) => (
31 |   <tbody
32 |     ref={ref}
33 |     className={cn("[&_tr:last-child]:border-0", className)}
34 |     {...props}
35 |   />
36 | ))
37 | TableBody.displayName = "TableBody"
38 | 
39 | const TableFooter = React.forwardRef<
40 |   HTMLTableSectionElement,
41 |   React.HTMLAttributes<HTMLTableSectionElement>
42 | >(({ className, ...props }, ref) => (
43 |   <tfoot
44 |     ref={ref}
45 |     className={cn(
46 |       "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
47 |       className
48 |     )}
49 |     {...props}
50 |   />
51 | ))
52 | TableFooter.displayName = "TableFooter"
53 | 
54 | const TableRow = React.forwardRef<
55 |   HTMLTableRowElement,
56 |   React.HTMLAttributes<HTMLTableRowElement>
57 | >(({ className, ...props }, ref) => (
58 |   <tr
59 |     ref={ref}
60 |     className={cn(
61 |       "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
62 |       className
63 |     )}
64 |     {...props}
65 |   />
66 | ))
67 | TableRow.displayName = "TableRow"
68 | 
69 | const TableHead = React.forwardRef<
70 |   HTMLTableCellElement,
71 |   React.ThHTMLAttributes<HTMLTableCellElement>
72 | >(({ className, ...props }, ref) => (
73 |   <th
74 |     ref={ref}
75 |     className={cn(
76 |       "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
77 |       className
78 |     )}
79 |     {...props}
80 |   />
81 | ))
82 | TableHead.displayName = "TableHead"
83 | 
84 | const TableCell = React.forwardRef<
85 |   HTMLTableCellElement,
86 |   React.TdHTMLAttributes<HTMLTableCellElement>
87 | >(({ className, ...props }, ref) => (
88 |   <td
89 |     ref={ref}
90 |     className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
91 |     {...props}
92 |   />
93 | ))
94 | TableCell.displayName = "TableCell"
95 | 
96 | const TableCaption = React.forwardRef<
97 |   HTMLTableCaptionElement,
98 |   React.HTMLAttributes<HTMLTableCaptionElement>
99 | >(({ className, ...props }, ref) => (
100 |   <caption
101 |     ref={ref}
102 |     className={cn("mt-4 text-sm text-muted-foreground", className)}
103 |     {...props}
104 |   />
105 | ))
106 | TableCaption.displayName = "TableCaption"
107 | 
108 | export {
109 |   Table,
110 |   TableHeader,
111 |   TableBody,
112 |   TableFooter,
113 |   TableHead,
114 |   TableRow,
115 |   TableCell,
116 |   TableCaption,
117 | }
```

src/components/ui/tabs.tsx
```
1 | import * as React from "react"
2 | import * as TabsPrimitive from "@radix-ui/react-tabs"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Tabs = TabsPrimitive.Root
7 | 
8 | const TabsList = React.forwardRef<
9 |   React.ElementRef<typeof TabsPrimitive.List>,
10 |   React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
11 | >(({ className, ...props }, ref) => (
12 |   <TabsPrimitive.List
13 |     ref={ref}
14 |     className={cn(
15 |       "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
16 |       className
17 |     )}
18 |     {...props}
19 |   />
20 | ))
21 | TabsList.displayName = TabsPrimitive.List.displayName
22 | 
23 | const TabsTrigger = React.forwardRef<
24 |   React.ElementRef<typeof TabsPrimitive.Trigger>,
25 |   React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
26 | >(({ className, ...props }, ref) => (
27 |   <TabsPrimitive.Trigger
28 |     ref={ref}
29 |     className={cn(
30 |       "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
31 |       className
32 |     )}
33 |     {...props}
34 |   />
35 | ))
36 | TabsTrigger.displayName = TabsPrimitive.Trigger.displayName
37 | 
38 | const TabsContent = React.forwardRef<
39 |   React.ElementRef<typeof TabsPrimitive.Content>,
40 |   React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
41 | >(({ className, ...props }, ref) => (
42 |   <TabsPrimitive.Content
43 |     ref={ref}
44 |     className={cn(
45 |       "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
46 |       className
47 |     )}
48 |     {...props}
49 |   />
50 | ))
51 | TabsContent.displayName = TabsPrimitive.Content.displayName
52 | 
53 | export { Tabs, TabsList, TabsTrigger, TabsContent }
```

src/components/ui/textarea.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | export interface TextareaProps
6 |   extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}
7 | 
8 | const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
9 |   ({ className, ...props }, ref) => {
10 |     return (
11 |       <textarea
12 |         className={cn(
13 |           "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
14 |           className
15 |         )}
16 |         ref={ref}
17 |         {...props}
18 |       />
19 |     )
20 |   }
21 | )
22 | Textarea.displayName = "Textarea"
23 | 
24 | export { Textarea }
```

src/components/ui/toast.tsx
```
1 | import * as React from "react"
2 | import * as ToastPrimitives from "@radix-ui/react-toast"
3 | import { cva, type VariantProps } from "class-variance-authority"
4 | import { X } from "lucide-react"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | const ToastProvider = ToastPrimitives.Provider
9 | 
10 | const ToastViewport = React.forwardRef<
11 |   React.ElementRef<typeof ToastPrimitives.Viewport>,
12 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
13 | >(({ className, ...props }, ref) => (
14 |   <ToastPrimitives.Viewport
15 |     ref={ref}
16 |     className={cn(
17 |       "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
18 |       className
19 |     )}
20 |     {...props}
21 |   />
22 | ))
23 | ToastViewport.displayName = ToastPrimitives.Viewport.displayName
24 | 
25 | const toastVariants = cva(
26 |   "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
27 |   {
28 |     variants: {
29 |       variant: {
30 |         default: "border bg-background text-foreground",
31 |         destructive:
32 |           "destructive group border-destructive bg-destructive text-destructive-foreground",
33 |       },
34 |     },
35 |     defaultVariants: {
36 |       variant: "default",
37 |     },
38 |   }
39 | )
40 | 
41 | const Toast = React.forwardRef<
42 |   React.ElementRef<typeof ToastPrimitives.Root>,
43 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
44 |     VariantProps<typeof toastVariants>
45 | >(({ className, variant, ...props }, ref) => {
46 |   return (
47 |     <ToastPrimitives.Root
48 |       ref={ref}
49 |       className={cn(toastVariants({ variant }), className)}
50 |       {...props}
51 |     />
52 |   )
53 | })
54 | Toast.displayName = ToastPrimitives.Root.displayName
55 | 
56 | const ToastAction = React.forwardRef<
57 |   React.ElementRef<typeof ToastPrimitives.Action>,
58 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
59 | >(({ className, ...props }, ref) => (
60 |   <ToastPrimitives.Action
61 |     ref={ref}
62 |     className={cn(
63 |       "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
64 |       className
65 |     )}
66 |     {...props}
67 |   />
68 | ))
69 | ToastAction.displayName = ToastPrimitives.Action.displayName
70 | 
71 | const ToastClose = React.forwardRef<
72 |   React.ElementRef<typeof ToastPrimitives.Close>,
73 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
74 | >(({ className, ...props }, ref) => (
75 |   <ToastPrimitives.Close
76 |     ref={ref}
77 |     className={cn(
78 |       "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
79 |       className
80 |     )}
81 |     toast-close=""
82 |     {...props}
83 |   >
84 |     <X className="h-4 w-4" />
85 |   </ToastPrimitives.Close>
86 | ))
87 | ToastClose.displayName = ToastPrimitives.Close.displayName
88 | 
89 | const ToastTitle = React.forwardRef<
90 |   React.ElementRef<typeof ToastPrimitives.Title>,
91 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
92 | >(({ className, ...props }, ref) => (
93 |   <ToastPrimitives.Title
94 |     ref={ref}
95 |     className={cn("text-sm font-semibold", className)}
96 |     {...props}
97 |   />
98 | ))
99 | ToastTitle.displayName = ToastPrimitives.Title.displayName
100 | 
101 | const ToastDescription = React.forwardRef<
102 |   React.ElementRef<typeof ToastPrimitives.Description>,
103 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
104 | >(({ className, ...props }, ref) => (
105 |   <ToastPrimitives.Description
106 |     ref={ref}
107 |     className={cn("text-sm opacity-90", className)}
108 |     {...props}
109 |   />
110 | ))
111 | ToastDescription.displayName = ToastPrimitives.Description.displayName
112 | 
113 | type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>
114 | 
115 | type ToastActionElement = React.ReactElement<typeof ToastAction>
116 | 
117 | export {
118 |   type ToastProps,
119 |   type ToastActionElement,
120 |   ToastProvider,
121 |   ToastViewport,
122 |   Toast,
123 |   ToastTitle,
124 |   ToastDescription,
125 |   ToastClose,
126 |   ToastAction,
127 | }
```

src/components/ui/toaster.tsx
```
1 | import { useToast } from "@/hooks/use-toast"
2 | import {
3 |   Toast,
4 |   ToastClose,
5 |   ToastDescription,
6 |   ToastProvider,
7 |   ToastTitle,
8 |   ToastViewport,
9 | } from "@/components/ui/toast"
10 | 
11 | export function Toaster() {
12 |   const { toasts } = useToast()
13 | 
14 |   return (
15 |     <ToastProvider>
16 |       {toasts.map(function ({ id, title, description, action, ...props }) {
17 |         return (
18 |           <Toast key={id} {...props}>
19 |             <div className="grid gap-1">
20 |               {title && <ToastTitle>{title}</ToastTitle>}
21 |               {description && (
22 |                 <ToastDescription>{description}</ToastDescription>
23 |               )}
24 |             </div>
25 |             {action}
26 |             <ToastClose />
27 |           </Toast>
28 |         )
29 |       })}
30 |       <ToastViewport />
31 |     </ToastProvider>
32 |   )
33 | }
```

src/components/ui/toggle-group.tsx
```
1 | import * as React from "react"
2 | import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
3 | import { type VariantProps } from "class-variance-authority"
4 | 
5 | import { cn } from "@/lib/utils"
6 | import { toggleVariants } from "@/components/ui/toggle"
7 | 
8 | const ToggleGroupContext = React.createContext<
9 |   VariantProps<typeof toggleVariants>
10 | >({
11 |   size: "default",
12 |   variant: "default",
13 | })
14 | 
15 | const ToggleGroup = React.forwardRef<
16 |   React.ElementRef<typeof ToggleGroupPrimitive.Root>,
17 |   React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
18 |     VariantProps<typeof toggleVariants>
19 | >(({ className, variant, size, children, ...props }, ref) => (
20 |   <ToggleGroupPrimitive.Root
21 |     ref={ref}
22 |     className={cn("flex items-center justify-center gap-1", className)}
23 |     {...props}
24 |   >
25 |     <ToggleGroupContext.Provider value={{ variant, size }}>
26 |       {children}
27 |     </ToggleGroupContext.Provider>
28 |   </ToggleGroupPrimitive.Root>
29 | ))
30 | 
31 | ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName
32 | 
33 | const ToggleGroupItem = React.forwardRef<
34 |   React.ElementRef<typeof ToggleGroupPrimitive.Item>,
35 |   React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
36 |     VariantProps<typeof toggleVariants>
37 | >(({ className, children, variant, size, ...props }, ref) => {
38 |   const context = React.useContext(ToggleGroupContext)
39 | 
40 |   return (
41 |     <ToggleGroupPrimitive.Item
42 |       ref={ref}
43 |       className={cn(
44 |         toggleVariants({
45 |           variant: context.variant || variant,
46 |           size: context.size || size,
47 |         }),
48 |         className
49 |       )}
50 |       {...props}
51 |     >
52 |       {children}
53 |     </ToggleGroupPrimitive.Item>
54 |   )
55 | })
56 | 
57 | ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName
58 | 
59 | export { ToggleGroup, ToggleGroupItem }
```

src/components/ui/toggle.tsx
```
1 | import * as React from "react"
2 | import * as TogglePrimitive from "@radix-ui/react-toggle"
3 | import { cva, type VariantProps } from "class-variance-authority"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const toggleVariants = cva(
8 |   "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",
9 |   {
10 |     variants: {
11 |       variant: {
12 |         default: "bg-transparent",
13 |         outline:
14 |           "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
15 |       },
16 |       size: {
17 |         default: "h-10 px-3",
18 |         sm: "h-9 px-2.5",
19 |         lg: "h-11 px-5",
20 |       },
21 |     },
22 |     defaultVariants: {
23 |       variant: "default",
24 |       size: "default",
25 |     },
26 |   }
27 | )
28 | 
29 | const Toggle = React.forwardRef<
30 |   React.ElementRef<typeof TogglePrimitive.Root>,
31 |   React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &
32 |     VariantProps<typeof toggleVariants>
33 | >(({ className, variant, size, ...props }, ref) => (
34 |   <TogglePrimitive.Root
35 |     ref={ref}
36 |     className={cn(toggleVariants({ variant, size, className }))}
37 |     {...props}
38 |   />
39 | ))
40 | 
41 | Toggle.displayName = TogglePrimitive.Root.displayName
42 | 
43 | export { Toggle, toggleVariants }
```

src/components/ui/tooltip.tsx
```
1 | import * as React from "react"
2 | import * as TooltipPrimitive from "@radix-ui/react-tooltip"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const TooltipProvider = TooltipPrimitive.Provider
7 | 
8 | const Tooltip = TooltipPrimitive.Root
9 | 
10 | const TooltipTrigger = TooltipPrimitive.Trigger
11 | 
12 | const TooltipContent = React.forwardRef<
13 |   React.ElementRef<typeof TooltipPrimitive.Content>,
14 |   React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
15 | >(({ className, sideOffset = 4, ...props }, ref) => (
16 |   <TooltipPrimitive.Content
17 |     ref={ref}
18 |     sideOffset={sideOffset}
19 |     className={cn(
20 |       "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
21 |       className
22 |     )}
23 |     {...props}
24 |   />
25 | ))
26 | TooltipContent.displayName = TooltipPrimitive.Content.displayName
27 | 
28 | export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

src/components/ui/use-toast.ts
```
1 | import { useToast, toast } from "@/hooks/use-toast";
2 | 
3 | export { useToast, toast };
```

src/services/ai/GenerateStoryService.ts
```
1 | // src/services/ai/GenerateStoryService.ts
2 | import { StoryOptions, Story } from "../../types"; // Importar Story si no está
3 | import { supabase } from "../../supabaseClient";
4 | 
5 | export interface GenerateStoryParams {
6 |   options: Partial<StoryOptions>; // O el tipo completo si siempre está completo
7 |   language?: string;
8 |   additionalDetails?: string; // <-- Añadir nueva propiedad
9 | }
10 | 
11 | // Definir el tipo de respuesta esperada de la Edge Function
12 | export interface GenerateStoryResponse {
13 |   content: string;
14 |   title: string;
15 | }
16 | 
17 | export class GenerateStoryService {
18 |   /**
19 |    * Generates initial story content and title using the 'generate-story' Edge Function.
20 |    */
21 |   public static async generateStoryWithAI(params: GenerateStoryParams): Promise<GenerateStoryResponse> {
22 |     try {
23 |       console.log('Sending request to generate-story Edge Function with params:', params); // Log parameters
24 | 
25 |       // Make sure to pass the authentication token if the function requires it (it does)
26 |       const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
27 |       if (sessionError || !sessionData.session) {
28 |         throw new Error(sessionError?.message || 'User not authenticated.');
29 |       }
30 |       const token = sessionData.session.access_token;
31 | 
32 |       // Validate character structure to ensure compatibility with new schema
33 |       if (params.options.characters && params.options.characters.length > 0) {
34 |         const validGenders = ['male', 'female', 'non-binary'];
35 |         for (const character of params.options.characters) {
36 |           if (!character.name || typeof character.name !== 'string' || character.name.trim().length === 0) {
37 |             throw new Error(`Invalid character: missing or empty name field`);
38 |           }
39 |           if (!character.gender || !validGenders.includes(character.gender)) {
40 |             throw new Error(`Invalid character "${character.name}": gender must be one of ${validGenders.join(', ')}`);
41 |           }
42 |           if (!character.description || typeof character.description !== 'string' || character.description.trim().length === 0) {
43 |             throw new Error(`Invalid character "${character.name}": missing or empty description field`);
44 |           }
45 |         }
46 |         console.log('✅ Character structure validation passed');
47 |       }
48 | 
49 |       // DEBUG: Log the exact payload being sent including character info
50 |       const charactersInfo = `Characters (${params.options.characters?.length || 0}): ${params.options.characters?.map(c => `${c.name} (${c.gender})`).join(', ') || 'None'}`;
51 |       console.log(`>>> Payload being sent to generate-story: ${charactersInfo}`);
52 |       console.log(">>> Full payload:", JSON.stringify(params, null, 2));
53 | 
54 |       const { data, error } = await supabase.functions.invoke<GenerateStoryResponse>('generate-story', { // Specify response type <T>
55 |         body: params, // Body already contains options, language, etc. and additionalDetails
56 |         headers: {
57 |           'Authorization': `Bearer ${token}` // Pass the token
58 |         }
59 |       });
60 | 
61 |       if (error) {
62 |         console.error('Error in generate-story Edge Function:', error);
63 |         // You can try to get more error details if it's an HttpError
64 |         let message = error.message;
65 |         if ((error as any).context) { // Supabase FunctionsHttpError has 'context'
66 |           message = `${message} - ${JSON.stringify((error as any).context)}`;
67 |         }
68 |         throw new Error(message);
69 |       }
70 | 
71 |       // Validate that the response has the expected format { content: string, title: string }
72 |       if (!data || typeof data.content !== 'string' || typeof data.title !== 'string') {
73 |         console.error('Unexpected response from generate-story:', data);
74 |         throw new Error('The generate-story response does not contain valid content and title.');
75 |       }
76 | 
77 |       console.log('Response from generate-story received (title):', data.title);
78 |       return data; // Return the complete { content, title } object
79 | 
80 |     } catch (error) {
81 |       console.error('Error in GenerateStoryService.generateStoryWithAI:', error);
82 |       // Re-throw so the caller (storyGenerator) can handle it
83 |       throw error;
84 |     }
85 |   }
86 | }
```

src/services/ai/StoryContinuationService.ts
```
1 | // src/services/StoryContinuationService.ts
2 | import { Story, StoryChapter } from "../../types"; // Importa tus tipos
3 | import { supabase } from "../../supabaseClient";
4 | 
5 | // Definir el tipo de respuesta esperada para continuaciones
6 | interface ContinuationResponse {
7 |   content: string;
8 |   title: string;
9 | }
10 | // Definir tipo para opciones generadas
11 | interface OptionsResponse {
12 |   options: { summary: string }[];
13 | }
14 | 
15 | 
16 | export class StoryContinuationService {
17 | 
18 |   /**
19 |    * Llama a la Edge Function 'story-continuation' para diferentes acciones.
20 |    * @param action La acción a realizar ('generateOptions', 'freeContinuation', etc.)
21 |    * @param payload Los datos específicos para esa acción.
22 |    * @returns La respuesta de la Edge Function (depende de la acción).
23 |    */
24 |   private static async invokeContinuationFunction<T = any>(action: string, payload: object): Promise<T> {
25 |     console.log(`Enviando solicitud a la Edge Function story-continuation (action: ${action})...`);
26 | 
27 |     const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
28 |     if (sessionError || !sessionData.session) {
29 |       throw new Error(sessionError?.message || 'Usuario no autenticado.');
30 |     }
31 |     const token = sessionData.session.access_token;
32 | 
33 |     const bodyPayload = {
34 |       action: action,
35 |       ...payload // Incluir el resto de los datos (story, chapters, etc.)
36 |     };
37 | 
38 |     // Log character information for debugging (consistent with GenerateStoryService)
39 |     if (bodyPayload.story && bodyPayload.story.options && bodyPayload.story.options.characters) {
40 |       const characters = bodyPayload.story.options.characters;
41 |       const charactersInfo = `Characters (${characters.length}): ${characters.map(c => `${c.name} (${c.gender})`).join(', ')}`;
42 |       console.log(`[StoryContinuationService] ${charactersInfo}`);
43 |     }
44 | 
45 |     try {
46 |       const jsonBodyString = JSON.stringify(bodyPayload, null, 2); // Pretty print
47 |       console.log(`[StoryContinuationService_DEBUG] Body payload AFTER stringify (length: ${jsonBodyString?.length}):\n---\n${jsonBodyString}\n---`);
48 |     } catch (stringifyError) {
49 |         console.error('[StoryContinuationService_DEBUG] Error during JSON.stringify:', stringifyError, 'Payload was:', bodyPayload);
50 |         throw new Error('Failed to stringify payload before sending to edge function.'); // Re-throw or handle
51 |     }
52 | 
53 |     const { data, error } = await supabase.functions.invoke<T>('story-continuation', { // Usar tipo genérico o específico
54 |       body: bodyPayload, // PASAR EL OBJETO DIRECTAMENTE
55 |       headers: {
56 |         'Authorization': `Bearer ${token}`
57 |         // 'Content-Type': 'application/json' // DEJAR QUE INVOKE LO MANEJE
58 |       }
59 |     });
60 | 
61 |     if (error) {
62 |       console.error(`Error en Edge Function story-continuation (action: ${action}):`, error);
63 |       let message = error.message;
64 |       if ((error as any).context) {
65 |         message = `${message} - ${JSON.stringify((error as any).context)}`;
66 |       }
67 |       throw new Error(message);
68 |     }
69 | 
70 |     console.log(`Respuesta recibida de story-continuation (action: ${action})`);
71 |     return data as T; // Devolver datos (casteo puede ser necesario)
72 |   }
73 | 
74 |   /**
75 |    * Genera opciones de continuación.
76 |    */
77 |   public static async generateContinuationOptions(
78 |     story: Story, 
79 |     chapters: StoryChapter[]
80 |   ): Promise<OptionsResponse> {
81 |     const response = await this.invokeContinuationFunction<OptionsResponse>('generateOptions', { 
82 |       story, 
83 |       chapters, 
84 |       language: story.options.language
85 |     });
86 |     if (!response || !Array.isArray(response.options)) {
87 |       console.error("Respuesta inválida para generateOptions:", response);
88 |       throw new Error("No se pudieron generar las opciones de continuación.");
89 |     }
90 |     return response;
91 |   }
92 | 
93 |   /**
94 |    * Genera una continuación libre (contenido y título).
95 |    */
96 |   public static async generateFreeContinuation(story: Story, chapters: StoryChapter[]): Promise<ContinuationResponse> {
97 |     const response = await this.invokeContinuationFunction<ContinuationResponse>('freeContinuation', { 
98 |       story, 
99 |       chapters, 
100 |       language: story.options.language 
101 |     });
102 |     if (!response || typeof response.content !== 'string' || typeof response.title !== 'string') {
103 |       console.error("Respuesta inválida para freeContinuation:", response);
104 |       throw new Error("No se pudo generar la continuación libre.");
105 |     }
106 |     return response;
107 |   }
108 | 
109 |   /**
110 |    * Genera una continuación basada en una opción seleccionada (contenido y título).
111 |    */
112 |   public static async generateOptionContinuation(story: Story, chapters: StoryChapter[], selectedOptionSummary: string): Promise<ContinuationResponse> {
113 |     const response = await this.invokeContinuationFunction<ContinuationResponse>('optionContinuation', { 
114 |       story, 
115 |       chapters, 
116 |       selectedOptionSummary, 
117 |       language: story.options.language 
118 |     });
119 |     if (!response || typeof response.content !== 'string' || typeof response.title !== 'string') {
120 |       console.error("Respuesta inválida para optionContinuation:", response);
121 |       throw new Error("No se pudo generar la continuación de opción.");
122 |     }
123 |     return response;
124 |   }
125 | 
126 |   /**
127 |    * Genera una continuación basada en la dirección del usuario (contenido y título).
128 |    */
129 |   public static async generateDirectedContinuation(story: Story, chapters: StoryChapter[], userDirection: string): Promise<ContinuationResponse> {
130 |     const response = await this.invokeContinuationFunction<ContinuationResponse>('directedContinuation', { 
131 |       story, 
132 |       chapters, 
133 |       userDirection, 
134 |       language: story.options.language 
135 |     });
136 |     if (!response || typeof response.content !== 'string' || typeof response.title !== 'string') {
137 |       console.error("Respuesta inválida para directedContinuation:", response);
138 |       throw new Error("No se pudo generar la continuación dirigida.");
139 |     }
140 |     return response;
141 |   }
142 | 
143 |   // generateChapterTitle ya no es necesaria para el flujo principal
144 |   // public static async generateChapterTitle(content: string): Promise<{ title: string }> {
145 |   //    // ... (código anterior si quieres mantenerla por alguna razón, pero no se llamará desde generateStory)
146 |   // }
147 | }
```

src/services/ai/imageGenerationService.ts
```
1 | import { SYSTEM_PROMPT_BASE, IMAGES_TYPE } from '@/constants/story-images.constant';
2 | import { supabase } from '@/supabaseClient';
3 | import OpenAI from "openai";
4 | 
5 | interface ImageGenerationOptions {
6 |   title: string;
7 |   content: string;
8 |   storyId: string;
9 |   chapterId?: string | number;
10 | }
11 | 
12 | interface GeneratedImage {
13 |   type: string;
14 |   url: string;
15 |   prompt: string;
16 | }
17 | 
18 | interface ImageGenerationResult {
19 |   success: boolean;
20 |   images: GeneratedImage[];
21 |   error?: string;
22 | }
23 | 
24 | /**
25 |  * Service for generating story images using OpenAI GPT-4.1-mini with image generation tools
26 |  */
27 | export class ImageGenerationService {
28 |   private static readonly MODEL = 'gpt-image-1';
29 |   private static openai = new OpenAI({
30 |     apiKey: import.meta.env.VITE_OPEN_AI_API_KEY,
31 |     dangerouslyAllowBrowser: true // Solo para desarrollo, en producción usar Edge Functions
32 |   });
33 | 
34 |   /**
35 |    * Generates all story images (cover, scenes, character) asynchronously
36 |    * @param options Story data for image generation
37 |    * @returns Promise with generation results
38 |    */
39 |   static async generateStoryImages(options: ImageGenerationOptions): Promise<ImageGenerationResult> {
40 |     const { title, content, storyId, chapterId = 1 } = options;
41 |     
42 |     try {
43 |       console.log('[ImageGeneration] Starting image generation for story:', storyId);
44 |       
45 |       // Create prompts for each image type
46 |       const prompts = this.createImagePrompts(title, content);
47 |       
48 |       // Generate all images concurrently for speed
49 |       const imagePromises = Object.entries(prompts).map(([imageType, prompt]) =>
50 |         this.generateSingleImage(imageType, prompt, storyId, chapterId)
51 |       );
52 |       
53 |       const results = await Promise.allSettled(imagePromises);
54 |       
55 |       // Process results
56 |       const successfulImages: GeneratedImage[] = [];
57 |       const errors: string[] = [];
58 |       
59 |       results.forEach((result, index) => {
60 |         const imageType = Object.keys(prompts)[index];
61 |         
62 |         if (result.status === 'fulfilled' && result.value.success) {
63 |           successfulImages.push(result.value.image!);
64 |         } else if (result.status === 'rejected') {
65 |           errors.push(`${imageType}: ${result.reason}`);
66 |         } else if (result.status === 'fulfilled' && !result.value.success) {
67 |           errors.push(`${imageType}: ${result.value.error}`);
68 |         }
69 |       });
70 |       
71 |       console.log(`[ImageGeneration] Generated ${successfulImages.length}/${Object.keys(prompts).length} images successfully`);
72 |       
73 |       return {
74 |         success: successfulImages.length > 0,
75 |         images: successfulImages,
76 |         error: errors.length > 0 ? errors.join('; ') : undefined
77 |       };
78 |       
79 |     } catch (error) {
80 |       console.error('[ImageGeneration] Error generating story images:', error);
81 |       return {
82 |         success: false,
83 |         images: [],
84 |         error: error instanceof Error ? error.message : 'Error desconocido'
85 |       };
86 |     }
87 |   }
88 | 
89 |   /**
90 |    * Creates specific prompts for each image type
91 |    * CHARACTER is generated first to establish visual consistency for scenes
92 |    */
93 |   private static createImagePrompts(title: string, content: string): Record<string, string> {
94 |     const baseContext = `**Cuento:**
95 | Título: ${title}
96 | Cuento: ${content}`;
97 | 
98 |     return {
99 |     [IMAGES_TYPE.COVER]: `${SYSTEM_PROMPT_BASE}
100 | 
101 | ${baseContext}
102 | 
103 | Genera una imagen de PORTADA que capture la esencia del cuento. Debe incluir el título de manera artística y elementos visuales que representen la historia principal, manteniendo la misma estética del personaje principal. Estilo acuarela tradicional de cuento infantil.`,
104 | 
105 |       [IMAGES_TYPE.SCENE_1]: `${SYSTEM_PROMPT_BASE}
106 | 
107 | ${baseContext}
108 | 
109 | Genera una imagen de la PRIMERA ESCENA más importante del cuento, donde el PERSONAJE PRINCIPAL debe ser el elemento central de la composición. Debe mostrar un momento clave de la historia con el protagonista en acción, manteniendo las características visuales establecidas del personaje. Estilo acuarela tradicional de cuento infantil.`,
110 | 
111 |       [IMAGES_TYPE.SCENE_2]: `${SYSTEM_PROMPT_BASE}
112 | 
113 | ${baseContext}
114 | 
115 | Genera una imagen de la SEGUNDA ESCENA más importante del cuento, donde el PERSONAJE PRINCIPAL debe ser prominente en la escena. Debe representar otro momento crucial diferente al anterior, mostrando al protagonista en una situación distinta pero manteniendo continuidad visual y las características del personaje establecidas. Estilo acuarela tradicional de cuento infantil.`
116 |     };
117 |   }
118 | 
119 |   /**
120 |    * Generates a single image and uploads it to Supabase
121 |    */
122 |   private static async generateSingleImage(
123 |     imageType: string, 
124 |     prompt: string, 
125 |     storyId: string, 
126 |     chapterId: string | number
127 |   ): Promise<{ success: boolean; image?: GeneratedImage; error?: string }> {
128 |     try {
129 |       console.log(`[ImageGeneration] Generating ${imageType} image...`);
130 |       
131 |       // Generate image with OpenAI
132 |       const imageBase64 = await this.callOpenAIImageGeneration(prompt);
133 |       
134 |       if (!imageBase64) {
135 |         throw new Error('No image data returned from OpenAI');
136 |       }
137 |       
138 |       // Upload to Supabase via Edge Function
139 |       const uploadResult = await this.uploadImageToSupabase(imageBase64, imageType, storyId, chapterId);
140 |       
141 |       if (!uploadResult.success) {
142 |         throw new Error(`Upload failed: ${uploadResult.error}`);
143 |       }
144 |       
145 |       console.log(`[ImageGeneration] Successfully generated and uploaded ${imageType}`);
146 |       
147 |       return {
148 |         success: true,
149 |         image: {
150 |           type: imageType,
151 |           url: uploadResult.publicUrl!,
152 |           prompt: prompt
153 |         }
154 |       };
155 |       
156 |     } catch (error) {
157 |       console.error(`[ImageGeneration] Error generating ${imageType}:`, error);
158 |       return {
159 |         success: false,
160 |         error: error instanceof Error ? error.message : 'Error desconocido'
161 |       };
162 |     }
163 |   }
164 | 
165 |   /**
166 |    * Calls OpenAI API to generate image using GPT-4.1-mini with image generation tools
167 |    */
168 |   private static async callOpenAIImageGeneration(prompt: string): Promise<string | null> {
169 |     try {
170 |       const response = await this.openai.images.generate({
171 |         model: this.MODEL,
172 |         prompt: prompt,
173 |         n: 1,
174 |         quality: "medium",
175 |         size: "1024x1536",
176 |         background: "opaque"
177 |       });
178 | 
179 | 
180 |       return response.data[0].b64_json;
181 |     } catch (error) {
182 |       console.error('[ImageGeneration] OpenAI API error:', error);
183 |       throw new Error(`OpenAI API error: ${error instanceof Error ? error.message : 'Unknown error'}`);
184 |     }
185 |   }
186 | 
187 |   /**
188 |    * Uploads generated image to Supabase storage via Edge Function
189 |    */
190 |   private static async uploadImageToSupabase(
191 |     imageBase64: string, 
192 |     imageType: string, 
193 |     storyId: string, 
194 |     chapterId: string | number
195 |   ): Promise<{ success: boolean; publicUrl?: string; error?: string }> {
196 |     try {
197 |       console.log(`[ImageGeneration] Uploading ${imageType} via Supabase invoke...`);
198 | 
199 |       const { data: functionResponse, error: functionError } = await supabase.functions.invoke(
200 |         'upload-story-image',
201 |         {
202 |           body: {
203 |             imageBase64,
204 |             imageType,
205 |             storyId,
206 |             chapterId: chapterId.toString()
207 |           }
208 |         }
209 |       );
210 | 
211 |       if (functionError) {
212 |         console.error('[ImageGeneration] Function error:', functionError);
213 |         throw new Error(`Function error: ${functionError.message}`);
214 |       }
215 | 
216 |       if (!functionResponse?.success) {
217 |         const errorMsg = functionResponse?.error || functionResponse?.details || 'Unknown upload error';
218 |         throw new Error(`Upload failed: ${errorMsg}`);
219 |       }
220 | 
221 |       console.log(`[ImageGeneration] Successfully uploaded ${imageType}:`, functionResponse.publicUrl);
222 | 
223 |       return {
224 |         success: true,
225 |         publicUrl: functionResponse.publicUrl
226 |       };
227 |       
228 |     } catch (error) {
229 |       console.error('[ImageGeneration] Upload error:', error);
230 |       return {
231 |         success: false,
232 |         error: error instanceof Error ? error.message : 'Error de subida'
233 |       };
234 |     }
235 |   }
236 | } 
```

src/services/ai/ttsService.ts
```
1 | // src/services/ai/ttsService.ts
2 | import { SYSTEM_PROMPT } from '@/constants/story-voices.constant';
3 | import OpenAI from 'openai';
4 | 
5 | /**
6 |  * Servicio para generar audio a partir de texto usando la API REST de OpenAI
7 |  * No usa Supabase ni funciones edge; realiza un fetch directo con tu clave.
8 |  */
9 | export type OpenAIVoiceType =
10 |   | 'alloy'
11 |   | 'echo'
12 |   | 'fable'
13 |   | 'onyx'
14 |   | 'nova'
15 |   | 'shimmer'
16 |   | 'coral'
17 |   | 'sage'
18 |   | 'ash';
19 | 
20 | export interface TTSOptions {
21 |   text: string;
22 |   voice?: OpenAIVoiceType;
23 |   model?: string;
24 |   instructions?: string;
25 | }
26 | 
27 | interface OpenAIError {
28 |   status?: number;
29 |   code?: string | number;
30 |   message?: string;
31 | }
32 | 
33 | function isOpenAIError(error: unknown): error is OpenAIError {
34 |   return typeof error === 'object' && error !== null;
35 | }
36 | 
37 | // Voces disponibles en OpenAI
38 | export const OPENAI_VOICES = [
39 |   { id: 'alloy' as const, name: 'Alloy', description: 'Alloy (Neutral)' },
40 |   { id: 'echo' as const, name: 'Echo', description: 'Echo (Masculino)' },
41 |   { id: 'fable' as const, name: 'Fable', description: 'Fable (Fantasía)' },
42 |   { id: 'onyx' as const, name: 'Onyx', description: 'Onyx (Masculino)' },
43 |   { id: 'nova' as const, name: 'Nova', description: 'Nova (Femenina)' },
44 |   { id: 'shimmer' as const, name: 'Shimmer', description: 'Shimmer (Femenina)' },
45 |   { id: 'coral' as const, name: 'Coral', description: 'Coral (Femenina)' },
46 |   { id: 'sage' as const, name: 'Sage', description: 'Sage (Narrador)' },
47 |   { id: 'ash' as const, name: 'Ash', description: 'Ash (Juvenil)' }
48 | ];
49 | 
50 | // Inicializar cliente de OpenAI
51 | const openai = new OpenAI({
52 |   apiKey: import.meta.env.VITE_OPEN_AI_API_KEY,
53 |   dangerouslyAllowBrowser: true // Permitir uso en el navegador
54 | });
55 | 
56 | // Función para obtener las voces disponibles
57 | export const getAvailableVoices = async () => {
58 |   return OPENAI_VOICES;
59 | };
60 | 
61 | /**
62 |  * Genera audio a partir de texto usando la API del cliente oficial de OpenAI
63 |  */
64 | export const generateSpeech = async ({
65 |   text,
66 |   voice = 'nova',
67 |   model,
68 |   instructions
69 | }: TTSOptions): Promise<Blob> => {
70 |   if (!text || text.trim() === '') {
71 |     throw new Error('El texto es requerido');
72 |   }
73 | 
74 |   // Limpiar el texto antes de procesarlo
75 |   const cleanedText = cleanTextForSpeech(text);
76 | 
77 |   // Combinar el system prompt con las instrucciones específicas del narrador
78 |   const fullInstructions = instructions 
79 |     ? `${SYSTEM_PROMPT} ${instructions}`
80 |     : SYSTEM_PROMPT;
81 | 
82 |   console.log(`Iniciando generación de audio... Texto limpio: ${cleanedText.length} caracteres`);
83 | 
84 |   console.log(`Configuración: Voz=${voice}, Modelo=${model}`);
85 |   
86 |   try {
87 |     // Llamar directamente a la API de OpenAI usando el cliente oficial
88 |     const response = await openai.audio.speech.create({
89 |       model,
90 |       voice,
91 |       input: cleanedText,
92 |       instructions: fullInstructions
93 |     });
94 | 
95 |     // Convertir la respuesta a un Blob usando arrayBuffer
96 |     const buffer = await response.arrayBuffer();
97 |     const audioBlob = new Blob([buffer], { type: 'audio/mpeg' });
98 |     
99 |     console.log("Blob de audio creado:", audioBlob.size, "bytes");
100 |     console.log('Audio generado correctamente');
101 |     
102 |     return audioBlob;
103 |   } catch (error: unknown) {
104 |     console.error('Error en generación de voz:', error);
105 |     
106 |     const openAIError = isOpenAIError(error) ? error as OpenAIError : null;
107 |     
108 |     // Manejar específicamente el error 429 (Too Many Requests)
109 |     if (openAIError?.status === 429 || openAIError?.code === 429) {
110 |       throw new Error('Alcanzaste el máximo de créditos para generar un audio');
111 |     }
112 |     
113 |     if (openAIError?.status === 401 || openAIError?.code === 'invalid_api_key') {
114 |       throw new Error('Error de autenticación con el servicio de voz');
115 |     }
116 |     
117 |     if (openAIError?.status === 400) {
118 |       throw new Error('El texto proporcionado no es válido para generar audio');
119 |     }
120 |     
121 |     if (openAIError?.status && openAIError.status >= 500) {
122 |       throw new Error('El servicio de voz no está disponible temporalmente');
123 |     }
124 |     
125 |     const errorMessage = error instanceof Error ? error.message : 'Error inesperado al generar el audio';
126 |     throw new Error(errorMessage);
127 |   }
128 | };
129 | 
130 | function cleanTextForSpeech(text: string): string {
131 |   return text
132 |     // Mantener caracteres especiales españoles
133 |     .replace(/[^\w\s.,!?áéíóúñÁÉÍÓÚÑ-]/g, '')
134 |     // Normalizar espacios
135 |     .replace(/\s+/g, ' ')
136 |     // Agregar pausas naturales
137 |     .replace(/([.!?])\s+/g, '$1\n')
138 |     .replace(/([.,])\s+/g, '$1 ')
139 |     // Eliminar líneas vacías múltiples
140 |     .replace(/\n\s*\n/g, '\n')
141 |     .trim();
142 | }
```

src/store/core/createStore.ts
```
1 | import { create } from 'zustand';
2 | import { persist } from 'zustand/middleware';
3 | 
4 | // Almacenamiento global del ID de usuario autenticado
5 | let currentAuthUserId: string | null = null;
6 | // Lista de stores que necesitan ser refrescados cuando cambia el usuario
7 | const storesRegistry: {[key: string]: Function} = {};
8 | 
9 | /**
10 |  * Establece el ID del usuario autenticado actualmente
11 |  * Esta función debe ser llamada desde el componente de autenticación
12 |  */
13 | export const setCurrentAuthUser = (userId: string | null) => {
14 |   console.log(`Cambiando usuario autenticado de [${currentAuthUserId}] a [${userId}]`);
15 |   
16 |   if (userId !== currentAuthUserId) {
17 |     // Si cambia el usuario, limpiar stores anteriores
18 |     if (userId) {
19 |       cleanPreviousUserStores(userId);
20 |       // Notificar a todos los stores registrados para que se actualicen
21 |       refreshAllStores();
22 |     }
23 |     currentAuthUserId = userId;
24 |   }
25 | };
26 | 
27 | /**
28 |  * Limpia los stores que no pertenecen al usuario actual
29 |  */
30 | export const cleanPreviousUserStores = (currentUserId: string) => {
31 |   console.log(`Limpiando stores previos para usuario: ${currentUserId}`);
32 |   
33 |   let cleaned = 0;
34 |   for (let i = 0; i < localStorage.length; i++) {
35 |     const key = localStorage.key(i);
36 |     if (key && key.startsWith('story-app-')) {
37 |       // Si no es una clave del usuario actual y no es la clave global de usuario
38 |       if (!key.includes(`-${currentUserId}-`) && !key.includes('story-app-user')) {
39 |         console.log(`Eliminando store: ${key}`);
40 |         localStorage.removeItem(key);
41 |         i--; // Ajustar el índice
42 |         cleaned++;
43 |       }
44 |     }
45 |   }
46 |   console.log(`Se limpiaron ${cleaned} stores anteriores`);
47 |   
48 |   // Identificar las claves que coinciden con el store de personajes
49 |   const characterKeys = [];
50 |   for (let i = 0; i < localStorage.length; i++) {
51 |     const key = localStorage.key(i);
52 |     if (key && key.includes('-characters')) {
53 |       characterKeys.push(key);
54 |       try {
55 |         const value = JSON.parse(localStorage.getItem(key) || '{}');
56 |         console.log(`[DEBUG] Clave ${key}, tiene ${value?.state?.savedCharacters?.length || 0} personajes`);
57 |       } catch (error) {
58 |         console.error(`[DEBUG] Error al analizar clave ${key}:`, error);
59 |       }
60 |     }
61 |   }
62 |   
63 |   console.log(`[DEBUG] Claves de personajes encontradas: ${characterKeys.join(', ')}`);
64 | };
65 | 
66 | /**
67 |  * Refresca todos los stores registrados para que carguen datos frescos
68 |  */
69 | export const refreshAllStores = () => {
70 |   console.log(`Refrescando ${Object.keys(storesRegistry).length} stores registrados`);
71 |   
72 |   Object.keys(storesRegistry).forEach(storeName => {
73 |     const refreshFn = storesRegistry[storeName];
74 |     if (typeof refreshFn === 'function') {
75 |       console.log(`Refrescando store: ${storeName}`);
76 |       try {
77 |         refreshFn();
78 |       } catch (error) {
79 |         console.error(`Error refrescando store ${storeName}:`, error);
80 |       }
81 |     }
82 |   });
83 | };
84 | 
85 | /**
86 |  * Registra una función para refrescar un store cuando cambia el usuario
87 |  */
88 | export const registerStoreRefresh = (storeName: string, refreshFn: Function) => {
89 |   storesRegistry[storeName] = refreshFn;
90 |   console.log(`Store ${storeName} registrado para refresco automático`);
91 | };
92 | 
93 | /**
94 |  * Crea un store persistente con Zustand que incluye el ID del usuario en el nombre
95 |  * para garantizar que cada usuario tenga sus propios datos
96 |  */
97 | export const createPersistentStore = <T>(
98 |   initialState: Partial<T>,
99 |   storeLogic: (set: Function, get: Function) => Partial<T>,
100 |   storeName: string
101 | ) => {
102 |   const fullStoreName = getStoreNameWithUserId(storeName);
103 |   
104 |   // Crear el store
105 |   const useStore = create<T>()(
106 |     persist(
107 |       (set, get) => ({
108 |         ...initialState,
109 |         ...storeLogic(set, get)
110 |       }) as T,
111 |       {
112 |         name: fullStoreName,
113 |       }
114 |     )
115 |   );
116 |   
117 |   return useStore;
118 | };
119 | 
120 | /**
121 |  * Genera un nombre de store único para cada usuario basado en su ID
122 |  */
123 | const getStoreNameWithUserId = (baseName: string): string => {
124 |   // Si hay un usuario autenticado, usar su ID
125 |   const userId = currentAuthUserId || 'anonymous';
126 |   
127 |   // El store para el usuario tiene que incluir su ID
128 |   const storeName = `story-app-${userId}-${baseName}`;
129 |   console.log(`Creando/accediendo store: ${storeName}`);
130 |   return storeName;
131 | }; 
```

src/store/core/utils.ts
```
1 | import { StoryCharacter } from "../../types";
2 | import { v4 as uuidv4 } from "uuid";
3 | 
4 | /**
5 |  * Genera un ID único formato UUID, compatible con PostgreSQL
6 |  * Reemplaza la implementación anterior que usaba prefijos personalizados
7 |  */
8 | export const generateId = (prefix: string = "id") => {
9 |   return uuidv4();
10 | };
11 | 
12 | /**
13 |  * Crea un personaje con valores por defecto y un ID único totalmente nuevo
14 |  */
15 | export const createDefaultCharacter = (): StoryCharacter => {
16 |   const newId = generateId("char");
17 |   console.log(`Creando personaje por defecto con nuevo ID: ${newId}`);
18 |   return {
19 |     id: newId,
20 |     name: "",
21 |     hobbies: [],
22 |     description: "",
23 |     profession: "",
24 |     characterType: "",
25 |     personality: "",
26 |   }
27 | };
```

src/store/stories/storiesStore.ts
```
1 | import { StoriesState } from "../types/storeTypes";
2 | import { createPersistentStore } from "../core/createStore";
3 | import { getUserStories, syncQueue, syncStory } from "../../services/supabase";
4 | import { useUserStore } from "../user/userStore";
5 | 
6 | // Estado inicial
7 | const initialState: Pick<
8 |   StoriesState,
9 |   "generatedStories" | "isGeneratingStory" | "isLoadingStories"
10 | > = {
11 |   generatedStories: [],
12 |   isGeneratingStory: false,
13 |   isLoadingStories: false,
14 | };
15 | 
16 | export const useStoriesStore = createPersistentStore<StoriesState>(
17 |   initialState,
18 |   (set, get) => ({
19 |     setIsGeneratingStory: (isGenerating) =>
20 |       set({
21 |         isGeneratingStory: isGenerating,
22 |       }),
23 | 
24 |     addGeneratedStory: async (story) => {
25 |       console.log("🚀 ~ addGeneratedStory: ~ story:", story)
26 |       // Guardar localmente primero
27 |       set((state) => ({
28 |         generatedStories: [story, ...state.generatedStories],
29 |       }));
30 | 
31 |       // Luego sincronizar con Supabase
32 |       try {
33 |         const user = useUserStore.getState().user;
34 | 
35 |         if (user) {
36 |           const { success } = await syncStory(user.id, story);
37 | 
38 |           if (!success) {
39 |             // Si falla, agregar a la cola de sincronización
40 |             syncQueue.addToQueue("stories", "insert", {
41 |               id: story.id,
42 |               user_id: user.id,
43 |               title: story.title,
44 |               content: story.content,
45 |               audio_url: story.audioUrl,
46 |               genre: story.options.genre,
47 |               story_format: story.options.format,
48 |               character_id: story.options.characters[0]?.id, // Primary character
49 |               additional_details: story.additional_details,
50 |             });
51 |           }
52 |         }
53 |       } catch (error) {
54 |         console.error("Error sincronizando historia con Supabase:", error);
55 |       }
56 |     },
57 | 
58 |     getStoryById: (id) => {
59 |       return get().generatedStories.find((story) => story.id === id);
60 |     },
61 | 
62 |     loadStoriesFromSupabase: async (userId?: string) => {
63 |       const user = useUserStore.getState().user;
64 |       if (!user) return;
65 | 
66 |       set({ isLoadingStories: true });
67 |       try {
68 |         console.log(`Cargando historias para usuario ${user.id}`);
69 | 
70 |         // IMPORTANTE: Limpiar antes de cargar
71 |         set({ generatedStories: [] });
72 | 
73 |         const { success, stories } = await getUserStories(user.id);
74 | 
75 |         if (success && stories) {
76 |           console.log(`Cargadas ${stories.length} historias de Supabase`);
77 |           set({ generatedStories: stories });
78 |         } else {
79 |           console.warn("No se encontraron historias o hubo un error");
80 |         }
81 |       } catch (error) {
82 |         console.error("Error al cargar historias:", error);
83 |       } finally {
84 |         set({ isLoadingStories: false });
85 |       }
86 |     },
87 |   }),
88 |   "stories",
89 | );
```

src/store/stories/storyGenerator.ts
```
1 | // src/store/stories/storyGenerator.ts
2 | import { toast } from "sonner";
3 | import { Story, StoryOptions, StoryChapter } from "../../types";
4 | import { useStoriesStore } from "./storiesStore";
5 | import { useUserStore } from "../user/userStore";
6 | import { charactersService } from "../../services/charactersService";
7 | import { useStoryOptionsStore } from "../storyOptions/storyOptionsStore";
8 | import { generateId } from "../core/utils";
9 | import { GenerateStoryService, GenerateStoryParams } from "@/services/ai/GenerateStoryService";
10 | import { useChaptersStore } from "./chapters/chaptersStore";
11 | 
12 | /**
13 |  * Genera una historia completa (Capítulo 1 + Título) a partir de las opciones
14 |  */
15 | export const generateStory = async (options: Partial<StoryOptions>): Promise<Story | null> => {
16 |   const storiesStore = useStoriesStore.getState();
17 |   const chaptersStore = useChaptersStore.getState();
18 |   const storyOptionsState = useStoryOptionsStore.getState();
19 |   const userStore = useUserStore.getState();
20 | 
21 |   console.log("🔍 DEBUG - Opciones generación historia:", JSON.stringify(options, null, 2));
22 |   console.log("🔍 DEBUG - Detalles Adicionales:", storyOptionsState.additionalDetails);
23 | 
24 |   storiesStore.setIsGeneratingStory(true);
25 | 
26 |   try {
27 |     const storyId = generateId();
28 |     const profileSettings = userStore.profileSettings;
29 |     const user = userStore.user;
30 |     const additionalDetails = storyOptionsState.additionalDetails;
31 | 
32 |     if (!user) {
33 |       throw new Error("Usuario no autenticado");
34 |     }
35 | 
36 |     // Obtener todos los personajes del usuario para poder filtrar los seleccionados
37 |     const allCharacters = await charactersService.getUserCharacters(user.id);
38 |     const selectedCharacters = storyOptionsState.getSelectedCharactersForStory(allCharacters);
39 | 
40 |     // --- DEBUG: Detailed parameter logging BEFORE building payload --- 
41 |     console.log("🔍 DEBUG PRE-PAYLOAD: Profile Data ->", JSON.stringify(profileSettings, null, 2));
42 |     console.log("🔍 DEBUG PRE-PAYLOAD: Selected Characters ->", JSON.stringify(selectedCharacters, null, 2));
43 |     console.log("🔍 DEBUG PRE-PAYLOAD: Options Received (function) ->", JSON.stringify(options, null, 2));
44 |     console.log("🔍 DEBUG PRE-PAYLOAD: Format (store) ->", storyOptionsState.currentStoryOptions.format);
45 |     console.log("🔍 DEBUG PRE-PAYLOAD: Additional Details ->", additionalDetails);
46 |     // --- END DEBUG ---
47 | 
48 |     if (!profileSettings) throw new Error("User profile not loaded.");
49 |     if (!selectedCharacters || selectedCharacters.length === 0) throw new Error("No characters selected.");
50 | 
51 |     // --- SINGLE call to service that invokes 'generate-story' EF ---
52 |     const payload: GenerateStoryParams = {
53 |       options: {
54 |         characters: selectedCharacters,
55 |         genre: options.genre,
56 |         format: storyOptionsState.currentStoryOptions.format,
57 |       },
58 |       language: profileSettings.language,
59 |       additionalDetails: additionalDetails || undefined,
60 |     };
61 | 
62 |     console.log("Sending request to generate-story Edge Function with params:", payload);
63 | 
64 |     const storyResponse = await GenerateStoryService.generateStoryWithAI(payload);
65 |     // storyResponse ahora es { content: string, title: string }
66 |     console.log(`[storyGenerator_DEBUG] Title received from Service: "${storyResponse.title}"`);
67 | 
68 |     // Los personajes seleccionados ya están guardados, no necesitamos save individual
69 |     // Solo guardamos currentCharacter si se usó para creación de personaje nuevo
70 | 
71 |     // Crear el objeto historia con título y contenido de la respuesta
72 |     const story: Story = {
73 |       id: storyId,
74 |       title: storyResponse.title,
75 |       content: storyResponse.content,
76 |       options: {
77 |         characters: selectedCharacters,
78 |         genre: options.genre || "adventure",
79 |         format: storyOptionsState.currentStoryOptions.format || "episodic",
80 |         language: payload.language,
81 |       },
82 |       additional_details: additionalDetails,
83 |       createdAt: new Date().toISOString(),
84 |       // audioUrl se añadirá después si se genera
85 |     };
86 | 
87 |     console.log("🔍 DEBUG - Story Created:", JSON.stringify(story.options, null, 2));
88 |     console.log(`[storyGenerator_DEBUG] Title being saved to store: "${story.title}"`);
89 | 
90 |     // 1. Save the main story (as before)
91 |     // Save the generated story in the store
92 |     await storiesStore.addGeneratedStory(story);
93 | 
94 |     // 2. Create and save Chapter 1
95 |     const firstChapter: StoryChapter = {
96 |       id: generateId(),
97 |       chapterNumber: 1,
98 |       title: story.title,
99 |       content: story.content,
100 |       generationMethod: 'free',
101 |       createdAt: new Date().toISOString(),
102 |       // customInput doesn't apply here
103 |     };
104 |     await chaptersStore.addChapter(story.id, firstChapter);
105 | 
106 |     // Clear temporarily stored story options
107 |     storyOptionsState.resetStoryOptions();
108 | 
109 |     return story;
110 | 
111 |   } catch (error: any) {
112 |     console.error("Error generating story in storyGenerator:", error);
113 |     toast.error("Error generating story", {
114 |       description: error?.message || "Please try again.",
115 |     });
116 |     // Consider if you should also call resetStoryOptions here
117 |     storyOptionsState.resetStoryOptions();
118 |     return null;
119 |   } finally {
120 |     storiesStore.setIsGeneratingStory(false);
121 |   }
122 | };
```

src/store/storyOptions/storyOptionsStore.ts
```
1 | import { StoryOptionsState } from '../types/storeTypes';
2 | import { StoryOptions, StoryFormat, StoryCharacter } from '../../types';
3 | import { createPersistentStore } from '../core/createStore';
4 | import { charactersService } from '../../services/charactersService';
5 | 
6 | // Estado inicial
7 | const initialState: Pick<StoryOptionsState, 'currentStoryOptions' | 'additionalDetails' | 'selectedCharacterIds'> = {
8 |   currentStoryOptions: {},
9 |   additionalDetails: null,
10 |   selectedCharacterIds: [],
11 | };
12 | 
13 | export const useStoryOptionsStore = createPersistentStore<StoryOptionsState>(
14 |   initialState,
15 |   (set) => ({
16 |     updateStoryOptions: (options) => set((state) => ({
17 |       currentStoryOptions: { ...state.currentStoryOptions, ...options }
18 |     })),
19 |     
20 |     resetStoryOptions: () => set({ 
21 |       currentStoryOptions: {}, 
22 |       additionalDetails: null,
23 |       selectedCharacterIds: []
24 |     }),
25 |     
26 |     setFormat: (format) => set((state) => ({
27 |       currentStoryOptions: { ...state.currentStoryOptions, format }
28 |     })),
29 |     
30 |     setGenre: (genre) => set((state) => ({
31 |       currentStoryOptions: { ...state.currentStoryOptions, genre }
32 |     })),
33 |     
34 |     setAdditionalDetails: (details) => set({ additionalDetails: details }),
35 |     
36 |     // Multiple character selection functions
37 |     setSelectedCharacterIds: (characterIds: string[]) => set({ selectedCharacterIds: characterIds }),
38 |     
39 |     getSelectedCharactersForStory: (allCharacters?: StoryCharacter[]) => {
40 |       const state = useStoryOptionsStore.getState();
41 |       
42 |       if (!allCharacters) {
43 |         console.warn('getSelectedCharactersForStory: No characters provided, returning empty array');
44 |         return [];
45 |       }
46 |       
47 |       return charactersService.getSelectedCharactersByIds(state.selectedCharacterIds, allCharacters);
48 |     },
49 |     
50 |     updateSelectedCharacters: (characters: StoryCharacter[]) => {
51 |       const characterIds = characters.map(char => char.id);
52 |       set((state) => ({
53 |         selectedCharacterIds: characterIds,
54 |         currentStoryOptions: {
55 |           ...state.currentStoryOptions,
56 |           // Usar siempre el array de personajes (simplificado)
57 |           characters: characters
58 |         }
59 |       }));
60 |     },
61 |   }),
62 |   'story-options'
63 | );
```

src/store/types/storeTypes.ts
```
1 | import {
2 |   ProfileSettings,
3 |   Story,
4 |   StoryChapter,
5 |   StoryCharacter,
6 |   StoryFormat,
7 |   StoryOptions,
8 |   StoryWithChapters,
9 |   User,
10 | } from "../../types";
11 | 
12 | // Tipos específicos para los stores
13 | export interface UserState {
14 |   user: User | null;
15 |   profileSettings: ProfileSettings | null;
16 |   intendedRedirectPath: string | null; // Añadido para gestionar redirecciones
17 | 
18 |   loginUser: (user: User) => void;
19 |   logoutUser: () => void;
20 |   setProfileSettings: (settings: Partial<ProfileSettings>) => void;
21 |   hasCompletedProfile: () => boolean;
22 |   checkAuth: () => Promise<User | null>;
23 | 
24 |   // Nuevos selectores para suscripción y límites
25 |   isPremium: () => boolean;
26 |   getRemainingMonthlyStories: () => number;
27 |   canCreateStory: () => boolean;
28 |   getRemainingMonthlyVoiceGenerations: () => number;
29 |   getAvailableVoiceCredits: () => number;
30 |   canGenerateVoice: () => boolean;
31 |   canContinueStory: (storyId: string) => boolean;
32 | }
33 | 
34 | // CharacterState interface removed - character functionality moved to charactersService
35 | 
36 | export interface StoryOptionsState {
37 |   currentStoryOptions: Partial<StoryOptions>;
38 |   additionalDetails?: string | null;
39 |   // Multiple character selection support
40 |   selectedCharacterIds: string[];
41 | 
42 |   updateStoryOptions: (options: Partial<StoryOptions>) => void;
43 |   resetStoryOptions: () => void;
44 |   setFormat: (format: StoryFormat) => void;  // era setDuration
45 |   setGenre: (genre: string) => void;
46 |   setAdditionalDetails: (details?: string | null) => void;
47 | 
48 |   // Multiple character selection functions
49 |   setSelectedCharacterIds: (characterIds: string[]) => void;
50 |   getSelectedCharactersForStory: () => StoryCharacter[];
51 |   updateSelectedCharacters: (characters: StoryCharacter[]) => void;
52 | }
53 | 
54 | export interface StoriesState {
55 |   generatedStories: Story[];
56 |   isGeneratingStory: boolean;
57 |   isLoadingStories: boolean;
58 | 
59 |   setIsGeneratingStory: (isGenerating: boolean) => void;
60 |   addGeneratedStory: (story: Story) => void;
61 |   getStoryById: (id: string) => Story | undefined;
62 |   loadStoriesFromSupabase: () => Promise<void>;
63 | }
64 | 
65 | export interface ChaptersState {
66 |   storyChapters: StoryWithChapters[];
67 | 
68 |   getChaptersByStoryId: (storyId: string) => StoryChapter[];
69 |   addChapter: (storyId: string, chapter: StoryChapter) => void;
70 |   getLastChapterByStoryId: (storyId: string) => StoryChapter | undefined;
71 |   loadChaptersFromSupabase: (storyId: string) => Promise<void>;
72 | }
73 | 
74 | export interface AudioState {
75 |   audioCache: {
76 |     [key: string]: {
77 |       url: string;
78 |       timestamp: string;
79 |     };
80 |   };
81 |   generationStatus: {
82 |     [key: string]: {
83 |       status: "idle" | "generating" | "completed" | "error";
84 |       progress: number;
85 |     };
86 |   };
87 |   currentVoice: string | null;
88 | 
89 |   addAudioToCache: (
90 |     storyId: string,
91 |     chapterId: string | number,
92 |     voiceId: string,
93 |     audioUrl: string,
94 |   ) => void;
95 |   getAudioFromCache: (
96 |     storyId: string,
97 |     chapterId: string | number,
98 |     voiceId: string,
99 |   ) => string | null;
100 |   setGenerationStatus: (
101 |     storyId: string,
102 |     chapterId: string | number,
103 |     status: "idle" | "generating" | "completed" | "error",
104 |     progress?: number,
105 |   ) => void;
106 |   getGenerationStatus: (
107 |     storyId: string,
108 |     chapterId: string | number,
109 |   ) => { status: string; progress: number };
110 |   setCurrentVoice: (voiceId: string) => void;
111 |   getCurrentVoice: () => string | null;
112 |   clearOldAudioCache: (olderThanDays?: number) => void;
113 |   loadAudioFromSupabase: () => Promise<void>;
114 | }
115 | 
116 | // StoryState legacy interface removed - using individual state interfaces instead
```

src/store/user/userStore.ts
```
1 | // src/store/user/userStore.ts
2 | 
3 | import { UserState } from "../types/storeTypes";
4 | import { ProfileSettings, User } from "../../types";
5 | import { createPersistentStore, setCurrentAuthUser } from "../core/createStore";
6 | import { getCurrentUser, logout } from "../../supabaseAuth";
7 | import {
8 |   getUserProfile,
9 |   syncQueue,
10 |   syncUserProfile,
11 | } from "../../services/supabase";
12 | import { supabase } from "../../supabaseClient";
13 | import { useChaptersStore } from '../stories/chapters/chaptersStore';
14 | 
15 | const PREMIUM_MONTHLY_VOICE_ALLOWANCE = 20; // Max free monthly voice generations for premium
16 | 
17 | // Estado inicial
18 | const initialState: Pick<UserState, "user" | "profileSettings" | "intendedRedirectPath"> = {
19 |   user: null,
20 |   profileSettings: null,
21 |   intendedRedirectPath: null, // Inicializado
22 | };
23 | 
24 | // Lógica del store
25 | export const useUserStore = createPersistentStore<UserState>(
26 |   initialState,
27 |   (set, get) => ({
28 |     loginUser: async (user: User): Promise<void> => {
29 |        setCurrentAuthUser(user.id);
30 |        set({ user, intendedRedirectPath: null });
31 | 
32 |        try {
33 |            // Una sola consulta para cargar perfil
34 |            const { success, profile } = await getUserProfile(user.id);
35 |            
36 |            if (success && profile) {
37 |                set({ profileSettings: profile });
38 |                const redirectPath = profile.has_completed_setup ? '/home' : '/profile-config';
39 |                set({ intendedRedirectPath: redirectPath });
40 |            } else {
41 |                // Si no hay perfil, debe ir a configuración
42 |                set({ intendedRedirectPath: '/profile-config' });
43 |            }
44 | 
45 |            // Cargar otros datos en segundo plano (no bloqueante)
46 |            syncAllUserData(user.id);
47 |        } catch (error) {
48 |            console.error("Error cargando datos de usuario:", error);
49 |            set({ intendedRedirectPath: '/profile-config' });
50 |        }
51 |     },
52 | 
53 |     logoutUser: async () => {
54 |       // Guardar una referencia al usuario actual antes de cerrar sesión
55 |       const currentUser = get().user;
56 | 
57 |       // Intentar sincronizar datos pendientes antes de cerrar sesión
58 |       if (currentUser) {
59 |         await syncQueue.processQueue();
60 |       }
61 | 
62 |       // Cerrar sesión en Supabase
63 |       await logout();
64 | 
65 |       // Limpiar el estado del store
66 |       set({ user: null, profileSettings: null, intendedRedirectPath: null });
67 | 
68 |       // Actualizar usuario en el store global (ningún usuario autenticado)
69 |       setCurrentAuthUser(null);
70 |     },
71 | 
72 |     setProfileSettings: async (settings: Partial<ProfileSettings>) => {
73 |       // 1. Merge partial settings with current state
74 |       set((state) => ({
75 |         profileSettings: {
76 |           // Ensure we have a base object even if profileSettings was null
77 |           ...(state.profileSettings || { has_completed_setup: false }), // Default has_completed_setup if null
78 |           ...settings,
79 |         } as ProfileSettings // Assert as ProfileSettings after merge
80 |       }));
81 | 
82 |       // 2. Sincronizar solo los campos proporcionados con Supabase
83 |       const user = get().user;
84 |       if (user) {
85 |         // 3. Construir objeto solo con los campos presentes en 'settings'
86 |         const syncData: { [key: string]: any } = {};
87 |         // Mapeo de camelCase (TypeScript) a snake_case (Supabase)
88 |         const keyMap: { [K in keyof ProfileSettings]?: string } = {
89 |           preferences: 'preferences',
90 |           language: 'language',
91 |           has_completed_setup: 'has_completed_setup', // Añadir mapeo si alguna vez se actualiza por aquí
92 |           // Añadir otros campos editables si es necesario
93 |         };
94 | 
95 |         for (const key in settings) {
96 |           if (Object.prototype.hasOwnProperty.call(settings, key)) {
97 |             const mappedKey = keyMap[key as keyof ProfileSettings];
98 |             if (mappedKey) {
99 |               // Asegurar que el valor no sea undefined antes de asignarlo
100 |               const value = settings[key as keyof ProfileSettings];
101 |               if (value !== undefined) {
102 |                 syncData[mappedKey] = value;
103 |               }
104 |             }
105 |           }
106 |         }
107 | 
108 |         // No sincronizar si no hay datos válidos para enviar
109 |         if (Object.keys(syncData).length === 0) {
110 |           console.log("setProfileSettings: No hay datos editables válidos para sincronizar.");
111 |           return;
112 |         }
113 | 
114 |         try {
115 |           // 4. Intentar la sincronización directa
116 |           const { success, error: syncError } = await syncUserProfile(user.id, syncData as any);
117 |           if (!success) {
118 |             console.warn("Sincronización directa fallida, añadiendo a la cola:", syncError);
119 |             // 5. Si falla, agregarlo a la cola de sincronización
120 |             syncQueue.addToQueue("profiles", "update", { id: user.id, ...syncData });
121 |           }
122 |         } catch (error) {
123 |           console.error("Error sincronizando perfil con Supabase:", error);
124 |           // 6. Agregar a la cola de sincronización en caso de error
125 |           syncQueue.addToQueue("profiles", "update", { id: user.id, ...syncData });
126 |         }
127 |       }
128 |     },
129 | 
130 |     hasCompletedProfile: () => {
131 |       const profile = get().profileSettings;
132 |       // Considerar el perfil completado si existe y el flag es true
133 |       return !!profile && profile.has_completed_setup;
134 |     },
135 | 
136 |     // --- Selectores Actualizados/Nuevos ---
137 |     isPremium: () => {
138 |       const status = get().profileSettings?.subscription_status;
139 |       return status === 'active' || status === 'trialing';
140 |     },
141 | 
142 |     getRemainingMonthlyStories: () => {
143 |       const settings = get().profileSettings;
144 |       // Si es premium, devuelve infinito (o un número grande), si no, calcula el restante de 10.
145 |       if (get().isPremium() || !settings) return Infinity;
146 |       return Math.max(0, 10 - (settings.monthly_stories_generated || 0));
147 |     },
148 | 
149 |     canCreateStory: () => {
150 |       return get().getRemainingMonthlyStories() > 0;
151 |     },
152 | 
153 |     getRemainingMonthlyVoiceGenerations: () => {
154 |       const settings = get().profileSettings;
155 |       // Solo aplica a premium, devuelve 0 si no lo es.
156 |       if (!get().isPremium() || !settings) return 0;
157 |       // Asumiendo 20 generaciones gratis al mes
158 |       return Math.max(0, 20 - (settings.monthly_voice_generations_used || 0));
159 |     },
160 | 
161 |     getAvailableVoiceCredits: () => {
162 |       return get().profileSettings?.voice_credits || 0;
163 |     },
164 | 
165 |     canGenerateVoice: () => {
166 |       const settings = get().profileSettings;
167 |       console.log('[canGenerateVoice_DEBUG] Checking canGenerateVoice. Settings:', settings);
168 | 
169 |       // a. Handle missing profile
170 |       if (!settings) {
171 |         console.warn('[canGenerateVoice_DEBUG] No profile settings found. Denying voice generation.');
172 |         return false;
173 |       }
174 | 
175 |       // b. Get values safely
176 |       const subscriptionStatus = settings.subscription_status;
177 |       const monthlyGenerationsUsed = settings.monthly_voice_generations_used ?? 0;
178 |       const voiceCredits = settings.voice_credits ?? 0;
179 | 
180 |       // c. Determine if premium
181 |       const isPremium = subscriptionStatus === 'active' || subscriptionStatus === 'trialing';
182 |       console.log(`[canGenerateVoice_DEBUG] User Status: ${subscriptionStatus}, Is Premium: ${isPremium}`);
183 | 
184 |       // d. Main logic
185 |       if (isPremium) {
186 |         const hasMonthlyGenerations = monthlyGenerationsUsed < PREMIUM_MONTHLY_VOICE_ALLOWANCE;
187 |         const hasPurchasedCredits = voiceCredits > 0;
188 |         const allowed = hasMonthlyGenerations || hasPurchasedCredits;
189 |         console.log(`[canGenerateVoice_DEBUG] Premium Check - Monthly Used: ${monthlyGenerationsUsed}/${PREMIUM_MONTHLY_VOICE_ALLOWANCE}, Credits: ${voiceCredits}. Allowed: ${allowed}`);
190 |         return allowed;
191 |       } else {
192 |         // Non-premium (Free, Canceled, etc.)
193 |         const hasPurchasedCredits = voiceCredits > 0;
194 |         console.log(`[canGenerateVoice_DEBUG] Non-Premium Check - Credits: ${voiceCredits}. Allowed: ${hasPurchasedCredits}`);
195 |         return hasPurchasedCredits; // Only allowed if they have purchased credits
196 |       }
197 |     },
198 | 
199 |     canContinueStory: (storyId: string) => {
200 |       if (get().isPremium()) return true; // Premium puede continuar ilimitadamente
201 | 
202 |       // Gratuito: obtener capítulos y contar
203 |       const chapters = useChaptersStore.getState().getChaptersByStoryId(storyId);
204 |       // Permite si hay menos de 2 capítulos (Cap 1 inicial + 1 continuación)
205 |       return chapters.length < 2;
206 |     },
207 | 
208 |     checkAuth: async (): Promise<User | null> => {
209 |        try {
210 |            const { user, error } = await getCurrentUser();
211 | 
212 |            if (user && !error) {
213 |                set({ user });
214 |                
215 |                // Solo cargar perfil si no está en cache
216 |                const currentProfile = get().profileSettings;
217 |                if (!currentProfile || currentProfile.id !== user.id) {
218 |                    const { success, profile } = await getUserProfile(user.id);
219 |                    if (success && profile) {
220 |                        set({ profileSettings: profile });
221 |                    }
222 |                }
223 |                
224 |                return user;
225 |            } else {
226 |                set({ user: null, profileSettings: null });
227 |                return null;
228 |            }
229 |        } catch (e) {
230 |            console.error("Error en checkAuth:", e);
231 |            set({ user: null, profileSettings: null });
232 |            return null;
233 |        }
234 |     },
235 |   }),
236 |   "user",
237 | );
238 | 
239 | // Función para sincronizar todos los datos del usuario desde Supabase
240 | async function syncAllUserData(userId: string) {
241 |   console.log(`Iniciando carga completa para usuario: ${userId}`);
242 | 
243 |   // 1. Cargar datos de historias desde Supabase
244 |   // Nota: Los personajes ahora se cargan directamente en las páginas según sea necesario
245 |   const otherStores = [
246 |     { store: (await import('../stories/storiesStore')).useStoriesStore, method: 'loadStoriesFromSupabase' },
247 |     // Character store eliminado - los personajes se cargan directamente vía charactersService
248 |     // Agrega otros stores aquí
249 |   ];
250 | 
251 |   // 2. Cargar secuencialmente
252 |   for (const { store, method } of otherStores) {
253 |     try {
254 |       console.log(`Cargando datos con método: ${method}`);
255 |       await store.getState()[method](userId);
256 |     } catch (error) {
257 |       console.error(`Error cargando datos con ${method}:`, error);
258 |     }
259 |   }
260 | 
261 |   console.log("Sincronización completa");
262 | }
```

supabase/functions/_shared/cors.ts
```
1 | // supabase/functions/_shared/cors.ts
2 | 
3 | export const corsHeaders = {
4 |   // For development: include localhost
5 |   'Access-Control-Allow-Origin': '*',
6 |   
7 |   // If you need to support multiple origins, you can use this instead
8 |   // and add logic in your function to set the appropriate origin
9 |   // 'Access-Control-Allow-Origin': '*', 
10 |   
11 |   'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
12 |   'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
13 |   'Access-Control-Max-Age': '86400',  // 24 hours caching for preflight requests
14 | };
```

supabase/functions/create-checkout-session/index.ts
```
1 | // supabase/functions/create-checkout-session/index.ts
2 | 
3 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
4 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
5 | import Stripe from 'https://esm.sh/stripe@14.13.0?target=deno';
6 | import { corsHeaders } from '../_shared/cors.ts'; // Ruta corregida
7 | 
8 | console.log(`[CREATE_CHECKOUT_DEBUG] Function create-checkout-session initializing...`);
9 | 
10 | // Inicializa Stripe
11 | const stripeSecretKey = Deno.env.get('STRIPE_SECRET_KEY');
12 | if (!stripeSecretKey) {
13 |   console.error("[CREATE_CHECKOUT_ERROR] CRITICAL: STRIPE_SECRET_KEY environment variable is not set.");
14 |   // Considera lanzar un error si falta
15 | }
16 | const stripe = new Stripe(stripeSecretKey!, {
17 |   apiVersion: '2023-10-16',
18 |   httpClient: Stripe.createFetchHttpClient(),
19 | });
20 | 
21 | // Obtén la URL base
22 | const appBaseUrl = Deno.env.get('APP_BASE_URL');
23 | if (!appBaseUrl) {
24 |   console.error("[CREATE_CHECKOUT_ERROR] APP_BASE_URL environment variable is not set.");
25 |   // Considera lanzar un error
26 | }
27 | 
28 | serve(async (req: Request) => {
29 |   // Gestiona preflight CORS
30 |   if (req.method === 'OPTIONS') {
31 |     console.log('[CREATE_CHECKOUT_DEBUG] Handling OPTIONS preflight request');
32 |     return new Response('ok', { headers: corsHeaders });
33 |   }
34 | 
35 |   console.log(`[CREATE_CHECKOUT_DEBUG] Handling ${req.method} request`);
36 | 
37 |   try {
38 |     // 1. Inicializa cliente Supabase
39 |     const supabaseClient = createClient(
40 |       Deno.env.get('SUPABASE_URL') ?? '',
41 |       Deno.env.get('SUPABASE_ANON_KEY') ?? '',
42 |       { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
43 |     );
44 | 
45 |     // 2. Verifica autenticación
46 |     const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
47 |     if (userError || !user) {
48 |       console.error('[CREATE_CHECKOUT_ERROR] Authentication error:', userError?.message || 'No user found');
49 |       return new Response(JSON.stringify({ error: 'Usuario no autenticado o inválido.' }), {
50 |         status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' },
51 |       });
52 |     }
53 |     console.log(`[CREATE_CHECKOUT_DEBUG] Authenticated user ID: ${user.id}`);
54 | 
55 |     // 3. Parsea el cuerpo y determina el item
56 |     let priceId: string | null = null;
57 |     let mode: 'payment' | 'subscription' = 'payment';
58 |     let finalMetadata = {}; // Usamos un nombre diferente para claridad
59 | 
60 |     const requestBody = await req.json();
61 |     const item = requestBody.item;
62 |     console.log(`[CREATE_CHECKOUT_DEBUG] Received request to purchase item: "${item}"`);
63 | 
64 |     if (item === 'premium') {
65 |       priceId = Deno.env.get('PREMIUM_PLAN_PRICE_ID');
66 |       mode = 'subscription';
67 |       finalMetadata = { supabase_user_id: user.id };
68 |       console.log(`[CREATE_CHECKOUT_DEBUG] Mode set to 'subscription'. Metadata for subscription_data: ${JSON.stringify(finalMetadata)}`);
69 |     } else if (item === 'credits') {
70 |       priceId = Deno.env.get('VOICE_CREDITS_PRICE_ID');
71 |       mode = 'payment';
72 |       // !! VERIFICACIÓN CLAVE !!
73 |       finalMetadata = { supabase_user_id: user.id, item_purchased: 'voice_credits' };
74 |       console.log(`[CREATE_CHECKOUT_DEBUG] Mode set to 'payment'. Metadata for payment_intent_data: ${JSON.stringify(finalMetadata)}`);
75 |     } else {
76 |       console.error(`[CREATE_CHECKOUT_ERROR] Invalid item requested: ${item}`);
77 |       return new Response(JSON.stringify({ error: 'Artículo solicitado inválido.' }), {
78 |         status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' },
79 |       });
80 |     }
81 | 
82 |     if (!priceId) {
83 |       console.error(`[CREATE_CHECKOUT_ERROR] Stripe Price ID is not configured in env variables for item: ${item}. Check PREMIUM_PLAN_PRICE_ID or VOICE_CREDITS_PRICE_ID.`);
84 |       throw new Error('Error de configuración del servidor: falta el ID de precio.');
85 |     }
86 |     console.log(`[CREATE_CHECKOUT_DEBUG] Resolved Price ID: ${priceId}, Mode: ${mode}`);
87 | 
88 |     // 4. Busca o crea cliente Stripe
89 |     let stripeCustomerId: string;
90 |     const { data: profile, error: profileError } = await supabaseClient
91 |       .from('profiles')
92 |       .select('stripe_customer_id')
93 |       .eq('id', user.id)
94 |       .maybeSingle();
95 | 
96 |     if (profileError) {
97 |       console.error('[CREATE_CHECKOUT_ERROR] Database error fetching profile:', profileError);
98 |       throw new Error('Error al consultar el perfil del usuario.');
99 |     }
100 | 
101 |     if (profile?.stripe_customer_id) {
102 |       stripeCustomerId = profile.stripe_customer_id;
103 |       console.log(`[CREATE_CHECKOUT_DEBUG] Found existing Stripe Customer ID: ${stripeCustomerId}`);
104 |     } else {
105 |       console.log(`[CREATE_CHECKOUT_DEBUG] Stripe Customer ID not found for user ${user.id}. Creating new Stripe Customer...`);
106 |       const customer = await stripe.customers.create({
107 |         email: user.email,
108 |         metadata: { supabase_user_id: user.id }, // Metadata en el cliente Stripe
109 |       });
110 |       stripeCustomerId = customer.id;
111 |       console.log(`[CREATE_CHECKOUT_DEBUG] Created new Stripe Customer ID: ${stripeCustomerId}. Updating profile...`);
112 | 
113 |       const { error: updateError } = await supabaseClient
114 |         .from('profiles')
115 |         .update({ stripe_customer_id: stripeCustomerId })
116 |         .eq('id', user.id);
117 | 
118 |       if (updateError) {
119 |         console.error('[CREATE_CHECKOUT_ERROR] Failed to update profile with Stripe Customer ID:', updateError);
120 |         throw new Error('No se pudo actualizar el perfil del usuario con la información de Stripe.');
121 |       }
122 |       console.log(`[CREATE_CHECKOUT_DEBUG] Profile updated successfully with Stripe Customer ID.`);
123 |     }
124 | 
125 |     // 6. Prepara y crea la sesión de Stripe Checkout
126 |     console.log(`[CREATE_CHECKOUT_DEBUG] Preparing Stripe Checkout session for Customer ${stripeCustomerId}...`);
127 |     const sessionParams: Stripe.Checkout.SessionCreateParams = {
128 |       customer: stripeCustomerId,
129 |       payment_method_types: ['card'],
130 |       line_items: [{ price: priceId, quantity: 1 }],
131 |       mode: mode,
132 |       success_url: `${appBaseUrl}/payment-success?session_id={CHECKOUT_SESSION_ID}`,
133 |       cancel_url: `${appBaseUrl}/payment-cancel`,
134 |       // Adjunta metadata relevante según el modo
135 |       ...(mode === 'subscription' && {
136 |         subscription_data: { metadata: finalMetadata } // Metadata para suscripciones
137 |       }),
138 |       ...(mode === 'payment' && {
139 |         payment_intent_data: { metadata: finalMetadata } // !! Metadata para pagos únicos (créditos) !!
140 |       }),
141 |     };
142 | 
143 |     // !! LOG ANTES DE CREAR !!
144 |     console.log(`[CREATE_CHECKOUT_DEBUG] Session parameters being sent to Stripe: ${JSON.stringify(sessionParams)}`);
145 | 
146 |     const session = await stripe.checkout.sessions.create(sessionParams);
147 |     console.log(`[CREATE_CHECKOUT_DEBUG] Stripe Checkout session created: ${session.id}, URL: ${session.url}`);
148 | 
149 |     // 7. Devuelve la URL
150 |     return new Response(JSON.stringify({ url: session.url }), {
151 |       headers: { ...corsHeaders, 'Content-Type': 'application/json' },
152 |       status: 200,
153 |     });
154 | 
155 |   } catch (error) {
156 |     console.error('[CREATE_CHECKOUT_ERROR] Unhandled error in create-checkout-session:', error);
157 |     return new Response(JSON.stringify({ error: `Error interno del servidor: ${error.message}` }), {
158 |       status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' },
159 |     });
160 |   }
161 | });
```

supabase/functions/create-customer-portal-session/index.ts
```
1 | // supabase/functions/create-customer-portal-session/index.ts
2 | 
3 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
4 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
5 | import Stripe from 'https://esm.sh/stripe@14.13.0?target=deno';
6 | import { corsHeaders } from '../_shared/cors.ts'; // Ruta corregida
7 | 
8 | console.log(`Function create-customer-portal-session initializing...`);
9 | 
10 | // --- Variables de Entorno y Cliente Stripe ---
11 | const stripeSecretKey = Deno.env.get('STRIPE_SECRET_KEY');
12 | const appBaseUrl = Deno.env.get('APP_BASE_URL');
13 | 
14 | // Verificación inicial (fuera del handler para errores de configuración tempranos)
15 | if (!stripeSecretKey) {
16 |     console.error("FATAL: STRIPE_SECRET_KEY environment variable is not set.");
17 |     // La función fallará al intentar inicializar Stripe, pero este log ayuda.
18 | }
19 | if (!appBaseUrl) {
20 |     console.error("FATAL: APP_BASE_URL environment variable is not set.");
21 |     // La verificación dentro del handler devolverá error 500 al cliente.
22 | }
23 | 
24 | // Inicializa Stripe con la clave secreta (si existe)
25 | // El '!' aquí es menos crítico porque si es null, Stripe() lanzará un error claro.
26 | // Pero es más seguro haberlo verificado antes.
27 | const stripe = new Stripe(stripeSecretKey!, {
28 |   apiVersion: '2023-10-16',
29 |   httpClient: Stripe.createFetchHttpClient(),
30 | });
31 | // --- Fin Variables y Cliente ---
32 | 
33 | 
34 | serve(async (req: Request) => {
35 |   // Gestiona la solicitud preflight CORS del navegador
36 |   if (req.method === 'OPTIONS') {
37 |     console.log('Handling OPTIONS preflight request');
38 |     return new Response('ok', { headers: corsHeaders });
39 |   }
40 | 
41 |   console.log(`Handling ${req.method} request`);
42 | 
43 |   try {
44 |     // Verificar de nuevo la variable APP_BASE_URL dentro del handler para poder retornar una respuesta
45 |     if (!appBaseUrl) {
46 |       // Este log ya se mostró al inicio, pero aquí retornamos error al cliente
47 |       console.error("Configuration Error: APP_BASE_URL is not set.");
48 |       return new Response(JSON.stringify({ error: 'Error de configuración interna del servidor.' }), {
49 |           status: 500, // Internal Server Error
50 |           headers: { ...corsHeaders, 'Content-Type': 'application/json' },
51 |       });
52 |     }
53 |     // Podríamos añadir una verificación similar para stripeSecretKey aquí también si quisiéramos ser extra seguros
54 | 
55 |     // 1. Inicializa el cliente de Supabase específico para esta solicitud
56 |     const supabaseClient = createClient(
57 |       Deno.env.get('SUPABASE_URL') ?? '',
58 |       Deno.env.get('SUPABASE_ANON_KEY') ?? '',
59 |       { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
60 |     );
61 | 
62 |     // 2. Verifica si el usuario está autenticado
63 |     const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
64 |     if (userError || !user) {
65 |       console.error('Authentication error:', userError);
66 |       return new Response(JSON.stringify({ error: 'Usuario no autenticado o inválido.' }), {
67 |         status: 401, // Unauthorized
68 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' },
69 |       });
70 |     }
71 |     console.log(`Authenticated user ID: ${user.id}`);
72 | 
73 |     // 3. Busca el stripe_customer_id en el perfil del usuario
74 |     const { data: profile, error: profileError } = await supabaseClient
75 |       .from('profiles')
76 |       .select('stripe_customer_id')
77 |       .eq('id', user.id)
78 |       .maybeSingle(); // Usa maybeSingle para manejar perfil no encontrado sin error
79 | 
80 |     // Maneja errores de DB que no sean 'no encontrado'
81 |     if (profileError && profileError.code !== 'PGRST116') {
82 |         console.error(`Database error fetching profile for user ${user.id}:`, profileError);
83 |         // Lanza un error para que sea capturado por el catch principal
84 |         throw new Error(`Error al consultar el perfil: ${profileError.message}`);
85 |     }
86 | 
87 |     // 4. Verifica que el usuario tenga un stripe_customer_id
88 |     if (!profile?.stripe_customer_id) {
89 |       console.warn(`No Stripe Customer ID found for user ${user.id}. Cannot open portal.`);
90 |       // Devuelve un error específico 404 para el frontend
91 |       return new Response(JSON.stringify({
92 |         error: 'No se encontró información de facturación para gestionar. Realiza una compra primero.'
93 |       }), {
94 |         status: 404, // Not Found
95 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' },
96 |       });
97 |     }
98 | 
99 |     const stripeCustomerId = profile.stripe_customer_id;
100 |     console.log(`Found Stripe Customer ID: ${stripeCustomerId}`);
101 | 
102 |     // 5. Crea una sesión del portal de cliente de Stripe
103 |     //    Define la ruta correcta del frontend para la página de inicio
104 |     const correctFrontendPath = '/'; // Ruta correcta para HomePage
105 |     const returnUrl = `${appBaseUrl}${correctFrontendPath}`; // Construye la URL completa
106 | 
107 |     console.log(`Creating Stripe Billing Portal session for Customer ${stripeCustomerId} with return URL: ${returnUrl}`); // Log con la URL correcta
108 |     const portalSession = await stripe.billingPortal.sessions.create({
109 |       customer: stripeCustomerId,
110 |       return_url: returnUrl, // Usa la URL corregida
111 |     });
112 | 
113 |     console.log(`Stripe Customer Portal session created: ${portalSession.id}`);
114 | 
115 |     // 6. Devuelve la URL de la sesión al frontend
116 |     return new Response(JSON.stringify({ url: portalSession.url }), {
117 |       headers: { ...corsHeaders, 'Content-Type': 'application/json' },
118 |       status: 200,
119 |     });
120 | 
121 |   } catch (error) { // 'error' aquí es de tipo 'unknown'
122 |     console.error('Unhandled error in create-customer-portal-session:', error);
123 | 
124 |     // ---- Bloque Catch con manejo seguro de 'unknown' ----
125 |     let errorMessage = 'Error desconocido'; // Mensaje por defecto
126 |     if (error instanceof Error) {
127 |       errorMessage = error.message; // Es seguro acceder a .message
128 |     } else if (typeof error === 'string') {
129 |       errorMessage = error; // Si se lanzó un string
130 |     }
131 |     // ---- Fin Bloque Catch ----
132 | 
133 |     // Devuelve la respuesta usando el mensaje obtenido de forma segura
134 |     return new Response(JSON.stringify({ error: `Error interno del servidor: ${errorMessage}` }), {
135 |       status: 500, // Internal Server Error
136 |       headers: { ...corsHeaders, 'Content-Type': 'application/json' },
137 |     });
138 |   }
139 | });
```

supabase/functions/generate-audio/deno.jsonc
```
1 | {
2 |   "tasks": {
3 |     "start": "deno run --allow-net --allow-env index.ts"
4 |   },
5 |   "importMap": "./import_map.json"
6 | } 
```

supabase/functions/generate-audio/import_map.json
```
1 | {
2 |   "imports": {
3 |     "std/": "https://deno.land/std@0.177.0/",
4 |     "openai": "https://esm.sh/openai@4.0.0"
5 |   }
6 | } 
```

supabase/functions/generate-audio/index.ts
```
1 | // supabase/functions/ai/generate-audio/index.ts
2 | // Lógica CORREGIDA: Verifica créditos ANTES de TTS y actualiza DB. Permite a gratuitos usar créditos comprados.
3 | 
4 | import { serve } from "https://deno.land/std@0.177.0/http/server.ts"; // O la versión que uses
5 | import { OpenAI } from "https://esm.sh/openai@4.40.0"; // O versión más reciente
6 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
7 | import { corsHeaders } from '../_shared/cors.ts'; // Asume que está en la carpeta renombrada 'functions'
8 | 
9 | // --- Configuración ---
10 | console.log(`[GENERATE_AUDIO_DEBUG] Function generate-audio initializing...`);
11 | 
12 | const openaiApiKey = Deno.env.get('OPENAI_API_KEY');
13 | if (!openaiApiKey) {
14 |     console.error("[GENERATE_AUDIO_ERROR] CRITICAL: OPENAI_API_KEY environment variable not set.");
15 |     // Lanzar error para detener la función si falta la clave
16 |     throw new Error("OPENAI_API_KEY environment variable not set");
17 | }
18 | const openai = new OpenAI({ apiKey: openaiApiKey });
19 | 
20 | const supabaseUrl = Deno.env.get('SUPABASE_URL');
21 | const serviceRoleKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY'); // O APP_SERVICE_ROLE_KEY si ese es el nombre
22 | if (!supabaseUrl || !serviceRoleKey) {
23 |     console.error("[GENERATE_AUDIO_ERROR] CRITICAL: Supabase URL or Service Role Key not set.");
24 |     throw new Error("Supabase URL or Service Role Key not set");
25 | }
26 | // Cliente Admin para operaciones críticas (consulta de perfil, actualización de créditos)
27 | const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey);
28 | 
29 | // Constante para el límite mensual (mejor si viene de env vars)
30 | const PREMIUM_MONTHLY_ALLOWANCE = 20;
31 | 
32 | console.log(`[GENERATE_AUDIO_DEBUG] Function generate-audio initialized successfully.`);
33 | // --- Fin Configuración ---
34 | 
35 | serve(async (req: Request) => {
36 |   // Manejo Preflight OPTIONS
37 |   if (req.method === 'OPTIONS') {
38 |     console.log('[GENERATE_AUDIO_DEBUG] Handling OPTIONS preflight request');
39 |     return new Response('ok', { headers: corsHeaders });
40 |   }
41 | 
42 |   let userId: string | null = null; // Para logging en caso de error temprano
43 |   let creditSource: 'monthly' | 'purchased' | 'none' = 'none'; // Para saber qué actualizar
44 | 
45 |   try {
46 |     // --- 1. Autenticación ---
47 |     console.log('[GENERATE_AUDIO_DEBUG] Attempting authentication...');
48 |     const authHeader = req.headers.get('Authorization');
49 |     if (!authHeader?.startsWith('Bearer ')) {
50 |         console.warn('[GENERATE_AUDIO_WARN] Invalid or missing Authorization header.');
51 |         return new Response(JSON.stringify({ error: 'Token inválido.' }), { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
52 |     }
53 |     const token = authHeader.replace('Bearer ', '');
54 | 
55 |     // Usamos el cliente ADMIN para obtener el usuario asociado al token JWT
56 |     // Esto es más seguro que crear un cliente por solicitud con el token del usuario
57 |     const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);
58 | 
59 |     if (authError || !user) {
60 |         console.error('[GENERATE_AUDIO_ERROR] Authentication failed:', authError?.message || 'User not found for token.');
61 |         return new Response(JSON.stringify({ error: 'No autenticado.' }), { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
62 |     }
63 |     userId = user.id; // Asignamos userId para logging posterior
64 |     console.log(`[GENERATE_AUDIO_INFO] User Authenticated: ${userId}`);
65 |     // --- Fin Autenticación ---
66 | 
67 |     // --- 2. Obtener Perfil y Verificar Permiso/Límites/Créditos ---
68 |     console.log(`[GENERATE_AUDIO_DEBUG] Fetching profile for user ${userId}...`);
69 |     const { data: profile, error: profileError } = await supabaseAdmin
70 |         .from('profiles')
71 |         .select('subscription_status, voice_credits, monthly_voice_generations_used')
72 |         .eq('id', userId)
73 |         .single(); // Usar single() para que falle si no hay exactamente 1 perfil
74 | 
75 |     if (profileError) {
76 |         console.error(`[GENERATE_AUDIO_ERROR] Failed to fetch profile for user ${userId}:`, profileError);
77 |         // No lanzar error aquí, devolver respuesta controlada
78 |         return new Response(JSON.stringify({ error: 'Error al obtener perfil de usuario.' }), { status: 500, headers: corsHeaders });
79 |     }
80 |     // No necesitamos chequear !profile porque .single() ya daría error si no existe
81 | 
82 |     console.log(`[GENERATE_AUDIO_DEBUG] Profile data for ${userId}:`, profile);
83 | 
84 |     let canGenerate = false;
85 |     const isPremium = profile.subscription_status === 'active' || profile.subscription_status === 'trialing';
86 |     const monthlyUsed = profile.monthly_voice_generations_used ?? 0;
87 |     const purchasedCredits = profile.voice_credits ?? 0;
88 | 
89 |     // --- Lógica de decisión ---
90 |     if (isPremium) {
91 |         console.log(`[GENERATE_AUDIO_DEBUG] User ${userId} is Premium/Trialing.`);
92 |         if (monthlyUsed < PREMIUM_MONTHLY_ALLOWANCE) {
93 |             console.log(`[GENERATE_AUDIO_INFO] Authorizing via monthly allowance for user ${userId}. Used: ${monthlyUsed}/${PREMIUM_MONTHLY_ALLOWANCE}.`);
94 |             canGenerate = true;
95 |             creditSource = 'monthly';
96 |         } else if (purchasedCredits > 0) {
97 |             console.log(`[GENERATE_AUDIO_INFO] Monthly allowance used. Authorizing via purchased credit for user ${userId}. Purchased available: ${purchasedCredits}.`);
98 |             canGenerate = true;
99 |             creditSource = 'purchased';
100 |         } else {
101 |             console.log(`[GENERATE_AUDIO_WARN] Denying - Premium user ${userId} has no monthly allowance or purchased credits remaining.`);
102 |         }
103 |     } else { // Usuario Gratuito, Cancelado, etc.
104 |         console.log(`[GENERATE_AUDIO_DEBUG] User ${userId} is not Premium (Status: ${profile.subscription_status}). Checking purchased credits...`);
105 |         if (purchasedCredits > 0) {
106 |             console.log(`[GENERATE_AUDIO_INFO] Authorizing via purchased credit for non-premium user ${userId}. Purchased available: ${purchasedCredits}.`);
107 |             canGenerate = true;
108 |             creditSource = 'purchased';
109 |         } else {
110 |             console.log(`[GENERATE_AUDIO_WARN] Denying - Non-premium user ${userId} has no purchased credits.`);
111 |             // Podríamos devolver 403 si NUNCA pudieran generar, pero como pueden comprar, 402 es mejor.
112 |         }
113 |     }
114 | 
115 |     // --- 3. Devolver error si no hay créditos ANTES de actualizar DB o llamar a TTS ---
116 |     if (!canGenerate) {
117 |         console.log(`[GENERATE_AUDIO_INFO] Denying audio generation for user ${userId} due to insufficient credits.`);
118 |         return new Response(JSON.stringify({ error: 'Créditos de voz insuficientes.' }), { status: 402, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }); // 402 Payment Required
119 |     }
120 | 
121 |     // --- 4. Actualizar Contador/Crédito (ANTES de llamar a OpenAI) ---
122 |     console.log(`[GENERATE_AUDIO_DEBUG] Attempting to update usage/credits for user ${userId} (Source: ${creditSource})...`);
123 |     let dbUpdateError = null;
124 |     let rpcResultData: number | null = null; // Para almacenar el resultado de decrement_voice_credits si es necesario
125 | 
126 |     if (creditSource === 'monthly') {
127 |         const { error: rpcError } = await supabaseAdmin.rpc('increment_monthly_voice_usage', { user_uuid: userId });
128 |         dbUpdateError = rpcError;
129 |         if (!dbUpdateError) console.log(`[GENERATE_AUDIO_INFO] DB OK: Monthly usage incremented for ${userId}.`);
130 | 
131 |     } else if (creditSource === 'purchased') {
132 |         // Llamamos a decrement y guardamos el resultado (podría ser el nuevo saldo o -1)
133 |         const { data, error: rpcError } = await supabaseAdmin.rpc('decrement_voice_credits', { user_uuid: userId });
134 |         dbUpdateError = rpcError;
135 |         rpcResultData = data; // Guardamos el resultado (puede ser null si la función no devuelve nada o el valor devuelto)
136 |         if (!dbUpdateError && typeof rpcResultData === 'number' && rpcResultData !== -1) {
137 |              console.log(`[GENERATE_AUDIO_INFO] DB OK: Purchased credit decremented for ${userId}. Approx new balance: ${rpcResultData}`);
138 |         } else if (!dbUpdateError && rpcResultData === -1) {
139 |              // Esto no debería pasar si canGenerate fue true, pero es un check de seguridad
140 |              console.warn(`[GENERATE_AUDIO_WARN] DB WARN: decrement_voice_credits returned -1 unexpectedly for user ${userId}.`);
141 |              // Considerar fallar aquí ya que el estado podría ser inconsistente
142 |              // dbUpdateError = new Error("Inconsistent state: decrement returned -1 after check passed.");
143 |         } else if (!dbUpdateError) {
144 |              console.log(`[GENERATE_AUDIO_INFO] DB OK: Purchased credit decremented for ${userId} (RPC did not return new balance).`);
145 |         }
146 |     }
147 | 
148 |     // Si la actualización de la DB falló, no continuamos
149 |     if (dbUpdateError) {
150 |         console.error(`[GENERATE_AUDIO_ERROR] CRITICAL FAIL: Failed to update ${creditSource} count via RPC for user ${userId}:`, dbUpdateError);
151 |         return new Response(JSON.stringify({ error: 'Error al actualizar el saldo de créditos.' }), { status: 500, headers: corsHeaders });
152 |     }
153 |     console.log(`[GENERATE_AUDIO_INFO] Credit/Usage count updated successfully for user ${userId}. Proceeding with TTS generation.`);
154 | 
155 |     // --- 5. Procesar Solicitud y Generar Audio (AHORA SÍ) ---
156 |     const { text, voice = 'alloy', model = 'tts-1' } = await req.json(); // Proporcionar defaults
157 |     if (!text || typeof text !== 'string' || text.trim().length === 0) {
158 |         console.warn(`[GENERATE_AUDIO_WARN] Invalid request body for user ${userId}: Text is missing or empty.`);
159 |         return new Response(JSON.stringify({ error: 'Texto inválido o ausente requerido.' }), { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
160 |     }
161 | 
162 |     console.log(`[GENERATE_AUDIO_INFO] Generating audio via OpenAI for user ${userId} (Voice: ${voice}, Model: ${model})...`);
163 |     const response = await openai.audio.speech.create({
164 |         model: model,
165 |         voice: voice,
166 |         input: text.trim() // Usar texto sin espacios extra
167 |     });
168 | 
169 |     // Verificar si la respuesta de OpenAI fue exitosa
170 |     if (!response.ok) {
171 |         const errorBody = await response.text(); // Intentar leer el cuerpo del error
172 |         console.error(`[GENERATE_AUDIO_ERROR] OpenAI API error for user ${userId}: ${response.status} ${response.statusText}`, errorBody);
173 |         // Devolver un error genérico al cliente, pero loguear el detalle
174 |         return new Response(JSON.stringify({ error: 'Error al contactar el servicio de generación de voz.' }), { status: 502, headers: corsHeaders }); // 502 Bad Gateway
175 |     }
176 | 
177 |     const audioBuffer = await response.arrayBuffer();
178 |     console.log(`[GENERATE_AUDIO_INFO] Audio generated successfully via OpenAI for user ${userId}.`);
179 |     // --- Fin Generar Audio ---
180 | 
181 |     // --- 6. Devolver Respuesta de Audio ---
182 |     // Nota: Ya no actualizamos créditos aquí, se hizo antes.
183 |     console.log(`[GENERATE_AUDIO_INFO] Returning audio buffer to user ${userId}.`);
184 |     return new Response(audioBuffer, {
185 |         headers: {
186 |             ...corsHeaders,
187 |             'Content-Type': 'audio/mpeg' // O el tipo correcto devuelto por OpenAI
188 |         },
189 |         status: 200
190 |     });
191 |     // --- Fin Devolver Respuesta ---
192 | 
193 |   } catch (error) {
194 |     // Captura errores generales (JSON parse, errores inesperados, etc.)
195 |     console.error(`[GENERATE_AUDIO_ERROR] Unhandled error in generate-audio function for user ${userId || 'UNKNOWN'}:`, error);
196 |     const errorMessage = 'Error interno del servidor al generar el audio.';
197 |     // Evitar exponer detalles internos en producción
198 |     // if (error instanceof Error) errorMessage = error.message;
199 |     // Usar 500 Internal Server Error para errores no manejados específicamente
200 |     return new Response(JSON.stringify({ error: errorMessage }), {
201 |         status: 500,
202 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' }
203 |     });
204 |   }
205 | });
```

supabase/functions/generate-story/index.ts
```
1 | // supabase/functions/generate-story/index.ts
2 | // v7.0 (OpenAI Client + JSON Output): Uses OpenAI client for Gemini, expects JSON.
3 | // IMPORTANT: prompt.ts has been updated to instruct AI for JSON output.
4 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
5 | import { corsHeaders } from '../_shared/cors.ts';
6 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
7 | import OpenAI from "npm:openai@^4.33.0"; // Using OpenAI client
8 | 
9 | // Importar funciones de prompt desde prompt.ts
10 | // createUserPrompt_JsonFormat (antes createUserPrompt_SeparatorFormat) ahora genera un prompt que pide JSON.
11 | import { createSystemPrompt, createUserPrompt_JsonFormat } from './prompt.ts';
12 | 
13 | // --- Helper Function (remains largely the same, adapted for potentially cleaner inputs from JSON) ---
14 | function cleanExtractedText(text: string | undefined | null, type: 'title' | 'content'): string {
15 |   const defaultText = type === 'title' ? `Aventura Inolvidable` : 'El cuento tiene un giro inesperado...';
16 |   if (text === null || text === undefined || typeof text !== 'string') {
17 |     console.warn(`[Helper v7.0] cleanExtractedText (${type}): Input empty/not string.`);
18 |     return defaultText;
19 |   }
20 |   console.log(`[Helper v7.0] cleanExtractedText (${type}) - BEFORE: "${text.substring(0, 150)}..."`);
21 |   let cleaned = text.trim();
22 | 
23 |   // These might be less necessary if AI strictly adheres to JSON values, but good for robustness
24 |   cleaned = cleaned.replace(/^Título:\s*/i, '').trim();
25 |   cleaned = cleaned.replace(/^Contenido:\s*/i, '').trim();
26 |   if (type === 'content') {
27 |     cleaned = cleaned.replace(/^\s*\d+\.\s+/gm, ''); // Eliminar numeración de listas
28 |     cleaned = cleaned.replace(/^\s*[-\*]\s+/gm, ''); // Eliminar viñetas de listas
29 |   }
30 |   if (type === 'title') {
31 |     cleaned = cleaned.replace(/^["'“‘](.*)["'”’]$/s, '$1').trim(); // Quitar comillas alrededor del título
32 |   }
33 |   cleaned = cleaned.replace(/^(Respuesta|Aquí tienes el título|El título es):\s*/i, '').trim();
34 |   cleaned = cleaned.replace(/^(Aquí tienes el cuento|El cuento es):\s*/i, '').trim();
35 | 
36 |   console.log(`[Helper v7.0] cleanExtractedText (${type}) - AFTER: "${cleaned.substring(0, 150)}..."`);
37 |   return cleaned || defaultText; // Ensure non-empty string or default
38 | }
39 | 
40 | // --- Interface for Structured AI Response ---
41 | interface StoryGenerationResult {
42 |   title: string;
43 |   content: string;
44 | }
45 | 
46 | function isValidStoryResult(data: any): data is StoryGenerationResult {
47 |   return data &&
48 |     typeof data.title === 'string' &&
49 |     typeof data.content === 'string';
50 | }
51 | 
52 | // --- Main Handler ---
53 | serve(async (req: Request) => {
54 |   const functionVersion = "v7.0 (OpenAI Client + JSON)";
55 |   // 1. MANEJAR PREFLIGHT PRIMERO
56 |   if (req.method === "OPTIONS") {
57 |     console.log(`[${functionVersion}] Handling OPTIONS preflight request...`);
58 |     return new Response("ok", { headers: corsHeaders });
59 |   }
60 | 
61 |   // --- Configuración para Grok ---
62 |   const GROK_API_KEY = Deno.env.get("GROK_API_KEY");
63 |   const GROK_API_BASE_URL = 'https://api.x.ai/v1';
64 |   const MODEL_NAME = 'grok-3-mini'; // Modelo explícito
65 | 
66 |   if (!GROK_API_KEY) {
67 |     throw new Error("La variable de entorno GROK_API_KEY no está configurada.");
68 |   }
69 | 
70 |   // --- Inicializar cliente OpenAI para Grok ---
71 |   const openai = new OpenAI({
72 |     apiKey: GROK_API_KEY,
73 |     baseURL: GROK_API_BASE_URL,
74 |   });
75 |   console.log(`[${functionVersion}] Cliente OpenAI configurado para el modelo Grok '${MODEL_NAME}' vía baseURL: ${openai.baseURL}`);
76 | 
77 |   const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
78 |   const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
79 | 
80 |   if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
81 |     console.error("Supabase URL or Service Role Key not set");
82 |     throw new Error("Supabase URL or Service Role Key not set");
83 |   }
84 |   const supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
85 | 
86 |   // 2. Verificar Método POST
87 |   if (req.method !== 'POST') {
88 |     console.log(`[${functionVersion}] Method ${req.method} not allowed.`);
89 |     return new Response(JSON.stringify({ error: 'Método no permitido. Usar POST.' }), {
90 |       status: 405, headers: { ...corsHeaders, 'Content-Type': 'application/json' }
91 |     });
92 |   }
93 | 
94 |   let userId: string | null = null;
95 |   let userIdForIncrement: string | null = null;
96 | 
97 |   try {
98 |     // 3. AUTENTICACIÓN
99 |     console.log(`[${functionVersion}] Handling POST request...`);
100 |     const authHeader = req.headers.get('Authorization');
101 |     if (!authHeader || !authHeader.startsWith('Bearer ')) {
102 |       console.error("Authorization header missing or invalid.");
103 |       return new Response(JSON.stringify({ error: 'Token inválido o ausente.' }), {
104 |         status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" }
105 |       });
106 |     }
107 |     const token = authHeader.replace('Bearer ', '');
108 |     const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);
109 | 
110 |     if (authError || !user) {
111 |       console.error("Auth Error:", authError);
112 |       return new Response(JSON.stringify({ error: authError?.message || 'No autenticado.' }), {
113 |         status: authError?.status || 401, headers: { ...corsHeaders, "Content-Type": "application/json" }
114 |       });
115 |     }
116 |     userId = user.id;
117 |     console.log(`[${functionVersion}] User Auth: ${userId}`);
118 | 
119 |     // 4. Perfil y Límites
120 |     const { data: profile, error: profileError } = await supabaseAdmin
121 |       .from('profiles')
122 |       .select('subscription_status, monthly_stories_generated, language, preferences')
123 |       .eq('id', userId)
124 |       .maybeSingle();
125 | 
126 |     if (profileError) {
127 |       console.error(`Error fetching profile for ${userId}:`, profileError);
128 |       throw new Error(`Error al obtener perfil de usuario: ${profileError.message}`);
129 |     }
130 | 
131 |     let isPremiumUser = false;
132 |     if (profile) {
133 |       isPremiumUser = profile.subscription_status === 'active' || profile.subscription_status === 'trialing';
134 |     } else {
135 |       console.warn(`Perfil no encontrado para ${userId}. Tratando como gratuito.`);
136 |     }
137 | 
138 |     const currentStoriesGenerated = profile?.monthly_stories_generated ?? 0;
139 |     const FREE_STORY_LIMIT = 10;
140 | 
141 |     if (!isPremiumUser) {
142 |       userIdForIncrement = userId;
143 |       console.log(`[${functionVersion}] Free user ${userId}. Stories: ${currentStoriesGenerated}/${FREE_STORY_LIMIT}`);
144 |       if (currentStoriesGenerated >= FREE_STORY_LIMIT) {
145 |         return new Response(JSON.stringify({
146 |           error: `Límite mensual (${FREE_STORY_LIMIT}) alcanzado.`
147 |         }), {
148 |           status: 429,
149 |           headers: { ...corsHeaders, "Content-Type": "application/json" }
150 |         });
151 |       }
152 |     } else {
153 |       console.log(`[${functionVersion}] Premium user ${userId}.`);
154 |     }
155 | 
156 |     // 5. Body y Validación
157 |     let params: any;
158 |     try {
159 |       params = await req.json();
160 |       console.log(`[${functionVersion}] Params Received:`, JSON.stringify(params, null, 2));
161 |       console.log(`[${functionVersion}] Validating basic structure...`);
162 |       console.log(`[${functionVersion}] profile.language:`, profile?.language, typeof profile?.language);
163 |       console.log(`[${functionVersion}] profile.preferences:`, profile?.preferences ? 'provided' : 'none');
164 |       console.log(`[${functionVersion}] params.options:`, params.options);
165 |       if (params.options) {
166 |         console.log(`[${functionVersion}] params.options.format:`, params.options.format, typeof params.options.format);
167 |         console.log(`[${functionVersion}] params.options.genre:`, params.options.genre, typeof params.options.genre);
168 |         console.log(`[${functionVersion}] params.options.characters:`, params.options.characters);
169 |         console.log(`[${functionVersion}] params.options.character:`, params.options.character);
170 |       }
171 | 
172 |       // More detailed validation with debugging
173 |       console.log(`[${functionVersion}] Starting detailed validation...`);
174 | 
175 |       if (!params) {
176 |         console.error("[VALIDATION ERROR] params is null/undefined");
177 |         throw new Error("Parámetros inválidos: datos no recibidos.");
178 |       }
179 | 
180 |       if (typeof params !== 'object') {
181 |         console.error("[VALIDATION ERROR] params is not an object:", typeof params);
182 |         throw new Error("Parámetros inválidos: formato incorrecto.");
183 |       }
184 | 
185 |       if (!params.options) {
186 |         console.error("[VALIDATION ERROR] params.options is missing");
187 |         throw new Error("Parámetros inválidos: falta 'options'.");
188 |       }
189 | 
190 |       if (typeof params.options !== 'object') {
191 |         console.error("[VALIDATION ERROR] params.options is not an object:", typeof params.options);
192 |         throw new Error("Parámetros inválidos: 'options' debe ser un objeto.");
193 |       }
194 | 
195 |       // Validate individual fields with more detailed error messages
196 |       const errors = [];
197 | 
198 |       // Language and preferences come from profile, not params
199 |       if (!profile?.language || typeof profile.language !== 'string') {
200 |         errors.push('User profile must have a valid language setting');
201 |         console.error("[VALIDATION ERROR] profile.language:", profile?.language, typeof profile?.language);
202 |       }
203 | 
204 |       if (typeof params.options.format !== 'string' || !params.options.format) {
205 |         errors.push('options.format must be a non-empty string');
206 |         console.error("[VALIDATION ERROR] format:", params.options.format, typeof params.options.format);
207 |       }
208 | 
209 |       if (typeof params.options.genre !== 'string' || !params.options.genre) {
210 |         errors.push('options.genre must be a non-empty string');
211 |         console.error("[VALIDATION ERROR] genre:", params.options.genre, typeof params.options.genre);
212 |       }
213 | 
214 |       if (errors.length > 0) {
215 |         console.error("[VALIDATION ERROR] Basic validation failed:", errors);
216 |         throw new Error(`Invalid basic parameters: ${errors.join(', ')}.`);
217 |       }
218 | 
219 |       console.log(`[${functionVersion}] Basic validation passed!`);
220 | 
221 |       // Validate character data - support both legacy (character) and new (characters) formats
222 |       const hasMultipleCharacters = params.options.characters && Array.isArray(params.options.characters) && params.options.characters.length > 0;
223 |       const hasSingleCharacter = params.options.character && typeof params.options.character === 'object' && params.options.character.name;
224 | 
225 |       if (!hasMultipleCharacters && !hasSingleCharacter) {
226 |         console.error("Validation failed. No valid character data found:", {
227 |           hasCharacters: !!params.options.characters,
228 |           charactersIsArray: Array.isArray(params.options.characters),
229 |           charactersLength: params.options.characters?.length,
230 |           hasCharacter: !!params.options.character,
231 |           hasCharacterName: !!params.options.character?.name
232 |         });
233 |         throw new Error("Se requiere al menos un personaje válido (options.character.name o options.characters[] con al menos un elemento).");
234 |       }
235 | 
236 |       // Normalize to characters array for internal processing
237 |       let charactersArray;
238 |       if (hasMultipleCharacters) {
239 |         charactersArray = params.options.characters;
240 |         console.log(`[${functionVersion}] Multiple characters mode: ${charactersArray.length} characters`);
241 |       } else {
242 |         charactersArray = [params.options.character];
243 |         console.log(`[${functionVersion}] Single character mode (legacy): ${params.options.character.name}`);
244 |       }
245 | 
246 |       // Validate characters array (1-4 characters)
247 |       if (charactersArray.length > 4) {
248 |         throw new Error("Máximo 4 personajes permitidos por historia.");
249 |       }
250 | 
251 |       const invalidCharacters = charactersArray.filter(char =>
252 |         !char || typeof char !== 'object' || !char.name || typeof char.name !== 'string'
253 |       );
254 | 
255 |       if (invalidCharacters.length > 0) {
256 |         console.error("Validation failed. Invalid characters found:", invalidCharacters);
257 |         throw new Error("Todos los personajes deben tener un nombre válido.");
258 |       }
259 | 
260 |       console.log(`[${functionVersion}] Characters validated: ${charactersArray.map(c => c.name).join(', ')}`);
261 | 
262 |       // Store normalized characters array for use in prompts
263 |       params.options.characters = charactersArray;
264 | 
265 |     } catch (error) {
266 |       console.error(`[${functionVersion}] Failed to parse/validate JSON body for user ${userId}. Error:`, error);
267 |       const message = error instanceof Error ? error.message : "Error desconocido al procesar JSON.";
268 |       throw new Error(`Invalid/empty/incomplete JSON in body: ${message}.`);
269 |     }
270 | 
271 |     // 6. Generación IA con OpenAI Client y Esperando JSON
272 |     const systemPrompt = createSystemPrompt(profile?.language || 'en', profile?.preferences || null);
273 |     const userPrompt = createUserPrompt_JsonFormat({ // Esta función ahora genera un prompt pidiendo JSON
274 |       options: params.options,
275 |       additionalDetails: params.additionalDetails
276 |     });
277 |     const combinedPrompt = `${systemPrompt}\n\n${userPrompt}`;
278 | 
279 |     console.log(`[${functionVersion}] Calling AI (${MODEL_NAME}) for JSON output (User: ${userId}). Prompt length: ${combinedPrompt.length}`);
280 | 
281 |     const chatCompletion = await openai.chat.completions.create({
282 |       model: MODEL_NAME, // Usando el modelo Grok explícito
283 |       messages: [{ role: "user", content: combinedPrompt }],
284 |       response_format: { type: "json_object" }, // Request JSON output
285 |       temperature: 0.8,
286 |       top_p: 0.95,
287 |       max_tokens: 8000 // Ajustado a un límite razonable para Sonnet
288 |     });
289 | 
290 |     const aiResponseContent = chatCompletion.choices[0]?.message?.content;
291 |     const finishReason = chatCompletion.choices[0]?.finish_reason;
292 | 
293 |     console.log(`[${functionVersion}] Raw AI JSON response (first 200 chars): ${aiResponseContent?.substring(0, 200) || '(No text received)'}... Finish Reason: ${finishReason}`);
294 | 
295 |     if (finishReason === 'length') {
296 |       console.warn(`[${functionVersion}] AI generation may have been truncated due to 'length' finish_reason.`);
297 |     }
298 |     // Nota: blockReason específico como en GoogleGenerativeAI no está directamente disponible.
299 |     // Se confía en finish_reason o contenido vacío para problemas.
300 | 
301 |     // 7. Procesar Respuesta JSON de la IA
302 |     let finalTitle = 'Aventura Inolvidable'; // Default
303 |     let finalContent = ''; // Default
304 |     let parsedSuccessfully = false;
305 | 
306 |     if (aiResponseContent) {
307 |       try {
308 |         const storyResult: StoryGenerationResult = JSON.parse(aiResponseContent);
309 |         if (isValidStoryResult(storyResult)) {
310 |           finalTitle = cleanExtractedText(storyResult.title, 'title');
311 |           finalContent = cleanExtractedText(storyResult.content, 'content');
312 |           parsedSuccessfully = true;
313 |           console.log(`[${functionVersion}] Parsed AI JSON successfully. Title: "${finalTitle}"`);
314 |         } else {
315 |           console.warn(`[${functionVersion}] AI response JSON structure is invalid. Received: ${aiResponseContent.substring(0, 500)}...`);
316 |         }
317 |       } catch (parseError) {
318 |         console.error(`[${functionVersion}] Failed to parse JSON from AI response. Error: ${parseError.message}. Raw content: ${aiResponseContent.substring(0, 500)}...`);
319 |       }
320 |     } else {
321 |       console.error(`[${functionVersion}] AI response was empty or text could not be extracted. Finish Reason: ${finishReason}`);
322 |     }
323 | 
324 |     if (!parsedSuccessfully) {
325 |       console.warn(`[${functionVersion}] Using fallback: Default title, and attempting to use raw AI response (if any) as content (after cleaning).`);
326 |       finalContent = cleanExtractedText(aiResponseContent, 'content'); // aiResponseContent could be null here
327 |       // finalTitle remains the default 'Aventura Inolvidable'
328 |     }
329 | 
330 |     if (!finalContent) {
331 |       console.error(`[${functionVersion}] Content is empty even after JSON parsing/fallback and cleaning.`);
332 |       // Considerar devolver la respuesta cruda o un mensaje de error específico
333 |       finalContent = "Hubo un problema al generar el contenido del cuento, pero aquí está la respuesta cruda de la IA (puede no estar formateada): " + (aiResponseContent || "No se recibió respuesta de la IA.");
334 |     }
335 | 
336 |     console.log(`[${functionVersion}] Final Title: "${finalTitle}", Final Content Length: ${finalContent.length}`);
337 | 
338 |     // 8. Incrementar Contador
339 |     if (userIdForIncrement) {
340 |       console.log(`[${functionVersion}] Incrementing count for ${userIdForIncrement}...`);
341 |       const { error: incrementError } = await supabaseAdmin.rpc('increment_story_count', {
342 |         user_uuid: userIdForIncrement
343 |       });
344 |       if (incrementError) {
345 |         console.error(`[${functionVersion}] CRITICAL: Failed count increment for ${userIdForIncrement}: ${incrementError.message}`);
346 |       } else {
347 |         console.log(`[${functionVersion}] Count incremented for ${userIdForIncrement}.`);
348 |       }
349 |     }
350 | 
351 |     // 9. Respuesta Final
352 |     return new Response(JSON.stringify({
353 |       content: finalContent,
354 |       title: finalTitle
355 |     }), {
356 |       status: 200,
357 |       headers: { ...corsHeaders, "Content-Type": "application/json" }
358 |     });
359 | 
360 |   } catch (error) {
361 |     // 10. Manejo de Errores
362 |     console.error(`[${functionVersion}] Error (User: ${userId || 'UNKNOWN'}):`, error);
363 |     let statusCode = 500;
364 |     const message = error instanceof Error ? error.message : "Error interno desconocido.";
365 | 
366 |     if (error instanceof Error) {
367 |       const lowerMessage = message.toLowerCase();
368 |       if (lowerMessage.includes("autenticado") || lowerMessage.includes("token inválido")) statusCode = 401;
369 |       else if (lowerMessage.includes("límite")) statusCode = 429;
370 |       else if (lowerMessage.includes("inválido") || lowerMessage.includes("json in body") || lowerMessage.includes("parámetros")) statusCode = 400;
371 |       // Actualizado para errores de IA con JSON
372 |       else if (lowerMessage.includes("ai response was not valid json") || lowerMessage.includes("ai response was empty") || lowerMessage.includes("ai response json structure is invalid") || lowerMessage.includes("blocked") || lowerMessage.includes("filter")) statusCode = 502; // Bad Gateway
373 |     }
374 | 
375 |     return new Response(JSON.stringify({
376 |       error: `Error procesando solicitud: ${message}`
377 |     }), {
378 |       status: statusCode,
379 |       headers: { ...corsHeaders, "Content-Type": "application/json" }
380 |     });
381 |   }
382 | });
```

supabase/functions/generate-story/prompt.ts
```
1 | // supabase/edge-functions/generate-story/prompt.ts
2 | // v8.0 (Adult Content + Preferences): Contiene las funciones para generar los prompts de contenido adulto.
3 | // createUserPrompt_JsonFormat ahora instruye a la IA para devolver JSON con contenido erótico.
4 | 
5 | // createSystemPrompt: El contenido textual de la guía para la IA ahora enfocado en contenido adulto.
6 | export function createSystemPrompt(language: string, preferences?: string | null): string {
7 |     console.log(`[Adult Content v8.0] createSystemPrompt: lang=${language}, preferences=${preferences ? 'provided' : 'none'}`);
8 | 
9 |     let base = `You are an expert writer creating personalized erotic stories for adults. Write always in ${language}, with sophisticated and sensual language appropriate for mature audiences (18+).`;
10 |     
11 |     if (preferences && preferences.trim()) {
12 |         base += ` The user has specified these preferences and interests: "${preferences.trim()}". Incorporate these elements thoughtfully and naturally into the story to create a personalized experience.`;
13 |         base += ` Guidelines for user preferences:\n`;
14 |         base += `   - **Respect Boundaries:** Only include elements that align with the specified preferences\n`;
15 |         base += `   - **Natural Integration:** Weave preferences into the plot organically, don't force them\n`;
16 |         base += `   - **Quality Focus:** Prioritize good storytelling over just including fetishes\n`;
17 |         base += `   - **Consent & Positivity:** All interactions should be consensual and positive\n`;
18 |         base += `   - **Character Development:** Use preferences to enhance character depth and relationships\n`;
19 |     } else {
20 |         base += ` Since no specific preferences were provided, create a sensual and engaging story with broad adult appeal, focusing on romance, attraction, and intimate connections.`;
21 |     }
22 |     
23 |     base += ` The story should follow a clear narrative structure: an engaging beginning that sets the mood, development with building tension and desire, and a satisfying climax and resolution.`;
24 |     base += ` Use sophisticated and evocative language that creates atmosphere and emotional connection. Focus on character development, sensual descriptions, and meaningful intimate moments.`;
25 |     base += ` Ensure all content is consensual, positive, and celebrates adult sexuality in a healthy and appealing way.`;
26 |     
27 |     return base;
28 | }
29 | 
30 | // Definición de tipos para las opciones del prompt de usuario (actualizado para múltiples personajes)
31 | interface CharacterOptions {
32 |     name: string;
33 |     gender: 'male' | 'female' | 'non-binary';
34 |     description: string;
35 | }
36 | 
37 | interface UserPromptOptions {
38 |     characters: CharacterOptions[];   // Unified: array de personajes (1-4)
39 |     genre: string;
40 |     format?: string;
41 |     language?: string;
42 | }
43 | 
44 | interface CreateUserPromptParams {
45 |     options: UserPromptOptions;
46 |     additionalDetails?: string;
47 | }
48 | 
49 | // createUserPrompt_JsonFormat: Anteriormente createUserPrompt_SeparatorFormat.
50 | // Modificada para instruir a la IA a devolver un objeto JSON con contenido adulto.
51 | export function createUserPrompt_JsonFormat({ options, additionalDetails }: CreateUserPromptParams): string {
52 |     console.log(`[Adult Content v8.0] createUserPrompt_JsonFormat:`, options, `details=`, additionalDetails);
53 |     const storyFormat = options.format || 'episodic';
54 |     const language = options.language || 'en';
55 | 
56 |     // Unified character system - always use characters array (1-4 characters)
57 |     const characters = options.characters || [];
58 |     const isMultipleCharacters = characters.length > 1;
59 | 
60 |     // Create base request with character handling
61 |     let request = `Create an erotic story for adults. Genre: ${options.genre}. `;
62 |     
63 |     if (isMultipleCharacters) {
64 |         request += `Main Characters (${characters.length}): `;
65 |         characters.forEach((char, index) => {
66 |             request += `${index + 1}. ${char.name}`;
67 |             request += `, gender: ${char.gender}`;
68 |             request += `, description: ${char.description}`;
69 |             if (index < characters.length - 1) request += '; ';
70 |         });
71 |         request += `.\n\n`;
72 |         
73 |         // Add specific instructions for multiple characters
74 |         request += `**Instructions for multiple characters:**\n`;
75 |         request += `- Ensure ALL characters have significant participation in the story\n`;
76 |         request += `- Each character should contribute uniquely based on their gender and personal description\n`;
77 |         request += `- Create natural and dynamic interactions between characters\n`;
78 |         request += `- Develop romantic/erotic tension and relationships between characters as appropriate\n`;
79 |         request += `- Keep the story focused and coherent despite multiple protagonists\n\n`;
80 |     } else {
81 |         const char = characters[0];
82 |         request += `Main Character: ${char.name}`;
83 |         request += `, gender: ${char.gender}`;
84 |         request += `, description: ${char.description}`;
85 |         request += `.\n\n`;
86 |     }
87 | 
88 |     // Content and structure instructions for adult content
89 |     request += `**Content, Length and Structure Instructions:**\n`;
90 |     request += `1. **Story Format:** '${storyFormat}'.\n`;
91 |     
92 |     if (storyFormat === 'single') {
93 |         request += `    * Complete Story: ~2150 tokens (~1600-1800 words).\n`;
94 |         request += `    * This should be a complete story with clear beginning, development, climax, and satisfying conclusion.\n`;
95 |         request += `    * Include full character development and resolve all plot elements.\n`;
96 |     } else {
97 |         request += `    * Episodic Chapter: ~1350 tokens (~1000-1200 words).\n`;
98 |         request += `    * This should be the first chapter of an ongoing story with an open ending.\n`;
99 |         request += `    * Leave room for future chapters and continuation of the adventure.\n`;
100 |         request += `    * Focus on establishing characters, setting, and initial erotic tension.\n`;
101 |     }
102 | 
103 |     // Additional user details (if any)
104 |     if (additionalDetails && typeof additionalDetails === 'string' && additionalDetails.trim()) {
105 |         request += `\n**Additional user instructions:**\n${additionalDetails.trim()}\n`;
106 |     }
107 | 
108 |     request += `2. **Structure Guidelines:**\n`;
109 |     if (storyFormat === 'single') {
110 |         request += `    * Clear beginning, development, climax, and satisfying conclusion\n`;
111 |         request += `    * Complete character arcs and resolution of conflicts\n`;
112 |         request += `    * Full exploration of the erotic theme and relationship dynamics\n`;
113 |     } else {
114 |         request += `    * Engaging opening that establishes setting and characters\n`;
115 |         request += `    * Build initial attraction and erotic tension\n`;
116 |         request += `    * End with anticipation and desire for continuation\n`;
117 |     }
118 |     request += `3. **Tone and Style:** Use sophisticated, sensual language that builds atmosphere and emotional connection. Create vivid scenes that engage the reader's imagination.\n`;
119 |     request += `4. **Adult Content Guidelines:** All interactions must be consensual and positive. Focus on emotional connection alongside physical attraction. Build tension and desire naturally through the narrative.\n`;
120 |     request += `5. **Character Development:** Create believable, complex characters with desires and motivations. Show their emotional journey alongside the physical story.\n`;
121 |     
122 |     request += `6. **Title:** Generate an extraordinary title (memorable, evocative, intriguing). The title should follow "Sentence case" style. The title must be written in the same language selected for the story: ${language}.\n`;
123 | 
124 |     // JSON format instructions (unchanged)
125 |     request += `\n**Response format instructions (VERY IMPORTANT!):**\n`;
126 |     request += `* You must respond with a SINGLE JSON object.\n`;
127 |     request += `* The JSON object must have exactly two keys: "title" and "content".\n`;
128 |     request += `* The "title" key value should be a string containing ONLY the generated title (ideally 4-7 words), following the title guidelines above (${language} language, "Sentence case").\n`;
129 |     request += `* The "content" key value should be a string with ALL the story content, starting directly with the first sentence of the story.\n`;
130 |     request += `* Example of expected JSON format: {"title": "An extraordinary title here", "content": "Once upon a time in a distant place..."}\n`;
131 |     request += `* Do NOT include ANYTHING before the '{' character that starts the JSON object.\n`;
132 |     request += `* Do NOT include ANYTHING after the '}' character that ends the JSON object.\n`;
133 |     request += `* Ensure the JSON is valid and complete.\n`;
134 |     request += `* Do NOT use markdown or any other formatting INSIDE the JSON strings unless it's part of the natural story text.\n`;
135 | 
136 |     return request;
137 | }
```

supabase/functions/story-continuation/index.ts
```
1 | // supabase/edge-functions/story-continuation/index.ts
2 | // v8.0 (Adult Content + Preferences): Uses OpenAI client for Gemini, expects structured JSON. Adult content with preferences.
3 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
4 | import { corsHeaders } from '../_shared/cors.ts';
5 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
6 | import OpenAI from "npm:openai@^4.33.0";
7 | 
8 | import {
9 |   createContinuationOptionsPrompt,
10 |   createContinuationPrompt,
11 |   type Story, // Assuming Story type is defined in prompt.ts
12 |   type Chapter, // Assuming Chapter type is defined in prompt.ts
13 |   type ContinuationContextType,
14 | } from './prompt.ts';
15 | 
16 | // --- Configuración Global para Grok ---
17 | const GROK_API_KEY = Deno.env.get("GROK_API_KEY");
18 | const GROK_API_BASE_URL = 'https://api.x.ai/v1';
19 | const MODEL_NAME = 'grok-3-mini'; // Modelo explícito
20 | 
21 | if (!GROK_API_KEY) {
22 |   throw new Error("La variable de entorno GROK_API_KEY no está configurada.");
23 | }
24 | 
25 | const openai = new OpenAI({
26 |   apiKey: GROK_API_KEY,
27 |   baseURL: GROK_API_BASE_URL,
28 | });
29 | const functionVersion = "v8.0 (Adult Content + Preferences)";
30 | console.log(`story-continuation ${functionVersion}: Using model ${MODEL_NAME} via ${openai.baseURL}`);
31 | 
32 | const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
33 | const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
34 | if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) throw new Error("Supabase URL or Service Role Key not set");
35 | const supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
36 | 
37 | // --- Interfaces for AI JSON Responses ---
38 | interface AiContinuationOption {
39 |   summary: string;
40 | }
41 | interface AiContinuationOptionsResponse {
42 |   options: AiContinuationOption[];
43 | }
44 | interface AiContinuationResponse {
45 |   title: string;
46 |   content: string;
47 | }
48 | 
49 | // --- Validation functions for AI responses ---
50 | function isValidOptionsResponse(data: any): data is AiContinuationOptionsResponse {
51 |   return data &&
52 |     Array.isArray(data.options) &&
53 |     data.options.every((opt: any) => typeof opt.summary === 'string' && opt.summary.trim() !== '');
54 | }
55 | 
56 | function isValidContinuationResponse(data: any): data is AiContinuationResponse {
57 |   return data &&
58 |     typeof data.title === 'string' && // Title can be empty initially, cleanExtractedText handles default
59 |     typeof data.content === 'string' && data.content.trim() !== '';
60 | }
61 | 
62 | 
63 | // --- Funciones Helper ---
64 | async function generateContinuationOptions(
65 |   story: Story,
66 |   chapters: Chapter[],
67 |   language: string = 'en',
68 |   preferences: string | null = null,
69 | ): Promise<AiContinuationOptionsResponse> {
70 |   console.log(`[${functionVersion}] generateContinuationOptions for story ${story?.id}`);
71 | 
72 |   if (!story || !story.id || !story.title || !story.content || !story.options) {
73 |     throw new Error("Datos de historia inválidos/incompletos para generar opciones.");
74 |   }
75 |   if (!Array.isArray(chapters)) {
76 |     throw new Error("Datos de capítulos inválidos para generar opciones.");
77 |   }
78 | 
79 |   const prompt = createContinuationOptionsPrompt(story, chapters, language, preferences);
80 |   console.log(`[${functionVersion}] Prompt para generación de opciones (lang: ${language}):\n---\n${prompt.substring(0, 300)}...\n---`);
81 | 
82 |   let aiResponseContent: string | null = null;
83 |   try {
84 |     const chatCompletion = await openai.chat.completions.create({
85 |       model: MODEL_NAME,
86 |       messages: [{ role: "user", content: prompt }],
87 |       response_format: { type: "json_object" },
88 |       temperature: 0.7,
89 |       max_tokens: 8000, // Ajustado
90 |     });
91 | 
92 |     aiResponseContent = chatCompletion.choices[0]?.message?.content;
93 |     const finishReason = chatCompletion.choices[0]?.finish_reason;
94 | 
95 |     console.log(`[${functionVersion}] Raw AI JSON for options (first 200 chars): ${aiResponseContent?.substring(0, 200) || '(No content received)'}... Finish Reason: ${finishReason}`);
96 | 
97 |     if (finishReason === 'length') {
98 |       console.warn(`[${functionVersion}] AI option generation may have been truncated.`);
99 |     }
100 |     if (!aiResponseContent) {
101 |       throw new Error("Respuesta vacía de la IA para las opciones.");
102 |     }
103 | 
104 |     const parsedResponse = JSON.parse(aiResponseContent);
105 | 
106 |     if (isValidOptionsResponse(parsedResponse)) {
107 |       console.log(`[${functionVersion}] Opciones JSON parseadas y validadas:`, parsedResponse.options);
108 |       return parsedResponse; // Return the whole object: { options: [...] }
109 |     }
110 |     console.error(`[${functionVersion}] Formato de opciones inválido después de parsear. Data:`, parsedResponse);
111 |     throw new Error("Formato de opciones inválido después de parsear el JSON de la IA.");
112 | 
113 |   } catch (e: any) {
114 |     console.error(`[${functionVersion}] Error procesando la respuesta de la IA para las opciones: ${e.message}. Raw response: ${aiResponseContent?.substring(0, 500)}`, e);
115 |     // Fallback
116 |     const defaultOptions = [
117 |       { summary: language.startsWith('en') ? "Continue the intimate encounter" : "Continuar el encuentro íntimo" },
118 |       { summary: language.startsWith('en') ? "Explore deeper desires" : "Explorar deseos más profundos" },
119 |       { summary: language.startsWith('en') ? "Try something new together" : "Probar algo nuevo juntos" }
120 |     ].map(opt => ({ summary: `${opt.summary} (${language.startsWith('en') ? 'default option' : 'opción por defecto'})` }));
121 |     return { options: defaultOptions };
122 |   }
123 | }
124 | 
125 | // cleanExtractedText: Se mantiene, ya que procesa strings provenientes de la IA (dentro del JSON).
126 | function cleanExtractedText(text: string | undefined | null, type: 'title' | 'content'): string {
127 |   const defaultText = type === 'title' ? `A New Chapter` : 'The story continues mysteriously...';
128 |   if (text === null || text === undefined || typeof text !== 'string') { // Allow empty string from AI, will return default
129 |     console.warn(`[${functionVersion}] cleanExtractedText (${type}): Input null, undefined, or not a string.`);
130 |     return defaultText;
131 |   }
132 |   // No console.log BEFORE for potentially very long content strings.
133 |   let cleaned = text;
134 |   // Markdown fences around the *whole string* should not happen with response_format: json_object,
135 |   // but if AI puts them *inside* a JSON string value, this might be useful.
136 |   // However, the primary instruction is AI should not use markdown *inside* string values unless natural.
137 |   // cleaned = cleaned.replace(/^```(?:json|text)?\s*([\s\S]*?)\s*```$/gm, '$1').trim(); // Less likely needed now
138 | 
139 |   cleaned = cleaned.trim(); // Trim first
140 |   cleaned = cleaned.replace(/^(Título|Title|Contenido|Content|Respuesta|Response):\s*/i, '').trim();
141 |   cleaned = cleaned.replace(/^(Aquí tienes el (título|contenido|cuento|capítulo)|Claro, aquí está el (título|contenido|cuento|capítulo)):\s*/i, '').trim();
142 |   cleaned = cleaned.replace(/\n\n\(Espero que te guste.*$/i, '').trim();
143 |   cleaned = cleaned.replace(/\n\n\[.*?\]$/i, '').trim();
144 | 
145 |   if (type === 'content') {
146 |     cleaned = cleaned.replace(/^\s*\d+\.\s+/gm, '');
147 |     cleaned = cleaned.replace(/^\s*[-\*]\s+/gm, '');
148 |   }
149 |   if (type === 'title') {
150 |     cleaned = cleaned.replace(/^["'“‘](.*)["'”’]$/s, '$1').trim();
151 |   }
152 |   cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
153 |   // console.log(`[${functionVersion}] cleanExtractedText (${type}) - AFTER: "${cleaned.substring(0, 150)}..."`);
154 |   return cleaned.trim() || defaultText; // Ensure it returns default if cleaning results in empty
155 | }
156 | // --- Fin Funciones Helper ---
157 | 
158 | serve(async (req: Request) => {
159 |   if (req.method === "OPTIONS") {
160 |     return new Response("ok", { headers: corsHeaders });
161 |   }
162 |   if (req.method !== 'POST') {
163 |     return new Response(JSON.stringify({ error: 'Método no permitido. Usar POST.' }), {
164 |       status: 405, headers: { ...corsHeaders, 'Content-Type': 'application/json' }
165 |     });
166 |   }
167 | 
168 |   let requestedAction = 'unknown';
169 |   let userId: string | null = null;
170 | 
171 |   try {
172 |     console.log(`[${functionVersion}] Handling POST request...`);
173 |     const authHeader = req.headers.get('Authorization');
174 |     if (!authHeader || !authHeader.startsWith('Bearer ')) {
175 |       console.error("Authorization header missing or invalid.");
176 |       return new Response(JSON.stringify({ error: 'Token inválido o ausente.' }), {
177 |         status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" }
178 |       });
179 |     }
180 |     const token = authHeader.replace('Bearer ', '');
181 |     const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);
182 |     if (authError || !user) {
183 |       console.error("Auth Error:", authError);
184 |       return new Response(JSON.stringify({ error: authError?.message || 'No autenticado.' }), {
185 |         status: authError?.status || 401, headers: { ...corsHeaders, "Content-Type": "application/json" }
186 |       });
187 |     }
188 |     userId = user.id;
189 |     console.log(`[${functionVersion}] User Auth: ${userId}`);
190 | 
191 |     let body: any;
192 |     try {
193 |       body = await req.json();
194 |       if (!body || typeof body !== 'object') throw new Error("Parsed body is not an object.");
195 |     } catch (error: any) {
196 |       console.error(`[${functionVersion}] Failed to parse JSON body for user ${userId}. Error:`, error);
197 |       throw new Error(`Invalid/empty JSON in body: ${error.message}.`);
198 |     }
199 | 
200 |     const { action, story, chapters = [], selectedOptionSummary, userDirection } = body;
201 |     requestedAction = action || 'unknown';
202 |     const story_id = story?.id;
203 | 
204 |     const isContinuationAction = ['freeContinuation', 'optionContinuation', 'directedContinuation'].includes(action);
205 |     const requiresStoryForContext = isContinuationAction || action === 'generateOptions';
206 | 
207 |     // Validaciones de entrada (largely same as v6.1)
208 |     if (!action) throw new Error("'action' es requerida.");
209 |     if (requiresStoryForContext) {
210 |       if (!story || typeof story !== 'object' || !story_id) {
211 |         throw new Error(`Objeto 'story' (con 'id') inválido/ausente para la acción '${action}'.`);
212 |       }
213 |       // Validate story has required content and at least one character
214 |       const hasCharacterData = (story.options.characters && story.options.characters.length > 0) || story.options.character?.name;
215 |       if (!story.content || !story.options || !hasCharacterData || !story.title) {
216 |         console.error("Story validation failed:", {
217 |           hasContent: !!story.content,
218 |           hasOptions: !!story.options,
219 |           hasCharacterData: hasCharacterData,
220 |           hasTitle: !!story.title,
221 |           charactersCount: story.options.characters?.length || 0,
222 |           primaryCharacterName: story.options.characters?.[0]?.name
223 |         });
224 |         throw new Error("Datos incompletos en el objeto 'story' recibido (content, options con al menos un personaje, title son necesarios).");
225 |       }
226 |       if (!Array.isArray(chapters)) {
227 |         throw new Error(`Array 'chapters' requerido (puede ser vacío) para la acción '${action}'.`);
228 |       }
229 |     }
230 |     if (action === 'optionContinuation' && (typeof selectedOptionSummary !== 'string' || !selectedOptionSummary.trim())) {
231 |       throw new Error("'selectedOptionSummary' (string no vacío) requerido para 'optionContinuation'.");
232 |     }
233 |     if (action === 'directedContinuation' && (typeof userDirection !== 'string' || !userDirection.trim())) {
234 |       throw new Error("'userDirection' (string no vacío) requerido para 'directedContinuation'.");
235 |     }
236 | 
237 |     // Get preferences from profile instead of legacy parameters
238 |     const { data: profile } = await supabaseAdmin
239 |       .from('profiles')
240 |       .select('language, preferences')
241 |       .eq('id', userId)
242 |       .single();
243 | 
244 |     const language = profile?.language || story?.options?.language || 'en';
245 |     const preferences = profile?.preferences || null;
246 |     const storyFormat = body.storyFormat || story?.options?.format || 'episodic';
247 | 
248 |     // Límites (largely same logic as v6.1)
249 |     if (isContinuationAction) {
250 |       const { data: profile, error: profileError } = await supabaseAdmin.from('profiles').select('subscription_status').eq('id', userId).maybeSingle();
251 |       if (profileError) throw new Error("Error al verificar el perfil de usuario para límites.");
252 | 
253 |       const isPremium = profile?.subscription_status === 'active' || profile?.subscription_status === 'trialing';
254 |       if (!isPremium) {
255 |         const { count: chapterCount, error: countError } = await supabaseAdmin.from('story_chapters')
256 |           .select('*', { count: 'exact', head: true })
257 |           .eq('story_id', story_id);
258 |         if (countError) throw new Error("Error al verificar límites de continuación.");
259 | 
260 |         const FREE_CHAPTER_LIMIT = 2; // Límite de capítulos *adicionales* generables (no se si el capitulo 0 lo cuenta)
261 |         if (chapterCount !== null && chapterCount >= FREE_CHAPTER_LIMIT) {
262 |           return new Response(JSON.stringify({ error: 'Límite de continuaciones gratuitas alcanzado.' }), {
263 |             status: 403, headers: { ...corsHeaders, "Content-Type": "application/json" }
264 |           });
265 |         }
266 |       }
267 |     }
268 | 
269 |     // --- Ejecutar Acción Principal ---
270 |     let responsePayload: any = {}; // Use 'any' for flexibility, or a union type
271 |     console.log(`[${functionVersion}] Executing action: ${action} for user ${userId}, story ${story_id || 'N/A'}`);
272 | 
273 |     if (action === 'generateOptions') {
274 |       const optionsResponse = await generateContinuationOptions(story as Story, chapters as Chapter[], language, preferences);
275 |       responsePayload = optionsResponse; // This is already { options: [...] }
276 |     } else if (isContinuationAction) {
277 |       const continuationContext: ContinuationContextType = {};
278 |       if (action === 'optionContinuation') continuationContext.optionSummary = selectedOptionSummary;
279 |       if (action === 'directedContinuation') continuationContext.userDirection = userDirection;
280 | 
281 |       const continuationPrompt = createContinuationPrompt(
282 |         action as 'freeContinuation' | 'optionContinuation' | 'directedContinuation',
283 |         story as Story,
284 |         chapters as Chapter[],
285 |         continuationContext,
286 |         language,
287 |         preferences,
288 |         storyFormat
289 |       );
290 | 
291 |       console.log(`[${functionVersion}] Calling AI for continuation. Prompt start: ${continuationPrompt.substring(0, 200)}...`);
292 | 
293 |       const chatCompletion = await openai.chat.completions.create({
294 |         model: MODEL_NAME,
295 |         messages: [{ role: "user", content: continuationPrompt }],
296 |         response_format: { type: "json_object" },
297 |         temperature: 0.8,
298 |         top_p: 0.95,
299 |         max_tokens: 8000 // Ajustado
300 |       });
301 | 
302 |       const aiResponseContent = chatCompletion.choices[0]?.message?.content;
303 |       const finishReason = chatCompletion.choices[0]?.finish_reason;
304 |       console.log(`[${functionVersion}] Raw AI JSON for continuation (first 200 chars): ${aiResponseContent?.substring(0, 200) || '(No content received)'}... Finish Reason: ${finishReason}`);
305 | 
306 |       if (finishReason === 'content_filter') {
307 |         console.error(`[${functionVersion}] AI Continuation Generation BLOCKED due to content filter.`);
308 |         throw new Error(`Generación de continuación bloqueada por seguridad: filtro de contenido.`);
309 |       }
310 |       if (finishReason === 'length') {
311 |         console.warn(`[${functionVersion}] AI continuation generation may have been truncated.`);
312 |       }
313 |       if (!aiResponseContent) {
314 |         throw new Error("Fallo al generar continuación: Respuesta IA vacía (sin bloqueo explícito).");
315 |       }
316 | 
317 |       let finalTitle = 'Un Nuevo Capítulo'; // Default
318 |       let finalContent = '';
319 |       let parsedSuccessfully = false;
320 | 
321 |       try {
322 |         const parsedResponse = JSON.parse(aiResponseContent);
323 |         if (isValidContinuationResponse(parsedResponse)) {
324 |           finalTitle = cleanExtractedText(parsedResponse.title, 'title');
325 |           finalContent = cleanExtractedText(parsedResponse.content, 'content');
326 |           parsedSuccessfully = true;
327 |           console.log(`[${functionVersion}] Parsed AI continuation JSON successfully.`);
328 |         } else {
329 |           console.warn(`[${functionVersion}] AI continuation response JSON structure invalid. Data:`, parsedResponse);
330 |         }
331 |       } catch (parseError: any) {
332 |         console.error(`[${functionVersion}] Failed to parse JSON from AI continuation response. Error: ${parseError.message}. Raw: ${aiResponseContent.substring(0, 300)}`);
333 |       }
334 | 
335 |       if (!parsedSuccessfully) {
336 |         console.warn(`[${functionVersion}] Using fallback for continuation: Default title, full raw response as content (if available).`);
337 |         finalContent = cleanExtractedText(aiResponseContent, 'content'); // aiResponseContent might be the non-JSON string
338 |       }
339 | 
340 |       if (!finalContent) { // If content is still empty after parsing/fallback and cleaning
341 |         console.error(`[${functionVersion}] Critical error: Final continuation content is empty after all processing.`);
342 |         finalContent = language.startsWith('en') ? "The story couldn't continue this time. Try another option or a new direction." : "La historia no pudo continuar esta vez. Intenta con otra opción o una nueva dirección.";
343 |         // Optionally throw, but providing a message might be better UX for continuations
344 |       }
345 | 
346 |       console.log(`[${functionVersion}] Final Title: "${finalTitle}", Final Content Length: ${finalContent.length}`);
347 |       responsePayload = { content: finalContent, title: finalTitle };
348 | 
349 |     } else {
350 |       throw new Error(`Acción no soportada: ${action}`);
351 |     }
352 | 
353 |     console.log(`[${functionVersion}] Action ${action} completed successfully for ${userId}.`);
354 |     return new Response(JSON.stringify(responsePayload), {
355 |       status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' }
356 |     });
357 | 
358 |   } catch (error: any) {
359 |     console.error(`Error in ${functionVersion} (User: ${userId || 'UNKNOWN'}, Action: ${requestedAction}):`, error.message, error.stack);
360 |     let statusCode = 500;
361 |     const lowerMessage = error.message.toLowerCase();
362 | 
363 |     if (lowerMessage.includes("token inválido") || lowerMessage.includes("no autenticado")) statusCode = 401;
364 |     else if (lowerMessage.includes("límite de continuaciones")) statusCode = 403;
365 |     else if (lowerMessage.includes("json in body") || lowerMessage.includes("inválido/ausente") || lowerMessage.includes("requerido")) statusCode = 400;
366 |     else if (lowerMessage.includes("bloqueada por seguridad") || lowerMessage.includes("respuesta ia vacía") || lowerMessage.includes("filtro de contenido")) statusCode = 502;
367 |     else if (lowerMessage.includes("acción no soportada")) statusCode = 400;
368 | 
369 |     return new Response(JSON.stringify({ error: `Error procesando solicitud (${requestedAction}): ${error.message}` }), {
370 |       status: statusCode, headers: { ...corsHeaders, 'Content-Type': 'application/json' }
371 |     });
372 |   }
373 | });
```

supabase/functions/story-continuation/prompt.ts
```
1 | // supabase/edge-functions/story-continuation/prompt.ts
2 | // v8.0 (Adult Content + Preferences): Prompts para la continuación de historias adultas.
3 | // Ahora incluye el contenido COMPLETO de los capítulos anteriores en el contexto.
4 | 
5 | // --- Tipos (asumidos/definidos según el uso en index.ts) ---
6 | export interface CharacterOptions {
7 |     name: string;
8 |     gender: 'male' | 'female' | 'non-binary';
9 |     description: string;
10 | }
11 | 
12 | export interface StoryOptions {
13 |     characters: CharacterOptions[];   // Unified: array de personajes (1-4)
14 |     genre: string;
15 |     format?: string; // 'single', 'episodic'
16 |     language?: string;
17 | }
18 | 
19 | export interface Story {
20 |     id: string;
21 |     title: string; // Título general de la historia
22 |     content: string; // Contenido del capítulo inicial (o la historia base si no hay capítulos)
23 |     options: StoryOptions;
24 | }
25 | 
26 | export interface Chapter {
27 |     id: string;
28 |     chapter_number: number;
29 |     title: string;
30 |     content: string;
31 | }
32 | 
33 | export interface ContinuationContextType {
34 |     optionSummary?: string;
35 |     userDirection?: string;
36 | }
37 | 
38 | // --- Funciones de Prompt ---
39 | 
40 | /**
41 |  * Crea el prompt para generar opciones de continuación para contenido adulto.
42 |  * Ahora incluye el contenido completo de la historia y capítulos anteriores.
43 |  */
44 | export function createContinuationOptionsPrompt(
45 |     story: Story,
46 |     chapters: Chapter[],
47 |     language: string = 'en',
48 |     preferences: string | null = null,
49 | ): string {
50 |     const functionVersion = "v8.0 (Adult Content + Preferences)";
51 |     console.log(`[Prompt Helper ${functionVersion}] createContinuationOptionsPrompt for story ID: ${story.id}, lang: ${language}`);
52 | 
53 |     let prompt = `You are a creative assistant expert in generating interesting and coherent continuations for erotic stories for adults.
54 |   Primary Story Language: ${language}. Target Audience: Adults (18+).`;
55 | 
56 |     if (preferences && preferences.trim()) {
57 |         prompt += `\nConsider the user's preferences when suggesting continuations: "${preferences.trim()}". Incorporate these elements naturally and appropriately.`;
58 |     }
59 | 
60 |     prompt += `\n\n--- COMPLETE STORY CONTEXT SO FAR ---`;
61 |     prompt += `\n\n**Original Story (General Title: "${story.title}")**`;
62 |     
63 |     // Character handling (unchanged)
64 |     const characters = story.options.characters || [];
65 |     
66 |     if (characters.length > 1) {
67 |         prompt += `\nMain Characters (${characters.length}): `;
68 |         characters.forEach((char, index) => {
69 |             prompt += `${index + 1}. ${char.name}`;
70 |             prompt += ` (${char.gender}, ${char.description})`;
71 |             if (index < characters.length - 1) prompt += ', ';
72 |         });
73 |         prompt += `.`;
74 |     } else if (characters.length === 1) {
75 |         prompt += `\nMain Character: ${characters[0].name} (${characters[0].gender}, ${characters[0].description}).`;
76 |     }
77 |     
78 |     prompt += `\n\n**Story Beginning:**\n${story.content}\n`;
79 | 
80 |     if (chapters && chapters.length > 0) {
81 |         prompt += `\n\n**Previous Chapters:**`;
82 |         chapters.forEach((chap) => {
83 |             prompt += `\n\n**Chapter ${chap.chapter_number}: "${chap.title}"**\n${chap.content}\n`;
84 |         });
85 |     }
86 |     prompt += `\n--- END OF COMPLETE CONTEXT ---\n`;
87 | 
88 |     prompt += `\n\nBased on the current state of the story (considering ALL the context provided above), generate 3 concise and attractive options to continue the erotic story. Each option should be a brief summary (10-20 words) of a possible next step in the adult adventure.`;
89 |     prompt += `\nThe options should be varied, offering different paths or approaches for continuation that maintain the erotic/romantic tension.`;
90 |     prompt += `\nEnsure the options explore clearly distinct themes or actions (for example: one option about exploring a new location, another about the introduction of a new character or element, and another about deepening intimacy or trying something new).`;
91 |     prompt += `\nThey must be written in ${language}.`;
92 | 
93 |     // JSON format instructions (unchanged)
94 |     prompt += `\n\n**Response format instructions (VERY IMPORTANT!):**`;
95 |     prompt += `\n* You must respond with a SINGLE JSON object.`;
96 |     prompt += `\n* The JSON object must have a single key called "options".`;
97 |     prompt += `\n* The value of the "options" key must be an array (list) of exactly 3 objects.`;
98 |     prompt += `\n* Each object within the "options" array must have a single key called "summary".`;
99 |     prompt += `\n* The value of the "summary" key should be a text string with the continuation option summary (10-20 words in ${language}).`;
100 |     prompt += `\n* Example of expected JSON format:`;
101 |     prompt += `\n{`;
102 |     prompt += `\n  "options": [`;
103 |     prompt += `\n    { "summary": "The character decides to explore the mysterious bedroom." },`;
104 |     prompt += `\n    { "summary": "A new romantic interest appears unexpectedly." },`;
105 |     prompt += `\n    { "summary": "The character remembers a secret fantasy to explore." }`;
106 |     prompt += `\n  ]`;
107 |     prompt += `\n}`;
108 |     prompt += `\n* Do NOT include ANYTHING before the '{' character that starts the JSON object.`;
109 |     prompt += `\n* Do NOT include ANYTHING after the '}' character that ends the JSON object.`;
110 |     prompt += `\n* Ensure the JSON is valid and complete.`;
111 | 
112 |     return prompt;
113 | }
114 | 
115 | /**
116 |  * Crea el prompt para generar la continuación de un capítulo para contenido adulto.
117 |  * Ahora incluye el contenido completo de la historia y capítulos anteriores.
118 |  */
119 | export function createContinuationPrompt(
120 |     action: 'freeContinuation' | 'optionContinuation' | 'directedContinuation',
121 |     story: Story,
122 |     chapters: Chapter[],
123 |     context: ContinuationContextType,
124 |     language: string = 'en',
125 |     preferences: string | null = null,
126 |     storyFormat: string = 'episodic'
127 | ): string {
128 |     const functionVersion = "v8.0 (Adult Content + Preferences)";
129 |     console.log(`[Prompt Helper ${functionVersion}] createContinuationPrompt for story ID: ${story.id}, action: ${action}, lang: ${language}`);
130 | 
131 |     let prompt = `You are an expert writer continuing erotic stories for adults.
132 |   Write always in ${language}, with sophisticated and sensual language appropriate for mature audiences (18+).
133 |   The original story has a genre of '${story.options.genre}'.`;
134 | 
135 |     // Chapter length guidance based on story format
136 |     prompt += `\n\n**Chapter length guide based on story format:**`;
137 |     if (storyFormat === 'single') {
138 |         prompt += `\n* Complete Story: ~2150 tokens (approx. 1600-1800 words).`;
139 |         prompt += `\n* This should conclude the story with a satisfying ending.`;
140 |     } else {
141 |         prompt += `\n* Episodic Chapter: ~1350 tokens (approx. 1000-1200 words).`;
142 |         prompt += `\n* This should continue the story with room for future chapters.`;
143 |     }
144 |     prompt += `\nThese figures are approximate and serve as reference for the expected length.`;
145 | 
146 |     if (preferences && preferences.trim()) {
147 |         prompt += `\nIncorporate the user's preferences naturally into the continuation: "${preferences.trim()}". Ensure all content remains consensual and positive while exploring these interests.`;
148 |         prompt += ` Guidelines for preferences:\n`;
149 |         prompt += `   - **Natural Integration:** Weave preferences into the plot organically\n`;
150 |         prompt += `   - **Consensual Content:** All interactions must be consensual and positive\n`;
151 |         prompt += `   - **Character Consistency:** Maintain character personalities while exploring preferences\n`;
152 |         prompt += `   - **Quality Storytelling:** Prioritize good narrative flow over just including elements\n`;
153 |     }
154 | 
155 |     // Complete context (unchanged structure, but content focus is now adult)
156 |     prompt += `\n\n--- COMPLETE STORY CONTEXT SO FAR ---`;
157 |     prompt += `\n\n**Original Story (General Title: "${story.title}")**`;
158 |     
159 |     const characters = story.options.characters || [];
160 |     
161 |     if (characters.length > 1) {
162 |         prompt += `\nMain Characters (${characters.length}): `;
163 |         characters.forEach((char, index) => {
164 |             prompt += `${index + 1}. ${char.name}`;
165 |             prompt += `, Gender: ${char.gender}`;
166 |             prompt += `, Description: ${char.description}`;
167 |             if (index < characters.length - 1) prompt += '; ';
168 |         });
169 |         prompt += `.`;
170 |         
171 |         prompt += `\n\n**IMPORTANT for multiple characters:** In this chapter, ensure all characters maintain their consistency and that each has relevant participation according to the story development and their established relationships.`;
172 |     } else if (characters.length === 1) {
173 |         const char = characters[0];
174 |         prompt += `\nMain Character: ${char.name}`;
175 |         prompt += `, Gender: ${char.gender}`;
176 |         prompt += `, Description: ${char.description}`;
177 |         prompt += `.`;
178 |     }
179 |     
180 |     prompt += `\n\n**Story Beginning:**\n${story.content}\n`;
181 | 
182 |     if (chapters && chapters.length > 0) {
183 |         prompt += `\n\n**Previous Chapters:**`;
184 |         chapters.forEach((chap) => {
185 |             prompt += `\n\n**Chapter ${chap.chapter_number}: "${chap.title}"**\n${chap.content}\n`;
186 |         });
187 |     }
188 |     prompt += `\n--- END OF COMPLETE CONTEXT ---\n`;
189 | 
190 |     prompt += `\n\n--- YOUR TASK ---`;
191 |     prompt += `\nConsidering ALL the context provided above, write the NEXT CHAPTER of this adult story.`;
192 | 
193 |     if (action === 'optionContinuation' && context.optionSummary) {
194 |         prompt += `\nThe continuation should be based on the following option chosen by the user: "${context.optionSummary}"`;
195 |     } else if (action === 'directedContinuation' && context.userDirection) {
196 |         prompt += `\nThe continuation should follow this specific direction provided by the user: "${context.userDirection}"`;
197 |     } else {
198 |         prompt += `\nContinue the story freely and creatively, maintaining coherence with previous events and characters.`;
199 |     }
200 | 
201 |     prompt += `\n\nGuides for the New Chapter:`;
202 |     prompt += `\n1. **Chapter Content:** Aim for '${storyFormat}' format.`;
203 |     if (storyFormat === 'single') {
204 |         prompt += ` (approximately 1600-1800 words) - Complete the story with a satisfying conclusion.`;
205 |     } else {
206 |         prompt += ` (approximately 1000-1200 words) - Continue the story with room for future development.`;
207 |     }
208 | 
209 |     prompt += `\n2. **Chapter Structure:** Should have clear narrative flow, connecting with the previous chapter and advancing the overall plot. Can introduce new erotic elements or deepen existing relationships.`;
210 |     prompt += `\n3. **Tone and Style:** Maintain the tone and style of the original story. Use sophisticated, sensual language that creates atmosphere and emotional connection. Build tension and desire naturally.`;
211 |     prompt += `\n4. **Coherence:** Ensure characters behave consistently and that new events fit logically in the story while maintaining the erotic tension.`;
212 |     prompt += `\n5. **Chapter Title:** Generate a brief, attractive and relevant title for the content of this new chapter. Must be in ${language} and in "Sentence case".`;
213 |     prompt += `\n6. **Adult Content:** All interactions must be consensual and positive. Focus on emotional connection alongside physical attraction. Create engaging, erotic content that celebrates adult sexuality healthily.`;
214 | 
215 |     // JSON format instructions (unchanged)
216 |     prompt += `\n\n**Response format instructions (VERY IMPORTANT!):**`;
217 |     prompt += `\n* You must respond with a SINGLE JSON object.`;
218 |     prompt += `\n* The JSON object must have exactly two keys: "title" and "content".`;
219 |     prompt += `\n* The "title" key value should be a text string containing ONLY the generated title for this new chapter, following the guidelines in point 5 of the "Guides for the New Chapter".`;
220 |     prompt += `\n* The "content" key value should be a text string with ALL the content of this new chapter, starting directly with the first sentence.`;
221 |     const exampleCharacterName = characters.length > 0 ? characters[0].name : 'the protagonist';
222 |     prompt += `\n* Example of expected JSON format: {"title": "The Unexpected Encounter", "content": "The next morning, ${exampleCharacterName} woke up feeling a strange energy in the air..."}`;
223 |     prompt += `\n* Do NOT include ANYTHING before the '{' character that starts the JSON object.`;
224 |     prompt += `\n* Do NOT include ANYTHING after the '}' character that ends the JSON object.`;
225 |     prompt += `\n* Ensure the JSON is valid and complete.`;
226 |     prompt += `\n* Do NOT use markdown or any other formatting INSIDE the JSON strings unless it's part of the natural story text.`;
227 | 
228 |     return prompt;
229 | }
```

supabase/functions/stripe-webhook/index.ts
```
1 | // supabase/functions/stripe-webhook/index.ts
2 | 
3 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
4 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
5 | import Stripe from 'https://esm.sh/stripe@14.13.0?target=deno';
6 | // Asegúrate que la ruta es correcta para tu estructura
7 | import { corsHeaders } from '../_shared/cors.ts'; // Ajusta si moviste cors.ts
8 | 
9 | // --- Constantes y Configuración ---
10 | console.log(`[WEBHOOK_DEBUG] Stripe Webhook Function Initializing...`);
11 | 
12 | const STRIPE_SECRET_KEY = Deno.env.get('STRIPE_SECRET_KEY');
13 | const STRIPE_SIGNING_SECRET = Deno.env.get('STRIPE_SIGNING_SECRET');
14 | const APP_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY'); // O el nombre que uses
15 | const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
16 | 
17 | if (!STRIPE_SECRET_KEY || !STRIPE_SIGNING_SECRET || !SUPABASE_URL || !APP_SERVICE_ROLE_KEY) {
18 |   console.error('[WEBHOOK_ERROR] CRITICAL: Missing environment variables. Check STRIPE_SECRET_KEY, STRIPE_SIGNING_SECRET, SUPABASE_SERVICE_ROLE_KEY.');
19 |   // Considera lanzar un error
20 | }
21 | 
22 | const stripe = new Stripe(STRIPE_SECRET_KEY!, {
23 |   apiVersion: '2023-10-16',
24 |   httpClient: Stripe.createFetchHttpClient(),
25 | });
26 | 
27 | const cryptoProvider = Stripe.createSubtleCryptoProvider();
28 | 
29 | const supabaseAdmin = createClient(SUPABASE_URL!, APP_SERVICE_ROLE_KEY!);
30 | 
31 | console.log('[WEBHOOK_DEBUG] Stripe Webhook Function Initialized successfully.');
32 | 
33 | // --- Lógica Principal del Servidor ---
34 | serve(async (req: Request) => {
35 |   if (req.method === 'OPTIONS') {
36 |     console.log('[WEBHOOK_DEBUG] Handling OPTIONS preflight request');
37 |     return new Response('ok', { headers: corsHeaders });
38 |   }
39 | 
40 |   const signature = req.headers.get('Stripe-Signature');
41 |   if (!signature) {
42 |     console.error('[WEBHOOK_ERROR] FAIL: Missing Stripe-Signature header');
43 |     return new Response('Missing Stripe-Signature header', { status: 400 });
44 |   }
45 | 
46 |   const body = await req.text();
47 | 
48 |   try {
49 |     // 1. Verifica la firma
50 |     console.log('[WEBHOOK_DEBUG] Verifying webhook signature...');
51 |     const event = await stripe.webhooks.constructEventAsync(
52 |       body,
53 |       signature,
54 |       STRIPE_SIGNING_SECRET!,
55 |       undefined,
56 |       cryptoProvider
57 |     );
58 |     console.log(`[WEBHOOK_INFO] Webhook event received: ${event.id}, Type: ${event.type}`);
59 | 
60 |     // 2. Maneja el evento
61 |     const eventObject = event.data.object as any;
62 |     let supabaseUserId: string | null = null;
63 |     let stripeCustomerId: string | null = null;
64 | 
65 |     // --- Inicio: Lógica robusta para identificar al usuario ---
66 |     console.log('[WEBHOOK_DEBUG] Attempting to identify user...');
67 |     if (eventObject.customer) {
68 |       stripeCustomerId = eventObject.customer;
69 |       console.log(`[WEBHOOK_DEBUG] Found stripeCustomerId from event object: ${stripeCustomerId}`);
70 |     }
71 | 
72 |     if (eventObject.metadata?.supabase_user_id) {
73 |       supabaseUserId = eventObject.metadata.supabase_user_id;
74 |       console.log(`[WEBHOOK_DEBUG] Found supabaseUserId from event metadata: ${supabaseUserId}`);
75 |     }
76 |     else if (stripeCustomerId) {
77 |       console.log(`[WEBHOOK_DEBUG] supabaseUserId not in event metadata, trying customer metadata for ${stripeCustomerId}...`);
78 |       try {
79 |         const customer = await stripe.customers.retrieve(stripeCustomerId) as Stripe.Customer;
80 |         if (!customer.deleted && customer.metadata?.supabase_user_id) {
81 |           supabaseUserId = customer.metadata.supabase_user_id;
82 |           console.log(`[WEBHOOK_DEBUG] Found supabaseUserId from customer metadata: ${supabaseUserId}`);
83 |         } else {
84 |           console.log(`[WEBHOOK_DEBUG] supabase_user_id not found in customer metadata or customer deleted.`);
85 |         }
86 |       } catch (customerError) { console.warn(`[WEBHOOK_WARN] Error retrieving customer ${stripeCustomerId}:`, customerError.message); }
87 |     }
88 | 
89 |     if (!supabaseUserId && stripeCustomerId) {
90 |       console.log(`[WEBHOOK_DEBUG] supabaseUserId not found yet, querying profiles table for customer ${stripeCustomerId}...`);
91 |       try {
92 |         const { data: profile, error: profileError } = await supabaseAdmin
93 |           .from('profiles').select('id').eq('stripe_customer_id', stripeCustomerId).single();
94 |         if (profileError && profileError.code !== 'PGRST116') { // Ignore 'not found' error, log others
95 |           console.error(`[WEBHOOK_ERROR] DB error querying profiles for ${stripeCustomerId}:`, profileError);
96 |         } else if (profile) {
97 |           supabaseUserId = profile.id;
98 |           console.log(`[WEBHOOK_DEBUG] Found supabaseUserId ${supabaseUserId} from profiles table.`);
99 |         } else {
100 |           console.log(`[WEBHOOK_DEBUG] Profile not found for stripe_customer_id ${stripeCustomerId}.`);
101 |         }
102 |       } catch (dbError) {
103 |         console.error(`[WEBHOOK_ERROR] Exception querying profiles table for customer ${stripeCustomerId}:`, dbError.message);
104 |       }
105 |     }
106 | 
107 |     if (!supabaseUserId && !['customer.subscription.deleted', 'customer.deleted'].includes(event.type)) {
108 |       console.error(`[WEBHOOK_ERROR] CRITICAL FAIL: Could not determine supabase_user_id for event ${event.id} (Type: ${event.type}). Customer: ${stripeCustomerId}. Cannot process update.`);
109 |       return new Response(JSON.stringify({ received: true, error: 'Webhook Error: User identification failed.' }), { status: 200 });
110 |     } else if (supabaseUserId) {
111 |       console.log(`[WEBHOOK_DEBUG] User identified successfully: supabaseUserId=${supabaseUserId}`);
112 |     } else {
113 |       console.log(`[WEBHOOK_DEBUG] Proceeding without supabaseUserId (likely a customer deletion event).`);
114 |     }
115 |     // --- Fin: Lógica robusta para identificar al usuario ---
116 | 
117 |     // --- Manejadores de Eventos Específicos ---
118 |     switch (event.type) {
119 | 
120 |       case 'checkout.session.completed': {
121 |         const session = eventObject as Stripe.Checkout.Session;
122 |         console.log(`[WEBHOOK_INFO] Processing checkout.session.completed for session ${session.id}, Mode: ${session.mode}`);
123 | 
124 |         // --- Suscripción Iniciada ---
125 |         if (session.mode === 'subscription') {
126 |           if (!supabaseUserId) throw new Error(`[WEBHOOK_ERROR] Cannot process subscription checkout ${session.id}: missing supabase_user_id.`);
127 | 
128 |           const subscriptionId = session.subscription as string;
129 |           console.log(`[WEBHOOK_DEBUG] Retrieving subscription ${subscriptionId}`);
130 |           const subscription = await stripe.subscriptions.retrieve(subscriptionId);
131 |           // const planId = subscription.items.data[0]?.price.id; // Descomenta si necesitas
132 |           const status = subscription.status;
133 |           const currentPeriodEnd = new Date(subscription.current_period_end * 1000);
134 | 
135 |           console.log(`[WEBHOOK_INFO] Updating profile for new subscription ${subscription.id} for user ${supabaseUserId}`);
136 |           const { error } = await supabaseAdmin
137 |             .from('profiles')
138 |             .update({
139 |               stripe_subscription_id: subscription.id,
140 |               subscription_status: status,
141 |               stripe_customer_id: stripeCustomerId, // Asegurar que esté guardado/actualizado
142 |               current_period_end: currentPeriodEnd.toISOString(),
143 |               monthly_voice_generations_used: 0, // Resetear contador de uso
144 |             })
145 |             .eq('id', supabaseUserId);
146 | 
147 |           if (error) {
148 |             console.error(`[WEBHOOK_ERROR] FAIL: Error updating profile for subscription ${subscription.id}:`, error);
149 |             throw error; // Relanza para el catch general
150 |           } else {
151 |             console.log(`[WEBHOOK_INFO] OK: Profile updated for new subscription ${subscription.id}.`);
152 |           }
153 | 
154 |           // --- Compra Única (Créditos) - CÓDIGO CORREGIDO + DEBUGGING ---
155 |         } else if (session.mode === 'payment') {
156 |           console.log(`[WEBHOOK_DEBUG] Handling checkout.session.completed for one-time payment: ${session.id}`);
157 | 
158 |           const paymentIntentId = session.payment_intent as string;
159 |           if (!paymentIntentId) {
160 |             console.error(`[WEBHOOK_ERROR] FAIL: Payment Intent ID missing in session ${session.id} for mode=payment.`);
161 |             return new Response(JSON.stringify({ received: true, error: 'Missing payment intent ID' }), { status: 200 });
162 |           }
163 |           console.log(`[WEBHOOK_DEBUG] Found PaymentIntent ID from session: ${paymentIntentId}`);
164 | 
165 |           let paymentIntent: Stripe.PaymentIntent;
166 |           try {
167 |             console.log(`[WEBHOOK_DEBUG] Retrieving PaymentIntent ${paymentIntentId}...`);
168 |             paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);
169 |             console.log(`[WEBHOOK_DEBUG] Retrieved PaymentIntent ${paymentIntent.id}. Status: ${paymentIntent.status}`);
170 |           } catch (piError) {
171 |             console.error(`[WEBHOOK_ERROR] FAIL: Could not retrieve PaymentIntent ${paymentIntentId}:`, piError);
172 |             return new Response(JSON.stringify({ received: true, error: 'Failed to retrieve payment intent' }), { status: 200 });
173 |           }
174 | 
175 |           // !! LEER METADATA DEL PAYMENT INTENT RECUPERADO !!
176 |           const piMetadata = paymentIntent.metadata; // Objeto metadata completo
177 |           const itemPurchased = piMetadata?.item_purchased;
178 |           const userIdFromMetadata = piMetadata?.supabase_user_id;
179 | 
180 |           // -------- AÑADIR ESTOS LOGS --------
181 |           console.log(`[WEBHOOK_DEBUG] Retrieved PaymentIntent Metadata: ${JSON.stringify(piMetadata)}`);
182 |           console.log(`[WEBHOOK_DEBUG] Value read for itemPurchased: "${itemPurchased}" (Type: ${typeof itemPurchased})`);
183 |           // -----------------------------------
184 | 
185 |           // Re-verificar supabaseUserId si no se obtuvo antes
186 |           if (!supabaseUserId && userIdFromMetadata) {
187 |             supabaseUserId = userIdFromMetadata;
188 |             console.log(`[WEBHOOK_DEBUG] supabaseUserId updated from PaymentIntent metadata: ${supabaseUserId}`);
189 |           }
190 | 
191 |           if (!supabaseUserId) {
192 |             console.error(`[WEBHOOK_ERROR] FAIL: Cannot process payment intent ${paymentIntent.id}: missing supabase_user_id after all checks.`);
193 |             return new Response(JSON.stringify({ received: true, error: 'User identification failed for payment' }), { status: 200 });
194 |           }
195 | 
196 |           // Comparar con la cadena EXACTA 'voice_credits'
197 |           if (itemPurchased === 'voice_credits') {
198 |             console.log(`[WEBHOOK_DEBUG] Condition 'itemPurchased === "voice_credits"' is TRUE.`);
199 | 
200 |             if (paymentIntent.status !== 'succeeded') {
201 |               console.warn(`[WEBHOOK_WARN] PaymentIntent ${paymentIntent.id} status is ${paymentIntent.status}, not 'succeeded'. Skipping credit increment.`);
202 |               return new Response(JSON.stringify({ received: true, status: 'payment_not_succeeded' }), { status: 200 });
203 |             }
204 | 
205 |             // ¡¡¡ VERIFICA ESTE NÚMERO !!!
206 |             const creditsToAdd = 20; // Ejemplo: 20 créditos
207 |             console.log(`[WEBHOOK_INFO] Attempting to add ${creditsToAdd} voice credits to user ${supabaseUserId} via RPC.`);
208 | 
209 |             const { error: creditError } = await supabaseAdmin.rpc('increment_voice_credits', {
210 |               user_uuid: supabaseUserId,
211 |               credits_to_add: creditsToAdd
212 |             });
213 | 
214 |             if (creditError) {
215 |               console.error(`[WEBHOOK_ERROR] FAIL: Error adding voice credits via RPC for user ${supabaseUserId} from PI ${paymentIntent.id}:`, creditError);
216 |               return new Response(JSON.stringify({ received: true, error: 'Failed to update credits in DB' }), { status: 200 });
217 |             } else {
218 |               console.log(`[WEBHOOK_INFO] OK: Added ${creditsToAdd} voice credits via RPC for user ${supabaseUserId} from PI ${paymentIntent.id}.`);
219 |             }
220 |           } else {
221 |             // Este log ahora nos dirá por qué falló la comparación
222 |             console.log(`[WEBHOOK_INFO] Condition 'itemPurchased === "voice_credits"' is FALSE. Actual value: "${itemPurchased}". No credits added.`);
223 |           }
224 |         }
225 |         break;
226 |       } // Fin case 'checkout.session.completed'
227 | 
228 |       case 'invoice.paid': {
229 |         const invoice = eventObject as Stripe.Invoice;
230 |         console.log(`[WEBHOOK_INFO] Processing invoice.paid for invoice ${invoice.id}, Billing Reason: ${invoice.billing_reason}`);
231 |         if (!supabaseUserId) throw new Error(`[WEBHOOK_ERROR] Cannot process invoice ${invoice.id}: missing supabase_user_id.`);
232 | 
233 |         if (invoice.paid && invoice.subscription && invoice.billing_reason === 'subscription_cycle') { // Procesar solo renovaciones aquí
234 |           const subscriptionId = invoice.subscription as string;
235 |           console.log(`[WEBHOOK_DEBUG] Retrieving subscription ${subscriptionId} for renewal.`);
236 |           const subscription = await stripe.subscriptions.retrieve(subscriptionId);
237 |           const currentPeriodEnd = new Date(subscription.current_period_end * 1000);
238 | 
239 |           console.log(`[WEBHOOK_INFO] Resetting monthly usage for user ${supabaseUserId} due to subscription renewal.`);
240 |           const { error } = await supabaseAdmin
241 |             .from('profiles')
242 |             .update({
243 |               subscription_status: subscription.status,
244 |               current_period_end: currentPeriodEnd.toISOString(),
245 |               monthly_voice_generations_used: 0, // Resetear uso mensual
246 |             })
247 |             .eq('id', supabaseUserId);
248 | 
249 |           if (error) {
250 |             console.error(`[WEBHOOK_ERROR] FAIL: Error updating profile for invoice.paid ${invoice.id}:`, error);
251 |             throw error;
252 |           } else {
253 |             console.log(`[WEBHOOK_INFO] OK: Profile updated (monthly usage reset) for invoice.paid ${invoice.id} (User: ${supabaseUserId}).`);
254 |           }
255 |         } else {
256 |           console.log(`[WEBHOOK_INFO] Invoice ${invoice.id} paid, but not a subscription renewal or already handled.`);
257 |         }
258 |         break;
259 |       } // Fin case 'invoice.paid'
260 | 
261 |       case 'customer.subscription.updated': {
262 |         const subscription = eventObject as Stripe.Subscription;
263 |         console.log(`[WEBHOOK_INFO] Processing customer.subscription.updated for subscription ${subscription.id}, Status: ${subscription.status}`);
264 |         if (!supabaseUserId) throw new Error(`[WEBHOOK_ERROR] Cannot process subscription update ${subscription.id}: missing supabase_user_id.`);
265 | 
266 |         const status = subscription.status;
267 |         const currentPeriodEnd = new Date(subscription.current_period_end * 1000);
268 | 
269 |         const updatePayload: { [key: string]: any } = {
270 |           subscription_status: status,
271 |           current_period_end: currentPeriodEnd.toISOString(),
272 |         };
273 | 
274 |         if (subscription.cancel_at_period_end) {
275 |           console.log(`[WEBHOOK_INFO] Subscription ${subscription.id} scheduled for cancellation at period end.`);
276 |         }
277 | 
278 |         console.log(`[WEBHOOK_INFO] Updating profile for customer.subscription.updated ${subscription.id}`);
279 |         const { error } = await supabaseAdmin
280 |           .from('profiles')
281 |           .update(updatePayload)
282 |           .eq('id', supabaseUserId);
283 | 
284 |         if (error) {
285 |           console.error(`[WEBHOOK_ERROR] FAIL: Error updating profile for customer.subscription.updated ${subscription.id}:`, error);
286 |           throw error;
287 |         } else {
288 |           console.log(`[WEBHOOK_INFO] OK: Profile updated for customer.subscription.updated ${subscription.id}.`);
289 |         }
290 |         break;
291 |       } // Fin case 'customer.subscription.updated'
292 | 
293 |       case 'customer.subscription.deleted': {
294 |         const subscription = eventObject as Stripe.Subscription;
295 |         console.log(`[WEBHOOK_INFO] Processing customer.subscription.deleted for subscription ${subscription.id}`);
296 | 
297 |         if (!stripeCustomerId) throw new Error(`[WEBHOOK_ERROR] Cannot process subscription delete ${subscription.id}: missing stripe_customer_id.`);
298 | 
299 |         console.log(`[WEBHOOK_INFO] Updating profile for customer.subscription.deleted using customer ID ${stripeCustomerId}`);
300 |         const { error } = await supabaseAdmin
301 |           .from('profiles')
302 |           .update({
303 |             stripe_subscription_id: null,
304 |             subscription_status: 'canceled',
305 |             current_period_end: null,
306 |             monthly_voice_generations_used: 0,
307 |             // voice_credits: 0, // Comentado para conservar créditos comprados
308 |           })
309 |           .eq('stripe_customer_id', stripeCustomerId);
310 | 
311 |         if (error) {
312 |           console.error(`[WEBHOOK_ERROR] FAIL: Error updating profile for customer.subscription.deleted ${subscription.id}:`, error);
313 |         } else {
314 |           console.log(`[WEBHOOK_INFO] OK: Profile updated for customer.subscription.deleted ${subscription.id}.`);
315 |         }
316 |         break;
317 |       } // Fin case 'customer.subscription.deleted'
318 | 
319 |       default:
320 |         console.log(`[WEBHOOK_INFO] Unhandled event type: ${event.type}. ID: ${event.id}`);
321 |     }
322 | 
323 |     // 3. Responde a Stripe
324 |     console.log(`[WEBHOOK_INFO] Webhook processed successfully for event: ${event.id}`);
325 |     return new Response(JSON.stringify({ received: true }), { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
326 | 
327 |   } catch (err) {
328 |     console.error('[WEBHOOK_ERROR] FATAL: Webhook handler error:', err);
329 |     const isSignatureError = err.type === 'StripeSignatureVerificationError';
330 |     const status = isSignatureError ? 400 : 500;
331 |     return new Response(`Webhook Error: ${err.message}`, { status: status, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
332 |   }
333 | });
```

supabase/functions/upload-chapter-audio/index.ts
```
1 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
2 | import { createClient, SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2';
3 | import { corsHeaders } from '../_shared/cors.ts'; // Asegúrate que la ruta sea correcta
4 | 
5 | // Tipado para los datos de la base de datos (opcional pero recomendado)
6 | interface ChapterAudioFile {
7 |   id?: string;
8 |   chapter_id: string;
9 |   user_id: string;
10 |   story_id: string;
11 |   voice_id: string;
12 |   storage_path: string;
13 |   public_url: string;
14 |   metadata?: Record<string, any>;
15 |   created_at?: string;
16 | }
17 | 
18 | serve(async (req: Request) => {
19 |   // Manejo de CORS preflight request
20 |   if (req.method === 'OPTIONS') {
21 |     return new Response('ok', { headers: corsHeaders });
22 |   }
23 | 
24 |   try {
25 |     const supabaseUrl = Deno.env.get('SUPABASE_URL');
26 |     const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
27 | 
28 |     if (!supabaseUrl || !supabaseServiceKey) {
29 |       console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY');
30 |       return new Response(JSON.stringify({ error: 'Variables de entorno del servidor no configuradas.' }), {
31 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' },
32 |         status: 500,
33 |       });
34 |     }
35 | 
36 |     const supabaseClient: SupabaseClient = createClient(supabaseUrl, supabaseServiceKey);
37 |     const formData = await req.formData();
38 | 
39 |     const chapterId = formData.get('chapterId') as string;
40 |     const voiceId = formData.get('voiceId') as string;
41 |     const audioFile = formData.get('audioFile') as File;
42 |     const userId = formData.get('userId') as string;
43 |     const storyId = formData.get('storyId') as string; // Añadido para la ruta de almacenamiento
44 | 
45 |     if (!chapterId || !voiceId || !audioFile || !storyId) {
46 |       return new Response(JSON.stringify({ error: 'Faltan parámetros: storyId, chapterId, voiceId o audioFile' }), {
47 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' },
48 |         status: 400,
49 |       });
50 |     }
51 | 
52 |     const bucketName = 'narrations'; 
53 |     // Estructura de ruta mejorada: bucket/storyId/chapterId/voiceId.mp3
54 |     const filePath = `${storyId}/${chapterId}/${voiceId}.mp3`; 
55 | 
56 |     console.log(`Subiendo archivo a: ${bucketName}/${filePath}`);
57 | 
58 |     const { data: uploadData, error: uploadError } = await supabaseClient.storage
59 |       .from(bucketName)
60 |       .upload(filePath, audioFile, {
61 |         cacheControl: '3600',
62 |         upsert: true, 
63 |         contentType: 'audio/mpeg',
64 |       });
65 | 
66 |     if (uploadError) {
67 |       console.error('Error subiendo a Storage:', uploadError);
68 |       // Si el error es 'Duplicate', significa que el archivo ya existe y upsert=true debería haberlo manejado.
69 |       // Podría ser un problema de permisos o configuración del bucket si no es 'Duplicate'.
70 |       // Para el caso específico de "The resource already exists" (cuando upsert=true),
71 |       // podemos considerar que el archivo ya está y continuar para obtener su URL.
72 |       if (uploadError.message !== 'The resource already exists') {
73 |          throw uploadError;
74 |       }
75 |       console.warn(`El archivo en ${filePath} ya existía. Se intentará obtener su URL pública.`);
76 |     }
77 | 
78 |     const { data: publicUrlData } = supabaseClient.storage
79 |       .from(bucketName)
80 |       .getPublicUrl(filePath);
81 | 
82 |     if (!publicUrlData || !publicUrlData.publicUrl) {
83 |       console.error('Error obteniendo URL pública para:', filePath);
84 |       throw new Error('No se pudo obtener la URL pública del archivo.');
85 |     }
86 |     const publicUrl = publicUrlData.publicUrl;
87 |     console.log('URL Pública obtenida:', publicUrl);
88 | 
89 |     const chapterAudioInsert: Omit<ChapterAudioFile, 'id' | 'created_at'> = {
90 |       chapter_id: chapterId,
91 |       story_id: storyId,
92 |       user_id: userId,
93 |       voice_id: voiceId,
94 |       storage_path: filePath, // Guardamos la ruta relativa al bucket
95 |       public_url: publicUrl,
96 |       // metadata: { fileSize: audioFile.size } // Opcional
97 |     };
98 | 
99 |     const { data: dbData, error: dbError } = await supabaseClient
100 |       .from('audio_files')
101 |       .upsert(chapterAudioInsert, {
102 |         onConflict: 'chapter_id, voice_id, user_id',
103 |         // ignoreDuplicates: false, // Queremos que actualice si hay conflicto
104 |       })
105 |       .select()
106 |       .single();
107 | 
108 |     if (dbError) {
109 |       console.error('Error guardando en base de datos:', dbError);
110 |       throw dbError;
111 |     }
112 |     console.log('Registro en DB:', dbData);
113 | 
114 |     return new Response(JSON.stringify({ publicUrl, chapterAudioFile: dbData }), {
115 |       headers: { ...corsHeaders, 'Content-Type': 'application/json' },
116 |       status: 200,
117 |     });
118 | 
119 |   } catch (error) {
120 |     console.error('Error en Edge Function (upload-chapter-audio):', error);
121 |     return new Response(JSON.stringify({ error: error.message || 'Error interno del servidor' }), {
122 |       headers: { ...corsHeaders, 'Content-Type': 'application/json' },
123 |       status: 500,
124 |     });
125 |   }
126 | });
```

supabase/functions/upload-story-image/index.ts
```
1 | import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
2 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
3 | 
4 | const corsHeaders = {
5 |   'Access-Control-Allow-Origin': '*',
6 |   'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
7 | }
8 | 
9 | interface UploadImageRequest {
10 |   imageUrl?: string;  // Para URLs de OpenAI (método antiguo)
11 |   imageBase64?: string; // Para datos base64 del nuevo método
12 |   imageType: string;
13 |   storyId: string;
14 |   chapterId: string;
15 | }
16 | 
17 | /**
18 |  * Edge Function to upload story images to Supabase storage
19 |  * Path structure: images-stories/storyId/chapterId/imageType.jpeg
20 |  */
21 | serve(async (req: Request) => {
22 |   // Handle CORS preflight requests
23 |   if (req.method === 'OPTIONS') {
24 |     return new Response('ok', { headers: corsHeaders })
25 |   }
26 | 
27 |   try {
28 |     console.log('[UPLOAD_STORY_IMAGE] Starting image upload process...');
29 | 
30 |     // Get request data
31 |     const { imageUrl, imageBase64, imageType, storyId, chapterId }: UploadImageRequest = await req.json();
32 | 
33 |     // Validate required fields
34 |     if ((!imageUrl && !imageBase64) || !imageType || !storyId || !chapterId) {
35 |       console.error('[UPLOAD_STORY_IMAGE] Missing required fields:', { 
36 |         imageUrl: !!imageUrl, 
37 |         imageBase64: !!imageBase64, 
38 |         imageType, 
39 |         storyId, 
40 |         chapterId 
41 |       });
42 |       return new Response(
43 |         JSON.stringify({ error: 'Missing required fields: (imageUrl or imageBase64), imageType, storyId, chapterId' }),
44 |         { status: 400, headers: corsHeaders }
45 |       );
46 |     }
47 | 
48 |     // Validate imageType
49 |     const validImageTypes = ['cover', 'scene_1', 'scene_2'];
50 |     if (!validImageTypes.includes(imageType)) {
51 |       console.error('[UPLOAD_STORY_IMAGE] Invalid image type:', imageType);
52 |       return new Response(
53 |         JSON.stringify({ error: `Invalid imageType. Must be one of: ${validImageTypes.join(', ')}` }),
54 |         { status: 400, headers: corsHeaders }
55 |       );
56 |     }
57 | 
58 |     console.log(`[UPLOAD_STORY_IMAGE] Processing ${imageType} for story ${storyId}, chapter ${chapterId}`);
59 | 
60 |     // Create Supabase admin client
61 |     const supabaseAdmin = createClient(
62 |       Deno.env.get('SUPABASE_URL') ?? '',
63 |       Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
64 |     );
65 | 
66 |     // Process image data (either from URL or base64)
67 |     let imageBuffer: ArrayBuffer;
68 |     
69 |     if (imageBase64) {
70 |       console.log('[UPLOAD_STORY_IMAGE] Processing base64 image data...');
71 |       // Convert base64 to buffer
72 |       const binaryString = atob(imageBase64);
73 |       const bytes = new Uint8Array(binaryString.length);
74 |       for (let i = 0; i < binaryString.length; i++) {
75 |         bytes[i] = binaryString.charCodeAt(i);
76 |       }
77 |       imageBuffer = bytes.buffer;
78 |       console.log(`[UPLOAD_STORY_IMAGE] Processed base64 image: ${imageBuffer.byteLength} bytes`);
79 |     } else if (imageUrl) {
80 |       console.log('[UPLOAD_STORY_IMAGE] Downloading image from URL...');
81 |       const imageResponse = await fetch(imageUrl);
82 |       
83 |       if (!imageResponse.ok) {
84 |         throw new Error(`Failed to download image: ${imageResponse.status} ${imageResponse.statusText}`);
85 |       }
86 | 
87 |       const imageBlob = await imageResponse.blob();
88 |       imageBuffer = await imageBlob.arrayBuffer();
89 |       console.log(`[UPLOAD_STORY_IMAGE] Downloaded image: ${imageBuffer.byteLength} bytes`);
90 |     } else {
91 |       throw new Error('No image data provided');
92 |     }
93 | 
94 |     // Define storage path: images-stories/storyId/chapterId/imageType.jpeg
95 |     const storagePath = `${storyId}/${chapterId}/${imageType}.jpeg`;
96 |     console.log(`[UPLOAD_STORY_IMAGE] Uploading to path: ${storagePath}`);
97 | 
98 |     // Upload to Supabase Storage
99 |     const { data: uploadData, error: uploadError } = await supabaseAdmin.storage
100 |       .from('images-stories')
101 |       .upload(storagePath, imageBuffer, {
102 |         contentType: 'image/jpeg',
103 |         upsert: true, // Overwrite if exists
104 |       });
105 | 
106 |     if (uploadError) {
107 |       console.error('[UPLOAD_STORY_IMAGE] Upload error:', uploadError);
108 |       throw new Error(`Storage upload failed: ${uploadError.message}`);
109 |     }
110 | 
111 |     console.log('[UPLOAD_STORY_IMAGE] Upload successful:', uploadData);
112 | 
113 |     // Get public URL
114 |     const { data: urlData } = supabaseAdmin.storage
115 |       .from('images-stories')
116 |       .getPublicUrl(storagePath);
117 | 
118 |     const publicUrl = urlData.publicUrl;
119 |     console.log(`[UPLOAD_STORY_IMAGE] Public URL generated: ${publicUrl}`);
120 | 
121 |     // Return success response
122 |     return new Response(
123 |       JSON.stringify({
124 |         success: true,
125 |         publicUrl: publicUrl,
126 |         path: storagePath,
127 |         imageType: imageType,
128 |         storyId: storyId,
129 |         chapterId: chapterId
130 |       }),
131 |       {
132 |         status: 200,
133 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' }
134 |       }
135 |     );
136 | 
137 |   } catch (error) {
138 |     console.error('[UPLOAD_STORY_IMAGE] Error:', error);
139 |     
140 |     return new Response(
141 |       JSON.stringify({
142 |         error: 'Failed to upload story image',
143 |         details: error instanceof Error ? error.message : 'Unknown error'
144 |       }),
145 |       {
146 |         status: 500,
147 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' }
148 |       }
149 |     );
150 |   }
151 | }) 
```

src/store/stories/audio/audioStore.ts
```
1 | import { create } from 'zustand';
2 | import { persist } from 'zustand/middleware';
3 | import { AudioState } from "../../types/storeTypes";
4 | import { createPersistentStore } from "../../core/createStore";
5 | import {
6 |   getCurrentVoice,
7 |   getUserAudios,
8 |   setCurrentVoice,
9 |   syncAudioFile,
10 |   syncQueue,
11 | } from "../../../services/supabase";
12 | import { useUserStore } from "../../user/userStore";
13 | 
14 | // Tipos
15 | type GenerationStatus = 'idle' | 'generating' | 'completed' | 'error';
16 | 
17 | interface AudioStateEntry {
18 |   url: string;
19 |   generatedAt: number;
20 |   // Eliminamos referencia a S3, solo usamos URLs locales (blob)
21 | }
22 | 
23 | interface AudioGenerationStatus {
24 |   status: GenerationStatus;
25 |   progress: number;
26 | }
27 | 
28 | interface AudioStore {
29 |   // Cache de audio
30 |   audioCache: Record<string, AudioStateEntry>; // storyId_chapterId_voiceId -> AudioStateEntry
31 |   
32 |   // Estado de generación
33 |   generationStatus: Record<string, AudioGenerationStatus>; // storyId_chapterId -> status
34 |   
35 |   // Preferencia de voz
36 |   currentVoice: string | null;
37 |   
38 |   // Acciones
39 |   addAudioToCache: (storyId: string, chapterId: string | number, voiceId: string, url: string) => void;
40 |   getAudioFromCache: (storyId: string, chapterId: string | number, voiceId: string) => string | null;
41 |   clearAudioCache: () => void;
42 |   removeAudioFromCache: (storyId: string, chapterId: string | number, voiceId: string) => void;
43 |   
44 |   // Acciones para generación
45 |   setGenerationStatus: (storyId: string, chapterId: string | number, status: GenerationStatus, progress?: number) => void;
46 |   getGenerationStatus: (storyId: string, chapterId: string | number) => AudioGenerationStatus;
47 |   
48 |   // Acciones preferencia de voz
49 |   setCurrentVoice: (voiceId: string) => void;
50 |   getCurrentVoice: () => string | null;
51 | }
52 | 
53 | // Crear store con persistencia
54 | export const useAudioStore = create<AudioStore>()(
55 |   persist(
56 |     (set, get) => ({
57 |       // Estado inicial
58 |       audioCache: {},
59 |       generationStatus: {},
60 |       currentVoice: null,
61 |       
62 |       // Acciones para cache de audio
63 |       addAudioToCache: (storyId, chapterId, voiceId, url) => {
64 |         const key = `${storyId}_${chapterId}_${voiceId}`;
65 |         set(state => ({
66 |           audioCache: {
67 |             ...state.audioCache,
68 |             [key]: {
69 |               url,
70 |               generatedAt: Date.now()
71 |             }
72 |           }
73 |         }));
74 |       },
75 |       
76 |       getAudioFromCache: (storyId, chapterId, voiceId) => {
77 |         const key = `${storyId}_${chapterId}_${voiceId}`;
78 |         const entry = get().audioCache[key];
79 |         return entry?.url || null;
80 |       },
81 |       
82 |       clearAudioCache: () => {
83 |         // Liberar URLs de blob antes de limpiar el cache
84 |         Object.values(get().audioCache).forEach(entry => {
85 |           if (entry.url.startsWith('blob:')) {
86 |             URL.revokeObjectURL(entry.url);
87 |           }
88 |         });
89 |         
90 |         set({ audioCache: {} });
91 |       },
92 |       
93 |       removeAudioFromCache: (storyId, chapterId, voiceId) => {
94 |         const key = `${storyId}_${chapterId}_${voiceId}`;
95 |         const entry = get().audioCache[key];
96 |         
97 |         // Si es un blob URL, liberarla
98 |         if (entry && entry.url.startsWith('blob:')) {
99 |           URL.revokeObjectURL(entry.url);
100 |         }
101 |         
102 |         set(state => {
103 |           const newCache = { ...state.audioCache };
104 |           delete newCache[key];
105 |           return { audioCache: newCache };
106 |         });
107 |       },
108 |       
109 |       // Acciones para estado de generación
110 |       setGenerationStatus: (storyId, chapterId, status, progress = 0) => {
111 |         const key = `${storyId}_${chapterId}`;
112 |         set(state => ({
113 |           generationStatus: {
114 |             ...state.generationStatus,
115 |             [key]: { status, progress }
116 |           }
117 |         }));
118 |       },
119 |       
120 |       getGenerationStatus: (storyId, chapterId) => {
121 |         const key = `${storyId}_${chapterId}`;
122 |         return get().generationStatus[key] || { status: 'idle', progress: 0 };
123 |       },
124 |       
125 |       // Acciones para preferencia de voz
126 |       setCurrentVoice: (voiceId) => {
127 |         set({ currentVoice: voiceId });
128 |       },
129 |       
130 |       getCurrentVoice: () => {
131 |         return get().currentVoice;
132 |       }
133 |     }),
134 |     {
135 |       name: 'audio-storage', // Nombre de la clave en localStorage
136 |     }
137 |   )
138 | );
```

src/store/stories/chapters/chaptersStore.ts
```
1 | import { ChaptersState } from "../../types/storeTypes";
2 | import { StoryWithChapters } from "../../../types";
3 | import { createPersistentStore } from "../../core/createStore";
4 | import { useStoriesStore } from "../storiesStore";
5 | import {
6 |   getStoryChapters,
7 |   syncChapter,
8 |   syncQueue,
9 | } from "../../../services/supabase";
10 | 
11 | // Estado inicial
12 | const initialState: Pick<ChaptersState, "storyChapters"> = {
13 |   storyChapters: [],
14 | };
15 | 
16 | export const useChaptersStore = createPersistentStore<ChaptersState>(
17 |   initialState,
18 |   (set, get) => ({
19 |     getChaptersByStoryId: (storyId) => {
20 |       const storyWithChapters = get().storyChapters.find((s) =>
21 |         s.id === storyId
22 |       );
23 |       return storyWithChapters ? storyWithChapters.chapters : [];
24 |     },
25 | 
26 |     addChapter: async (storyId, chapter) => {
27 |       console.log("🚀 ~ addChapter: ~ chapter:", chapter)
28 |       console.log("🚀 ~ addChapter: ~ storyId:", storyId)
29 |       try {
30 |         // 1. Intentar sincronizar con Supabase PRIMERO
31 |         const { success } = await syncChapter(chapter, storyId);
32 | 
33 |         if (success) {
34 |           // 2. SI la sincronización es exitosa, AHORA actualizar el store local
35 |           set((state) => {
36 |             const storyWithChapters = state.storyChapters.find((s) =>
37 |               s.id === storyId
38 |             );
39 | 
40 |             if (storyWithChapters) {
41 |               // Actualizar los capítulos existentes
42 |               return {
43 |                 storyChapters: state.storyChapters.map((s) =>
44 |                   s.id === storyId
45 |                     ? { ...s, chapters: [...s.chapters, chapter] }
46 |                     : s
47 |                 ),
48 |               };
49 |             } else {
50 |               // Crear nueva entrada para la historia
51 |               const storiesStore = useStoriesStore.getState();
52 |               const story = storiesStore.getStoryById(storyId);
53 | 
54 |               if (!story) return state; // Historia no encontrada
55 | 
56 |               const newStoryWithChapters: StoryWithChapters = {
57 |                 id: storyId,
58 |                 title: story.title,
59 |                 content: story.content,
60 |                 options: story.options,
61 |                 createdAt: story.createdAt,
62 |                 audioUrl: story.audioUrl,
63 |                 chapters: [chapter],
64 |               };
65 | 
66 |               return {
67 |                 storyChapters: [...state.storyChapters, newStoryWithChapters],
68 |               };
69 |             }
70 |           });
71 |         } else {
72 |            // 3. Si falla la sincronización directa, agregar a la cola SIN actualizar el estado local
73 |            console.warn("Sincronización directa de capítulo fallida, añadiendo a la cola.");
74 |            syncQueue.addToQueue("story_chapters", "insert", {
75 |              story_id: storyId,
76 |              chapter_number: chapter.chapterNumber,
77 |              title: chapter.title,
78 |              content: chapter.content,
79 |              generation_method: chapter.generationMethod,
80 |              custom_input: chapter.customInput,
81 |            });
82 |            // Lanzar un error para que el frontend sepa que no se guardó (opcional pero recomendado)
83 |            throw new Error("No se pudo guardar el capítulo en la base de datos.");
84 |         }
85 |       } catch (error) {
86 |         console.error("Error sincronizando capítulo con Supabase:", error);
87 |         // 4. Si hay un error en el try, agregar a la cola SIN actualizar el estado local
88 |         syncQueue.addToQueue("story_chapters", "insert", {
89 |           story_id: storyId,
90 |           chapter_number: chapter.chapterNumber,
91 |           title: chapter.title,
92 |           content: chapter.content,
93 |           generation_method: chapter.generationMethod,
94 |           custom_input: chapter.customInput,
95 |         });
96 |         // Propagar el error para que el frontend pueda manejarlo
97 |         throw error;
98 |       }
99 |     },
100 | 
101 |     getLastChapterByStoryId: (storyId) => {
102 |       const chapters = get().getChaptersByStoryId(storyId);
103 |       if (chapters.length === 0) return undefined;
104 | 
105 |       // Ordenar capítulos y devolver el último
106 |       return [...chapters].sort((a, b) => b.chapterNumber - a.chapterNumber)[0];
107 |     },
108 | 
109 |     loadChaptersFromSupabase: async (storyId) => {
110 |       try {
111 |         const { success, chapters } = await getStoryChapters(storyId);
112 | 
113 |         if (success && chapters && chapters.length > 0) {
114 |           const storiesStore = useStoriesStore.getState();
115 |           const story = storiesStore.getStoryById(storyId);
116 | 
117 |           if (!story) return; // Historia no encontrada
118 | 
119 |           set((state) => {
120 |             const existingStoryIndex = state.storyChapters.findIndex((s) =>
121 |               s.id === storyId
122 |             );
123 | 
124 |             if (existingStoryIndex >= 0) {
125 |               // Actualizar capítulos de la historia existente
126 |               const updatedStoryChapters = [...state.storyChapters];
127 |               updatedStoryChapters[existingStoryIndex] = {
128 |                 ...updatedStoryChapters[existingStoryIndex],
129 |                 chapters,
130 |               };
131 | 
132 |               return { storyChapters: updatedStoryChapters };
133 |             } else {
134 |               // Crear nueva entrada para la historia
135 |               const newStoryWithChapters: StoryWithChapters = {
136 |                 id: storyId,
137 |                 title: story.title,
138 |                 content: story.content,
139 |                 options: story.options,
140 |                 createdAt: story.createdAt,
141 |                 audioUrl: story.audioUrl,
142 |                 chapters,
143 |               };
144 | 
145 |               return {
146 |                 storyChapters: [...state.storyChapters, newStoryWithChapters],
147 |               };
148 |             }
149 |           });
150 |         }
151 |       } catch (error) {
152 |         console.error("Error cargando capítulos desde Supabase:", error);
153 |       }
154 |     },
155 |   }),
156 |   "chapters",
157 | );
```
