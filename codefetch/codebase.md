Project Structure:
├── CHANGELOG.md
├── CLAUDE.md
├── README.md
├── bun.lockb
├── components.json
├── debug-edge-function.js
├── deploy-pm2.sh
├── docs
│   ├── EDGE_FUNCTIONS.md
│   ├── PAUTAS_DE_DISENO.md
│   ├── Stripe_integration.md
│   ├── exportar_pdf.md
│   ├── project_structure.md
│   ├── provisional_logica_tts.md
│   ├── services.md
│   ├── store_arquitecture.md
│   ├── supabase-integration-guide.md
│   ├── supabase_RLS.sql
│   ├── supabase_presets_data.sql
│   └── supabase_tables.sql
├── ecosystem.config.cjs
├── eslint.config.js
├── get-token.js
├── index.html
├── package-lock.json
├── package.json
├── postcss.config.cjs
├── public
│   ├── favicon_v0.png
│   ├── favicon_v2.png
│   ├── fondo_png.png
│   ├── icono_png.png
│   ├── logo_png.png
├── src
│   ├── App.css
│   ├── App.tsx
│   ├── env.d.ts
│   ├── index.css
│   ├── main.tsx
│   ├── supabaseAuth.ts
│   ├── supabaseClient.ts
│   └── vite-env.d.ts
├── supabase
│   ├── config.toml
├── tailwind.config.ts
├── tsconfig.app.json
├── tsconfig.json
├── tsconfig.node.json
└── vite.config.ts


CLAUDE.md
```
1 | # CLAUDE.md - TaleMe Project Guide
2 | 
3 | ## Project Overview
4 | 
5 | **TaleMe** is a personalized children's storytelling application that generates custom stories with voice narration and educational challenges. The app creates tales adapted to each child's age, interests, and personality, featuring professional voice narration and interactive learning elements.
6 | 
7 | **Current Version**: 1.1.4  
8 | **Main Branch**: master  
9 | **Project Type**: Single Page Application (SPA)  
10 | **Language**: Spanish (with multi-language support)
11 | 
12 | ## Technology Stack
13 | 
14 | ### Frontend
15 | - **React 18.3.1** with TypeScript
16 | - **Vite** for build tooling and development server
17 | - **Tailwind CSS** for styling with custom configuration
18 | - **shadcn/ui** component library (extensive Radix UI components)
19 | - **Framer Motion** for animations and transitions
20 | - **Zustand** for state management
21 | - **React Router DOM** for navigation
22 | - **React Hook Form** with Zod validation
23 | - **TanStack Query** for server state management
24 | 
25 | ### Backend & Services
26 | - **Supabase** as Backend-as-a-Service (BaaS)
27 |   - Authentication and user management
28 |   - PostgreSQL database with Row Level Security (RLS)
29 |   - Edge Functions for serverless compute
30 |   - File storage for audio and images
31 | - **OpenAI** for AI-powered story generation and TTS
32 | - **Google Generative AI** (Gemini) for story generation
33 | - **Stripe** for payment processing and subscriptions
34 | - **ElevenLabs** for voice synthesis (via API)
35 | 
36 | ### Development Tools
37 | - **TypeScript** with strict configuration
38 | - **ESLint** with React and TypeScript rules
39 | - **PostCSS** with Tailwind CSS
40 | - **PM2** for production deployment
41 | - **Bun** as package manager (with npm fallback)
42 | 
43 | ## Project Structure
44 | 
45 | ```
46 | TaleMe/
47 | ├── src/
48 | │   ├── components/           # Reusable UI components
49 | │   │   ├── ui/              # shadcn/ui components (~49 files)
50 | │   │   └── [various].tsx    # App-specific components
51 | │   ├── pages/               # Route-based page components
52 | │   ├── services/            # API integration layer
53 | │   │   ├── ai/             # AI service wrappers
54 | │   │   └── [various].ts    # Database and third-party services
55 | │   ├── store/              # Zustand state management
56 | │   │   ├── character/      # Character management
57 | │   │   ├── stories/        # Story-related state
58 | │   │   ├── user/           # User profile and auth
59 | │   │   └── core/           # Store utilities
60 | │   ├── hooks/              # Custom React hooks
61 | │   ├── lib/                # Utility functions
62 | │   ├── types/              # TypeScript type definitions
63 | │   └── config/             # App configuration
64 | ├── supabase/
65 | │   ├── functions/          # Edge Functions
66 | │   ├── migrations/         # Database migrations
67 | │   └── sql-functions/      # Database functions
68 | ├── docs/                   # Project documentation
69 | └── public/                 # Static assets
70 | ```
71 | 
72 | ## Key Features
73 | 
74 | ### Story Generation
75 | - **Personalized Stories**: AI-generated tales based on character preferences, age, and interests
76 | - **Chapter System**: Multi-chapter stories with continuation options
77 | - **Multiple Genres**: Adventure, fantasy, educational, etc.
78 | - **Character Customization**: Name, profession, personality, hobbies
79 | 
80 | ### Audio Features
81 | - **Text-to-Speech**: Professional voice narration using OpenAI TTS
82 | - **Multiple Voices**: Different personality-matched voices
83 | - **Audio Player**: Custom audio player with progress tracking
84 | - **Voice Preview**: Sample voices before selection
85 | 
86 | ### Image Generation
87 | - **AI-Generated Images**: DALL-E 3 integration for story illustrations
88 | - **Multiple Image Types**: Cover, scenes, character portraits
89 | - **Automatic Generation**: Asynchronous image creation for stories
90 | 
91 | ### Educational Elements
92 | - **Challenges**: Reading comprehension, math, language questions
93 | - **Multiple Languages**: Support for translation challenges
94 | - **Adaptive Difficulty**: Age-appropriate content and questions
95 | 
96 | ### User Management
97 | - **Authentication**: Supabase Auth with email/password
98 | - **Profiles**: User preferences and child information
99 | - **Subscriptions**: Stripe-powered payment system
100 | - **Usage Tracking**: Story and voice credit limits
101 | 
102 | ## Development Workflow
103 | 
104 | ### Local Development
105 | ```bash
106 | # Install dependencies
107 | npm install
108 | 
109 | # Start development server
110 | npm run dev
111 | 
112 | # Build for production
113 | npm run build:prod
114 | 
115 | # Preview production build
116 | npm run start:prod
117 | ```
118 | 
119 | ### Key Commands
120 | - `npm run dev` - Start development server (localhost:8080)
121 | - `npm run build` - Build for production
122 | - `npm run lint` - Run ESLint
123 | - `npm run deploy` - Build and start production server
124 | 
125 | ### Environment Setup
126 | Required environment variables:
127 | - `VITE_SUPABASE_URL` - Supabase project URL
128 | - `VITE_SUPABASE_ANON_KEY` - Supabase anonymous key
129 | - `VITE_STRIPE_PUBLISHABLE_KEY` - Stripe publishable key
130 | - `VITE_ELEVENLABS_API_KEY` - ElevenLabs API key
131 | 
132 | ## Architecture Patterns
133 | 
134 | ### State Management
135 | - **Zustand stores** for global state
136 | - **Store separation** by domain (user, character, stories, etc.)
137 | - **Persistence** with localStorage for offline support
138 | - **Sync queue** for offline-first data handling
139 | 
140 | ### Service Layer
141 | - **Abstraction layer** between UI and backend
142 | - **Edge Function wrappers** for AI services
143 | - **Direct database access** with RLS security
144 | - **Error handling** with standardized response format
145 | 
146 | ### Component Architecture
147 | - **Atomic design** with reusable components
148 | - **Page-based routing** with React Router
149 | - **Custom hooks** for shared logic
150 | - **TypeScript** for type safety
151 | 
152 | ## Database Schema
153 | 
154 | ### Main Tables
155 | - `profiles` - User profiles and preferences
156 | - `characters` - Custom story characters
157 | - `stories` - Generated stories with metadata
158 | - `story_chapters` - Individual story chapters
159 | - `audio_files` - Generated audio recordings
160 | - `challenges` - Educational challenges
161 | - `user_voices` - Voice preferences
162 | 
163 | ### Security
164 | - **Row Level Security (RLS)** on all tables
165 | - **User-based access control**
166 | - **Secure API key management** in Edge Functions
167 | 
168 | ### SQL Documentation
169 | For detailed SQL schema and RLS policies, consult:
170 | - `/docs/supabase_tables.sql` - Complete table definitions and structure
171 | - `/docs/supabase_RLS.sql` - Row Level Security policies and permissions
172 | 
173 | ## Testing
174 | 
175 | **Note**: Currently no test framework is configured. The project uses:
176 | - Manual testing in development
177 | - TypeScript for compile-time validation
178 | - ESLint for code quality
179 | - Production monitoring for runtime issues
180 | 
181 | ## Deployment
182 | 
183 | ### Production Setup
184 | - **PM2** for process management
185 | - **Nginx** reverse proxy (not included in repo)
186 | - **Environment variables** for configuration
187 | - **Supabase Edge Functions** for serverless compute
188 | 
189 | ### PM2 Configuration
190 | ```javascript
191 | // ecosystem.config.cjs
192 | {
193 |   name: "cuenta-cuentos",
194 |   script: "npm",
195 |   args: "run start:prod",
196 |   env: {
197 |     NODE_ENV: "production",
198 |     PORT: "8080"
199 |   }
200 | }
201 | ```
202 | 
203 | ## Development Guidelines
204 | 
205 | ### Code Style
206 | - **TypeScript strict mode** enabled
207 | - **ESLint** configuration with React rules
208 | - **Consistent naming** (camelCase for JS, snake_case for DB)
209 | - **Component organization** by feature/domain
210 | 
211 | ### Best Practices
212 | - **Prefer editing** existing files over creating new ones
213 | - **Use absolute imports** with `@/` alias
214 | - **Handle errors** gracefully with user feedback
215 | - **Implement loading states** for async operations
216 | - **Follow Tailwind CSS** utility-first approach
217 | 
218 | ### State Management Rules
219 | - **Single source of truth** for each domain
220 | - **Immutable updates** using Zustand patterns
221 | - **Async operations** with proper loading/error states
222 | - **Persist critical data** to localStorage
223 | 
224 | ## API Integration
225 | 
226 | ### Edge Functions
227 | - `generate-story` - AI story generation
228 | - `story-continuation` - Story continuation options
229 | - `challenge` - Educational challenge generation
230 | - `generate-audio` - Text-to-speech conversion
231 | - `upload-story-image` - Image generation and storage
232 | - Stripe functions for payment processing
233 | 
234 | ### External APIs
235 | - **OpenAI** - GPT models and TTS
236 | - **Google Generative AI** - Gemini models
237 | - **Stripe** - Payment processing
238 | - **ElevenLabs** - Voice synthesis
239 | 
240 | ## Common Issues & Solutions
241 | 
242 | ### Authentication
243 | - **Race conditions** handled with auth guards
244 | - **Session management** through Supabase client
245 | - **Redirect handling** for auth callbacks
246 | 
247 | ### Performance
248 | - **Lazy loading** for route components
249 | - **Image optimization** with proper formats
250 | - **Audio streaming** for large files
251 | - **State persistence** to avoid refetching
252 | 
253 | ### Offline Support
254 | - **Sync queue** for failed operations
255 | - **localStorage persistence** for critical data
256 | - **Network detection** for connectivity changes
257 | 
258 | ## Future Considerations
259 | 
260 | ### Potential Improvements
261 | - **Unit testing** framework (Jest/Vitest)
262 | - **E2E testing** with Cypress/Playwright
263 | - **Performance monitoring** with analytics
264 | - **Accessibility** improvements
265 | - **PWA features** for offline usage
266 | 
267 | ### Scaling Considerations
268 | - **Database optimization** for large datasets
269 | - **CDN integration** for static assets
270 | - **Caching strategies** for API responses
271 | - **Load balancing** for high traffic
272 | 
273 | ---
274 | 
275 | **Last Updated**: January 2025  
276 | **Version**: 1.1.4  
277 | **Maintainer**: Development Team
278 | 
279 | For detailed implementation guides, see the `/docs` directory.
```

components.json
```
1 | {
2 |   "$schema": "https://ui.shadcn.com/schema.json",
3 |   "style": "default",
4 |   "rsc": false,
5 |   "tsx": true,
6 |   "tailwind": {
7 |     "config": "tailwind.config.ts",
8 |     "css": "src/index.css",
9 |     "baseColor": "slate",
10 |     "cssVariables": true,
11 |     "prefix": ""
12 |   },
13 |   "aliases": {
14 |     "components": "@/components",
15 |     "utils": "@/lib/utils",
16 |     "ui": "@/components/ui",
17 |     "lib": "@/lib",
18 |     "hooks": "@/hooks"
19 |   }
20 | }
```

debug-edge-function.js
```
1 | // Script de depuración para probar la función edge de generación de títulos
2 | import { createClient } from '@supabase/supabase-js';
3 | 
4 | // Configuración de Supabase (usar las mismas credenciales que en el proyecto)
5 | const supabaseUrl = 'https://xivpepuqgfqvcaalrpcn.supabase.co';
6 | const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpdnBlcHVxZ2ZxdmNhYWxycGNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIzMTE1MjcsImV4cCI6MjA1Nzg4NzUyN30.tvVnrSY6SJZQUa5MJw1g4558sbm_gsN1RA_BqUVYIGY';
7 | const supabase = createClient(supabaseUrl, supabaseKey);
8 | 
9 | // Función para probar la generación de títulos
10 | async function testGenerateTitle() {
11 |   console.log('Probando generación de títulos...');
12 |   
13 |   try {
14 |     // Contenido de ejemplo para generar un título
15 |     const sampleContent = `Había una vez un pequeño conejo llamado Tito que vivía en el bosque. A Tito le gustaba explorar y descubrir nuevos lugares. Un día, mientras saltaba entre los arbustos, encontró una madriguera que nunca antes había visto. Era extraña y misteriosa, con un brillo tenue que salía desde su interior.`;
16 |     
17 |     console.log('Enviando solicitud a la Edge Function story-continuation (generateTitle)...');
18 |     
19 |     const { data, error } = await supabase.functions.invoke('story-continuation', {
20 |       body: {
21 |         action: 'generateTitle',
22 |         content: sampleContent
23 |       }
24 |     });
25 |     
26 |     if (error) {
27 |       console.error('Error en Edge Function:', error);
28 |       return;
29 |     }
30 |     
31 |     // Mostrar la respuesta completa para depuración
32 |     console.log('Respuesta completa:', JSON.stringify(data, null, 2));
33 |     
34 |     if (data && data.title) {
35 |       console.log('Título generado correctamente:', data.title);
36 |     } else {
37 |       console.error('La respuesta no contiene un título:', data);
38 |     }
39 |   } catch (error) {
40 |     console.error('Error al ejecutar la prueba:', error);
41 |   }
42 | }
43 | 
44 | // Ejecutar la prueba
45 | testGenerateTitle(); 
```

deploy-pm2.sh
```
1 | #!/bin/bash
2 | set -e
3 | 
4 | # Messages colors
5 | GREEN='\033[0;32m'
6 | YELLOW='\033[1;33m'
7 | RED='\033[0;31m'
8 | NC='\033[0m' # No Color
9 | 
10 | echo -e "${GREEN}=== Starting production deployment with PM2 ===${NC}"
11 | 
12 | # Verify if pm2 is installed
13 | if ! command -v pm2 &> /dev/null; then
14 |     echo -e "${YELLOW}PM2 is not installed. Installing globally...${NC}"
15 |     npm install -g pm2
16 | fi
17 | 
18 | # Verify if .env file exists
19 | if [ ! -f .env.production ]; then
20 |     echo -e "${YELLOW}File .env not found. Copying from .env.example...${NC}"
21 |     if [ -f .env.example ]; then
22 |         cp .env.example .env
23 |         echo -e "${YELLOW}¡Copied! Please edit the .env file with your real credentials before continuing.${NC}"
24 |         exit 1
25 |     else
26 |         echo -e "${RED}File .env.example not found. Please create a .env file manually.${NC}"
27 |         exit 1
28 |     fi
29 | fi
30 | 
31 | # Install dependencies
32 | echo -e "${GREEN}Installing dependencies...${NC}"
33 | npm ci
34 | 
35 | # Build the application
36 | echo -e "${GREEN}Building the application for production...${NC}"
37 | npm run build:prod
38 | 
39 | # Stop previous instance in PM2 (if exists)
40 | echo -e "${GREEN}Stopping previous instance (if exists)...${NC}"
41 | pm2 delete cuenta-cuentos 2>/dev/null || true
42 | 
43 | # Start with PM2
44 | echo -e "${GREEN}Starting the application with PM2...${NC}"
45 | pm2 start ecosystem.config.cjs --env production
46 | 
47 | # Save PM2 configuration
48 | echo -e "${GREEN}Saving PM2 configuration...${NC}"
49 | pm2 save
50 | 
51 | # Show status
52 | echo -e "${GREEN}Showing application status...${NC}"
53 | pm2 status
54 | 
55 | echo -e "${GREEN}=== Deployment completed ===${NC}"
56 | echo -e "${GREEN}The application is available at: http://localhost:80${NC}"
57 | echo -e "${YELLOW}To see the logs: pm2 logs cuenta-cuentos${NC}"
58 | echo -e "${YELLOW}To stop the application: pm2 stop cuenta-cuentos${NC}"
59 | echo -e "${YELLOW}To restart the application: pm2 restart cuenta-cuentos${NC}"
60 | echo -e "${YELLOW}To monitor resources: pm2 monit${NC}" 
```

ecosystem.config.cjs
```
1 | module.exports = {
2 |   apps: [
3 |     {
4 |       name: "cuenta-cuentos",
5 |       script: "npm",
6 |       args: "run start:prod",
7 |       env: {
8 |         NODE_ENV: "production",
9 |         PORT: "8080"
10 |       },
11 |       instances: 1,
12 |       exec_mode: "fork",
13 |       watch: false,
14 |       max_memory_restart: "1G",
15 |       env_production: {
16 |         NODE_ENV: "production"
17 |       }
18 |     }
19 |   ]
20 | } 
```

eslint.config.js
```
1 | import js from "@eslint/js";
2 | import globals from "globals";
3 | import reactHooks from "eslint-plugin-react-hooks";
4 | import reactRefresh from "eslint-plugin-react-refresh";
5 | import tseslint from "typescript-eslint";
6 | 
7 | export default tseslint.config(
8 |   { ignores: ["dist"] },
9 |   {
10 |     extends: [js.configs.recommended, ...tseslint.configs.recommended],
11 |     files: ["**/*.{ts,tsx}"],
12 |     languageOptions: {
13 |       ecmaVersion: 2020,
14 |       globals: globals.browser,
15 |     },
16 |     plugins: {
17 |       "react-hooks": reactHooks,
18 |       "react-refresh": reactRefresh,
19 |     },
20 |     rules: {
21 |       ...reactHooks.configs.recommended.rules,
22 |       "react-refresh/only-export-components": [
23 |         "warn",
24 |         { allowConstantExport: true },
25 |       ],
26 |       "@typescript-eslint/no-unused-vars": "off",
27 |     },
28 |   }
29 | );
```

index.html
```
1 | <!DOCTYPE html>
2 | <html lang="en">
3 | 
4 | <head>
5 |   <meta charset="UTF-8" />
6 |   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
7 |   <title>TaleMe!</title>
8 |   <meta name="description" content="TaleMe! Una app de cuentos personalizados generados por IA para niños" />
9 |   <meta name="author" content="Luis Martin, Ivano Garcia, Miguel Tajada" />
10 |   
11 |   <!-- Favicon configuración -->
12 |   <link rel="icon" href="/favicon_v2.png" />
13 |   <link rel="apple-touch-icon" href="/favicon_v2.png" />
14 |   <link rel="shortcut icon" type="image/png" href="/favicon_v2.png" />
15 |   <meta property="og:image" content="/favicon_v2.png" />
16 |   <meta name="theme-color" content="#ffffff" />
17 |   
18 |   <link rel="preconnect" href="https://fonts.googleapis.com">
19 |   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
20 |   <link
21 |     href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Quicksand:wght@500;600;700&display=swap"
22 |     rel="stylesheet">
23 | </head>
24 | 
25 | <body>
26 |   <div id="root"></div>
27 |   <script type="module" src="/src/main.tsx"></script>
28 | </body>
29 | 
30 | </html>
```

package.json
```
1 | {
2 |   "name": "vite_react_shadcn_ts",
3 |   "private": true,
4 |   "version": "0.0.0",
5 |   "type": "module",
6 |   "scripts": {
7 |     "dev": "vite",
8 |     "build": "vite build",
9 |     "build:dev": "vite build --mode development",
10 |     "build:prod": "vite build --mode production",
11 |     "start": "vite preview --host --port 8080",
12 |     "start:prod": "NODE_ENV=production vite preview --host --port 8080",
13 |     "deploy": "npm run build:prod && npm run start:prod",
14 |     "lint": "eslint .",
15 |     "preview": "vite preview"
16 |   },
17 |   "dependencies": {
18 |     "@google/generative-ai": "^0.24.0",
19 |     "@hookform/resolvers": "^3.9.0",
20 |     "@radix-ui/react-accordion": "^1.2.0",
21 |     "@radix-ui/react-alert-dialog": "^1.1.1",
22 |     "@radix-ui/react-aspect-ratio": "^1.1.0",
23 |     "@radix-ui/react-avatar": "^1.1.0",
24 |     "@radix-ui/react-checkbox": "^1.1.1",
25 |     "@radix-ui/react-collapsible": "^1.1.0",
26 |     "@radix-ui/react-context-menu": "^2.2.1",
27 |     "@radix-ui/react-dialog": "^1.1.2",
28 |     "@radix-ui/react-dropdown-menu": "^2.1.1",
29 |     "@radix-ui/react-hover-card": "^1.1.1",
30 |     "@radix-ui/react-label": "^2.1.0",
31 |     "@radix-ui/react-menubar": "^1.1.1",
32 |     "@radix-ui/react-navigation-menu": "^1.2.0",
33 |     "@radix-ui/react-popover": "^1.1.1",
34 |     "@radix-ui/react-progress": "^1.1.0",
35 |     "@radix-ui/react-radio-group": "^1.2.0",
36 |     "@radix-ui/react-scroll-area": "^1.1.0",
37 |     "@radix-ui/react-select": "^2.1.1",
38 |     "@radix-ui/react-separator": "^1.1.0",
39 |     "@radix-ui/react-slider": "^1.2.0",
40 |     "@radix-ui/react-slot": "^1.1.0",
41 |     "@radix-ui/react-switch": "^1.1.0",
42 |     "@radix-ui/react-tabs": "^1.1.0",
43 |     "@radix-ui/react-toast": "^1.2.1",
44 |     "@radix-ui/react-toggle": "^1.1.0",
45 |     "@radix-ui/react-toggle-group": "^1.1.0",
46 |     "@radix-ui/react-tooltip": "^1.1.4",
47 |     "@stripe/stripe-js": "^7.0.0",
48 |     "@supabase/supabase-js": "^2.49.3",
49 |     "@tanstack/react-query": "^5.56.2",
50 |     "@types/howler": "^2.2.12",
51 |     "@types/uuid": "^10.0.0",
52 |     "class-variance-authority": "^0.7.1",
53 |     "clsx": "^2.1.1",
54 |     "cmdk": "^1.0.0",
55 |     "date-fns": "^3.6.0",
56 |     "embla-carousel-react": "^8.3.0",
57 |     "framer-motion": "^10.16.4",
58 |     "howler": "^2.2.4",
59 |     "html2canvas": "^1.4.1",
60 |     "input-otp": "^1.2.4",
61 |     "jspdf": "^3.0.1",
62 |     "lucide-react": "^0.462.0",
63 |     "next-themes": "^0.3.0",
64 |     "openai": "^4.104.0",
65 |     "react": "^18.3.1",
66 |     "react-day-picker": "^8.10.1",
67 |     "react-dom": "^18.3.1",
68 |     "react-hook-form": "^7.53.0",
69 |     "react-resizable-panels": "^2.1.3",
70 |     "react-router-dom": "^6.26.2",
71 |     "recharts": "^2.12.7",
72 |     "sonner": "^1.7.4",
73 |     "tailwind-merge": "^2.5.2",
74 |     "tailwindcss-animate": "^1.0.7",
75 |     "uuid": "^11.1.0",
76 |     "vaul": "^0.9.3",
77 |     "zod": "^3.23.8",
78 |     "zustand": "^4.5.6"
79 |   },
80 |   "devDependencies": {
81 |     "@eslint/js": "^9.9.0",
82 |     "@tailwindcss/typography": "^0.5.15",
83 |     "@types/node": "^22.5.5",
84 |     "@types/react": "^18.3.3",
85 |     "@types/react-dom": "^18.3.0",
86 |     "@vitejs/plugin-react-swc": "^3.5.0",
87 |     "autoprefixer": "^10.4.20",
88 |     "eslint": "^9.9.0",
89 |     "eslint-plugin-react-hooks": "^5.1.0-rc.0",
90 |     "eslint-plugin-react-refresh": "^0.4.9",
91 |     "globals": "^15.9.0",
92 |     "lovable-tagger": "^1.1.7",
93 |     "postcss": "^8.4.47",
94 |     "tailwindcss": "^3.4.11",
95 |     "typescript": "^5.5.3",
96 |     "typescript-eslint": "^8.0.1",
97 |     "vite": "^5.4.1"
98 |   }
99 | }
```

postcss.config.cjs
```
1 | module.exports = {
2 |   plugins: {
3 |     tailwindcss: {},
4 |     autoprefixer: {},
5 |   },
6 | } 
```

tailwind.config.ts
```
1 | import type { Config } from "tailwindcss";
2 | 
3 | export default {
4 | 	darkMode: ["class"],
5 | 	content: [
6 | 		"./pages/**/*.{ts,tsx}",
7 | 		"./components/**/*.{ts,tsx}",
8 | 		"./app/**/*.{ts,tsx}",
9 | 		"./src/**/*.{ts,tsx}",
10 | 	],
11 | 	prefix: "",
12 | 	theme: {
13 | 		container: {
14 | 			center: true,
15 | 			padding: '2rem',
16 | 			screens: {
17 | 				'2xl': '1400px'
18 | 			}
19 | 		},
20 | 		extend: {
21 | 			fontFamily: {
22 | 				sans: ['Open Sans', 'ui-sans-serif', 'system-ui', 'sans-serif'],
23 | 				heading: ['Quicksand', 'ui-sans-serif', 'system-ui', 'sans-serif'],
24 | 			},
25 | 			colors: {
26 | 				'brand': {
27 | 					'pink': '#FDDDE3',      // Rosa Base
28 | 					'purple': '#BB79D1',    // Morado
29 | 					'blue': '#7DC4E0',      // Azul Claro
30 | 					'yellow': '#F9DA60',    // Amarillo
31 | 				},
32 | 				border: 'hsl(var(--border))',
33 | 				input: 'hsl(var(--input))',
34 | 				ring: 'hsl(var(--ring))',
35 | 				background: '#FFFBF5',       // Un blanco muy suave con tinte rosa/amarillo
36 | 				foreground: 'hsl(var(--foreground))',
37 | 				primary: {
38 | 					DEFAULT: '#BB79D1',     // Morado como primario
39 | 					foreground: 'hsl(var(--primary-foreground))'
40 | 				},
41 | 				secondary: {
42 | 					DEFAULT: '#7DC4E0',     // Azul como secundario
43 | 					foreground: 'hsl(var(--secondary-foreground))'
44 | 				},
45 | 				destructive: {
46 | 					DEFAULT: 'hsl(var(--destructive))',
47 | 					foreground: 'hsl(var(--destructive-foreground))'
48 | 				},
49 | 				muted: {
50 | 					DEFAULT: 'hsl(var(--muted))',
51 | 					foreground: 'hsl(var(--muted-foreground))'
52 | 				},
53 | 				accent: {
54 | 					DEFAULT: '#F9DA60',     // Amarillo como acento
55 | 					foreground: 'hsl(var(--accent-foreground))'
56 | 				},
57 | 				popover: {
58 | 					DEFAULT: 'hsl(var(--popover))',
59 | 					foreground: 'hsl(var(--popover-foreground))'
60 | 				},
61 | 				card: {
62 | 					DEFAULT: '#FFFFFF',     // Blanco puro para tarjetas
63 | 					foreground: 'hsl(var(--card-foreground))'
64 | 				},
65 | 				'text-primary': '#4A4A4A',  // Gris oscuro para texto principal
66 | 				'text-secondary': '#757575', // Gris medio para texto secundario
67 | 				story: {
68 | 					purple: {
69 | 						DEFAULT: '#3F2E5D',
70 | 						50: '#F5F2FA',
71 | 						100: '#EBE6F5',
72 | 						200: '#D7CCE9',
73 | 						300: '#C3B3DE',
74 | 						400: '#AF99D2',
75 | 						500: '#9B80C7',
76 | 						600: '#8767BB',
77 | 						700: '#6E4CA6',
78 | 						800: '#563C82',
79 | 						900: '#3F2E5D',
80 | 						950: '#302246'
81 | 					},
82 | 					orange: {
83 | 						DEFAULT: '#F4A261',
84 | 						50: '#FEF5EE',
85 | 						100: '#FDEADC',
86 | 						200: '#FBCFAF',
87 | 						300: '#F9B383',
88 | 						400: '#F4A261',
89 | 						500: '#F08430',
90 | 						600: '#DD6A10',
91 | 						700: '#A64F0C',
92 | 						800: '#6F3608',
93 | 						900: '#371A04'
94 | 					},
95 | 					blue: {
96 | 						DEFAULT: '#457B9D',
97 | 						50: '#E9F0F4',
98 | 						100: '#D3E1E8',
99 | 						200: '#A7C3D1',
100 | 						300: '#7BAABF',
101 | 						400: '#5692AE',
102 | 						500: '#457B9D',
103 | 						600: '#345C75',
104 | 						700: '#233E4E',
105 | 						800: '#111F26',
106 | 						900: '#06090B'
107 | 					},
108 | 				}
109 | 			},
110 | 			borderRadius: {
111 | 				lg: 'var(--radius)',
112 | 				md: 'calc(var(--radius) - 2px)',
113 | 				sm: 'calc(var(--radius) - 4px)'
114 | 			},
115 | 			keyframes: {
116 | 				'accordion-down': {
117 | 					from: { height: '0' },
118 | 					to: { height: 'var(--radix-accordion-content-height)' }
119 | 				},
120 | 				'accordion-up': {
121 | 					from: { height: 'var(--radix-accordion-content-height)' },
122 | 					to: { height: '0' }
123 | 				},
124 | 				'fade-in': {
125 | 					'0%': { opacity: '0', transform: 'translateY(10px)' },
126 | 					'100%': { opacity: '1', transform: 'translateY(0)' }
127 | 				},
128 | 				'fade-out': {
129 | 					'0%': { opacity: '1', transform: 'translateY(0)' },
130 | 					'100%': { opacity: '0', transform: 'translateY(10px)' }
131 | 				},
132 | 				'scale-in': {
133 | 					'0%': { transform: 'scale(0.95)', opacity: '0' },
134 | 					'100%': { transform: 'scale(1)', opacity: '1' }
135 | 				},
136 | 				'scale-out': {
137 | 					from: { transform: 'scale(1)', opacity: '1' },
138 | 					to: { transform: 'scale(0.95)', opacity: '0' }
139 | 				},
140 | 				'slide-in-right': {
141 | 					'0%': { transform: 'translateX(100%)' },
142 | 					'100%': { transform: 'translateX(0)' }
143 | 				},
144 | 				'slide-out-right': {
145 | 					'0%': { transform: 'translateX(0)' },
146 | 					'100%': { transform: 'translateX(100%)' }
147 | 				},
148 | 				'pulse-subtle': {
149 | 					'0%, 100%': { opacity: '1' },
150 | 					'50%': { opacity: '0.8' }
151 | 				},
152 | 				'float': {
153 | 					'0%, 100%': { transform: 'translateY(0)' },
154 | 					'50%': { transform: 'translateY(-5px)' }
155 | 				}
156 | 			},
157 | 			animation: {
158 | 				'accordion-down': 'accordion-down 0.2s ease-out',
159 | 				'accordion-up': 'accordion-up 0.2s ease-out',
160 | 				'fade-in': 'fade-in 0.5s ease-out',
161 | 				'fade-out': 'fade-out 0.5s ease-out',
162 | 				'scale-in': 'scale-in 0.3s ease-out',
163 | 				'scale-out': 'scale-out 0.3s ease-out',
164 | 				'slide-in-right': 'slide-in-right 0.3s ease-out',
165 | 				'slide-out-right': 'slide-out-right 0.3s ease-out',
166 | 				'pulse-subtle': 'pulse-subtle 2s infinite ease-in-out',
167 | 				'float': 'float 3s infinite ease-in-out'
168 | 			}
169 | 		}
170 | 	},
171 | 	plugins: [require("tailwindcss-animate")],
172 | } satisfies Config;
```

tsconfig.app.json
```
1 | {
2 |   "compilerOptions": {
3 |     "target": "ES2020",
4 |     "useDefineForClassFields": true,
5 |     "lib": ["ES2020", "DOM", "DOM.Iterable"],
6 |     "module": "ESNext",
7 |     "skipLibCheck": true,
8 | 
9 |     /* Bundler mode */
10 |     "moduleResolution": "bundler",
11 |     "allowImportingTsExtensions": true,
12 |     "isolatedModules": true,
13 |     "moduleDetection": "force",
14 |     "noEmit": true,
15 |     "jsx": "react-jsx",
16 | 
17 |     /* Linting */
18 |     "strict": false,
19 |     "noUnusedLocals": false,
20 |     "noUnusedParameters": false,
21 |     "noImplicitAny": false,
22 |     "noFallthroughCasesInSwitch": false,
23 | 
24 |     "baseUrl": ".",
25 |     "paths": {
26 |       "@/*": ["./src/*"]
27 |     }
28 |   },
29 |   "include": ["src"]
30 | }
```

tsconfig.json
```
1 | {
2 |   "files": [],
3 |   "references": [
4 |     { "path": "./tsconfig.app.json" },
5 |     { "path": "./tsconfig.node.json" }
6 |   ],
7 |   "compilerOptions": {
8 |     "baseUrl": ".",
9 |     "paths": {
10 |       "@/*": ["./src/*"]
11 |     },
12 |     "noImplicitAny": false,
13 |     "noUnusedParameters": false,
14 |     "skipLibCheck": true,
15 |     "allowJs": true,
16 |     "noUnusedLocals": false,
17 |     "strictNullChecks": false
18 |   }
19 | }
```

tsconfig.node.json
```
1 | {
2 |   "compilerOptions": {
3 |     "target": "ES2022",
4 |     "lib": ["ES2023"],
5 |     "module": "ESNext",
6 |     "skipLibCheck": true,
7 | 
8 |     /* Bundler mode */
9 |     "moduleResolution": "bundler",
10 |     "allowImportingTsExtensions": true,
11 |     "isolatedModules": true,
12 |     "moduleDetection": "force",
13 |     "noEmit": true,
14 | 
15 |     /* Linting */
16 |     "strict": true,
17 |     "noUnusedLocals": false,
18 |     "noUnusedParameters": false,
19 |     "noFallthroughCasesInSwitch": true
20 |   },
21 |   "include": ["vite.config.ts"]
22 | }
```

vite.config.ts
```
1 | import { defineConfig, loadEnv } from "vite";
2 | import react from "@vitejs/plugin-react-swc";
3 | import path from "path";
4 | import { componentTagger } from "lovable-tagger";
5 | 
6 | // https://vitejs.dev/config/
7 | export default defineConfig(({ mode }) => {
8 |   // Cargar variables de entorno
9 |   const env = loadEnv(mode, process.cwd(), '');
10 |   
11 |   return {
12 |     server: {
13 |       host: "::",
14 |       port: 8080,
15 |     },
16 |     plugins: [
17 |       react(),
18 |       mode === 'development' &&
19 |       componentTagger(),
20 |     ].filter(Boolean),
21 |     resolve: {
22 |       alias: {
23 |         "@": path.resolve(__dirname, "./src"),
24 |       },
25 |     },
26 |     envDir: './',
27 |     envPrefix: 'VITE_',
28 |     define: {
29 |       'process.env.VITE_ELEVENLABS_API_KEY': JSON.stringify(env.VITE_ELEVENLABS_API_KEY),
30 |     }
31 |   };
32 | });
```

.claude/settings.local.json
```
1 | {
2 |   "permissions": {
3 |     "allow": [
4 |       "Bash(mkdir:*)",
5 |       "Bash(cp:*)"
6 |     ],
7 |     "deny": []
8 |   }
9 | }
```

docs/EDGE_FUNCTIONS.md
```
1 | # Edge Functions de TaleMe!
2 | 
3 | Este documento describe las Edge Functions implementadas en Supabase para
4 | manejar la generación de contenido utilizando modelos de lenguaje.
5 | 
6 | ## Descripción General
7 | 
8 | Se han implementado las siguientes Edge Functions:
9 | 
10 | 1. **generate-story**: Genera historias personalizadas basadas en las opciones
11 |    proporcionadas.
12 | 2. **challenge**: Crea desafíos educativos basados en historias.
13 | 3. **story-continuation**: Genera continuaciones para historias existentes.
14 | 
15 | Estas funciones utilizan el modelo de lenguaje
16 | **gemini-2.0-flash-thinking-exp-01-21** de Google para generar contenido de alta
17 | calidad, permitiendo:
18 | 
19 | - Mantener las claves API seguras en el servidor.
20 | - Reducir la carga en el dispositivo del cliente.
21 | - Centralizar la lógica de generación de contenido.
22 | - Mejorar la seguridad y el rendimiento.
23 | 
24 | ## Configuración
25 | 
26 | Las funciones utilizan las siguientes variables de entorno:
27 | 
28 | - `GEMINI_API_KEY`: Clave para acceder a la API de Gemini de Google.
29 | 
30 | Para configurar las variables de entorno en Supabase:
31 | 
32 | ```bash
33 | supabase secrets set GEMINI_API_KEY="tu-clave-api"
34 | ```
35 | 
36 | ## Funciones Disponibles
37 | 
38 | ### generate-story
39 | 
40 | Genera una historia infantil personalizada basada en las opciones
41 | proporcionadas.
42 | 
43 | #### Parámetros de Entrada (Request Payload):
44 | 
45 | ```json
46 | {
47 |     "options": { // Opciones de la historia
48 |         "character": { // Detalles del personaje principal
49 |             "name": "Nombre del personaje",
50 |             "profession": "Profesión",
51 |             "hobbies": ["Afición 1", "Afición 2"],
52 |             "characterType": "Tipo de personaje (ej. Animal, Humano)",
53 |             "personality": "Personalidad (ej. Valiente, Tímido)"
54 |         },
55 |         "genre": "Género de la historia (ej. Aventura, Fantasía)",
56 |         "moral": "Enseñanza o moraleja",
57 |         "duration": "short|medium|long" // Duración deseada
58 |     },
59 |     "language": "español", // Idioma deseado para la historia
60 |     "childAge": 7, // Edad del niño/a para adaptar el lenguaje y contenido
61 |     "specialNeed": "Ninguna|TEA|TDAH|Dislexia|Ansiedad|Down|Comprension", // Necesidad especial para adaptar la historia
62 |     "additionalDetails": "Texto libre con detalles adicionales para la historia" // Opcional
63 | }
64 | ```
65 | 
66 | #### Respuesta Exitosa (Success Response):
67 | 
68 | ```json
69 | {
70 |     "title": "Título Atractivo Generado por la IA",
71 |     "content": "Texto completo de la historia generada..."
72 | }
73 | ```
74 | 
75 | #### Respuesta de Error (Error Response):
76 | 
77 | ```json
78 | {
79 |     "error": "Mensaje descriptivo del error"
80 | }
81 | ```
82 | 
83 | #### Flujo de Implementación Interna:
84 | 
85 | 1.  **Recepción y Validación:** La función recibe el payload JSON. Se valida la presencia de los campos requeridos (`options`).
86 | 2.  **Construcción del Prompt:**
87 |     *   Se crea un **prompt de sistema** que instruye a la IA sobre su rol (generador de cuentos infantiles), el formato de salida esperado (JSON con `title` y `content`), y las restricciones generales (tono, longitud, creatividad para el título).
88 |     *   Se crea un **prompt de usuario** detallado que incluye:
89 |         *   Todas las `options` proporcionadas (personaje, género, moraleja, duración).
90 |         *   El `language` solicitado.
91 |         *   La `childAge`, indicando a la IA que adapte el lenguaje y la complejidad.
92 |         *   La `specialNeed`, instruyendo a la IA para que considere sensibilidades o temas específicos si es relevante (evitando estereotipos).
93 |         *   Los `additionalDetails` si se proporcionan.
94 | 3.  **Llamada a la API de Gemini:** Se utiliza el cliente `@google/generative-ai` para enviar ambos prompts (sistema y usuario) al modelo Gemini configurado. Se especifica que la respuesta debe ser en formato JSON.
95 | 4.  **Procesamiento de la Respuesta:**
96 |     *   Se intenta parsear la respuesta JSON recibida de Gemini.
97 |     *   Se extraen los campos `title` y `content`.
98 |     *   Se realiza una limpieza básica (ej. eliminar posibles bloques de código markdown alrededor del JSON).
99 |     *   Se valida que `title` y `content` no estén vacíos.
100 | 5.  **Retorno:** Se devuelve un objeto JSON con `title` y `content` si todo fue exitoso, o un objeto con `error` si ocurrió algún problema.
101 | 
102 | #### Depuración y Problemas Anteriores:
103 | 
104 | *   **Problema Inicial:** Durante el desarrollo, se detectó que los parámetros `childAge` y `specialNeed` no llegaban correctamente a la Edge Function, resultando en `null` o valores por defecto, aunque el parámetro `language` sí se recibía bien.
105 | *   **Diagnóstico:** La investigación reveló que el error no estaba en la Edge Function en sí, sino en el flujo de datos del lado del cliente antes de invocar la función. Específicamente, la lógica para guardar la configuración del perfil del usuario en la base de datos no persistía correctamente estos campos.
106 | *   **Causa Raíz (Cliente):** La función `syncUserProfile` en `src/services/supabase.ts` recibía los datos mapeados desde `userStore` (con nombres de columna como `child_age`, `special_need`), pero intentaba acceder a ellos usando los nombres de propiedad originales de TypeScript (`profileSettings.childAge`, `profileSettings.specialNeed`), los cuales eran `undefined` en ese contexto. Esto causaba que se guardaran `null` o valores incorrectos en la base de datos.
107 | *   **Solución (Cliente):** Se corrigió `syncUserProfile` para que utilizara directamente el objeto de datos mapeado (`dataToSync`) al preparar el objeto para la operación `upsert` de Supabase, asegurando que los nombres de columna correctos (`child_age`, `special_need`) se usaran con los valores correctos.
108 | *   **Impacto en la Edge Function:** Una vez corregido el guardado en el cliente, la Edge Function comenzó a recibir los valores correctos para `childAge` y `specialNeed`, permitiéndole adaptar la generación de historias según lo previsto.
109 | 
110 | ### challenge
111 | 
112 | Genera desafíos educativos basados en historias.
113 | 
114 | #### Acción: createChallenge
115 | 
116 | ##### Solicitud:
117 | 
118 | ```json
119 | {
120 |     "action": "createChallenge",
121 |     "story": {
122 |         "id": "id-de-la-historia",
123 |         "title": "Título de la historia",
124 |         "content": "Contenido completo de la historia...",
125 |         "options": {
126 |             "character": {
127 |                 "id": "id-del-personaje",
128 |                 "name": "Nombre del personaje",
129 |                 "profession": "Profesión",
130 |                 "characterType": "Tipo de personaje",
131 |                 "hobbies": ["Afición 1", "Afición 2"],
132 |                 "personality": "Personalidad"
133 |             },
134 |             "genre": "Género de la historia",
135 |             "moral": "Enseñanza o moraleja",
136 |             "duration": "short|medium|long"
137 |         }
138 |     },
139 |     "category": "language|math|comprehension",
140 |     "profileSettings": {
141 |         "childAge": 7,
142 |         "specialNeed": "Ninguna|TEA|TDAH|Dislexia",
143 |         "language": "es"
144 |     },
145 |     "targetLanguage": "en" // Solo para desafíos de idiomas
146 | }
147 | ```
148 | 
149 | ##### Respuesta:
150 | 
151 | ```json
152 | {
153 |     "id": "id-del-desafío",
154 |     "storyId": "id-de-la-historia",
155 |     "questions": [
156 |         {
157 |             "id": "id-de-la-pregunta",
158 |             "category": "language|math|comprehension",
159 |             "question": "Texto de la pregunta",
160 |             "options": ["Opción 1", "Opción 2", "Opción 3", "Opción 4"],
161 |             "correctOptionIndex": 0,
162 |             "explanation": "Explicación de la respuesta correcta",
163 |             "targetLanguage": "en" // Solo para desafíos de idiomas
164 |         }
165 |     ],
166 |     "createdAt": "2023-01-01T00:00:00.000Z"
167 | }
168 | ```
169 | 
170 | #### Acción: getLanguages
171 | 
172 | ##### Solicitud:
173 | 
174 | ```json
175 | {
176 |     "action": "getLanguages",
177 |     "profileSettings": {
178 |         "language": "es"
179 |     }
180 | }
181 | ```
182 | 
183 | ##### Respuesta:
184 | 
185 | ```json
186 | {
187 |     "languages": [
188 |         { "code": "en", "name": "Inglés" },
189 |         { "code": "fr", "name": "Francés" }
190 |         // Otros idiomas...
191 |     ]
192 | }
193 | ```
194 | 
195 | ### story-continuation
196 | 
197 | Genera continuaciones para historias existentes.
198 | 
199 | #### Lógica de Límites (Usuarios Gratuitos)
200 | 
201 | -   Un usuario gratuito puede generar **una continuación** por cada historia creada.
202 | -   Esto significa que una historia gratuita puede tener un máximo de **dos capítulos**: el capítulo inicial generado con `generate-story` y una continuación generada a través de esta función (`story-continuation`).
203 | -   La función verifica el número de capítulos existentes para la historia *antes* de generar una continuación (`optionContinuation`, `directedContinuation`, `freeContinuation`).
204 | -   Si el usuario es gratuito y la historia ya tiene 2 o más capítulos, la función devolverá un error `403 Forbidden` indicando que se ha alcanzado el límite.
205 | -   La acción `generateOptions` no está sujeta a este límite, ya que solo sugiere posibles caminos.
206 | 
207 | #### Acción: generateOptions
208 | 
209 | ##### Solicitud:
210 | 
211 | ```json
212 | {
213 |     "action": "generateOptions",
214 |     "story": {
215 |         "id": "id-de-la-historia",
216 |         "title": "Título de la historia",
217 |         "content": "Contenido principal de la historia...",
218 |         "options": {
219 |             "character": {/* datos del personaje */},
220 |             "genre": "Género de la historia",
221 |             "moral": "Enseñanza o moraleja",
222 |             "duration": "short|medium|long"
223 |         }
224 |     },
225 |     "chapters": [
226 |         {
227 |             "id": "id-del-capítulo",
228 |             "storyId": "id-de-la-historia",
229 |             "title": "Título del capítulo",
230 |             "content": "Contenido del capítulo...",
231 |             "order": 1,
232 |             "createdAt": "2023-01-01T00:00:00.000Z"
233 |         }
234 |         // Más capítulos si existen...
235 |     ]
236 | }
237 | ```
238 | 
239 | ##### Respuesta:
240 | 
241 | ```json
242 | {
243 |     "options": [
244 |         { "summary": "Buscar el tesoro escondido en el bosque." },
245 |         { "summary": "Hablar con el misterioso anciano del pueblo." },
246 |         { "summary": "Seguir el camino hacia las montañas nevadas." }
247 |     ]
248 | }
249 | ```
250 | 
251 | #### Acción: freeContinuation, optionContinuation, directedContinuation
252 | 
253 | Todos estos endpoints tienen estructuras similares, variando según el tipo de
254 | continuación.
255 | 
256 | ##### Respuesta para todas las acciones de continuación:
257 | 
258 | ```json
259 | {
260 |     "content": "Texto completo de la continuación generada..."
261 | }
262 | ```
263 | 
264 | #### Acción: generateTitle
265 | 
266 | ##### Solicitud:
267 | 
268 | ```json
269 | {
270 |     "action": "generateTitle",
271 |     "content": "Contenido del capítulo para el cual se generará un título..."
272 | }
273 | ```
274 | 
275 | ##### Respuesta:
276 | 
277 | ```json
278 | {
279 |     "title": "Título generado para el capítulo"
280 | }
281 | ```
282 | 
283 | ## Beneficios de la Migración a Edge Functions
284 | 
285 | 1. **Seguridad**: Las claves API se almacenan de forma segura en el servidor y
286 |    no se exponen al cliente.
287 | 2. **Rendimiento**: La generación de contenido se realiza en el servidor,
288 |    reduciendo la carga en el dispositivo del cliente.
289 | 3. **Mantenibilidad**: La lógica de generación está centralizada y es más fácil
290 |    de mantener y actualizar.
291 | 4. **Escalabilidad**: Las Edge Functions pueden escalar automáticamente según la
292 |    demanda.
293 | 
294 | ## Próximos Pasos
295 | 
296 | Considerar la migración de los siguientes servicios a Edge Functions:
297 | 
298 | 1. **syncService**: Para sincronización de datos con la base de datos.
299 | 2. **Otros servicios** que requieran acceso a APIs externas o procesamiento
300 |    intensivo.
```

docs/PAUTAS_DE_DISENO.md
```
1 | # Pautas de Diseño UI/UX – TaleMe
2 | 
3 | ## ⚠️ DISCLAIMER IMPORTANTE: PRESERVACIÓN DE FUNCIONALIDAD
4 | 
5 | **EXTREMADAMENTE IMPORTANTE: Al aplicar estas pautas de diseño, NUNCA se debe alterar la funcionalidad existente.**
6 | 
7 | - **Mantener toda la lógica intacta:** Al rediseñar componentes, solo modificar aspectos visuales (colores, espaciado, tipografía, etc.).
8 | - **No eliminar ni añadir botones:** La cantidad y tipo de elementos interactivos debe permanecer exactamente igual.
9 | - **Preservar todos los estados:** Asegurarse de que estados como hover, active, disabled, loading, etc. sigan funcionando correctamente.
10 | - **No modificar manejadores de eventos:** Las funciones onClick, onChange y similares deben permanecer intactas.
11 | - **Mantener la estructura de datos:** No alterar la forma en que se almacenan o procesan los datos.
12 | - **Respetar los permisos y restricciones:** Los bloqueos para usuarios free/premium deben seguir funcionando igual.
13 | 
14 | El objetivo es **ÚNICAMENTE mejorar la apariencia visual** manteniendo toda la funcionalidad existente. Cualquier cambio que afecte el comportamiento de la aplicación está estrictamente prohibido.
15 | 
16 | ## 1. Identidad Visual
17 | - **Logotipo:** Utiliza siempre el logotipo oficial en sus variantes de color y fondo según el manual de marca.
18 | - **Iconografía:** Usa los iconos oficiales de TaleMe, preferiblemente en formato SVG o PNG de alta calidad.
19 | 
20 | ## 2. Paleta de Colores
21 | Utiliza la paleta oficial para todos los elementos de la interfaz:
22 | - **Rosa:** #F6A5B7  (principal, botones primarios)
23 | - **Morado:** #BB79D1  (acentos, fondos suaves)
24 | - **Celeste:** #A5D6F6  (botones secundarios, fondos)
25 | - **Amarillo:** #F9DA60  (acentos, detalles)
26 | - **Lavanda:** #E6B7D9  (fondos suaves, tarjetas)
27 | - **Azul Claro:** #7DC4E0  (fondos, detalles)
28 | 
29 | ## 3. Tipografía
30 | - **Principal (encabezados):** Quicksand, bold y semibold.
31 | - **Secundaria (texto):** Open Sans, regular y semibold.
32 | - **Tamaños:**
33 |   - Títulos: grandes y llamativos.
34 |   - Botones: medianos, legibles y en mayúsculas si aplica.
35 | 
36 | ## 4. Estilo Visual
37 | - **Fondo:** Gradientes pastel, nubes y estrellas decorativas (preferentemente SVG o PNG).
38 | - **Botones:**
39 |   - Grandes, redondeados (`border-radius: 24px` o más).
40 |   - Colores sólidos de la paleta, texto blanco.
41 |   - Sombra suave y efecto hover.
42 | - **Componentes:**
43 |   - Bordes suaves y esquinas redondeadas.
44 |   - Espaciado generoso y aireado.
45 | 
46 | ## 5. Uso de Imágenes y Decoraciones
47 | - **Logo y fondo:** Siempre centrados, con espacio suficiente.
48 | - **Ilustraciones:** Usa las oficiales del manual de marca.
49 | - **No sobrecargar:** Mantén la interfaz limpia y amigable.
50 | 
51 | ## 6. Accesibilidad
52 | - Contraste suficiente entre texto y fondo.
53 | - Botones grandes y fácilmente tocables.
54 | - Texto legible y jerarquías claras.
55 | 
56 | ## 7. Tono y Estilo de Comunicación
57 | - Moderno, amigable, imaginativo.
58 | - Mensajes claros, positivos y cercanos.
59 | 
60 | ## 8. Distribución del Espacio
61 | - **Agrupación de elementos:** Mantén juntos los elementos relacionados.
62 | - **Espaciado vertical:** 
63 |   - Reduce espacios entre logo y contenido principal (usar `mt-4 mb-0` y `py-0`).
64 |   - Asegura suficiente espacio entre el contenido y el borde inferior (usar `mb-10` para botones inferiores).
65 | - **Estructura de página:** Usa contenedores flex con `min-h-[80vh]` y `justify-between` para distribuir el espacio.
66 | - **Jerarquía visual:** Elementos importantes más grandes y con mayor contraste.
67 | 
68 | ## 9. Preservación de Funcionalidad
69 | - **⚠️ EXTREMADAMENTE IMPORTANTE: Nunca eliminar botones ni cambiar funcionalidades existentes.**
70 | - Todos los botones y elementos interactivos deben preservarse en el rediseño.
71 | - Si un botón existe en la versión original, debe existir en la versión rediseñada.
72 | - Mantener la misma navegación y flujos de usuario que en la versión original.
73 | - Solo se permite mejorar el aspecto visual, no modificar comportamientos.
74 | 
75 | ## 10. Legibilidad
76 | - Usar fondos con opacidad adecuada (40-50% para fondos de tarjetas).
77 | - Texto principal en colores oscuros de la paleta (#BB79D1).
78 | - Texto secundario en colores contrastantes (#7DC4E0).
79 | - Usar `font-bold` para elementos importantes y `font-medium` para mejorar legibilidad.
80 | 
81 | ## 11. Legibilidad y Uso de Colores en Texto
82 | - **Regla general:** Siempre prioriza el contraste entre texto y fondo para garantizar la legibilidad.
83 | 
84 | ### Cuándo usar cada color:
85 | - **Texto principal en tarjetas o bloques claros (fondos blancos, lavanda, pastel):**
86 |   - Usa **gris oscuro** (`#222` o `#333`) para el texto principal. Esto asegura máxima legibilidad en fondos claros/pastel.
87 |   - Ejemplo: títulos, frases clave, información principal.
88 | - **Números, datos clave o acentos:**
89 |   - Usa colores de la paleta para resaltar: rosa (`#F6A5B7`), amarillo (`#F9DA60`), azul claro (`#7DC4E0`), morado (`#BB79D1`).
90 |   - Ejemplo: “8 / 10”, precios, alertas.
91 | - **Iconos:**
92 |   - Usa el color corporativo correspondiente según el contexto (ej. morado para elementos generales, azul para info, rosa para acciones, amarillo para alertas positivas).
93 | - **Texto secundario o descripciones:**
94 |   - Usa azul claro (`#7DC4E0`) o morado claro, siempre que el fondo sea suficientemente claro.
95 | 
96 | ### Fondos:
97 | - **Tarjetas y bloques de información:**
98 |   - Usa fondo blanco translúcido (`bg-white/70` o `#fff9`), lavanda muy clara o pastel con suficiente opacidad.
99 |   - Nunca uses fondo morado medio con texto morado o azul claro encima.
100 |   - Si el fondo es pastel/morado claro y el texto no se lee bien, sube la opacidad del fondo o cambia el texto a gris oscuro.
101 | 
102 | ### Reglas de contraste:
103 | - **No usar negro puro** (`#000`) salvo casos extremos de accesibilidad. Prefiere gris oscuro.
104 | - **Evita morado sobre morado y azul sobre morado claro**: el contraste es insuficiente.
105 | - **Para alertas o mensajes críticos:**
106 |   - Usa fondo claro y texto oscuro o viceversa, nunca dos colores de baja diferencia de luminosidad.
107 | 
108 | ### Sombra de texto:
109 | - Puedes añadir `text-shadow: 0 1px 4px rgba(187, 121, 209, 0.15);` para separar el texto del fondo en fondos translúcidos o pastel.
110 | 
111 | ### Resumen de buenas prácticas:
112 | - Texto principal: gris oscuro (`#222`), nunca morado/azul claro sobre pastel/morado claro.
113 | - Números/acento: color de la paleta.
114 | - Iconos: color de la paleta según contexto.
115 | - Fondos: blanco translúcido, pastel claro, suficiente opacidad.
116 | - Sombra de texto para mejorar legibilidad si es necesario.
117 | 
118 | ## 12. Consistencia Visual y Matices Aprendidos
119 | 
120 | ### Fondo general de la aplicación
121 | - **Siempre usar el mismo fondo:** Utiliza `public/fondo_png.png` en todas las pantallas principales.
122 | - **Modo de aplicación:** Aplica el fondo usando `style` con las siguientes propiedades para evitar zoom excesivo o repetición:
123 |   ```jsx
124 |   style={{
125 |     backgroundImage: 'url(/fondo_png.png)',
126 |     backgroundSize: 'cover',
127 |     backgroundPosition: 'center',
128 |     backgroundRepeat: 'no-repeat',
129 |   }}
130 |   ```
131 | - **No uses clases como `bg-cover` si no garantizan el mismo comportamiento cross-browser.**
132 | 
133 | ### Tarjetas y bloques de información
134 | - **Fondo:** Usa `bg-white/40` (blanco translúcido) para tarjetas y bloques principales, con `rounded-3xl`, borde pastel (`border-[#BB79D1]/20`) y sombra suave.
135 | - **No uses blanco sólido salvo en menús desplegables o casos de legibilidad crítica.**
136 | - **No uses translúcido en dropdowns:** Los menús desplegables deben ser `bg-white` sólido para máxima legibilidad.
137 | 
138 | ### Menús desplegables (selects)
139 | - **Fondo:** `bg-white` sólido, nunca translúcido.
140 | - **Borde:** Pastel (`border-[#BB79D1]/40`), sombra y esquinas redondeadas.
141 | - **Texto:** Siempre oscuro (`#222`).
142 | - **Focus:** Fondo morado translúcido suave (`focus:bg-[#BB79D1]/20`).
143 | 
144 | ### Consistencia de colores para cada elemento
145 | - **Texto principal:** Gris oscuro (`#222` o `#333`) en tarjetas, formularios y menús.
146 | - **Números/acento:** Usa la paleta oficial:
147 |   - Rosa (`#F6A5B7`): para cantidades, estados destacados.
148 |   - Amarillo (`#F9DA60`): para edades, avisos positivos.
149 |   - Azul claro (`#7DC4E0`): para descripciones, textos secundarios.
150 |   - Morado (`#BB79D1`): para títulos, iconos principales y acentos.
151 | - **Iconos:** Color de la paleta según contexto (ejemplo: azul para info, rosa para acciones, amarillo para alertas, morado para elementos generales).
152 | 
153 | ### Legibilidad y contraste
154 | - **Nunca uses texto morado o azul claro sobre fondo morado claro o pastel:** El contraste es insuficiente.
155 | - **No uses negro puro:** Prefiere gris oscuro.
156 | - **En menús y tarjetas, prioriza la legibilidad sobre la estética pastel.**
157 | 
158 | ### Resumen de buenas prácticas
159 | - Fondo uniforme y sin zoom excesivo.
160 | - Tarjetas translúcidas, menús sólidos.
161 | - Colores coherentes para cada tipo de elemento.
162 | - Máxima legibilidad en todos los contextos.
163 | 
164 | ## 13. Patrones de Diseño Específicos
165 | 
166 | ### Fondos y Contenedores
167 | 
168 | #### Fondo Principal
169 | - **Cuándo usar**: En todas las pantallas principales de la aplicación.
170 | - **Implementación**: 
171 |   ```jsx
172 |   style={{
173 |     backgroundImage: 'url(/fondo_png.png)',
174 |     backgroundSize: 'cover',
175 |     backgroundPosition: 'center',
176 |     backgroundRepeat: 'no-repeat',
177 |   }}
178 |   ```
179 | - **Razón**: Proporciona una identidad visual consistente y un ambiente acogedor para la aplicación de cuentos.
180 | 
181 | #### Contenedores de Información
182 | - **Cuándo usar**: Para agrupar información relacionada (textos explicativos, preguntas).
183 | - **Implementación**: Fondo blanco con opacidad 70-80% (`bg-white/70` o `bg-white/80`), bordes redondeados (`rounded-xl`), sombra suave.
184 | - **Razón**: Mejora la legibilidad del texto sobre el fondo decorativo, manteniendo la estética general.
185 | 
186 | ### Tarjetas de Selección
187 | 
188 | #### Estilo Base
189 | - **Implementación**: 
190 |   - Fondo blanco con opacidad 70% (`bg-white/70`)
191 |   - Bordes redondeados amplios (`rounded-2xl`)
192 |   - Bordes coloreados según su contenido (`border-2 border-[#COLOR]/60`)
193 |   - Sombra suave para elevación visual
194 |   - Transiciones suaves para interacciones
195 | 
196 | #### Estados Interactivos
197 | - **Normal**: Fondo blanco translúcido, icono colorido, texto oscuro para máxima legibilidad.
198 | - **Hover**: Ligero tinte del color temático (`hover:bg-[#COLOR]/10`), aumento de escala (`hover:scale-105`), sombra mejorada.
199 | - **Seleccionado**: Anillo de color destacado (`ring-4 ring-[#COLOR]`), sombra más prominente, escala ligeramente aumentada.
200 | 
201 | ### Código de Colores Funcionales
202 | 
203 | - **Rosa (#F6A5B7)**: Para elementos primarios, acciones principales, duración corta.
204 | - **Amarillo (#F9DA60)**: Para alertas positivas, elementos medios, duración media.
205 | - **Azul Claro (#7DC4E0)**: Para información, elementos secundarios, duración larga.
206 | - **Morado (#BB79D1)**: Para navegación, títulos, botones de avance en el flujo.
207 | 
208 | ### Botones de Acción
209 | 
210 | #### Botones Principales (como "Continuar")
211 | - **Implementación**: 
212 |   ```jsx
213 |   <div className="flex justify-center w-full">
214 |     <button className="w-full max-w-xs py-4 rounded-2xl text-white text-lg font-semibold 
215 |                       shadow-lg bg-[#BB79D1] hover:bg-[#BB79D1]/90 
216 |                       border-2 border-[#BB79D1]/50 transition-all duration-200">
217 |       Texto del botón
218 |     </button>
219 |   </div>
220 |   ```
221 | - **Razón**: Destacan visualmente como puntos de acción principales, manteniendo coherencia con el flujo de la aplicación.
222 | 
223 | #### Botón de Retroceso
224 | - **Implementación**: 
225 |   ```jsx
226 |   <button className="absolute top-6 left-6 w-12 h-12 flex items-center justify-center 
227 |                     rounded-full bg-white shadow-lg border-2 border-[#BB79D1]/60 
228 |                     text-[#BB79D1] hover:bg-[#BB79D1]/10 hover:text-[#7DC4E0] 
229 |                     focus:ring-4 focus:ring-[#BB79D1]/30 transition-all duration-300 z-20">
230 |     <ChevronLeft size={28} />
231 |   </button>
232 |   ```
233 | - **Razón**: Proporciona una forma consistente de navegación hacia atrás sin competir visualmente con el contenido principal.
234 | 
235 | ### Consideraciones para Pantallas de Selección
236 | 
237 | 1. **Uso de colores diferenciados por opción**: Cada opción debe tener su propio color de la paleta para crear asociación visual y facilitar la identificación.
238 | 
239 | 2. **Mayor opacidad en fondos de tarjetas** (70% en lugar de 40%): Mejora significativamente la legibilidad del texto mientras mantiene la estética translúcida.
240 | 
241 | 3. **Texto oscuro en lugar de blanco para tarjetas**: Siguiendo las pautas de legibilidad, el texto oscuro (`text-[#222]`) sobre fondo claro proporciona mejor contraste.
242 | 
243 | 4. **Estados visuales claros**: Los estados normal, hover y seleccionado deben tener diferencias visuales significativas pero coherentes.
244 | 
245 | 5. **Botones de acción centrados y con ancho controlado**: Seguir el patrón de los botones principales de la Home, creando consistencia en la experiencia de usuario.
246 | 
247 | ---
248 | 
249 | _Última actualización: 17 de abril de 2025_
250 | 
251 | ---
252 | 
253 | **Referencia:**
254 | Estas pautas se basan en el manual de marca oficial de TaleMe (ver imágenes adjuntas en docs/manual_marca.png o docs/manual_marca.pdf si están disponibles).
255 | 
256 | ---
257 | 
258 | _Actualiza este documento si el manual de marca evoluciona o hay nuevas directrices de diseño._
```

docs/Stripe_integration.md
```
1 | # Guía Detallada: Integración de Stripe en Web App con Supabase (Cuenta Cuentos)
2 | 
3 | **Documento creado para:**
4 | 
5 | *   Servir como referencia detallada del proceso de integración de Stripe.
6 | *   Facilitar la consulta y resolución de dudas sobre la implementación.
7 | *   Proporcionar una guía paso a paso para la futura implementación de Stripe en aplicaciones similares.
8 | 
9 | **Versión:** 1.1 (Actualizado para reflejar manejo de creación de personajes sin límite)
10 | **Fecha:** 2024-04-03
11 | 
12 | ---
13 | 
14 | ## 1. Introducción
15 | 
16 | Este documento describe el proceso completo para integrar **Stripe** como pasarela de pagos en una aplicación web (Cuenta Cuentos) que utiliza **Supabase** como backend y **Vite** como framework frontend. La integración permite:
17 | 
18 | *   **Suscripción Premium:** Venta de un plan de suscripción mensual recurrente.
19 | *   **Compra de Créditos:** Venta de paquetes de créditos de voz (pago único).
20 | *   **Gestión de Suscripción:** Permite a los usuarios gestionar sus suscripciones (cancelar, actualizar método de pago) a través del **Stripe Customer Portal**.
21 | 
22 | La implementación se basa en **Stripe Checkout**, **Supabase Edge Functions** para la lógica segura del backend y **Stripe Webhooks** para mantener la sincronización del estado.
23 | 
24 | ---
25 | 
26 | ## 2. Prerrequisitos
27 | 
28 | *   **Cuenta de Stripe:** Activa ([https://stripe.com/](https://stripe.com)). Usar **modo de prueba** durante el desarrollo.
29 | *   **Proyecto Supabase:** Funcional (Base de datos, Auth, Edge Functions habilitadas).
30 | *   **CLI de Supabase:** Instalada y configurada.
31 | *   **CLI de Stripe (Opcional):** Útil para pruebas básicas.
32 | *   **Entorno Frontend:** Configurado (Vite).
33 | *   **Variables de Entorno/Secretos de Supabase Configurados:** (Ver paso 3.2).
34 | 
35 | ---
36 | 
37 | ## 3. Configuración Inicial
38 | 
39 | ### 3.1. Configuración de Productos y Precios en Stripe
40 | 
41 | 1.  **Accede al Dashboard de Stripe** (modo de prueba).
42 | 2.  **Crea Productos:**
43 |     *   Navega a "Productos" > "Catálogo de productos" > "+ Añadir producto".
44 |     *   **Producto 1: Suscripción Premium**
45 |         *   Nombre: "Plan Premium Cuenta Cuentos"
46 |         *   Modelo: "Periódico", Mensual, Precio (ej. 10 USD).
47 |         *   Guarda. Anota **ID Producto (`prod_...`)** y **ID Precio (`price_...`)**.
48 |     *   **Producto 2: Créditos de Voz**
49 |         *   Nombre: "Paquete Créditos de Voz"
50 |         *   Modelo: "Pago único", Precio (ej. 5 USD).
51 |         *   Guarda. Anota **ID Producto (`prod_...`)** y **ID Precio (`price_...`)**.
52 | 
53 | ### 3.2. Configuración de Secretos en Supabase
54 | 
55 | Usa la CLI de Supabase (`supabase secrets set <NOMBRE>=<VALOR>`):
56 | 
57 | ```bash
58 | # Clave secreta de Stripe
59 | supabase secrets set STRIPE_SECRET_KEY=sk_test_xxxxxxxxxxxx
60 | 
61 | # Clave publicable de Stripe (Prefijo VITE_ para Vite)
62 | supabase secrets set VITE_STRIPE_PUBLISHABLE_KEY=pk_test_zzzzzzzzzzzz
63 | 
64 | # ID del Precio del Plan Premium
65 | supabase secrets set PREMIUM_PLAN_PRICE_ID=price_12345abcdefg
66 | 
67 | # ID del Precio de los Créditos de Voz
68 | supabase secrets set VOICE_CREDITS_PRICE_ID=price_67890hijklmn
69 | 
70 | # URL base de tu app frontend (Ajusta para producción)
71 | supabase secrets set APP_BASE_URL=http://localhost:8080
72 | 
73 | # Clave Service Role de Supabase (Usa nombre personalizado)
74 | supabase secrets set APP_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR.......
75 | 
76 | # Secreto de Firma de Webhooks (Obtenido más tarde de Stripe)
77 | supabase secrets set STRIPE_SIGNING_SECRET=whsec_yyyyyyyyyyyy_TEMPORAL
78 | ```
79 | 
80 | ### 3.3. Configuración de la Base de Datos (profiles)
81 | 
82 | Asegura que la tabla public.profiles (vinculada a auth.users.id) contenga los campos necesarios.
83 | 
84 | Código SQL para definir/modificar tabla profiles (SQL Editor de Supabase):
85 | 
86 | ```sql
87 | -- Añadir o asegurar columnas para Stripe y límites de la app
88 | ALTER TABLE public.profiles
89 | ADD COLUMN IF NOT EXISTS stripe_customer_id TEXT UNIQUE,
90 | ADD COLUMN IF NOT EXISTS subscription_id TEXT UNIQUE,
91 | ADD COLUMN IF NOT EXISTS subscription_status TEXT,
92 | ADD COLUMN IF NOT EXISTS plan_id TEXT,
93 | ADD COLUMN IF NOT EXISTS current_period_end TIMESTAMPTZ,
94 | ADD COLUMN IF NOT EXISTS voice_credits INT4 DEFAULT 0,
95 | ADD COLUMN IF NOT EXISTS monthly_stories_generated INT4 DEFAULT 0,
96 | ADD COLUMN IF NOT EXISTS last_story_reset_date TIMESTAMPTZ;
97 | 
98 | -- Hacer columnas NULLables si se establecen después del registro
99 | ALTER TABLE public.profiles ALTER COLUMN child_age DROP NOT NULL; -- Ejemplo
100 | ```
101 | 
102 | Función SQL RPC increment_voice_credits (SQL Editor de Supabase): (Usada por Webhook)
103 | 
104 | ```sql
105 | CREATE OR REPLACE FUNCTION increment_voice_credits(user_uuid uuid, credits_to_add integer)
106 | RETURNS void LANGUAGE plpgsql AS $$
107 | BEGIN
108 |   UPDATE public.profiles
109 |   SET voice_credits = COALESCE(voice_credits, 0) + credits_to_add
110 |   WHERE id = user_uuid;
111 | END; $$;
112 | GRANT EXECUTE ON FUNCTION public.increment_voice_credits(uuid, integer) TO service_role;
113 | ```
114 | 
115 | Funciones SQL RPC para Límites (SQL Editor de Supabase): (Usadas por Edge Functions)
116 | 
117 | ```sql
118 | -- Incrementa contador de historias (llamada desde generate-story)
119 | CREATE OR REPLACE FUNCTION increment_story_count(user_uuid UUID)
120 | RETURNS VOID LANGUAGE plpgsql AS $$
121 | BEGIN
122 |   UPDATE public.profiles
123 |   SET monthly_stories_generated = COALESCE(monthly_stories_generated, 0) + 1
124 |   WHERE id = user_uuid;
125 | END; $$;
126 | GRANT EXECUTE ON FUNCTION public.increment_story_count(UUID) TO service_role;
127 | 
128 | -- Decrementa créditos de voz (llamada desde narrate-voice)
129 | CREATE OR REPLACE FUNCTION decrement_voice_credits(user_uuid UUID)
130 | RETURNS INTEGER LANGUAGE plpgsql AS $$
131 | DECLARE updated_credits INTEGER;
132 | BEGIN
133 |   UPDATE public.profiles
134 |   SET voice_credits = voice_credits - 1
135 |   WHERE id = user_uuid AND voice_credits > 0
136 |   RETURNING voice_credits INTO updated_credits;
137 |   RETURN COALESCE(updated_credits, -1); -- -1 si no se pudo decrementar
138 | END; $$;
139 | GRANT EXECUTE ON FUNCTION public.decrement_voice_credits(UUID) TO service_role;
140 | ```
141 | 
142 | ## 4. Implementación del Backend (Supabase Edge Functions)
143 | 
144 | ### 4.1. Función: create-checkout-session
145 | 
146 | Propósito: Inicia el proceso de compra (Suscripción o Créditos).
147 | Código (supabase/functions/create-checkout-session/index.ts):
148 | (Inserta aquí el código completo y final de la función proporcionado anteriormente).
149 | Despliegue: `supabase functions deploy create-checkout-session --no-verify-jwt`
150 | 
151 | ### 4.2. Función: stripe-webhook
152 | 
153 | Propósito: Recibe eventos de Stripe y actualiza la BD Supabase.
154 | Código (supabase/functions/stripe-webhook/index.ts):
155 | (Inserta aquí el código completo y final (versión con APP_SERVICE_ROLE_KEY) proporcionado anteriormente).
156 | Despliegue: `supabase functions deploy stripe-webhook --no-verify-jwt`
157 | Configuración del Endpoint en Stripe: (Realizar DESPUÉS de desplegar)
158 | 
159 | Dashboard Stripe -> Desarrolladores -> Webhooks -> "+ Añadir endpoint".
160 | URL: `https://<TU_PROYECTO_REF>.supabase.co/functions/v1/stripe-webhook`
161 | Eventos: `checkout.session.completed`, `invoice.paid`, `customer.subscription.updated`, `customer.subscription.deleted`.
162 | Añadir endpoint y copiar "Secreto de firma" (whsec_...).
163 | Guardar secreto en Supabase: `supabase secrets set STRIPE_SIGNING_SECRET=<SECRETO_WHSEC_REAL>`
164 | 
165 | ### 4.3. Función: create-customer-portal-session
166 | 
167 | Propósito: Genera enlace al Stripe Customer Portal para gestión de suscripción.
168 | Código (supabase/functions/create-customer-portal-session/index.ts):
169 | (Inserta aquí el código completo y final de la función proporcionado anteriormente).
170 | Despliegue: `supabase functions deploy create-customer-portal-session --no-verify-jwt`
171 | 
172 | ### 4.4. Lógica de Límites y Reset Mensual (Integrada en Funciones Existentes)
173 | 
174 | Importante: La aplicación de límites (10 historias/mes, 1 continuación gratuita, créditos de voz) y el reset mensual dinámico se integran directamente en las funciones que manejan esas acciones (ej. generate-story, continue-story, narrate-voice), no en funciones separadas.
175 | 
176 | **Generar Historia (generate-story function):**
177 | Debe incluir lógica para:
178 | - Obtener subscription_status, monthly_stories_generated, last_story_reset_date del perfil.
179 | - Reset Dinámico: Si el usuario es gratuito, comparar last_story_reset_date con la fecha actual. Si es un mes nuevo, actualizar monthly_stories_generated = 0 y last_story_reset_date ANTES de la verificación de límite.
180 | - Verificación Límite: Si es gratuito, comprobar monthly_stories_generated < 10. Si no, devolver error 429.
181 | - Actualización Post-Éxito: Si la generación es exitosa y el usuario es gratuito, llamar a supabaseAdmin.rpc('increment_story_count', { user_uuid: user.id }).
182 | (Nota: El código detallado para esta lógica se proporcionó en la conversación anterior).
183 | 
184 | **Continuar Historia (continue-story function):**
185 | Debe incluir lógica para:
186 | - Obtener subscription_status.
187 | - Obtener free_continuation_used de la tabla stories.
188 | - Verificación Límite: Si es gratuito y free_continuation_used es true, devolver error 403.
189 | - Actualización Post-Éxito: Si la continuación es exitosa y el usuario es gratuito, actualizar stories.free_continuation_used = true.
190 | (Nota: El pseudocódigo para esta lógica se proporcionó anteriormente).
191 | 
192 | **Narración de Voz (narrate-voice function):**
193 | Debe incluir lógica para:
194 | - Obtener subscription_status y voice_credits.
195 | - Verificación Límite: Si no es 'active', devolver error 403. Si voice_credits <= 0, devolver error 402.
196 | - Actualización Post-Éxito: Si la generación es exitosa, llamar a supabaseAdmin.rpc('decrement_voice_credits', { user_uuid: user.id }). Verificar que el resultado RPC no sea -1.
197 | (Nota: El pseudocódigo para esta lógica se proporcionó anteriormente).
198 | 
199 | ### 4.5. Manejo de Creación de Personajes (Sin Límite Actual)
200 | 
201 | Implementación Actual: La creación de personajes se maneja directamente desde el frontend mediante llamadas al cliente Supabase (supabase.from('characters').insert(...)). No se aplica límite entre usuarios gratuitos y premium en esta versión.
202 | 
203 | Nota de Seguridad: Este enfoque frontend es aceptable mientras no haya límites. Si se introduce un límite en el futuro (ej. 2 personajes para gratuitos), será necesario implementar una Edge Function dedicada (create-character) para aplicar el límite de forma segura en el backend.
204 | 
205 | ## 5. Configuración del Stripe Customer Portal
206 | 
207 | Dashboard Stripe -> Configuración (⚙️) -> Billing -> Customer portal.
208 | Activar y Configurar:
209 | - Actualizar suscripciones -> Cancelar suscripciones (marcar, fin de periodo).
210 | - Actualizar métodos de pago.
211 | - Ver historial de facturación.
212 | - Revisar Información del Negocio y Branding.
213 | - URL de Redirección Predeterminada: http://localhost:8080/profile (Ajustar para producción).
214 | - Guardar cambios.
215 | 
216 | ## 6. Implementación del Frontend (Vite Ejemplo)
217 | 
218 | ### 6.1. Inicialización de Stripe.js
219 | 
220 | En tu punto de entrada JS/TS:
221 | 
222 | ```typescript
223 | import { loadStripe } from '@stripe/stripe-js';
224 | const stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY);
225 | ```
226 | 
227 | ### 6.2. Lógica para Iniciar Checkout
228 | 
229 | En el componente con botones "Suscribirse"/"Comprar Créditos":
230 | 
231 | ```typescript
232 | import { supabase } from './supabaseClient';
233 | async function redirectToCheckout(itemType: 'premium' | 'credits') {
234 |   try {
235 |     const { data, error } = await supabase.functions.invoke('create-checkout-session', { body: JSON.stringify({ item: itemType }) });
236 |     if (error) throw error;
237 |     if (data?.url) window.location.href = data.url;
238 |     else alert('Error al iniciar el pago.');
239 |   } catch (error) { console.error(error); alert('Ocurrió un error.'); }
240 | }
241 | // Asignar a botones...
242 | ```
243 | 
244 | ### 6.3. Página de Éxito (/payment-success)
245 | 
246 | Crea esta ruta/componente:
247 | 
248 | ```typescript
249 | // Ejemplo React (adaptar)
250 | import { useEffect } from 'react';
251 | import { useLocation, useNavigate } from 'react-router-dom';
252 | function PaymentSuccessPage() {
253 |   const location = useLocation(); const navigate = useNavigate();
254 |   useEffect(() => {
255 |     const sessionId = new URLSearchParams(location.search).get('session_id');
256 |     if (sessionId) alert('¡Gracias! Tu cuenta se actualizará.');
257 |     else alert('Pago procesado, revisa tu perfil.');
258 |     setTimeout(() => navigate('/profile'), 3000);
259 |   }, [location, navigate]);
260 |   return <div><h1>¡Pago Exitoso!</h1><p>Actualizando cuenta...</p></div>;
261 | }
262 | export default PaymentSuccessPage;
263 | ```
264 | 
265 | ### 6.4. Lógica para Gestionar Suscripción (Customer Portal)
266 | 
267 | En el componente con el botón "Gestionar Suscripción":
268 | 
269 | ```typescript
270 | import { supabase } from './supabaseClient';
271 | async function handleManageSubscriptionClick() {
272 |   try {
273 |     const { data: { session }, error: se } = await supabase.auth.getSession();
274 |     if (se || !session) { alert('Inicia sesión.'); return; }
275 |     const { data, error } = await supabase.functions.invoke('create-customer-portal-session');
276 |     if (error) {
277 |       if (error.context?.status === 404) alert(data?.error || 'No se encontró info de facturación.');
278 |       else throw error;
279 |     } else if (data?.url) window.location.href = data.url;
280 |     else alert('No se pudo obtener el enlace.');
281 |   } catch (err) { console.error(err); alert('Ocurrió un error.'); }
282 | }
283 | // Asignar al botón...
284 | ```
285 | 
286 | ### 6.5. Lógica para Crear Personajes
287 | 
288 | En el servicio/componente que crea personajes:
289 | 
290 | ```typescript
291 | import { supabase } from './supabaseClient';
292 | async function createCharacterDirectly(characterData: { name: string, user_id: string, /*...*/ }) {
293 |   console.log(`Inserting character directly for user ${characterData.user_id}...`);
294 |   const { data: newCharacter, error } = await supabase
295 |     .from('characters')
296 |     .insert(characterData) // Inserción directa
297 |     .select().single();
298 |   if (error) { console.error(error); throw error; }
299 |   return newCharacter;
300 | }
301 | // Llamar a esta función desde la UI
302 | ```
303 | 
304 | ## 7. Estrategia de Pruebas
305 | 
306 | - Pruebas Backend (curl): Verifica respuestas básicas de las Edge Functions desplegadas.
307 | - Pruebas End-to-End (Esencial):
308 |   - Compra: Flujo completo desde frontend (login -> comprar -> checkout Stripe prueba -> /payment-success).
309 |   - Webhook: Monitorizar logs de stripe-webhook en Supabase Dashboard.
310 |   - Base de Datos: Verificar actualizaciones en profiles (status, créditos, contadores).
311 |   - Límites: Probar generar/continuar/narrar/crear (según aplique) como usuario gratuito y premium para confirmar que los límites (o ausencia de ellos) se aplican correctamente según la lógica integrada en las funciones.
312 |   - Gestión: Flujo completo desde frontend (login -> gestionar -> portal Stripe -> cancelar -> volver). Verificar logs y BD.
313 | 
314 | ## 8. Consideraciones Adicionales
315 | 
316 | - Manejo de Errores: Refinar mensajes de error en frontend y backend.
317 | - UI Dinámica: Mostrar estado (Gratuito/Premium), créditos restantes, deshabilitar/ocultar funciones según plan.
318 | - Seguridad Producción:
319 |   - Usar claves Live de Stripe.
320 |   - Configurar webhook y secreto de firma Live.
321 |   - Restringir CORS a tu dominio de producción.
322 |   - Actualizar APP_BASE_URL.
323 | - Future Character Limits: Si se introducen límites de personajes gratuitos, implementar una Edge Function dedicada (create-character) para validación segura en backend.
324 | 
325 | Este documento actualizado refleja la estructura completa de la integración, incluyendo la decisión actual sobre la creación de personajes.
```

docs/exportar_pdf.md
```
1 | # Guía: Exportación de Cuentos a PDF
2 | 
3 | TaleMe ahora permite exportar tus historias a archivos PDF con un formato personalizado y profesional.
4 | 
5 | ## Características del PDF generado
6 | 
7 | - **Portada personalizada** con el título del cuento y el nombre del autor
8 | - **Diseño elegante** con fondo en tonalidad #fff6e0 (color pergamino suave)
9 | - **Letra grande y en color** optimizada para lectura infantil en tono #ce9789
10 | - **Logo de TaleMe** en la portada
11 | - **Encabezado en cada página** con logo en miniatura y título del cuento
12 | - **Contraportada** con mensaje de cierre y año de generación
13 | - **Numeración de páginas**
14 | - **Información de versión** en cada página
15 | 
16 | ## ¿Cómo exportar un cuento?
17 | 
18 | 1. Abre el cuento que deseas exportar navegando a la página de visualización
19 | 2. Haz clic en el botón de exportación (ícono de descarga) ubicado en la esquina superior derecha
20 | 3. Se abrirá una vista previa del PDF con las opciones de exportación
21 | 4. Haz clic en "Descargar PDF" para generar y descargar el archivo
22 | 5. Elige la ubicación donde quieres guardarlo en tu dispositivo
23 | 
24 | ## Características pensadas para niños
25 | 
26 | - **Tamaño de texto aumentado** para facilitar la lectura por parte de los más pequeños
27 | - **Texto en negrita** para mejor legibilidad
28 | - **Color cálido** para el texto que resulta amigable y atractivo
29 | - **Márgenes amplios** para una mejor experiencia de lectura
30 | - **Encabezados infantiles** con el título del cuento y logo para una mejor orientación
31 | - **Contraportada con corazón** que añade un toque emocional al cuento
32 | 
33 | ## Requisitos técnicos
34 | 
35 | - La generación de PDF funciona en todos los navegadores modernos (Chrome, Firefox, Safari, Edge)
36 | - Se necesita conexión a internet para cargar correctamente los recursos gráficos
37 | - El proceso de generación puede tomar unos segundos dependiendo del tamaño del cuento
38 | 
39 | ## Solución de problemas
40 | 
41 | Si encuentras problemas al generar el PDF:
42 | 
43 | 1. Verifica que estás usando un navegador actualizado
44 | 2. Si hay imágenes en tu historia, asegúrate de que están correctamente cargadas
45 | 3. Para historias muy largas, ten paciencia mientras se procesa el documento
46 | 4. Si el problema persiste, intenta recargar la página o volver a abrir el cuento
47 | 
48 | ## Recomendaciones
49 | 
50 | - Los PDF generados son ideales para imprimir físicamente o compartir digitalmente
51 | - Para la mejor experiencia de impresión, usa papel de color crema o ligeramente amarillento
52 | - El formato está optimizado para impresión en tamaño A4
53 | - Imprime a doble cara para que la contraportada quede al final como en un libro real 
```

docs/project_structure.md
```
1 | # Estructura del Proyecto Cuenta-Cuentos
2 | 
3 | Este documento describe la estructura de carpetas y archivos principales del proyecto. Utiliza un formato de árbol para facilitar la comprensión de la organización del código y los recursos. Los comentarios explicativos se presentan después de los nombres de archivos, precedidos por `#`.
4 | 
5 | ```text
6 | Cuenta-Cuentos/
7 | ├── .vscode/
8 | │   └── extensions.json
9 | ├── docs/
10 | │   ├── EDGE_FUNCTIONS.md
11 | │   ├── PAUTAS_DE_DISENO.md
12 | │   ├── Stripe_integration.md
13 | │   ├── project_files_content.md
14 | │   ├── project_structure.md
15 | │   ├── services.md
16 | │   ├── store_arquitecture.md
17 | │   ├── supabase-integration-guide.md
18 | │   ├── supabase_RLS.sql
19 | │   ├── supabase_presets_data.sql
20 | │   └── supabase_tables.sql
21 | ├── node_modules/
22 | ├── public/
23 | ├── src/
24 | │   ├── App.css
25 | │   ├── App.tsx
26 | │   ├── components/
27 | │   │   ├── AudioPlayer.tsx
28 | │   │   ├── AuthGuard.tsx
29 | │   │   ├── BackButton.tsx
30 | │   │   ├── ChallengeQuestion.tsx
31 | │   │   ├── ChallengeSelector.tsx
32 | │   │   ├── IconLoadingAnimation.tsx
33 | │   │   ├── LanguageSelector.tsx
34 | │   │   ├── LoadingAnimation.tsx
35 | │   │   ├── ManageSubscriptionButton.tsx
36 | │   │   ├── PageTransition.tsx
37 | │   │   ├── PaymentButtons.tsx
38 | │   │   ├── ProgressBar.tsx
39 | │   │   ├── StoryAudioPlayer.tsx
40 | │   │   ├── StoryButton.tsx
41 | │   │   ├── StoryChapter.tsx
42 | │   │   ├── StoryContinuationCustomInput.tsx
43 | │   │   ├── StoryContinuationOptions.tsx
44 | │   │   ├── StoryOptionCard.tsx
45 | │   │   ├── VoiceSettings.tsx
46 | │   │   └── ui/                   # Componentes reutilizables (~49 archivos *.tsx)
47 | │   ├── env.d.ts
48 | │   ├── hooks/
49 | │   │   ├── use-mobile.tsx
50 | │   │   └── use-toast.tsx
51 | │   ├── index.css
52 | │   ├── lib/
53 | │   │   └── utils.ts
54 | │   ├── main.tsx
55 | │   ├── pages/
56 | │   │   ├── AuthCallback.tsx
57 | │   │   ├── CharacterHobbies.tsx
58 | │   │   ├── CharacterName.tsx
59 | │   │   ├── CharacterPersonality.tsx
60 | │   │   ├── CharacterProfession.tsx
61 | │   │   ├── CharacterSelection.tsx
62 | │   │   ├── CharactersManagement.tsx
63 | │   │   ├── DurationSelection.tsx
64 | │   │   ├── ErrorPage.tsx
65 | │   │   ├── GeneratingStory.tsx
66 | │   │   ├── Home.tsx
67 | │   │   ├── Index.tsx
68 | │   │   ├── Login.tsx
69 | │   │   ├── NotFound.tsx
70 | │   │   ├── PaymentCancel.tsx
71 | │   │   ├── PaymentSuccess.tsx
72 | │   │   ├── PlansPage.tsx
73 | │   │   ├── ProfileConfigPage.tsx
74 | │   │   ├── SavedStories.tsx
75 | │   │   ├── SettingsPage.tsx
76 | │   │   ├── Signup.tsx
77 | │   │   ├── StoryAudioPage.tsx
78 | │   │   ├── StoryContinuation.tsx
79 | │   │   ├── StoryDetailsInput.tsx
80 | │   │   ├── StoryGenre.tsx
81 | │   │   ├── StoryMoral.tsx
82 | │   │   ├── StoryViewer.tsx
83 | │   │   └── Welcome.tsx
84 | │   ├── services/
85 | │   │   ├── ai/
86 | │   │   │   ├── ChallengeService.ts
87 | │   │   │   ├── GenerateStoryService.ts
88 | │   │   │   ├── StoryContinuationService.ts
89 | │   │   │   └── ttsService.ts
90 | │   │   ├── stripeService.ts
91 | │   │   ├── supabase.ts
92 | │   │   └── syncService.ts
93 | │   ├── store/
94 | │   │   ├── character/
95 | │   │   │   └── characterStore.ts
96 | │   │   ├── core/
97 | │   │   │   ├── createStore.ts
98 | │   │   │   └── utils.ts
99 | │   │   ├── index.ts
100 | │   │   ├── stories/
101 | │   │   │   ├── audio/
102 | │   │   │   │   └── audioStore.ts
103 | │   │   │   ├── challenges/
104 | │   │   │   │   └── challengesStore.ts
105 | │   │   │   ├── chapters/
106 | │   │   │   │   └── chaptersStore.ts
107 | │   │   │   ├── storiesStore.ts
108 | │   │   │   └── storyGenerator.ts
109 | │   │   ├── storyOptions/
110 | │   │   │   └── storyOptionsStore.ts
111 | │   │   ├── types/
112 | │   │   │   └── storeTypes.ts
113 | │   │   └── user/
114 | │   │       └── userStore.ts
115 | │   ├── supabaseAuth.ts
116 | │   ├── supabaseClient.ts
117 | │   ├── types/
118 | │   │   ├── index.ts
119 | │   │   └── storeTypes.ts
120 | │   └── vite-env.d.ts
121 | ├── supabase/
122 | │   ├── .branches/
123 | │   ├── .temp/
124 | │   ├── config.toml
125 | │   ├── functions/
126 | │   │   ├── Stripe/
127 | │   │   │   ├── create-checkout-session/
128 | │   │   │   │   └── index.ts
129 | │   │   │   ├── create-customer-portal-session/
130 | │   │   │   │   └── index.ts
131 | │   │   │   └── stripe-webhook/
132 | │   │   │       └── index.ts
133 | │   │   ├── _shared/
134 | │   │   │   └── cors.ts
135 | │   │   ├── ai/
136 | │   │   │   ├── challenge/
137 | │   │   │   │   ├── index.ts
138 | │   │   │   │   └── README.md
139 | │   │   │   ├── generate-audio/
140 | │   │   │   │   ├── deno.jsonc
141 | │   │   │   │   ├── import_map.json
142 | │   │   │   │   └── index.ts
143 | │   │   │   ├── generate-story/
144 | │   │   │   │   ├── index.ts
145 | │   │   │   │   └── README.md
146 | │   │   │   └── story-continuation/
147 | │   │   │       ├── index.ts
148 | │   │   │       └── README.md
149 | │   │   └── deno.jsonc
150 | │   ├── migrations/
151 | │   │   ├── 20230901000000_init_db.sql
152 | │   │   └── 20231027103000_schedule_monthly_reset.sql
153 | │   ├── sql-functions/
154 | │   │   ├── decrement_voice_credits.sql
155 | │   │   ├── handle_new_user.sql
156 | │   │   ├── increment_monthly_voice_usage.sql
157 | │   │   ├── increment_story_count.sql
158 | │   │   ├── increment_voice_credits.sql
159 | │   │   ├── reset_monthly_counters.sql
160 | │   │   └── update_modified_column.sql
161 | │   └── config.toml
162 | ├── .env
163 | ├── .gitignore
164 | ├── bun.lockb
165 | ├── components.json
166 | ├── debug-edge-function.js
167 | ├── eslint.config.js
168 | ├── get-token.js
169 | ├── index.html
170 | ├── package-lock.json
171 | ├── package.json
172 | ├── postcss.config.cjs
173 | ├── README.md
174 | ├── tailwind.config.ts
175 | ├── tsconfig.app.json
176 | ├── tsconfig.json
177 | ├── tsconfig.node.json
178 | ├── vite.config.ts
179 | ```
180 | 
181 | > **Nota:** Este esquema puede variar ligeramente si se agregan o eliminan archivos/carpetas. Consulta el repositorio para la versión más actualizada.
```

docs/provisional_logica_tts.md
```
1 | # Lógica de Consumo de Créditos de Voz
2 | 
3 | ## Objetivo
4 | 
5 | Definir el proceso y las reglas para verificar la disponibilidad de créditos de
6 | voz y registrarlos como gastados cuando un usuario solicita la generación de una
7 | narración (audio TTS) para un capítulo de una historia.
8 | 
9 | ## Ubicación de la Lógica
10 | 
11 | Esta lógica **debe implementarse en el backend**, específicamente dentro de la
12 | **Edge Function encargada de procesar la solicitud de generación de audio**
13 | (probablemente llamada `generate-audio` o similar). No debe realizarse en el
14 | frontend por razones de seguridad y control.
15 | 
16 | ## Flujo General
17 | 
18 | 1. **Recepción de Solicitud:** La función recibe una petición del frontend para
19 |    generar audio para un texto/capítulo específico, incluyendo el ID de la voz
20 |    deseada.
21 | 2. **Autenticación:** Se verifica el token del usuario para confirmar que es una
22 |    solicitud válida y obtener su `user_id`. Si falla, se devuelve un error 401
23 |    (No autorizado).
24 | 3. **Obtención de Perfil:** Se consulta la tabla `profiles` en la base de datos
25 |    (usando el `user_id`) para obtener el estado actual del usuario:
26 |    - `subscription_status` (ej. 'free', 'active', 'trialing', 'canceled')
27 |    - `monthly_voice_generations_used` (contador de uso para Premium)
28 |    - `voice_credits` (créditos comprados) Si no se encuentra el perfil, se
29 |      devuelve un error 500.
30 | 4. **Verificación de Créditos (¡Lógica Clave!):** Se aplican las reglas para
31 |    determinar si el usuario tiene permiso y créditos suficientes para generar el
32 |    audio (ver detalles abajo).
33 | 5. **Error por Falta de Créditos:** Si la verificación determina que no hay
34 |    créditos suficientes, se devuelve un error al frontend **antes** de realizar
35 |    cualquier llamada a la API de TTS. Se recomienda usar el código de estado
36 |    HTTP:
37 |    - `402 Payment Required`: Si el usuario podría obtener más créditos
38 |      (comprando o esperando la renovación del plan).
39 |    - `403 Forbidden`: Si el tipo de usuario (ej. gratuito sin opción de compra)
40 |      simplemente no tiene acceso a la función. (En nuestro caso, como los
41 |      gratuitos pueden comprar, 402 suele ser más apropiado si se quedan sin
42 |      créditos).
43 | 6. **Actualización de Base de Datos (¡CRÍTICO!):** Si la verificación de
44 |    créditos es exitosa, se debe **actualizar inmediatamente** el contador
45 |    correspondiente en la base de datos **ANTES** de llamar a la API externa de
46 |    TTS. Esto se hace llamando a la función SQL apropiada mediante RPC:
47 |    - Si se usa un crédito del plan mensual:
48 |      `increment_monthly_voice_usage(user_id)`
49 |    - Si se usa un crédito comprado: `decrement_voice_credits(user_id)` Si esta
50 |      actualización falla, se debe devolver un error 500 al frontend y **no**
51 |      proceder con la generación de TTS.
52 | 7. **Generación de Audio (TTS):** Solo si la actualización de la base de datos
53 |    fue exitosa, se procede a llamar a la API externa de Text-to-Speech (ej.
54 |    ElevenLabs, OpenAI TTS) con el texto y la voz solicitada.
55 | 8. **Manejo de Errores TTS:** Si la API de TTS devuelve un error, se debe
56 |    registrar el fallo y devolver un error apropiado (ej. 500 o 502) al frontend.
57 |    _Nota: El crédito ya se gastó en el paso 6, lo cual es intencional para
58 |    evitar abusos o reintentos infinitos si la API externa falla
59 |    intermitentemente._
60 | 9. **Respuesta Exitosa:** Si la generación de TTS es exitosa, se devuelve el
61 |    buffer de audio (o la URL, según la implementación) al frontend con un estado
62 |    200 OK.
63 | 
64 | ## Lógica Detallada por Tipo de Usuario
65 | 
66 | ### Usuario Premium (`subscription_status` es 'active' o 'trialing')
67 | 
68 | 1. **Verificar Límite Mensual:** Se comprueba si
69 |    `monthly_voice_generations_used` es menor que el límite mensual permitido
70 |    (ej. 20).
71 |    - **Si SÍ (< 20):** El usuario puede generar.
72 |      - **Acción DB (ANTES de TTS):** Llamar a
73 |        `increment_monthly_voice_usage(user_id)`.
74 |    - **Si NO (>= 20):** Pasar al siguiente paso.
75 | 2. **Verificar Créditos Comprados:** Se comprueba si `voice_credits` es mayor
76 |    que 0.
77 |    - **Si SÍ (> 0):** El usuario puede generar.
78 |      - **Acción DB (ANTES de TTS):** Llamar a
79 |        `decrement_voice_credits(user_id)`.
80 |    - **Si NO (<= 0):** El usuario **no** puede generar. Devolver error 402 (Pago
81 |      Requerido).
82 | 
83 | ### Usuario Gratuito (o Cancelado, etc.)
84 | 
85 | 1. **Verificar Créditos Comprados:** Se comprueba si `voice_credits` es mayor
86 |    que 0.
87 |    - **Si SÍ (> 0):** El usuario puede generar.
88 |      - **Acción DB (ANTES de TTS):** Llamar a
89 |        `decrement_voice_credits(user_id)`.
90 |    - **Si NO (<= 0):** El usuario **no** puede generar. Devolver error 402 (Pago
91 |      Requerido), indicando que necesita comprar créditos.
92 | 
93 | ## Funciones SQL Necesarias (Supabase RPC)
94 | 
95 | Asegúrate de que estas funciones existan en tu base de datos y sean accesibles
96 | por el rol `service_role` (usado por `supabaseAdmin`):
97 | 
98 | - `increment_monthly_voice_usage(user_uuid uuid)`: Incrementa el contador
99 |   `monthly_voice_generations_used` en 1 para el usuario dado.
100 | - `decrement_voice_credits(user_uuid uuid)`: Decrementa `voice_credits` en 1
101 |   para el usuario dado, idealmente devolviendo el nuevo saldo o un indicador
102 |   (-1) si no había créditos para decrementar (aunque la lógica principal ya lo
103 |   verifica).
104 | 
105 | ## Consideraciones Adicionales
106 | 
107 | - **Constantes:** Definir el límite mensual (ej. 20) como una constante o
108 |   variable de entorno para fácil mantenimiento.
109 | - **Atomicidad:** Las llamadas RPC a funciones SQL que actualizan una sola fila
110 |   suelen ser suficientemente atómicas para este caso de uso, minimizando riesgos
111 |   de condiciones de carrera.
112 | - **Errores:** Manejar adecuadamente los errores de red, de base de datos y de
113 |   la API de TTS, devolviendo códigos de estado HTTP informativos.
```

docs/services.md
```
1 | Guía Completa de la Carpeta @src/services
2 | Versión: 1.0
3 | Fecha: 2024-07-25
4 | Destinatario: Agente de Código (Windsurf), Desarrolladores
5 | 
6 | 1. Propósito General
7 | La carpeta @src/services actúa como una capa de abstracción crucial entre la lógica del frontend (componentes de UI en @/pages, @/components, y manejo de estado en @/store) y el backend (Supabase). Sus responsabilidades principales son:
8 | 
9 | Invocar Edge Functions (EFs): Proporcionar métodos claros y específicos que llaman a las Supabase Edge Functions para tareas que requieren lógica del lado del servidor, acceso a APIs externas con claves secretas (IA, Stripe), o cómputo intensivo.
10 | Interactuar con la Base de Datos Supabase: Centralizar las operaciones CRUD (Crear, Leer, Actualizar, Eliminar) directas con las tablas de la base de datos Supabase, encapsulando las llamadas al cliente supabase.
11 | Orquestar Procesos de Sincronización: Gestionar la lógica inicial de carga de datos y la sincronización al detectar cambios de conectividad.
12 | Manejar Lógica Específica de Terceros (Frontend): Contener inicialización o utilidades relacionadas con librerías de terceros que se ejecutan en el cliente (como cargar Stripe.js).
13 | 2. Principios de Diseño y Arquitectura
14 | Separación de Responsabilidades: Mantiene la lógica de comunicación con el backend separada de la UI y el estado global.
15 | Seguridad: NO CONTIENE claves API secretas (OpenAI, Gemini, Stripe Secret Key). Estas claves residen de forma segura en los secretos de Supabase y solo son accedidas por las Edge Functions. Los servicios aquí usan el token de autenticación de Supabase para invocar las EFs.
16 | Patrón Wrapper para EFs: Servicios como ChallengeService, GenerateStoryService, StoryContinuationService, ttsService, y stripeService actúan principalmente como wrappers delgados. Reciben datos del frontend, llaman a la EF correspondiente vía supabase.functions.invoke(), y devuelven la respuesta. La lógica compleja reside en la EF.
17 | Acceso Directo a DB (Controlado): supabase.ts realiza llamadas directas a la base de datos (supabase.from(...).select/insert/update/delete). La seguridad de estas operaciones depende fundamentalmente de las Políticas de Row Level Security (RLS) configuradas en Supabase.
18 | Manejo de Errores: Implementa bloques try...catch y a menudo devuelve objetos con formato { success: boolean, data?: T, error?: any }.
19 | Cliente Supabase Único: Todos los servicios importan y utilizan la instancia única del cliente Supabase inicializada en @src/supabaseClient.ts.
20 | Sincronización Offline: supabase.ts integra una cola (SyncQueueService) para manejar operaciones de escritura fallidas cuando la aplicación está offline.
21 | 3. Desglose de Archivos
22 | 3.1. @src/services/ChallengeService.ts
23 | Propósito: Wrapper para la Edge Function challenge. Maneja la generación y obtención de información sobre desafíos educativos.
24 | Métodos Clave:
25 | generateChallengeQuestion(story, category, profileSettings, targetLanguage): Llama a la EF (action: 'createChallenge') para generar una pregunta de desafío y extrae solo la pregunta de la respuesta. (Nota: Podría optimizarse en la EF si solo se necesita la pregunta).
26 | createChallenge(story, category, profileSettings, targetLanguage): Llama a la EF (action: 'createChallenge') para generar un objeto Challenge completo (con ID de desafío y preguntas).
27 | getAvailableLanguages(currentLanguage): Llama a la EF (action: 'getLanguages') para obtener la lista de idiomas disponibles para desafíos de traducción. Incluye un fallback en caso de error de la EF.
28 | Dependencias: supabaseClient, EF challenge.
29 | Interacción: Usado por componentes de UI como StoryViewer.tsx (para crear retos) y LanguageSelector.tsx (para listar idiomas).
30 | Cuidado: Asegurarse de que los métodos sigan siendo wrappers delgados y no reintroduzcan lógica de prompts.
31 | 3.2. @src/services/GenerateStoryService.ts
32 | Propósito: Wrapper para la Edge Function generate-story. Encargado de solicitar la generación de la historia inicial.
33 | Métodos Clave:
34 | generateStoryWithAI(params): Llama a la EF generate-story pasándole las opciones de configuración de la historia (personaje, género, etc.) y devuelve el contenido de la historia generada.
35 | Dependencias: supabaseClient, EF generate-story.
36 | Interacción: Usado principalmente por el store (@store/storyGenerator.ts) para iniciar la generación de una nueva historia.
37 | Cuidado: Confirmar que no queda ninguna lógica de creación de prompts o generación de títulos (ya eliminada).
38 | 3.3. @src/services/ai/StoryContinuationService.ts
39 | Propósito: Wrapper para la Edge Function story-continuation. Encargado de solicitar opciones de continuación para una historia en curso.
40 | 
41 | Métodos Clave:
42 | - generateContinuationOptions(story, chapters, childAge?, specialNeed?, language?): Llama a la EF story-continuation (acción: 'generateOptions') pasando los parámetros contextuales:
43 |     - story: Objeto con los metadatos de la historia (título, género, moral, personaje, etc.).
44 |     - chapters: Array de capítulos previos de la historia.
45 |     - childAge: (opcional) Edad del niño/a objetivo. Mejora la adecuación de las opciones generadas.
46 |     - specialNeed: (opcional) Necesidad especial del niño/a. Permite adaptar el tono, vocabulario o contenido para necesidades específicas.
47 |     - language: (opcional) Idioma en el que se debe generar la continuación. El prompt se adapta para instruir al modelo en ese idioma.
48 | 
49 | La función construye un prompt contextualizado que incluye estos parámetros, asegurando que las opciones generadas sean relevantes para la edad, necesidades y idioma del usuario.
50 | 
51 | Dependencias: supabaseClient, EF story-continuation.
52 | Interacción: Usado por StoryContinuation.tsx y otros componentes de la UI para mostrar opciones de continuación adaptadas.
53 | 
54 | Cuidado: Si la firma de la EF cambia (parámetros, respuesta), actualizar este wrapper para mantener la coherencia.
55 | 3.4. @src/services/ttsService.ts
56 | Propósito: Wrapper para la Edge Function generate-audio y proveedor de utilidades/constantes relacionadas con Text-to-Speech para el frontend.
57 | Métodos/Exportaciones Clave:
58 | generateSpeech(options): Llama a la EF generate-audio pasándole el texto, voz, modelo e instrucciones para generar el audio. Devuelve un Blob de audio.
59 | getAvailableVoices(): Devuelve una lista estática de voces disponibles (actualmente OPENAI_VOICES).
60 | OPENAI_VOICES: Constante con la lista de voces de OpenAI y sus descripciones (usada por la UI).
61 | OpenAIVoiceType: Tipo para las voces de OpenAI.
62 | cleanTextForSpeech(text): Función de utilidad del frontend para limpiar/preparar el texto antes de enviarlo a la EF.
63 | Dependencias: supabaseClient, EF generate-audio.
64 | Interacción: Usado por componentes/páginas relacionados con la reproducción/configuración de audio (StoryAudioPage.tsx, AudioPlayer.tsx, VoiceSettings.tsx, etc.).
65 | Cuidado: Asegurarse de que no contiene referencias a API Keys. Mantener OPENAI_VOICES actualizada si cambian las opciones o si se usan en la UI.
66 | 3.5. @src/services/stripeService.ts
67 | Propósito: Wrapper para las Edge Functions de Stripe y gestor de Stripe.js en el frontend.
68 | Métodos Clave:
69 | getStripe(): Carga y devuelve la instancia de Stripe.js usando la Publishable Key (cargada desde variables de entorno VITE_). Necesario si se usan elementos UI de Stripe.
70 | createCheckoutSession(item): Llama a la EF create-checkout-session (pasando token de Supabase) para obtener una URL de redirección a la página de pago de Stripe.
71 | createCustomerPortalSession(): Llama a la EF create-customer-portal-session (pasando token de Supabase) para obtener una URL de redirección al portal de gestión de suscripciones de Stripe.
72 | Dependencias: supabaseClient, loadStripe, EFs create-checkout-session, create-customer-portal-session.
73 | Interacción: Usado por la UI en páginas de precios, perfil de usuario, o botones de "Upgrade/Comprar/Gestionar Suscripción".
74 | Cuidado: Fundamental que NUNCA maneje la Secret Key de Stripe. Debe limitarse a llamar a las EFs. Verificar que VITE_STRIPE_PUBLISHABLE_KEY esté configurada. Asegurar que las llamadas a las EFs usen fetch con el token Authorization correcto. (Nota: El código proporcionado usa fetch directamente en lugar de supabase.functions.invoke, lo cual es válido pero menos consistente con los otros servicios; invoke maneja la autenticación automáticamente si el cliente Supabase está autenticado*).
75 | 3.6. @src/services/supabase.ts
76 | Propósito: Capa central de acceso a la base de datos Supabase. Realiza operaciones CRUD directas y maneja la cola de sincronización offline.
77 | Métodos Clave (Ejemplos):
78 |     *   `syncUserProfile(userId, profileData)`: **Actualiza/Inserta (upsert)** el perfil del usuario en la tabla `profiles`.
79 |         *   **Importante:** Espera que el objeto `profileData` contenga las claves ya **en formato `snake_case`** (ej., `child_age`, `special_need`), coincidiendo con las columnas de la base de datos. El mapeo desde `camelCase` se realiza *antes* de llamar a esta función (actualmente en `@store/user/userStore.ts -> setProfileSettings`).
80 |         *   Utiliza `upsert` con `id` como conflicto para manejar tanto creación como actualización.
81 |         *   Usa `syncQueue.addToQueue` en caso de error para sincronización offline.
82 |     *   `getUserProfile`: Obtiene el perfil completo del usuario desde la tabla `profiles`. Es crucial para obtener el estado de suscripción y límites del usuario.
83 |     *   `syncCharacter, getUserCharacters, deleteCharacter`: CRUD para la tabla `characters`.
84 |     *   `syncStory, getUserStories`: CRUD para la tabla `stories` (incluyendo join con `characters`).
85 |     *   `syncChapter, getStoryChapters`: CRUD para la tabla `story_chapters`.
86 |     *   `getChapterCountForStory(storyId)`: Cuenta cuántos capítulos existen actualmente para una historia específica en la tabla `story_chapters`. Usado para determinar el número del siguiente capítulo.
87 |     *   `syncChallenge, getStoryChallenges`: CRUD para challenges y challenge_questions.
88 |     *   `syncAudioFile, getUserAudios`: CRUD para audio_files.
89 |     *   `setCurrentVoice, getCurrentVoice`: CRUD para user_voices.
90 | *   **Leer Presets de Historias**: Aunque la lógica específica puede estar directamente en el componente (`StoryDetailsInput.tsx`), las llamadas a `supabase.from('preset_suggestions').select(...)` para obtener las sugerencias aleatorias también forman parte de la interacción directa con la base de datos gestionada a través del cliente Supabase centralizado.
91 | Componente Clave: SyncQueueService
92 | Implementa un Singleton (syncQueue) para gestionar una cola de operaciones de escritura (insert, update, delete) que fallan (presumiblemente por estar offline).
93 | Persiste la cola en localStorage.
94 | Intenta procesar la cola (processQueue) cuando la aplicación vuelve a estar online.
95 | Usa upsert para reintentar operaciones de forma segura. Re-encola ítems que vuelven a fallar.
96 | Dependencias: supabaseClient.
97 | Interacción: Es la principal fuente de datos para los stores (userStore, characterStore, etc.) durante la carga inicial (load...FromSupabase methods) y es llamado por los stores para persistir cambios en la base de datos. syncQueue se usa implícitamente si una operación de escritura falla dentro de un try...catch que llame a syncQueue.addToQueue.
98 | Cuidado:
99 | RLS: La causa más común de errores aquí son políticas RLS mal configuradas o ausentes en Supabase. Asegurarse de que el usuario autenticado tiene permisos para SELECT, INSERT, UPDATE, DELETE en las tablas según sea necesario.
100 | Schema Mismatch: Errores si los nombres de columna/tabla o tipos de datos en el código no coinciden exactamente con la base de datos.
101 | upsert: Usar con cuidado. Asegurarse de que la condición de conflicto (onConflict) es la deseada para no sobrescribir datos accidentalmente.
102 | syncQueue: Asegurar que los datos añadidos (especialmente para delete) contienen el id necesario. Monitorizar localStorage (sync_queue key) durante el desarrollo si hay problemas de sincronización.
103 | Errores Silenciosos: Algunas funciones devuelven { success: false } sin lanzar una excepción necesariamente; el código que llama debe verificar success.
104 | 3.7. @src/services/syncService.ts
105 | Propósito: Orquestar el inicio de la sincronización de datos y reaccionar a cambios de conectividad. NO carga datos directamente.
106 | Métodos Clave:
107 | initSyncService(): Función principal a llamar una vez al inicio de la app. Inicializa los listeners y lanza el primer intento de syncUserData.
108 | initSyncListeners(): Configura listeners para los eventos online y visibilitychange del navegador. Ambos eventos disparan syncUserData. Usa un flag (_syncListenersInitialized) para evitar duplicación.
109 | syncUserData(): Función clave de disparo. Verifica si hay conexión y sesión de Supabase activa. Si es así, llama a useUserStore.getState().checkAuth(), delegando todo el proceso de carga/sincronización real al userStore.
110 | Dependencias: supabaseClient (para getSession), userStore (para checkAuth).
111 | Interacción: initSyncService es llamado desde el punto de entrada de la aplicación (main.ts o App.tsx). Los listeners actúan en segundo plano. syncUserData interactúa directamente con userStore.
112 | Cuidado: Asegurarse de que syncUserData solo dispara el proceso en userStore y no intenta cargar datos de otros stores directamente (lo cual ya está corregido en el código proporcionado). Verificar que initSyncService se llame solo una vez.
113 | 4. Errores Comunes y Puntos a Considerar
114 | RLS (Row Level Security): La causa nº1 de errores en supabase.ts y, por extensión, en los stores. Siempre verificar las políticas en el dashboard de Supabase.
115 | Errores de Red/Offline: Asegurarse de que las llamadas a EFs y DB manejen correctamente los errores de red. syncQueue ayuda con las escrituras, pero las lecturas fallarán si no hay conexión.
116 | Desincronización de Estado: Si syncQueue falla repetidamente o si hay errores en los webhooks de Stripe, el estado local en el store puede desincronizarse con la base de datos.
117 | Dependencias de EF: Si la firma (parámetros, nombre, respuesta) de una Edge Function cambia, el servicio wrapper correspondiente en @src/services debe actualizarse.
118 | Errores en invoke: Las llamadas a supabase.functions.invoke pueden fallar por errores dentro de la EF (errores 500) o problemas de autenticación/permisos (errores 401/403). Los catch deben manejar esto.
119 | Manejo de null/undefined: Al interactuar con la DB (supabase.ts), tener cuidado con valores nulos o indefinidos que podrían no ser aceptados por columnas no nulables en la base de datos.
120 | Consistencia de Tipos: Asegurar que los tipos definidos en @src/types.ts coinciden con la estructura de datos devuelta por la base de datos y las EFs.
121 | 5. Desarrollo Futuro
122 | Nuevos Servicios para EFs: Si se crea una nueva EF, añadir un servicio wrapper correspondiente aquí siguiendo el patrón establecido (simple, solo llama a invoke).
123 | Nuevas Entidades de DB: Añadir las funciones CRUD necesarias a supabase.ts, asegurarse de crear las políticas RLS adecuadas en Supabase, y actualizar los stores relevantes para usar las nuevas funciones.
124 | Refactorización (Opcional): Considerar si los wrappers de EF añaden suficiente valor o si las llamadas a invoke podrían hacerse directamente desde los stores o hooks para reducir una capa (evaluar pros y contras en cada caso).
125 | 6. Race Condition Fixes: Authentication and Story Loading
126 | 
127 | **Authentication Race Condition**
128 | 
129 | - Updated `checkAuth` signature to return `Promise<User | null>` instead of `Promise<boolean>`.
130 | - Refactored `AuthGuard.tsx` to use an internal `authStatus` (`'pending' | 'authenticated' | 'unauthenticated'`), awaiting `checkAuth()` result before rendering or redirecting.
131 | - Eliminated separate `authChecked` state and reliance on store `user` for decision-making.
132 | 
133 | **Story Loading Race Condition**
134 | 
135 | - Added `isLoadingStories: boolean` to `StoriesState` and initialized it in `storiesStore.ts`.
136 | - In `storiesStore.ts`, `loadStoriesFromSupabase` sets `isLoadingStories` to `true` at start and resets it to `false` in `finally`.
137 | - Updated `StoryViewer.tsx` to depend on `isLoadingStories` in its main `useEffect`, returning early if `true`, and rendering a loading spinner until stories are loaded. Navigation to `/not-found` only occurs if the story remains `undefined` after loading.
138 | 
139 | Este documento debería proporcionar una comprensión sólida de la carpeta @src/services, su arquitectura actual y los puntos clave a tener en cuenta.
```

docs/store_arquitecture.md
```
1 | # Store Architecture and Data Flow Guide (Zustand + Supabase)
2 | 
3 | **Document Version:** 1.0
4 | **Date:** 2023-10-27 (Update with actual date)
5 | **Target Audience:** Code Agent (e.g., Windsurf), Developers
6 | 
7 | ## 1. Overview
8 | 
9 | This document details the state management architecture for the AI Storyteller web application, primarily located within the `src/store` directory. The application utilizes **Zustand** as its state management library, employing a modular approach where different aspects of the application state are handled by separate "stores."
10 | 
11 | **Key Goals of this Architecture:**
12 | 
13 | *   **Centralized State:** Provide a single source of truth for various application states.
14 | *   **Modularity:** Separate concerns into logical units (user, characters, stories, etc.) for maintainability.
15 | *   **Reactivity:** Enable UI components to react automatically to state changes.
16 | *   **Persistence:** Persist user-specific state across browser sessions using `localStorage`.
17 | *   **Supabase Integration:** Manage the flow of data between the frontend state and the Supabase backend (database and authentication).
18 | *   **Multi-User Support:** Isolate the persisted state for different authenticated users.
19 | 
20 | ## 2. Core Concepts & Mechanisms
21 | 
22 | Several core mechanisms underpin how the stores function:
23 | 
24 | ### 2.1. Persistent Store Creation (`@store/core/createStore.ts`)
25 | 
26 | *   **`createPersistentStore<T>(initialState, storeLogic, storeName)`:** A custom wrapper around Zustand's `create` and `persist` middleware.
27 | *   **User-Specific Persistence:**
28 |     *   It automatically generates a unique `localStorage` key for each store *and* each authenticated user: `` `story-app-${userId}-${storeName}` `` (e.g., `story-app-user123-characters`). `userId` is 'anonymous' if no user is logged in.
29 |     *   This ensures that data from different users does not mix in `localStorage`.
30 | *   **`setCurrentAuthUser(userId: string | null)`:** **Crucial function.** Called by `@store/user/userStore.ts` during login/logout/auth check. It updates a global tracker for the current user ID, which `createPersistentStore` uses to generate the correct storage key.
31 | *   **`cleanPreviousUserStores(currentUserId: string)`:** Called when the user changes (via `setCurrentAuthUser`). It iterates through `localStorage` and removes keys associated with *previous* users (keys matching `story-app-...` but *not* containing the `currentUserId` and not being the generic `story-app-user` key).
32 | *   **`registerStoreRefresh(storeName: string, refreshFn: Function)` & `refreshAllStores()`:** A mechanism allowing stores to register a function (typically their `load...FromSupabase` method) that gets called automatically by `refreshAllStores` (triggered via `setCurrentAuthUser` on user change) to reload data relevant to the *new* user.
33 | 
34 | ### 2.2. Data Loading & Synchronization Flow
35 | 
36 | The loading of user-specific data from Supabase upon login or app initialization follows a specific, centralized pattern orchestrated by `@store/user/userStore.ts`:
37 | 
38 | 1.  **Initiation:** Triggered by:
39 |     *   App load (`@main.ts` -> `@services/syncService.ts` -> `useUserStore.checkAuth()`).
40 |     *   Explicit Login (`Login Page` -> `supabaseAuth.login` -> `useUserStore.loginUser()`).
41 |     *   Coming back online (`online` event -> `@services/syncService.ts` -> `useUserStore.checkAuth()`).
42 | 2.  **`userStore.checkAuth()` / `userStore.loginUser()`:**
43 |     *   Verifies authentication state with Supabase Auth (`supabase.auth.getSession`, `supabase.auth.getUser`).
44 |     *   If authenticated, calls `setCurrentAuthUser(userId)` to set the global user ID.
45 |     *   Calls `@services/supabase.ts -> getUserProfile(userId)` to fetch the user's *complete* profile data (including settings, subscription status, limits, credits).
46 |     *   Updates its *own* state (`user` and `profileSettings`).
47 |     *   **Crucially, calls the internal `syncAllUserData(userId)` function.**
48 | 3.  **`userStore.syncAllUserData(userId)`:**
49 |     *   This function acts as the **central orchestrator** for loading data into *other* stores.
50 |     *   It iterates through a predefined list (`otherStores`) of stores and their respective data-loading methods (e.g., `useCharacterStore.loadCharactersFromSupabase`, `useStoriesStore.loadStoriesFromSupabase`, `useAudioStore.loadAudioFromSupabase`).
51 |     *   It calls these methods sequentially, passing the `userId`.
52 | 4.  **Individual Store `load...FromSupabase(userId)` Methods:**
53 |     *   Each store's loading method (e.g., `@store/character/characterStore.ts -> loadCharactersFromSupabase`) uses the provided `userId` to call the relevant data-fetching function in `@services/supabase.ts` (e.g., `getUserCharacters`).
54 |     *   **Important:** These methods should **first clear** the relevant part of their local state (e.g., `set({ savedCharacters: [] })`) before fetching and setting the fresh data from Supabase to prevent merging old/stale data.
55 |     *   They update their own state upon successful data retrieval.
56 | 
57 | ### 2.3. Offline Queue (`@services/supabase.ts -> syncQueue`)
58 | 
59 | *   **Purpose:** To handle situations where the application is offline or a direct Supabase operation fails temporarily.
60 | *   **Mechanism:**
61 |     *   When a direct Supabase write operation (e.g., `syncCharacter`, `syncUserProfile`) fails within its `try...catch` block, the operation details (table, operation type, data) are added to the `syncQueue` using `syncQueue.addToQueue(...)`.
62 |     *   The `SyncQueueService` class persists this queue in `localStorage`.
63 |     *   An `online` event listener triggers `syncQueue.processQueue()`.
64 |     *   `processQueue()` attempts to execute the queued operations (using `upsert` for resilience) against Supabase. Successful operations are removed from the queue; failed ones are re-queued.
65 | *   **Consideration:** Requires careful handling of data format, especially ensuring `id` is present for `delete` operations.
66 | 
67 | ## 3. Store Breakdown
68 | 
69 | ### 3.1. `@store/user/userStore.ts`
70 | 
71 | *   **Purpose:** Manages user authentication state, user profile settings (including subscription/limit data), and orchestrates the initial data loading for other stores.
72 | *   **Key State:**
73 |     *   `user: User | null`: Basic user info (id, email).
74 |     *   `profileSettings: ProfileSettings | null`: Complete profile data fetched from the `profiles` table (language, age, need, subscription status, limits, credits, etc.). **Crucial for app logic.**
75 |         *   Includes fields like `subscription_status`, `monthly_stories_generated`, `monthly_voice_generations_used`, `voice_credits`, `current_period_end`.
76 |         *   Includes `has_completed_setup: boolean`: A flag indicating if the user has gone through the initial profile configuration (`ProfileConfigPage`) at least once. This flag is crucial for redirection logic.
77 | *   **Key Selectors (Computed State):**
78 |     *   `isPremium()`: Returns `true` if `subscription_status` indicates an active premium plan ('premium_monthly', 'premium_yearly', 'trialing').
79 |     *   `getRemainingMonthlyStories()`: Calculates remaining stories for free users based on `monthly_stories_generated`.
80 |     *   `getRemainingMonthlyVoiceGenerations()`: Returns the number of *included* monthly voice generations remaining for premium users (e.g., `20 - monthly_voice_generations_used`). Returns 0 for non-premium users.
81 |     *   `getAvailableVoiceCredits()`: Returns the number of *purchased* `voice_credits`.
82 |     *   `canGenerateStory()`: Checks if the user (free or premium) has available story generations (monthly limit or purchased credits, though story credits are not fully implemented yet).
83 |     *   `canGenerateVoice()`: Determines if the user can generate voice based on subscription status and voice credits.
84 |         * **Premium users (`active` or `trialing`):** Allowed if they have remaining monthly voice generations (quota) OR purchased voice credits.
85 |         * **Non-premium users (`free`, `canceled`, etc.):** Allowed only if they have purchased voice credits.
86 |     *   `hasCompletedProfile()`: A selector returning `true` if `profileSettings` exists and `profileSettings.has_completed_setup` is true. Used by components like `Home` and `AuthGuard` to check if the user needs to be sent to profile configuration.
87 | *   **Important Distinction: Monthly Quota vs. Purchased Credits:**
88 |     It's crucial to understand the difference in how voice generation allowances work:
89 |     *   **Monthly Voice Generations (Premium):** Represented by tracking `monthly_voice_generations_used` against a fixed limit (e.g., 20). This is a *quota* that **resets to 0** at the start of each subscription period (handled by the Stripe webhook). This effectively makes the full quota available again each month. Unused generations from one month **do not roll over** to the next.
90 |     *   **Purchased Voice Credits (`voice_credits`):** Represent a *balance* of credits bought separately. These credits **persist** across subscription periods and **do not reset** monthly. They are only consumed when used (either by free users or by premium users who have exhausted their monthly quota). This balance accumulates if more credits are purchased.
91 | 
92 | *   **Key Actions:**
93 |     *   `checkAuth()`: Verifies auth, loads profile, triggers `syncAllUserData`. **Central function.** Determines initial redirect path (`/home` or `/profile-config`) based on `profileSettings.has_completed_setup`.
94 |     *   `loginUser(user)`: Sets user state, loads profile, triggers `syncAllUserData`.
95 |     *   `logoutUser()`: Processes sync queue, signs out via `@services/supabaseAuth.logout`, clears local state, calls `setCurrentAuthUser(null)`.
96 |     *   `setProfileSettings(settings)`: 
97 |         1. Recibe un objeto `settings` con las propiedades del perfil a actualizar (usando nombres en camelCase, ej. `childAge`).
98 |         2. **Actualiza inmediatamente el estado local (`profileSettings`)** fusionando los nuevos `settings` para que la UI refleje los cambios al instante.
99 |         3. **Mapea las claves del objeto `settings`** de camelCase (TypeScript) a snake_case (Supabase DB) usando un `keyMap` interno (ej., `childAge` -> `child_age`, `specialNeed` -> `special_need`). Solo se incluyen en el mapeo las propiedades presentes en el `settings` recibido.
100 |         4. Construye un objeto `syncData` que contiene únicamente las propiedades mapeadas a snake_case con sus valores.
101 |         5. Llama a `@services/supabase.syncUserProfile` pasándole el `userId` y el objeto `syncData` (con claves snake_case) para persistir los cambios en la base de datos.
102 |         6. Utiliza `@services/syncQueue` como fallback si la sincronización directa falla.
103 |         7. **Nota:** Cuando se llama desde `ProfileConfigPage` por primera vez, el objeto `settings` también incluye explícitamente `has_completed_setup: true` para marcar el perfil como configurado.
104 | *   **Supabase Interaction:** Calls `getCurrentUser`, `logout`, `getUserProfile`, `syncUserProfile`, `syncQueue`.
105 | *   **Notes:** Contains the vital `syncAllUserData` orchestrator function. Ensure all necessary stores are listed in its `otherStores` array.
106 | 
107 | ### 3.2. `@store/character/characterStore.ts`
108 | 
109 | *   **Purpose:** Manages user-created characters.
110 | *   **Key State:**
111 |     *   `currentCharacter: StoryCharacter | null`: The character currently being edited or selected.
112 |     *   `savedCharacters: StoryCharacter[]`: List of all characters saved by the user.
113 | *   **Key Actions:**
114 |     *   `updateCharacter(updates)`: Modifies `currentCharacter`.
115 |     *   `resetCharacter()`: Clears `currentCharacter` for creating a new one.
116 |     *   `saveCurrentCharacter()`: Adds/updates `currentCharacter` in `savedCharacters`, calls `@services/supabase.syncCharacter`, uses `syncQueue` on failure. Handles local duplicate name check.
117 |     *   `selectCharacter(characterId)`: Sets `currentCharacter` from `savedCharacters`.
118 |     *   `deleteCharacter(characterId)`: Removes character locally, calls `@services/supabase.deleteCharacter`, uses `syncQueue` on failure.
119 |     *   `loadCharactersFromSupabase(userId)`: Clears `savedCharacters`, fetches via `@services/supabase.getUserCharacters`, updates state. Called by `syncAllUserData`.
120 | *   **Supabase Interaction:** Calls `syncCharacter`, `getUserCharacters`, `deleteCharacter`, `syncQueue`.
121 | *   **Notes:** The previous `setTimeout` for initial load was removed; relies solely on `syncAllUserData`.
122 | 
123 | ### 3.3. `@store/stories/storiesStore.ts`
124 | 
125 | *   **Purpose:** Manages the list of generated stories (metadata and initial content).
126 | *   **Key State:**
127 |     *   `generatedStories: Story[]`: List of stories created by the user.
128 |     *   `isGeneratingStory: boolean`: Flag for UI loading state during story generation.
129 | *   **Key Actions:**
130 |     *   `addGeneratedStory(story)`: Adds a new story locally, calls `@services/supabase.syncStory`, uses `syncQueue` on failure.
131 |         *   **Note:** After this action is successfully called by `@store/stories/storyGenerator.ts`, the generator proceeds to create and save the initial chapter (Chapter 1) using `chaptersStore.addChapter`.
132 |     *   `getStoryById(id)`: Retrieves a specific story from the local state.
133 |     *   `loadStoriesFromSupabase(userId)`: Clears `generatedStories`, fetches via `@services/supabase.getUserStories`, updates state. Called by `syncAllUserData`.
134 | *   **Supabase Interaction:** Calls `syncStory`, `getUserStories`, `syncQueue`.
135 | 
136 | ### 3.4. `@store/storyOptions/storyOptionsStore.ts`
137 | 
138 | *   **Purpose:** Manages the temporary options selected by the user during the story creation flow *before* the story is generated.
139 | *   **Key State:**
140 |     *   `currentStoryOptions: Partial<StoryOptions>`: Holds selected duration, genre, moral, character.
141 |     *   `additionalDetails: string | null | undefined`: Holds optional free-text details or instructions provided by the user to further customize the story generation.
142 | *   **Key Actions:**
143 |     *   `updateStoryOptions(options)`: Updates multiple options at once.
144 |     *   `resetStoryOptions()`: Clears all selected options.
145 |     *   `setDuration(duration)`: Sets the story duration.
146 |     *   `setMoral(moral)`: Sets the story moral.
147 |     *   `setGenre(genre)`: Sets the story genre.
148 |     *   `setAdditionalDetails(details)`: Sets the optional additional details provided by the user. This is read by `storyGenerator.ts` before calling the generation service.
149 | *   **Persistence:** This store is **not persistent** as the options are temporary for the current creation flow.
150 | 
151 | ### 3.5. `@store/stories/chapters/chaptersStore.ts`
152 | 
153 | *   **Purpose:** Manages the individual chapters associated with each story.
154 | *   **Key State:**
155 |     *   `storyChapters: StoryWithChapters[]`: An array where each element represents a story and contains an array of its `chapters`. (Note: This duplicates some story metadata; consider if just storing chapters grouped by `storyId` is sufficient).
156 | *   **Key Actions:**
157 |     *   `addChapter(storyId, chapter)`: Adds a new chapter to the appropriate story in `storyChapters`, calls `@services/supabase.syncChapter`, uses `syncQueue` on failure.
158 |         *   **Important State Update Logic:** To prevent inconsistencies (especially for free user limit checks), the local state (`storyChapters`) is **only updated *after* the `syncChapter` call successfully completes**.
159 |         *   **Note:** This action is called both by `@store/stories/storyGenerator.ts` (for the initial Chapter 1, using the story's title/content) and by `@pages/StoryContinuation.tsx` (for subsequent chapters). The logic for determining the correct `chapterNumber` (either `1` or based on `getChapterCountForStory`) resides in the calling code *before* this action is invoked.
160 |     *   `getChaptersByStoryId(storyId)`: Retrieves chapters for a specific story.
161 |     *   `loadChaptersFromSupabase(storyId)`: Fetches chapters for a *specific story* via `@services/supabase.getStoryChapters`. This is typically called on demand when viewing a story, *not* by `syncAllUserData` initially.
162 | *   **Supabase Interaction:** Calls `syncChapter`, `getStoryChapters`, `syncQueue`.
163 | 
164 | ### 3.6. `@store/stories/audio/audioStore.ts`
165 | 
166 | *   **Purpose:** Manages generated audio files, generation status, and user voice preference.
167 | *   **Key State:**
168 |     *   `audioCache: { [key: string]: { url: string; timestamp: string } }`: Cache of generated audio URLs.
169 |     *   `generationStatus: { [key: string]: { status: string; progress: number } }`: Tracks audio generation progress.
170 |     *   `currentVoice: string | null`: The ID of the user's preferred voice.
171 | *   **Key Actions:**
172 |     *   `addAudioToCache(...)`: Adds audio URL locally, calls `@services/supabase.syncAudioFile`, uses `syncQueue` on failure.
173 |     *   `setCurrentVoice(voiceId)`: Updates state, calls `@services/supabase.setCurrentVoice`.
174 |     *   `loadAudioFromSupabase(userId)`: Fetches *existing* generated audio records and the user's current voice preference via `@services/supabase.getUserAudios` and `@services/supabase.getCurrentVoice`. Called by `syncAllUserData`.
175 | *   **Supabase Interaction:** Calls `syncAudioFile`, `getUserAudios`, `setCurrentVoice`, `getCurrentVoice`, `syncQueue`.
176 | 
177 | ### 3.7. `@store/stories/challenges/challengesStore.ts`
178 | 
179 | *   **Purpose:** Manages challenges and questions associated with stories.
180 | *   **Key State:**
181 |     *   `challenges: Challenge[]`: List of all challenges across stories.
182 | *   **Key Actions:**
183 |     *   `addChallenge(challenge)`: Adds challenge locally, calls `@services/supabase.syncChallenge` (which handles challenge and questions), uses `syncQueue` on failure.
184 |     *   `getChallengesByStoryId(storyId)`: Filters challenges for a specific story.
185 |     *   `loadChallengesFromSupabase(storyId)`: Fetches challenges for a *specific story* via `@services/supabase.getStoryChallenges`. Called on demand.
186 | *   **Supabase Interaction:** Calls `syncChallenge`, `getStoryChallenges`, `syncQueue`.
187 | 
188 | ## 4. Supabase Interaction Layer
189 | 
190 | *   **`@services/supabaseClient.ts`:** **Single source of truth.** Initializes and exports the `supabase` client instance. All other files needing the client *must* import it from here.
191 | *   **`@services/supabaseAuth.ts`:** Handles **authentication** operations ONLY (`signUp`, `login`, `logout`, `signInWithGoogle`, `getCurrentUser`, `requestPasswordReset`). It imports and uses the client from `@supabaseClient.ts`. It *does not* handle profile data or manual state tracking anymore.
192 | *   **`@services/supabase.ts`:** Handles **database operations** ONLY (CRUD for profiles, characters, stories, chapters, audio, challenges, voices). It imports and uses the client from `@supabaseClient.ts`. Relies heavily on Supabase RLS for security and data access control.
193 | *   **Reliance on RLS:** Security and data access rules (e.g., "user can only see their own stories", "user can only insert profile if ID matches auth ID") are primarily enforced by **Row Level Security (RLS) policies** defined directly in the Supabase database, *not* by client-side checks (which were removed).
194 | 
195 | ## 5. Context within the Application
196 | 
197 | *   **Initialization (`@main.ts`):** The entry point initializes the core app (`AppWithAuth`). `AppWithAuth` uses a `useEffect` hook to call `useUserStore.checkAuth()` on mount. After `checkAuth` completes, it calls `@services/syncService.initSyncService()`.
198 | *   **Sync Service (`@services/syncService.ts`):**
199 |     *   `initSyncService`: Called once by `main.ts`. Sets up listeners. Tries an initial sync.
200 |     *   `initSyncListeners`: Listens for `online` and `visibilitychange` events.
201 |     *   `syncUserData`: **Initiator function.** Called on initial load (if online) and by listeners. It verifies connection/session and then triggers the main loading flow by calling `useUserStore.checkAuth()`. **It no longer loads data directly.**
202 | *   **UI Components (`@components/`, `@pages/`):**
203 |     *   Interact with the state using Zustand hooks (e.g., `const { user, profileSettings } = useUserStore();`, `const { savedCharacters, saveCurrentCharacter } = useCharacterStore();`).
204 |     *   Subscribe to state changes and re-render automatically.
205 |     *   Call action functions from the stores (e.g., `saveCurrentCharacter()`, `setProfileSettings(...)`, `addGeneratedStory(...)`) to modify state and trigger backend synchronization.
206 |     *   Use selectors/state data (e.g., `profileSettings.subscription_status`, `profileSettings.voice_credits`) for **Feature Gating**: enabling/disabling buttons, showing/hiding options, displaying limits based on the user's plan.
207 | 
208 | ## 6. Common Issues & Pitfalls Encountered/Resolved
209 | 
210 | *   **RLS Policies:**
211 |     *   **Missing `INSERT` Policy:** Forgetting to define an `INSERT` policy (e.g., for `profiles`) prevents record creation even if the user is authenticated. Solution: Add `CREATE POLICY ... FOR INSERT ... WITH CHECK (auth.uid() = id);`.
212 |     *   **Incorrect Conditions:** Ensure `USING` (for SELECT/UPDATE/DELETE) and `WITH CHECK` (for INSERT/UPDATE) conditions correctly use `auth.uid()` and match the appropriate columns (`id` or `user_id`).
213 | *   **Type Mismatches:**
214 |     *   **`ProfileSettings`:** The type definition in `@types.ts` *must* accurately reflect *all* columns fetched from the `profiles` table by `getUserProfile`, including Stripe/limit fields. Failure leads to TS errors and missing data in the store.
215 |     *   **DB Column Names:** Trying to insert/update a column name (e.g., `age_range`) in Supabase functions (`syncUserProfile`, `syncQueue.addToQueue`) or SQL Functions (`HandleNewUser`) that doesn't exist in the actual DB table causes runtime errors. Solution: Ensure code uses exact DB column names.
216 | *   **Redundant Data Loading:**
217 |     *   Avoid calling individual `load...FromSupabase` methods directly after `checkAuth` if `syncAllUserData` already handles it (e.g., removed in `syncService.ts`).
218 |     *   Avoid using `setTimeout` for initial data loading in stores (e.g., removed in `characterStore.ts`). Rely on the `checkAuth` -> `syncAllUserData` flow.
219 | *   **Supabase Client Initialization:**
220 |     *   Having multiple `createClient` calls leads to confusion and potential errors. Solution: Centralize client creation in `@supabaseClient.ts` and import it everywhere else. Ensure all `import { supabase }` statements point to this single file.
221 | *   **Timing Issues:**
222 |     *   **Post-`signUp` Profile Creation:** Calling profile creation (`syncUserProfile`) *immediately* after `signUp` might fail due to RLS not recognizing the new `auth.uid()` yet. Solution: Integrate profile creation into the standard `checkAuth` / `loginUser` flow, which ensures the session is fully established, or add a small delay/retry if absolutely necessary.
223 | *   **Forgetting Store Orchestration:**
224 |     *   When adding a new store that needs initial data loading, remember to add it to the `otherStores` array within the `syncAllUserData` function in `@userStore.ts`.
225 | *   **Offline Queue (`syncQueue`):**
226 |     *   Ensure data passed to `addToQueue` for `delete` operations contains the necessary `id`.
227 |     *   Stale/incorrect items stuck in `localStorage` can cause repeated errors. Solution: Clear the `sync_queue` key in `localStorage` during debugging if necessary.
228 | *   **SQL Function Security:**
229 |     *   Functions modifying sensitive data or called from untrusted contexts (like webhooks) should generally use `SECURITY DEFINER` (e.g., `increment_voice_credits`). Ensure appropriate `GRANT EXECUTE` permissions are set for the calling role (e.g., `service_role`). Trigger functions often use `INVOKER` or `DEFINER` depending on needs (`handle_new_user` needs `DEFINER`).
230 | 
231 | ## 7. Conclusion
232 | 
233 | This modular Zustand architecture, coupled with a well-defined data synchronization flow orchestrated by `userStore` and reliant on Supabase RLS, provides a robust foundation for the application. Maintaining consistency in Supabase client usage, type definitions, and the central data loading pattern is key to stability. Understanding the interaction between frontend stores, the Supabase service layer, and RLS policies is crucial for debugging and future development. Remember to manage SQL functions via Supabase Migrations for proper version control.
234 | 
235 | ## 8. Race Condition Fixes: Authentication and Story Loading
236 | 
237 | **Authentication Race Condition**
238 | 
239 | - Updated `checkAuth` signature to return `Promise<User | null>` instead of `Promise<boolean>`.
240 | - Refactored `AuthGuard.tsx` to use an internal `authStatus` (`'pending' | 'authenticated' | 'unauthenticated'`), awaiting `checkAuth()` result before rendering or redirecting.
241 | - Eliminated separate `authChecked` state and reliance on store `user` for decision-making.
242 | 
243 | **Story Loading Race Condition**
244 | 
245 | - Added `isLoadingStories: boolean` to `StoriesState` and initialized it in `storiesStore.ts`.
246 | - In `storiesStore.ts`, `loadStoriesFromSupabase` sets `isLoadingStories` to `true` at start and resets it to `false` in `finally`.
247 | - Updated `StoryViewer.tsx` to depend on `isLoadingStories` in its main `useEffect`, exiting early if `true`, and rendering a loading spinner until stories are loaded. Navigation to `/not-found` only occurs if the story remains `undefined` after loading.
248 | 
249 | ## 9. Flujo de Parámetros Contextuales en la Generación de Opciones de Continuación
250 | 
251 | ### 3.2. `@store/stories/storyGenerator.ts`
252 | 
253 | *   **Propósito:** Orquesta la generación de historias y la continuación de las mismas, gestionando tanto la creación inicial como la obtención de opciones de continuación adaptadas al usuario.
254 | *   **Estado Clave:**
255 |     *   `currentStory: Story | null`: Historia activa en el flujo.
256 |     *   `storyChapters: StoryChapter[]`: Capítulos generados hasta el momento.
257 |     *   `continuationOptions: Option[]`: Opciones generadas para continuar la historia, adaptadas al contexto del usuario.
258 | *   **Acciones Clave:**
259 |     *   `generateOptions()`: Llama a `StoryContinuationService.generateContinuationOptions`, pasando además de la historia y capítulos, los parámetros contextuales:
260 |         - `childAge`: Edad del niño/a (desde `profileSettings`).
261 |         - `specialNeed`: Necesidad especial del usuario (desde `profileSettings`).
262 |         - `language`: Idioma preferido del usuario (desde `profileSettings` o historia).
263 |     *   El store se encarga de obtener estos valores desde `userStore.profileSettings` y asegurarse de que se pasan correctamente al servicio y a la Edge Function.
264 | *   **Flujo de Datos:**
265 |     1. El usuario inicia la generación de opciones de continuación desde la UI.
266 |     2. El store recupera los valores de contexto del perfil del usuario.
267 |     3. Se invoca el método del servicio, que a su vez llama a la Edge Function con el prompt contextualizado.
268 |     4. Las opciones generadas se almacenan en el estado y se muestran en la UI.
269 | *   **Impacto:**
270 |     - Esto garantiza que las opciones de historia sean relevantes para la edad, necesidades y preferencias lingüísticas del usuario final, mejorando la personalización y adecuación del contenido.
```

docs/supabase-integration-guide.md
```
1 | # Guía de Integración con Supabase
2 | 
3 | ## Problemas Identificados
4 | 
5 | ### Problemas de Sincronización de Datos
6 | 
7 | 1. **Persistencia entre sesiones:**
8 |    - Los usuarios podían iniciar sesión, pero sus datos generados (historias,
9 |      personajes, etc.) no estaban correctamente vinculados a su cuenta.
10 |    - Cuando un usuario cerraba sesión e iniciaba con otra cuenta, veía el
11 |      contenido creado por el usuario anterior.
12 |    - Al limpiar el navegador o cambiar de dispositivo, los usuarios perdían
13 |      acceso a su contenido previamente creado.
14 | 
15 | 2. **Sobrescritura de personajes:**
16 |    - Cuando un usuario creaba un nuevo personaje, el anterior desaparecía.
17 |    - En lugar de mantener múltiples personajes por usuario, el sistema
18 |      reemplazaba el personaje anterior con el nuevo.
19 |    - Al cargar datos desde Supabase, se limpiaba el array de personajes
20 |      guardados antes de cargar.
21 |    - El uso incorrecto de `upsert` con `onConflict: 'id'` causaba que nuevos
22 |      personajes reemplazaran a los existentes.
23 | 
24 | 3. **Inconsistencia en IDs:**
25 |    - Algunos personajes no tenían IDs generados consistentemente.
26 |    - Faltaba validación en la creación de nuevos personajes para garantizar IDs
27 |      únicos.
28 |    - No se separaban claramente las operaciones de creación y actualización.
29 | 
30 | 4. **Filtración de datos entre usuarios:**
31 |    - Los personajes de otros usuarios aparecían en la interfaz después de
32 |      cambiar de cuenta.
33 |    - La función de limpieza de localStorage (`cleanPreviousUserStores`) estaba
34 |      deshabilitada.
35 |    - Las operaciones de carga no filtraban correctamente por el ID del usuario
36 |      actual.
37 |    - Los datos del usuario anterior permanecían en localStorage después de
38 |      iniciar sesión con una nueva cuenta.
39 | 
40 | ## Soluciones Implementadas
41 | 
42 | ### 1. Arquitectura de Sincronización Mejorada
43 | 
44 | Hemos rediseñado la arquitectura de sincronización para asegurar que:
45 | 
46 | 1. Cada usuario tenga sus propios datos separados tanto en el almacenamiento
47 |    local como en Supabase
48 | 2. Los datos se vinculen correctamente a cada usuario por su ID
49 | 3. La sincronización funcione de manera bidireccional para mantener la
50 |    persistencia de los datos
51 | 
52 | #### Nombres de Store Vinculados al Usuario
53 | 
54 | Modificamos `createPersistentStore` para incluir el ID del usuario en el nombre
55 | del store de Zustand:
56 | 
57 | ```typescript
58 | export const createPersistentStore = <T>(
59 |     initialState: Partial<T>,
60 |     storeLogic: (set: Function, get: Function) => Partial<T>,
61 |     storeName: string,
62 | ) => {
63 |     return create<T>()(
64 |         persist(
65 |             (set, get) =>
66 |                 ({
67 |                     ...initialState,
68 |                     ...storeLogic(set, get),
69 |                 }) as T,
70 |             {
71 |                 name: getStoreNameWithUserId(storeName),
72 |                 // ...
73 |             },
74 |         ),
75 |     );
76 | };
77 | ```
78 | 
79 | De esta forma, cada usuario tiene sus propios stores en localStorage, evitando
80 | mezclar datos entre usuarios.
81 | 
82 | #### Validación de Usuario en Cada Operación
83 | 
84 | Implementamos una validación estricta de seguridad en las operaciones de
85 | Supabase:
86 | 
87 | ```typescript
88 | const validateUserId = async (providedUserId: string): Promise<boolean> => {
89 |     // Verifica que el ID de usuario proporcionado coincida con el usuario autenticado
90 |     // ...
91 |     return isValid;
92 | };
93 | ```
94 | 
95 | Esta función se utiliza en cada operación de Supabase para asegurar que:
96 | 
97 | - El usuario está autenticado
98 | - El usuario está intentando acceder/modificar solo sus propios datos
99 | 
100 | #### Limpieza de Datos al Cambiar de Usuario
101 | 
102 | Cuando un usuario cierra sesión o un nuevo usuario inicia sesión, limpiamos
103 | todos los datos del usuario anterior:
104 | 
105 | ```typescript
106 | export const cleanPreviousUserStores = (currentUserId: string) => {
107 |     console.log(`Limpiando stores previos para usuario: ${currentUserId}`);
108 | 
109 |     let cleaned = 0;
110 |     for (let i = 0; i < localStorage.length; i++) {
111 |         const key = localStorage.key(i);
112 |         if (key && key.startsWith("story-app-")) {
113 |             // Si no es una clave del usuario actual y no es la clave global de usuario
114 |             if (
115 |                 !key.includes(`-${currentUserId}-`) &&
116 |                 !key.includes("story-app-user")
117 |             ) {
118 |                 console.log(`Eliminando store: ${key}`);
119 |                 localStorage.removeItem(key);
120 |                 i--; // Ajustar el índice
121 |                 cleaned++;
122 |             }
123 |         }
124 |     }
125 |     console.log(`Se limpiaron ${cleaned} stores anteriores`);
126 | };
127 | ```
128 | 
129 | Este proceso es fundamental para garantizar que el usuario actual solo ve sus
130 | propios datos y no los de usuarios anteriores. La causa principal de la
131 | filtración de datos entre usuarios era que esta función estaba comentada en el
132 | código.
133 | 
134 | #### Carga de Datos Filtrada por Usuario
135 | 
136 | Para garantizar que solo se cargan los datos del usuario actual, cada función de
137 | carga desde Supabase:
138 | 
139 | 1. Verifica que el usuario esté autenticado
140 | 2. Limpia los datos existentes antes de cargar nuevos
141 | 3. Filtra explícitamente por el ID del usuario actual en las consultas a
142 |    Supabase
143 | 
144 | ```typescript
145 | const loadCharactersFromSupabase = async (userId: string) => {
146 |     try {
147 |         // Primero, limpiar el array existente para evitar mezclar personajes
148 |         set({ savedCharacters: [] });
149 | 
150 |         // Log para depuración
151 |         console.log(
152 |             `[DEBUG] Consultando personajes SOLO para el usuario con ID: ${userId}`,
153 |         );
154 | 
155 |         const { success, characters } = await getUserCharacters(userId);
156 | 
157 |         if (success && characters) {
158 |             // Establecer solo los personajes recuperados de Supabase
159 |             set({ savedCharacters: characters });
160 |         }
161 |     } catch (error) {
162 |         console.error(
163 |             `Error cargando personajes desde Supabase para usuario ${userId}:`,
164 |             error,
165 |         );
166 |     }
167 | };
168 | ```
169 | 
170 | #### Sincronización Bidireccional
171 | 
172 | La sincronización bidireccional asegura que:
173 | 
174 | 1. Los datos creados localmente se sincronizan con Supabase
175 | 2. Al iniciar sesión, los datos se cargan desde Supabase
176 | 
177 | Por ejemplo, en `userStore.ts`:
178 | 
179 | ```typescript
180 | syncAllUserData(user.id);
181 | ```
182 | 
183 | Este método carga todos los datos del usuario desde Supabase, incluyendo
184 | historias, personajes, etc.
185 | 
186 | ### 2. Corrección de la Gestión de Personajes
187 | 
188 | Para solucionar el problema de sobrescritura de personajes, implementamos los
189 | siguientes cambios:
190 | 
191 | #### Función `syncCharacter` mejorada
192 | 
193 | En lugar de usar `upsert` con `onConflict: 'id'`, que sobrescribía personajes
194 | existentes, modificamos la función para decidir explícitamente entre actualizar
195 | o insertar:
196 | 
197 | ```typescript
198 | export const syncCharacter = async (
199 |     userId: string,
200 |     character: StoryCharacter,
201 | ) => {
202 |     try {
203 |         // Verificar si ya existe un personaje con ese ID
204 |         const { data: existingChar, error: existingError } = await supabase
205 |             .from("characters")
206 |             .select("id, name, user_id")
207 |             .eq("id", character.id)
208 |             .maybeSingle();
209 | 
210 |         // Preparar datos para guardar
211 |         const characterData = {
212 |             id: character.id,
213 |             user_id: userId,
214 |             name: character.name,
215 |             hobbies: character.hobbies,
216 |             description: character.description,
217 |             profession: character.profession,
218 |             character_type: character.characterType,
219 |             personality: character.personality,
220 |             updated_at: new Date(),
221 |         };
222 | 
223 |         let result;
224 | 
225 |         // Si el personaje ya existe, actualizarlo; si no, insertarlo como nuevo
226 |         if (existingChar) {
227 |             // Si el personaje pertenece a otro usuario, no permitir sobreescribirlo
228 |             if (existingChar.user_id !== userId) {
229 |                 return {
230 |                     success: false,
231 |                     error: new Error(
232 |                         "No tienes permiso para modificar este personaje",
233 |                     ),
234 |                 };
235 |             }
236 | 
237 |             // Actualizar el personaje existente
238 |             result = await supabase
239 |                 .from("characters")
240 |                 .update(characterData)
241 |                 .eq("id", character.id)
242 |                 .eq("user_id", userId);
243 |         } else {
244 |             // Insertar nuevo personaje
245 |             result = await supabase
246 |                 .from("characters")
247 |                 .insert(characterData);
248 |         }
249 | 
250 |         // Resto del código...
251 |     } catch (error) {
252 |         // Manejo de errores...
253 |     }
254 | };
255 | ```
256 | 
257 | #### Preservación de personajes al cargar desde Supabase
258 | 
259 | Modificamos la función `loadCharactersFromSupabase` para no limpiar la lista de
260 | personajes antes de cargar:
261 | 
262 | ```typescript
263 | const loadCharactersFromSupabase = async (userId: string) => {
264 |     try {
265 |         // Ya no limpiamos el array antes de cargar para evitar sobreescribir
266 |         // set({ savedCharacters: [] });  <- ELIMINADO
267 | 
268 |         const { success, characters } = await getUserCharacters(userId);
269 | 
270 |         if (success && characters) {
271 |             // En lugar de reemplazar todo, actualizar los existentes y agregar los nuevos
272 |             set((state) => {
273 |                 const currentCharacters = [...state.savedCharacters];
274 |                 const updatedCharacters = [...currentCharacters];
275 | 
276 |                 // Actualizar o agregar personajes nuevos
277 |                 characters.forEach((character) => {
278 |                     const existingIndex = currentCharacters.findIndex((c) =>
279 |                         c.id === character.id
280 |                     );
281 |                     if (existingIndex >= 0) {
282 |                         // Actualizar existente
283 |                         updatedCharacters[existingIndex] = character;
284 |                     } else {
285 |                         // Agregar nuevo
286 |                         updatedCharacters.push(character);
287 |                     }
288 |                 });
289 | 
290 |                 return { savedCharacters: updatedCharacters };
291 |             });
292 |         }
293 |     } catch (error) {
294 |         // Manejo de errores...
295 |     }
296 | };
297 | ```
298 | 
299 | #### Generación consistente de IDs para nuevos personajes
300 | 
301 | Mejoramos la función `resetCharacter` para garantizar IDs únicos:
302 | 
303 | ```typescript
304 | resetCharacter: (() => {
305 |     console.log("Reseteando personaje actual con nuevo ID");
306 |     const newId = generateId("char");
307 |     console.log(`Nuevo ID generado: ${newId}`);
308 | 
309 |     // Crear un personaje completamente vacío con un nuevo ID
310 |     set({
311 |         currentCharacter: {
312 |             id: newId,
313 |             name: "",
314 |             hobbies: [],
315 |             description: "",
316 |             profession: "",
317 |             characterType: "",
318 |             personality: "",
319 |         },
320 |     });
321 | });
322 | ```
323 | 
324 | También aseguramos que al crear un nuevo personaje siempre se llame a
325 | `resetCharacter`:
326 | 
327 | ```typescript
328 | const handleCreateNewCharacter = () => {
329 |     // Resetear el personaje actual para asegurar un ID único
330 |     const { resetCharacter } = useCharacterStore.getState();
331 |     resetCharacter();
332 |     navigate("/character-name");
333 | };
334 | ```
335 | 
336 | ## Flujo de Datos
337 | 
338 | ### 1. Ciclo de vida de la autenticación
339 | 
340 | #### Inicio de Sesión
341 | 
342 | - Usuario inicia sesión/se registra
343 | - El ID de usuario se almacena globalmente con `setCurrentAuthUser`
344 | - Se configuran los nombres de store con el ID de usuario
345 | - Se cargan los datos del usuario desde Supabase
346 | 
347 | #### Durante la sesión
348 | 
349 | - Los stores mantienen estado local y se sincronizan periódicamente con Supabase
350 | - Las operaciones críticas se sincronizan inmediatamente
351 | - Operaciones fallidas se agregan a la cola de sincronización
352 | 
353 | #### Cierre de Sesión
354 | 
355 | - Se sincronizan datos pendientes con Supabase
356 | - Se resetea el ID de usuario global con `setCurrentAuthUser(null)`
357 | - Se limpian los datos locales del usuario
358 | 
359 | ### 2. Ciclo de vida de un personaje
360 | 
361 | 1. **Creación:**
362 |    - Al iniciar la creación, se genera un ID único con `resetCharacter()`
363 |    - El usuario completa la información del personaje a través de varios pasos
364 |    - Cada actualización llama a `updateCharacter()` que preserva el ID
365 |    - Al finalizar, se llama a `saveCurrentCharacter()` que:
366 |      - Guarda localmente el personaje con su ID en `savedCharacters`
367 |      - Sincroniza con Supabase usando `syncCharacter()`
368 | 
369 | 2. **Carga:**
370 |    - Al iniciar sesión o entrar a la pantalla de selección, se cargan personajes
371 |      con `loadCharactersFromSupabase()`
372 |    - La función mantiene personajes existentes y agrega/actualiza nuevos
373 |    - Cada personaje mantiene su ID único
374 | 
375 | 3. **Selección:**
376 |    - Al seleccionar un personaje existente, se usa
377 |      `selectCharacter(characterId)`
378 |    - Esto establece el personaje actual sin modificar su ID
379 | 
380 | 4. **Actualización:**
381 |    - Al editar un personaje existente, se usa su ID original
382 |    - Los cambios se sincronizan con Supabase manteniendo el mismo ID
383 | 
384 | 5. **Eliminación:**
385 |    - Se elimina localmente y en Supabase mediante `deleteCharacter(characterId)`
386 |    - Se verifica que el usuario sea el propietario antes de permitir la
387 |      eliminación
388 | 
389 | ## Verificaciones de Seguridad
390 | 
391 | ### 1. Validación de Propiedad y Permisos
392 | 
393 | Cada operación en Supabase verifica que:
394 | 
395 | - El usuario esté autenticado
396 | - El ID de usuario coincida con el token de autenticación
397 | - El usuario solo acceda a sus propios datos
398 | 
399 | ```typescript
400 | // Verificar que el recurso pertenezca al usuario actual
401 | const { data } = await supabase
402 |     .from("resource_table")
403 |     .select("user_id")
404 |     .eq("id", resourceId)
405 |     .single();
406 | 
407 | if (!data || data.user_id !== userId) {
408 |     return {
409 |         success: false,
410 |         error: new Error("No tienes permiso para esta operación"),
411 |     };
412 | }
413 | ```
414 | 
415 | ### 2. Políticas de Seguridad en Supabase (RLS)
416 | 
417 | Las políticas RLS (Row Level Security) en Supabase son cruciales para restringir
418 | el acceso a nivel de base de datos:
419 | 
420 | ```sql
421 | -- Ejemplo de políticas RLS para personajes
422 | CREATE POLICY "Los usuarios pueden ver sus propios personajes" ON public.characters
423 |   FOR SELECT USING (auth.uid() = user_id);
424 | CREATE POLICY "Los usuarios pueden crear sus propios personajes" ON public.characters
425 |   FOR INSERT WITH CHECK (auth.uid() = user_id);
426 | CREATE POLICY "Los usuarios pueden actualizar sus propios personajes" ON public.characters
427 |   FOR UPDATE USING (auth.uid() = user_id);
428 | CREATE POLICY "Los usuarios pueden eliminar sus propios personajes" ON public.characters
429 |   FOR DELETE USING (auth.uid() = user_id);
430 | ```
431 | 
432 | ### 3. Validación de IDs
433 | 
434 | Aseguramos que:
435 | 
436 | - Cada personaje tenga un ID único mediante `generateId("char")`
437 | - Se valide el formato y estructura de los IDs
438 | - No se permita la modificación de IDs una vez asignados
439 | 
440 | ## Patrones y Mejores Prácticas
441 | 
442 | ### 1. Patrones de Arquitectura
443 | 
444 | #### Patrón de Store con Cache y Sincronización
445 | 
446 | - Almacenamiento local para operaciones rápidas (Zustand + localStorage)
447 | - Sincronización con la base de datos remota (Supabase)
448 | - Cola de sincronización para operaciones fallidas
449 | 
450 | #### Patrón de Validación en Capas
451 | 
452 | - Validación en UI (front-end)
453 | - Validación en el servicio (lógica de negocio)
454 | - Validación en la base de datos (RLS en Supabase)
455 | 
456 | ### 2. Mejores Prácticas
457 | 
458 | #### Gestión de IDs
459 | 
460 | - Generar IDs únicos en el cliente para poder trabajar offline
461 | - Usar un formato consistente para los IDs (prefijos, UUIDs, etc.)
462 | - Verificar la unicidad de los IDs antes de insertar
463 | 
464 | #### Operaciones de Actualización vs Inserción
465 | 
466 | - Ser explícito sobre cuando actualizar o insertar (no usar `upsert`
467 |   automáticamente)
468 | - Verificar la existencia y propiedad antes de actualizar
469 | 
470 | #### Limpieza de Datos
471 | 
472 | - No limpiar colecciones completas antes de cargar nueva data
473 | - Usar actualizaciones incrementales/diferenciales
474 | - Mantener una estrategia de merge clara para conflictos
475 | 
476 | #### Logs y Depuración
477 | 
478 | - Incluir logs detallados para las operaciones de sincronización
479 | - Usar identificadores de sesión para agrupar logs relacionados
480 | - Registrar errores con contexto suficiente para diagnosticar problemas
481 | 
482 | ## Errores Comunes a Evitar
483 | 
484 | ### 1. Sobrescritura de Datos
485 | 
486 | #### ❌ Error: Limpiar colecciones antes de cargar
487 | 
488 | ```typescript
489 | // Incorrecto: Elimina todos los personajes existentes
490 | set({ savedCharacters: [] });
491 | const { success, characters } = await getUserCharacters(userId);
492 | if (success && characters) {
493 |     set({ savedCharacters: characters });
494 | }
495 | ```
496 | 
497 | #### ✅ Solución: Actualizar de forma incremental
498 | 
499 | ```typescript
500 | const { success, characters } = await getUserCharacters(userId);
501 | if (success && characters) {
502 |     set((state) => {
503 |         const currentCharacters = [...state.savedCharacters];
504 |         // Actualizar existentes y agregar nuevos...
505 |         return { savedCharacters: updatedCharacters };
506 |     });
507 | }
508 | ```
509 | 
510 | **Nota:** En el caso específico de cambio de usuario, sí es recomendable limpiar
511 | completamente los datos antes de cargar los del nuevo usuario, pero esto debe
512 | hacerse en el proceso de login/logout, no en cada operación de carga.
513 | 
514 | ### 2. Uso incorrecto de `upsert`
515 | 
516 | #### ❌ Error: Usar upsert sin control adecuado
517 | 
518 | ```typescript
519 | // Incorrecto: Puede sobrescribir datos no intencionalmente
520 | const { error } = await supabase
521 |     .from("characters")
522 |     .upsert(characterData, { onConflict: "id" });
523 | ```
524 | 
525 | #### ✅ Solución: Decisión explícita entre actualizar o insertar
526 | 
527 | ```typescript
528 | // Verificar existencia primero
529 | const { data: existing } = await supabase
530 |     .from("characters")
531 |     .select("id")
532 |     .eq("id", characterId)
533 |     .maybeSingle();
534 | 
535 | // Luego decidir explícitamente
536 | if (existing) {
537 |     // Actualizar
538 |     await supabase.from("characters").update(data).eq("id", characterId);
539 | } else {
540 |     // Insertar
541 |     await supabase.from("characters").insert(data);
542 | }
543 | ```
544 | 
545 | ### 3. No validar propiedad antes de operaciones
546 | 
547 | #### ❌ Error: Actualizar sin verificar propiedad
548 | 
549 | ```typescript
550 | // Incorrecto: No verifica si el usuario es propietario
551 | await supabase
552 |     .from("characters")
553 |     .update(characterData)
554 |     .eq("id", characterId);
555 | ```
556 | 
557 | #### ✅ Solución: Verificar propiedad primero
558 | 
559 | ```typescript
560 | // Verificar propiedad
561 | const { data } = await supabase
562 |     .from("characters")
563 |     .select("user_id")
564 |     .eq("id", characterId)
565 |     .single();
566 | 
567 | if (!data || data.user_id !== userId) {
568 |     return { success: false, error: "No tienes permiso" };
569 | }
570 | 
571 | // Luego actualizar
572 | await supabase
573 |     .from("characters")
574 |     .update(characterData)
575 |     .eq("id", characterId)
576 |     .eq("user_id", userId); // Doble verificación
577 | ```
578 | 
579 | ### 4. No manejar IDs consistentemente
580 | 
581 | #### ❌ Error: Generación inconsistente de IDs
582 | 
583 | ```typescript
584 | // Incorrecto: No garantiza unicidad entre sesiones
585 | const id = Math.random().toString();
586 | // o
587 | const id = new Date().getTime().toString();
588 | ```
589 | 
590 | #### ✅ Solución: Usar generación de IDs consistente
591 | 
592 | ```typescript
593 | // Recomendado: UUID v4 o similar con prefijo para categorizar
594 | import { v4 as uuidv4 } from "uuid";
595 | const id = `char_${uuidv4()}`;
596 | // o
597 | const generateId = (prefix: string) => `${prefix}_${uuidv4()}`;
598 | const id = generateId("char");
599 | ```
600 | 
601 | ### 5. No limpiar datos de usuarios anteriores
602 | 
603 | #### ❌ Error: Comentar o deshabilitar la limpieza de localStorage
604 | 
605 | ```typescript
606 | // Incorrecto: La función está comentada o deshabilitada
607 | export const cleanPreviousUserStores = (currentUserId: string) => {
608 |     console.log(
609 |         `[DEBUG] DESACTIVADO - Limpiando stores previos para usuario: ${currentUserId}`,
610 |     );
611 |     /*
612 |   let cleaned = 0;
613 |   for (let i = 0; i < localStorage.length; i++) {
614 |     // Código de limpieza...
615 |   }
616 |   */
617 | };
618 | ```
619 | 
620 | #### ✅ Solución: Mantener activa la limpieza de localStorage
621 | 
622 | ```typescript
623 | // Correcto: Activamente limpia los datos de usuarios anteriores
624 | export const cleanPreviousUserStores = (currentUserId: string) => {
625 |     console.log(`Limpiando stores previos para usuario: ${currentUserId}`);
626 | 
627 |     let cleaned = 0;
628 |     for (let i = 0; i < localStorage.length; i++) {
629 |         const key = localStorage.key(i);
630 |         if (key && key.startsWith("story-app-")) {
631 |             // Si no es una clave del usuario actual y no es la clave global de usuario
632 |             if (
633 |                 !key.includes(`-${currentUserId}-`) &&
634 |                 !key.includes("story-app-user")
635 |             ) {
636 |                 console.log(`Eliminando store: ${key}`);
637 |                 localStorage.removeItem(key);
638 |                 i--; // Ajustar el índice
639 |                 cleaned++;
640 |             }
641 |         }
642 |     }
643 |     console.log(`Se limpiaron ${cleaned} stores anteriores`);
644 | };
645 | ```
646 | 
647 | Este paso es crítico para evitar la filtración de datos entre usuarios. Sin esta
648 | limpieza, los personajes y otros datos de usuarios anteriores permanecerán en
649 | localStorage y podrían mezclarse con los datos del usuario actual.
650 | 
651 | ## Para Desarrolladores
652 | 
653 | ### 1. Creación de Nuevos Stores
654 | 
655 | - Usa siempre `createPersistentStore` para crear nuevos stores
656 | - Implementa funciones de carga desde Supabase (`loadXXXFromSupabase`)
657 | - Agrega la sincronización al método `syncAllUserData` en userStore
658 | - Asegúrate de que tu función de carga haga limpieza de datos existentes al
659 |   cambiar de usuario
660 | 
661 | ### 2. Nuevas Tablas en Supabase
662 | 
663 | - Asegúrate que cada tabla tenga un campo `user_id`
664 | - Implementa políticas de seguridad RLS (Row Level Security) en Supabase para
665 |   cada operación (SELECT, INSERT, UPDATE, DELETE)
666 | - Valida siempre el `user_id` en las consultas
667 | - Utiliza el filtro `.eq("user_id", userId)` en todas las consultas
668 | 
669 | ### 3. Verificación de Estado de Autenticación
670 | 
671 | - Usa `useUserStore.getState().user` para verificar si hay un usuario
672 |   autenticado
673 | - Para operaciones críticas, verifica también con `supabase.auth.getSession()`
674 | - Incluye timeout y manejo de errores para las verificaciones de autenticación
675 | 
676 | ### 4. Gestión de Errores de Sincronización
677 | 
678 | - Utiliza `syncQueue.addToQueue()` para operaciones que fallan
679 | - Implementa reintentos para operaciones críticas
680 | - Proporciona feedback al usuario cuando sea apropiado
681 | 
682 | ## Posibles Mejoras Futuras
683 | 
684 | 1. Implementar una estrategia de sincronización offline/online más robusta
685 |    - Indicadores visuales de estado de sincronización
686 |    - Resincronización automática cuando se recupera la conexión
687 | 
688 | 2. Mejorar el manejo de conflictos cuando se modifican datos en múltiples
689 |    dispositivos
690 |    - Estrategia basada en timestamps para resolución de conflictos
691 |    - UI para resolución manual de conflictos en casos críticos
692 | 
693 | 3. Implementar pruebas automatizadas para la sincronización
694 |    - Tests unitarios para funciones de sincronización
695 |    - Tests de integración para el flujo completo
696 | 
697 | 4. Agregar eventos para notificar a la UI sobre estados de sincronización
698 |    - Sistema de eventos centralizado para estados (en progreso, completado,
699 |      error)
700 |    - Toast notifications para errores críticos de sincronización
701 | 
702 | 5. Optimización de rendimiento
703 |    - Batch updates para sincronización masiva
704 |    - Sincronización diferencial (solo enviar cambios, no objetos completos)
705 |    - Compresión de datos para reducir el tamaño de las transferencias
706 | 
707 | ## Gestión de Presets de Historias
708 | 
709 | Se ha introducido una nueva funcionalidad para ofrecer sugerencias (presets) aleatorias a los usuarios al momento de detallar su historia. Esta función utiliza una tabla específica en Supabase.
710 | 
711 | ### Tabla `preset_suggestions`
712 | 
713 | Esta tabla almacena las sugerencias de texto que se mostrarán a los usuarios.
714 | 
715 | -   **Propósito**: Contener textos predefinidos que sirvan de inspiración o punto de partida para la descripción de la historia.
716 | -   **Estructura Clave**:
717 |     -   `id`: Identificador único del preset.
718 |     -   `text_prompt`: El texto de la sugerencia.
719 |     -   `is_active`: Booleano que indica si el preset debe mostrarse (permite desactivar presets sin borrarlos).
720 | -   **Datos Iniciales**: Se cargan mediante el script `docs/supabase_presets_data.sql`.
721 | 
722 | ### Integración con el Frontend (`StoryDetailsInput.tsx`)
723 | 
724 | El componente `StoryDetailsInput.tsx` ahora incluye lógica para:
725 | 
726 | 1.  **Obtener Presets**: Al montar el componente, se realiza una llamada a Supabase para obtener todos los presets activos (`is_active = true`).
727 |     ```typescript
728 |     const { data, error } = await supabase
729 |       .from('preset_suggestions')
730 |       .select('id, text_prompt')
731 |       .eq('is_active', true);
732 |     ```
733 | 2.  **Almacenamiento Local**: Los presets obtenidos se guardan en el estado local del componente para evitar llamadas repetidas a la base de datos.
734 | 3.  **Selección Aleatoria**: Se seleccionan 3 presets aleatorios de la lista almacenada para mostrarlos al usuario.
735 | 4.  **Actualización**: Un botón permite al usuario obtener un nuevo conjunto de 3 presets aleatorios sin necesidad de recargar la página.
736 | 5.  **Uso del Preset**: Al hacer clic en un preset, su texto (`text_prompt`) se copia en el área de texto principal (`textarea`) para que el usuario pueda usarlo o modificarlo.
737 | 
738 | ### Seguridad (RLS)
739 | 
740 | Se ha configurado una política de seguridad a nivel de fila (RLS) para la tabla `preset_suggestions` que permite a cualquier usuario autenticado leer (`SELECT`) únicamente los presets que estén marcados como activos (`is_active = true`). Esto asegura que solo se muestren las sugerencias relevantes y aprobadas. Consulta `docs/supabase_RLS.sql` para ver la política específica.
```

docs/supabase_RLS.sql
```
1 | -- Habilitar RLS para todas las tablas relevantes (Asegúrate de que RLS esté habilitado para cada tabla)
2 | -- Ejemplo: ALTER TABLE public.characters ENABLE ROW LEVEL SECURITY;
3 | --          ALTER TABLE public.stories ENABLE ROW LEVEL SECURITY;
4 | --          ... y así sucesivamente para todas las tablas con políticas ...
5 | -- (Nota: Supabase suele habilitar RLS por defecto al crear políticas desde la UI,
6 | --  pero es bueno verificarlo si las creas por SQL)
7 | 
8 | -- Políticas para la tabla characters
9 | CREATE POLICY "Los usuarios pueden ver sus propios personajes"
10 | ON public.characters
11 | FOR SELECT
12 | TO authenticated
13 | USING (auth.uid() = user_id);
14 | 
15 | CREATE POLICY "Los usuarios pueden crear sus propios personajes"
16 | ON public.characters
17 | FOR INSERT
18 | TO authenticated
19 | WITH CHECK (auth.uid() = user_id);
20 | 
21 | CREATE POLICY "Los usuarios pueden actualizar sus propios personajes"
22 | ON public.characters
23 | FOR UPDATE
24 | TO authenticated
25 | USING (auth.uid() = user_id)
26 | WITH CHECK (auth.uid() = user_id);
27 | 
28 | CREATE POLICY "Los usuarios pueden eliminar sus propios personajes"
29 | ON public.characters
30 | FOR DELETE
31 | TO authenticated
32 | USING (auth.uid() = user_id);
33 | 
34 | -- Políticas para la tabla stories
35 | CREATE POLICY "Los usuarios pueden ver sus propias historias"
36 | ON public.stories
37 | FOR SELECT
38 | TO authenticated
39 | USING (auth.uid() = user_id);
40 | 
41 | CREATE POLICY "Los usuarios pueden crear sus propias historias"
42 | ON public.stories
43 | FOR INSERT
44 | TO authenticated
45 | WITH CHECK (auth.uid() = user_id);
46 | 
47 | CREATE POLICY "Los usuarios pueden actualizar sus propias historias"
48 | ON public.stories
49 | FOR UPDATE
50 | TO authenticated
51 | USING (auth.uid() = user_id)
52 | WITH CHECK (auth.uid() = user_id);
53 | 
54 | CREATE POLICY "Los usuarios pueden eliminar sus propias historias"
55 | ON public.stories
56 | FOR DELETE
57 | TO authenticated
58 | USING (auth.uid() = user_id);
59 | 
60 | -- Políticas para la tabla audio_files
61 | CREATE POLICY "Los usuarios pueden ver sus archivos de audio"
62 | ON public.audio_files
63 | FOR SELECT
64 | TO authenticated
65 | USING (auth.uid() = user_id);
66 | 
67 | CREATE POLICY "Los usuarios pueden crear sus archivos de audio"
68 | ON public.audio_files
69 | FOR INSERT
70 | TO authenticated
71 | WITH CHECK (auth.uid() = user_id);
72 | 
73 | CREATE POLICY "Los usuarios pueden actualizar sus archivos de audio"
74 | ON public.audio_files
75 | FOR UPDATE
76 | TO authenticated
77 | USING (auth.uid() = user_id)
78 | WITH CHECK (auth.uid() = user_id);
79 | 
80 | CREATE POLICY "Los usuarios pueden eliminar sus archivos de audio"
81 | ON public.audio_files
82 | FOR DELETE
83 | TO authenticated
84 | USING (auth.uid() = user_id);
85 | 
86 | -- Políticas para la tabla story_chapters
87 | CREATE POLICY "Los usuarios pueden ver capítulos de sus historias"
88 | ON public.story_chapters
89 | FOR SELECT
90 | TO authenticated
91 | USING (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = story_chapters.story_id));
92 | 
93 | CREATE POLICY "Los usuarios pueden crear capítulos en sus historias"
94 | ON public.story_chapters
95 | FOR INSERT
96 | TO authenticated
97 | WITH CHECK (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = story_chapters.story_id));
98 | 
99 | CREATE POLICY "Los usuarios pueden actualizar capítulos de sus historias"
100 | ON public.story_chapters
101 | FOR UPDATE
102 | TO authenticated
103 | USING (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = story_chapters.story_id))
104 | WITH CHECK (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = story_chapters.story_id));
105 | 
106 | CREATE POLICY "Los usuarios pueden eliminar capítulos de sus historias"
107 | ON public.story_chapters
108 | FOR DELETE
109 | TO authenticated
110 | USING (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = story_chapters.story_id));
111 | 
112 | -- Políticas para la tabla challenges
113 | CREATE POLICY "Los usuarios pueden ver desafíos de sus historias"
114 | ON public.challenges
115 | FOR SELECT
116 | TO authenticated
117 | USING (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = challenges.story_id));
118 | 
119 | CREATE POLICY "Los usuarios pueden crear desafíos en sus historias"
120 | ON public.challenges
121 | FOR INSERT
122 | TO authenticated
123 | WITH CHECK (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = challenges.story_id));
124 | 
125 | CREATE POLICY "Los usuarios pueden actualizar desafíos de sus historias"
126 | ON public.challenges
127 | FOR UPDATE
128 | TO authenticated
129 | USING (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = challenges.story_id))
130 | WITH CHECK (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = challenges.story_id));
131 | 
132 | CREATE POLICY "Los usuarios pueden eliminar desafíos de sus historias"
133 | ON public.challenges
134 | FOR DELETE
135 | TO authenticated
136 | USING (auth.uid() IN (SELECT stories.user_id FROM public.stories WHERE stories.id = challenges.story_id));
137 | 
138 | -- Políticas para la tabla challenge_questions
139 | CREATE POLICY "Los usuarios pueden ver preguntas de desafíos de sus historias"
140 | ON public.challenge_questions
141 | FOR SELECT
142 | TO authenticated
143 | USING (auth.uid() IN (SELECT s.user_id FROM public.stories s JOIN public.challenges c ON s.id = c.story_id WHERE c.id = challenge_questions.challenge_id));
144 | 
145 | CREATE POLICY "Los usuarios pueden crear preguntas en desafíos de sus historias"
146 | ON public.challenge_questions
147 | FOR INSERT
148 | TO authenticated
149 | WITH CHECK (auth.uid() IN (SELECT s.user_id FROM public.stories s JOIN public.challenges c ON s.id = c.story_id WHERE c.id = challenge_questions.challenge_id));
150 | 
151 | CREATE POLICY "Los usuarios pueden actualizar preguntas de desafíos de sus historias"
152 | ON public.challenge_questions
153 | FOR UPDATE
154 | TO authenticated
155 | USING (auth.uid() IN (SELECT s.user_id FROM public.stories s JOIN public.challenges c ON s.id = c.story_id WHERE c.id = challenge_questions.challenge_id))
156 | WITH CHECK (auth.uid() IN (SELECT s.user_id FROM public.stories s JOIN public.challenges c ON s.id = c.story_id WHERE c.id = challenge_questions.challenge_id));
157 | 
158 | CREATE POLICY "Los usuarios pueden eliminar preguntas de desafíos de sus historias"
159 | ON public.challenge_questions
160 | FOR DELETE
161 | TO authenticated
162 | USING (auth.uid() IN (SELECT s.user_id FROM public.stories s JOIN public.challenges c ON s.id = c.story_id WHERE c.id = challenge_questions.challenge_id));
163 | 
164 | -- Políticas para la tabla profiles
165 | CREATE POLICY "Allow authenticated users to read own profile"
166 | ON public.profiles
167 | FOR SELECT
168 | TO authenticated
169 | USING (auth.uid() = id);
170 | 
171 | CREATE POLICY "Allow authenticated users to update own profile"
172 | ON public.profiles
173 | FOR UPDATE
174 | TO authenticated
175 | USING (auth.uid() = id)
176 | WITH CHECK (auth.uid() = id);
177 | 
178 | CREATE POLICY "Allow authenticated users to insert own profile"
179 | ON public.profiles
180 | FOR INSERT
181 | TO authenticated
182 | WITH CHECK (auth.uid() = id);
183 | 
184 | -- Políticas para la tabla user_voices
185 | CREATE POLICY "Users can select their own voices"
186 | ON public.user_voices
187 | FOR SELECT
188 | TO authenticated
189 | USING (auth.uid() = user_id);
190 | 
191 | CREATE POLICY "Users can insert their own voices"
192 | ON public.user_voices
193 | FOR INSERT
194 | TO authenticated
195 | WITH CHECK (auth.uid() = user_id);
196 | 
197 | CREATE POLICY "Users can update their own voices"
198 | ON public.user_voices
199 | FOR UPDATE
200 | TO authenticated
201 | USING (auth.uid() = user_id)
202 | WITH CHECK (auth.uid() = user_id);
203 | 
204 | CREATE POLICY "Users can delete their own voices"
205 | ON public.user_voices
206 | FOR DELETE
207 | TO authenticated
208 | USING (auth.uid() = user_id);
209 | 
210 | -- Políticas para la tabla preset_suggestions
211 | CREATE POLICY "Allow authenticated read access to active presets"
212 | ON public.preset_suggestions
213 | FOR SELECT
214 | TO authenticated
215 | USING (is_active = true);
216 | 
217 | -- (Opcional: Si necesitas que los administradores puedan gestionar presets)
218 | -- CREATE POLICY "Allow admin full access to presets"
219 | -- ON public.preset_suggestions
220 | -- FOR ALL
221 | -- TO service_role -- O a un rol de administrador personalizado
222 | -- USING (true);
```

docs/supabase_presets_data.sql
```
1 | -- Datos iniciales para la tabla preset_suggestions
2 | -- Estos son los presets en español que se insertan por defecto
3 | 
4 | INSERT INTO public.preset_suggestions (text_prompt, language_code, is_active) VALUES
5 | ('Que ocurra en un bosque encantado.', 'es', true),
6 | ('Ambientar en una ciudad futurista.', 'es', true),
7 | ('En lo alto de una montaña nevada.', 'es', true),
8 | <...resto de los presets...>;
9 | 
10 | -- Este archivo puede ser ejecutado en el SQL Editor de Supabase
11 | -- para poblar la tabla con los presets iniciales
```

docs/supabase_tables.sql
```
1 | CREATE TABLE public.characters (
2 |   id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
3 |   user_id uuid NOT NULL,
4 |   name text NOT NULL,
5 |   hobbies text[] NOT NULL,
6 |   description text NOT NULL,
7 |   profession text NOT NULL,
8 |   character_type text NOT NULL,
9 |   personality text NULL,
10 |   created_at timestamp with time zone NOT NULL DEFAULT now(),
11 |   updated_at timestamp with time zone NOT NULL DEFAULT now(),
12 |   CONSTRAINT characters_pkey PRIMARY KEY (id),
13 |   CONSTRAINT characters_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
14 | );
15 | 
16 | CREATE TABLE public.stories (
17 |   id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
18 |   user_id uuid NOT NULL,
19 |   title text NOT NULL,
20 |   content text NOT NULL,
21 |   audio_url text NULL,
22 |   moral text NULL,
23 |   genre text NULL,
24 |   duration text NOT NULL,
25 |   character_id uuid NULL,
26 |   created_at timestamp with time zone NOT NULL DEFAULT now(),
27 |   updated_at timestamp with time zone NOT NULL DEFAULT now(),
28 |   additional_details text NULL,
29 |   CONSTRAINT stories_pkey PRIMARY KEY (id),
30 |   CONSTRAINT stories_character_id_fkey FOREIGN KEY (character_id) REFERENCES characters(id),
31 |   CONSTRAINT stories_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
32 | );
33 | 
34 | CREATE TABLE public.story_chapters (
35 |   id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
36 |   story_id uuid NOT NULL,
37 |   chapter_number integer NOT NULL,
38 |   title text NOT NULL,
39 |   content text NOT NULL,
40 |   generation_method text NULL,
41 |   custom_input text NULL,
42 |   created_at timestamp with time zone NOT NULL DEFAULT now(),
43 |   updated_at timestamp with time zone NOT NULL DEFAULT now(),
44 |   CONSTRAINT story_chapters_pkey PRIMARY KEY (id),
45 |   CONSTRAINT story_chapters_story_id_fkey FOREIGN KEY (story_id) REFERENCES stories(id)
46 | );
47 | 
48 | CREATE TABLE public.audio_files (
49 |   id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
50 |   user_id uuid NOT NULL,
51 |   story_id uuid NULL,
52 |   chapter_id uuid NULL,
53 |   voice_id text NOT NULL,
54 |   url text NOT NULL,
55 |   created_at timestamp with time zone NOT NULL DEFAULT now(),
56 |   CONSTRAINT audio_files_pkey PRIMARY KEY (id),
57 |   CONSTRAINT audio_files_chapter_id_fkey FOREIGN KEY (chapter_id) REFERENCES story_chapters(id),
58 |   CONSTRAINT audio_files_story_id_fkey FOREIGN KEY (story_id) REFERENCES stories(id),
59 |   CONSTRAINT audio_files_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
60 | );
61 | 
62 | CREATE TABLE public.challenges (
63 |   id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
64 |   story_id uuid NOT NULL,
65 |   created_at timestamp with time zone NOT NULL DEFAULT now(),
66 |   CONSTRAINT challenges_pkey PRIMARY KEY (id),
67 |   CONSTRAINT challenges_story_id_fkey FOREIGN KEY (story_id) REFERENCES stories(id)
68 | );
69 | 
70 | CREATE TABLE public.challenge_questions (
71 |   id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
72 |   challenge_id uuid NOT NULL,
73 |   question text NOT NULL,
74 |   options text[] NOT NULL,
75 |   correct_option_index integer NOT NULL,
76 |   explanation text NOT NULL,
77 |   category text NOT NULL,
78 |   target_language text NULL,
79 |   created_at timestamp with time zone NOT NULL DEFAULT now(),
80 |   CONSTRAINT challenge_questions_pkey PRIMARY KEY (id),
81 |   CONSTRAINT challenge_questions_challenge_id_fkey FOREIGN KEY (challenge_id) REFERENCES challenges(id)
82 | );
83 | 
84 | CREATE TABLE public.preset_suggestions (
85 |   id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
86 |   text_prompt text NOT NULL,
87 |   category text NULL,
88 |   language_code character varying(5) NOT NULL DEFAULT 'es'::character varying,
89 |   is_active boolean NOT NULL DEFAULT true,
90 |   created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
91 |   CONSTRAINT preset_suggestions_pkey PRIMARY KEY (id)
92 | );
93 | 
94 | CREATE TABLE public.profiles (
95 |   id uuid NOT NULL,
96 |   language text NOT NULL,
97 |   child_age integer NULL,
98 |   special_need text NULL,
99 |   created_at timestamp with time zone NOT NULL DEFAULT now(),
100 |   updated_at timestamp with time zone NOT NULL DEFAULT now(),
101 |   stripe_customer_id text NULL,
102 |   subscription_status text NULL,
103 |   voice_credits integer NOT NULL DEFAULT 0,
104 |   current_period_end timestamp with time zone NULL,
105 |   monthly_stories_generated integer NOT NULL DEFAULT 0,
106 |   subscription_id text NULL,
107 |   plan_id text NULL,
108 |   period_start_date timestamp with time zone NULL,
109 |   monthly_voice_generations_used integer NULL DEFAULT 0,
110 |   has_completed_setup boolean NOT NULL DEFAULT false,
111 |   CONSTRAINT profiles_pkey PRIMARY KEY (id),
112 |   CONSTRAINT profiles_stripe_customer_id_key UNIQUE (stripe_customer_id),
113 |   CONSTRAINT profiles_subscription_id_key UNIQUE (subscription_id),
114 |   CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
115 | );
116 | 
117 | CREATE TABLE public.user_voices (
118 |   id uuid NOT NULL DEFAULT extensions.uuid_generate_v4(),
119 |   user_id uuid NOT NULL,
120 |   voice_id text NOT NULL,
121 |   is_current boolean NULL DEFAULT false,
122 |   created_at timestamp with time zone NOT NULL DEFAULT now(),
123 |   updated_at timestamp with time zone NOT NULL DEFAULT now(),
124 |   CONSTRAINT user_voices_pkey PRIMARY KEY (id),
125 |   CONSTRAINT user_voices_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
126 | );
```

src/App.css
```
1 | #root {
2 |   max-width: 1280px;
3 |   margin: 0 auto;
4 |   padding: 2rem;
5 |   text-align: center;
6 | }
7 | 
8 | .logo {
9 |   height: 6em;
10 |   padding: 1.5em;
11 |   will-change: filter;
12 |   transition: filter 300ms;
13 | }
14 | 
15 | .logo:hover {
16 |   filter: drop-shadow(0 0 2em #BB79D1aa);
17 |   /* Morado TaleMe! */
18 | }
19 | 
20 | .logo.react:hover {
21 |   filter: drop-shadow(0 0 2em #7DC4E0aa);
22 |   /* Azul TaleMe! */
23 | }
24 | 
25 | @keyframes logo-spin {
26 |   from {
27 |     transform: rotate(0deg);
28 |   }
29 | 
30 |   to {
31 |     transform: rotate(360deg);
32 |   }
33 | }
34 | 
35 | @media (prefers-reduced-motion: no-preference) {
36 |   a:nth-of-type(2) .logo {
37 |     animation: logo-spin infinite 20s linear;
38 |   }
39 | }
40 | 
41 | .card {
42 |   padding: 2em;
43 | }
44 | 
45 | .read-the-docs {
46 |   color: #888;
47 | }
```

src/App.tsx
```
1 | import { Toaster } from "@/components/ui/toaster";
2 | import { Toaster as Sonner } from "@/components/ui/sonner";
3 | import { TooltipProvider } from "@/components/ui/tooltip";
4 | import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
5 | import { BrowserRouter, Routes, Route } from "react-router-dom";
6 | import { AnimatePresence } from "framer-motion";
7 | import AuthGuard from "./components/AuthGuard";
8 | import MainLayout from "./components/MainLayout";
9 | 
10 | // Pages
11 | import Welcome from "./pages/Welcome";
12 | import Login from "./pages/Login";
13 | import Signup from "./pages/Signup";
14 | import SignupSuccess from "./pages/SignupSuccess";
15 | // import ProfileSetup from "./pages/ProfileSetup"; 
16 | import Home from "./pages/Home";
17 | import CharacterSelection from "./pages/CharacterSelection";
18 | import CharacterName from "./pages/CharacterName";
19 | import CharacterHobbies from "./pages/CharacterHobbies";
20 | import CharacterPersonality from "./pages/CharacterPersonality";
21 | import CharacterProfession from "./pages/CharacterProfession";
22 | import DurationSelection from "./pages/DurationSelection";
23 | import StoryGenre from "./pages/StoryGenre";
24 | import StoryMoral from "./pages/StoryMoral";
25 | import GeneratingStory from "./pages/GeneratingStory";
26 | import StoryViewer from "./pages/StoryViewer";
27 | import StoryAudioPage from "./pages/StoryAudioPage";
28 | import StoryContinuation from "./pages/StoryContinuation";
29 | import SavedStories from "./pages/SavedStories";
30 | import ErrorPage from "./pages/ErrorPage";
31 | import NotFound from "./pages/NotFound";
32 | import AuthCallback from "./pages/AuthCallback";
33 | import CharactersManagement from "./pages/CharactersManagement";
34 | import PaymentSuccess from "./pages/PaymentSuccess";
35 | import PaymentCancel from "./pages/PaymentCancel";
36 | import StoryDetailsInput from "./pages/StoryDetailsInput";
37 | import TermsAndConditions from "./pages/TermsAndConditions";
38 | import PrivacyPolicy from "./pages/PrivacyPolicy";
39 | import Contact from "./pages/Contact";
40 | import Changelog from "./pages/Changelog";
41 | 
42 | // New Pages for Refactor
43 | import ProfileConfigPage from './pages/ProfileConfigPage';
44 | import SettingsPage from './pages/SettingsPage';
45 | import PlansPage from './pages/PlansPage';
46 | 
47 | const queryClient = new QueryClient();
48 | 
49 | const App = () => {
50 |   return (
51 |     <QueryClientProvider client={queryClient}>
52 |       <TooltipProvider>
53 |         <Toaster />
54 |         <Sonner />
55 |         <BrowserRouter>
56 |           <AnimatePresence mode="wait">
57 |             <MainLayout>
58 |               <Routes>
59 |                 {/* Public routes */}
60 |                 <Route path="/" element={<Welcome />} />
61 |                 <Route path="/login" element={<Login />} />
62 |                 <Route path="/signup" element={<Signup />} />
63 |                 <Route path="/signup-success" element={<SignupSuccess />} />
64 |                 <Route path="/error" element={<ErrorPage />} />
65 |                 <Route path="*" element={<NotFound />} />
66 |                 <Route path="/auth/callback" element={<AuthCallback />} />
67 |                 <Route path="/terms" element={<TermsAndConditions />} />
68 |                 <Route path="/privacy-policy" element={<PrivacyPolicy />} />
69 |                 <Route path="/contact" element={<Contact />} />
70 |                 <Route path="/changelog" element={<Changelog />} />
71 | 
72 |                 {/* Payment routes */}
73 |                 <Route path="/payment-success" element={<AuthGuard><PaymentSuccess /></AuthGuard>} />
74 |                 <Route path="/payment-cancel" element={<AuthGuard><PaymentCancel /></AuthGuard>} />
75 | 
76 |                 {/* Protected routes */}
77 |                 <Route path="/home" element={<AuthGuard><Home /></AuthGuard>} />
78 |                 <Route path="/duration" element={<AuthGuard><DurationSelection /></AuthGuard>} />
79 |                 <Route path="/characters-management" element={<AuthGuard><CharactersManagement /></AuthGuard>} />
80 |                 <Route path="/character-selection" element={<AuthGuard><CharacterSelection /></AuthGuard>} />
81 |                 <Route path="/character-name" element={<AuthGuard><CharacterName /></AuthGuard>} />
82 |                 <Route path="/character-hobbies" element={<AuthGuard><CharacterHobbies /></AuthGuard>} />
83 |                 <Route path="/character-personality" element={<AuthGuard><CharacterPersonality /></AuthGuard>} />
84 |                 <Route path="/character-profession" element={<AuthGuard><CharacterProfession /></AuthGuard>} />
85 |                 <Route path="/story-genre" element={<AuthGuard><StoryGenre /></AuthGuard>} />
86 |                 <Route path="/story-moral" element={<AuthGuard><StoryMoral /></AuthGuard>} />
87 |                 <Route path="/story-details-input" element={<AuthGuard><StoryDetailsInput /></AuthGuard>} />
88 |                 <Route path="/generating" element={<AuthGuard><GeneratingStory /></AuthGuard>} />
89 |                 <Route path="/story/:storyId" element={<AuthGuard><StoryViewer /></AuthGuard>} />
90 |                 <Route path="/story/:storyId/audio/:chapterId?" element={<AuthGuard><StoryAudioPage /></AuthGuard>} />
91 |                 <Route path="/story/:storyId/continue" element={<AuthGuard><StoryContinuation /></AuthGuard>} />
92 |                 <Route path="/stories" element={<AuthGuard><SavedStories /></AuthGuard>} />
93 | 
94 |                 {/* New Protected Routes */}
95 |                 <Route path="/profile-config" element={<AuthGuard><ProfileConfigPage /></AuthGuard>} />
96 |                 <Route path="/settings" element={<AuthGuard><SettingsPage /></AuthGuard>} />
97 |                 <Route path="/plans" element={<AuthGuard><PlansPage /></AuthGuard>} />
98 |               </Routes>
99 |             </MainLayout>
100 |           </AnimatePresence>
101 |         </BrowserRouter>
102 |       </TooltipProvider>
103 |     </QueryClientProvider>
104 |   );
105 | };
106 | 
107 | export default App;
```

src/index.css
```
1 | @tailwind base;
2 | @tailwind components;
3 | @tailwind utilities;
4 | 
5 | @layer base {
6 |   :root {
7 |     /* TaleMe! colors as HSL values */
8 |     --background: 35 100% 98%;
9 |     /* #FFFBF5 - Fondo claro */
10 |     --foreground: 0 0% 29%;
11 |     /* #4A4A4A - Texto principal */
12 | 
13 |     --card: 0 0% 100%;
14 |     /* #FFFFFF - Fondo de tarjetas */
15 |     --card-foreground: 0 0% 29%;
16 |     /* #4A4A4A - Texto en tarjetas */
17 | 
18 |     --popover: 0 0% 100%;
19 |     /* #FFFFFF - Fondo de popovers */
20 |     --popover-foreground: 0 0% 29%;
21 |     /* #4A4A4A - Texto en popovers */
22 | 
23 |     --primary: 284 43% 65%;
24 |     /* #BB79D1 - Morado como primario */
25 |     --primary-foreground: 0 0% 100%;
26 |     /* #FFFFFF - Texto sobre primario */
27 | 
28 |     --secondary: 195 65% 69%;
29 |     /* #7DC4E0 - Azul como secundario */
30 |     --secondary-foreground: 0 0% 100%;
31 |     /* #FFFFFF - Texto sobre secundario */
32 | 
33 |     --muted: 284 43% 90%;
34 |     /* Versión más clara del morado */
35 |     --muted-foreground: 0 0% 46%;
36 |     /* #757575 - Texto secundario */
37 | 
38 |     --accent: 49 94% 68%;
39 |     /* #F9DA60 - Amarillo como acento */
40 |     --accent-foreground: 0 0% 29%;
41 |     /* #4A4A4A - Texto sobre acento */
42 | 
43 |     --destructive: 0 84% 60%;
44 |     /* Mantener el error en rojo */
45 |     --destructive-foreground: 0 0% 98%;
46 | 
47 |     --border: 284 43% 90%;
48 |     /* Borde en tono morado claro */
49 |     --input: 284 43% 95%;
50 |     /* Input en tono morado muy claro */
51 |     --ring: 284 43% 65%;
52 |     /* Ring en tono morado primario */
53 | 
54 |     --radius: 0.75rem;
55 | 
56 |     /* Mantener las variables legacy para compatibilidad */
57 |     --story-purple-50: hsl(284, 43%, 95%);
58 |     --story-purple-100: hsl(284, 43%, 90%);
59 |     --story-purple-200: hsl(284, 43%, 80%);
60 |     --story-purple-300: hsl(284, 43%, 70%);
61 |     --story-purple-400: hsl(284, 43%, 65%);
62 |     --story-purple-500: hsl(284, 43%, 60%);
63 | 
64 |     --story-orange-400: hsl(49, 94%, 68%);
65 |     --story-orange-500: hsl(49, 94%, 60%);
66 |   }
67 | 
68 |   .dark {
69 |     --background: 284 43% 15%;
70 |     /* Fondo oscuro basado en el morado */
71 |     --foreground: 0 0% 90%;
72 |     /* Texto claro sobre fondo oscuro */
73 | 
74 |     --card: 284 43% 20%;
75 |     /* Tarjetas en tono morado oscuro */
76 |     --card-foreground: 0 0% 90%;
77 |     /* Texto claro sobre tarjetas */
78 | 
79 |     --popover: 284 43% 20%;
80 |     /* Popovers en tono morado oscuro */
81 |     --popover-foreground: 0 0% 90%;
82 |     /* Texto claro sobre popovers */
83 | 
84 |     --primary: 284 43% 70%;
85 |     /* Primario un poco más claro para dark mode */
86 |     --primary-foreground: 0 0% 98%;
87 | 
88 |     --secondary: 195 65% 69%;
89 |     /* Mantener el azul para secondary */
90 |     --secondary-foreground: 0 0% 15%;
91 | 
92 |     --muted: 284 43% 25%;
93 |     /* Muted en tono morado oscuro */
94 |     --muted-foreground: 0 0% 60%;
95 |     /* Texto muted más claro */
96 | 
97 |     --accent: 49 94% 68%;
98 |     /* Mantener el amarillo para accent */
99 |     --accent-foreground: 0 0% 15%;
100 | 
101 |     --destructive: 0 62.8% 30.6%;
102 |     --destructive-foreground: 0 0% 98%;
103 | 
104 |     --border: 284 43% 30%;
105 |     /* Borde más oscuro */
106 |     --input: 284 43% 30%;
107 |     /* Input más oscuro */
108 |     --ring: 284 43% 70%;
109 |     /* Ring en tono morado claro */
110 |   }
111 | }
112 | 
113 | @layer base {
114 |   * {
115 |     @apply border-border;
116 |   }
117 | 
118 |   html,
119 |   body {
120 |     @apply font-sans bg-background text-text-primary min-h-screen overflow-x-hidden;
121 |     -webkit-font-smoothing: antialiased;
122 |     -moz-osx-font-smoothing: grayscale;
123 |     font-feature-settings: "rlig" 1, "calt" 1;
124 |   }
125 | 
126 |   h1,
127 |   h2,
128 |   h3,
129 |   h4,
130 |   h5,
131 |   h6 {
132 |     @apply font-heading;
133 |   }
134 | 
135 |   /* Hide scrollbar for Chrome, Safari and Opera */
136 |   .hide-scrollbar::-webkit-scrollbar {
137 |     display: none;
138 |   }
139 | 
140 |   /* Hide scrollbar for IE, Edge and Firefox */
141 |   .hide-scrollbar {
142 |     -ms-overflow-style: none;
143 |     /* IE and Edge */
144 |     scrollbar-width: none;
145 |     /* Firefox */
146 |   }
147 | }
148 | 
149 | @layer components {
150 |   .story-card {
151 |     @apply relative rounded-3xl bg-gradient-to-br from-white/15 to-white/5 backdrop-blur-md shadow-lg border border-white/20 overflow-hidden transition-all duration-300 ease-in-out;
152 |   }
153 | 
154 |   .glass-card {
155 |     @apply bg-white/15 backdrop-blur-md border border-white/20 rounded-3xl shadow-md;
156 |   }
157 | 
158 |   .gradient-bg {
159 |     @apply bg-gradient-to-br from-brand-purple via-brand-blue to-brand-pink;
160 |   }
161 | 
162 |   .story-btn {
163 |     @apply rounded-2xl px-8 py-4 text-lg font-medium transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-2;
164 |   }
165 | 
166 |   .story-btn-primary {
167 |     @apply story-btn bg-gradient-to-r from-brand-purple to-brand-blue text-white shadow-md hover:shadow-xl hover:from-brand-purple hover:to-brand-purple focus:ring-2 focus:ring-brand-purple/20 focus:ring-offset-2 font-semibold;
168 |   }
169 | 
170 |   .story-btn-secondary {
171 |     @apply story-btn bg-white/15 backdrop-blur-md text-white border border-white/30 hover:bg-white/25 hover:shadow-md hover:border-white/40;
172 |   }
173 | 
174 |   /* Narrar con Voz & Volver al Inicio buttons */
175 |   .nav-button {
176 |     @apply flex items-center justify-center gap-2 px-6 py-3 rounded-xl transition-all duration-300;
177 |     @apply bg-white/15 backdrop-blur-lg border border-white/20;
178 |     @apply hover:bg-white/25 hover:shadow-lg hover:border-white/30 hover:scale-105;
179 |     @apply active:scale-95 text-white font-medium;
180 |     text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
181 |     box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), inset 0 1px 1px rgba(255, 255, 255, 0.2);
182 |   }
183 | 
184 |   .nav-button svg {
185 |     @apply transition-transform duration-300;
186 |   }
187 | 
188 |   .nav-button:hover svg {
189 |     @apply transform scale-110;
190 |   }
191 | 
192 |   .story-input {
193 |     @apply w-full rounded-xl border border-white/20 bg-white/15 backdrop-blur-md px-4 py-3 text-black placeholder:text-white/60 focus:outline-none focus:ring-2 focus:ring-story-orange-400/70 shadow-md;
194 |   }
195 | 
196 |   /* Override for white background Select components */
197 |   .bg-white .SelectTrigger,
198 |   .bg-white .SelectContent,
199 |   .bg-white .SelectItem,
200 |   .SelectContent,
201 |   .story-input.bg-white {
202 |     @apply text-black font-medium;
203 |   }
204 | 
205 |   /* Fix for SelectContent items */
206 |   .SelectItem {
207 |     @apply text-black;
208 |   }
209 | 
210 |   /* Updated input styles for white backgrounds */
211 |   input.bg-white,
212 |   select.bg-white,
213 |   textarea.bg-white,
214 |   .bg-white input,
215 |   .bg-white select,
216 |   .bg-white textarea,
217 |   [data-theme="light"] input,
218 |   [data-theme="light"] select,
219 |   [data-theme="light"] textarea,
220 |   .SelectTrigger[style*="background: white"],
221 |   .SelectContent,
222 |   div[style*="background-color: white"] input,
223 |   div[style*="background-color: white"] select,
224 |   div[style*="background-color: white"] textarea,
225 |   div[style*="background: white"] input,
226 |   div[style*="background: white"] select,
227 |   div[style*="background: white"] textarea,
228 |   input[style*="background: white"],
229 |   select[style*="background: white"],
230 |   textarea[style*="background: white"] {
231 |     @apply text-black placeholder:text-gray-500;
232 |   }
233 | 
234 |   .story-label {
235 |     @apply block text-base font-medium text-white mb-2;
236 |   }
237 | 
238 |   .story-choice-card {
239 |     @apply relative overflow-hidden rounded-3xl bg-gradient-to-br from-white/20 to-white/10 backdrop-blur-md border border-white/20 transition-all duration-300 ease-in-out cursor-pointer hover:scale-105 active:scale-95 flex flex-col items-center justify-center gap-3 p-4 shadow-md hover:shadow-lg;
240 |   }
241 | 
242 |   .story-page-container {
243 |     @apply min-h-screen w-full flex flex-col items-center justify-center p-6 relative overflow-hidden animate-fade-in;
244 |   }
245 | 
246 |   .page-transition-enter {
247 |     opacity: 0;
248 |     transform: translateY(20px);
249 |   }
250 | 
251 |   .page-transition-enter-active {
252 |     opacity: 1;
253 |     transform: translateY(0);
254 |     transition: opacity 500ms, transform 500ms;
255 |   }
256 | 
257 |   .page-transition-exit {
258 |     opacity: 1;
259 |     transform: translateY(0);
260 |   }
261 | 
262 |   .page-transition-exit-active {
263 |     opacity: 0;
264 |     transform: translateY(-20px);
265 |     transition: opacity 500ms, transform 500ms;
266 |   }
267 | 
268 |   .audio-player-controls {
269 |     @apply flex items-center justify-center gap-6 mt-6;
270 |   }
271 | 
272 |   .audio-player-btn {
273 |     @apply w-14 h-14 rounded-full flex items-center justify-center transition-all duration-300 ease-in-out hover:bg-white/20 active:bg-white/30 text-white;
274 |   }
275 | 
276 |   .audio-player-progress {
277 |     @apply w-full h-2 bg-white/20 rounded-full overflow-hidden mt-4;
278 |   }
279 | 
280 |   .audio-player-progress-bar {
281 |     @apply h-full bg-story-orange-400;
282 |   }
283 | 
284 |   /* Custom animation for spinner */
285 |   .animate-spin-slow {
286 |     animation: spin 3s linear infinite;
287 |   }
288 | 
289 |   @keyframes spin {
290 |     from {
291 |       transform: rotate(0deg);
292 |     }
293 | 
294 |     to {
295 |       transform: rotate(360deg);
296 |     }
297 |   }
298 | }
299 | 
300 | /* Print styles */
301 | @media print {
302 |   .gradient-bg {
303 |     background: white !important;
304 |     color: black !important;
305 |   }
306 | 
307 |   .bg-white\/20,
308 |   .bg-white\/15,
309 |   .bg-white\/10 {
310 |     background: white !important;
311 |     color: black !important;
312 |     border: 1px solid #ddd !important;
313 |   }
314 | 
315 |   .text-white {
316 |     color: black !important;
317 |   }
318 | 
319 |   button,
320 |   .story-btn {
321 |     display: none !important;
322 |   }
323 | }
324 | 
325 | /* Fix high contrast */
326 | .text-white {
327 |   text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
328 | }
329 | 
330 | .story-choice-card:hover {
331 |   box-shadow: 0 0 0 2px rgba(244, 162, 97, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2);
332 | }
333 | 
334 | .voice-settings {
335 |   @apply mt-4;
336 | }
337 | 
338 | .voice-settings select {
339 |   @apply bg-white/20 text-white rounded-lg px-4 py-2 backdrop-blur-md outline-none focus:ring-2 focus:ring-purple-300;
340 | }
341 | 
342 | .voice-settings input[type="range"] {
343 |   @apply w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer;
344 | }
345 | 
346 | .voice-settings input[type="range"]::-webkit-slider-thumb {
347 |   @apply appearance-none w-4 h-4 rounded-full bg-story-orange-400 cursor-pointer;
348 | }
349 | 
350 | .animate-fadeIn {
351 |   animation: fadeIn 0.3s ease-in-out;
352 | }
353 | 
354 | @keyframes fadeIn {
355 |   from {
356 |     opacity: 0;
357 |     transform: translateY(-10px);
358 |   }
359 | 
360 |   to {
361 |     opacity: 1;
362 |     transform: translateY(0);
363 |   }
364 | }
```

src/main.tsx
```
1 | import { createRoot } from 'react-dom/client'
2 | import { useEffect } from 'react'
3 | import App from './App.tsx'
4 | import './index.css'
5 | import { useUserStore } from './store/user/userStore'
6 | import { initSyncService } from './services/syncService'
7 | 
8 | // Component to handle authentication check on app load
9 | const AppWithAuth = () => {
10 |   const { checkAuth } = useUserStore()
11 | 
12 |   useEffect(() => {
13 |     // Check authentication status when app loads
14 |     const initAuth = async () => {
15 |       await checkAuth()
16 |       // Inicializar el servicio de sincronización después de verificar autenticación
17 |       initSyncService()
18 |     }
19 |     
20 |     initAuth()
21 |   }, [checkAuth])
22 | 
23 |   return <App />
24 | }
25 | 
26 | createRoot(document.getElementById("root")!).render(<AppWithAuth />)
```

src/supabaseAuth.ts
```
1 | // Importa el cliente ÚNICO desde supabaseClient.ts
2 | import { supabase } from "./supabaseClient"; // Asegúrate que la ruta es correcta
3 | import { User } from "./types"; // Asume que estos tipos son correctos
4 | 
5 | // Listener de Auth simplificado (opcional, solo para logging)
6 | supabase.auth.onAuthStateChange((event, session) => {
7 |   console.log(`Auth Event: ${event}`, session ? `User: ${session.user.id}` : 'No session');
8 | });
9 | 
10 | // --- Funciones de Autenticación ---
11 | 
12 | export const signUp = async (
13 |   email: string,
14 |   password: string,
15 | ): Promise<{ user: User | null; error: Error | null }> => {
16 |   // Eliminada la llamada a clearSessionData
17 |   try {
18 |     const { data, error } = await supabase.auth.signUp({
19 |       email,
20 |       password,
21 |       // Opciones adicionales si las necesitas (e.g., data para metadata inicial)
22 |     });
23 | 
24 |     if (error) {
25 |       console.error("Error en signUp:", error.message);
26 |       return { user: null, error };
27 |     }
28 | 
29 |     // ¡Importante! signUp puede requerir verificación de email.
30 |     // data.user puede existir pero data.session ser null hasta la verificación.
31 |     // La lógica que llama a signUp debe manejar esto.
32 |     if (!data.user) {
33 |       // Esto no debería ocurrir si no hay error, pero por si acaso.
34 |       console.error("signUp exitoso pero no se devolvió usuario.");
35 |       return { user: null, error: new Error("User creation failed unexpectedly") };
36 |     }
37 | 
38 |     // Devolver solo la información básica del usuario creado.
39 |     // El proceso de login/checkAuth se encargará de establecer la sesión completa y cargar datos.
40 |     return {
41 |       user: {
42 |         id: data.user.id,
43 |         email: data.user.email || "",
44 |       },
45 |       error: null,
46 |     };
47 |   } catch (err) {
48 |     console.error("Error inesperado durante signUp:", err);
49 |     return { user: null, error: err as Error };
50 |   }
51 | };
52 | 
53 | export const signInWithGoogle = async (): Promise<{ error: Error | null }> => {
54 |   // Eliminada la llamada a clearSessionData
55 |   try {
56 |     const { error } = await supabase.auth.signInWithOAuth({
57 |       provider: "google",
58 |       options: {
59 |         // Asegúrate que esta URL está en la lista de URLs permitidas en Supabase Auth settings
60 |         redirectTo: `${window.location.origin}/auth/callback`, // o tu ruta de callback
61 |       },
62 |     });
63 | 
64 |     if (error) {
65 |       console.error("Error en signInWithGoogle:", error.message);
66 |       return { error };
67 |     }
68 |     // signInWithOAuth redirige, no devuelve usuario/sesión aquí.
69 |     // El manejo se hace en la página de callback.
70 |     return { error: null };
71 |   } catch (err) {
72 |     console.error("Error inesperado durante signInWithGoogle:", err);
73 |     return { error: err as Error };
74 |   }
75 | };
76 | 
77 | export const login = async (
78 |   email: string,
79 |   password: string,
80 | ): Promise<{ user: User | null; error: Error | null }> => {
81 |   // Eliminada la llamada a clearSessionData
82 |   try {
83 |     const { data, error } = await supabase.auth.signInWithPassword({
84 |       email,
85 |       password,
86 |     });
87 | 
88 |     if (error) {
89 |       console.error("Error en login:", error.message);
90 |       return { user: null, error };
91 |     }
92 | 
93 |     // signIn devuelve tanto user como session si es exitoso
94 |     if (!data.user || !data.session) {
95 |       console.error("Login exitoso pero faltan datos de usuario o sesión.");
96 |       return { user: null, error: new Error("Login failed unexpectedly") };
97 |     }
98 | 
99 |     // Devolver usuario básico. El userStore.checkAuth/loginUser
100 |     // se encargará de actualizar el estado global y cargar datos.
101 |     return {
102 |       user: {
103 |         id: data.user.id,
104 |         email: data.user.email || "",
105 |       },
106 |       error: null,
107 |     };
108 |   } catch (err) {
109 |     console.error("Error inesperado durante login:", err);
110 |     return { user: null, error: err as Error };
111 |   }
112 | };
113 | 
114 | export const logout = async (): Promise<{ error: Error | null }> => {
115 |   // Eliminada la llamada a clearSessionData
116 |   try {
117 |     // El userStore.logoutUser debería llamar a syncQueue.processQueue() ANTES de llamar a esta función.
118 |     const { error } = await supabase.auth.signOut();
119 | 
120 |     if (error) {
121 |       console.error("Error en logout:", error.message);
122 |       // Incluso si hay error, el estado local debe limpiarse. userStore lo hará.
123 |       return { error };
124 |     }
125 | 
126 |     // El estado local (stores, userStore.user) será limpiado por userStore.logoutUser
127 |     // después de llamar a esta función de signOut.
128 |     return { error: null };
129 |   } catch (err) {
130 |     console.error("Error inesperado durante logout:", err);
131 |     return { error: err as Error };
132 |   }
133 | };
134 | 
135 | // ELIMINADAS las funciones getProfile y updateProfile. Usar getUserProfile y syncUserProfile de supabase.ts
136 | 
137 | // getCurrentUser sigue siendo útil como una forma rápida de obtener el usuario básico.
138 | export const getCurrentUser = async (): Promise<{ user: User | null; error: Error | null }> => {
139 |   try {
140 |     // getUser es preferible a getSession si solo necesitas el usuario y quieres forzar refresco si es necesario.
141 |     const { data: { user }, error } = await supabase.auth.getUser();
142 | 
143 |     if (error) {
144 |       // No loguear error aquí necesariamente, puede ser normal si no hay sesión.
145 |       return { user: null, error };
146 |     }
147 | 
148 |     if (!user) {
149 |       return { user: null, error: null }; // Sin usuario, sin error.
150 |     }
151 | 
152 |     return {
153 |       user: {
154 |         id: user.id,
155 |         email: user.email || "",
156 |       },
157 |       error: null,
158 |     };
159 |   } catch (err) {
160 |     // Capturar errores inesperados del propio método getUser
161 |     console.error("Error inesperado en getCurrentUser:", err);
162 |     return { user: null, error: err as Error };
163 |   }
164 | };
165 | 
166 | export const requestPasswordReset = async (
167 |   email: string,
168 | ): Promise<{ error: Error | null }> => {
169 |   try {
170 |     const { error } = await supabase.auth.resetPasswordForEmail(email, {
171 |       // Asegúrate que esta ruta existe y maneja la actualización de contraseña
172 |       redirectTo: `${window.location.origin}/update-password`, // Ruta para actualizar contraseña
173 |     });
174 | 
175 |     if (error) {
176 |       console.error("Error solicitando reseteo de contraseña:", error.message);
177 |       return { error };
178 |     }
179 | 
180 |     return { error: null };
181 |   } catch (err) {
182 |     console.error("Error inesperado solicitando reseteo de contraseña:", err);
183 |     return { error: err as Error };
184 |   }
185 | };
```

src/supabaseClient.ts
```
1 | import { createClient } from "@supabase/supabase-js";
2 | 
3 | const supabaseUrl = import.meta.env.VITE_SUPABASE_URL as string;
4 | const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY as string;
5 | 
6 | export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

src/vite-env.d.ts
```
1 | /// <reference types="vite/client" />
```

supabase/config.toml
```
1 | # supabase/config.toml
2 | 
3 | # For detailed configuration reference documentation, visit:
4 | # https://supabase.com/docs/guides/local-development/cli/config
5 | # A string used to distinguish different Supabase projects on the same host. Defaults to the
6 | # working directory name when running `supabase init`.
7 | project_id = "CuentaSuenos-investigacion-Narraciones-d"
8 | 
9 | [api]
10 | enabled = true
11 | port = 54321
12 | schemas = ["public", "graphql_public"]
13 | extra_search_path = ["public", "extensions"]
14 | max_rows = 1000
15 | 
16 | [api.tls]
17 | enabled = false
18 | 
19 | [db]
20 | port = 54322
21 | shadow_port = 54320
22 | major_version = 15
23 | 
24 | [db.pooler]
25 | enabled = false
26 | port = 54329
27 | pool_mode = "transaction"
28 | default_pool_size = 20
29 | max_client_conn = 100
30 | 
31 | [db.migrations]
32 | schema_paths = []
33 | 
34 | [db.seed]
35 | enabled = true
36 | sql_paths = ["./seed.sql"]
37 | 
38 | [realtime]
39 | enabled = true
40 | 
41 | [studio]
42 | enabled = true
43 | port = 54323
44 | api_url = "http://127.0.0.1"
45 | openai_api_key = "env(OPENAI_API_KEY)"
46 | 
47 | [inbucket]
48 | enabled = true
49 | port = 54324
50 | 
51 | [storage]
52 | enabled = true
53 | file_size_limit = "50MiB"
54 | 
55 | [auth]
56 | enabled = true
57 | # --- Asegúrate que estas URLs coincidan con tu config remota o local deseada ---
58 | site_url = "http://localhost:8080"
59 | additional_redirect_urls = ["http://localhost:8080/auth/v1/callback"]
60 | # --- Fin URLs ---
61 | jwt_expiry = 3600
62 | enable_refresh_token_rotation = true
63 | refresh_token_reuse_interval = 10
64 | enable_signup = true
65 | enable_anonymous_sign_ins = false
66 | enable_manual_linking = false
67 | minimum_password_length = 6
68 | password_requirements = ""
69 | 
70 | [auth.rate_limit]
71 | email_sent = 2
72 | sms_sent = 30
73 | anonymous_users = 30
74 | token_refresh = 150
75 | sign_in_sign_ups = 30
76 | token_verifications = 30
77 | 
78 | [auth.email]
79 | enable_signup = true
80 | double_confirm_changes = true
81 | enable_confirmations = false
82 | secure_password_change = false
83 | max_frequency = "1m0s"
84 | otp_length = 6
85 | otp_expiry = 86400
86 | 
87 | [auth.sms]
88 | enable_signup = false
89 | enable_confirmations = false
90 | template = "Your code is {{ .Code }}"
91 | max_frequency = "5s"
92 | 
93 | [auth.sms.twilio]
94 | enabled = false
95 | account_sid = ""
96 | message_service_sid = ""
97 | auth_token = "env(SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN)"
98 | 
99 | [auth.mfa]
100 | max_enrolled_factors = 10
101 | 
102 | [auth.mfa.totp]
103 | enroll_enabled = true
104 | verify_enabled = true
105 | 
106 | [auth.mfa.phone]
107 | enroll_enabled = false
108 | verify_enabled = false
109 | otp_length = 6
110 | template = "Your code is {{ .Code }}"
111 | max_frequency = "5s"
112 | 
113 | [auth.external.apple]
114 | enabled = false
115 | client_id = ""
116 | secret = "env(SUPABASE_AUTH_EXTERNAL_APPLE_SECRET)"
117 | redirect_uri = ""
118 | url = ""
119 | skip_nonce_check = false
120 | 
121 | [auth.third_party.firebase]
122 | enabled = false
123 | 
124 | [auth.third_party.auth0]
125 | enabled = false
126 | 
127 | [auth.third_party.aws_cognito]
128 | enabled = false
129 | 
130 | [auth.third_party.clerk]
131 | enabled = false
132 | 
133 | # --- NO DEBE HABER SECCIÓN [functions] AQUÍ ---
134 | 
135 | [edge_runtime]
136 | enabled = true
137 | policy = "oneshot"
138 | inspector_port = 8083
139 | deno_version = 1
140 | 
141 | [analytics]
142 | enabled = true
143 | port = 54327
144 | backend = "postgres"
145 | 
146 | [experimental]
147 | orioledb_version = ""
148 | s3_host = "env(S3_HOST)"
149 | s3_region = "env(S3_REGION)"
150 | s3_access_key = "env(S3_ACCESS_KEY)"
151 | s3_secret_key = "env(S3_SECRET_KEY)"
```

.vite/deps/_metadata.json
```
1 | {
2 |   "hash": "3a7d4734",
3 |   "configHash": "74516b19",
4 |   "lockfileHash": "e3b0c442",
5 |   "browserHash": "7f9c0fe1",
6 |   "optimized": {},
7 |   "chunks": {}
8 | }
```

.vite/deps/package.json
```
1 | {
2 |   "type": "module"
3 | }
```

.windsurf/workflows/subirgit.md
```
1 | ---
2 | description: guardar en git y subir a github
3 | ---
4 | 
5 | 1. Ejecutar `git status` para identificar archivos añadidos, modificados o eliminados.  
6 | 2. Actualizar el fichero de estructura del proyecto /Users/miguel/Mizat Ventures/smartwrite-mentor/Documentation/estructura_proyecto.md los cambios detectados (añadir/quitar documentos). Incluir notas solo si afectan directamente a la estructura.  
7 | 3. Verificar que la rama activa es la correcta.  
8 | 4. Indexar los cambios con `git add`.  
9 | 5. Realizar el commit con un mensaje detallado que incluya:  
10 |    - Descripción de cada modificación.  
11 |    - Motivo de añadir/eliminar documentos.  
12 |    - Referencias relevantes de la conversación previa con el agente de código (si está disponible).  
13 | 6. Ejecutar `git push` para subir los cambios a GitHub.
```

src/components/AudioPlayer.tsx
```
1 | import { useState, useEffect, useRef } from "react";
2 | import { Button } from "@/components/ui/button";
3 | import { Slider } from "@/components/ui/slider";
4 | import { Play, Pause, Volume2, VolumeX } from "lucide-react";
5 | import { generateSpeech, OPENAI_VOICES, OpenAIVoiceType } from "@/services/ai/ttsService";
6 | import { cn } from "@/lib/utils";
7 | import { toast } from "sonner";
8 | 
9 | // Función auxiliar para formatear el tiempo
10 | function formatTime(seconds: number): string {
11 |   const minutes = Math.floor(seconds / 60);
12 |   const remainingSeconds = Math.floor(seconds % 60);
13 |   return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
14 | }
15 | 
16 | interface Voice {
17 |   id: string;
18 |   name: string;
19 |   description: string;
20 | }
21 | 
22 | const ELEVENLABS_MODELS = [
23 |   { id: 'eleven_multilingual_v2', name: 'Multilingüe V2', description: 'Mejor para español y otros idiomas' },
24 |   { id: 'eleven_monolingual_v1', name: 'Monolingüe V1', description: 'Mejor para inglés' },
25 |   { id: 'eleven_turbo_v2', name: 'Turbo V2', description: 'Más rápido, buena calidad' }
26 | ];
27 | 
28 | interface AudioPlayerProps {
29 |   text: string;
30 |   className?: string;
31 |   onComplete?: () => void;
32 | }
33 | 
34 | export default function AudioPlayer({ text, className, onComplete }: AudioPlayerProps) {
35 |   const [isPlaying, setIsPlaying] = useState(false);
36 |   const [isLoading, setIsLoading] = useState(false);
37 |   const [volume, setVolume] = useState(1);
38 |   const [isMuted, setIsMuted] = useState(false);
39 |   const [currentTime, setCurrentTime] = useState(0);
40 |   const [duration, setDuration] = useState(0);
41 |   const [audioUrl, setAudioUrl] = useState<string | null>(null);
42 |   const [selectedVoice, setSelectedVoice] = useState<Voice>(OPENAI_VOICES[0]);
43 |   const [selectedModel, setSelectedModel] = useState(ELEVENLABS_MODELS[0]);
44 |   const audioRef = useRef<HTMLAudioElement>(null);
45 |   const [isGenerating, setIsGenerating] = useState(false);
46 |   const [error, setError] = useState<string | null>(null);
47 | 
48 |   // Limpia los intervalos al desmontar
49 |   useEffect(() => {
50 |     return () => {
51 |       if (audioRef.current) {
52 |         audioRef.current.pause();
53 |         audioRef.current.src = '';
54 |       }
55 |       if (audioUrl) {
56 |         URL.revokeObjectURL(audioUrl);
57 |       }
58 |     };
59 |   }, [audioUrl]);
60 | 
61 |   // Maneja la actualización del tiempo
62 |   useEffect(() => {
63 |     let interval: NodeJS.Timeout;
64 |     if (isPlaying && audioRef.current) {
65 |       interval = setInterval(() => {
66 |         setCurrentTime(audioRef.current?.currentTime || 0);
67 |       }, 100);
68 |     }
69 |     return () => clearInterval(interval);
70 |   }, [isPlaying]);
71 | 
72 |   // Maneja la actualización de la duración
73 |   useEffect(() => {
74 |     if (audioRef.current) {
75 |       const handleLoadedMetadata = () => {
76 |         console.log('Audio metadata loaded, duration:', audioRef.current?.duration);
77 |         setDuration(audioRef.current?.duration || 0);
78 |       };
79 | 
80 |       audioRef.current.addEventListener('loadedmetadata', handleLoadedMetadata);
81 |       return () => {
82 |         audioRef.current?.removeEventListener('loadedmetadata', handleLoadedMetadata);
83 |       };
84 |     }
85 |   }, []);
86 | 
87 |   // Maneja la actualización de la URL del audio
88 |   useEffect(() => {
89 |     if (audioRef.current && audioUrl) {
90 |       console.log('Setting audio source:', audioUrl);
91 |       audioRef.current.src = audioUrl;
92 |       audioRef.current.load();
93 |     }
94 |   }, [audioUrl]);
95 | 
96 |   const handlePlayPause = async () => {
97 |     if (!audioUrl) {
98 |       setIsLoading(true);
99 |       try {
100 |         await handleGenerateAudio();
101 |       } catch (err) {
102 |         console.error('Error al generar audio:', err);
103 |         return;
104 |       } finally {
105 |         setIsLoading(false);
106 |       }
107 |     }
108 | 
109 |     if (audioRef.current) {
110 |       if (isPlaying) {
111 |         console.log('Pausing audio...');
112 |         audioRef.current.pause();
113 |         setIsPlaying(false);
114 |       } else {
115 |         console.log('Starting playback...');
116 |         const playPromise = audioRef.current.play();
117 |         if (playPromise !== undefined) {
118 |           playPromise
119 |             .then(() => {
120 |               console.log('Playback started successfully');
121 |               setIsPlaying(true);
122 |             })
123 |             .catch(error => {
124 |               console.error('Error starting playback:', error);
125 |               setIsPlaying(false);
126 |             });
127 |         }
128 |       }
129 |     }
130 |   };
131 | 
132 |   const handleGenerateAudio = async (): Promise<string> => {
133 |     try {
134 |       setIsGenerating(true);
135 |       setError(null);
136 |       
137 |       console.log('Generating audio with voice:', selectedVoice.id, 'and model:', selectedModel.id);
138 |       const audioBlob = await generateSpeech({
139 |         text,
140 |         voice: selectedVoice.id as OpenAIVoiceType,
141 |         model: selectedModel.id
142 |       });
143 |       
144 |       const audioObjectUrl = URL.createObjectURL(audioBlob);
145 |       console.log('Audio generated successfully, URL:', audioObjectUrl);
146 |       setAudioUrl(audioObjectUrl);
147 |       setIsGenerating(false);
148 |       return audioObjectUrl;
149 |     } catch (err) {
150 |       console.error('Error al generar audio:', err);
151 |       setError(err instanceof Error ? err.message : 'Error al generar el audio');
152 |       setIsGenerating(false);
153 |       throw err;
154 |     }
155 |   };
156 | 
157 |   const handleVoiceChange = (voiceId: string) => {
158 |     setSelectedVoice(OPENAI_VOICES.find(voice => voice.id === voiceId) || OPENAI_VOICES[0]);
159 |     setAudioUrl(null);
160 |   };
161 | 
162 |   const handleTimeUpdate = () => {
163 |     if (audioRef.current) {
164 |       setCurrentTime(audioRef.current.currentTime);
165 |     }
166 |   };
167 | 
168 |   const handleSeek = (value: number[]) => {
169 |     if (audioRef.current) {
170 |       audioRef.current.currentTime = value[0];
171 |       setCurrentTime(value[0]);
172 |     }
173 |   };
174 | 
175 |   const handleVolumeChange = (value: number[]) => {
176 |     if (audioRef.current) {
177 |       const newVolume = value[0];
178 |       audioRef.current.volume = newVolume;
179 |       setVolume(newVolume);
180 |       setIsMuted(newVolume === 0);
181 |     }
182 |   };
183 | 
184 |   const handleMuteToggle = () => {
185 |     if (audioRef.current) {
186 |       const newMutedState = !isMuted;
187 |       audioRef.current.volume = newMutedState ? 0 : volume;
188 |       setIsMuted(newMutedState);
189 |     }
190 |   };
191 | 
192 |   const handleEndedEvent = () => {
193 |     console.log('Audio ended event triggered');
194 |     setIsPlaying(false);
195 |     setCurrentTime(duration);
196 |     onComplete?.();
197 |   };
198 | 
199 |   const handlePauseEvent = () => {
200 |     console.log('Audio pause event triggered');
201 |     setIsPlaying(false);
202 |   };
203 | 
204 |   return (
205 |     <div className={cn("flex flex-col gap-4 p-4 bg-white rounded-lg shadow-md", className)}>
206 |       <div className="flex items-center gap-4">
207 |         <Button
208 |           onClick={handlePlayPause}
209 |           disabled={isLoading}
210 |           className="w-12 h-12 rounded-full"
211 |         >
212 |           {isLoading ? (
213 |             <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
214 |           ) : isPlaying ? (
215 |             <Pause className="w-6 h-6" />
216 |           ) : (
217 |             <Play className="w-6 h-6" />
218 |           )}
219 |         </Button>
220 | 
221 |         <div className="flex-1">
222 |           <div className="flex items-center gap-2">
223 |             <span className="text-sm text-gray-500">
224 |               {formatTime(currentTime)} / {formatTime(duration)}
225 |             </span>
226 |             <Slider
227 |               value={[currentTime]}
228 |               max={duration}
229 |               step={1}
230 |               onValueChange={handleSeek}
231 |               className="flex-1"
232 |             />
233 |           </div>
234 |         </div>
235 | 
236 |         <Button
237 |           variant="ghost"
238 |           size="icon"
239 |           onClick={handleMuteToggle}
240 |           className="w-10 h-10"
241 |         >
242 |           {isMuted ? (
243 |             <VolumeX className="w-5 h-5" />
244 |           ) : (
245 |             <Volume2 className="w-5 h-5" />
246 |           )}
247 |         </Button>
248 |       </div>
249 | 
250 |       <div className="flex items-center gap-4">
251 |         <select
252 |           value={selectedVoice.id}
253 |           onChange={(e) => handleVoiceChange(e.target.value)}
254 |           className="px-3 py-2 border rounded-md"
255 |         >
256 |           {OPENAI_VOICES.map((voice) => (
257 |             <option key={voice.id} value={voice.id}>
258 |               {voice.name}
259 |             </option>
260 |           ))}
261 |         </select>
262 | 
263 |         <select
264 |           value={selectedModel.id}
265 |           onChange={(e) => {
266 |             setSelectedModel(ELEVENLABS_MODELS.find(model => model.id === e.target.value) || ELEVENLABS_MODELS[0]);
267 |             setAudioUrl(null);
268 |           }}
269 |           className="px-3 py-2 border rounded-md"
270 |         >
271 |           {ELEVENLABS_MODELS.map((model) => (
272 |             <option key={model.id} value={model.id}>
273 |               {model.name}
274 |             </option>
275 |           ))}
276 |         </select>
277 |       </div>
278 | 
279 |       <audio
280 |         ref={audioRef}
281 |         onTimeUpdate={handleTimeUpdate}
282 |         onEnded={handleEndedEvent}
283 |         onPause={handlePauseEvent}
284 |         className="hidden"
285 |       />
286 |     </div>
287 |   );
288 | }
```

src/components/AuthGuard.tsx
```
1 | import { useEffect, useState } from "react";
2 | import { Navigate, useLocation, useNavigate } from "react-router-dom";
3 | import { useUserStore } from "../store/user/userStore";
4 | import { User } from "../types";
5 | 
6 | interface AuthGuardProps {
7 |   children: React.ReactNode;
8 | }
9 | 
10 | type AuthStatus = 'pending' | 'authenticated' | 'unauthenticated';
11 | 
12 | export default function AuthGuard({ children }: AuthGuardProps) {
13 |   const { checkAuth, intendedRedirectPath } = useUserStore(state => ({
14 |     checkAuth: state.checkAuth,
15 |     intendedRedirectPath: state.intendedRedirectPath,
16 |   }));
17 |   const set = useUserStore.setState;
18 | 
19 |   const [authStatus, setAuthStatus] = useState<AuthStatus>('pending');
20 |   const [checkedUser, setCheckedUser] = useState<User | null>(null);
21 | 
22 |   const location = useLocation();
23 |   const navigate = useNavigate();
24 | 
25 |   useEffect(() => {
26 |     let isMounted = true;
27 |     const verifyAuth = async () => {
28 |       console.log("AuthGuard: Verifying authentication...");
29 |       const userResult = await checkAuth();
30 |       console.log("AuthGuard: Authentication check completed. User:", userResult ? userResult.id : 'null');
31 |       if (isMounted) {
32 |         setCheckedUser(userResult);
33 |         setAuthStatus(userResult ? 'authenticated' : 'unauthenticated');
34 |       }
35 |     };
36 | 
37 |     verifyAuth();
38 | 
39 |     return () => { isMounted = false; };
40 |   }, [checkAuth]);
41 | 
42 |   useEffect(() => {
43 |     if (authStatus === 'pending') {
44 |       console.log("AuthGuard Redirect Effect: Waiting for auth check to complete...");
45 |       return;
46 |     }
47 | 
48 |     console.log(`AuthGuard Redirect Effect: Evaluating state - Status: ${authStatus}, Intended: ${intendedRedirectPath}, Current: ${location.pathname}`);
49 | 
50 |     if (intendedRedirectPath && intendedRedirectPath !== location.pathname) {
51 |       console.log(`AuthGuard Redirect Effect: Redirecting from ${location.pathname} to intended path: ${intendedRedirectPath}`);
52 |       set({ intendedRedirectPath: null });
53 |       navigate(intendedRedirectPath, { replace: true });
54 |     }
55 |     else if (intendedRedirectPath && intendedRedirectPath === location.pathname) {
56 |       console.log(`AuthGuard Redirect Effect: Already at intended path ${intendedRedirectPath}. Resetting flag.`);
57 |       set({ intendedRedirectPath: null });
58 |     }
59 |   }, [authStatus, intendedRedirectPath, location.pathname, navigate, set]);
60 | 
61 |   if (authStatus === 'pending') {
62 |     console.log(`AuthGuard Render: Auth check in progress. Showing loader.`);
63 |     return (
64 |       <div className="gradient-bg min-h-screen flex items-center justify-center">
65 |         <div className="animate-spin h-10 w-10 border-4 border-white rounded-full border-t-transparent"></div>
66 |       </div>
67 |     );
68 |   }
69 | 
70 |   if (intendedRedirectPath && intendedRedirectPath !== location.pathname) {
71 |     console.log(`AuthGuard Render: Redirect pending to ${intendedRedirectPath}. Waiting for navigation.`);
72 |     return (
73 |       <div className="gradient-bg min-h-screen flex items-center justify-center">
74 |         <div className="animate-spin h-10 w-10 border-4 border-white rounded-full border-t-transparent"></div>
75 |       </div>
76 |     );
77 |   }
78 | 
79 |   if (authStatus === 'authenticated' && checkedUser) {
80 |     console.log(`AuthGuard Render: Auth checked, user ${checkedUser.id} exists. Rendering children for ${location.pathname}.`);
81 |     return <>{children}</>;
82 |   }
83 | 
84 |   if (authStatus === 'unauthenticated') {
85 |     console.log(`AuthGuard Render: Auth checked, user not authenticated. Redirecting to /login.`);
86 |     return <Navigate to="/login" state={{ from: location }} replace />;
87 |   }
88 | 
89 |   console.warn(`AuthGuard Render: Reached unexpected state (Status: ${authStatus}, CheckedUser: ${!!checkedUser}, Intended: ${intendedRedirectPath}). Rendering null or redirecting to error.`);
90 |   return <Navigate to="/error" replace />;
91 | }
```

src/components/BackButton.tsx
```
1 | import { ChevronLeft } from "lucide-react";
2 | import { useNavigate } from "react-router-dom";
3 | 
4 | interface BackButtonProps {
5 |   onClick?: () => void;
6 |   className?: string;
7 | }
8 | 
9 | export default function BackButton({ onClick, className = "" }: BackButtonProps) {
10 |   const navigate = useNavigate();
11 |   
12 |   const handleClick = () => {
13 |     if (onClick) {
14 |       onClick();
15 |     } else {
16 |       navigate(-1);
17 |     }
18 |   };
19 |   
20 |   return (
21 |     <button 
22 |       onClick={handleClick}
23 |       className={`absolute top-6 left-6 w-12 h-12 flex items-center justify-center rounded-full bg-white shadow-lg border-2 border-[#BB79D1]/60 text-[#BB79D1] hover:bg-[#BB79D1]/10 hover:text-[#7DC4E0] focus:ring-4 focus:ring-[#BB79D1]/30 transition-all duration-300 z-20 ${className}`}
24 |       aria-label="Volver atrás"
25 |     >
26 |       <ChevronLeft size={28} />
27 |     </button>
28 |   );
29 | }
```

src/components/ChallengeQuestion.tsx
```
1 | import { useState } from 'react';
2 | import { motion } from 'framer-motion';
3 | import { CheckCircle, XCircle, RefreshCw } from 'lucide-react';
4 | import { ChallengeQuestion as ChallengeQuestionType } from '../types';
5 | 
6 | interface ChallengeQuestionProps {
7 |   question: ChallengeQuestionType;
8 |   onNextQuestion?: () => void;
9 |   onTryAgain?: () => void;
10 |   onChangeChallenge?: () => void;
11 | }
12 | 
13 | export default function ChallengeQuestion({ 
14 |   question, 
15 |   onNextQuestion,
16 |   onTryAgain,
17 |   onChangeChallenge
18 | }: ChallengeQuestionProps) {
19 |   const [selectedOption, setSelectedOption] = useState<number | null>(null);
20 |   const [showFeedback, setShowFeedback] = useState(false);
21 |   const [loading, setLoading] = useState(false);
22 | 
23 |   const isCorrect = selectedOption === question.correctOptionIndex;
24 | 
25 |   const handleSelectOption = (index: number) => {
26 |     if (showFeedback || loading) return;
27 |     setSelectedOption(index);
28 |     setShowFeedback(true);
29 |   };
30 | 
31 |   const handleNext = () => {
32 |     setSelectedOption(null);
33 |     setShowFeedback(false);
34 |     if (onNextQuestion) onNextQuestion();
35 |   };
36 | 
37 |   const handleTryAgain = () => {
38 |     setSelectedOption(null);
39 |     setShowFeedback(false);
40 |     setLoading(false);
41 |     if (onTryAgain) onTryAgain();
42 |   };
43 | 
44 |   // Set category-specific styles
45 |   const getCategoryStyle = () => {
46 |     switch (question.category) {
47 |       case 'language':
48 |         return {
49 |           bg: 'bg-[#7DC4E0]',
50 |           border: 'border-[#7DC4E0]',
51 |           hover: 'hover:bg-[#7DC4E0]/10',
52 |           icon: 'text-[#7DC4E0]'
53 |         };
54 |       case 'math':
55 |         return {
56 |           bg: 'bg-[#F9DA60]',
57 |           border: 'border-[#F9DA60]',
58 |           hover: 'hover:bg-[#F9DA60]/10',
59 |           icon: 'text-[#F9DA60]'
60 |         };
61 |       case 'comprehension':
62 |         return {
63 |           bg: 'bg-[#F6A5B7]',
64 |           border: 'border-[#F6A5B7]',
65 |           hover: 'hover:bg-[#F6A5B7]/10',
66 |           icon: 'text-[#F6A5B7]'
67 |         };
68 |       default:
69 |         return {
70 |           bg: 'bg-[#BB79D1]',
71 |           border: 'border-[#BB79D1]',
72 |           hover: 'hover:bg-[#BB79D1]/10',
73 |           icon: 'text-[#BB79D1]'
74 |         };
75 |     }
76 |   };
77 | 
78 |   const categoryStyle = getCategoryStyle();
79 | 
80 |   return (
81 |     <motion.div
82 |       initial={{ opacity: 0, y: 20 }}
83 |       animate={{ opacity: 1, y: 0 }}
84 |       exit={{ opacity: 0, y: -20 }}
85 |       transition={{ duration: 0.5 }}
86 |       className="bg-white/80 rounded-2xl p-6 text-[#222] shadow-lg"
87 |     >
88 |       {/* Pregunta */}
89 |       <div className={`p-4 rounded-xl mb-6 ${categoryStyle.bg} text-white shadow-md`}>
90 |         <h2 className="text-xl font-bold mb-2 drop-shadow-sm">Pregunta:</h2>
91 |         <p className="text-lg">{question.question}</p>
92 |       </div>
93 | 
94 |       {/* Opciones */}
95 |       <div className="space-y-3 mb-6">
96 |         {question.options.map((option, index) => (
97 |           <button
98 |             key={index}
99 |             onClick={() => handleSelectOption(index)}
100 |             disabled={showFeedback}
101 |             className={`w-full text-left p-4 rounded-xl transition-all shadow-sm ${
102 |               selectedOption === index
103 |                 ? showFeedback
104 |                   ? isCorrect
105 |                     ? 'bg-green-500 text-white border-2 border-green-500'
106 |                     : 'bg-red-500 text-white border-2 border-red-500'
107 |                   : `${categoryStyle.bg} text-white border-2 ${categoryStyle.border}`
108 |                 : showFeedback && index === question.correctOptionIndex
109 |                 ? 'bg-green-500 text-white border-2 border-green-500'
110 |                 : `bg-white/70 border-2 ${categoryStyle.border}/30 ${categoryStyle.hover}`
111 |             }`}
112 |           >
113 |             <div className="flex items-center">
114 |               {showFeedback && index === question.correctOptionIndex && (
115 |                 <CheckCircle className="mr-2 text-white" size={20} />
116 |               )}
117 |               {showFeedback && selectedOption === index && !isCorrect && (
118 |                 <XCircle className="mr-2 text-white" size={20} />
119 |               )}
120 |               <span>{option}</span>
121 |             </div>
122 |           </button>
123 |         ))}
124 |       </div>
125 | 
126 |       {/* Feedback */}
127 |       {showFeedback && (
128 |         <motion.div
129 |           initial={{ opacity: 0, height: 0 }}
130 |           animate={{ opacity: 1, height: 'auto' }}
131 |           className={`p-4 rounded-xl mb-6 shadow-md ${
132 |             isCorrect ? 'bg-white/70 border-2 border-green-500/30' : 'bg-white/70 border-2 border-red-500/30'
133 |           }`}
134 |         >
135 |           <h3 className={`font-bold mb-2 ${isCorrect ? 'text-green-600' : 'text-red-600'}`}>
136 |             {isCorrect ? '¡Genial! Has acertado 🎉' : 'Respuesta incorrecta 😕'}
137 |           </h3>
138 |           <p className="text-[#222]">{question.explanation}</p>
139 |         </motion.div>
140 |       )}
141 | 
142 |       {/* Botones de acción */}
143 |       {showFeedback && (
144 |         <div className="flex flex-col sm:flex-row justify-center items-center gap-4">
145 |           {!isCorrect && (
146 |             <>
147 |               <button
148 |                 onClick={handleTryAgain}
149 |                 className="flex items-center px-5 sm:px-6 py-3 sm:py-4 rounded-2xl font-semibold bg-white/70 hover:bg-white/90 text-[#7DC4E0] transition-all shadow w-full sm:w-auto"
150 |               >
151 |                 <RefreshCw size={18} className="mr-2" /> Intentar de nuevo
152 |               </button>
153 |               {onChangeChallenge && (
154 |                 <button
155 |                   onClick={onChangeChallenge}
156 |                   className="flex items-center px-5 sm:px-6 py-3 sm:py-4 rounded-2xl font-semibold bg-white/70 hover:bg-white/90 text-[#F6A5B7] transition-all shadow w-full sm:w-auto"
157 |                 >
158 |                   Cambiar de reto
159 |                 </button>
160 |               )}
161 |             </>
162 |           )}
163 |           {(isCorrect || !onTryAgain) && (
164 |             <button
165 |               onClick={handleNext}
166 |               className="flex items-center justify-center px-5 sm:px-6 py-3 sm:py-4 rounded-2xl font-semibold text-white transition-all shadow-lg text-base sm:text-lg w-full sm:w-auto bg-[#BB79D1] hover:bg-[#BB79D1]/80 active:bg-[#E6B7D9] focus:bg-[#E6B7D9]"
167 |             >
168 |               Continuar
169 |             </button>
170 |           )}
171 |         </div>
172 |       )}
173 |     </motion.div>
174 |   );
175 | } 
```

src/components/ChallengeSelector.tsx
```
1 | import { useState } from 'react';
2 | import { motion } from 'framer-motion';
3 | import { Book, Calculator, Brain, ChevronRight } from 'lucide-react';
4 | import { ChallengeCategory } from '../types';
5 | 
6 | interface ChallengeSelectorProps {
7 |   onSelectCategory: (category: ChallengeCategory) => void;
8 |   onContinue: () => void;
9 | }
10 | 
11 | export default function ChallengeSelector({ onSelectCategory, onContinue }: ChallengeSelectorProps) {
12 |   const [selectedCategory, setSelectedCategory] = useState<ChallengeCategory | null>(null);
13 | 
14 |   const handleCategorySelect = (category: ChallengeCategory) => {
15 |     setSelectedCategory(category);
16 |     onSelectCategory(category);
17 |   };
18 | 
19 |   return (
20 |     <motion.div
21 |       initial={{ opacity: 0, y: 20 }}
22 |       animate={{ opacity: 1, y: 0 }}
23 |       exit={{ opacity: 0, y: -20 }}
24 |       transition={{ duration: 0.5 }}
25 |       className="bg-white/80 rounded-2xl p-6 mb-8 text-[#222] shadow-lg"
26 |     >
27 |       <h2 className="text-2xl font-bold text-center mb-4 text-[#BB79D1] font-heading drop-shadow-lg">¿Aceptas el reto?</h2>
28 |       <p className="text-center mb-6 font-medium">Elige un tipo de desafío:</p>
29 | 
30 |       <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
31 |         <button
32 |           onClick={() => handleCategorySelect('language')}
33 |           className={`flex flex-col items-center p-4 rounded-xl transition-all shadow-md ${
34 |             selectedCategory === 'language'
35 |               ? 'bg-[#7DC4E0] text-white border-2 border-[#7DC4E0] ring-2 ring-[#7DC4E0]/50'
36 |               : 'bg-white/70 border-2 border-[#7DC4E0]/30 text-[#222] hover:bg-[#7DC4E0]/10'
37 |           }`}
38 |         >
39 |           <div className="flex items-center justify-center mb-2">
40 |             <Book className={`mr-1 ${selectedCategory === 'language' ? 'text-white' : 'text-[#7DC4E0]'}`} size={24} />
41 |             <span className="text-2xl">🌍</span>
42 |           </div>
43 |           <span className="font-medium">Aprende un idioma</span>
44 |         </button>
45 | 
46 |         <button
47 |           onClick={() => handleCategorySelect('math')}
48 |           className={`flex flex-col items-center p-4 rounded-xl transition-all shadow-md ${
49 |             selectedCategory === 'math'
50 |               ? 'bg-[#F9DA60] text-[#222] border-2 border-[#F9DA60] ring-2 ring-[#F9DA60]/50'
51 |               : 'bg-white/70 border-2 border-[#F9DA60]/30 text-[#222] hover:bg-[#F9DA60]/10'
52 |           }`}
53 |         >
54 |           <div className="flex items-center justify-center mb-2">
55 |             <Calculator className={`mr-1 ${selectedCategory === 'math' ? 'text-[#222]' : 'text-[#F9DA60]'}`} size={24} />
56 |             <span className="text-2xl">➗</span>
57 |           </div>
58 |           <span className="font-medium">Reto matemático</span>
59 |         </button>
60 | 
61 |         <button
62 |           onClick={() => handleCategorySelect('comprehension')}
63 |           className={`flex flex-col items-center p-4 rounded-xl transition-all shadow-md ${
64 |             selectedCategory === 'comprehension'
65 |               ? 'bg-[#F6A5B7] text-white border-2 border-[#F6A5B7] ring-2 ring-[#F6A5B7]/50'
66 |               : 'bg-white/70 border-2 border-[#F6A5B7]/30 text-[#222] hover:bg-[#F6A5B7]/10'
67 |           }`}
68 |         >
69 |           <div className="flex items-center justify-center mb-2">
70 |             <Brain className={`mr-1 ${selectedCategory === 'comprehension' ? 'text-white' : 'text-[#F6A5B7]'}`} size={24} />
71 |             <span className="text-2xl">🧩</span>
72 |           </div>
73 |           <span className="font-medium">Comprensión lectora</span>
74 |         </button>
75 |       </div>
76 | 
77 |       <div className="flex justify-center">
78 |         <button
79 |           onClick={onContinue}
80 |           disabled={!selectedCategory}
81 |           className={`flex items-center justify-center px-6 py-3 rounded-2xl font-semibold transition-all shadow-lg text-base ${
82 |             selectedCategory
83 |               ? 'bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white active:bg-[#E6B7D9] focus:bg-[#E6B7D9]'
84 |               : 'bg-gray-300 text-gray-500 cursor-not-allowed'
85 |           }`}
86 |         >
87 |           Continuar <ChevronRight size={20} className="ml-1" />
88 |         </button>
89 |       </div>
90 |     </motion.div>
91 |   );
92 | }
```

src/components/Footer.tsx
```
1 | import { Link } from "react-router-dom";
2 | import { APP_CONFIG } from "../config/app";
3 | 
4 | export default function Footer() {
5 |   return (
6 |     <footer className="w-full bg-white/80 py-3 md:py-4 backdrop-blur-sm mt-auto">
7 |       <div className="max-w-6xl mx-auto px-4 sm:px-6 md:px-8 flex flex-col md:flex-row justify-between items-center">
8 |         <div className="mb-2 md:mb-0">
9 |           <img src="/logo_png.png" alt="TaleMe Logo" className="h-12 md:h-14" />
10 |         </div>
11 |         
12 |         <div className="text-[#555] text-xs text-center md:text-left mb-2 md:mb-0">
13 |           <div>
14 |             &copy; {new Date().getFullYear()} TaleMe!. Todos los derechos reservados.
15 |           </div>
16 |           <div className="text-[#777] text-xs mt-1 text-center">
17 |             v{APP_CONFIG.version}
18 |           </div>
19 |         </div>
20 |         
21 |         <div className="mt-2 md:mt-0 flex gap-4">
22 |           <Link to={APP_CONFIG.footerLinks.terms} className="text-[#BB79D1] hover:text-[#A5D6F6] transition-colors text-sm">Términos</Link>
23 |           <Link to={APP_CONFIG.footerLinks.privacy} className="text-[#BB79D1] hover:text-[#A5D6F6] transition-colors text-sm">Privacidad</Link>
24 |           <Link to={APP_CONFIG.footerLinks.contact} className="text-[#BB79D1] hover:text-[#A5D6F6] transition-colors text-sm">Contacto</Link>
25 |           <Link to={APP_CONFIG.footerLinks.changelog} className="text-[#BB79D1] hover:text-[#A5D6F6] transition-colors text-sm">Changelog</Link>
26 |         </div>
27 |       </div>
28 |     </footer>
29 |   );
30 | } 
```

src/components/IconLoadingAnimation.tsx
```
1 | import { motion } from "framer-motion";
2 | 
3 | interface IconLoadingAnimationProps {
4 |   message?: string;
5 | }
6 | 
7 | export default function IconLoadingAnimation({ message = "Loading..." }: IconLoadingAnimationProps) {
8 |   // Variantes para la animación del icono principal
9 |   const iconVariants = {
10 |     rotate: {
11 |       rotate: [0, 10, 0, -10, 0],
12 |       y: [0, -10, 0, -5, 0],
13 |       transition: {
14 |         duration: 5,
15 |         repeat: Infinity,
16 |         ease: "easeInOut",
17 |       }
18 |     }
19 |   };
20 | 
21 |   // Variantes para las estrellas/partículas
22 |   const particleVariants = {
23 |     animate: (i: number) => ({
24 |       opacity: [0, 0.8, 0],
25 |       scale: [0.4, 1, 0.4],
26 |       y: [0, -40, 0],
27 |       x: [0, i * 15, 0],
28 |       rotate: [0, i * 30, 0],
29 |       transition: {
30 |         duration: 3,
31 |         repeat: Infinity,
32 |         delay: i * 0.2,
33 |         ease: "easeInOut",
34 |       }
35 |     })
36 |   };
37 | 
38 |   // Variantes para el brillo
39 |   const glowVariants = {
40 |     animate: {
41 |       opacity: [0.4, 0.8, 0.4],
42 |       scale: [0.9, 1.1, 0.9],
43 |       transition: {
44 |         duration: 3,
45 |         repeat: Infinity,
46 |         ease: "easeInOut",
47 |       }
48 |     }
49 |   };
50 | 
51 |   // Variantes para el texto
52 |   const textVariants = {
53 |     animate: {
54 |       opacity: [0.7, 1, 0.7],
55 |       transition: {
56 |         duration: 2,
57 |         repeat: Infinity,
58 |         ease: "easeInOut",
59 |       }
60 |     }
61 |   };
62 | 
63 |   // Crear un array para las partículas
64 |   const particles = Array.from({ length: 5 }, (_, i) => i - 2);
65 | 
66 |   return (
67 |     <div className="flex flex-col items-center justify-center space-y-8">
68 |       <div className="relative">
69 |         {/* Círculo de brillo detrás del icono */}
70 |         <motion.div
71 |           className="absolute inset-0 rounded-full bg-gradient-to-r from-[#F6A5B7]/40 to-[#BB79D1]/40 blur-md"
72 |           variants={glowVariants}
73 |           animate="animate"
74 |         />
75 |         
76 |         {/* Partículas/estrellas alrededor del icono */}
77 |         {particles.map((i) => (
78 |           <motion.div
79 |             key={i}
80 |             className="absolute top-1/2 left-1/2 w-4 h-4"
81 |             custom={i}
82 |             variants={particleVariants}
83 |             animate="animate"
84 |           >
85 |             <div className="w-full h-full bg-[#F9DA60] rounded-full" />
86 |           </motion.div>
87 |         ))}
88 |         
89 |         {/* Icono principal */}
90 |         <motion.div
91 |           className="relative z-10 w-32 h-32 flex items-center justify-center"
92 |           variants={iconVariants}
93 |           animate="rotate"
94 |         >
95 |           <img 
96 |             src="/icono_png.png" 
97 |             alt="Cuenta Cuentos" 
98 |             className="w-full h-full object-contain drop-shadow-lg" 
99 |           />
100 |         </motion.div>
101 |       </div>
102 |       
103 |       {/* Mensaje de carga */}
104 |       <motion.p
105 |         className="text-xl font-medium text-[#222] bg-white/80 px-6 py-2 rounded-xl shadow-md font-heading"
106 |         variants={textVariants}
107 |         animate="animate"
108 |       >
109 |         {message}
110 |       </motion.p>
111 |     </div>
112 |   );
113 | }
```

src/components/LanguageSelector.tsx
```
1 | import { useState, useEffect } from 'react';
2 | import { motion } from 'framer-motion';
3 | import { ChevronRight, ArrowLeft } from 'lucide-react';
4 | import { ChallengeService } from '../services/ai/ChallengeService';
5 | 
6 | interface LanguageSelectorProps {
7 |   currentLanguage: string;
8 |   onSelectLanguage: (language: string) => void;
9 |   onContinue: () => void;
10 |   onBack: () => void;
11 | }
12 | 
13 | export default function LanguageSelector({
14 |   currentLanguage,
15 |   onSelectLanguage,
16 |   onContinue,
17 |   onBack
18 | }: LanguageSelectorProps) {
19 |   const [languages, setLanguages] = useState<Array<{ code: string; name: string }>>([]);
20 |   const [selectedLanguage, setSelectedLanguage] = useState<string | null>(null);
21 | 
22 |   useEffect(() => {
23 |     async function fetchLanguages() {
24 |       const availableLanguages = await ChallengeService.getAvailableLanguages(currentLanguage);
25 |       setLanguages(availableLanguages);
26 |     }
27 |     
28 |     fetchLanguages();
29 |   }, [currentLanguage]);
30 | 
31 |   const handleLanguageSelect = (languageCode: string) => {
32 |     setSelectedLanguage(languageCode);
33 |     onSelectLanguage(languageCode);
34 |   };
35 | 
36 |   return (
37 |     <motion.div
38 |       initial={{ opacity: 0, y: 20 }}
39 |       animate={{ opacity: 1, y: 0 }}
40 |       exit={{ opacity: 0, y: -20 }}
41 |       transition={{ duration: 0.5 }}
42 |       className="bg-white/80 rounded-2xl p-6 mb-8 text-[#222] shadow-lg"
43 |     >
44 |       <button 
45 |         onClick={onBack}
46 |         className="mb-4 flex items-center text-[#BB79D1] hover:text-[#F6A5B7] transition-colors font-medium"
47 |       >
48 |         <ArrowLeft size={16} className="mr-1" />
49 |         Volver a categorías
50 |       </button>
51 | 
52 |       <h2 className="text-2xl font-bold text-center mb-4 text-[#BB79D1] font-heading drop-shadow-lg">Selecciona un idioma</h2>
53 |       <p className="text-lg text-[#222] bg-white/70 rounded-xl px-4 py-2 text-center mb-6 font-medium shadow-sm">Elige el idioma que quieres aprender:</p>
54 | 
55 |       <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-8">
56 |         {languages.map((lang) => (
57 |           <button
58 |             key={lang.code}
59 |             onClick={() => handleLanguageSelect(lang.code)}
60 |             className={`flex flex-col items-center p-3 rounded-xl transition-all shadow-md ${
61 |               selectedLanguage === lang.code
62 |                 ? 'bg-[#7DC4E0] text-white border-2 border-[#7DC4E0] ring-2 ring-[#7DC4E0]/50'
63 |                 : 'bg-white/70 border-2 border-[#7DC4E0]/30 text-[#222] hover:bg-[#7DC4E0]/10'
64 |             }`}
65 |           >
66 |             <span className="font-medium">{lang.name}</span>
67 |           </button>
68 |         ))}
69 |       </div>
70 | 
71 |       <div className="flex justify-center">
72 |         <button
73 |           onClick={onContinue}
74 |           disabled={!selectedLanguage}
75 |           className={`flex items-center justify-center px-5 sm:px-6 py-3 sm:py-4 rounded-2xl font-semibold transition-all shadow-lg text-base sm:text-lg ${
76 |             selectedLanguage
77 |               ? 'bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white active:bg-[#E6B7D9] focus:bg-[#E6B7D9]'
78 |               : 'bg-gray-300 text-gray-500 cursor-not-allowed'
79 |           }`}
80 |         >
81 |           Confirmar <ChevronRight size={20} className="ml-1" />
82 |         </button>
83 |       </div>
84 |     </motion.div>
85 |   );
86 | } 
```

src/components/LoadingAnimation.tsx
```
1 | 
2 | import { motion } from "framer-motion";
3 | 
4 | interface LoadingAnimationProps {
5 |   message?: string;
6 | }
7 | 
8 | export default function LoadingAnimation({ message = "Loading..." }: LoadingAnimationProps) {
9 |   return (
10 |     <div className="flex flex-col items-center justify-center space-y-6">
11 |       <motion.div
12 |         className="w-24 h-24 rounded-full bg-story-orange-400 flex items-center justify-center"
13 |         animate={{
14 |           scale: [1, 1.1, 1],
15 |           opacity: [0.7, 1, 0.7],
16 |         }}
17 |         transition={{
18 |           duration: 2,
19 |           repeat: Infinity,
20 |           ease: "easeInOut",
21 |         }}
22 |       >
23 |         <motion.div
24 |           className="w-16 h-16 rounded-full bg-story-purple-500 flex items-center justify-center"
25 |           animate={{
26 |             scale: [1, 1.15, 1],
27 |             opacity: [0.7, 1, 0.7],
28 |           }}
29 |           transition={{
30 |             duration: 2,
31 |             repeat: Infinity,
32 |             ease: "easeInOut",
33 |             delay: 0.2,
34 |           }}
35 |         >
36 |           <motion.div
37 |             className="w-8 h-8 rounded-full bg-story-blue-400"
38 |             animate={{
39 |               scale: [1, 1.2, 1],
40 |               opacity: [0.7, 1, 0.7],
41 |             }}
42 |             transition={{
43 |               duration: 2,
44 |               repeat: Infinity,
45 |               ease: "easeInOut",
46 |               delay: 0.4,
47 |             }}
48 |           />
49 |         </motion.div>
50 |       </motion.div>
51 |       
52 |       <motion.p
53 |         className="text-xl font-medium text-white"
54 |         animate={{
55 |           opacity: [0.7, 1, 0.7],
56 |         }}
57 |         transition={{
58 |           duration: 2,
59 |           repeat: Infinity,
60 |           ease: "easeInOut",
61 |         }}
62 |       >
63 |         {message}
64 |       </motion.p>
65 |     </div>
66 |   );
67 | }
```

src/components/MainLayout.tsx
```
1 | import { ReactNode } from "react";
2 | import Footer from "./Footer";
3 | 
4 | interface MainLayoutProps {
5 |   children: ReactNode;
6 |   hideFooter?: boolean;
7 | }
8 | 
9 | export default function MainLayout({ children, hideFooter = false }: MainLayoutProps) {
10 |   return (
11 |     <div className="flex flex-col min-h-screen">
12 |       <main className="flex-grow">
13 |         {children}
14 |       </main>
15 |       
16 |       {!hideFooter && <Footer />}
17 |     </div>
18 |   );
19 | } 
```

src/components/ManageSubscriptionButton.tsx
```
1 | import { useState } from 'react';
2 | import { Settings } from 'lucide-react';
3 | import { Button } from '@/components/ui/button.tsx'; 
4 | import { useToast } from '@/hooks/use-toast.ts'; 
5 | import { createCustomerPortalSession } from '../services/stripeService.ts'; 
6 | 
7 | interface ManageSubscriptionButtonProps {
8 |   className?: string;
9 | }
10 | 
11 | export default function ManageSubscriptionButton({ className = '' }: ManageSubscriptionButtonProps) {
12 |   const [isLoading, setIsLoading] = useState(false);
13 |   const { toast } = useToast();
14 | 
15 |   const handleManageSubscription = async () => {
16 |     setIsLoading(true);
17 | 
18 |     try {
19 |       // Llamada a la función del servicio (que llama a la Edge Function)
20 |       const { url, error } = await createCustomerPortalSession();
21 | 
22 |       if (error) {
23 |         // Manejo de errores específicos devueltos por el servicio
24 |         console.error("Error from createCustomerPortalSession:", error);
25 |         // Podrías querer ser más específico aquí si el servicio devuelve códigos o mensajes clave
26 |         if (error.includes('No se encontró información de cliente') || error.includes('404')) { // Ejemplo de verificación
27 |           toast({
28 |             title: "No hay suscripción activa",
29 |             description: "Necesitas tener una suscripción activa o haber realizado una compra previamente.",
30 |             variant: "destructive"
31 |           });
32 |         } else {
33 |           toast({
34 |             title: "Error al acceder al portal",
35 |             description: error, // Muestra el error devuelto por el servicio/función
36 |             variant: "destructive"
37 |           });
38 |         }
39 |       } else if (url) {
40 |         // Redirigir al Stripe Customer Portal
41 |         console.log(`Redirigiendo al Portal de Cliente de Stripe: ${url}`);
42 |         window.location.href = url;
43 |       } else {
44 |         // Caso inesperado: sin error pero sin URL
45 |         console.error("No URL received from createCustomerPortalSession");
46 |         toast({
47 |           title: "Error",
48 |           description: "No se recibió una URL válida del portal.",
49 |           variant: "destructive"
50 |         });
51 |       }
52 |     } catch (err) { // err es 'unknown'
53 |       // Manejo de errores inesperados (ej. red, error no capturado antes)
54 |       console.error("Unexpected error in handleManageSubscription:", err);
55 |       let errorMessage = "Ocurrió un error inesperado al procesar la solicitud.";
56 |       // Opcional: intentar obtener un mensaje más específico
57 |       // if (err instanceof Error) { errorMessage = err.message; }
58 |       // else if (typeof err === 'string') { errorMessage = err; }
59 |       toast({
60 |         title: "Error inesperado",
61 |         description: errorMessage,
62 |         variant: "destructive"
63 |       });
64 |     } finally {
65 |       setIsLoading(false);
66 |     }
67 |   };
68 | 
69 |   return (
70 |     <Button
71 |       onClick={handleManageSubscription}
72 |       disabled={isLoading}
73 |       className={`bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center justify-center ${className}`}
74 |     >
75 |       <Settings className="mr-2 h-5 w-5" />
76 |       {isLoading ? 'Procesando...' : 'Gestionar Suscripción'}
77 |     </Button>
78 |   );
79 | }
```

src/components/PageTransition.tsx
```
1 | 
2 | import { motion } from "framer-motion";
3 | import { ReactNode } from "react";
4 | 
5 | interface PageTransitionProps {
6 |   children: ReactNode;
7 |   className?: string;
8 | }
9 | 
10 | export default function PageTransition({ children, className = "" }: PageTransitionProps) {
11 |   return (
12 |     <motion.div
13 |       initial={{ opacity: 0, y: 20 }}
14 |       animate={{ opacity: 1, y: 0 }}
15 |       exit={{ opacity: 0, y: -20 }}
16 |       transition={{ duration: 0.5, ease: "easeInOut" }}
17 |       className={`w-full min-h-screen ${className}`}
18 |     >
19 |       {children}
20 |     </motion.div>
21 |   );
22 | }
```

src/components/PaymentButtons.tsx
```
1 | import { useState } from 'react';
2 | import { createCheckoutSession } from '../services/stripeService';
3 | import { useToast } from '@/hooks/use-toast';
4 | import { CreditCard, Sparkles } from 'lucide-react';
5 | import { Button } from '@/components/ui/button';
6 | 
7 | interface PaymentButtonsProps {
8 |   className?: string;
9 |   showBoth?: boolean; // Si es false, solo muestra el botón de premium
10 | }
11 | 
12 | export default function PaymentButtons({ className = '', showBoth = true }: PaymentButtonsProps) {
13 |   const [isLoading, setIsLoading] = useState<'premium' | 'credits' | null>(null);
14 |   const { toast } = useToast();
15 | 
16 |   const handlePurchase = async (item: 'premium' | 'credits') => {
17 |     setIsLoading(item);
18 |     
19 |     try {
20 |       const { url, error } = await createCheckoutSession(item);
21 |       
22 |       if (error) {
23 |         toast({
24 |           title: "Error al iniciar el pago",
25 |           description: error,
26 |           variant: "destructive"
27 |         });
28 |       } else if (url) {
29 |         // Redirigir a Stripe Checkout
30 |         console.log(`Redirigiendo a Stripe Checkout: ${url}`);
31 |         window.location.href = url;
32 |       } else {
33 |         toast({
34 |           title: "Error",
35 |           description: "No se recibió una URL de pago válida.",
36 |           variant: "destructive"
37 |         });
38 |       }
39 |     } catch (err) {
40 |       toast({
41 |         title: "Error inesperado",
42 |         description: "Ocurrió un error al procesar la solicitud de pago.",
43 |         variant: "destructive"
44 |       });
45 |       console.error(err);
46 |     } finally {
47 |       setIsLoading(null);
48 |     }
49 |   };
50 | 
51 |   return (
52 |     <div className={`flex ${showBoth ? 'flex-col sm:flex-row' : 'flex-col'} gap-3 ${className}`}>
53 |       <Button 
54 |         onClick={() => handlePurchase('premium')}
55 |         disabled={isLoading !== null}
56 |         className="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center justify-center"
57 |       >
58 |         <Sparkles className="mr-2 h-5 w-5" />
59 |         {isLoading === 'premium' ? 'Procesando...' : 'Suscripción Premium'}
60 |       </Button>
61 |       
62 |       {showBoth && (
63 |         <Button 
64 |           onClick={() => handlePurchase('credits')}
65 |           disabled={isLoading !== null}
66 |           className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center justify-center"
67 |         >
68 |           <CreditCard className="mr-2 h-5 w-5" />
69 |           {isLoading === 'credits' ? 'Procesando...' : 'Comprar Créditos de Voz'}
70 |         </Button>
71 |       )}
72 |     </div>
73 |   );
74 | }
```

src/components/PreviewVoiceModal.tsx
```
1 | import { Dispatch, SetStateAction, useEffect, useRef, useState } from "react";
2 | import { motion, AnimatePresence } from "framer-motion";
3 | import { X, Play, Pause } from "lucide-react";
4 | import { Slider } from "@/components/ui/slider";
5 | import { Button } from "@/components/ui/button";
6 | 
7 | interface Voice {
8 |   id: string;
9 |   name: string;
10 |   icon: React.ReactNode;
11 |   color: string;
12 |   description?: string;
13 | }
14 | 
15 | interface PreviewVoiceModalProps {
16 |   voice: Voice;
17 |   url: string;
18 |   open: boolean;
19 |   onClose: () => void;
20 | }
21 | 
22 | export function PreviewVoiceModal({
23 |   voice,
24 |   url,
25 |   open,
26 |   onClose,
27 | }: PreviewVoiceModalProps) {
28 |   const audioRef = useRef<HTMLAudioElement>(new Audio(url));
29 |   const [isPlaying, setIsPlaying] = useState(false);
30 |   const [volume, setVolume] = useState(0.8);
31 | 
32 |   // actualizar src cuando cambie la URL
33 |   useEffect(() => {
34 |     if (audioRef.current.src !== url) {
35 |       audioRef.current.pause();
36 |       audioRef.current = new Audio(url);
37 |       audioRef.current.volume = volume;
38 |       setIsPlaying(false);
39 |     }
40 |   }, [url]);
41 | 
42 |   // limpiar al desmontar
43 |   useEffect(() => {
44 |     return () => {
45 |       audioRef.current.pause();
46 |       audioRef.current.src = "";
47 |     };
48 |   }, []);
49 | 
50 |   // sincronizar volumen
51 |   useEffect(() => {
52 |     audioRef.current.volume = volume;
53 |   }, [volume]);
54 | 
55 |   const togglePlay = () => {
56 |     if (isPlaying) {
57 |       audioRef.current.pause();
58 |       setIsPlaying(false);
59 |     } else {
60 |       audioRef.current
61 |         .play()
62 |         .then(() => setIsPlaying(true))
63 |         .catch(() => /* manejar error */ null);
64 |     }
65 |   };
66 | 
67 |   return (
68 |     <AnimatePresence>
69 |       {open && (
70 |         <motion.div
71 |           className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"
72 |           initial={{ opacity: 0 }}
73 |           animate={{ opacity: 1 }}
74 |           exit={{ opacity: 0 }}
75 |         >
76 |           <motion.div
77 |             className="w-full max-w-xs bg-white rounded-2xl overflow-hidden shadow-lg"
78 |             initial={{ scale: 0.9 }}
79 |             animate={{ scale: 1 }}
80 |             exit={{ scale: 0.9 }}
81 |           >
82 |             {/* Header */}
83 |             <div className="flex justify-between items-center px-4 py-2 bg-gray-100">
84 |               <h2 className="text-lg font-semibold text-gray-800">
85 |                 Vista previa de voz
86 |               </h2>
87 |               <button onClick={onClose} className="p-1">
88 |                 <X size={20} className="text-gray-600" />
89 |               </button>
90 |             </div>
91 | 
92 |             {/* Body */}
93 |             <div className="px-6 py-8 flex flex-col items-center space-y-4">
94 |               <div
95 |                 className="text-6xl"
96 |                 style={{ color: voice.color }}
97 |               >
98 |                 {voice.icon}
99 |               </div>
100 |               <h3 className="text-xl font-medium text-gray-800">
101 |                 {voice.name}
102 |               </h3>
103 |               {voice.description && (
104 |                 <p className="text-sm text-gray-600 text-center">
105 |                   {voice.description}
106 |                 </p>
107 |               )}
108 | 
109 |               {/* Play/Pause */}
110 |               <button
111 |                 onClick={togglePlay}
112 |                 className="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center shadow-md"
113 |                 style={{ color: voice.color }}
114 |               >
115 |                 {isPlaying ? (
116 |                   <Pause size={28} />
117 |                 ) : (
118 |                   <Play size={28} />
119 |                 )}
120 |               </button>
121 | 
122 |               {/* Volume Slider */}
123 |               <div className="w-full">
124 |                 <Slider
125 |                   value={[volume]}
126 |                   step={0.01}
127 |                   max={1}
128 |                   onValueChange={(v) => setVolume(v[0])}
129 |                 />
130 |               </div>
131 | 
132 |               <Button
133 |                 variant="ghost"
134 |                 size="sm"
135 |                 onClick={onClose}
136 |               >
137 |                 Cerrar
138 |               </Button>
139 |             </div>
140 |           </motion.div>
141 |         </motion.div>
142 |       )}
143 |     </AnimatePresence>
144 |   );
145 | }
```

src/components/ProgressBar.tsx
```
1 | import { motion } from "framer-motion";
2 | 
3 | interface ProgressBarProps {
4 |   current: number;
5 |   total: number;
6 | }
7 | 
8 | export default function ProgressBar({ current, total }: ProgressBarProps) {
9 |   const progress = (current / total) * 100;
10 |   
11 |   return (
12 |     <div className="mb-8">
13 |       <div className="flex justify-between text-xs text-white/70 mb-2">
14 |         <span>Paso {current} de {total}</span>
15 |         <span>{Math.round(progress)}%</span>
16 |       </div>
17 |       <div className="h-2 w-full bg-white/10 rounded-full overflow-hidden">
18 |         <motion.div
19 |           initial={{ width: 0 }}
20 |           animate={{ width: `${progress}%` }}
21 |           transition={{ duration: 0.5, ease: "easeOut" }}
22 |           className="h-full bg-primary-orange rounded-full"
23 |         />
24 |       </div>
25 |     </div>
26 |   );
27 | } 
```

src/components/StoryAudioPlayer.tsx
```
1 | import { useState, useEffect, useRef } from "react";
2 | import { Play, Pause, X, AlertCircle } from "lucide-react";
3 | import { Button } from "@/components/ui/button";
4 | import { Slider } from "@/components/ui/slider";
5 | import { motion } from "framer-motion";
6 | import { cn } from "@/lib/utils";
7 | import { generateSpeech, OPENAI_VOICES, OpenAIVoiceType } from "@/services/ai/ttsService";
8 | import { useAudioStore } from "@/store/stories/audio/audioStore";
9 | import { useUserStore } from "@/store/user/userStore";
10 | import { toast } from "sonner";
11 | import { STORY_VOICES, PLAYBACK_SPEEDS } from "@/constants/story-voices.constant";
12 | 
13 | 
14 | // Function to format time
15 | const formatTime = (seconds: number): string => {
16 |   if (isNaN(seconds)) return "0:00";
17 |   const minutes = Math.floor(seconds / 60);
18 |   const remainingSeconds = Math.floor(seconds % 60);
19 |   return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
20 | };
21 | 
22 | interface StoryAudioPlayerProps {
23 |   text: string;
24 |   onClose: () => void;
25 | }
26 | 
27 | export default function StoryAudioPlayer({ text, onClose }: StoryAudioPlayerProps) {
28 |   const { 
29 |     addAudioToCache, 
30 |     getAudioFromCache, 
31 |     setGenerationStatus, 
32 |     getGenerationStatus,
33 |     setCurrentVoice,
34 |     getCurrentVoice
35 |   } = useAudioStore();
36 |   
37 |   const { canGenerateVoice, isPremium, getRemainingMonthlyVoiceGenerations, getAvailableVoiceCredits } = useUserStore();
38 | 
39 |   const [isPlaying, setIsPlaying] = useState(false);
40 |   const [isLoading, setIsLoading] = useState(false);
41 |   const [currentTime, setCurrentTime] = useState(0);
42 |   const [duration, setDuration] = useState(0);
43 |   const [audioUrl, setAudioUrl] = useState<string | null>(null);
44 |   const [selectedVoice, setSelectedVoice] = useState<typeof STORY_VOICES[0]>(() => {
45 |     const savedVoiceId = getCurrentVoice();
46 |     if (savedVoiceId) {
47 |       const voiceIdx = STORY_VOICES.findIndex(v => v.id === savedVoiceId);
48 |       if (voiceIdx !== -1) {
49 |         return STORY_VOICES[voiceIdx];
50 |       }
51 |     }
52 |     return STORY_VOICES[0];
53 |   });
54 |   const [playbackSpeed, setPlaybackSpeed] = useState(1);
55 |   const [showGenerationPopup, setShowGenerationPopup] = useState(false);
56 |   const [generationProgress, setGenerationProgress] = useState(0);
57 |   const audioRef = useRef<HTMLAudioElement>(null);
58 | 
59 |   // Guardar la voz seleccionada en el store
60 |   useEffect(() => {
61 |     setCurrentVoice(selectedVoice.id);
62 |   }, [selectedVoice.id, setCurrentVoice]);
63 | 
64 |   // Cleanup when component unmounts
65 |   useEffect(() => {
66 |     return () => {
67 |       if (audioRef.current) {
68 |         audioRef.current.pause();
69 |         audioRef.current.src = '';
70 |       }
71 |       if (audioUrl && !audioUrl.startsWith('blob:')) {
72 |         URL.revokeObjectURL(audioUrl);
73 |       }
74 |     };
75 |   }, [audioUrl]);
76 | 
77 |   // Update time display
78 |   useEffect(() => {
79 |     let interval: NodeJS.Timeout;
80 |     if (isPlaying && audioRef.current) {
81 |       interval = setInterval(() => {
82 |         setCurrentTime(audioRef.current?.currentTime || 0);
83 |       }, 100);
84 |     }
85 |     return () => clearInterval(interval);
86 |   }, [isPlaying]);
87 | 
88 |   // Update duration when metadata is loaded
89 |   useEffect(() => {
90 |     if (audioRef.current) {
91 |       const handleLoadedMetadata = () => {
92 |         setDuration(audioRef.current?.duration || 0);
93 |       };
94 | 
95 |       audioRef.current.addEventListener('loadedmetadata', handleLoadedMetadata);
96 |       return () => {
97 |         audioRef.current?.removeEventListener('loadedmetadata', handleLoadedMetadata);
98 |       };
99 |     }
100 |   }, []);
101 | 
102 |   // Update audio source when URL changes
103 |   useEffect(() => {
104 |     if (audioRef.current && audioUrl) {
105 |       if (audioUrl.startsWith('blob:')) {
106 |         audioRef.current.src = audioUrl;
107 |       } else {
108 |         fetch(audioUrl)
109 |           .then(response => response.blob())
110 |           .then(blob => {
111 |             const audioObjUrl = URL.createObjectURL(new Blob([blob], { type: 'audio/mp4' }));
112 |             audioRef.current.src = audioObjUrl;
113 |           });
114 |       }
115 |       audioRef.current.load();
116 |     }
117 |   }, [audioUrl]);
118 | 
119 |   // Update playback speed
120 |   useEffect(() => {
121 |     if (audioRef.current) {
122 |       audioRef.current.playbackRate = playbackSpeed;
123 |     }
124 |   }, [playbackSpeed]);
125 | 
126 |   const handlePlayPause = async () => {
127 |     if (!audioUrl) {
128 |       setShowGenerationPopup(true);
129 |       return;
130 |     }
131 | 
132 |     if (audioRef.current) {
133 |       if (isPlaying) {
134 |         audioRef.current.pause();
135 |         setIsPlaying(false);
136 |       } else {
137 |         try {
138 |           await audioRef.current.play().catch(error => {
139 |             console.error('Safari playback error:', error);
140 |             toast.error("Safari requiere interacción directa - Haz click primero en el botón");
141 |           });
142 |           setIsPlaying(true);
143 |         } catch (error) {
144 |           console.error('Error starting playback:', error);
145 |           setIsPlaying(false);
146 |           toast.error("No se pudo reproducir el audio");
147 |         }
148 |       }
149 |     }
150 |   };
151 | 
152 |   const handleGenerateAudio = async () => {
153 |     // Verificar si el usuario puede generar audio según su plan y límites
154 |     if (!canGenerateVoice()) {
155 |       const isPremiumUser = isPremium();
156 |       const remainingGenerations = getRemainingMonthlyVoiceGenerations();
157 |       const availableCredits = getAvailableVoiceCredits();
158 |       
159 |       if (isPremiumUser && remainingGenerations <= 0) {
160 |         toast.error("Has alcanzado el límite mensual de generaciones de voz para tu plan premium.");
161 |         return;
162 |       } else if (!isPremiumUser && availableCredits <= 0) {
163 |         toast.error("No tienes créditos disponibles para generar audio. Actualiza a premium para obtener más generaciones mensuales.");
164 |         return;
165 |       }
166 |     }
167 |     
168 |     try {
169 |       setIsLoading(true);
170 |       // Usamos un ID temporal para identificar la generación
171 |       const tempId = "temp-audio";
172 |       
173 |       setGenerationStatus(tempId, "chapter", 'generating', 10);
174 |       setGenerationProgress(10);
175 |       
176 |       // Simulate generation progress (in real implementation, you would get actual progress)
177 |       const progressInterval = setInterval(() => {
178 |         setGenerationProgress(prev => {
179 |           const newValue = prev + Math.random() * 15;
180 |           const progress = newValue > 90 ? 90 : newValue;
181 |           setGenerationStatus(tempId, "chapter", 'generating', progress);
182 |           return progress;
183 |         });
184 |       }, 800);
185 | 
186 |       // Mapeo de voces de la historia a las voces de OpenAI
187 |       const voiceApiMapping: {[key: string]: OpenAIVoiceType} = {
188 |         "el-sabio": "sage",
189 |         "el-capitan": "onyx",
190 |         "el-animado": "ash",
191 |         "el-elegante": "alloy",
192 |         "el-aventurero": "echo",
193 |         "el-enigmatico": "fable",
194 |         "el-risueno": "nova",
195 |         "el-tierno": "coral"
196 |       };
197 |       
198 |       // Instrucciones específicas según el tipo de narrador
199 |       const narratorInstructions: {[key: string]: string} = {
200 |         "el-sabio": "Narra con un tono grave y reflexivo, haciendo pausas significativas entre oraciones importantes.",
201 |         "el-capitan": "Narra con energía y autoridad, enfatizando las palabras de acción y aventura.",
202 |         "el-animado": "Narra con entusiasmo y diversión, variando el tono para mantener la atención de los niños.",
203 |         "el-elegante": "Narra con un tono refinado y sofisticado, articulando cada palabra con claridad.",
204 |         "el-aventurero": "Narra con emoción y dinamismo, acelerando el ritmo en los momentos de acción.",
205 |         "el-enigmatico": "Narra con un tono misterioso y pausado, generando intriga en cada frase.",
206 |         "el-risueno": "Narra con alegría y optimismo, transmitiendo positividad en la historia.",
207 |         "el-tierno": "Narra con dulzura y calidez, creando un ambiente íntimo y reconfortante."
208 |       };
209 | 
210 |       // Generar el audio con la nueva API
211 |       const audioBlob = await generateSpeech({
212 |         text,
213 |         voice: voiceApiMapping[selectedVoice.id] || "nova",
214 |         model: 'gpt-4o-mini-tts',
215 |         instructions: narratorInstructions[selectedVoice.id]
216 |       });
217 | 
218 |       // Crear URL para el blob
219 |       const audioObjUrl = URL.createObjectURL(audioBlob);
220 |       setAudioUrl(audioObjUrl);
221 |       
222 |       // Guardar en caché
223 |       addAudioToCache(tempId, "chapter", selectedVoice.id, audioObjUrl);
224 |       setGenerationStatus(tempId, "chapter", 'completed', 100);
225 |       
226 |       setShowGenerationPopup(false);
227 |       setIsPlaying(true);
228 | 
229 |       clearInterval(progressInterval);
230 |       setGenerationProgress(100);
231 | 
232 |       // Reproducir automáticamente después de la generación
233 |       if (audioRef.current) {
234 |         try {
235 |           await audioRef.current.play().catch(error => {
236 |             console.error('Safari playback error:', error);
237 |             toast.error("Safari requiere interacción directa - Haz click primero en el botón");
238 |           });
239 |           setIsPlaying(true);
240 |         } catch (error) {
241 |           console.error('Error auto-playing after generation:', error);
242 |         }
243 |       }
244 |     } catch (error) {
245 |       console.error('Error generating audio:', error);
246 |       toast.error("Error al generar el audio");
247 |       setGenerationStatus("temp-audio", "chapter", 'error', 0);
248 |     } finally {
249 |       setIsLoading(false);
250 |     }
251 |   };
252 | 
253 |   const handleSeek = (value: number[]) => {
254 |     if (audioRef.current) {
255 |       audioRef.current.currentTime = value[0];
256 |       setCurrentTime(value[0]);
257 |     }
258 |   };
259 | 
260 |   const handleVoiceChange = (voice: typeof STORY_VOICES[0]) => {
261 |     setSelectedVoice(voice);
262 |     setAudioUrl(null);
263 |   };
264 | 
265 |   const handlePlaybackSpeedChange = (speed: number) => {
266 |     setPlaybackSpeed(speed);
267 |     if (audioRef.current) {
268 |       audioRef.current.playbackRate = speed;
269 |     }
270 |   };
271 | 
272 |   const handleEndedEvent = () => {
273 |     setIsPlaying(false);
274 |     setCurrentTime(duration);
275 |   };
276 | 
277 |   const handleClose = () => {
278 |     if (isPlaying && audioRef.current) {
279 |       audioRef.current.pause();
280 |     }
281 |     onClose();
282 |   };
283 | 
284 |   return (
285 |     <motion.div
286 |       initial={{ opacity: 0, y: 20 }}
287 |       animate={{ opacity: 1, y: 0 }}
288 |       exit={{ opacity: 0, y: 20 }}
289 |       transition={{ duration: 0.3 }}
290 |       className={cn(
291 |         "w-full max-w-md mx-auto rounded-3xl overflow-hidden shadow-2xl",
292 |         selectedVoice.color
293 |       )}
294 |     >
295 |       {/* Header with title */}
296 |       <div className="px-6 pt-6 pb-2">
297 |         <div className="flex justify-between items-center">
298 |           <h2 className="text-xl font-bold text-white truncate pr-4">{}</h2>
299 |           <Button 
300 |             variant="ghost" 
301 |             size="icon" 
302 |             onClick={handleClose}
303 |             className="rounded-full text-white hover:bg-white/20"
304 |           >
305 |             <X size={24} />
306 |           </Button>
307 |         </div>
308 |       </div>
309 | 
310 |       {/* Main player area */}
311 |       <div className="bg-white/15 backdrop-blur-lg p-8 text-white">
312 |         {/* Voice indicator */}
313 |         <div className="flex items-center justify-center gap-2 mb-6">
314 |           <span className="text-4xl">{selectedVoice.icon}</span>
315 |           <div className="text-center">
316 |             <p className="text-lg font-semibold">Narrado por</p>
317 |             <p className="text-2xl font-bold">{selectedVoice.name}</p>
318 |           </div>
319 |         </div>
320 | 
321 |         {/* Play button */}
322 |         <div className="flex justify-center mb-8">
323 |           <Button
324 |             onClick={handlePlayPause}
325 |             disabled={isLoading}
326 |             className={cn(
327 |               "w-24 h-24 rounded-full border-4 border-white/30",
328 |               "flex items-center justify-center",
329 |               "bg-white/20 hover:bg-white/30 transition-all"
330 |             )}
331 |           >
332 |             {isLoading ? (
333 |               <div className="w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin" />
334 |             ) : isPlaying ? (
335 |               <Pause className="w-12 h-12" />
336 |             ) : (
337 |               <Play className="w-12 h-12 ml-2" />
338 |             )}
339 |           </Button>
340 |         </div>
341 | 
342 |         {/* Progress bar */}
343 |         <div className="mb-4">
344 |           <Slider
345 |             value={[currentTime]}
346 |             max={duration || 100}
347 |             step={0.1}
348 |             onValueChange={handleSeek}
349 |             disabled={!audioUrl}
350 |             className="mb-2"
351 |           />
352 |           <div className="flex justify-between text-sm">
353 |             <span>{formatTime(currentTime)}</span>
354 |             <span>{formatTime(duration)}</span>
355 |           </div>
356 |         </div>
357 | 
358 |         {/* Playback speed */}
359 |         <div className="mb-4">
360 |           <p className="text-sm mb-2">Velocidad de reproducción</p>
361 |           <div className="flex justify-between gap-2">
362 |             {PLAYBACK_SPEEDS.map(speed => (
363 |               <Button
364 |                 key={speed}
365 |                 variant={playbackSpeed === speed ? "default" : "outline"}
366 |                 size="sm"
367 |                 onClick={() => handlePlaybackSpeedChange(speed)}
368 |                 className={cn(
369 |                   "flex-1 rounded-full",
370 |                   playbackSpeed === speed 
371 |                     ? "bg-white/30 text-white" 
372 |                     : "bg-transparent text-white border-white/50 hover:bg-white/20"
373 |                 )}
374 |               >
375 |                 {speed}x
376 |               </Button>
377 |             ))}
378 |           </div>
379 |         </div>
380 | 
381 |         {/* Voice selector */}
382 |         <div>
383 |           <p className="text-sm mb-2">Seleccionar narrador</p>
384 |           <div className="grid grid-cols-4 gap-2 mb-4">
385 |             {STORY_VOICES.map(voice => (
386 |               <Button
387 |                 key={voice.id}
388 |                 variant="ghost"
389 |                 size="sm"
390 |                 onClick={() => handleVoiceChange(voice)}
391 |                 className={cn(
392 |                   "aspect-square p-1 flex items-center justify-center",
393 |                   "rounded-xl border-2 transition-all",
394 |                   selectedVoice.id === voice.id 
395 |                     ? "border-white bg-white/20" 
396 |                     : "border-transparent hover:border-white/50 hover:bg-white/10"
397 |                 )}
398 |                 title={voice.name}
399 |               >
400 |                 <span className="text-2xl">{voice.icon}</span>
401 |               </Button>
402 |             ))}
403 |           </div>
404 |         </div>
405 | 
406 |         {/* Return button */}
407 |         <Button
408 |           variant="outline"
409 |           className="w-full mt-4 rounded-full border-white/50 text-white hover:bg-white/20 hover:text-white"
410 |           onClick={handleClose}
411 |         >
412 |           Volver a la lectura
413 |         </Button>
414 |       </div>
415 | 
416 |       {/* Audio element (hidden) */}
417 |       <audio
418 |         ref={audioRef}
419 |         onTimeUpdate={() => setCurrentTime(audioRef.current?.currentTime || 0)}
420 |         onEnded={handleEndedEvent}
421 |         className="hidden"
422 |       />
423 | 
424 |       {/* Voice generation popup */}
425 |       {showGenerationPopup && (
426 |         <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
427 |           <motion.div
428 |             initial={{ opacity: 0, scale: 0.9 }}
429 |             animate={{ opacity: 1, scale: 1 }}
430 |             className={cn(
431 |               "w-full max-w-md rounded-3xl p-8 text-white shadow-2xl",
432 |               selectedVoice.color
433 |             )}
434 |           >
435 |             <div className="text-center mb-6">
436 |               <span className="text-5xl mb-4 inline-block">{selectedVoice.icon}</span>
437 |               <h3 className="text-2xl font-bold mb-2">{selectedVoice.name}</h3>
438 |               <p className="text-white/90 mb-6">{selectedVoice.description}</p>
439 |               
440 |               {isLoading ? (
441 |                 <>
442 |                   <div className="w-full bg-white/20 rounded-full h-2 mb-4">
443 |                     <div 
444 |                       className="bg-white h-2 rounded-full" 
445 |                       style={{ width: `${generationProgress}%` }}
446 |                     ></div>
447 |                   </div>
448 |                   <p className="text-white/80">Generando audio, por favor espera...</p>
449 |                 </>
450 |               ) : (
451 |                 <button
452 |                   onClick={handleGenerateAudio}
453 |                   disabled={isLoading || !canGenerateVoice()}
454 |                   className={cn(
455 |                     "flex items-center justify-center gap-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-full font-medium shadow-md hover:from-purple-600 hover:to-indigo-700 transition-all",
456 |                     (isLoading || !canGenerateVoice()) && "opacity-70 cursor-not-allowed"
457 |                   )}
458 |                   title={!canGenerateVoice() ? "Has alcanzado el límite de generaciones de voz" : ""}
459 |                 >
460 |                   {isLoading ? (
461 |                     <>Generando... {Math.round(generationProgress)}%</>
462 |                   ) : (
463 |                     <>
464 |                       Generar Audio
465 |                       {!canGenerateVoice() && <AlertCircle className="ml-1 h-4 w-4" />}
466 |                     </>
467 |                   )}
468 |                 </button>
469 |               )}
470 |             </div>
471 |             
472 |             {!isLoading && (
473 |               <Button
474 |                 variant="ghost"
475 |                 onClick={() => setShowGenerationPopup(false)}
476 |                 className="w-full text-white/80 hover:text-white hover:bg-white/10"
477 |               >
478 |                 Cancelar
479 |               </Button>
480 |             )}
481 |           </motion.div>
482 |         </div>
483 |       )}
484 |     </motion.div>
485 |   );
486 | }
```

src/components/StoryButton.tsx
```
1 | 
2 | import { ButtonHTMLAttributes, ReactNode } from "react";
3 | 
4 | interface StoryButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
5 |   children: ReactNode;
6 |   variant?: "primary" | "secondary";
7 |   icon?: ReactNode;
8 |   isFullWidth?: boolean;
9 | }
10 | 
11 | export default function StoryButton({ 
12 |   children, 
13 |   variant = "primary", 
14 |   icon, 
15 |   isFullWidth = false,
16 |   ...props 
17 | }: StoryButtonProps) {
18 |   return (
19 |     <button
20 |       className={`
21 |         ${variant === "primary" ? "story-btn-primary" : "story-btn-secondary"}
22 |         ${isFullWidth ? "w-full" : ""}
23 |         ${props.disabled ? "opacity-50 cursor-not-allowed" : ""}
24 |         ${props.className || ""}
25 |       `}
26 |       {...props}
27 |     >
28 |       {icon && <span className="mr-2">{icon}</span>}
29 |       {children}
30 |     </button>
31 |   );
32 | }
```

src/components/StoryChapter.tsx
```
1 | import { motion } from "framer-motion";
2 | import { StoryChapter as StoryChapterType } from "../types";
3 | 
4 | interface StoryChapterProps {
5 |   chapter: StoryChapterType;
6 |   isLatest?: boolean;
7 | }
8 | 
9 | export default function StoryChapter({ chapter, isLatest = false }: StoryChapterProps) {
10 |   return (
11 |     <motion.div
12 |       initial={{ opacity: 0, y: 20 }}
13 |       animate={{ opacity: 1, y: 0 }}
14 |       transition={{ duration: 0.5 }}
15 |       className={`${isLatest ? 'bg-white/20' : 'bg-white/15'} backdrop-blur-md rounded-3xl p-6 mb-8 text-white leading-relaxed shadow-xl`}
16 |     >
17 |       <div className="flex items-center justify-between mb-4">
18 |         <div className="flex items-center">
19 |           <div className="bg-story-orange-400 text-white text-xs font-bold rounded-full px-3 py-1 mr-3">
20 |             Capítulo {chapter.chapterNumber}
21 |           </div>
22 |           <h3 className="text-xl font-bold">{chapter.title}</h3>
23 |         </div>
24 |         <div className="text-xs text-white/60">
25 |           {new Date(chapter.createdAt).toLocaleDateString()}
26 |         </div>
27 |       </div>
28 | 
29 |       <div className="prose prose-invert max-w-none">
30 |         {chapter.content.split('\n').map((paragraph, index) => (
31 |           <p key={index} className="mb-4">{paragraph}</p>
32 |         ))}
33 |       </div>
34 |     </motion.div>
35 |   );
36 | }
```

src/components/StoryContinuationCustomInput.tsx
```
1 | import { useState } from "react";
2 | import { motion } from "framer-motion";
3 | import { ArrowLeft, Send } from "lucide-react";
4 | 
5 | interface StoryContinuationCustomInputProps {
6 |   onSubmit: (text: string) => void;
7 |   onBack: () => void;
8 |   disabled?: boolean;
9 | }
10 | 
11 | export default function StoryContinuationCustomInput({
12 |   onSubmit,
13 |   onBack,
14 |   disabled = false
15 | }: StoryContinuationCustomInputProps) {
16 |   const [userInput, setUserInput] = useState("");
17 |   const [isSubmitting, setIsSubmitting] = useState(false);
18 | 
19 |   const handleSubmit = () => {
20 |     if (!userInput.trim()) return;
21 |     
22 |     setIsSubmitting(true);
23 |     onSubmit(userInput);
24 |   };
25 | 
26 |   return (
27 |     <motion.div
28 |       initial={{ opacity: 0, y: 20 }}
29 |       animate={{ opacity: 1, y: 0 }}
30 |       transition={{ duration: 0.5 }}
31 |       className="bg-white/80 backdrop-blur-md rounded-3xl p-6 mb-8 text-[#222] leading-relaxed shadow-xl border border-[#BB79D1]/30"
32 |     >
33 |       <div className="flex items-center mb-6">
34 |         <button 
35 |           onClick={onBack}
36 |           className="mr-4 p-2 rounded-full bg-[#BB79D1]/20 hover:bg-[#BB79D1]/30 transition-all text-[#BB79D1]"
37 |         >
38 |           <ArrowLeft size={20} />
39 |         </button>
40 |         <h2 className="text-2xl font-bold text-[#BB79D1]">Describe tu continuación</h2>
41 |       </div>
42 | 
43 |       <p className="mb-4 text-[#222] font-medium">
44 |         Describe cómo te gustaría que continuara la historia. Puedes incluir nuevos personajes, 
45 |         lugares o situaciones. ¡Sé creativo!
46 |       </p>
47 | 
48 |       <textarea
49 |         value={userInput}
50 |         onChange={(e) => setUserInput(e.target.value)}
51 |         placeholder="Ejemplo: Me gustaría que el protagonista descubriera un objeto mágico que le permita..."
52 |         className="w-full h-40 p-4 rounded-xl bg-[#F6A5B7]/10 text-[#222] placeholder-[#222]/50 focus:outline-none focus:ring-2 focus:ring-[#BB79D1] resize-none mb-4 border border-[#F6A5B7]/30"
53 |         disabled={isSubmitting || disabled}
54 |       />
55 | 
56 |       <div className="flex justify-end">
57 |         <button
58 |           onClick={handleSubmit}
59 |           disabled={!userInput.trim() || isSubmitting || disabled}
60 |           className={`px-6 py-3 rounded-full font-medium flex items-center ${
61 |             !userInput.trim() || isSubmitting || disabled
62 |               ? "bg-[#BB79D1]/30 text-[#222]/50 cursor-not-allowed"
63 |               : "bg-[#BB79D1] text-white hover:bg-[#BB79D1]/90 transition-all shadow-lg"
64 |           }`}
65 |         >
66 |           {isSubmitting ? (
67 |             <div className="w-5 h-5 border-t-2 border-b-2 border-white rounded-full animate-spin mr-2" />
68 |           ) : (
69 |             <Send size={18} className="mr-2" />
70 |           )}
71 |           {isSubmitting ? "Generando..." : "Enviar"}
72 |         </button>
73 |       </div>
74 |     </motion.div>
75 |   );
76 | }
```

src/components/StoryContinuationOptions.tsx
```
1 | import { useState, useEffect } from "react";
2 | import { motion } from "framer-motion";
3 | import { ArrowRight, PenLine, Sparkles, Lightbulb, Wand2, Loader2 } from "lucide-react";
4 | 
5 | interface StoryContinuationOptionsProps {
6 |   options: { summary: string }[];
7 |   onSelectOption: (index: number) => void;
8 |   onSelectFree: () => void;
9 |   onSelectCustom: () => void;
10 |   isLoading?: boolean;
11 |   disabled?: boolean;
12 | }
13 | 
14 | export default function StoryContinuationOptions({
15 |   options = [],
16 |   onSelectOption,
17 |   onSelectFree,
18 |   onSelectCustom,
19 |   isLoading = false,
20 |   disabled = false
21 | }: StoryContinuationOptionsProps) {
22 |   const [selectedOption, setSelectedOption] = useState<number | null>(null);
23 |   const [displayOptions, setDisplayOptions] = useState<{ summary: string }[]>([]);
24 |   
25 |   // Asegurarse de que siempre tengamos 3 opciones
26 |   useEffect(() => {
27 |     const defaultOptions = [
28 |       { summary: "Buscar el tesoro escondido en el bosque." },
29 |       { summary: "Hablar con el misterioso anciano del pueblo." },
30 |       { summary: "Seguir el camino hacia las montañas nevadas." }
31 |     ];
32 |     
33 |     if (options && options.length === 3) {
34 |       setDisplayOptions(options);
35 |     } else {
36 |       console.warn("No se recibieron 3 opciones en el componente. Usando opciones predeterminadas.");
37 |       setDisplayOptions(defaultOptions);
38 |     }
39 |   }, [options]);
40 | 
41 |   const handleOptionSelect = (index: number) => {
42 |     setSelectedOption(index);
43 |     setTimeout(() => onSelectOption(index), 300);
44 |   };
45 | 
46 |   // Paleta de colores y gradientes distintos para cada opción
47 |   const optionStyles = [
48 |     { bg: "bg-[#7DC4E0]", icon: <Lightbulb className="shrink-0 mr-3" size={24} /> },
49 |     { bg: "bg-[#f7c59f]", icon: <Wand2 className="shrink-0 mr-3" size={24} /> },
50 |     { bg: "bg-[#F6A5B7]", icon: <Sparkles className="shrink-0 mr-3" size={24} /> }
51 |   ];
52 | 
53 |   return (
54 |     <div className="space-y-6">
55 |       {/* Continuar Libre Option */}
56 |       <motion.div 
57 |         initial={{ opacity: 0, y: 20 }}
58 |         animate={{ opacity: 1, y: 0 }}
59 |         transition={{ duration: 0.4, delay: 0.1 }}
60 |         whileHover={{ scale: 1.02 }}
61 |         className="w-full"
62 |       >
63 |         <button
64 |           onClick={onSelectFree}
65 |           disabled={disabled}
66 |           className={`w-full bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white rounded-2xl p-5 transition-all shadow-lg flex items-center justify-between ${disabled ? 'opacity-60 cursor-not-allowed' : ''}`}
67 |         >
68 |           <span className="text-lg font-semibold">Continuar Libre</span>
69 |           <ArrowRight size={20} />
70 |         </button>
71 |       </motion.div>
72 | 
73 |       {/* AI Options - Siempre mostrar esta sección */}
74 |       <motion.div 
75 |         initial={{ opacity: 0 }}
76 |         animate={{ opacity: 1 }}
77 |         transition={{ duration: 0.4, delay: 0.2 }}
78 |         className="space-y-2"
79 |       >
80 |         <h3 className="text-lg font-medium mb-3 text-[#222] bg-white/70 rounded-xl px-4 py-2 text-center shadow-sm">Elige una opción:</h3>
81 |         
82 |         {isLoading ? (
83 |           <div className="flex justify-center p-6 bg-white/70 rounded-xl shadow-md">
84 |             <Loader2 size={48} className="animate-spin text-[#BB79D1]" />
85 |           </div>
86 |         ) : (
87 |           displayOptions.map((option, index) => (
88 |             <motion.div 
89 |               key={index}
90 |               initial={{ opacity: 0, x: -20 }}
91 |               animate={{ opacity: 1, x: 0 }}
92 |               transition={{ duration: 0.4, delay: 0.3 + (index * 0.1) }}
93 |               whileHover={{ scale: 1.02 }}
94 |               whileTap={{ scale: 0.98 }}
95 |             >
96 |               <button
97 |                 onClick={() => handleOptionSelect(index)}
98 |                 disabled={disabled}
99 |                 className={`w-full text-left p-5 rounded-xl transition-all shadow-md flex ${optionStyles[index].bg} text-white ${disabled ? 'opacity-60 cursor-not-allowed' : ''}`}
100 |               >
101 |                 <div className="flex-1">
102 |                   <div className="flex items-start mb-2">
103 |                     {optionStyles[index].icon}
104 |                     <span className="font-medium text-lg">{`Opción ${index + 1}`}</span>
105 |                   </div>
106 |                   <p className="pl-8 text-white/90">{option.summary}</p>
107 |                 </div>
108 |                 {selectedOption === index && (
109 |                   <div className="flex items-center justify-center">
110 |                     <ArrowRight size={18} />
111 |                   </div>
112 |                 )}
113 |               </button>
114 |             </motion.div>
115 |           ))
116 |         )}
117 |       </motion.div>
118 | 
119 |       {/* Custom Option */}
120 |       <motion.div 
121 |         initial={{ opacity: 0, y: 20 }}
122 |         animate={{ opacity: 1, y: 0 }}
123 |         transition={{ duration: 0.4, delay: 0.6 }}
124 |         whileHover={{ scale: 1.02 }}
125 |       >
126 |         <button
127 |           onClick={onSelectCustom}
128 |           disabled={disabled}
129 |           className="w-full bg-white/70 hover:bg-white/90 text-[#BB79D1] rounded-xl p-5 transition-all shadow-lg flex items-center justify-center font-semibold border-2 border-[#BB79D1]/30"
130 |         >
131 |           <PenLine size={20} className="mr-3 text-[#BB79D1]" />
132 |           <span>Describir tu continuación soñada</span>
133 |         </button>
134 |       </motion.div>
135 |     </div>
136 |   );
137 | }
```

src/components/StoryOptionCard.tsx
```
1 | 
2 | import { ReactNode } from "react";
3 | 
4 | interface StoryOptionCardProps {
5 |   icon?: ReactNode;
6 |   label: string;
7 |   onClick: () => void;
8 |   selected?: boolean;
9 |   className?: string;
10 | }
11 | 
12 | export default function StoryOptionCard({ 
13 |   icon, 
14 |   label, 
15 |   onClick, 
16 |   selected = false,
17 |   className = ""
18 | }: StoryOptionCardProps) {
19 |   return (
20 |     <div 
21 |       onClick={onClick}
22 |       className={`
23 |         story-choice-card
24 |         ${selected ? 'ring-4 ring-story-orange-400 bg-white/20 shadow-lg transform scale-105' : 'hover:scale-105 hover:shadow-md transition-all duration-300'}
25 |         ${className}
26 |       `}
27 |     >
28 |       {icon && (
29 |         <div className="text-white text-3xl mb-3">
30 |           {icon}
31 |         </div>
32 |       )}
33 |       <span className="text-white text-center font-medium text-shadow">{label}</span>
34 |     </div>
35 |   );
36 | }
```

src/components/StoryPdfPreview.tsx
```
1 | import { useState, useRef, useEffect } from "react";
2 | import { Button } from "./ui/button";
3 | import { Loader2, Heart, Palette, FileText, CheckCircle, AlertCircle } from "lucide-react";
4 | import { Progress } from "./ui/progress";
5 | import { APP_CONFIG } from "../config/app";
6 | import { StoryPdfService, ImageGenerationProgress } from "../services/storyPdfService";
7 | 
8 | interface StoryPdfPreviewProps {
9 |   title: string;
10 |   author?: string;
11 |   content: string;
12 |   onClose?: () => void;
13 |   isOpen: boolean;
14 |   storyId: string;
15 |   chapterId: string;
16 | }
17 | 
18 | export default function StoryPdfPreview({
19 |   title,
20 |   author,
21 |   content,
22 |   onClose,
23 |   isOpen,
24 |   storyId,
25 |   chapterId
26 | }: StoryPdfPreviewProps) {
27 |   const [isGenerating, setIsGenerating] = useState(false);
28 |   const [isGeneratingIllustrated, setIsGeneratingIllustrated] = useState(false);
29 |   const [isValidatingImages, setIsValidatingImages] = useState(false);
30 |   const [needsImageGeneration, setNeedsImageGeneration] = useState(false);
31 |   const [showConfirmGeneration, setShowConfirmGeneration] = useState(false);
32 |   const [imageValidationResult, setImageValidationResult] = useState<{
33 |     canGenerate: boolean;
34 |     reason?: string;
35 |     missingImages?: string[];
36 |   } | null>(null);
37 |   const [generationProgress, setGenerationProgress] = useState<ImageGenerationProgress | null>(null);
38 |   const [error, setError] = useState<string | null>(null);
39 |   const [activePreview, setActivePreview] = useState<'cover' | 'content' | 'backCover'>('cover');
40 |   
41 |   // Reset states when modal opens
42 |   useEffect(() => {
43 |     if (isOpen) {
44 |       setError(null);
45 |       setNeedsImageGeneration(false);
46 |       setShowConfirmGeneration(false);
47 |       setImageValidationResult(null);
48 |       setGenerationProgress(null);
49 |     }
50 |   }, [isOpen]);
51 |   
52 |   if (!isOpen) return null;
53 |   
54 |   const handleGenerateStandard = async () => {
55 |     try {
56 |       setIsGenerating(true);
57 |       setError(null);
58 |       
59 |       // Generate standard PDF using service
60 |       const pdfBlob = await StoryPdfService.generateStandardPdf({
61 |         title,
62 |         author,
63 |         content,
64 |         storyId,
65 |         chapterId
66 |       });
67 |       
68 |       // Download PDF using service
69 |       StoryPdfService.downloadPdf(pdfBlob, title, false);
70 |       
71 |       if (onClose) onClose();
72 |     } catch (err) {
73 |       console.error('[StoryPdfPreview] Error generating standard PDF:', err);
74 |       setError('Ocurrió un error al generar el PDF. Por favor intenta nuevamente.');
75 |     } finally {
76 |       setIsGenerating(false);
77 |     }
78 |   };
79 | 
80 |   const handleGenerateIllustrated = async () => {
81 |     try {
82 |       setIsValidatingImages(true);
83 |       setError(null);
84 |       
85 |       console.log('[StoryPdfPreview] Starting illustrated story generation...');
86 |       
87 |       // Check if images exist
88 |       const validationResult = await StoryPdfService.canGenerateIllustratedPdf(storyId, chapterId);
89 |       setImageValidationResult(validationResult);
90 |       
91 |       if (validationResult.canGenerate) {
92 |         // Images exist, proceed directly with PDF generation
93 |         console.log('[StoryPdfPreview] ✅ All required images exist. Proceeding with illustrated PDF generation...');
94 |         await generateIllustratedPdfDirectly();
95 |       } else {
96 |         // Images missing, show confirmation dialog
97 |         console.log('[StoryPdfPreview] ❌ Missing images detected:', validationResult.missingImages);
98 |         setNeedsImageGeneration(true);
99 |         setShowConfirmGeneration(true);
100 |       }
101 |       
102 |     } catch (err) {
103 |       console.error('[StoryPdfPreview] Error checking images:', err);
104 |       setError('Ocurrió un error al verificar las imágenes. Por favor intenta nuevamente.');
105 |     } finally {
106 |       setIsValidatingImages(false);
107 |     }
108 |   };
109 | 
110 |   const handleConfirmImageGeneration = async () => {
111 |     try {
112 |       setShowConfirmGeneration(false);
113 |       setIsGeneratingIllustrated(true);
114 |       
115 |       console.log('[StoryPdfPreview] User confirmed image generation. Starting complete illustrated PDF process...');
116 |       
117 |       // Generate illustrated PDF with automatic image generation and progress tracking
118 |       const pdfBlob = await StoryPdfService.generateCompleteIllustratedPdf({
119 |         title,
120 |         author,
121 |         content,
122 |         storyId,
123 |         chapterId,
124 |         onProgress: (progress) => {
125 |           setGenerationProgress(progress);
126 |         }
127 |       });
128 |       
129 |       // Download illustrated PDF
130 |       StoryPdfService.downloadPdf(pdfBlob, title, true);
131 |       
132 |       if (onClose) onClose();
133 |       
134 |     } catch (err) {
135 |       console.error('[StoryPdfPreview] Error generating complete illustrated PDF:', err);
136 |       setError('Ocurrió un error al generar el cuento ilustrado. Por favor intenta nuevamente.');
137 |     } finally {
138 |       setIsGeneratingIllustrated(false);
139 |       setGenerationProgress(null);
140 |     }
141 |   };
142 | 
143 |   const generateIllustratedPdfDirectly = async () => {
144 |     try {
145 |       setIsGeneratingIllustrated(true);
146 |       
147 |       // Validate required images exist in storage using service
148 |       const imageValidation = await StoryPdfService.validateRequiredImages(storyId, chapterId);
149 |       
150 |       if (!imageValidation.allValid) {
151 |         setError(`Faltan imágenes necesarias: ${imageValidation.missingImages.join(', ')}. Por favor, genera las imágenes del cuento primero.`);
152 |         return;
153 |       }
154 |       
155 |       console.log('[StoryPdfPreview] ✅ All required images validated. Proceeding with illustrated PDF generation...');
156 |       
157 |       // Generate illustrated PDF with validated image URLs
158 |       const pdfBlob = await StoryPdfService.generateIllustratedPdf({
159 |         title,
160 |         author,
161 |         content,
162 |         storyId,
163 |         chapterId,
164 |         imageUrls: {
165 |           cover: imageValidation.imageUrls!.cover!,
166 |           scene_1: imageValidation.imageUrls!.scene_1!,
167 |           scene_2: imageValidation.imageUrls!.scene_2!
168 |         }
169 |       });
170 |       
171 |       // Download illustrated PDF
172 |       StoryPdfService.downloadPdf(pdfBlob, title, true);
173 |       
174 |       if (onClose) onClose();
175 |       
176 |     } catch (err) {
177 |       console.error('[StoryPdfPreview] Error generating illustrated story:', err);
178 |       setError('Ocurrió un error al generar el cuento ilustrado. Por favor intenta nuevamente.');
179 |     } finally {
180 |       setIsGeneratingIllustrated(false);
181 |     }
182 |   };
183 | 
184 |   const handleCancelGeneration = () => {
185 |     setShowConfirmGeneration(false);
186 |     setNeedsImageGeneration(false);
187 |     setImageValidationResult(null);
188 |   };
189 |   
190 |   return (
191 |     <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70">
192 |       <div className="bg-white rounded-xl w-full max-w-lg overflow-hidden shadow-2xl">
193 |         {/* Cabecera */}
194 |         <div className="p-4 bg-[#BB79D1] text-white">
195 |           <h2 className="text-xl font-bold">Generar versión imprimible</h2>
196 |         </div>
197 |         
198 |         {/* Cuerpo */}
199 |         <div className="p-6">
200 |           {/* Selector de vista previa */}
201 |           <div className="flex justify-center space-x-3 mb-4">
202 |             <button 
203 |               className={`px-4 py-1 rounded-full transition-all ${activePreview === 'cover' 
204 |                 ? 'bg-[#BB79D1] text-white' 
205 |                 : 'bg-gray-100 hover:bg-gray-200'}`}
206 |               onClick={() => setActivePreview('cover')}
207 |             >
208 |               Portada
209 |             </button>
210 |             <button 
211 |               className={`px-4 py-1 rounded-full transition-all ${activePreview === 'content' 
212 |                 ? 'bg-[#BB79D1] text-white' 
213 |                 : 'bg-gray-100 hover:bg-gray-200'}`}
214 |               onClick={() => setActivePreview('content')}
215 |             >
216 |               Contenido
217 |             </button>
218 |             <button 
219 |               className={`px-4 py-1 rounded-full transition-all ${activePreview === 'backCover' 
220 |                 ? 'bg-[#BB79D1] text-white' 
221 |                 : 'bg-gray-100 hover:bg-gray-200'}`}
222 |               onClick={() => setActivePreview('backCover')}
223 |             >
224 |               Contraportada
225 |             </button>
226 |           </div>
227 |           
228 |           {/* Vista previa según la selección */}
229 |           {activePreview === 'cover' && (
230 |             <div className="mb-6 bg-[#fff6e0] p-4 rounded-lg border border-amber-200 h-80 flex flex-col justify-center">
231 |               <div className="text-center">
232 |                 <img 
233 |                   src="/logo_png.png" 
234 |                   alt={APP_CONFIG.name} 
235 |                   className="h-16 mx-auto mb-4"
236 |                 />
237 |                 <h3 className="text-xl font-bold text-[#BB79D1] mb-1">{title}</h3>
238 |                 {author && (
239 |                   <p className="text-gray-600 italic">por {author}</p>
240 |                 )}
241 |               </div>
242 |             </div>
243 |           )}
244 |           
245 |           {activePreview === 'content' && (
246 |             <div className="mb-6 bg-[#fff6e0] p-4 rounded-lg border border-amber-200">
247 |               <p className="text-sm text-gray-600 mb-2">
248 |                 Vista previa del contenido:
249 |               </p>
250 |               
251 |               <div className="max-h-64 overflow-y-auto text-base border border-amber-100 p-3 rounded bg-white">
252 |                 {content.split("\n").slice(0, 5).map((paragraph, i) => (
253 |                   <p key={i} className="mb-2 font-bold text-[#ce9789]">
254 |                     {paragraph || "..."}
255 |                   </p>
256 |                 ))}
257 |                 {content.split("\n").length > 5 && (
258 |                   <p className="text-gray-400 italic text-sm text-center mt-2">
259 |                     (más contenido no mostrado en la vista previa)
260 |                   </p>
261 |                 )}
262 |               </div>
263 |             </div>
264 |           )}
265 |           
266 |           {activePreview === 'backCover' && (
267 |             <div className="mb-6 bg-[#fff6e0] p-4 rounded-lg border border-amber-200 h-80 flex flex-col justify-center">
268 |               <div className="text-center">
269 |                 <img 
270 |                   src="/logo_png.png" 
271 |                   alt={APP_CONFIG.name} 
272 |                   className="h-16 mx-auto mb-6"
273 |                 />
274 |                 <p className="text-[#BB79D1] font-bold mb-1 text-base">
275 |                   Generado con <Heart className="inline h-4 w-4 mx-0.5 fill-[#BB79D1]" /> por
276 |                 </p>
277 |                 <h3 className="text-2xl font-bold text-[#ce9789] mb-4">{APP_CONFIG.name}!</h3>
278 |                 <p className="text-gray-500 text-sm">{new Date().getFullYear()}</p>
279 |               </div>
280 |             </div>
281 |           )}
282 |           
283 |           {/* Progress Bar y Confirmation Dialog - COMENTADOS PARA DEMO */}
284 |           {/* 
285 |           {generationProgress && (
286 |             <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
287 |               <div className="flex items-center mb-2">
288 |                 <Loader2 className="mr-2 h-4 w-4 animate-spin text-blue-600" />
289 |                 <span className="text-sm font-medium text-blue-800">
290 |                   {generationProgress.currentStep}
291 |                 </span>
292 |               </div>
293 |               <Progress value={generationProgress.progress} className="mb-2" />
294 |               <div className="text-xs text-blue-600">
295 |                 {generationProgress.progress.toFixed(0)}% completado
296 |                 {generationProgress.currentImageType && (
297 |                   <span className="ml-2">• {generationProgress.currentImageType}</span>
298 |                 )}
299 |               </div>
300 |             </div>
301 |           )}
302 | 
303 |           {showConfirmGeneration && imageValidationResult && !imageValidationResult.canGenerate && (
304 |             <div className="mb-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
305 |               <div className="flex items-start">
306 |                 <AlertCircle className="h-5 w-5 text-orange-600 mr-3 mt-0.5 flex-shrink-0" />
307 |                 <div className="flex-1">
308 |                   <h4 className="font-medium text-orange-800 mb-2">
309 |                     Generación de imágenes requerida
310 |                   </h4>
311 |                   <p className="text-sm text-orange-700 mb-3">
312 |                     Para generar el cuento ilustrado necesitamos llenarlo de magia con imágenes y color. 
313 |                   </p>
314 |                   <p className="text-sm text-orange-700 mb-4">
315 |                     Este proceso puede tomar 2-3 minutos. ¿Deseas continuar?
316 |                   </p>
317 |                   <div className="flex space-x-3">
318 |                     <Button
319 |                       onClick={handleConfirmImageGeneration}
320 |                       disabled={isGeneratingIllustrated}
321 |                       className="bg-orange-600 hover:bg-orange-700 text-white"
322 |                       size="sm"
323 |                     >
324 |                       <CheckCircle className="h-4 w-4 mr-2" />
325 |                       Sí, generar imágenes
326 |                     </Button>
327 |                     <Button
328 |                       onClick={handleCancelGeneration}
329 |                       variant="outline"
330 |                       size="sm"
331 |                     >
332 |                       Cancelar
333 |                     </Button>
334 |                   </div>
335 |                 </div>
336 |               </div>
337 |             </div>
338 |           )}
339 |           */}
340 |           
341 |           {error && (
342 |             <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg">
343 |               {error}
344 |             </div>
345 |           )}
346 | 
347 |           {/* Opciones de generación */}
348 |           <div className="mb-4">
349 |             <h3 className="text-lg font-semibold mb-3 text-gray-800">Generar PDF:</h3>
350 |             
351 |             {/* Opción 1: Formato TaleMe */}
352 |             <div className="mb-3 p-4 border border-pink-200 rounded-lg bg-pink-50">
353 |               <div className="flex items-center justify-between">
354 |                 <div className="flex-1">
355 |                   <div className="flex items-center mb-2">
356 |                     <FileText className="h-5 w-5 text-pink-600 mr-2" />
357 |                     <h4 className="font-semibold text-pink-800">Cuento Formato TaleMe!</h4>
358 |                     <span className="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
359 |                       GRATIS
360 |                     </span>
361 |                   </div>
362 |                   <p className="text-sm text-pink-700">
363 |                     PDF con el formato tradicional de TaleMe (solo texto)
364 |                   </p>
365 |                 </div>
366 |                 <Button
367 |                   onClick={handleGenerateStandard}
368 |                   disabled={isGenerating}
369 |                   className="ml-4 bg-[#F6A5B7] hover:bg-[#F6A5B7]/90"
370 |                 >
371 |                   {isGenerating ? (
372 |                     <>
373 |                       <Loader2 className="mr-2 h-4 w-4 animate-spin" />
374 |                       Generando...
375 |                     </>
376 |                   ) : (
377 |                     <>Generar</>
378 |                   )}
379 |                 </Button>
380 |               </div>
381 |             </div>
382 | 
383 |             {/* Opción 2: Cuento Ilustrado - COMENTADO PARA DEMO */}
384 |             {/* 
385 |             <div className="p-4 border border-purple-200 rounded-lg bg-purple-50">
386 |               <div className="flex items-center justify-between">
387 |                 <div className="flex-1">
388 |                   <div className="flex items-center mb-2">
389 |                     <Palette className="h-5 w-5 text-purple-600 mr-2" />
390 |                     <h4 className="font-semibold text-purple-800">Cuento Ilustrado</h4>
391 |                     <span className="ml-2 px-2 py-1 bg-purple-100 text-purple-800 text-xs font-medium rounded-full">
392 |                       8,99€
393 |                     </span>
394 |                   </div>
395 |                   <p className="text-sm text-purple-700">
396 |                     PDF con imágenes generadas por IA que ilustran el cuento
397 |                   </p>
398 |                 </div>
399 |                 <Button
400 |                   onClick={handleGenerateIllustrated}
401 |                   disabled={isGeneratingIllustrated || isGenerating || isValidatingImages || showConfirmGeneration}
402 |                   className="ml-4 bg-purple-600 hover:bg-purple-700"
403 |                 >
404 |                   {isValidatingImages ? (
405 |                     <>
406 |                       <Loader2 className="mr-2 h-4 w-4 animate-spin" />
407 |                       Validando...
408 |                     </>
409 |                   ) : isGeneratingIllustrated ? (
410 |                     <>
411 |                       <Loader2 className="mr-2 h-4 w-4 animate-spin" />
412 |                       Generando...
413 |                     </>
414 |                   ) : (
415 |                     <>Generar</>
416 |                   )}
417 |                 </Button>
418 |               </div>
419 |             </div>
420 |             */}
421 |           </div>
422 |           
423 |           <div className="flex justify-end">
424 |             <Button
425 |               variant="outline"
426 |               onClick={onClose}
427 |               disabled={isGenerating}
428 |             >
429 |               Cancelar
430 |             </Button>
431 |           </div>
432 |         </div>
433 |       </div>
434 |     </div>
435 |   );
436 | }
437 | 
438 | // NOTA: Las siguientes funciones están temporalmente comentadas para la demo
439 | // pero siguen disponibles para cuando se reactive la funcionalidad ilustrada:
440 | // - handleGenerateIllustrated
441 | // - handleConfirmImageGeneration
442 | // - generateIllustratedPdfDirectly
443 | // - handleCancelGeneration
444 | // - Estados: isGeneratingIllustrated, isValidatingImages, needsImageGeneration, 
445 | //   showConfirmGeneration, imageValidationResult, generationProgress
```

src/components/VoiceSettings.tsx
```
1 | import { useState, useEffect } from 'react';
2 | import { Volume2, ChevronDown, AlertCircle } from 'lucide-react';
3 | import { getAvailableVoices } from '../services/ai/ttsService';
4 | import { useUserStore } from '../store/user/userStore';
5 | 
6 | interface Voice {
7 |   id: string;
8 |   description: string;
9 | }
10 | 
11 | interface VoiceSettingsProps {
12 |   onSettingsChange: (settings: {
13 |     voiceId: string;
14 |   }) => void;
15 |   className?: string;
16 | }
17 | 
18 | export default function VoiceSettings({ onSettingsChange, className = '' }: VoiceSettingsProps) {
19 |   const [isOpen, setIsOpen] = useState(false);
20 |   const [voices, setVoices] = useState<Voice[]>([]);
21 |   const [selectedVoice, setSelectedVoice] = useState<Voice | null>(null);
22 |   const [isLoading, setIsLoading] = useState(true);
23 |   
24 |   // Obtener selectores del userStore
25 |   const { 
26 |     isPremium, 
27 |     canGenerateVoice, 
28 |     getRemainingMonthlyVoiceGenerations, 
29 |     getAvailableVoiceCredits 
30 |   } = useUserStore();
31 | 
32 |   // Cargar las voces disponibles
33 |   useEffect(() => {
34 |     const loadVoices = async () => {
35 |       setIsLoading(true);
36 |       try {
37 |         const availableVoices = await getAvailableVoices();
38 |         setVoices(availableVoices);
39 |         
40 |         // Seleccionar la primera voz por defecto
41 |         const defaultVoice = availableVoices[0];
42 |         setSelectedVoice(defaultVoice);
43 |         
44 |         onSettingsChange({
45 |           voiceId: defaultVoice.id
46 |         });
47 |       } catch (error) {
48 |         console.error('Error cargando voces:', error);
49 |       } finally {
50 |         setIsLoading(false);
51 |       }
52 |     };
53 |     
54 |     loadVoices();
55 |   }, []);
56 | 
57 |   const handleVoiceChange = (voice: Voice) => {
58 |     setSelectedVoice(voice);
59 |     onSettingsChange({
60 |       voiceId: voice.id
61 |     });
62 |     setIsOpen(false);
63 |   };
64 | 
65 |   const toggleSettings = () => {
66 |     setIsOpen(!isOpen);
67 |   };
68 | 
69 |   // Obtener información de límites
70 |   const remainingMonthly = getRemainingMonthlyVoiceGenerations();
71 |   const availableCredits = getAvailableVoiceCredits();
72 |   const canGenerate = canGenerateVoice();
73 | 
74 |   return (
75 |     <div className={`voice-settings ${className}`}>
76 |       <div className="text-center mb-2 text-white/90 text-sm font-medium">
77 |         Personalizar narración
78 |       </div>
79 |       
80 |       <div className="mb-6 relative">
81 |         <button
82 |           onClick={toggleSettings}
83 |           className="w-full flex items-center justify-between p-4 bg-white/10 hover:bg-white/15 rounded-xl text-white text-sm backdrop-blur-md focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
84 |           disabled={isLoading || !selectedVoice}
85 |         >
86 |           <div className="flex items-center gap-2">
87 |             <Volume2 size={18} className="text-purple-200" />
88 |             <span>{selectedVoice?.description || 'Cargando voces...'}</span>
89 |           </div>
90 |           <ChevronDown size={18} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} />
91 |         </button>
92 |         
93 |         {isOpen && (
94 |           <div className="absolute mt-1 w-full rounded-xl p-2 bg-white/10 backdrop-blur-xl z-10 animate-fadeIn shadow-xl">
95 |             {voices.map((voice) => (
96 |               <button
97 |                 key={voice.id}
98 |                 onClick={() => handleVoiceChange(voice)}
99 |                 className={`w-full text-left p-3 my-1 rounded-lg flex items-center transition-colors hover:bg-white/10 ${
100 |                   selectedVoice?.id === voice.id ? 'bg-white/20 font-medium' : ''
101 |                 }`}
102 |               >
103 |                 <span className={`h-2 w-2 rounded-full mr-3 ${voice.description.includes('Femenina') ? 'bg-pink-400' : 'bg-blue-400'}`}></span>
104 |                 {voice.description}
105 |               </button>
106 |             ))}
107 |           </div>
108 |         )}
109 |       </div>
110 |       
111 |       {/* Información de límites de generación de voz */}
112 |       {isPremium() ? (
113 |         <div className="text-center text-sm text-white/80">
114 |           {canGenerate ? (
115 |             <div className="flex flex-col gap-1">
116 |               <div className="font-medium text-green-300">
117 |                 {remainingMonthly > 0 ? (
118 |                   <span>Te quedan {remainingMonthly} generaciones gratuitas</span>
119 |                 ) : (
120 |                   <span>Has usado todas tus generaciones mensuales</span>
121 |                 )}
122 |               </div>
123 |               {availableCredits > 0 && (
124 |                 <div className="text-purple-300">
125 |                   Tienes {availableCredits} créditos adicionales
126 |                 </div>
127 |               )}
128 |             </div>
129 |           ) : (
130 |             <div className="flex items-center justify-center gap-2 text-amber-300">
131 |               <AlertCircle size={16} />
132 |               <span>Necesitas comprar más créditos para generar audio</span>
133 |             </div>
134 |           )}
135 |         </div>
136 |       ) : (
137 |         <div className="text-center text-sm text-amber-300 flex items-center justify-center gap-2">
138 |           <AlertCircle size={16} />
139 |           <span>Necesitas una suscripción premium para narrar historias</span>
140 |         </div>
141 |       )}
142 |     </div>
143 |   );
144 | }
```

src/components/WaveForm.tsx
```
1 | import { useEffect, useRef } from "react";
2 | 
3 | interface WaveFormProps {
4 |   isPlaying: boolean;
5 |   color: string;
6 |   intensity?: number;
7 | }
8 | 
9 | function hexToRgb(hex: string) {
10 |   const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
11 |   return result
12 |     ? {
13 |         r: parseInt(result[1], 16),
14 |         g: parseInt(result[2], 16),
15 |         b: parseInt(result[3], 16)
16 |       }
17 |     : null;
18 | }
19 | 
20 | export const WaveForm = ({ isPlaying, color, intensity = 0.5 }: WaveFormProps) => {
21 |   const canvasRef = useRef<HTMLCanvasElement>(null);
22 |   const animationRef = useRef<number | null>(null);
23 |   const intensityRef = useRef(intensity);
24 | 
25 |   useEffect(() => {
26 |     intensityRef.current = intensity;
27 |   }, [intensity]);
28 | 
29 |   useEffect(() => {
30 |     const canvas = canvasRef.current;
31 |     if (!canvas) return;
32 | 
33 |     const ctx = canvas.getContext('2d');
34 |     if (!ctx) return;
35 | 
36 |     const dpr = window.devicePixelRatio || 1;
37 |     const parentWidth = canvas.parentElement?.clientWidth || window.innerWidth;
38 |     const parentHeight = canvas.parentElement?.clientHeight || 300;
39 | 
40 |     canvas.width = parentWidth * dpr;
41 |     canvas.height = parentHeight * dpr;
42 |     canvas.style.width = `${parentWidth}px`;
43 |     canvas.style.height = `${parentHeight}px`;
44 | 
45 |     ctx.scale(dpr, dpr);
46 | 
47 |     // Handle window resize
48 |     const handleResize = () => {
49 |       const parentWidth = canvas.parentElement?.clientWidth || window.innerWidth;
50 |       const parentHeight = canvas.parentElement?.clientHeight || 300;
51 | 
52 |       canvas.width = parentWidth * dpr;
53 |       canvas.height = parentHeight * dpr;
54 |       canvas.style.width = `${parentWidth}px`;
55 |       canvas.style.height = `${parentHeight}px`;
56 | 
57 |       ctx.scale(dpr, dpr);
58 |     };
59 | 
60 |     window.addEventListener('resize', handleResize);
61 | 
62 |     const rgb = hexToRgb(color);
63 | 
64 |     // Number of particles
65 |     const particleCount = 30;
66 |     const particles: {
67 |       x: number;
68 |       y: number;
69 |       radius: number;
70 |       originalRadius: number;
71 |       speed: number;
72 |       angle: number;
73 |       opacity: number;
74 |       pulseSpeed: number;
75 |     }[] = [];
76 | 
77 |     // Initialize particles
78 |     for (let i = 0; i < particleCount; i++) {
79 |       const centerX = canvas.width / dpr / 2;
80 |       const centerY = canvas.height / dpr / 2;
81 | 
82 |       // Create particles in circular pattern around center
83 |       const angle = Math.random() * Math.PI * 2;
84 |       const distance = 20 + Math.random() * (Math.min(centerX, centerY) * 0.6);
85 | 
86 |       particles.push({
87 |         x: centerX + Math.cos(angle) * distance,
88 |         y: centerY + Math.sin(angle) * distance,
89 |         radius: 5 + Math.random() * 20,
90 |         originalRadius: 5 + Math.random() * 20,
91 |         speed: 0.2 + Math.random() * 0.5,
92 |         angle: Math.random() * Math.PI * 2,
93 |         opacity: 0.2 + Math.random() * 0.3,
94 |         pulseSpeed: 0.01 + Math.random() * 0.03
95 |       });
96 |     }
97 | 
98 |     let phase = 0;
99 | 
100 |     // Animation loop
101 |     const animate = () => {
102 |       if (!canvas || !ctx) return;
103 | 
104 |       // Clear canvas with a subtle background
105 |       ctx.fillStyle = rgb ?
106 |         `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.05)` :
107 |         'rgba(100, 100, 255, 0.05)';
108 |       ctx.fillRect(0, 0, canvas.width / dpr, canvas.height / dpr);
109 | 
110 |       // Update phase
111 |       phase += isPlaying ? 0.02 : 0.005;
112 | 
113 |       // Center coordinates
114 |       const centerX = canvas.width / dpr / 2;
115 |       const centerY = canvas.height / dpr / 2;
116 | 
117 |       // Draw central pulsing circle
118 |       const basePulse = isPlaying ?
119 |         0.6 + Math.sin(phase * 2) * 0.2 * intensityRef.current :
120 |         0.7 + Math.sin(phase) * 0.1;
121 | 
122 |       const mainRadius = Math.min(centerX, centerY) * 0.3 * basePulse;
123 | 
124 |       // Central glow
125 |       const gradient = ctx.createRadialGradient(
126 |         centerX, centerY, 0,
127 |         centerX, centerY, mainRadius * 2
128 |       );
129 | 
130 |       if (rgb) {
131 |         gradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${isPlaying ? 0.3 : 0.15})`);
132 |         gradient.addColorStop(0.5, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${isPlaying ? 0.1 : 0.05})`);
133 |         gradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0)`);
134 |       } else {
135 |         gradient.addColorStop(0, `rgba(100, 100, 255, ${isPlaying ? 0.3 : 0.15})`);
136 |         gradient.addColorStop(0.5, `rgba(100, 100, 255, ${isPlaying ? 0.1 : 0.05})`);
137 |         gradient.addColorStop(1, 'rgba(100, 100, 255, 0)');
138 |       }
139 | 
140 |       ctx.fillStyle = gradient;
141 |       ctx.beginPath();
142 |       ctx.arc(centerX, centerY, mainRadius * 2, 0, Math.PI * 2);
143 |       ctx.fill();
144 | 
145 |       // Draw main circle
146 |       ctx.beginPath();
147 |       ctx.arc(centerX, centerY, mainRadius, 0, Math.PI * 2);
148 |       ctx.fillStyle = rgb ?
149 |         `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${isPlaying ? 0.4 : 0.2})` :
150 |         `rgba(100, 100, 255, ${isPlaying ? 0.4 : 0.2})`;
151 |       ctx.fill();
152 | 
153 |       // Draw and update particles
154 |       particles.forEach((particle, index) => {
155 |         // Create orbital movement
156 |         if (isPlaying) {
157 |           // More dynamic movement when playing
158 |           particle.angle += particle.speed * 0.02;
159 | 
160 |           // Pulse radius based on audio intensity
161 |           const pulseIntensity = intensityRef.current *
162 |             (0.5 + 0.5 * Math.sin(phase * 3 + index * 0.2));
163 | 
164 |           particle.radius = particle.originalRadius *
165 |             (0.8 + 0.4 * pulseIntensity * Math.sin(phase * particle.pulseSpeed * 10));
166 | 
167 |           // Dynamic opacity based on audio intensity
168 |           particle.opacity = 0.2 + 0.3 * intensityRef.current * Math.sin(phase * 2 + index * 0.1);
169 |         } else {
170 |           // Slower, more subtle movement when paused
171 |           particle.angle += particle.speed * 0.005;
172 | 
173 |           // Gentle pulsing when paused
174 |           particle.radius = particle.originalRadius * (0.9 + 0.1 * Math.sin(phase + index * 0.1));
175 |           particle.opacity = 0.1 + 0.1 * Math.sin(phase * 0.5 + index * 0.05);
176 |         }
177 | 
178 |         // Calculate particle position based on orbital movement
179 |         const orbitRadius = 20 + index % 3 * 40;
180 |         const orbitX = centerX + Math.cos(particle.angle) * orbitRadius;
181 |         const orbitY = centerY + Math.sin(particle.angle) * orbitRadius;
182 | 
183 |         // Add some wobble to the orbit
184 |         const wobble = isPlaying ?
185 |           Math.sin(phase * 2 + index) * 5 * intensityRef.current :
186 |           Math.sin(phase + index) * 2;
187 | 
188 |         particle.x = orbitX + wobble * Math.cos(particle.angle * 2);
189 |         particle.y = orbitY + wobble * Math.sin(particle.angle * 3);
190 | 
191 |         // Draw particle with gradient
192 |         const particleGradient = ctx.createRadialGradient(
193 |           particle.x, particle.y, 0,
194 |           particle.x, particle.y, particle.radius
195 |         );
196 | 
197 |         if (rgb) {
198 |           particleGradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${particle.opacity})`);
199 |           particleGradient.addColorStop(0.6, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${particle.opacity * 0.5})`);
200 |           particleGradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0)`);
201 |         } else {
202 |           particleGradient.addColorStop(0, `rgba(100, 100, 255, ${particle.opacity})`);
203 |           particleGradient.addColorStop(0.6, `rgba(100, 100, 255, ${particle.opacity * 0.5})`);
204 |           particleGradient.addColorStop(1, 'rgba(100, 100, 255, 0)');
205 |         }
206 | 
207 |         ctx.beginPath();
208 |         ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
209 |         ctx.fillStyle = particleGradient;
210 |         ctx.fill();
211 | 
212 |         // Occasionally connect particles with lines when playing
213 |         if (isPlaying && Math.random() > 0.97) {
214 |           const nearestParticleIndex = (index + 1) % particles.length;
215 |           const nearestParticle = particles[nearestParticleIndex];
216 | 
217 |           ctx.beginPath();
218 |           ctx.moveTo(particle.x, particle.y);
219 |           ctx.lineTo(nearestParticle.x, nearestParticle.y);
220 |           ctx.strokeStyle = rgb ?
221 |             `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)` :
222 |             'rgba(100, 100, 255, 0.2)';
223 |           ctx.lineWidth = 1;
224 |           ctx.stroke();
225 |         }
226 |       });
227 | 
228 |       animationRef.current = requestAnimationFrame(animate);
229 |     };
230 | 
231 |     // Start animation
232 |     animate();
233 | 
234 |     // Cleanup function
235 |     return () => {
236 |       if (animationRef.current) {
237 |         cancelAnimationFrame(animationRef.current);
238 |       }
239 |       window.removeEventListener('resize', handleResize);
240 |     };
241 |   }, [isPlaying, color]);
242 | 
243 |   return (
244 |     <canvas
245 |       ref={canvasRef}
246 |       className="absolute top-0 left-0 w-full h-full"
247 |     />
248 |   );
249 | };
250 | 
251 | export default WaveForm; 
```

src/config/app.ts
```
1 | /**
2 |  * Configuración global de la aplicación
3 |  * Este archivo contiene parámetros y configuraciones globales que pueden ser utilizados en toda la app
4 |  */
5 | 
6 | export const APP_CONFIG = {
7 |   /**
8 |    * Versión actual de la aplicación
9 |    * Formato: major.minor.patch
10 |    */
11 |   version: '1.1.3',
12 | 
13 |   /**
14 |    * Nombre de la aplicación
15 |    */
16 |   name: 'TaleMe',
17 |   
18 |   /**
19 |    * URL del sitio web
20 |    */
21 |   websiteUrl: 'https://taleme.app',
22 |   
23 |   /**
24 |    * Enlaces de redes sociales
25 |    */
26 |   socialLinks: {
27 |     twitter: 'https://twitter.com/taleme_app',
28 |     instagram: 'https://instagram.com/taleme_app',
29 |     facebook: 'https://facebook.com/talemeapp'
30 |   },
31 | 
32 |   /**
33 |    * URLs del footer
34 |    */
35 |   footerLinks: {
36 |     terms: '/terms',
37 |     privacy: '/privacy-policy',
38 |     contact: '/contact',
39 |     changelog: '/changelog'
40 |   }
41 | }; 
```

src/constants/story-images.constant.ts
```
1 | export const SYSTEM_PROMPT_BASE = `Quiero generar tres imágenes a partir de el siguiente cuento que posea las siguientes caráterísticas: **Estilo de la imagen, artístico en acuarela**: La idea es que el diseño de las imágenes parezcan hechas a mano, pintadas en acuarela o creyón, para mantener un estilo de dibujo de cuento tradicional. **Deben mantener el mismo estilos las imágenes**: Se debe mantener una concordancia en las imagenes generadas, con el fin de que mantenga una linea histórica del cuento. **Contenido del cuento para la idea**: Tomaremos el contenido del cuento para crear cuatro imágenes, una imagen para la "PORTADA", dos imágenes de las ESCENAS mas importante del cuento con la misma estética y que siga la misma línea del personaje principal.`
2 | 
3 | export const IMAGES_TYPE = {
4 |     COVER: "cover",
5 |     SCENE_1: "scene_1",
6 |     SCENE_2: "scene_2",
7 |     CHARACTER: "character",
8 | }
```

src/constants/story-voices.constant.ts
```
1 | export const STORY_VOICES = [
2 |     {
3 |       id: "el-sabio",
4 |       name: "El Sabio",
5 |       description: "Voz grave y serena, ideal para transmitir conocimiento.",
6 |       color: "#a5d6f6", // Indigo-600
7 |       gradientFrom: "#6366f1", // Indigo-500
8 |       gradientTo: "#3730a3", // Indigo-800
9 |       speed: 0.50,
10 |       icon: "📚",
11 |       preview: "📚 El Sabio: “Hola, soy El Sabio, con mi voz grave y serena te acompañaré en este viaje de conocimiento.”",
12 |       instructions: "El Sabio: Velocidad 0.50; pausa 250 ms antes y después de frases clave; entonación descendente al final de oraciones; Lee este texto con acento castellano muy marcado propias de un hablante nativo de España; añadir susurro de hojas al 10 % de volumen; realzar 100–300 Hz y atenuar >6 kHz; inhalaciones sutiles antes de pasajes largos."
13 |     },
14 |   
15 |     {
16 |       id: "la-hada",
17 |       name: "La Hada",
18 |       description: "Voz suave y dulce, perfecta para historias emocionales y de aprendizaje.",
19 |       color: "#f6a5b7", // Rose-600
20 |       gradientFrom: "#f43f5e", // Rose-500
21 |       gradientTo: "#be123c", // Rose-700
22 |       speed: 1.00,
23 |       icon: "👸",
24 |       preview: "👸 La Hada: “Soy La Hada, mi voz suave y dulce te envolverá en cada emoción y enseñanza.”",
25 |       instructions: "La Hada: Velocidad 1.00; pausas de 150 ms tras frases emotivas; subir tono en picos emocionales y alargar vocales ‘a’ y ‘o’; Lee este texto con acento castellano muy marcado propias de un hablante nativo de España; campanillas al 8 % de volumen; realzar 3–6 kHz; respiraciones antes de frases conmovedoras."
26 |     },
27 |   
28 |     {
29 |       id: "el-animado",
30 |       name: "El Animado",
31 |       description: "Voz aguda y caricaturesca, ideal para historias divertidas.",
32 |       color: "#f7c59f", // Green-600
33 |       gradientFrom: "#22c55e", // Green-500
34 |       gradientTo: "#16a34a", // Green-700
35 |       speed: 1.20,
36 |       icon: "🎭",
37 |       preview: "🎭 El Animado: “¡Ey, qué tal! Soy El Animado, con mi tono alegre y caricaturesco haré de esta historia una fiesta.”",
38 |       instructions: "El Animado: Velocidad 1.20; pausas de 100 ms entre frases; cambios rápidos de entonación en exclamaciones y preguntas; Lee este texto con acento castellano muy marcado propias de un hablante nativo de España; risas y aplausos al 12 % de volumen; realzar 1–2 kHz; inhalaciones cortas antes de exclamaciones."
39 |     }
40 |   ];
41 |   
42 | export const SYSTEM_PROMPT = "Eres un narrador profesional de cuentos infantiles en castellano de España, con pronunciación clara de la z como /θ/ y la s como /s/. Adapta tu ritmo y entonación al personaje";
43 | 
44 | export const CUSTOM_VOICE_MAPPING = {
45 |   "el-sabio": "ash",
46 |   "la-hada": "sage",
47 |   "el-animado": "ballad",
48 | };
49 | 
50 | export const PREVIEW_FILES: Record<string, string> = {
51 |   "el-sabio": "/previews/sabio.mp3",
52 |   "la-hada": "/previews/hada.mp3",
53 |   "el-animado": "/previews/animado.mp3"
54 | };
55 | 
56 | export const PLAYBACK_SPEEDS = [0.75, 1, 1.25, 1.5, 1.75, 2];
```

src/hooks/use-mobile.tsx
```
1 | import * as React from "react"
2 | 
3 | const MOBILE_BREAKPOINT = 768
4 | 
5 | export function useIsMobile() {
6 |   const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)
7 | 
8 |   React.useEffect(() => {
9 |     const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
10 |     const onChange = () => {
11 |       setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
12 |     }
13 |     mql.addEventListener("change", onChange)
14 |     setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
15 |     return () => mql.removeEventListener("change", onChange)
16 |   }, [])
17 | 
18 |   return !!isMobile
19 | }
```

src/hooks/use-toast.ts
```
1 | import * as React from "react"
2 | 
3 | import type {
4 |   ToastActionElement,
5 |   ToastProps,
6 | } from "@/components/ui/toast"
7 | 
8 | const TOAST_LIMIT = 1
9 | const TOAST_REMOVE_DELAY = 1000000
10 | 
11 | type ToasterToast = ToastProps & {
12 |   id: string
13 |   title?: React.ReactNode
14 |   description?: React.ReactNode
15 |   action?: ToastActionElement
16 | }
17 | 
18 | const actionTypes = {
19 |   ADD_TOAST: "ADD_TOAST",
20 |   UPDATE_TOAST: "UPDATE_TOAST",
21 |   DISMISS_TOAST: "DISMISS_TOAST",
22 |   REMOVE_TOAST: "REMOVE_TOAST",
23 | } as const
24 | 
25 | let count = 0
26 | 
27 | function genId() {
28 |   count = (count + 1) % Number.MAX_SAFE_INTEGER
29 |   return count.toString()
30 | }
31 | 
32 | type ActionType = typeof actionTypes
33 | 
34 | type Action =
35 |   | {
36 |       type: ActionType["ADD_TOAST"]
37 |       toast: ToasterToast
38 |     }
39 |   | {
40 |       type: ActionType["UPDATE_TOAST"]
41 |       toast: Partial<ToasterToast>
42 |     }
43 |   | {
44 |       type: ActionType["DISMISS_TOAST"]
45 |       toastId?: ToasterToast["id"]
46 |     }
47 |   | {
48 |       type: ActionType["REMOVE_TOAST"]
49 |       toastId?: ToasterToast["id"]
50 |     }
51 | 
52 | interface State {
53 |   toasts: ToasterToast[]
54 | }
55 | 
56 | const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()
57 | 
58 | const addToRemoveQueue = (toastId: string) => {
59 |   if (toastTimeouts.has(toastId)) {
60 |     return
61 |   }
62 | 
63 |   const timeout = setTimeout(() => {
64 |     toastTimeouts.delete(toastId)
65 |     dispatch({
66 |       type: "REMOVE_TOAST",
67 |       toastId: toastId,
68 |     })
69 |   }, TOAST_REMOVE_DELAY)
70 | 
71 |   toastTimeouts.set(toastId, timeout)
72 | }
73 | 
74 | export const reducer = (state: State, action: Action): State => {
75 |   switch (action.type) {
76 |     case "ADD_TOAST":
77 |       return {
78 |         ...state,
79 |         toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
80 |       }
81 | 
82 |     case "UPDATE_TOAST":
83 |       return {
84 |         ...state,
85 |         toasts: state.toasts.map((t) =>
86 |           t.id === action.toast.id ? { ...t, ...action.toast } : t
87 |         ),
88 |       }
89 | 
90 |     case "DISMISS_TOAST": {
91 |       const { toastId } = action
92 | 
93 |       // ! Side effects ! - This could be extracted into a dismissToast() action,
94 |       // but I'll keep it here for simplicity
95 |       if (toastId) {
96 |         addToRemoveQueue(toastId)
97 |       } else {
98 |         state.toasts.forEach((toast) => {
99 |           addToRemoveQueue(toast.id)
100 |         })
101 |       }
102 | 
103 |       return {
104 |         ...state,
105 |         toasts: state.toasts.map((t) =>
106 |           t.id === toastId || toastId === undefined
107 |             ? {
108 |                 ...t,
109 |                 open: false,
110 |               }
111 |             : t
112 |         ),
113 |       }
114 |     }
115 |     case "REMOVE_TOAST":
116 |       if (action.toastId === undefined) {
117 |         return {
118 |           ...state,
119 |           toasts: [],
120 |         }
121 |       }
122 |       return {
123 |         ...state,
124 |         toasts: state.toasts.filter((t) => t.id !== action.toastId),
125 |       }
126 |   }
127 | }
128 | 
129 | const listeners: Array<(state: State) => void> = []
130 | 
131 | let memoryState: State = { toasts: [] }
132 | 
133 | function dispatch(action: Action) {
134 |   memoryState = reducer(memoryState, action)
135 |   listeners.forEach((listener) => {
136 |     listener(memoryState)
137 |   })
138 | }
139 | 
140 | type Toast = Omit<ToasterToast, "id">
141 | 
142 | function toast({ ...props }: Toast) {
143 |   const id = genId()
144 | 
145 |   const update = (props: ToasterToast) =>
146 |     dispatch({
147 |       type: "UPDATE_TOAST",
148 |       toast: { ...props, id },
149 |     })
150 |   const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })
151 | 
152 |   dispatch({
153 |     type: "ADD_TOAST",
154 |     toast: {
155 |       ...props,
156 |       id,
157 |       open: true,
158 |       onOpenChange: (open) => {
159 |         if (!open) dismiss()
160 |       },
161 |     },
162 |   })
163 | 
164 |   return {
165 |     id: id,
166 |     dismiss,
167 |     update,
168 |   }
169 | }
170 | 
171 | function useToast() {
172 |   const [state, setState] = React.useState<State>(memoryState)
173 | 
174 |   React.useEffect(() => {
175 |     listeners.push(setState)
176 |     return () => {
177 |       const index = listeners.indexOf(setState)
178 |       if (index > -1) {
179 |         listeners.splice(index, 1)
180 |       }
181 |     }
182 |   }, [state])
183 | 
184 |   return {
185 |     ...state,
186 |     toast,
187 |     dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
188 |   }
189 | }
190 | 
191 | export { useToast, toast }
```

src/hooks/useChangelog.ts
```
1 | import { useState, useEffect } from 'react';
2 | import { parseChangelog, type ChangelogEntry } from '@/lib/utils';
3 | import changelogContent from '../../CHANGELOG.md?raw';
4 | 
5 | interface UseChangelogReturn {
6 |   changelogData: ChangelogEntry[];
7 |   isLoading: boolean;
8 |   error: string | null;
9 | }
10 | 
11 | export function useChangelog(): UseChangelogReturn {
12 |   const [changelogData, setChangelogData] = useState<ChangelogEntry[]>([]);
13 |   const [isLoading, setIsLoading] = useState(true);
14 |   const [error, setError] = useState<string | null>(null);
15 | 
16 |   useEffect(() => {
17 |     const loadChangelog = async () => {
18 |       try {
19 |         setIsLoading(true);
20 |         setError(null);
21 |         
22 |         // Parsear el contenido del archivo CHANGELOG.md
23 |         const parsedData = parseChangelog(changelogContent);
24 |         setChangelogData(parsedData);
25 |       } catch (err) {
26 |         console.error('Error parsing changelog:', err);
27 |         setError(err instanceof Error ? err.message : 'Error desconocido al cargar el changelog');
28 |         setChangelogData([]);
29 |       } finally {
30 |         setIsLoading(false);
31 |       }
32 |     };
33 | 
34 |     loadChangelog();
35 |   }, []);
36 | 
37 |   return {
38 |     changelogData,
39 |     isLoading,
40 |     error
41 |   };
42 | } 
```

src/lib/utils.ts
```
1 | import { clsx, type ClassValue } from "clsx"
2 | import { twMerge } from "tailwind-merge"
3 | import { toast } from "sonner"
4 | 
5 | export function cn(...inputs: ClassValue[]) {
6 |   return twMerge(clsx(inputs))
7 | }
8 | 
9 | export function parseTextToParagraphs(content: string): string[] {
10 |   return content
11 |     .split('\n')
12 |     .map(paragraph => paragraph.trim())
13 |     .filter(paragraph => paragraph.length > 0);
14 | }
15 | 
16 | let lastToastId: string | number | null = null;
17 | let lastToastMessage: string | null = null;
18 | 
19 | export const toastManager = {
20 |   show: (type: 'success' | 'error' | 'info' | 'warning', message: string, description?: string, force = false) => {
21 |     if (!force && lastToastMessage === message) {
22 |       return lastToastId;
23 |     }
24 | 
25 |     if (lastToastId) {
26 |       toast.dismiss(lastToastId);
27 |     }
28 | 
29 |     let toastId: string | number;
30 |     
31 |     switch (type) {
32 |       case 'success':
33 |         toastId = toast.success(message, description ? { description } : undefined);
34 |         break;
35 |       case 'error':
36 |         toastId = toast.error(message, description ? { description } : undefined);
37 |         break;
38 |       case 'info':
39 |         toastId = toast.info(message, description ? { description } : undefined);
40 |         break;
41 |       case 'warning':
42 |         toastId = toast.warning(message, description ? { description } : undefined);
43 |         break;
44 |       default:
45 |         toastId = toast(message, description ? { description } : undefined);
46 |     }
47 | 
48 |     lastToastId = toastId;
49 |     lastToastMessage = message;
50 |     
51 |     return toastId;
52 |   },
53 |   
54 |   clear: () => {
55 |     if (lastToastId) {
56 |       toast.dismiss(lastToastId);
57 |       lastToastId = null;
58 |       lastToastMessage = null;
59 |     }
60 |   },
61 |   
62 |   clearAll: () => {
63 |     toast.dismiss();
64 |     lastToastId = null;
65 |     lastToastMessage = null;
66 |   }
67 | };
68 | 
69 | // Interfaces para el changelog
70 | export interface ChangelogEntry {
71 |   version: string;
72 |   date: string;
73 |   features?: string[];
74 |   improvements?: string[];
75 |   technical?: string[];
76 |   fixes?: string[];
77 | }
78 | 
79 | // Parser del changelog markdown
80 | export function parseChangelog(markdownContent: string): ChangelogEntry[] {
81 |   const entries: ChangelogEntry[] = [];
82 |   const lines = markdownContent.split('\n');
83 |   
84 |   let currentEntry: Partial<ChangelogEntry> | null = null;
85 |   let currentSection: 'features' | 'improvements' | 'technical' | 'fixes' | null = null;
86 |   
87 |   for (const line of lines) {
88 |     const trimmedLine = line.trim();
89 |     
90 |     // Saltar líneas vacías o que no son relevantes
91 |     if (!trimmedLine || trimmedLine.startsWith('#') && !trimmedLine.startsWith('##')) {
92 |       continue;
93 |     }
94 |     
95 |     // Detectar nueva versión (formato: ## [1.1.3] - 2024-12-19)
96 |     const versionMatch = trimmedLine.match(/^##\s*\[([^\]]+)\]\s*-\s*(.+)$/);
97 |     if (versionMatch) {
98 |       // Guardar entry anterior si existe
99 |       if (currentEntry && currentEntry.version && currentEntry.date) {
100 |         entries.push(currentEntry as ChangelogEntry);
101 |       }
102 |       
103 |       // Crear nueva entry
104 |       currentEntry = {
105 |         version: versionMatch[1],
106 |         date: versionMatch[2].trim(),
107 |       };
108 |       currentSection = null;
109 |       continue;
110 |     }
111 |     
112 |     // Detectar secciones (### Mejoras, ### Cambios Técnicos, etc.)
113 |     const sectionMatch = trimmedLine.match(/^###\s*(.+)$/);
114 |     if (sectionMatch && currentEntry) {
115 |       const sectionTitle = sectionMatch[1].toLowerCase();
116 |       
117 |       if (sectionTitle.includes('mejoras') || sectionTitle.includes('improvements')) {
118 |         currentSection = 'improvements';
119 |         currentEntry.improvements = [];
120 |       } else if (sectionTitle.includes('técnicos') || sectionTitle.includes('cambios técnicos') || sectionTitle.includes('technical')) {
121 |         currentSection = 'technical';
122 |         currentEntry.technical = [];
123 |       } else if (sectionTitle.includes('correcciones') || sectionTitle.includes('fix') || sectionTitle.includes('bugs')) {
124 |         currentSection = 'fixes';
125 |         currentEntry.fixes = [];
126 |       } else if (sectionTitle.includes('añadido') || sectionTitle.includes('funcionalidades') || sectionTitle.includes('features') || sectionTitle.includes('nuevo')) {
127 |         currentSection = 'features';
128 |         currentEntry.features = [];
129 |       }
130 |       continue;
131 |     }
132 |     
133 |     // Detectar items de lista (- **item**: descripción o - item)
134 |     const listItemMatch = trimmedLine.match(/^-\s*(.+)$/);
135 |     if (listItemMatch && currentEntry && currentSection) {
136 |       let itemText = listItemMatch[1];
137 |       
138 |       // Limpiar markdown (quitar ** y otros formatos)
139 |       itemText = itemText
140 |         .replace(/\*\*(.*?)\*\*/g, '$1') // bold
141 |         .replace(/`(.*?)`/g, '$1') // code
142 |         .replace(/\[(.*?)\]\(.*?\)/g, '$1') // links
143 |         .trim();
144 |       
145 |       // Solo agregar si no está vacío después de limpiar
146 |       if (itemText) {
147 |         const targetArray = currentEntry[currentSection];
148 |         if (Array.isArray(targetArray)) {
149 |           targetArray.push(itemText);
150 |         }
151 |       }
152 |     }
153 |   }
154 |   
155 |   // Agregar la última entry si existe
156 |   if (currentEntry && currentEntry.version && currentEntry.date) {
157 |     entries.push(currentEntry as ChangelogEntry);
158 |   }
159 |   
160 |   return entries;
161 | }
```

src/pages/AuthCallback.tsx
```
1 | import { useEffect, useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { useUserStore } from "../store/user/userStore";
4 | import { supabase } from "../supabaseClient";
5 | import { getUserProfile } from "../services/supabase";
6 | 
7 | export default function AuthCallback() {
8 |   const navigate = useNavigate();
9 |   const { loginUser, hasCompletedProfile } = useUserStore();
10 |   const [error, setError] = useState<string | null>(null);
11 | 
12 |   useEffect(() => {
13 |     const handleAuthCallback = async () => {
14 |       try {
15 |         // Obtener datos de la redirección de OAuth
16 |         const { data, error } = await supabase.auth.getSession();
17 | 
18 |         if (error) {
19 |           console.error("Error en el callback de autenticación:", error.message);
20 |           setError(error.message);
21 |           setTimeout(() => navigate("/login"), 3000);
22 |           return;
23 |         }
24 | 
25 |         if (data?.session?.user) {
26 |           // Usuario autenticado correctamente
27 |           const userId = data.session.user.id;
28 |           
29 |           loginUser({
30 |             id: userId,
31 |             email: data.session.user.email || "",
32 |           });
33 |           
34 |           try {
35 |             // Verificar si el usuario ya tiene un perfil configurado
36 |             const { success, profile } = await getUserProfile(userId);
37 |             
38 |             if (success && profile) {
39 |               // Si ya tiene perfil, redirigir a la página principal
40 |               navigate("/home");
41 |             } else {
42 |               // Si no tiene perfil, redirigir a la configuración de perfil
43 |               navigate("/profile");
44 |             }
45 |           } catch (profileError) {
46 |             console.error("Error al verificar perfil:", profileError);
47 |             // En caso de error, mandamos a la configuración por seguridad
48 |             navigate("/profile");
49 |           }
50 |         } else {
51 |           // No hay sesión, redirigir al login
52 |           navigate("/login");
53 |         }
54 |       } catch (err) {
55 |         console.error("Error inesperado en callback:", err);
56 |         setError("Ocurrió un error inesperado");
57 |         setTimeout(() => navigate("/login"), 3000);
58 |       }
59 |     };
60 | 
61 |     handleAuthCallback();
62 |   }, [navigate, loginUser]);
63 | 
64 |   return (
65 |     <div className="gradient-bg min-h-screen flex flex-col items-center justify-center p-6">
66 |       <div className="glass-card p-8 w-full max-w-md text-center">
67 |         {error ? (
68 |           <>
69 |             <h2 className="text-2xl font-bold text-white mb-4">Error de autenticación</h2>
70 |             <p className="text-white/80 mb-4">{error}</p>
71 |             <p className="text-white/60">Redirigiendo al inicio de sesión...</p>
72 |           </>
73 |         ) : (
74 |           <>
75 |             <div className="animate-spin h-12 w-12 border-4 border-white rounded-full border-t-transparent mx-auto mb-6"></div>
76 |             <h2 className="text-2xl font-bold text-white mb-4">Autenticando...</h2>
77 |             <p className="text-white/80">Estamos verificando tu información</p>
78 |           </>
79 |         )}
80 |       </div>
81 |     </div>
82 |   );
83 | } 
```

src/pages/CharacterHobbies.tsx
```
1 | import { useNavigate, useLocation } from "react-router-dom";
2 | import { Book, Music, Gamepad, Camera, Utensils, Bike, Dumbbell, Palette, Globe, Computer, Wand2, Theater } from "lucide-react";
3 | import { motion } from "framer-motion";
4 | import { useCharacterStore } from "../store/character/characterStore";
5 | import BackButton from "../components/BackButton";
6 | import StoryButton from "../components/StoryButton";
7 | import PageTransition from "../components/PageTransition";
8 | import { useState } from "react";
9 | import { HobbyOption } from "../types";
10 | import { toast } from "sonner";
11 | 
12 | export default function CharacterHobbies() {
13 |   const navigate = useNavigate();
14 |   const location = useLocation();
15 |   const { currentCharacter, updateCharacter } = useCharacterStore();
16 |   const characterName = currentCharacter?.name || "tu personaje";
17 |   
18 |   // Obtener el parámetro "from" de la URL
19 |   const searchParams = new URLSearchParams(location.search);
20 |   const fromManagement = searchParams.get('from') === 'management';
21 |   
22 |   const hobbies: HobbyOption[] = [
23 |     { id: "reading", name: "Leer", icon: <Book /> },
24 |     { id: "music", name: "Música", icon: <Music /> },
25 |     { id: "gaming", name: "Videojuegos", icon: <Gamepad /> },
26 |     { id: "photography", name: "Fotografía", icon: <Camera /> },
27 |     { id: "cooking", name: "Cocinar", icon: <Utensils /> },
28 |     { id: "cycling", name: "Ciclismo", icon: <Bike /> },
29 |     { id: "sports", name: "Deportes", icon: <Dumbbell /> },
30 |     { id: "painting", name: "Pintar", icon: <Palette /> },
31 |     { id: "travel", name: "Viajar", icon: <Globe /> },
32 |     { id: "programming", name: "Programar", icon: <Computer /> },
33 |     { id: "magic", name: "Magia", icon: <Wand2 /> },
34 |     { id: "theater", name: "Teatro", icon: <Theater /> },
35 |   ];
36 |   
37 |   const [selectedHobbies, setSelectedHobbies] = useState<string[]>(
38 |     currentCharacter?.hobbies || []
39 |   );
40 |   
41 |   const toggleHobby = (hobbyId: string) => {
42 |     setSelectedHobbies(prev => {
43 |       if (prev.includes(hobbyId)) {
44 |         return prev.filter(id => id !== hobbyId);
45 |       } else {
46 |         const newSelected = [...prev, hobbyId];
47 |         return newSelected;
48 |       }
49 |     });
50 |   };
51 |   
52 |   const handleContinue = () => {
53 |     updateCharacter({ hobbies: selectedHobbies });
54 |     navigate(`/character-personality${fromManagement ? '?from=management' : ''}`);
55 |   };
56 |   
57 |   const container = {
58 |     hidden: { opacity: 0 },
59 |     show: {
60 |       opacity: 1,
61 |       transition: {
62 |         staggerChildren: 0.05
63 |       }
64 |     }
65 |   };
66 |   
67 |   const item = {
68 |     hidden: { y: 20, opacity: 0 },
69 |     show: { y: 0, opacity: 1 }
70 |   };
71 |   
72 |   return (
73 |     <PageTransition>
74 |       <div 
75 |         className="min-h-screen flex flex-col items-center justify-center p-6"
76 |         style={{
77 |           backgroundImage: "url(/fondo_png.png)",
78 |           backgroundSize: "cover",
79 |           backgroundPosition: "center",
80 |           backgroundRepeat: "no-repeat",
81 |         }}
82 |       >
83 |         <BackButton />
84 |         
85 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
86 |           <h1 className="text-3xl font-bold text-[#BB79D1] mb-4 text-center font-heading drop-shadow-lg">
87 |             ¿Qué le gusta a <span className="text-[#F6A5B7]">{characterName}</span>?
88 |           </h1>
89 |           
90 |           <p className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-6 font-medium shadow-sm">
91 |             Selecciona las aficiones que definen a tu personaje
92 |           </p>
93 |           
94 |           <motion.div 
95 |             variants={container}
96 |             initial="hidden"
97 |             animate="show"
98 |             className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-8"
99 |           >
100 |             {hobbies.map((hobby) => (
101 |               <motion.div key={hobby.id} variants={item}>
102 |                 <div
103 |                   onClick={() => toggleHobby(hobby.id)}
104 |                   className={`
105 |                     flex flex-col items-center justify-center p-4 cursor-pointer
106 |                     bg-white/70 rounded-xl border-2 
107 |                     ${selectedHobbies.includes(hobby.id) 
108 |                       ? 'ring-4 ring-[#7DC4E0] border-[#7DC4E0] shadow-lg transform scale-105' 
109 |                       : 'border-[#7DC4E0]/30 hover:bg-[#7DC4E0]/10 hover:scale-105 hover:shadow-md'}
110 |                     transition-all duration-300 h-32 sm:h-36
111 |                   `}
112 |                 >
113 |                   <div className={`text-3xl mb-3 ${selectedHobbies.includes(hobby.id) ? 'text-[#7DC4E0]' : 'text-[#7DC4E0]/70'}`}>
114 |                     {hobby.icon}
115 |                   </div>
116 |                   <span className="text-[#222] text-center font-medium">{hobby.name}</span>
117 |                 </div>
118 |               </motion.div>
119 |             ))}
120 |           </motion.div>
121 |           
122 |           <div className="flex flex-col sm:flex-row justify-between gap-4 w-full max-w-md mx-auto">
123 |             <button
124 |               type="button"
125 |               onClick={() => navigate(`/character-name${fromManagement ? '?from=management' : ''}`)}
126 |               className="w-full sm:w-[48%] py-3 rounded-2xl font-medium bg-white/70 hover:bg-white/90 text-[#BB79D1] border border-[#BB79D1]/30 shadow-md transition-all"
127 |             >
128 |               Atrás
129 |             </button>
130 |             
131 |             <button
132 |               onClick={handleContinue}
133 |               disabled={selectedHobbies.length === 0}
134 |               className="w-full sm:w-[48%] py-3 rounded-2xl font-medium bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed"
135 |             >
136 |               Continuar
137 |             </button>
138 |           </div>
139 |         </div>
140 |       </div>
141 |     </PageTransition>
142 |   );
143 | }
```

src/pages/CharacterName.tsx
```
1 | import { useState, useEffect } from "react";
2 | import { useNavigate, useLocation } from "react-router-dom";
3 | import { User, AlertCircle } from "lucide-react";
4 | import { motion } from "framer-motion";
5 | import { useCharacterStore } from "../store/character/characterStore";
6 | import BackButton from "../components/BackButton";
7 | import StoryButton from "../components/StoryButton";
8 | import PageTransition from "../components/PageTransition";
9 | import { Input } from "@/components/ui/input";
10 | import { toast } from "sonner";
11 | 
12 | // Define a type for the window with the nameTimeout property
13 | declare global {
14 |   interface Window {
15 |     nameTimeout: NodeJS.Timeout | undefined;
16 |   }
17 | }
18 | 
19 | export default function CharacterName() {
20 |   const navigate = useNavigate();
21 |   const location = useLocation();
22 |   const { currentCharacter, updateCharacter, savedCharacters } = useCharacterStore();
23 |   
24 |   // Obtener el parámetro "from" de la URL
25 |   const searchParams = new URLSearchParams(location.search);
26 |   const fromManagement = searchParams.get('from') === 'management';
27 |   
28 |   const [name, setName] = useState(currentCharacter?.name || "");
29 |   const [isFocused, setIsFocused] = useState(false);
30 |   const [hasTyped, setHasTyped] = useState(false);
31 |   const [error, setError] = useState("");
32 |   
33 |   // Verificar si el nombre ya existe entre los personajes guardados
34 |   const checkNameExists = (nameToCheck: string): boolean => {
35 |     if (!nameToCheck.trim()) return false;
36 |     
37 |     // Si estamos editando un personaje existente, excluir su propio nombre de la validación
38 |     return savedCharacters.some(
39 |       char => char.name.toLowerCase() === nameToCheck.toLowerCase() && 
40 |               char.id !== currentCharacter.id
41 |     );
42 |   };
43 |   
44 |   const handleSubmit = (e: React.FormEvent) => {
45 |     e.preventDefault();
46 |     
47 |     if (!name.trim()) {
48 |       setError("Por favor, ingresa un nombre para tu personaje");
49 |       return;
50 |     }
51 |     
52 |     // Verificar si el nombre ya existe
53 |     if (checkNameExists(name)) {
54 |       setError(`Ya tienes un personaje llamado "${name}". Por favor, elige otro nombre.`);
55 |       toast.error("Nombre duplicado", {
56 |         description: "Ya existe un personaje con este nombre"
57 |       });
58 |       return;
59 |     }
60 |     
61 |     // Si no hay error, guardar y continuar
62 |     setError("");
63 |     updateCharacter({ name: name });
64 |     toast.success("¡Nombre guardado!", { 
65 |       duration: 1500,
66 |       description: "Continuando a las aficiones..."
67 |     });
68 |     
69 |     setTimeout(() => {
70 |       navigate(`/character-hobbies${fromManagement ? '?from=management' : ''}`);
71 |     }, 1000);
72 |   };
73 |   
74 |   const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
75 |     const newName = e.target.value;
76 |     setName(newName);
77 |     
78 |     // Limpiar el error cuando el usuario escribe
79 |     if (error) {
80 |       setError("");
81 |     }
82 |     
83 |     if (!hasTyped && newName.length > 0) {
84 |       setHasTyped(true);
85 |     }
86 |   };
87 |   
88 |   const handleKeyDown = (e: React.KeyboardEvent) => {
89 |     if (e.key === "Enter" && name.trim()) {
90 |       e.preventDefault();
91 |       handleSubmit(e);
92 |     }
93 |   };
94 |   
95 |   useEffect(() => {
96 |     return () => {
97 |       clearTimeout(window.nameTimeout);
98 |     };
99 |   }, []);
100 |   
101 |   return (
102 |     <PageTransition>
103 |       <div 
104 |         className="min-h-screen flex flex-col items-center justify-center p-6"
105 |         style={{
106 |           backgroundImage: "url(/fondo_png.png)",
107 |           backgroundSize: "cover",
108 |           backgroundPosition: "center",
109 |           backgroundRepeat: "no-repeat",
110 |         }}
111 |       >
112 |         <BackButton />
113 |         
114 |         <div className="w-full max-w-md flex flex-col items-center">
115 |           <motion.div
116 |             initial={{ scale: 0.8, opacity: 0 }}
117 |             animate={{ scale: 1, opacity: 1 }}
118 |             transition={{ duration: 0.5 }}
119 |             className="w-24 h-24 rounded-full bg-[#7DC4E0]/20 border-2 border-[#7DC4E0]/40 flex items-center justify-center mb-6 shadow-md"
120 |           >
121 |             <User size={40} className="text-[#7DC4E0]" />
122 |           </motion.div>
123 |           
124 |           <h1 className="text-3xl font-bold text-[#BB79D1] mb-6 text-center font-heading drop-shadow-lg">
125 |             ¿Cómo se llama tu personaje?
126 |           </h1>
127 |           
128 |           <p className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-8 font-medium shadow-sm">
129 |             Dale un nombre a tu personaje para continuar
130 |           </p>
131 |           
132 |           <form onSubmit={handleSubmit} className="w-full space-y-8">
133 |             <div 
134 |               className={`
135 |                 relative transition-all duration-300 ease-in-out
136 |                 ${isFocused ? 'scale-105' : 'scale-100'}
137 |               `}
138 |             >
139 |               <Input 
140 |                 value={name}
141 |                 onChange={handleChange}
142 |                 onFocus={() => setIsFocused(true)}
143 |                 onBlur={() => setIsFocused(false)}
144 |                 onKeyDown={handleKeyDown}
145 |                 placeholder="Nombre del personaje"
146 |                 className={`story-input text-xl text-center h-16 font-medium rounded-xl shadow-md ${error ? 'border-[#F6A5B7] text-[#F6A5B7] bg-[#F6A5B7]/10' : 'text-[#222] bg-white/90 border-[#BB79D1]/30'} placeholder:text-[#BB79D1]/50`}
147 |                 autoFocus
148 |               />
149 |               
150 |               {error && (
151 |                 <div className="mt-2 flex items-center justify-center text-[#F6A5B7] gap-2 p-2 bg-white/80 rounded-lg border border-[#F6A5B7]/30 shadow-sm">
152 |                   <AlertCircle size={16} />
153 |                   <span className="text-sm font-medium">{error}</span>
154 |                 </div>
155 |               )}
156 |             </div>
157 |             
158 |             <div className="flex justify-between w-full">
159 |               <button
160 |                 type="button"
161 |                 onClick={() => navigate(fromManagement ? "/characters-management" : "/character-selection")}
162 |                 className="w-[48%] text-lg py-4 shadow-md hover:shadow-lg transition-all rounded-2xl font-medium bg-white/70 hover:bg-white/90 text-[#BB79D1] border border-[#BB79D1]/30"
163 |               >
164 |                 Atrás
165 |               </button>
166 |               
167 |               <button
168 |                 type="submit"
169 |                 className="w-[48%] text-lg py-4 shadow-md hover:shadow-lg transition-all bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white rounded-2xl font-medium disabled:opacity-50 disabled:cursor-not-allowed"
170 |                 disabled={!name.trim()}
171 |               >
172 |                 Continuar
173 |               </button>
174 |             </div>
175 |           </form>
176 |         </div>
177 |       </div>
178 |     </PageTransition>
179 |   );
180 | }
```

src/pages/CharacterPersonality.tsx
```
1 | import { useState } from "react";
2 | import { useNavigate, useLocation } from "react-router-dom";
3 | import { Smile, Search, Shield, Brain, Users, Cloud, Feather, CheckSquare, Clock, Compass } from "lucide-react";
4 | import { motion } from "framer-motion";
5 | import { useCharacterStore } from "../store/character/characterStore";
6 | import BackButton from "../components/BackButton";
7 | import StoryButton from "../components/StoryButton";
8 | import PageTransition from "../components/PageTransition";
9 | 
10 | // Define los tipos de personalidad disponibles
11 | const personalityOptions = [
12 |   { id: "alegre", name: "Alegre", icon: <Smile className="w-6 h-6" /> },
13 |   { id: "curioso", name: "Curioso", icon: <Search className="w-6 h-6" /> },
14 |   { id: "valiente", name: "Valiente", icon: <Shield className="w-6 h-6" /> },
15 |   { id: "inteligente", name: "Inteligente", icon: <Brain className="w-6 h-6" /> },
16 |   { id: "amistoso", name: "Amistoso", icon: <Users className="w-6 h-6" /> },
17 |   { id: "soñador", name: "Soñador", icon: <Cloud className="w-6 h-6" /> },
18 |   { id: "travieso", name: "Travieso", icon: <Feather className="w-6 h-6" /> },
19 |   { id: "responsable", name: "Responsable", icon: <CheckSquare className="w-6 h-6" /> },
20 |   { id: "paciente", name: "Paciente", icon: <Clock className="w-6 h-6" /> },
21 |   { id: "aventurero", name: "Aventurero", icon: <Compass className="w-6 h-6" /> },
22 | ];
23 | 
24 | export default function CharacterPersonality() {
25 |   const navigate = useNavigate();
26 |   const location = useLocation();
27 |   const { currentCharacter, updateCharacter } = useCharacterStore();
28 |   const [selectedPersonalities, setSelectedPersonalities] = useState<string[]>(
29 |     currentCharacter?.personality ? 
30 |     currentCharacter.personality.split(',') : []
31 |   );
32 |   
33 |   // Obtener el parámetro "from" de la URL
34 |   const searchParams = new URLSearchParams(location.search);
35 |   const fromManagement = searchParams.get('from') === 'management';
36 |   
37 |   const characterName = currentCharacter?.name || "tu personaje";
38 |   
39 |   const handlePersonalitySelect = (personalityId: string) => {
40 |     setSelectedPersonalities(prev => {
41 |       if (prev.includes(personalityId)) {
42 |         return prev.filter(id => id !== personalityId);
43 |       } else {
44 |         return [...prev, personalityId];
45 |       }
46 |     });
47 |   };
48 |   
49 |   const handleContinue = () => {
50 |     if (selectedPersonalities.length > 0) {
51 |       updateCharacter({ personality: selectedPersonalities.join(',') });
52 |     }
53 |     navigate(`/character-profession${fromManagement ? '?from=management' : ''}`);
54 |   };
55 |   
56 |   const handleBack = () => {
57 |     navigate(`/character-hobbies${fromManagement ? '?from=management' : ''}`);
58 |   };
59 |   
60 |   const container = {
61 |     hidden: { opacity: 0 },
62 |     show: {
63 |       opacity: 1,
64 |       transition: {
65 |         staggerChildren: 0.05
66 |       }
67 |     }
68 |   };
69 |   
70 |   const item = {
71 |     hidden: { y: 20, opacity: 0 },
72 |     show: { y: 0, opacity: 1 }
73 |   };
74 |   
75 |   return (
76 |     <PageTransition>
77 |       <div 
78 |         className="min-h-screen flex flex-col items-center justify-center p-6"
79 |         style={{
80 |           backgroundImage: "url(/fondo_png.png)",
81 |           backgroundSize: "cover",
82 |           backgroundPosition: "center",
83 |           backgroundRepeat: "no-repeat",
84 |         }}
85 |       >
86 |         <BackButton onClick={handleBack} />
87 |         
88 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
89 |           <h1 className="text-3xl font-bold text-[#BB79D1] mb-4 text-center font-heading drop-shadow-lg">
90 |             ¿Cómo es la personalidad de <span className="text-[#F6A5B7]">{characterName}</span>?
91 |           </h1>
92 |           
93 |           <p className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-6 font-medium shadow-sm">
94 |             Selecciona los rasgos de personalidad que mejor definen a tu personaje
95 |           </p>
96 |           
97 |           <motion.div 
98 |             variants={container}
99 |             initial="hidden"
100 |             animate="show"
101 |             className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-8"
102 |           >
103 |             {personalityOptions.map((personality) => (
104 |               <motion.div key={personality.id} variants={item}>
105 |                 <div
106 |                   onClick={() => handlePersonalitySelect(personality.id)}
107 |                   className={`
108 |                     flex flex-col items-center justify-center p-4 cursor-pointer
109 |                     bg-white/70 rounded-xl border-2 
110 |                     ${selectedPersonalities.includes(personality.id) 
111 |                       ? 'ring-4 ring-[#A5D6F6] border-[#A5D6F6] shadow-lg transform scale-105' 
112 |                       : 'border-[#A5D6F6]/30 hover:bg-[#A5D6F6]/10 hover:scale-105 hover:shadow-md'}
113 |                     transition-all duration-300 h-32 sm:h-36
114 |                   `}
115 |                 >
116 |                   <div className={`text-3xl mb-3 ${selectedPersonalities.includes(personality.id) ? 'text-[#A5D6F6]' : 'text-[#A5D6F6]/70'}`}>
117 |                     {personality.icon}
118 |                   </div>
119 |                   <span className="text-[#222] text-center font-medium">{personality.name}</span>
120 |                 </div>
121 |               </motion.div>
122 |             ))}
123 |           </motion.div>
124 |           
125 |           <div className="flex flex-col sm:flex-row justify-between gap-4 w-full max-w-md mx-auto">
126 |             <button
127 |               type="button"
128 |               onClick={handleBack}
129 |               className="w-full sm:w-[48%] py-3 rounded-2xl font-medium bg-white/70 hover:bg-white/90 text-[#BB79D1] border border-[#BB79D1]/30 shadow-md transition-all"
130 |             >
131 |               Atrás
132 |             </button>
133 |             
134 |             <button
135 |               onClick={handleContinue}
136 |               disabled={selectedPersonalities.length === 0}
137 |               className="w-full sm:w-[48%] py-3 rounded-2xl font-medium bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed"
138 |             >
139 |               Continuar
140 |             </button>
141 |           </div>
142 |         </div>
143 |       </div>
144 |     </PageTransition>
145 |   );
146 | } 
```

src/pages/CharacterProfession.tsx
```
1 | import { useNavigate, useLocation } from "react-router-dom";
2 | import { motion } from "framer-motion";
3 | import { useCharacterStore } from "../store/character/characterStore";
4 | import { useStoryOptionsStore } from "../store/storyOptions/storyOptionsStore";
5 | import StoryOptionCard from "../components/StoryOptionCard";
6 | import BackButton from "../components/BackButton";
7 | import StoryButton from "../components/StoryButton";
8 | import PageTransition from "../components/PageTransition";
9 | import { useState } from "react";
10 | import { toast } from "sonner";
11 | import { 
12 |   Rocket, 
13 |   Search, 
14 |   Shield, 
15 |   Crown, 
16 |   Zap, 
17 |   Wand2, 
18 |   Trophy, 
19 |   GraduationCap 
20 | } from "lucide-react";
21 | 
22 | const professions = [
23 |   { id: "astronaut", name: "Astronauta", icon: <Rocket /> },
24 |   { id: "explorer", name: "Explorador/a", icon: <Search /> },
25 |   { id: "knight", name: "Caballero", icon: <Shield /> },
26 |   { id: "royalty", name: "Príncipe/Princesa", icon: <Crown /> },
27 |   { id: "superhero", name: "Superhéroe", icon: <Zap /> },
28 |   { id: "wizard", name: "Mago/Maga", icon: <Wand2 /> },
29 |   { id: "athlete", name: "Deportista", icon: <Trophy /> },
30 |   { id: "teacher", name: "Profesor/a", icon: <GraduationCap /> }
31 | ];
32 | 
33 | export default function CharacterProfession() {
34 |   const navigate = useNavigate();
35 |   const location = useLocation();
36 |   const { currentCharacter, updateCharacter, saveCurrentCharacter } = useCharacterStore();
37 |   const { updateStoryOptions } = useStoryOptionsStore();
38 |   const characterName = currentCharacter?.name || "el personaje";
39 |   const [selectedProfession, setSelectedProfession] = useState(
40 |     currentCharacter?.profession || ""
41 |   );
42 |   
43 |   // Obtener el parámetro "from" de la URL
44 |   const searchParams = new URLSearchParams(location.search);
45 |   const fromManagement = searchParams.get('from') === 'management';
46 |   
47 |   const handleSelectProfession = (profession: string) => {
48 |     setSelectedProfession(profession);
49 |   };
50 |   
51 |   const handleContinue = async () => {
52 |     // Update the character
53 |     updateCharacter({ profession: selectedProfession });
54 |     
55 |     // Save and check for errors
56 |     const result = await saveCurrentCharacter();
57 |     
58 |     if (!result || !result.success) {
59 |       if (result?.error && typeof result.error === 'string' && result.error.includes("Ya existe un personaje con el nombre")) {
60 |         toast.error("Nombre duplicado", {
61 |           description: result.error
62 |         });
63 |         // Volver a la página de nombre del personaje para corregir
64 |         navigate(`/character-name${fromManagement ? '?from=management' : ''}`);
65 |         return;
66 |       } else if (result?.error) {
67 |         toast.error("Error al guardar", {
68 |           description: typeof result.error === 'string' 
69 |             ? result.error 
70 |             : "Hubo un problema al guardar el personaje"
71 |         });
72 |         return;
73 |       }
74 |     }
75 |     
76 |     // Important: Update story options with the current character
77 |     if (currentCharacter) {
78 |       updateStoryOptions({ 
79 |         character: {
80 |           ...currentCharacter,
81 |           profession: selectedProfession
82 |         }
83 |       });
84 |     }
85 |     
86 |     if (fromManagement) {
87 |       toast.success("¡Personaje guardado!", {
88 |         description: "Volviendo a la gestión de personajes"
89 |       });
90 |       navigate("/characters-management");
91 |     } else {
92 |       toast.success("¡Personaje guardado!", {
93 |         description: "Continuando a la selección de género"
94 |       });
95 |       navigate("/story-genre");
96 |     }
97 |   };
98 |   
99 |   const container = {
100 |     hidden: { opacity: 0 },
101 |     show: {
102 |       opacity: 1,
103 |       transition: {
104 |         staggerChildren: 0.1
105 |       }
106 |     }
107 |   };
108 |   
109 |   const item = {
110 |     hidden: { y: 20, opacity: 0 },
111 |     show: { y: 0, opacity: 1 }
112 |   };
113 |   
114 |   return (
115 |     <PageTransition>
116 |       <div 
117 |         className="min-h-screen flex flex-col items-center justify-center p-6"
118 |         style={{
119 |           backgroundImage: "url(/fondo_png.png)",
120 |           backgroundSize: "cover",
121 |           backgroundPosition: "center",
122 |           backgroundRepeat: "no-repeat",
123 |         }}
124 |       >
125 |         <BackButton />
126 |         
127 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
128 |           <h1 className="text-3xl font-bold text-[#BB79D1] mb-4 text-center font-heading drop-shadow-lg">
129 |             ¿Qué quiere ser <span className="text-[#F6A5B7]">{characterName}</span>?
130 |           </h1>
131 |           
132 |           <p className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-6 font-medium shadow-sm">
133 |             Selecciona una profesión para tu personaje
134 |           </p>
135 |           
136 |           <motion.div 
137 |             variants={container}
138 |             initial="hidden"
139 |             animate="show"
140 |             className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-8"
141 |           >
142 |             {professions.map((profession) => (
143 |               <motion.div key={profession.id} variants={item}>
144 |                 <div
145 |                   onClick={() => handleSelectProfession(profession.id)}
146 |                   className={`
147 |                     flex flex-col items-center justify-center p-4 cursor-pointer
148 |                     bg-white/70 rounded-xl border-2 
149 |                     ${selectedProfession === profession.id 
150 |                       ? 'ring-4 ring-[#F9DA60] border-[#F9DA60] shadow-lg transform scale-105' 
151 |                       : 'border-[#F9DA60]/30 hover:bg-[#F9DA60]/10 hover:scale-105 hover:shadow-md'}
152 |                     transition-all duration-300 h-32 sm:h-36
153 |                   `}
154 |                 >
155 |                   <div className={`text-3xl mb-3 ${selectedProfession === profession.id ? 'text-[#F9DA60]' : 'text-[#F9DA60]/70'}`}>
156 |                     {profession.icon}
157 |                   </div>
158 |                   <span className="text-[#222] text-center font-medium">{profession.name}</span>
159 |                 </div>
160 |               </motion.div>
161 |             ))}
162 |           </motion.div>
163 |           
164 |           <div className="flex flex-col sm:flex-row justify-between gap-4 w-full max-w-md mx-auto">
165 |             <button
166 |               type="button"
167 |               onClick={() => navigate(`/character-personality${fromManagement ? '?from=management' : ''}`)}
168 |               className="w-full sm:w-[48%] py-3 rounded-2xl font-medium bg-white/70 hover:bg-white/90 text-[#BB79D1] border border-[#BB79D1]/30 shadow-md transition-all"
169 |             >
170 |               Atrás
171 |             </button>
172 |             
173 |             <button
174 |               onClick={handleContinue}
175 |               disabled={!selectedProfession}
176 |               className="w-full sm:w-[48%] py-3 rounded-2xl font-medium bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed"
177 |             >
178 |               Continuar
179 |             </button>
180 |           </div>
181 |         </div>
182 |       </div>
183 |     </PageTransition>
184 |   );
185 | }
```

src/pages/CharacterSelection.tsx
```
1 | import { useNavigate } from "react-router-dom";
2 | import { Plus, User } from "lucide-react";
3 | import { useCharacterStore, reloadCharacters } from "../store/character/characterStore";
4 | import { useStoryOptionsStore } from "../store/storyOptions/storyOptionsStore";
5 | import BackButton from "../components/BackButton";
6 | import StoryButton from "../components/StoryButton";
7 | import PageTransition from "../components/PageTransition";
8 | import { motion } from "framer-motion";
9 | import { useEffect, useState } from "react";
10 | import { useUserStore } from "../store/user/userStore";
11 | 
12 | export default function CharacterSelection() {
13 |   const navigate = useNavigate();
14 |   const { savedCharacters, selectCharacter, currentCharacter, loadCharactersFromSupabase } = useCharacterStore();
15 |   const { updateStoryOptions } = useStoryOptionsStore();
16 |   const [isLoading, setIsLoading] = useState(true);
17 |   
18 |   // Cargar personajes al montar el componente
19 |   useEffect(() => {
20 |     const loadCharacters = async () => {
21 |       console.log("[DEBUG] CharacterSelection montado - cargando personajes directamente desde Supabase");
22 |       setIsLoading(true);
23 |       
24 |       const user = useUserStore.getState().user;
25 |       if (!user) {
26 |         console.error("[DEBUG] No hay usuario autenticado para cargar personajes");
27 |         setIsLoading(false);
28 |         return;
29 |       }
30 |       
31 |       // Limpiar personajes existentes antes de cargar
32 |       useCharacterStore.setState({ savedCharacters: [] });
33 |       
34 |       // Forzar recarga limpia desde Supabase - el método internamente usa user.id
35 |       await loadCharactersFromSupabase();
36 |       
37 |       // Asegurarnos de que se cargaron los personajes
38 |       const chars = useCharacterStore.getState().savedCharacters;
39 |       console.log(`[DEBUG] Después de cargar: ${chars.length} personajes para usuario ${user.id}`);
40 |       
41 |       setIsLoading(false);
42 |     };
43 |     
44 |     loadCharacters();
45 |   }, [loadCharactersFromSupabase]);
46 |   
47 |   // Mostrar personajes disponibles
48 |   useEffect(() => {
49 |     console.log(`CharacterSelection tiene ${savedCharacters.length} personajes disponibles:`, 
50 |       savedCharacters.map(char => `${char.name} (${char.id})`));
51 |   }, [savedCharacters]);
52 |   
53 |   const handleSelectCharacter = (characterId: string) => {
54 |     selectCharacter(characterId);
55 |     const character = savedCharacters.find(char => char.id === characterId);
56 |     if (character) {
57 |       updateStoryOptions({ character });
58 |     }
59 |     navigate("/story-genre");
60 |   };
61 |   
62 |   const handleCreateNewCharacter = () => {
63 |     // Resetear el personaje actual para asegurar un ID único
64 |     const { resetCharacter } = useCharacterStore.getState();
65 |     resetCharacter();
66 |     navigate("/character-name");
67 |   };
68 |   
69 |   const container = {
70 |     hidden: { opacity: 0 },
71 |     show: {
72 |       opacity: 1,
73 |       transition: {
74 |         staggerChildren: 0.1
75 |       }
76 |     }
77 |   };
78 |   
79 |   const item = {
80 |     hidden: { y: 20, opacity: 0 },
81 |     show: { y: 0, opacity: 1 }
82 |   };
83 |   
84 |   return (
85 |     <PageTransition>
86 |       <div
87 |         className="min-h-screen flex flex-col items-center justify-center relative"
88 |         style={{
89 |           backgroundImage: "url(/fondo_png.png)",
90 |           backgroundSize: "cover",
91 |           backgroundPosition: "center",
92 |           backgroundRepeat: "no-repeat",
93 |         }}
94 |       >
95 |         <BackButton />
96 |         
97 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
98 |           <h1 className="text-3xl font-bold text-[#BB79D1] text-center mb-4 font-heading drop-shadow-lg">
99 |             Selecciona un Personaje
100 |           </h1>
101 |           
102 |           <p className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-8 font-medium shadow-sm">
103 |             Elige un personaje para tu historia o crea uno nuevo
104 |           </p>
105 |           
106 |           {isLoading ? (
107 |             <div className="text-center bg-white/70 rounded-xl p-4 shadow-md mb-8">
108 |               <div className="text-[#BB79D1] font-medium">Cargando personajes...</div>
109 |             </div>
110 |           ) : (
111 |             <>
112 |               <motion.div 
113 |                 variants={container}
114 |                 initial="hidden"
115 |                 animate="show"
116 |                 className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8"
117 |               >
118 |                 <motion.div variants={item}>
119 |                   <div 
120 |                     onClick={handleCreateNewCharacter}
121 |                     className="flex flex-col items-center justify-center p-6 h-40 cursor-pointer
122 |                       bg-white/70 rounded-2xl border-2 border-[#F6A5B7]/60
123 |                       hover:bg-[#F6A5B7]/10 hover:scale-105 hover:shadow-md
124 |                       transition-all duration-300"
125 |                   >
126 |                     <Plus size={40} className="text-[#F6A5B7] mb-2" />
127 |                     <span className="text-[#222] text-center font-medium">Crear Nuevo</span>
128 |                   </div>
129 |                 </motion.div>
130 |                 
131 |                 {savedCharacters.map((character) => (
132 |                   <motion.div key={character.id} variants={item}>
133 |                     <div 
134 |                       onClick={() => handleSelectCharacter(character.id)}
135 |                       className={`
136 |                         flex flex-col items-center justify-center p-6 h-40 cursor-pointer
137 |                         bg-white/70 rounded-2xl border-2 border-[#7DC4E0]/60
138 |                         ${currentCharacter && currentCharacter.id === character.id ? 'ring-4 ring-[#7DC4E0] shadow-lg transform scale-105' : 'hover:bg-[#7DC4E0]/10 hover:scale-105 hover:shadow-md'}
139 |                         transition-all duration-300
140 |                       `}
141 |                     >
142 |                       <User size={40} className="text-[#7DC4E0] mb-2" />
143 |                       <span className="text-[#222] text-center font-medium">{character.name}</span>
144 |                       <span className="text-[#555] text-xs">{character.profession}</span>
145 |                     </div>
146 |                   </motion.div>
147 |                 ))}
148 |               </motion.div>
149 |               
150 |               {savedCharacters.length === 0 && (
151 |                 <div className="text-center bg-white/70 rounded-xl p-4 shadow-md mb-8">
152 |                   <div className="text-[#555] font-medium">No tienes personajes guardados. ¡Crea uno nuevo!</div>
153 |                 </div>
154 |               )}
155 |               
156 |               {savedCharacters.length > 0 && (
157 |                 <div className="flex justify-center w-full mt-2 mb-2">
158 |                   <StoryButton
159 |                     onClick={() => handleSelectCharacter(currentCharacter?.id || "")}
160 |                     isFullWidth={false}
161 |                     disabled={!currentCharacter}
162 |                     className="w-full max-w-xs py-4 rounded-2xl text-white text-lg font-semibold shadow-lg bg-[#BB79D1] hover:bg-[#BB79D1]/90 border-2 border-[#BB79D1]/50 transition-all duration-200"
163 |                   >
164 |                     Continuar
165 |                   </StoryButton>
166 |                 </div>
167 |               )}
168 |             </>
169 |           )}
170 |         </div>
171 |       </div>
172 |     </PageTransition>
173 |   );
174 | }
```

src/pages/CharactersManagement.tsx
```
1 | import { useNavigate } from "react-router-dom";
2 | import { User, Plus, Edit, Trash2, ArrowLeft } from "lucide-react";
3 | import { useCharacterStore } from "../store/character/characterStore";
4 | import { useEffect, useState } from "react";
5 | import { useUserStore } from "../store/user/userStore";
6 | import PageTransition from "../components/PageTransition";
7 | import StoryButton from "../components/StoryButton";
8 | import { motion } from "framer-motion";
9 | import BackButton from "../components/BackButton";
10 | import { useToast } from "@/hooks/use-toast";
11 | import { StoryCharacter } from "../types";
12 | 
13 | export default function CharactersManagement() {
14 |   const navigate = useNavigate();
15 |   const { savedCharacters, loadCharactersFromSupabase, deleteCharacter, selectCharacter, resetCharacter } = useCharacterStore();
16 |   const [isLoading, setIsLoading] = useState(true);
17 |   const [characterToDelete, setCharacterToDelete] = useState<StoryCharacter | null>(null);
18 |   const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
19 |   const { toast } = useToast();
20 | 
21 |   // Cargar personajes al montar el componente
22 |   useEffect(() => {
23 |     const loadCharacters = async () => {
24 |       setIsLoading(true);
25 |       
26 |       const user = useUserStore.getState().user;
27 |       if (!user) {
28 |         console.error("No hay usuario autenticado para cargar personajes");
29 |         setIsLoading(false);
30 |         return;
31 |       }
32 |       
33 |       // Limpiar personajes existentes antes de cargar
34 |       useCharacterStore.setState({ savedCharacters: [] });
35 |       
36 |       // Forzar recarga limpia desde Supabase
37 |       await loadCharactersFromSupabase();
38 |       
39 |       setIsLoading(false);
40 |     };
41 |     
42 |     loadCharacters();
43 |   }, [loadCharactersFromSupabase]);
44 | 
45 |   const handleCreateNewCharacter = () => {
46 |     // Resetear el personaje actual para asegurar un ID único
47 |     resetCharacter();
48 |     navigate("/character-name?from=management");
49 |   };
50 | 
51 |   const handleEditCharacter = (characterId: string) => {
52 |     selectCharacter(characterId);
53 |     navigate("/character-name?from=management");
54 |   };
55 | 
56 |   const handleDeleteClick = (character: StoryCharacter) => {
57 |     setCharacterToDelete(character);
58 |     setShowDeleteConfirm(true);
59 |   };
60 | 
61 |   const confirmDelete = async () => {
62 |     if (characterToDelete) {
63 |       await deleteCharacter(characterToDelete.id);
64 |       setShowDeleteConfirm(false);
65 |       setCharacterToDelete(null);
66 |       toast({
67 |         title: "Personaje eliminado",
68 |         description: `El personaje ${characterToDelete.name} ha sido eliminado`,
69 |       });
70 |     }
71 |   };
72 | 
73 |   const cancelDelete = () => {
74 |     setShowDeleteConfirm(false);
75 |     setCharacterToDelete(null);
76 |   };
77 | 
78 |   const container = {
79 |     hidden: { opacity: 0 },
80 |     show: {
81 |       opacity: 1,
82 |       transition: {
83 |         staggerChildren: 0.1
84 |       }
85 |     }
86 |   };
87 |   
88 |   const item = {
89 |     hidden: { y: 20, opacity: 0 },
90 |     show: { y: 0, opacity: 1 }
91 |   };
92 | 
93 |   return (
94 |     <PageTransition>
95 |       <div
96 |         className="min-h-screen flex flex-col items-center justify-center relative overflow-auto"
97 |         style={{
98 |           backgroundImage: "url(/fondo_png.png)",
99 |           backgroundSize: "cover",
100 |           backgroundPosition: "center",
101 |           backgroundRepeat: "no-repeat",
102 |         }}
103 |       >
104 |         <BackButton onClick={() => navigate("/home")} />
105 |         
106 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
107 |           <h1 className="text-3xl font-bold text-[#BB79D1] text-center mb-6 font-heading drop-shadow-lg">
108 |             Mis Personajes
109 |           </h1>
110 |           
111 |           <div className="mb-8">
112 |             <button 
113 |               onClick={handleCreateNewCharacter}
114 |               className="w-full bg-[#F6A5B7] hover:bg-[#F6A5B7]/80 text-white font-semibold py-4 px-6 rounded-2xl shadow-lg flex items-center justify-center gap-3 transition-all duration-200 text-lg"
115 |             >
116 |               <Plus size={24} className="text-white" />
117 |               Crear Nuevo Personaje
118 |             </button>
119 |           </div>
120 |           
121 |           {isLoading ? (
122 |             <div className="flex justify-center my-8 bg-white/70 rounded-xl p-6 shadow-md">
123 |               <div className="animate-spin h-10 w-10 border-4 border-[#BB79D1] rounded-full border-t-transparent"></div>
124 |             </div>
125 |           ) : (
126 |             <>
127 |               {savedCharacters.length === 0 ? (
128 |                 <div className="bg-white/80 rounded-xl p-8 text-center text-[#222] shadow-md">
129 |                   <User size={48} className="mx-auto mb-4 text-[#BB79D1] opacity-70" />
130 |                   <h3 className="text-xl font-semibold mb-2 text-[#222]">No tienes personajes</h3>
131 |                   <p className="text-[#555] mb-6">
132 |                     Crea tu primer personaje para utilizarlo en tus historias
133 |                   </p>
134 |                   <StoryButton 
135 |                     onClick={handleCreateNewCharacter}
136 |                     variant="secondary"
137 |                     icon={<Plus size={16} />}
138 |                     className="bg-[#F6A5B7] hover:bg-[#F6A5B7]/80 text-white font-semibold py-2 px-4 rounded-xl shadow-md transition-all duration-200"
139 |                   >
140 |                     Crear Personaje
141 |                   </StoryButton>
142 |                 </div>
143 |               ) : (
144 |                 <motion.div 
145 |                   variants={container}
146 |                   initial="hidden"
147 |                   animate="show"
148 |                   className="space-y-4"
149 |                 >
150 |                   {savedCharacters.map((character) => (
151 |                     <motion.div key={character.id} variants={item}>
152 |                       <div className="bg-white/80 rounded-xl p-4 flex items-center shadow-md">
153 |                         <div className="w-12 h-12 rounded-full bg-[#7DC4E0]/20 border-2 border-[#7DC4E0]/40 flex items-center justify-center mr-4 flex-shrink-0">
154 |                           <User size={24} className="text-[#7DC4E0]" />
155 |                         </div>
156 |                         <div className="flex-grow mr-4">
157 |                           <h3 className="text-[#222] font-semibold text-lg">{character.name}</h3>
158 |                           <p className="text-[#555] text-sm">
159 |                             {character.characterType && 
160 |                               `${character.characterType}${character.profession ? ` · ${character.profession}` : ''}`}
161 |                           </p>
162 |                         </div>
163 |                         <div className="flex gap-2">
164 |                           <button 
165 |                             onClick={() => handleEditCharacter(character.id)}
166 |                             className="w-10 h-10 rounded-full bg-white/70 hover:bg-[#BB79D1]/20 flex items-center justify-center text-[#BB79D1] border border-[#BB79D1]/30 transition-colors shadow-sm"
167 |                             aria-label="Editar"
168 |                           >
169 |                             <Edit size={16} />
170 |                           </button>
171 |                           <button 
172 |                             onClick={() => handleDeleteClick(character)}
173 |                             className="w-10 h-10 rounded-full bg-white/70 hover:bg-[#F6A5B7]/20 flex items-center justify-center text-[#F6A5B7] hover:text-[#F6A5B7] border border-[#F6A5B7]/30 transition-colors shadow-sm"
174 |                             aria-label="Eliminar"
175 |                           >
176 |                             <Trash2 size={16} />
177 |                           </button>
178 |                         </div>
179 |                       </div>
180 |                     </motion.div>
181 |                   ))}
182 |                 </motion.div>
183 |               )}
184 |             </>
185 |           )}
186 |         </div>
187 | 
188 |         {/* Modal de confirmación de eliminación */}
189 |         {showDeleteConfirm && characterToDelete && (
190 |           <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 px-4">
191 |             <motion.div 
192 |               initial={{ scale: 0.9, opacity: 0 }}
193 |               animate={{ scale: 1, opacity: 1 }}
194 |               className="bg-white/90 rounded-xl p-6 max-w-md w-full shadow-lg"
195 |             >
196 |               <h3 className="text-xl font-semibold text-[#BB79D1] mb-2">Eliminar personaje</h3>
197 |               <p className="text-[#222] mb-6">
198 |                 ¿Estás seguro de que quieres eliminar a <span className="font-medium text-[#BB79D1]">{characterToDelete.name}</span>? 
199 |                 Esta acción no se puede deshacer.
200 |               </p>
201 |               <div className="flex gap-3">
202 |                 <button
203 |                   onClick={cancelDelete}
204 |                   className="flex-1 py-2 px-4 bg-white/80 rounded-xl text-[#222] font-medium hover:bg-white/90 transition-colors border border-[#BB79D1]/30 shadow-sm"
205 |                 >
206 |                   Cancelar
207 |                 </button>
208 |                 <button
209 |                   onClick={confirmDelete}
210 |                   className="flex-1 py-2 px-4 bg-[#F6A5B7] rounded-xl text-white font-medium hover:bg-[#F6A5B7]/80 transition-colors shadow-sm"
211 |                 >
212 |                   Eliminar
213 |                 </button>
214 |               </div>
215 |             </motion.div>
216 |           </div>
217 |         )}
218 |       </div>
219 |     </PageTransition>
220 |   );
221 | }
```

src/pages/Contact.tsx
```
1 | import React from 'react';
2 | import { useNavigate } from 'react-router-dom';
3 | import { Button } from "@/components/ui/button";
4 | import PageTransition from "../components/PageTransition";
5 | import { Mail, MapPin, Heart } from 'lucide-react';
6 | 
7 | const Contact: React.FC = () => {
8 |   const navigate = useNavigate();
9 | 
10 |   return (
11 |     <PageTransition>
12 |       <div 
13 |         className="min-h-screen flex flex-col"
14 |         style={{
15 |           backgroundImage: 'url(/fondo_png.png)',
16 |           backgroundSize: 'cover',
17 |           backgroundPosition: 'center',
18 |           backgroundRepeat: 'no-repeat',
19 |         }}
20 |       >
21 |         <div className="container mx-auto py-8 px-4 flex-1 overflow-auto">
22 |           <div className="max-w-4xl mx-auto">
23 |             <div className="text-center mb-6">
24 |               <h1 className="text-3xl font-bold text-[#222]">Contacto</h1>
25 |             </div>
26 | 
27 |             <div className="space-y-8 bg-white/80 p-8 rounded-2xl backdrop-blur-sm shadow-lg">
28 |               <div className="flex flex-col items-center text-center space-y-8">
29 |                 <div className="flex flex-col items-center">
30 |                   <Mail className="h-10 w-10 text-[#BB79D1] mb-2" />
31 |                   <h2 className="text-xl font-bold text-[#555]">Correo electrónico</h2>
32 |                   <a 
33 |                     href="mailto:hola@taleme.app" 
34 |                     className="text-lg text-[#BB79D1] hover:text-[#A5D6F6] transition-colors"
35 |                   >
36 |                     hola@taleme.app
37 |                   </a>
38 |                 </div>
39 | 
40 |                 <div className="flex flex-col items-center">
41 |                   <MapPin className="h-10 w-10 text-[#BB79D1] mb-2" />
42 |                   <h2 className="text-xl font-bold text-[#555]">Ubicación</h2>
43 |                   <p className="text-lg">Zaragoza, España</p>
44 |                 </div>
45 | 
46 |                 <div className="pt-8 border-t border-gray-200/50 w-3/4 mx-auto">
47 |                   <div className="flex flex-col items-center">
48 |                     <div className="flex items-center mb-2">
49 |                       <span className="text-xl font-bold text-[#555] mr-2">Hecho con</span>
50 |                       <Heart className="h-6 w-6 text-[#F6A5B7] fill-[#F6A5B7]" />
51 |                       <span className="text-xl font-bold text-[#555] ml-2">por:</span>
52 |                     </div>
53 |                     <p className="text-lg text-center">
54 |                       Luis Martín, Ivano Garcia y Miguel Tajada
55 |                     </p>
56 |                   </div>
57 |                 </div>
58 |               </div>
59 |             </div>
60 |             
61 |             <div className="flex justify-center mt-6">
62 |               <Button 
63 |                 variant="default" 
64 |                 onClick={() => navigate(-1)}
65 |                 className="min-w-32"
66 |               >
67 |                 Volver
68 |               </Button>
69 |             </div>
70 |           </div>
71 |         </div>
72 |       </div>
73 |     </PageTransition>
74 |   );
75 | };
76 | 
77 | export default Contact; 
```

src/pages/DurationSelection.tsx
```
1 | import { useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { Clock, Timer, Watch } from "lucide-react";
4 | import { useStoryOptionsStore } from "../store/storyOptions/storyOptionsStore";
5 | import BackButton from "../components/BackButton";
6 | import StoryButton from "../components/StoryButton";
7 | import PageTransition from "../components/PageTransition";
8 | import { StoryDuration } from "../types";
9 | 
10 | export default function DurationSelection() {
11 |   const navigate = useNavigate();
12 |   const { setDuration, currentStoryOptions } = useStoryOptionsStore();
13 |   const [selectedDuration, setSelectedDuration] = useState<StoryDuration | null>(
14 |     currentStoryOptions.duration || null
15 |   );
16 |   
17 |   const handleSelectDuration = (duration: StoryDuration) => {
18 |     setDuration(duration);
19 |     setSelectedDuration(duration);
20 |   };
21 |   
22 |   const handleContinue = () => {
23 |     navigate("/character-selection");
24 |   };
25 |   
26 |   return (
27 |     <PageTransition>
28 |       <div
29 |         className="min-h-screen flex flex-col items-center justify-center relative"
30 |         style={{
31 |           backgroundImage: "url(/fondo_png.png)",
32 |           backgroundSize: "cover",
33 |           backgroundPosition: "center",
34 |           backgroundRepeat: "no-repeat",
35 |         }}
36 |       >
37 |         <BackButton />
38 |         <div className="w-full max-w-xl mx-auto px-4 py-8">
39 |           <h1 className="text-3xl font-bold text-[#BB79D1] text-center mb-4 font-heading drop-shadow-lg">
40 |             Duración de la Historia
41 |           </h1>
42 |           <p className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-8 font-medium shadow-sm">
43 |             ¿Cuánto tiempo quieres que dure la historia?
44 |           </p>
45 |           <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
46 |             <div 
47 |               onClick={() => handleSelectDuration("short")}
48 |               className={`
49 |                 flex flex-col items-center justify-center p-6 cursor-pointer
50 |                 bg-white/70 rounded-2xl border-2 border-[#F6A5B7]/60
51 |                 ${selectedDuration === "short" ? 'ring-4 ring-[#F6A5B7] shadow-lg transform scale-105' : 'hover:bg-[#F6A5B7]/10 hover:scale-105 hover:shadow-md'}
52 |                 transition-all duration-300
53 |               `}
54 |             >
55 |               <div className="text-[#F6A5B7] text-3xl mb-3">
56 |                 <Clock />
57 |               </div>
58 |               <span className="text-[#222] text-center font-medium">Breve (3-5 min)</span>
59 |             </div>
60 |             
61 |             <div 
62 |               onClick={() => handleSelectDuration("medium")}
63 |               className={`relative
64 |                 flex flex-col items-center justify-center p-6 cursor-pointer
65 |                 bg-white/70 rounded-2xl border-2 border-[#F9DA60]/60
66 |                 ${selectedDuration === "medium" ? 'ring-4 ring-[#F9DA60] shadow-lg transform scale-105' : 'hover:bg-[#F9DA60]/10 hover:scale-105 hover:shadow-md'}
67 |                 transition-all duration-300
68 |               `}
69 |             >
70 |               <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-[#E6B7D9]/70 text-white text-xs font-semibold px-2 py-0.5 rounded-full shadow-md whitespace-nowrap">
71 |                 Narración no disponible
72 |               </div>
73 |               <div className="text-[#F9DA60] text-3xl mb-3">
74 |                 <Timer />
75 |               </div>
76 |               <span className="text-[#222] text-center font-medium">Media (5-10 min)</span>
77 |             </div>
78 |             
79 |             <div 
80 |               onClick={() => handleSelectDuration("long")}
81 |               className={`relative
82 |                 flex flex-col items-center justify-center p-6 cursor-pointer
83 |                 bg-white/70 rounded-2xl border-2 border-[#7DC4E0]/60
84 |                 ${selectedDuration === "long" ? 'ring-4 ring-[#7DC4E0] shadow-lg transform scale-105' : 'hover:bg-[#7DC4E0]/10 hover:scale-105 hover:shadow-md'}
85 |                 transition-all duration-300
86 |               `}
87 |             >
88 |               <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-[#E6B7D9]/70 text-white text-xs font-semibold px-2 py-0.5 rounded-full shadow-md whitespace-nowrap">
89 |                 Narración no disponible
90 |               </div>
91 |               <div className="text-[#7DC4E0] text-3xl mb-3">
92 |                 <Watch />
93 |               </div>
94 |               <span className="text-[#222] text-center font-medium">Larga (10-15 min)</span>
95 |             </div>
96 |           </div>
97 |           
98 |           {/* Botón centrado y alargado al estilo Home */}
99 |           <div className="flex justify-center w-full mt-2 mb-2">
100 |             <StoryButton
101 |               onClick={handleContinue}
102 |               isFullWidth={false}
103 |               disabled={!selectedDuration}
104 |               className="w-full max-w-xs py-4 rounded-2xl text-white text-lg font-semibold shadow-lg bg-[#BB79D1] hover:bg-[#BB79D1]/90 border-2 border-[#BB79D1]/50 transition-all duration-200"
105 |             >
106 |               Continuar
107 |             </StoryButton>
108 |           </div>
109 |         </div>
110 |       </div>
111 |     </PageTransition>
112 |   );
113 | }
```

src/pages/ErrorPage.tsx
```
1 | import { useLocation, useNavigate } from "react-router-dom";
2 | import { RefreshCw, Home } from "lucide-react";
3 | import PageTransition from "../components/PageTransition";
4 | 
5 | export default function ErrorPage() {
6 |   const location = useLocation();
7 |   const navigate = useNavigate();
8 |   const error = location.state?.error || "Algo salió mal";
9 | 
10 |   const tryAgain = () => {
11 |     navigate(-1);
12 |   };
13 | 
14 |   return (
15 |     <PageTransition>
16 |       <div
17 |         className="min-h-screen flex flex-col items-center justify-center p-6"
18 |         style={{
19 |           backgroundImage: 'url(/fondo_png.png)',
20 |           backgroundSize: 'cover',
21 |           backgroundPosition: 'center',
22 |           backgroundRepeat: 'no-repeat',
23 |         }}
24 |       >
25 |         <div className="w-full max-w-md bg-white/90 rounded-3xl shadow-lg overflow-hidden">
26 |           <div className="p-8 flex flex-col items-center">
27 |             <div className="w-24 h-24 rounded-full bg-[#F9DA60]/20 flex items-center justify-center mb-6">
28 |               <svg width="44" height="44" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
29 |                 <path d="M12 9V13" stroke="#F9DA60" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
30 |                 <path d="M12 17.0195V17" stroke="#F9DA60" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
31 |                 <path d="M10.1708 3.61232L1.97534 17.001C1.02535 18.5413 2.17321 20.501 3.97914 20.501H20.0209C21.8268 20.501 22.9746 18.5413 22.0246 17.001L13.8292 3.61232C12.8708 2.05984 11.1292 2.05984 10.1708 3.61232Z" stroke="#F9DA60" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
32 |               </svg>
33 |             </div>
34 | 
35 |             <h1 className="text-3xl font-bold text-[#222] mb-4 text-center">
36 |               ¡Ups! Ocurrió un error
37 |             </h1>
38 | 
39 |             <p className="text-[#333] mb-10 text-center">
40 |               Nuestros asistentes de TaleMe! están teniendo problemas para crear tu historia. Por favor, inténtalo de nuevo.
41 |             </p>
42 | 
43 |             <div className="w-full">
44 |               <button
45 |                 onClick={tryAgain}
46 |                 className="w-full flex items-center justify-center gap-2 bg-[#BB79D1] hover:bg-[#BB79D1]/90 text-white rounded-full py-4 font-semibold text-lg mb-4"
47 |               >
48 |                 <RefreshCw className="animate-spin-slow" size={20} />
49 |                 Intentar nuevamente
50 |               </button>
51 | 
52 |               <button
53 |                 onClick={() => navigate("/home")}
54 |                 className="w-full flex items-center justify-center gap-2 bg-[#BB79D1] hover:bg-[#BB79D1]/90 text-white rounded-full py-4 font-semibold text-lg"
55 |               >
56 |                 <Home size={20} />
57 |                 Volver al inicio
58 |               </button>
59 |             </div>
60 |           </div>
61 |         </div>
62 |       </div>
63 |     </PageTransition>
64 |   );
65 | }
```

src/pages/GeneratingStory.tsx
```
1 | import { useEffect } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { motion } from "framer-motion";
4 | import { generateStory } from "../store/stories/storyGenerator";
5 | import { useStoriesStore } from "../store/stories/storiesStore";
6 | import { useStoryOptionsStore } from "../store/storyOptions/storyOptionsStore";
7 | import IconLoadingAnimation from "../components/IconLoadingAnimation";
8 | import PageTransition from "../components/PageTransition";
9 | 
10 | export default function GeneratingStory() {
11 |   const navigate = useNavigate();
12 |   const { currentStoryOptions } = useStoryOptionsStore();
13 |   
14 |   useEffect(() => {
15 |     const generate = async () => {
16 |       try {
17 |         const story = await generateStory(currentStoryOptions);
18 |         navigate(`/story/${story.id}`);
19 |       } catch (error) {
20 |         console.error("Error generating story:", error);
21 |         navigate("/error", { state: { error } });
22 |       }
23 |     };
24 |     
25 |     generate();
26 |   }, []);
27 |   
28 |   return (
29 |     <PageTransition>
30 |       <div 
31 |         className="min-h-screen flex flex-col items-center justify-center p-6"
32 |         style={{
33 |           backgroundImage: "url(/fondo_png.png)",
34 |           backgroundSize: "cover",
35 |           backgroundPosition: "center",
36 |           backgroundRepeat: "no-repeat",
37 |         }}
38 |       >
39 |         <div className="w-full max-w-md flex flex-col items-center justify-center">
40 |           <motion.div
41 |             initial={{ opacity: 0, scale: 0.8 }}
42 |             animate={{ opacity: 1, scale: 1 }}
43 |             transition={{ duration: 0.5 }}
44 |             className="mb-10"
45 |           >
46 |             <IconLoadingAnimation message="Creando tu historia..." />
47 |           </motion.div>
48 |           
49 |           <motion.div
50 |             initial={{ opacity: 0 }}
51 |             animate={{ opacity: 1 }}
52 |             transition={{ delay: 1, duration: 1 }}
53 |             className="bg-white/70 text-[#222] p-4 rounded-xl max-w-sm text-center shadow-md"
54 |           >
55 |             <p className="font-medium">Estamos personalizando una historia mágica especialmente para ti...</p>
56 |             
57 |             <div className="mt-4 grid grid-cols-3 gap-2">
58 |               {currentStoryOptions.character && (
59 |                 <div className="bg-[#7DC4E0]/20 p-2 rounded-lg border border-[#7DC4E0]/30">
60 |                   <p className="text-xs font-semibold text-[#7DC4E0]">Personaje</p>
61 |                   <p className="text-sm truncate">{currentStoryOptions.character.name || "Personaje"}</p>
62 |                 </div>
63 |               )}
64 |               
65 |               {currentStoryOptions.genre && (
66 |                 <div className="bg-[#BB79D1]/20 p-2 rounded-lg border border-[#BB79D1]/30">
67 |                   <p className="text-xs font-semibold text-[#BB79D1]">Género</p>
68 |                   <p className="text-sm truncate">{currentStoryOptions.genre}</p>
69 |                 </div>
70 |               )}
71 |               
72 |               {currentStoryOptions.duration && (
73 |                 <div className="bg-[#F9DA60]/20 p-2 rounded-lg border border-[#F9DA60]/30">
74 |                   <p className="text-xs font-semibold text-[#F9DA60]">Duración</p>
75 |                   <p className="text-sm truncate">{currentStoryOptions.duration}</p>
76 |                 </div>
77 |               )}
78 |             </div>
79 |           </motion.div>
80 | 
81 |           {/* Nuevo cuadro de aviso */}
82 |           <motion.div
83 |             initial={{ opacity: 0 }}
84 |             animate={{ opacity: 1 }}
85 |             transition={{ delay: 1.5, duration: 1 }}
86 |             className="mt-6 bg-white/70 text-[#222] p-4 rounded-xl max-w-sm text-center shadow-md"
87 |           >
88 |             <p className="font-medium">
89 |               ¡Tu cuento está casi listo! Para que la magia continúe, por favor, no abandones esta página mientras se crea. ✨
90 |             </p>
91 |           </motion.div>
92 |         </div>
93 |       </div>
94 |     </PageTransition>
95 |   );
96 | }
```

src/pages/Home.tsx
```
1 | import React, { useEffect } from 'react';
2 | import { useNavigate, Link } from "react-router-dom";
3 | import { Settings, User, Star, ChevronRight } from "lucide-react";
4 | import { motion } from "framer-motion";
5 | import { useUserStore } from "../store/user/userStore";
6 | import { useStoriesStore } from "../store/stories/storiesStore";
7 | import PageTransition from "../components/PageTransition";
8 | import { useToast } from "@/hooks/use-toast";
9 | 
10 | export default function Home() {
11 |   const navigate = useNavigate();
12 |   const { hasCompletedProfile, canCreateStory, isPremium, getRemainingMonthlyStories } = useUserStore();
13 |   const { generatedStories } = useStoriesStore();
14 |   const { toast } = useToast();
15 | 
16 |   useEffect(() => {
17 |     const needsProfileSetup = !hasCompletedProfile();
18 |     if (needsProfileSetup) {
19 |       navigate("/profile-config", { replace: true });
20 |     }
21 |   }, [hasCompletedProfile, navigate]);
22 | 
23 |   if (!hasCompletedProfile()) {
24 |     return null;
25 |   }
26 | 
27 |   const handleNewStory = () => {
28 |     if (canCreateStory()) {
29 |       navigate("/duration");
30 |     } else {
31 |       toast({
32 |         title: "Límite de historias alcanzado",
33 |         description: isPremium()
34 |           ? "Has alcanzado el límite de historias para tu plan premium. Contacta con soporte para más información."
35 |           : `Has alcanzado el límite mensual de historias gratuitas. Actualiza a premium para crear más historias.`,
36 |         variant: "destructive",
37 |       });
38 |     }
39 |   };
40 | 
41 |   const premiumUser = isPremium();
42 |   const subscriptionText = premiumUser ? 'Premium' : 'Free';
43 | 
44 |   return (
45 |     <PageTransition>
46 |       <div
47 |         className="relative min-h-screen flex flex-col items-center justify-center p-0"
48 |         style={{
49 |           backgroundImage: 'url(/fondo_png.png)',
50 |           backgroundSize: 'cover',
51 |           backgroundPosition: 'center',
52 |           backgroundRepeat: 'no-repeat',
53 |         }}
54 |       >
55 |         {/* Botones superiores */}
56 |         <div className="absolute top-6 right-6 flex gap-3 z-10">
57 |           <Link
58 |             to="/plans"
59 |             className={`flex items-center gap-2 px-3 py-1.5 rounded-xl shadow-md text-xs font-semibold transition-all duration-200 bg-white/70 hover:bg-white/90 text-pink-500`}
60 |             aria-label="Ver planes y suscripción"
61 |           >
62 |             <img src="/icono_png.png" alt="icono free/premium" className="h-5 w-5" />
63 |             <span>{subscriptionText}</span>
64 |             <ChevronRight className="h-3.5 w-3.5 opacity-75" />
65 |           </Link>
66 |           <Link
67 |             to="/profile-config"
68 |             className="w-9 h-9 rounded-full bg-white/70 flex items-center justify-center text-pink-500 hover:bg-white/90 transition-all shadow-md"
69 |             aria-label="Configuración de Perfil"
70 |           >
71 |             <User className="h-5 w-5" />
72 |           </Link>
73 |           <Link
74 |             to="/settings"
75 |             className="w-9 h-9 rounded-full bg-white/70 flex items-center justify-center text-pink-500 hover:bg-white/90 transition-all shadow-md"
76 |             aria-label="Ajustes"
77 |           >
78 |             <Settings className="h-5 w-5" />
79 |           </Link>
80 |         </div>
81 | 
82 |         {/* Logo y título */}
83 |         <div className="flex flex-col items-center mt-10 mb-8 select-none">
84 |           <img src="/logo_png.png" alt="TaleMe Logo" className="w-80 max-w-md mx-auto mb-4 drop-shadow-xl" />
85 |         </div>
86 | 
87 |         {/* Botones principales */}
88 |         <div className="flex flex-col items-center w-full max-w-xs gap-5 -mt-4">
89 |           <button
90 |             className={`w-full py-4 rounded-2xl text-lg font-semibold shadow-lg transition-all duration-200 ${
91 |               canCreateStory()
92 |                 ? "bg-[#f6a5b7] hover:bg-[#fbb6ce] text-white"
93 |                 : "bg-[#f6a5b7]/50 text-white/90 cursor-not-allowed"
94 |             }`}
95 |             onClick={handleNewStory}
96 |             // disabled={!canCreateStory()}
97 |             title={!canCreateStory() ? `Te quedan ${getRemainingMonthlyStories()} historias este mes` : ""}
98 |           >
99 |             Generar una Nueva Historia
100 |           </button>
101 |           <button
102 |             className="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg transition-all duration-200 bg-[#f7c59f] hover:bg-[#ffd7ba]"
103 |             onClick={() => navigate("/characters-management")}
104 |           >
105 |             Mis Personajes
106 |           </button>
107 |           {generatedStories.length > 0 && (
108 |             <button
109 |               className="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg transition-all duration-200 bg-[#a5d6f6] hover:bg-[#c8e6fa]"
110 |               onClick={() => navigate("/stories")}
111 |             >
112 |               Mis Historias
113 |             </button>
114 |           )}
115 |         </div>
116 |       </div>
117 |     </PageTransition>
118 |   );
119 | }
```

src/pages/Index.tsx
```
1 | // Update this page (the content is just a fallback if you fail to update the page)
2 | 
3 | const Index = () => {
4 |   return (
5 |     <div className="min-h-screen flex items-center justify-center bg-gray-100">
6 |       <div className="text-center">
7 |         <h1 className="text-4xl font-bold mb-4">Welcome to Your Blank App</h1>
8 |         <p className="text-xl text-gray-600">Start building your amazing project here!</p>
9 |       </div>
10 |     </div>
11 |   );
12 | };
13 | 
14 | export default Index;
```

src/pages/Login.tsx
```
1 | import { useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { Mail, Lock, Eye, EyeOff } from "lucide-react";
4 | import { useUserStore } from "../store/user/userStore";
5 | import { Input } from "@/components/ui/input";
6 | import { Form, FormControl, FormField, FormItem } from "@/components/ui/form";
7 | import { useForm } from "react-hook-form";
8 | import PageTransition from "../components/PageTransition";
9 | import { useToast } from "@/hooks/use-toast";
10 | import { login, requestPasswordReset, signInWithGoogle } from "../supabaseAuth";
11 | import { getUserProfile } from "../services/supabase";
12 | 
13 | export default function Login() {
14 |   const navigate = useNavigate();
15 |   const { loginUser } = useUserStore();
16 |   const { toast } = useToast();
17 |   const [showPassword, setShowPassword] = useState(false);
18 |   const [rememberSession, setRememberSession] = useState(false);
19 |   const [isLoading, setIsLoading] = useState(false);
20 |   const [isGoogleLoading, setIsGoogleLoading] = useState(false);
21 | 
22 |   const form = useForm({
23 |     defaultValues: {
24 |       email: "",
25 |       password: ""
26 |     }
27 |   });
28 | 
29 |   const handleLogin = async (data: { email: string; password: string }) => {
30 |     try {
31 |       setIsLoading(true);
32 |       const { user, error } = await login(data.email, data.password);
33 | 
34 |       if (error) {
35 |         toast({
36 |           title: "Error de inicio de sesión",
37 |           description: error.message,
38 |           variant: "destructive"
39 |         });
40 |         return;
41 |       }
42 | 
43 |       if (user) {
44 |         loginUser(user);
45 | 
46 |         toast({
47 |           title: "Inicio de sesión exitoso",
48 |           description: "¡Bienvenido de nuevo!",
49 |         });
50 | 
51 |         try {
52 |           // Verificar si el usuario ya tiene un perfil configurado
53 |           const { success, profile } = await getUserProfile(user.id);
54 | 
55 |           if (success && profile) {
56 |             // Si ya tiene perfil, redirigir a la página principal
57 |             navigate("/home");
58 |           } else {
59 |             // Si no tiene perfil, redirigir a la configuración de perfil
60 |             navigate("/profile");
61 |           }
62 |         } catch (profileError) {
63 |           console.error("Error al verificar perfil:", profileError);
64 |           // En caso de error, mandamos a la configuración por seguridad
65 |           navigate("/profile");
66 |         }
67 |       } else {
68 |         toast({
69 |           title: "Error de inicio de sesión",
70 |           description: "Credenciales inválidas",
71 |           variant: "destructive"
72 |         });
73 |       }
74 |     } catch (err) {
75 |       toast({
76 |         title: "Error inesperado",
77 |         description: "Ha ocurrido un error inesperado",
78 |         variant: "destructive"
79 |       });
80 |       console.error(err);
81 |     } finally {
82 |       setIsLoading(false);
83 |     }
84 |   };
85 | 
86 |   const handleGoogleLogin = async () => {
87 |     try {
88 |       setIsGoogleLoading(true);
89 |       const { error } = await signInWithGoogle();
90 | 
91 |       if (error) {
92 |         toast({
93 |           title: "Error al iniciar sesión con Google",
94 |           description: error.message,
95 |           variant: "destructive"
96 |         });
97 |       }
98 |     } catch (err) {
99 |       toast({
100 |         title: "Error inesperado",
101 |         description: "Ha ocurrido un error al iniciar sesión con Google",
102 |         variant: "destructive"
103 |       });
104 |       console.error(err);
105 |     } finally {
106 |       setIsGoogleLoading(false);
107 |     }
108 |   };
109 | 
110 |   const handleForgotPassword = async () => {
111 |     const email = form.getValues("email");
112 |     if (!email) {
113 |       toast({
114 |         title: "Email requerido",
115 |         description: "Por favor ingresa tu correo electrónico para restablecer la contraseña",
116 |         variant: "destructive"
117 |       });
118 |       return;
119 |     }
120 | 
121 |     try {
122 |       setIsLoading(true);
123 |       const { error } = await requestPasswordReset(email);
124 | 
125 |       if (error) {
126 |         toast({
127 |           title: "Error al solicitar restablecimiento",
128 |           description: error.message,
129 |           variant: "destructive"
130 |         });
131 |         return;
132 |       }
133 | 
134 |       toast({
135 |         title: "Solicitud enviada",
136 |         description: "Revisa tu correo electrónico para restablecer tu contraseña",
137 |       });
138 |     } catch (err) {
139 |       toast({
140 |         title: "Error inesperado",
141 |         description: "Ha ocurrido un error inesperado",
142 |         variant: "destructive"
143 |       });
144 |       console.error(err);
145 |     } finally {
146 |       setIsLoading(false);
147 |     }
148 |   };
149 | 
150 |   const togglePasswordVisibility = () => setShowPassword(!showPassword);
151 | 
152 |   return (
153 |     <PageTransition>
154 |       <div 
155 |         className="min-h-screen flex flex-col items-center justify-center p-6"
156 |         style={{
157 |           backgroundImage: 'url(/fondo_png.png)',
158 |           backgroundSize: 'cover',
159 |           backgroundPosition: 'center',
160 |           backgroundRepeat: 'no-repeat',
161 |         }}
162 |       >
163 |         <div className="w-full max-w-md bg-white/70 rounded-3xl p-8 shadow-lg border border-[#BB79D1]/20">
164 |           <div className="flex justify-center mb-6">
165 |             <img src="/logo_png.png" alt="TaleMe Logo" className="w-48 max-w-full" />
166 |           </div>
167 | 
168 |           <Form {...form}>
169 |             <form
170 |               onSubmit={form.handleSubmit(handleLogin)}
171 |               className="space-y-5"
172 |             >
173 |               <FormField
174 |                 control={form.control}
175 |                 name="email"
176 |                 render={({ field }) => (
177 |                   <FormItem>
178 |                     <div className="relative">
179 |                       <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1]" size={20} />
180 |                       <FormControl>
181 |                         <Input
182 |                           placeholder="Correo electrónico"
183 |                           className="pl-10 py-6 rounded-xl bg-white/80 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-1 focus:ring-[#BB79D1] text-[#333]"
184 |                           type="email"
185 |                           {...field}
186 |                           required
187 |                         />
188 |                       </FormControl>
189 |                     </div>
190 |                   </FormItem>
191 |                 )}
192 |               />
193 | 
194 |               <FormField
195 |                 control={form.control}
196 |                 name="password"
197 |                 render={({ field }) => (
198 |                   <FormItem>
199 |                     <div className="relative">
200 |                       <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1]" size={20} />
201 |                       <FormControl>
202 |                         <Input
203 |                           placeholder="Contraseña"
204 |                           className="pl-10 pr-10 py-6 rounded-xl bg-white/80 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-1 focus:ring-[#BB79D1] text-[#333]"
205 |                           type={showPassword ? "text" : "password"}
206 |                           {...field}
207 |                           required
208 |                         />
209 |                       </FormControl>
210 |                       <button
211 |                         type="button"
212 |                         onClick={togglePasswordVisibility}
213 |                         className="absolute right-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1] hover:text-[#A5D6F6] transition-colors"
214 |                       >
215 |                         {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
216 |                       </button>
217 |                     </div>
218 |                   </FormItem>
219 |                 )}
220 |               />
221 | 
222 |               <div className="flex items-center justify-between">
223 |                 <label className="flex items-center space-x-2 cursor-pointer">
224 |                   <input
225 |                     type="checkbox"
226 |                     checked={rememberSession}
227 |                     onChange={() => setRememberSession(!rememberSession)}
228 |                     className="rounded text-[#F6A5B7] focus:ring-[#F6A5B7] border-[#BB79D1]/30"
229 |                   />
230 |                   <span className="text-sm text-[#555]">Recordar sesión</span>
231 |                 </label>
232 | 
233 |                 <button
234 |                   type="button"
235 |                   onClick={handleForgotPassword}
236 |                   className="text-sm text-[#BB79D1] hover:text-[#A5D6F6] hover:underline transition-colors"
237 |                 >
238 |                   ¿Olvidaste tu contraseña?
239 |                 </button>
240 |               </div>
241 | 
242 |               <button
243 |                 type="submit"
244 |                 disabled={isLoading}
245 |                 className="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg transition-all duration-200 bg-[#F6A5B7] hover:bg-[#F6A5B7]/80 active:bg-[#F6A5B7]/90 disabled:opacity-60 disabled:cursor-not-allowed"
246 |               >
247 |                 {isLoading ? "Iniciando sesión..." : "Iniciar Sesión"}
248 |               </button>
249 | 
250 | 
251 |               <div className="relative flex items-center my-4">
252 |                 <div className="flex-grow border-t border-[#BB79D1]/20"></div>
253 |                 <span className="mx-4 flex-shrink text-[#555] text-sm">O continúa con</span>
254 |                 <div className="flex-grow border-t border-[#BB79D1]/20"></div>
255 |               </div>
256 |               <button
257 |                 type="button"
258 |                 onClick={handleGoogleLogin}
259 |                 disabled={isGoogleLoading}
260 |                 className="w-full flex items-center justify-center gap-2 bg-white text-[#333] rounded-xl py-3 hover:bg-gray-100 transition-colors duration-300 border border-[#BB79D1]/20 shadow-md"
261 |               >
262 |                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px">
263 |                   <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" />
264 |                   <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" />
265 |                   <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" />
266 |                   <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z" />
267 |                 </svg>
268 |                 {isGoogleLoading ? "Conectando..." : "Iniciar sesión con Google"}
269 |               </button>
270 | 
271 |               <div className="text-center mt-5">
272 |                 <span className="text-[#555] text-sm">¿No tienes una cuenta? </span>
273 |                 <button
274 |                   type="button"
275 |                   onClick={() => navigate("/signup")}
276 |                   className="text-[#BB79D1] font-semibold text-sm hover:underline"
277 |                 >
278 |                   Registrarse
279 |                 </button>
280 |               </div>
281 |             </form>
282 |           </Form>
283 |         </div>
284 |       </div>
285 |     </PageTransition>
286 |   );
287 | }
```

src/pages/NotFound.tsx
```
1 | import { useNavigate } from "react-router-dom";
2 | import { Home } from "lucide-react";
3 | import PageTransition from "../components/PageTransition";
4 | 
5 | export default function NotFound() {
6 |   const navigate = useNavigate();
7 | 
8 |   return (
9 |     <PageTransition>
10 |       <div
11 |         className="min-h-screen flex flex-col items-center justify-center p-6"
12 |         style={{
13 |           backgroundImage: 'url(/fondo_png.png)',
14 |           backgroundSize: 'cover',
15 |           backgroundPosition: 'center',
16 |           backgroundRepeat: 'no-repeat',
17 |         }}
18 |       >
19 |         <div className="w-full max-w-md bg-white/90 rounded-3xl shadow-lg overflow-hidden">
20 |           <div className="p-8 flex flex-col items-center">
21 |             <div className="w-24 h-24 rounded-full bg-[#BB79D1]/20 flex items-center justify-center mb-6">
22 |               <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
23 |                 <path d="M14 2.5L14 6.5C14 7.05 14.45 7.5 15 7.5L19 7.5" stroke="#BB79D1" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
24 |                 <path d="M6 13.5V12.9C6 11.0297 6 10.0945 6.43597 9.4453C6.81947 8.87762 7.37762 8.45322 8.0453 8.21675C8.69945 8 9.51292 8 11.1398 8C11.6462 8 11.8994 8 12.1174 8.01666C12.3293 8.03261 12.5139 8.06577 12.6904 8.11391C12.86 8.16 13.0145 8.22462 13.3235 8.35385V8.35385C13.6195 8.47809 13.7675 8.54021 13.8789 8.63C13.9832 8.71405 14.0701 8.81649 14.1353 8.93149C14.2042 9.053 14.2457 9.19648 14.3287 9.48345L14.5 10.0001" stroke="#BB79D1" strokeWidth="1.5" strokeLinecap="round" />
25 |                 <path d="M14.5 14.5L15.5 14.5" stroke="#BB79D1" strokeWidth="1.5" strokeLinecap="round" />
26 |                 <path d="M9 18.5H12" stroke="#BB79D1" strokeWidth="1.5" strokeLinecap="round" />
27 |                 <path d="M13.5 21H8.2C7.07989 21 6.51984 21 6.09202 20.782C5.71569 20.5903 5.40973 20.2843 5.21799 19.908C5 19.4802 5 18.9201 5 17.8V6.2C5 5.07989 5 4.51984 5.21799 4.09202C5.40973 3.71569 5.71569 3.40973 6.09202 3.21799C6.51984 3 7.07989 3 8.2 3H11.4C11.9601 3 12.2401 3 12.5056 3.10899C12.7477 3.20487 12.9667 3.35345 13.1465 3.54254C13.3469 3.75596 13.4869 4.04931 13.7672 4.63602L15.4471 8.20775C15.6038 8.52143 15.6822 8.67827 15.7385 8.84087C15.789 8.98529 15.825 9.13516 15.8465 9.2873C15.8705 9.45552 15.8705 9.62661 15.8705 9.9688V17.8C15.8705 18.9201 15.8705 19.4802 15.6525 19.908C15.4608 20.2843 15.1548 20.5903 14.7785 20.782C14.3507 21 13.7906 21 12.6705 21" stroke="#BB79D1" strokeWidth="1.5" strokeLinecap="round" />
28 |               </svg>
29 |             </div>
30 | 
31 |             <h1 className="text-3xl font-bold text-[#222] mb-4 text-center">
32 |               Página no encontrada
33 |             </h1>
34 | 
35 |             <p className="text-[#333] mb-10 text-center">
36 |               Parece que te has aventurado a un lugar que no existe en nuestro mundo mágico.
37 |             </p>
38 | 
39 |             <button
40 |               onClick={() => navigate("/")}
41 |               className="w-full flex items-center justify-center gap-2 bg-[#BB79D1] hover:bg-[#BB79D1]/90 text-white rounded-full py-4 font-semibold text-lg"
42 |             >
43 |               <Home size={20} />
44 |               Volver al inicio
45 |             </button>
46 |           </div>
47 |         </div>
48 |       </div>
49 |     </PageTransition>
50 |   );
51 | }
```

src/pages/PaymentCancel.tsx
```
1 | import { useEffect, useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { ArrowLeft } from "lucide-react";
4 | import PageTransition from "../components/PageTransition";
5 | 
6 | export default function PaymentCancel() {
7 |   const navigate = useNavigate();
8 |   const [timeLeft, setTimeLeft] = useState(5);
9 | 
10 |   useEffect(() => {
11 |     // Automatically redirect after 5 seconds
12 |     if (timeLeft > 0) {
13 |       const timer = setTimeout(() => {
14 |         setTimeLeft(timeLeft - 1);
15 |       }, 1000);
16 |       return () => clearTimeout(timer);
17 |     } else {
18 |       navigate("/profile");
19 |     }
20 |   }, [timeLeft, navigate]);
21 | 
22 |   return (
23 |     <PageTransition>
24 |       <div
25 |         className="min-h-screen flex flex-col items-center justify-center p-4"
26 |         style={{
27 |           backgroundImage: 'url(/fondo_png.png)',
28 |           backgroundSize: 'cover',
29 |           backgroundPosition: 'center',
30 |           backgroundRepeat: 'no-repeat',
31 |         }}
32 |       >
33 |         <div className="w-full max-w-md bg-white/90 rounded-3xl shadow-lg overflow-hidden">
34 |           <div className="p-8 flex flex-col items-center">
35 |             <div className="p-3 bg-[#F6A5B7]/20 rounded-full mb-6">
36 |               <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
37 |                 <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#F6A5B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
38 |                 <path d="M12 8V12" stroke="#F6A5B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
39 |                 <path d="M12 16H12.01" stroke="#F6A5B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
40 |               </svg>
41 |             </div>
42 | 
43 |             <h1 className="text-2xl font-bold text-[#222] mb-4 text-center">Pago Cancelado</h1>
44 | 
45 |             <p className="text-[#333] text-center mb-4">
46 |               Has cancelado el proceso de pago. No se ha realizado ningún cargo a tu cuenta.
47 |             </p>
48 | 
49 |             <p className="text-[#333] mb-8 text-center">
50 |               Serás redirigido a tu perfil en <span className="font-bold text-[#F6A5B7]">{timeLeft}</span> segundos.
51 |             </p>
52 | 
53 |             <button
54 |               onClick={() => navigate("/profile")}
55 |               className="w-full flex items-center justify-center gap-2 bg-[#BB79D1] hover:bg-[#BB79D1]/90 text-white rounded-full py-4 font-semibold text-lg"
56 |             >
57 |               <ArrowLeft size={20} />
58 |               Volver a mi Perfil
59 |             </button>
60 |           </div>
61 |         </div>
62 |       </div>
63 |     </PageTransition>
64 |   );
65 | }
```

src/pages/PaymentSuccess.tsx
```
1 | import { useEffect, useState } from "react";
2 | import { useLocation, useNavigate } from "react-router-dom";
3 | import { Home } from "lucide-react";
4 | import { motion } from "framer-motion";
5 | import PageTransition from "../components/PageTransition";
6 | 
7 | export default function PaymentSuccess() {
8 |   const location = useLocation();
9 |   const navigate = useNavigate();
10 |   const [sessionId, setSessionId] = useState<string | null>(null);
11 | 
12 |   useEffect(() => {
13 |     // Extraer session_id de la URL
14 |     const queryParams = new URLSearchParams(location.search);
15 |     const sessionIdParam = queryParams.get('session_id');
16 | 
17 |     if (sessionIdParam) {
18 |       console.log("ID de sesión de Stripe:", sessionIdParam);
19 |       setSessionId(sessionIdParam);
20 |     }
21 |   }, [location]);
22 | 
23 |   return (
24 |     <PageTransition>
25 |       <div
26 |         className="min-h-screen flex flex-col items-center justify-center p-6"
27 |         style={{
28 |           backgroundImage: 'url(/fondo_png.png)',
29 |           backgroundSize: 'cover',
30 |           backgroundPosition: 'center',
31 |           backgroundRepeat: 'no-repeat',
32 |         }}
33 |       >
34 |         <div className="w-full max-w-md bg-white/90 rounded-3xl shadow-lg overflow-hidden">
35 |           <div className="p-8 flex flex-col items-center">
36 |             <div className="w-24 h-24 mx-auto rounded-full bg-[#A5D6F6]/20 flex items-center justify-center mb-6">
37 |               <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
38 |                 <path d="M30 5C16.2 5 5 16.2 5 30C5 43.8 16.2 55 30 55C43.8 55 55 43.8 55 30C55 16.2 43.8 5 30 5ZM30 50C18.95 50 10 41.05 10 30C10 18.95 18.95 10 30 10C41.05 10 50 18.95 50 30C50 41.05 41.05 50 30 50ZM42.5 20L27.5 35L20 27.5L16.25 31.25L27.5 42.5L46.25 23.75L42.5 20Z" fill="#A5D6F6" />
39 |               </svg>
40 |             </div>
41 | 
42 |             <h1 className="text-3xl font-bold text-[#222] mb-4">
43 |               ¡Pago Exitoso!
44 |             </h1>
45 | 
46 |             <p className="text-[#333] text-lg mb-12">
47 |               Gracias por tu compra. Tu cuenta se actualizará en breve.
48 |             </p>
49 | 
50 |             <button
51 |               onClick={() => navigate('/home')}
52 |               className="w-full flex items-center justify-center gap-2 bg-[#BB79D1] hover:bg-[#BB79D1]/90 text-white rounded-full py-4 font-semibold text-lg"
53 |             >
54 |               <Home size={20} />
55 |               Volver al inicio
56 |             </button>
57 |           </div>
58 |         </div>
59 |       </div>
60 |     </PageTransition>
61 |   );
62 | }
```

src/pages/PlansPage.tsx
```
1 | import React, { useState, useEffect } from 'react';
2 | import { useNavigate, Link, useLocation } from 'react-router-dom';
3 | import { useUserStore } from '@/store/user/userStore'; // Adjust path if needed
4 | import { supabase } from '@/supabaseClient'; // Adjust path if needed
5 | import { useToast } from '@/hooks/use-toast'; // Adjust path if needed
6 | import PageTransition from '@/components/PageTransition'; // Adjust path if needed
7 | import BackButton from '@/components/BackButton';
8 | import { motion } from 'framer-motion';
9 | import {
10 |     Star,
11 |     BookOpen,
12 |     TrendingUp,
13 |     Mic,
14 |     CheckCircle,
15 |     XCircle,
16 |     ChevronRight,
17 |     ChevronLeft,
18 |     Sparkles,
19 |     CreditCard,
20 |     Settings,
21 |     AlertTriangle,
22 |     Euro
23 | } from 'lucide-react';
24 | 
25 | const PlansPage: React.FC = () => {
26 |     const navigate = useNavigate();
27 |     const location = useLocation();
28 |     const { toast } = useToast();
29 |     const { profileSettings, isPremium } = useUserStore(
30 |         (state) => ({
31 |             profileSettings: state.profileSettings,
32 |             isPremium: state.isPremium,
33 |         })
34 |     );
35 | 
36 |     const [isCheckoutLoading, setIsCheckoutLoading] = useState(false);
37 |     const [isPortalLoading, setIsPortalLoading] = useState(false);
38 |     const [activeTab, setActiveTab] = useState<'comparison' | 'details'>(isPremium() ? 'details' : 'comparison');
39 |     const [activePlan, setActivePlan] = useState<'free' | 'premium'>(isPremium() ? 'premium' : 'free');
40 | 
41 |     // Handle tab query parameter
42 |     useEffect(() => {
43 |         const queryParams = new URLSearchParams(location.search);
44 |         const tabParam = queryParams.get('tab');
45 |         if (tabParam === 'premium') {
46 |             setActivePlan('premium');
47 |         } else if (tabParam === 'free') {
48 |             setActivePlan('free');
49 |         }
50 |     }, [location.search]);
51 | 
52 |     const handleCheckout = async (item: 'premium' | 'credits') => {
53 |         setIsCheckoutLoading(true);
54 |         try {
55 |             const { data, error } = await supabase.functions.invoke('create-checkout-session', {
56 |                 body: JSON.stringify({ item }),
57 |             });
58 | 
59 |             if (error) throw error;
60 | 
61 |             if (data?.url) {
62 |                 window.location.href = data.url;
63 |             } else {
64 |                 throw new Error('No se recibió URL de checkout.');
65 |             }
66 |         } catch (error: Error | unknown) {
67 |             console.error(`Error creating ${item} checkout session:`, error);
68 |             toast({ title: 'Error', description: `No se pudo iniciar el pago: ${error instanceof Error ? error.message : 'Error desconocido'}`, variant: 'destructive' });
69 |             setIsCheckoutLoading(false);
70 |         } // No finally needed as page redirects on success
71 |     };
72 | 
73 |     const handleManageSubscription = async () => {
74 |         if (!profileSettings?.stripe_customer_id) {
75 |             toast({ title: 'Error', description: 'No se encontró información de cliente para gestionar la suscripción.', variant: 'destructive' });
76 |             return;
77 |         }
78 | 
79 |         setIsPortalLoading(true);
80 |         try {
81 |             const { data, error } = await supabase.functions.invoke('create-customer-portal-session');
82 | 
83 |             if (error) throw error;
84 | 
85 |             if (data?.url) {
86 |                 window.location.href = data.url;
87 |             } else {
88 |                 throw new Error('No se recibió URL del portal de cliente.');
89 |             }
90 |         } catch (error: Error | unknown) {
91 |             console.error("Error creating customer portal session:", error);
92 |             toast({ title: 'Error', description: `No se pudo redirigir a la gestión de suscripción: ${error instanceof Error ? error.message : 'Error desconocido'}`, variant: 'destructive' });
93 |             setIsPortalLoading(false);
94 |         } // No finally block needed for isLoading as page redirects on success
95 |     };
96 | 
97 |     const premiumUser = isPremium();
98 | 
99 |     // Define features for comparison table (updated per requirements)
100 |     const features = [
101 |         { name: 'Historias Generadas', free: '10 / mes', premium: 'Ilimitadas', icon: BookOpen, limited: true },
102 |         { name: 'Continuaciones por Historia', free: '1', premium: 'Ilimitadas', icon: TrendingUp, limited: true },
103 |         { name: 'Narración con Voz (IA)', free: 'Si (2 / mes)', premium: 'Sí (20/mes incl.)', icon: Mic, limited: true },
104 |         { name: 'Retos Creativos', free: 'Ilimitados', premium: 'Ilimitados', icon: CheckCircle, limited: false },
105 |     ];
106 | 
107 |     return (
108 |         <PageTransition>
109 |             <div
110 |                 className="relative min-h-screen flex flex-col items-center justify-start p-0"
111 |                 style={{
112 |                     backgroundImage: 'url(/fondo_png.png)',
113 |                     backgroundSize: 'cover',
114 |                     backgroundPosition: 'center',
115 |                     backgroundRepeat: 'no-repeat',
116 |                 }}
117 |             >
118 |                 {/* Logo y cabecera - Reducido espacio */}
119 |                 <div className="flex flex-col items-center mt-4 mb-0 select-none">
120 |                     <img src="/logo_png.png" alt="TaleMe Logo" className="w-60 max-w-xs mx-auto mb-0 drop-shadow-xl" />
121 |                 </div>
122 |                 <div className="container mx-auto px-4 py-0 max-w-4xl">
123 |                     {/* Back button */}
124 |                     <BackButton className="absolute top-8 left-4 md:left-8" />
125 |                     {/* Premium User View */}
126 |                     {premiumUser && (
127 |                         <div className="pt-0 flex flex-col min-h-[80vh] justify-between">
128 |                             <div>
129 |                                 <motion.div
130 |                                     initial={{ opacity: 0, y: -10 }}
131 |                                     animate={{ opacity: 1, y: 0 }}
132 |                                     transition={{ duration: 0.5 }}
133 |                                     className="text-center mb-6"
134 |                                 >
135 |                                     <div className="inline-flex justify-center items-center w-16 h-16 rounded-full bg-[#F9DA60] mb-2">
136 |                                         <Star className="h-8 w-8 text-[#BB79D1]" />
137 |                                     </div>
138 |                                     <h1 className="text-3xl md:text-4xl font-bold mb-2 font-heading text-[#BB79D1]">Plan Premium Activo</h1>
139 |                                     <p className="text-[#7DC4E0] text-lg">Disfruta de todas las funciones sin límites</p>
140 |                                 </motion.div>
141 |                                 <div className="grid md:grid-cols-2 gap-6 mt-8">
142 |                                     {/* Card: Buy Voice Credits */}
143 |                                     <motion.div
144 |                                         initial={{ opacity: 0, y: 20 }}
145 |                                         animate={{ opacity: 1, y: 0 }}
146 |                                         transition={{ duration: 0.5, delay: 0.1 }}
147 |                                         className="bg-white/40 backdrop-blur-md rounded-3xl overflow-hidden shadow-xl border border-[#A5D6F6]/30"
148 |                                     >
149 |                                         <div className="p-6">
150 |                                             <div className="flex items-center gap-3 mb-4">
151 |                                                 <div className="w-10 h-10 rounded-full bg-[#A5D6F6]/40 flex items-center justify-center">
152 |                                                     <Mic className="h-5 w-5 text-[#7DC4E0]" />
153 |                                                 </div>
154 |                                                 <div>
155 |                                                     <h3 className="font-bold text-xl font-heading text-[#BB79D1]">Créditos de Voz</h3>
156 |                                                     <p className="text-[#7DC4E0] text-sm">Amplía tus narraciones</p>
157 |                                                 </div>
158 |                                             </div>
159 |                                             <div className="mb-6">
160 |                                                 <div className="flex justify-between items-center mb-2">
161 |                                                     <span className="text-[#BB79D1]">Disponibles:</span>
162 |                                                     <span className="font-mono font-bold text-lg text-[#7DC4E0]">{profileSettings?.voice_credits || 0}</span>
163 |                                                 </div>
164 |                                                 <div className="h-2 bg-[#E6B7D9]/40 rounded-full overflow-hidden">
165 |                                                     <div className="h-full bg-gradient-to-r from-[#7DC4E0] to-[#BB79D1]"
166 |                                                         style={{ width: `${Math.min(100, ((profileSettings?.voice_credits || 0) / 20) * 100)}%` }}></div>
167 |                                                 </div>
168 |                                             </div>
169 |                                             <button
170 |                                                 onClick={() => handleCheckout('credits')}
171 |                                                 disabled={isCheckoutLoading}
172 |                                                 className="w-full py-3 px-4 bg-[#A5D6F6]/70 border border-[#A5D6F6]/60 hover:bg-[#A5D6F6] text-white rounded-2xl font-medium flex justify-center items-center gap-2 shadow-lg transform transition-transform duration-200 hover:scale-[1.02] active:scale-[0.98]"
173 |                                             >
174 |                                                 {isCheckoutLoading ? (
175 |                                                     <div className="h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
176 |                                                 ) : (
177 |                                                     <>
178 |                                                         <CreditCard className="h-4 w-4" />
179 |                                                         <span>Comprar Créditos</span>
180 |                                                     </>
181 |                                                 )}
182 |                                             </button>
183 |                                         </div>
184 |                                     </motion.div>
185 |                                     {/* Card: Manage Subscription */}
186 |                                     <motion.div
187 |                                         initial={{ opacity: 0, y: 20 }}
188 |                                         animate={{ opacity: 1, y: 0 }}
189 |                                         transition={{ duration: 0.5, delay: 0.2 }}
190 |                                         className="bg-white/40 backdrop-blur-md rounded-3xl overflow-hidden shadow-xl border border-[#F9DA60]/30"
191 |                                     >
192 |                                         <div className="p-6">
193 |                                             <div className="flex items-center gap-3 mb-4">
194 |                                                 <div className="w-10 h-10 rounded-full bg-[#F9DA60]/40 flex items-center justify-center">
195 |                                                     <Star className="h-5 w-5 text-[#F9DA60]" />
196 |                                                 </div>
197 |                                                 <div>
198 |                                                     <h3 className="font-bold text-xl font-heading text-[#BB79D1]">Suscripción Premium</h3>
199 |                                                     <p className="text-[#7DC4E0] text-sm">Administra tu plan</p>
200 |                                                 </div>
201 |                                             </div>
202 |                                             <div className="space-y-4 mb-6">
203 |                                                 <div className="bg-white/70 rounded-lg p-3 flex justify-between items-center border border-[#F9DA60]/30">
204 |                                                     <span className="text-[#222] font-medium">Estado:</span>
205 |                                                     <span className="font-bold text-[#F9DA60] bg-[#F9DA60]/20 px-3 py-1 rounded-full border border-[#F9DA60]/30">Activo</span>
206 |                                                 </div>
207 |                                                 <div className="bg-[#F6A5B7]/10 rounded-lg p-3 flex justify-between items-center">
208 |                                                     <span className="text-[#BB79D1]">Beneficios:</span>
209 |                                                     <span className="font-medium text-[#BB79D1]">Todos los incluidos</span>
210 |                                                 </div>
211 |                                             </div>
212 |                                             <button
213 |                                                 onClick={handleManageSubscription}
214 |                                                 disabled={isPortalLoading}
215 |                                                 className="flex items-center justify-between w-full py-3 px-4 bg-[#F9DA60]/60 border border-[#F9DA60]/40 hover:bg-[#F9DA60]/80 text-[#BB79D1] rounded-2xl font-medium transition-all shadow-md hover:shadow-lg"
216 |                                             >
217 |                                                 <div className="flex items-center gap-2">
218 |                                                     <Settings className="h-4 w-4" />
219 |                                                     <span>Gestionar Suscripción</span>
220 |                                                 </div>
221 |                                                 {isPortalLoading ? (
222 |                                                     <div className="h-4 w-4 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin"></div>
223 |                                                 ) : (
224 |                                                     <ChevronRight className="h-4 w-4" />
225 |                                                 )}
226 |                                             </button>
227 |                                         </div>
228 |                                     </motion.div>
229 |                                 </div>
230 |                                 {/* Bottom Premium Features Reminder */}
231 |                                 <motion.div
232 |                                     initial={{ opacity: 0, y: 20 }}
233 |                                     animate={{ opacity: 1, y: 0 }}
234 |                                     transition={{ duration: 0.5, delay: 0.3 }}
235 |                                     className="mt-8 bg-white/60 backdrop-blur-md rounded-3xl p-5 border border-[#F9DA60]/40 shadow-lg"
236 |                                 >
237 |                                     <h3 className="font-bold text-xl mb-4 flex items-center gap-2 font-heading text-[#BB79D1]">
238 |                                         <Sparkles className="h-6 w-6 text-[#F9DA60]" />
239 |                                         <span>Beneficios Premium Activos</span>
240 |                                     </h3>
241 |                                     <ul className="grid grid-cols-1 md:grid-cols-2 gap-4">
242 |                                         {features.map((feature, i) => (
243 |                                             <li key={i} className="flex items-center gap-3 bg-white/70 p-3 rounded-xl border border-[#BB79D1]/10 shadow-sm">
244 |                                                 <CheckCircle className="h-6 w-6 text-green-500 flex-shrink-0" />
245 |                                                 <div>
246 |                                                     <div className="flex items-center gap-2">
247 |                                                         <feature.icon className="h-4 w-4 text-[#7DC4E0]" />
248 |                                                         <span className="font-bold text-[#222]">{feature.name}</span>
249 |                                                     </div>
250 |                                                     <span className="text-sm font-medium text-[#BB79D1]">{feature.premium}</span>
251 |                                                 </div>
252 |                                             </li>
253 |                                         ))}
254 |                                     </ul>
255 |                                 </motion.div>
256 |                                 {/* Botón para ir a la app */}
257 |                                 <motion.div
258 |                                     initial={{ opacity: 0 }}
259 |                                     animate={{ opacity: 1 }}
260 |                                     transition={{ duration: 0.5, delay: 0.4 }}
261 |                                     className="mt-8 mb-14 text-center"
262 |                                 >
263 |                                     <Link
264 |                                         to="/home"
265 |                                         className="inline-block py-3 px-6 bg-[#BB79D1] hover:bg-[#A37AC2] text-white rounded-2xl font-medium flex items-center justify-center gap-2 shadow-lg transform transition-transform duration-200 hover:scale-[1.02] active:scale-[0.98] mx-auto"
266 |                                     >
267 |                                         <BookOpen className="h-5 w-5" />
268 |                                         <span>Ir a la aplicación</span>
269 |                                     </Link>
270 |                                 </motion.div>
271 |                             </div>
272 |                         </div>
273 |                     )}
274 |                     {/* Free User View */}
275 |                     {!premiumUser && (
276 |                         <div className="pt-0 flex flex-col min-h-[80vh] justify-between">
277 |                             <div>
278 |                                 {/* Header */}
279 |                                 <motion.div
280 |                                     initial={{ opacity: 0, y: -10 }}
281 |                                     animate={{ opacity: 1, y: 0 }}
282 |                                     transition={{ duration: 0.5 }}
283 |                                     className="text-center mb-4"
284 |                                 >
285 |                                     <h1 className="text-3xl md:text-4xl font-bold mb-1 font-heading text-[#BB79D1]">Desbloquea tu Creatividad</h1>
286 |                                     <p className="text-[#7DC4E0] text-lg mx-auto max-w-xl">
287 |                                         Compara los planes y elige la mejor experiencia para tus historias
288 |                                     </p>
289 |                                 </motion.div>
290 |                                 {/* Plan Toggle */}
291 |                                 <div className="flex justify-center mb-4">
292 |                                     <motion.div
293 |                                         initial={{ opacity: 0, y: 10 }}
294 |                                         animate={{ opacity: 1, y: 0 }}
295 |                                         transition={{ duration: 0.5, delay: 0.1 }}
296 |                                         className="bg-white/40 backdrop-blur-md rounded-full p-1 inline-flex"
297 |                                     >
298 |                                         <button
299 |                                             onClick={() => setActivePlan('free')}
300 |                                             className={`py-2 px-5 md:px-8 rounded-full transition-colors flex items-center gap-2 ${activePlan === 'free'
301 |                                                 ? 'bg-[#F6A5B7]/60 text-white font-medium'
302 |                                                 : 'text-[#BB79D1] hover:text-white'
303 |                                                 }`}
304 |                                         >
305 |                                             <span>Free</span>
306 |                                         </button>
307 |                                         <button
308 |                                             onClick={() => setActivePlan('premium')}
309 |                                             className={`py-2 px-5 md:px-8 rounded-full transition-colors flex items-center gap-2 relative ${activePlan === 'premium'
310 |                                                 ? 'bg-gradient-to-r from-[#F9DA60] to-[#F9DA60]/80 text-white font-medium'
311 |                                                 : 'text-[#BB79D1] hover:text-white'
312 |                                                 }`}
313 |                                         >
314 |                                             <Star className="h-4 w-4" />
315 |                                             <span>Premium</span>
316 |                                             <span className="absolute -top-2 -right-2 bg-[#F6A5B7] text-white text-xs font-bold py-0.5 px-2 rounded-full shadow-md">Próximamente</span>
317 |                                         </button>
318 |                                     </motion.div>
319 |                                 </div>
320 |                                 {/* Features by Plan */}
321 |                                 <motion.div
322 |                                     initial={{ opacity: 0, y: 20 }}
323 |                                     animate={{ opacity: 1, y: 0 }}
324 |                                     transition={{ duration: 0.5, delay: 0.2 }}
325 |                                     className="max-w-2xl mx-auto"
326 |                                 >
327 |                                     {/* Active Plan Card */}
328 |                                     <div className="bg-white/70 backdrop-blur-md rounded-3xl overflow-hidden shadow-xl border border-[#BB79D1]/20 mb-6">
329 |                                         {/* Plan Header - Mejorada legibilidad */}
330 |                                         <div className={`p-6 ${activePlan === 'premium'
331 |                                             ? 'bg-[#F9DA60]/20 border-b border-[#F9DA60]/40'
332 |                                             : 'bg-[#F6A5B7]/20 border-b border-[#BB79D1]/20'
333 |                                             }`}>
334 |                                             <div className="flex justify-between items-center">
335 |                                                 <h2 className="text-2xl font-bold flex items-center gap-2 font-heading text-[#BB79D1]">
336 |                                                     {activePlan === 'premium' && <Star className="h-5 w-5 text-[#F9DA60]" />}
337 |                                                     Plan {activePlan === 'premium' ? 'Premium' : 'Free'}
338 |                                                 </h2>
339 |                                                 {activePlan === 'premium' && (
340 |                                                     <span className="bg-[#F6A5B7] text-white px-3 py-1 rounded-full text-sm font-bold">
341 |                                                         Próximamente
342 |                                                     </span>
343 |                                                 )}
344 |                                             </div>
345 |                                             {activePlan === 'premium' ? (
346 |                                                 <>
347 |                                                     <p className="text-[#BB79D1] mt-1 font-medium">Creatividad sin límites para tus historias</p>
348 |                                                     <div className="flex items-center mt-3 bg-white/70 p-3 rounded-xl justify-between border border-[#F9DA60]">
349 |                                                         <div className="flex items-center gap-2">
350 |                                                             <Euro className="h-5 w-5 text-[#F9DA60]" />
351 |                                                             <span className="text-[#222] font-medium">Precio:</span>
352 |                                                         </div>
353 |                                                         <div className="font-bold text-xl text-[#BB79D1] flex items-center gap-1">
354 |                                                             <span>10€</span>
355 |                                                             <span className="text-sm font-normal text-[#222] opacity-80">/mes</span>
356 |                                                         </div>
357 |                                                     </div>
358 |                                                 </>
359 |                                             ) : (
360 |                                                 <p className="text-[#7DC4E0] mt-1">Perfecto para comenzar a explorar</p>
361 |                                             )}
362 |                                         </div>
363 | 
364 |                                         {/* Premium "Hazte Premium" button - Only shown on premium tab */}
365 |                                         {activePlan === 'premium' && (
366 |                                             <div className="p-6 pt-4 pb-0">
367 |                                                 <button
368 |                                                     disabled={true}
369 |                                                     className="w-full py-3 px-6 bg-gradient-to-r from-[#F9DA60]/60 to-[#F9DA60]/40 text-[#BB79D1] rounded-2xl font-bold flex justify-center items-center gap-2 shadow-lg cursor-not-allowed relative overflow-hidden"
370 |                                                 >
371 |                                                     <Star className="h-5 w-5" />
372 |                                                     <span>Hazte Premium Ahora</span>
373 |                                                 </button>
374 |                                                 <p className="text-center text-sm text-[#BB79D1] mt-3 font-medium">Estamos trabajando para ofrecerte esta opción muy pronto</p>
375 |                                             </div>
376 |                                         )}
377 | 
378 |                                         {/* Features List - Consistent style for both tabs */}
379 |                                         <div className="p-6">
380 |                                             <h3 className="font-bold text-lg mb-4 flex items-center gap-2 font-heading text-[#BB79D1]">
381 |                                                 <Sparkles className="h-5 w-5 text-[#F9DA60]" />
382 |                                                 <span>{activePlan === 'premium' ? 'Beneficios Premium' : 'Características del plan'}</span>
383 |                                             </h3>
384 | 
385 |                                             <ul className="space-y-3">
386 |                                                 {features.map((feature, index) => (
387 |                                                     <li key={index} className="bg-white/60 p-3 rounded-lg border border-[#BB79D1]/10 shadow-sm">
388 |                                                         <div className="flex items-center gap-3">
389 |                                                             <div className="flex-shrink-0">
390 |                                                                 {activePlan === 'premium' ? (
391 |                                                                     feature.premium === 'No' ? (
392 |                                                                         <XCircle className="h-5 w-5 text-red-400" />
393 |                                                                     ) : (
394 |                                                                         <CheckCircle className="h-5 w-5 text-green-500" />
395 |                                                                     )
396 |                                                                 ) : (
397 |                                                                     feature.free === 'No' ? (
398 |                                                                         <XCircle className="h-5 w-5 text-red-400" />
399 |                                                                     ) : (
400 |                                                                         feature.limited ? (
401 |                                                                             <AlertTriangle className="h-5 w-5 text-[#F9DA60]" />
402 |                                                                         ) : (
403 |                                                                             <CheckCircle className="h-5 w-5 text-green-500" />
404 |                                                                         )
405 |                                                                     )
406 |                                                                 )}
407 |                                                             </div>
408 |                                                             <div>
409 |                                                                 <div className="flex items-center gap-2">
410 |                                                                     <feature.icon className="h-4 w-4 text-[#7DC4E0]" />
411 |                                                                     <span className="font-bold text-[#222]">{feature.name}</span>
412 |                                                                 </div>
413 |                                                                 <div className="text-sm font-medium text-[#444]">
414 |                                                                     {activePlan === 'premium' ? feature.premium : feature.free}
415 |                                                                     {activePlan === 'free' && feature.limited && (
416 |                                                                         <span className="text-xs text-[#BB79D1] ml-1 font-bold">(limitado)</span>
417 |                                                                     )}
418 |                                                                 </div>
419 |                                                             </div>
420 |                                                         </div>
421 |                                                     </li>
422 |                                                 ))}
423 |                                             </ul>
424 |                                         </div>
425 |                                     </div>
426 |                                 </motion.div>
427 |                             </div>
428 |                             {/* Botones de navegación entre planes - Con espacio abajo */}
429 |                             <div className="flex flex-col md:flex-row justify-center gap-4 mb-10">
430 |                                 {activePlan === 'free' && (
431 |                                     <button
432 |                                         onClick={() => setActivePlan('premium')}
433 |                                         className="py-3 px-8 bg-gradient-to-r from-[#F6A5B7] to-[#BB79D1] text-white rounded-2xl font-bold shadow-lg flex items-center gap-2 transition-all duration-200 hover:scale-105 hover:bg-[#BB79D1]/90"
434 |                                     >
435 |                                         <Star className="h-5 w-5" />
436 |                                         <span>Ver plan Premium</span>
437 |                                         <ChevronRight className="h-4 w-4" />
438 |                                     </button>
439 |                                 )}
440 |                                 {activePlan === 'premium' && (
441 |                                     <button
442 |                                         onClick={() => setActivePlan('free')}
443 |                                         className="py-3 px-8 bg-[#A5D6F6]/70 text-[#BB79D1] rounded-2xl font-bold shadow-lg flex items-center gap-2 transition-all duration-200 hover:scale-105 hover:bg-[#BB79D1]/20"
444 |                                     >
445 |                                         <ChevronLeft className="h-4 w-4" />
446 |                                         <span>Ver plan Free</span>
447 |                                     </button>
448 |                                 )}
449 |                                 {/* Botón para continuar gratis */}
450 |                                 {activePlan === 'free' && (
451 |                                     <Link
452 |                                         to="/home"
453 |                                         className="py-3 px-8 bg-transparent border border-[#BB79D1]/50 hover:bg-[#BB79D1]/10 text-[#BB79D1] rounded-2xl font-bold transition-all shadow-sm hover:shadow-md flex items-center gap-2"
454 |                                     >
455 |                                         Continuar con el plan gratuito
456 |                                     </Link>
457 |                                 )}
458 |                             </div>
459 |                         </div>
460 |                     )}
461 |                 </div>
462 |             </div>
463 |         </PageTransition>
464 |     );
465 | };
466 | 
467 | export default PlansPage;
```

src/pages/PrivacyPolicy.tsx
```
1 | import React from 'react';
2 | import { useNavigate } from 'react-router-dom';
3 | import { Button } from "@/components/ui/button";
4 | import PageTransition from "../components/PageTransition";
5 | 
6 | const PrivacyPolicy: React.FC = () => {
7 |   const navigate = useNavigate();
8 | 
9 |   return (
10 |     <PageTransition>
11 |       <div 
12 |         className="min-h-screen flex flex-col"
13 |         style={{
14 |           backgroundImage: 'url(/fondo_png.png)',
15 |           backgroundSize: 'cover',
16 |           backgroundPosition: 'center',
17 |           backgroundRepeat: 'no-repeat',
18 |         }}
19 |       >
20 |         <div className="container mx-auto py-8 px-4 flex-1 overflow-auto">
21 |           <div className="max-w-4xl mx-auto">
22 |             <div className="text-center mb-6">
23 |               <h1 className="text-3xl font-bold text-[#222]">POLÍTICA DE PRIVACIDAD DE TaleMe!</h1>
24 |               <p className="text-sm text-[#555] mt-2">Última actualización: 23 de abril de 2025</p>
25 |             </div>
26 | 
27 |             <div className="space-y-6 bg-white/80 p-8 rounded-2xl backdrop-blur-sm shadow-lg">
28 |               <p className="font-medium">
29 |                 Resumen de privacidad: En TaleMe! valoramos tu confianza y nos comprometemos a proteger tus datos personales. Recopilamos únicamente la información imprescindible para ofrecerte nuestro servicio de generación de cuentos infantiles con Inteligencia Artificial, la almacenamos bajo estrictas medidas de seguridad y te damos control absoluto sobre su uso. A continuación, te explicamos de forma clara y transparente cómo tratamos tus datos.
30 |               </p>
31 | 
32 |               <div>
33 |                 <h2 className="text-xl font-bold text-[#BB79D1]">1. RESPONSABLE DEL TRATAMIENTO</h2>
34 |                 <p className="mt-2">
35 |                   TaleMe! (en adelante, "TaleMe!"), con domicilio en Zaragoza, España, y correo electrónico de contacto hola@taleme.app, es la entidad responsable del tratamiento de tus datos personales cuando utilizas la plataforma TaleMe!.
36 |                 </p>
37 |               </div>
38 | 
39 |               <div>
40 |                 <h2 className="text-xl font-bold text-[#BB79D1]">2. ¿QUÉ DATOS RECOPILAMOS Y POR QUÉ?</h2>
41 |                 <p className="mt-2 font-medium">2.1 Datos facilitados por el Usuario</p>
42 |                 <p className="mt-2">
43 |                   Registro: nombre, dirección de correo electrónico, contraseña.
44 |                 </p>
45 |                 <p className="mt-2">
46 |                   Perfil y preferencias: edad del niño o niña, temas favoritos, idioma y estilo de cuento.
47 |                 </p>
48 |                 <p className="mt-2">
49 |                   Comunicación: mensajes o consultas que envíes a través de nuestro formulario o correo.
50 |                 </p>
51 |                 
52 |                 <p className="mt-4 font-medium">2.2 Datos técnicos y de uso</p>
53 |                 <p className="mt-2">
54 |                   Dirección IP, tipo de navegador, dispositivo, sistema operativo.
55 |                 </p>
56 |                 <p className="mt-2">
57 |                   Páginas visitadas, duración de la sesión, acciones realizadas (generación, edición, descarga de cuentos).
58 |                 </p>
59 |                 <p className="mt-2">
60 |                   Cookies y tecnologías similares para mejorar la experiencia y personalizar contenidos.
61 |                 </p>
62 |               </div>
63 | 
64 |               <div>
65 |                 <h2 className="text-xl font-bold text-[#BB79D1]">3. FINALIDADES DEL TRATAMIENTO</h2>
66 |                 <p className="mt-2">
67 |                   Utilizamos tus datos para:
68 |                 </p>
69 |                 <p className="mt-2">
70 |                   Gestionar tu cuenta y acceso a TaleMe!.
71 |                 </p>
72 |                 <p className="mt-2">
73 |                   Generar, guardar y entregar por email los cuentos infantiles que solicites.
74 |                 </p>
75 |                 <p className="mt-2">
76 |                   Enviar notificaciones por correo electrónico sobre el estado de tus creaciones, novedades y mejoras de la plataforma.
77 |                 </p>
78 |                 <p className="mt-2">
79 |                   Prestar soporte técnico y atención al cliente.
80 |                 </p>
81 |                 <p className="mt-2">
82 |                   Cumplir con obligaciones legales y de seguridad.
83 |                 </p>
84 |               </div>
85 | 
86 |               <div>
87 |                 <h2 className="text-xl font-bold text-[#BB79D1]">4. COOKIES Y TECNOLOGÍAS SIMILARES</h2>
88 |                 <p className="mt-2">
89 |                   Para optimizar tu experiencia y analizar el uso de TaleMe!, empleamos cookies propias y de terceros. Puedes gestionar o desactivar las cookies desde la configuración de tu navegador; ten en cuenta que ello podría afectar la funcionalidad del servicio. Consulta nuestra Política de Cookies para más información.
90 |                 </p>
91 |               </div>
92 | 
93 |               <div>
94 |                 <h2 className="text-xl font-bold text-[#BB79D1]">5. SEGURIDAD DE TUS DATOS</h2>
95 |                 <p className="mt-2">
96 |                   Implementamos medidas técnicas y organizativas (cifrado HTTPS, controles de acceso, backups) para proteger tus datos contra accesos no autorizados, alteraciones o pérdida. Recomendamos cerrar sesión cuando uses dispositivos compartidos y mantener tu contraseña en un lugar seguro.
97 |                 </p>
98 |               </div>
99 | 
100 |               <div>
101 |                 <h2 className="text-xl font-bold text-[#BB79D1]">6. ENLACES A TERCEROS</h2>
102 |                 <p className="mt-2">
103 |                   TaleMe! puede incluir enlaces a sitios web o servicios de terceros. No somos responsables de las prácticas de privacidad ni del contenido de estas webs externas, por lo que te aconsejamos leer sus propias políticas de privacidad.
104 |                 </p>
105 |               </div>
106 | 
107 |               <div>
108 |                 <h2 className="text-xl font-bold text-[#BB79D1]">7. TUS DERECHOS Y CÓMO EJERCERLOS</h2>
109 |                 <p className="mt-2">
110 |                   Tienes derecho a:
111 |                 </p>
112 |                 <p className="mt-2">
113 |                   Acceder a tus datos personales.
114 |                 </p>
115 |                 <p className="mt-2">
116 |                   Rectificar datos inexactos o incompletos.
117 |                 </p>
118 |                 <p className="mt-2">
119 |                   Eliminar tus datos (derecho al olvido).
120 |                 </p>
121 |                 <p className="mt-2">
122 |                   Limitar u oponerte a ciertos tratamientos.
123 |                 </p>
124 |                 <p className="mt-2">
125 |                   Portabilidad de tus datos.
126 |                 </p>
127 |                 <p className="mt-2">
128 |                   Retirar tu consentimiento en cualquier momento, sin que ello afecte la licitud del tratamiento previo.
129 |                 </p>
130 |                 <p className="mt-4">
131 |                   Para ejercerlos, puedes:
132 |                 </p>
133 |                 <p className="mt-2">
134 |                   Acceder a tu perfil y modificar tus datos.
135 |                 </p>
136 |                 <p className="mt-2">
137 |                   Enviar un email a hola@taleme.app con asunto "Protección de Datos" e indicando claramente qué derecho deseas ejercer.
138 |                 </p>
139 |               </div>
140 | 
141 |               <div>
142 |                 <h2 className="text-xl font-bold text-[#BB79D1]">8. USO DEL SERVICIO POR MENORES</h2>
143 |                 <p className="mt-2">
144 |                   TaleMe! está pensado para la creación de cuentos infantiles a iniciativa de un adulto responsable. Los menores de 14 años deberán contar con el consentimiento de su padre, madre o tutor legal para la recogida y tratamiento de sus datos.
145 |                 </p>
146 |               </div>
147 | 
148 |               <div>
149 |                 <h2 className="text-xl font-bold text-[#BB79D1]">9. CONSERVACIÓN DE LOS DATOS</h2>
150 |                 <p className="mt-2">
151 |                   Conservaremos tus datos mientras mantengas una cuenta activa en TaleMe! y, una vez cancelada, durante el tiempo necesario para cumplir con obligaciones legales (p. ej., fiscales), salvo que solicites su supresión antes.
152 |                 </p>
153 |               </div>
154 | 
155 |               <div>
156 |                 <h2 className="text-xl font-bold text-[#BB79D1]">10. CAMBIOS EN ESTA POLÍTICA</h2>
157 |                 <p className="mt-2">
158 |                   Podemos actualizar esta Política de Privacidad para adaptarla a novedades legales o mejoras de servicio. Te informaremos de los cambios relevantes a través de un aviso en la plataforma o por correo electrónico antes de que entren en vigor.
159 |                 </p>
160 |               </div>
161 | 
162 |               <div>
163 |                 <h2 className="text-xl font-bold text-[#BB79D1]">11. CONTACTO Y RECLAMACIONES</h2>
164 |                 <p className="mt-2">
165 |                   Si tienes dudas, consultas o reclamaciones sobre el tratamiento de tus datos, puedes escribirnos a hola@taleme.app. También tienes derecho a presentar una reclamación ante la Agencia Española de Protección de Datos si consideras que tus derechos no se han atendido correctamente.
166 |                 </p>
167 |               </div>
168 | 
169 |               <p className="italic">
170 |                 Gracias por confiar en TaleMe! Tu privacidad y la de los más pequeños son nuestra máxima prioridad.
171 |               </p>
172 |             </div>
173 |             
174 |             <div className="flex justify-center mt-6">
175 |               <Button 
176 |                 variant="default" 
177 |                 onClick={() => navigate(-1)}
178 |                 className="min-w-32"
179 |               >
180 |                 Volver
181 |               </Button>
182 |             </div>
183 |           </div>
184 |         </div>
185 |       </div>
186 |     </PageTransition>
187 |   );
188 | };
189 | 
190 | export default PrivacyPolicy; 
```

src/pages/ProfileConfigPage.tsx
```
1 | import React, { useState, useEffect } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { Check, Globe, User, Languages, Calendar, Heart } from "lucide-react";
4 | import { motion } from "framer-motion";
5 | 
6 | // Importaciones del Store y tipos
7 | import { useUserStore } from "@/store/user/userStore";
8 | import { ProfileSettings } from "@/types";
9 | import { supabase } from "@/supabaseClient";
10 | 
11 | // Componentes UI y Hooks
12 | import BackButton from "@/components/BackButton";
13 | import PageTransition from "@/components/PageTransition";
14 | import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
15 | import { Slider } from "@/components/ui/slider";
16 | import { useToast } from "@/hooks/use-toast";
17 | 
18 | const ProfileConfigPage: React.FC = () => {
19 |     const navigate = useNavigate();
20 |     const { profileSettings: storeProfileSettings, setProfileSettings, user, hasCompletedProfile } = useUserStore();
21 |     const { toast } = useToast();
22 | 
23 |     // Estado Local del Formulario
24 |     const [language, setLanguage] = useState("Español");
25 |     const [childAge, setChildAge] = useState(5);
26 |     const [specialNeed, setSpecialNeed] = useState("Ninguna");
27 |     const [isLoading, setIsLoading] = useState(false); // Let useEffect manage loading state
28 |     const [isSaving, setIsSaving] = useState(false);
29 | 
30 |     // Definiciones de idiomas y necesidades especiales (Moved up for use in Trigger)
31 |     const languages = [
32 |         { value: "Español", label: "Español", flag: "🇪🇸" },
33 |         { value: "Inglés", label: "Inglés", flag: "🇬🇧" },
34 |         { value: "Francés", label: "Francés", flag: "🇫🇷" },
35 |         { value: "Alemán", label: "Alemán", flag: "🇩🇪" },
36 |         { value: "Italiano", label: "Italiano", flag: "🇮🇹" }
37 |     ];
38 | 
39 |     const specialNeeds = [
40 |         { value: "Ninguna", label: "Ninguna" },
41 |         { value: "TEA", label: "Trastorno del Espectro Autista (TEA)" },
42 |         { value: "TDAH", label: "Déficit de Atención e Hiperactividad (TDAH)" },
43 |         { value: "Dislexia", label: "Dislexia o Dificultad en Lectura" },
44 |         { value: "Ansiedad", label: "Ansiedad o Miedos Específicos" },
45 |         { value: "Down", label: "Síndrome de Down" },
46 |         { value: "Comprension", label: "Dificultades de Comprensión Auditiva o Lingüística" }
47 |     ];
48 | 
49 |     // Efecto para cargar datos iniciales del perfil
50 |     useEffect(() => {
51 |         setIsLoading(true);
52 |         const profileComplete = hasCompletedProfile(); // Check completion status first
53 | 
54 |         if (profileComplete && storeProfileSettings) {
55 |             // Profile is complete, use stored settings (with fallback just in case)
56 |             console.log("ProfileConfigPage: Profile complete, using store data:", storeProfileSettings);
57 |             setLanguage(storeProfileSettings.language || "Español");
58 |             setChildAge(storeProfileSettings.childAge || 5);
59 |             setSpecialNeed(storeProfileSettings.specialNeed || "Ninguna");
60 |         } else if (user) {
61 |             // Profile NOT complete (or store settings missing), OR user exists but profile status unknown yet. Set defaults.
62 |             console.log(`ProfileConfigPage: Profile incomplete or store settings missing (Complete: ${profileComplete}). Using defaults.`);
63 |             setLanguage("Español");
64 |             setChildAge(5);
65 |             setSpecialNeed("Ninguna");
66 |         } else {
67 |             // Waiting for user data
68 |             console.log("ProfileConfigPage: Waiting for user data...");
69 |         }
70 |         setIsLoading(false); // Set loading false after logic runs
71 | 
72 |     // Dependencies: user, storeProfileSettings, and hasCompletedProfile function reference
73 |     }, [user, storeProfileSettings, hasCompletedProfile]);
74 | 
75 |     // Find the selected language object for display in Trigger
76 |     const selectedLang = languages.find(l => l.value === language);
77 | 
78 |     // Manejador del envío del formulario
79 |     const handleSubmit = async (e: React.FormEvent) => {
80 |         e.preventDefault();
81 |         if (!user) {
82 |             toast({
83 |                 title: "Error",
84 |                 description: "Debes estar autenticado para guardar el perfil.",
85 |                 variant: "destructive",
86 |             });
87 |             return;
88 |         }
89 | 
90 |         const wasSetupAlreadyComplete = hasCompletedProfile();
91 | 
92 |         const profileDataToSave: Partial<ProfileSettings> = {
93 |             language,
94 |             childAge,
95 |             specialNeed: specialNeed === "Ninguna" ? undefined : specialNeed,
96 |         };
97 | 
98 |         setIsSaving(true);
99 |         try {
100 |             // 1. Guardar los settings editables a través del store Y marcar como completado LOCALMENTE
101 |             const finalSettingsToSave = {
102 |                 ...profileDataToSave, // language, age, needs
103 |                 has_completed_setup: true // <<<--- AÑADIDO EXPLICITAMENTE
104 |             };
105 |             await setProfileSettings(finalSettingsToSave);
106 | 
107 |             // 2. Marcar setup como completado en la BD (redundante pero seguro)
108 |             const { error: updateError } = await supabase
109 |                 .from('profiles')
110 |                 .update({ has_completed_setup: true })
111 |                 .eq('id', user.id);
112 | 
113 |             if (updateError) {
114 |                 console.error('Error al marcar perfil como completado:', updateError);
115 |                 toast({
116 |                     title: "Error parcial",
117 |                     description: "Se guardó el perfil, pero hubo un problema al marcar el setup como completado.",
118 |                     variant: "destructive",
119 |                 });
120 |                 // Considerar si detener el flujo aquí
121 |             } else {
122 |                 // <<<--- MODIFICADO: Conditional Navigation & Toast --- */
123 |                 const nextPath = wasSetupAlreadyComplete ? "/home" : "/plans";
124 |                 const successDescription = wasSetupAlreadyComplete
125 |                     ? "Tu configuración ha sido guardada."
126 |                     : "Tu configuración ha sido guardada. ¡Vamos a elegir un plan!";
127 | 
128 |                 toast({
129 |                     title: "¡Perfil actualizado!",
130 |                     description: successDescription,
131 |                 });
132 |                 navigate(nextPath);
133 |                 // <<<--- FIN MODIFICADO --- */
134 |             }
135 |             // --- FIN AÑADIDO ---
136 | 
137 |         } catch (err) {
138 |             console.error("Error en handleSubmit al llamar a setProfileSettings:", err);
139 |             let errorDesc = "Ha ocurrido un error inesperado al guardar tu perfil.";
140 |             if (err instanceof Error) {
141 |                 errorDesc = `Error: ${err.message}`;
142 |             }
143 |             toast({
144 |                 title: "Error al guardar",
145 |                 description: errorDesc,
146 |                 variant: "destructive",
147 |             });
148 |         } finally {
149 |             setIsSaving(false);
150 |         }
151 |     };
152 | 
153 |     return (
154 |         <PageTransition>
155 |             <div
156 |                 className="min-h-screen flex flex-col items-center justify-start relative"
157 |                 style={{
158 |                     backgroundImage: "url(/fondo_png.png)",
159 |                     backgroundSize: "cover",
160 |                     backgroundPosition: "center",
161 |                     backgroundRepeat: "no-repeat",
162 |                 }}
163 |             >
164 |                 <div className="container mx-auto px-4 py-8 max-w-2xl">
165 |                     {/* Back button */}
166 |                     <BackButton className="absolute top-8 left-4 md:left-8" />
167 | 
168 |                     {/* Header */}
169 |                     <motion.div
170 |                         initial={{ opacity: 0, y: -10 }}
171 |                         animate={{ opacity: 1, y: 0 }}
172 |                         transition={{ duration: 0.5 }}
173 |                         className="pt-16 text-center mb-8"
174 |                     >
175 |                         <div className="inline-flex justify-center items-center w-16 h-16 rounded-full bg-[#A5D6F6]/80 border border-[#A5D6F6]/50 mb-4 shadow-lg">
176 |                             <User className="h-8 w-8 text-white" />
177 |                         </div>
178 |                         <h1 className="text-3xl font-bold mb-2 font-heading text-[#BB79D1]">Configura tu Perfil</h1>
179 |                         <p className="text-[#222] text-md max-w-md mx-auto font-medium bg-white/60 rounded-xl px-4 py-2 shadow-sm">
180 |                             Personaliza la experiencia para adaptar las historias a tus preferencias
181 |                         </p>
182 |                     </motion.div>
183 | 
184 |                     {isLoading && (
185 |                         <div className="flex justify-center py-12">
186 |                             <div className="rounded-full h-12 w-12 border-4 border-[#A5D6F6] border-t-transparent animate-spin"></div>
187 |                         </div>
188 |                     )}
189 | 
190 |                     {!isLoading && user && (
191 |                         <motion.form
192 |                             initial={{ opacity: 0, y: 20 }}
193 |                             animate={{ opacity: 1, y: 0 }}
194 |                             transition={{ duration: 0.5, delay: 0.1 }}
195 |                             onSubmit={handleSubmit}
196 |                             className="space-y-8 bg-white/40 backdrop-blur-md rounded-3xl border border-[#BB79D1]/20 shadow-xl p-6"
197 |                         >
198 |                             {/* Language Select */}
199 |                             <div className="space-y-2">
200 |                                 <label htmlFor="language" className="flex items-center gap-2 text-lg font-medium mb-2 font-heading text-[#222]">
201 |                                     <div className="w-8 h-8 rounded-full bg-[#A5D6F6]/20 flex items-center justify-center">
202 |                                         <Languages className="h-4 w-4 text-[#A5D6F6]" />
203 |                                     </div>
204 |                                     <span>Idioma de la Historia</span>
205 |                                 </label>
206 | 
207 |                                 <Select value={language} onValueChange={setLanguage}>
208 |                                     <SelectTrigger className="w-full bg-white/10 border-[#A5D6F6]/30 backdrop-blur-sm text-[#222] hover:bg-white/20 transition-colors h-12">
209 |                                         {/* --- MODIFICATION START --- */}
210 |                                         {/* Render flag and label directly if language is selected */}
211 |                                         {selectedLang ? (
212 |                                             <div className="flex items-center">
213 |                                                 <span role="img" aria-label={selectedLang.label} className="mr-2">{selectedLang.flag}</span>
214 |                                                 {selectedLang.label}
215 |                                             </div>
216 |                                         ) : (
217 |                                             /* Fallback to placeholder if no language (shouldn't happen) */
218 |                                             <SelectValue placeholder="Selecciona un idioma..." />
219 |                                         )}
220 |                                         {/* --- MODIFICATION END --- */}
221 |                                     </SelectTrigger>
222 |                                     <SelectContent className="bg-white border-[#BB79D1]/40 shadow-xl rounded-2xl text-[#222]">
223 |                                         {languages.map((lang) => (
224 |                                             <SelectItem key={lang.value} value={lang.value} className="text-[#222] focus:bg-[#BB79D1]/20 focus:text-[#222]">
225 |                                                 <span className="flex items-center gap-3">
226 |                                                     <span className="text-xl inline-block min-w-[1.5rem]">{lang.flag}</span>
227 |                                                     <span>{lang.label}</span>
228 |                                                 </span>
229 |                                             </SelectItem>
230 |                                         ))}
231 |                                     </SelectContent>
232 |                                 </Select>
233 |                             </div>
234 | 
235 |                             {/* Child Age Slider */}
236 |                             <div className="space-y-2 pt-2">
237 |                                 <label htmlFor="childAge" className="flex items-center gap-2 text-lg font-medium mb-2 font-heading text-[#222]">
238 |                                     <div className="w-8 h-8 rounded-full bg-[#F9DA60]/20 flex items-center justify-center">
239 |                                         <Calendar className="h-4 w-4 text-[#F9DA60]" />
240 |                                     </div>
241 |                                     <span>Edad del Niño/Oyente</span>
242 |                                 </label>
243 | 
244 |                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl border border-white/20 p-6">
245 |                                     <Slider
246 |                                         id="childAge"
247 |                                         min={1}
248 |                                         max={10}
249 |                                         step={1}
250 |                                         value={[childAge]}
251 |                                         onValueChange={(value) => setChildAge(value[0])}
252 |                                         className="py-4"
253 |                                     />
254 |                                     <div className="flex justify-between mt-3">
255 |                                         <span className="text-xs text-[#7DC4E0]">1 año</span>
256 |                                         <div className="px-4 py-2 rounded-full bg-gradient-to-r from-[#F9DA60]/20 to-[#F9DA60]/30 border border-[#F9DA60]/30">
257 |                                             <span className="text-2xl font-bold text-[#F9DA60]">{childAge}</span>
258 |                                             <span className="text-xs text-[#F9DA60]/90 ml-1">años</span>
259 |                                         </div>
260 |                                         <span className="text-xs text-[#7DC4E0]">10 años</span>
261 |                                     </div>
262 |                                 </div>
263 |                             </div>
264 | 
265 |                             {/* Special Need Select */}
266 |                             <div className="space-y-2 pt-2">
267 |                                 <label htmlFor="specialNeed" className="flex items-center gap-2 text-lg font-medium mb-2 font-heading text-[#222]">
268 |                                     <div className="w-8 h-8 rounded-full bg-[#F6A5B7]/20 flex items-center justify-center">
269 |                                         <Heart className="h-4 w-4 text-[#F6A5B7]" />
270 |                                     </div>
271 |                                     <span>¿Alguna necesidad especial? (Opcional)</span>
272 |                                 </label>
273 | 
274 |                                 <Select value={specialNeed} onValueChange={setSpecialNeed}>
275 |                                     <SelectTrigger className="w-full bg-white/10 border-[#F6A5B7]/30 backdrop-blur-sm text-[#222] hover:bg-white/20 transition-colors h-12">
276 |                                         <SelectValue placeholder="Selecciona una opción" />
277 |                                     </SelectTrigger>
278 |                                     <SelectContent className="bg-white border-[#BB79D1]/40 shadow-xl rounded-2xl text-[#222]">
279 |                                         {specialNeeds.map((need) => (
280 |                                             <SelectItem key={need.value} value={need.value} className="text-[#222] focus:bg-[#BB79D1]/20 focus:text-[#222]">
281 |                                                 {need.label}
282 |                                             </SelectItem>
283 |                                         ))}
284 |                                     </SelectContent>
285 |                                 </Select>
286 |                             </div>
287 | 
288 |                             {/* Botón de Guardar */}
289 |                             <motion.button
290 |                                 whileHover={{ scale: 1.02 }}
291 |                                 whileTap={{ scale: 0.98 }}
292 |                                 type="submit"
293 |                                 disabled={isSaving || isLoading} /* Disable also while loading initial data */
294 |                                 className={`w-full mt-6 py-4 px-6 rounded-xl font-medium flex items-center justify-center gap-2 shadow-lg transition-all ${
295 |                                     (isSaving || isLoading)
296 |                                         ? 'bg-gray-400/30 border-gray-400/30 text-gray-500 cursor-not-allowed'
297 |                                         : 'bg-[#BB79D1]/30 border border-[#BB79D1]/30 hover:bg-[#BB79D1]/40 text-[#222]'
298 |                                 }`}
299 |                             >
300 |                                 {isSaving ? (
301 |                                     <div className="h-5 w-5 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin mr-2"></div>
302 |                                 ) : (
303 |                                     <Check className="h-5 w-5 text-[#BB79D1]" />
304 |                                 )}
305 |                                 <span>{isSaving ? "Guardando..." : "Guardar Perfil"}</span>
306 |                             </motion.button>
307 |                         </motion.form>
308 |                     )}
309 |                 </div>
310 |             </div>
311 |         </PageTransition>
312 |     );
313 | };
314 | 
315 | export default ProfileConfigPage;
```

src/pages/SavedStories.tsx
```
1 | import { useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { Book, Calendar, ChevronDown, ChevronRight, Bookmark, User, Clock, SortAsc, SortDesc, Filter } from "lucide-react";
4 | import { motion, AnimatePresence } from "framer-motion";
5 | import { useStoriesStore } from "../store/stories/storiesStore";
6 | import { useChaptersStore } from "../store/stories/chapters/chaptersStore";
7 | import BackButton from "../components/BackButton";
8 | import PageTransition from "../components/PageTransition";
9 | import { StoryWithChapters } from "../types";
10 | 
11 | export default function SavedStories() {
12 |   const navigate = useNavigate();
13 |   const { generatedStories } = useStoriesStore();
14 |   const { getChaptersByStoryId } = useChaptersStore();
15 |   const [expandedStories, setExpandedStories] = useState<{[key: string]: boolean}>({});
16 |   const [sortOrder, setSortOrder] = useState<'newest' | 'oldest'>('newest');
17 |   
18 |   const formatDate = (dateString: string) => {
19 |     const date = new Date(dateString);
20 |     return new Intl.DateTimeFormat('es-ES', { 
21 |       year: 'numeric', 
22 |       month: 'short', 
23 |       day: 'numeric' 
24 |     }).format(date);
25 |   };
26 |   
27 |   const container = {
28 |     hidden: { opacity: 0 },
29 |     show: {
30 |       opacity: 1,
31 |       transition: {
32 |         staggerChildren: 0.1
33 |       }
34 |     }
35 |   };
36 |   
37 |   const item = {
38 |     hidden: { y: 20, opacity: 0 },
39 |     show: { y: 0, opacity: 1 }
40 |   };
41 | 
42 |   const toggleExpand = (storyId: string) => {
43 |     setExpandedStories(prev => ({
44 |       ...prev,
45 |       [storyId]: !prev[storyId]
46 |     }));
47 |   };
48 | 
49 |   const toggleSortOrder = () => {
50 |     setSortOrder(prev => prev === 'newest' ? 'oldest' : 'newest');
51 |   };
52 | 
53 |   // Group stories that have chapters
54 |   const storiesWithChaptersInfo = generatedStories.map(story => {
55 |     const chapters = getChaptersByStoryId(story.id);
56 |     return {
57 |       ...story,
58 |       hasMultipleChapters: chapters.length > 1,
59 |       chaptersCount: chapters.length,
60 |       chapters
61 |     } as StoryWithChapters;
62 |   });
63 |   
64 |   // Sort stories based on sort order
65 |   const sortedStories = [...storiesWithChaptersInfo].sort((a, b) => {
66 |     const dateA = new Date(a.createdAt).getTime();
67 |     const dateB = new Date(b.createdAt).getTime();
68 |     return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
69 |   });
70 |   
71 |   return (
72 |     <PageTransition>
73 |       <div
74 |         className="min-h-screen flex flex-col items-center justify-center relative"
75 |         style={{
76 |           backgroundImage: "url(/fondo_png.png)",
77 |           backgroundSize: "cover",
78 |           backgroundPosition: "center",
79 |           backgroundRepeat: "no-repeat",
80 |         }}
81 |       >
82 |         <BackButton />
83 |         
84 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
85 |           <h1 className="text-3xl font-bold text-[#BB79D1] text-center mb-4 font-heading drop-shadow-lg">
86 |             Mis Historias
87 |           </h1>
88 |           
89 |           {storiesWithChaptersInfo.length > 0 && (
90 |             <div 
91 |               className="flex justify-center mb-6 bg-white/70 rounded-xl p-1 max-w-xs mx-auto shadow-md"
92 |               onClick={toggleSortOrder}
93 |             >
94 |               <button className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${sortOrder === 'newest' ? 'bg-[#BB79D1] text-white shadow-md' : 'hover:bg-white/80 text-[#222]'}`}>
95 |                 <SortDesc size={16} />
96 |                 <span>Más recientes</span>
97 |               </button>
98 |               <button className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${sortOrder === 'oldest' ? 'bg-[#BB79D1] text-white shadow-md' : 'hover:bg-white/80 text-[#222]'}`}>
99 |                 <SortAsc size={16} />
100 |                 <span>Más antiguas</span>
101 |               </button>
102 |             </div>
103 |           )}
104 |           
105 |           {sortedStories.length === 0 ? (
106 |             <div className="text-center bg-white/70 rounded-xl p-6 shadow-md">
107 |               <p className="text-[#222] font-medium">No tienes historias guardadas.</p>
108 |             </div>
109 |           ) : (
110 |             <motion.div
111 |               variants={container}
112 |               initial="hidden"
113 |               animate="show"
114 |               className="space-y-4"
115 |             >
116 |               {sortedStories.map((story) => (
117 |                 <motion.div
118 |                   key={story.id}
119 |                   variants={item}
120 |                   className="bg-white/80 rounded-xl overflow-hidden shadow-md"
121 |                 >
122 |                   <div 
123 |                     className="story-card p-4 cursor-pointer hover:bg-white/90 transition-all"
124 |                     onClick={() => story.hasMultipleChapters 
125 |                       ? toggleExpand(story.id) 
126 |                       : navigate(`/story/${story.id}`)}
127 |                   >
128 |                     <div className="flex items-center">
129 |                       <div className="w-12 h-12 rounded-full bg-[#F6A5B7]/20 flex items-center justify-center mr-4 shrink-0 border-2 border-[#F6A5B7]/40">
130 |                         <Book size={20} className="text-[#F6A5B7]" />
131 |                       </div>
132 |                       <div className="flex-1 min-w-0">
133 |                         <h3 className="text-[#222] font-semibold text-lg truncate">{story.title}</h3>
134 |                         <div className="flex items-center text-[#555] text-sm">
135 |                           <Calendar size={14} className="mr-1 shrink-0" />
136 |                           <span className="mr-3">{formatDate(story.createdAt)}</span>
137 |                           {story.hasMultipleChapters && (
138 |                             <span className="text-[#BB79D1] flex items-center">
139 |                               <Bookmark size={14} className="mr-1" />
140 |                               {story.chaptersCount} capítulos
141 |                             </span>
142 |                           )}
143 |                         </div>
144 |                       </div>
145 |                       {story.hasMultipleChapters && (
146 |                         <div className="ml-2">
147 |                           {expandedStories[story.id] ? (
148 |                             <ChevronDown size={20} className="text-[#BB79D1]" />
149 |                           ) : (
150 |                             <ChevronRight size={20} className="text-[#BB79D1]" />
151 |                           )}
152 |                         </div>
153 |                       )}
154 |                     </div>
155 |                     
156 |                     {/* Character info */}
157 |                     <div className="mt-3 pt-3 border-t border-[#BB79D1]/10 flex items-center">
158 |                       <div className="bg-[#7DC4E0]/20 h-8 w-8 rounded-full flex items-center justify-center mr-2 border border-[#7DC4E0]/40">
159 |                         <User size={14} className="text-[#7DC4E0]" />
160 |                       </div>
161 |                       <div className="text-[#222] text-sm flex-1">
162 |                         <span className="font-medium">{story.options.character.name || "Personaje"}</span>
163 |                         {story.options.character.profession && (
164 |                           <span className="ml-2 text-[#555]">• {story.options.character.profession}</span>
165 |                         )}
166 |                       </div>
167 |                       <div className="flex gap-2">
168 |                         {story.options.genre && (
169 |                           <div className="px-2 py-1 text-xs rounded-full bg-[#BB79D1]/10 text-[#BB79D1] border border-[#BB79D1]/30">
170 |                             {story.options.genre}
171 |                           </div>
172 |                         )}
173 |                         <div className="px-2 py-1 text-xs rounded-full bg-[#F9DA60]/20 text-[#222] border border-[#F9DA60]/40 flex items-center gap-1">
174 |                           <Clock size={11} className="text-[#F9DA60]" />
175 |                           {story.options.duration}
176 |                         </div>
177 |                       </div>
178 |                     </div>
179 |                   </div>
180 |                   
181 |                   {/* Chapters list for expanded stories */}
182 |                   <AnimatePresence>
183 |                     {story.hasMultipleChapters && expandedStories[story.id] && (
184 |                       <motion.div
185 |                         initial={{ height: 0, opacity: 0 }}
186 |                         animate={{ height: "auto", opacity: 1 }}
187 |                         exit={{ height: 0, opacity: 0 }}
188 |                         transition={{ duration: 0.3 }}
189 |                         className="overflow-hidden"
190 |                       >
191 |                         <div className="bg-[#F6A5B7]/5 border-t border-[#F6A5B7]/10">
192 |                           {story.chapters.map((chapter, index) => (
193 |                             <div 
194 |                               key={`${story.id}-chapter-${index}`}
195 |                               className="px-4 py-3 border-b border-[#F6A5B7]/5 last:border-b-0 hover:bg-[#F6A5B7]/10 cursor-pointer"
196 |                               onClick={() => navigate(`/story/${story.id}?chapter=${index}`)}
197 |                             >
198 |                               <div className="flex items-center">
199 |                                 <div className="w-8 h-8 rounded-full bg-[#BB79D1]/20 flex items-center justify-center mr-3 shrink-0 border border-[#BB79D1]/30">
200 |                                   <span className="text-sm text-[#BB79D1] font-medium">
201 |                                     {index + 1}
202 |                                   </span>
203 |                                 </div>
204 |                                 <div>
205 |                                   <h4 className="text-[#222] font-medium">
206 |                                     {chapter.title || `Capítulo ${index + 1}`}
207 |                                   </h4>
208 |                                   <span className="text-[#555] text-xs">
209 |                                     {formatDate(chapter.createdAt)}
210 |                                   </span>
211 |                                 </div>
212 |                               </div>
213 |                             </div>
214 |                           ))}
215 |                         </div>
216 |                       </motion.div>
217 |                     )}
218 |                   </AnimatePresence>
219 |                 </motion.div>
220 |               ))}
221 |             </motion.div>
222 |           )}
223 |         </div>
224 |       </div>
225 |     </PageTransition>
226 |   );
227 | }
```

src/pages/SettingsPage.tsx
```
1 | import React, { useState } from 'react';
2 | import { useNavigate, Link } from 'react-router-dom';
3 | import { useUserStore } from '@/store/user/userStore'; // Adjust path if needed
4 | import { supabase } from '@/supabaseClient'; // Adjust path if needed
5 | import { useToast } from '@/hooks/use-toast'; // Adjust path if needed
6 | import PageTransition from '@/components/PageTransition'; // Adjust path if needed
7 | import BackButton from '@/components/BackButton';
8 | import { motion } from 'framer-motion';
9 | import {
10 |     Settings,
11 |     User,
12 |     CreditCard,
13 |     LogOut,
14 |     BookOpen,
15 |     CalendarClock,
16 |     AlertTriangle,
17 |     Star,
18 |     ChevronRight,
19 |     Mail,
20 |     Mic,
21 |     Euro
22 | } from 'lucide-react';
23 | 
24 | const SettingsPage: React.FC = () => {
25 |     const navigate = useNavigate();
26 |     const { toast } = useToast();
27 |     const { user, profileSettings, logoutUser, isPremium } = useUserStore(
28 |         (state) => ({
29 |             user: state.user,
30 |             profileSettings: state.profileSettings,
31 |             logoutUser: state.logoutUser,
32 |             isPremium: state.isPremium, // Assuming isPremium selector exists
33 |         })
34 |     );
35 | 
36 |     const [isPortalLoading, setIsPortalLoading] = useState(false);
37 |     const [isLogoutLoading, setIsLogoutLoading] = useState(false);
38 |     const [isCheckoutLoading, setIsCheckoutLoading] = useState(false);
39 | 
40 |     // --- Voice Credits Constants ---
41 |     const PREMIUM_MONTHLY_VOICE_ALLOWANCE = 20; // O usa el valor correcto si es diferente
42 |     const VOICE_CREDITS_PACKAGE_AMOUNT = 20; // O usa el valor correcto si es diferente
43 |     const VOICE_CREDITS_PACKAGE_PRICE_EUR = 10; // O usa el valor correcto si es diferente
44 | 
45 |     const handleLogout = async () => {
46 |         setIsLogoutLoading(true);
47 |         try {
48 |             await logoutUser();
49 |             // logoutUser should handle redirect internally, but navigate as a fallback
50 |             navigate('/');
51 |             toast({ title: 'Sesión cerrada', description: 'Has cerrado sesión correctamente.' });
52 |         } catch (error) {
53 |             console.error("Error during logout:", error);
54 |             toast({ title: 'Error', description: 'No se pudo cerrar sesión.', variant: 'destructive' });
55 |             setIsLogoutLoading(false);
56 |         }
57 |     };
58 | 
59 |     const handleCheckout = async (item: 'premium' | 'credits') => {
60 |         setIsCheckoutLoading(true);
61 |         try {
62 |             const { data, error } = await supabase.functions.invoke('create-checkout-session', {
63 |                 body: JSON.stringify({ item }),
64 |             });
65 | 
66 |             if (error) throw error;
67 | 
68 |             if (data?.url) {
69 |                 window.location.href = data.url;
70 |             } else {
71 |                 throw new Error('No se recibió URL de checkout.');
72 |             }
73 |         } catch (error: any) {
74 |             console.error(`Error creating ${item} checkout session:`, error);
75 |             toast({ title: 'Error', description: `No se pudo iniciar el pago: ${error.message}`, variant: 'destructive' });
76 |             setIsCheckoutLoading(false);
77 |         }
78 |     };
79 | 
80 |     const handleManageSubscription = async () => {
81 |         if (!profileSettings?.stripe_customer_id) {
82 |             toast({ title: 'Error', description: 'No se encontró información de cliente para gestionar la suscripción.', variant: 'destructive' });
83 |             return;
84 |         }
85 | 
86 |         setIsPortalLoading(true);
87 |         try {
88 |             const { data, error } = await supabase.functions.invoke('create-customer-portal-session');
89 | 
90 |             if (error) throw error;
91 | 
92 |             if (data?.url) {
93 |                 window.location.href = data.url;
94 |             } else {
95 |                 throw new Error('No se recibió URL del portal de cliente.');
96 |             }
97 |         } catch (error: any) {
98 |             console.error("Error creating customer portal session:", error);
99 |             toast({ title: 'Error', description: `No se pudo redirigir a la gestión de suscripción: ${error.message}`, variant: 'destructive' });
100 |             setIsPortalLoading(false);
101 |         } // No finally block needed for isLoading as page redirects on success
102 |     };
103 | 
104 |     if (!user || !profileSettings) {
105 |         // Optional: Show a loading state or redirect if data isn't ready
106 |         return (
107 |             <PageTransition>
108 |                 <div className="min-h-screen gradient-bg flex justify-center items-center p-6">
109 |                     <div className="rounded-full h-12 w-12 border-4 border-brand-blue border-t-transparent animate-spin"></div>
110 |                 </div>
111 |             </PageTransition>
112 |         );
113 |     }
114 | 
115 |     const premiumUser = isPremium(); // Call the selector
116 | 
117 |     // --- Calculate Reset Date String --- BEGIN
118 |     let resetDateString = "Fecha no disponible"; // Default
119 | 
120 |     if (premiumUser) {
121 |         // Premium: Use current_period_end
122 |         const endDateISO = profileSettings?.current_period_end;
123 |         if (endDateISO) {
124 |             try {
125 |                 const endDate = new Date(endDateISO);
126 |                 resetDateString = new Intl.DateTimeFormat('es-ES', {
127 |                     day: 'numeric',
128 |                     month: 'long',
129 |                     // year: 'numeric' // Optional: add year if needed
130 |                 }).format(endDate);
131 |                 resetDateString = `el ${resetDateString}`;
132 |             } catch (e) {
133 |                 console.error("Error formateando current_period_end:", e);
134 |                 resetDateString = "Error al formatear fecha";
135 |             }
136 |         } else {
137 |             console.warn("Usuario premium sin current_period_end en profileSettings.");
138 |             resetDateString = "en el próximo ciclo de facturación";
139 |         }
140 |     } else {
141 |         // Free: Static message
142 |         resetDateString = "el día 1 del próximo mes";
143 |     }
144 |     // --- Calculate Reset Date String --- END
145 | 
146 |     return (
147 |         <PageTransition>
148 |             <div
149 |                 className="min-h-screen flex flex-col items-center justify-start bg-[#FFF6FA] relative"
150 |                 style={{
151 |                     backgroundImage: 'url(/fondo_png.png)',
152 |                     backgroundSize: 'cover',
153 |                     backgroundPosition: 'center',
154 |                     backgroundRepeat: 'no-repeat',
155 |                 }}
156 |             >
157 |                 {/* Logo centrado arriba */}
158 |                 <div className="flex flex-col items-center mt-6 mb-2 select-none">
159 |                     <img src="/logo_png.png" alt="TaleMe Logo" className="w-48 max-w-xs mx-auto mb-2 drop-shadow-xl" />
160 |                 </div>
161 |                 <div className="container mx-auto px-4 py-2 max-w-2xl">
162 |                     {/* Back button */}
163 |                     <BackButton className="absolute top-8 left-4 md:left-8" />
164 | 
165 |                     {/* Header */}
166 |                     <motion.div
167 |                         initial={{ opacity: 0, y: -10 }}
168 |                         animate={{ opacity: 1, y: 0 }}
169 |                         transition={{ duration: 0.5 }}
170 |                         className="text-center mb-6"
171 |                     >
172 |                         <div className="inline-flex justify-center items-center w-16 h-16 rounded-full bg-[#BB79D1]/80 border border-[#BB79D1]/50 mb-2 shadow-lg">
173 |                             <Settings className="h-8 w-8 text-white" />
174 |                         </div>
175 |                         <h1 className="text-3xl font-bold font-heading text-[#BB79D1]">Ajustes</h1>
176 |                     </motion.div>
177 | 
178 |                     {/* Account Section */}
179 |                     <motion.div
180 |                         initial={{ opacity: 0, y: 20 }}
181 |                         animate={{ opacity: 1, y: 0 }}
182 |                         transition={{ duration: 0.5, delay: 0.1 }}
183 |                         className="bg-white/40 backdrop-blur-md rounded-3xl border border-[#BB79D1]/20 shadow-xl overflow-hidden mb-5"
184 |                     >
185 |                         <div className="p-5 border-b border-[#BB79D1]/10 flex items-center gap-3">
186 |                             <div className="w-10 h-10 rounded-full bg-[#A5D6F6]/20 flex items-center justify-center">
187 |                                 <User className="h-5 w-5 text-[#A5D6F6]" />
188 |                             </div>
189 |                             <h2 className="text-xl font-semibold font-heading text-[#BB79D1]">Cuenta</h2>
190 |                         </div>
191 |                         <div className="p-5">
192 |                             <div className="flex items-center p-2">
193 |                                 <Mail className="h-5 w-5 text-[#BB79D1]/80 mr-3" />
194 |                                 <div className="flex-1">
195 |                                     <div className="text-sm text-[#BB79D1]/80 mb-1">Email</div>
196 |                                     <div className="font-medium text-[#BB79D1]">{user.email}</div>
197 |                                 </div>
198 |                             </div>
199 |                         </div>
200 |                     </motion.div>
201 | 
202 |                     {/* Plan & Billing Section */}
203 |                     <motion.div
204 |                         initial={{ opacity: 0, y: 20 }}
205 |                         animate={{ opacity: 1, y: 0 }}
206 |                         transition={{ duration: 0.5, delay: 0.2 }}
207 |                         className="bg-white/40 backdrop-blur-md rounded-3xl border border-[#F9DA60]/20 shadow-xl overflow-hidden mb-5"
208 |                     >
209 |                         <div className="p-5 border-b border-[#F9DA60]/10 flex items-center gap-3">
210 |                             <div className="w-10 h-10 rounded-full bg-[#F9DA60]/20 flex items-center justify-center">
211 |                                 <CreditCard className="h-5 w-5 text-[#F9DA60]" />
212 |                             </div>
213 |                             <h2 className="text-xl font-semibold font-heading text-[#BB79D1]">Plan y Facturación</h2>
214 |                         </div>
215 |                         <div className="p-5">
216 |                             <div className="flex items-center justify-between p-2 border-b border-[#BB79D1]/10 pb-4 mb-4">
217 |                                 <div className="flex items-center">
218 |                                     <div className="text-md text-[#BB79D1]">Plan Actual:</div>
219 |                                 </div>
220 |                                 <div className={`px-3 py-1 rounded-full font-semibold text-sm ${premiumUser
221 |                                     ? 'bg-gradient-to-r from-[#F9DA60]/30 to-[#F9DA60]/40 text-[#BB79D1] border border-[#F9DA60]/30'
222 |                                     : 'bg-[#BB79D1]/20 text-[#BB79D1] border border-[#BB79D1]/30'
223 |                                     }`}>
224 |                                     {premiumUser ? 'Premium' : 'Free'}
225 |                                 </div>
226 |                             </div>
227 | 
228 |                             {/* Free User Content */}
229 |                             {!premiumUser && (
230 |                                 <div className="space-y-5">
231 |                                     {/* Story Limits */}
232 |                                     <div className="bg-white/70 rounded-2xl p-4 mb-2 border border-[#BB79D1]/30 shadow-sm">
233 |                                         <div className="flex items-center gap-3 mb-2">
234 |                                             <div className="w-10 h-10 rounded-full bg-[#BB79D1]/20 flex items-center justify-center">
235 |                                                 <BookOpen className="h-5 w-5 text-[#BB79D1]" />
236 |                                             </div>
237 |                                             <div>
238 |                                                 <h3 className="font-bold text-lg text-[#222]">Historias restantes este mes</h3>
239 |                                                 <p className="text-[#7DC4E0] text-sm">Cuentos que puedes crear</p>
240 |                                             </div>
241 |                                         </div>
242 |                                         <div className="flex justify-between items-center mb-2 px-2">
243 |                                             <span className="text-[#222] font-medium">Disponibles:</span>
244 |                                             <span className="font-mono font-bold text-xl text-[#F6A5B7]">{profileSettings.monthly_stories_generated !== undefined ? Math.max(0, 10 - profileSettings.monthly_stories_generated) : 'N/A'}</span>
245 |                                         </div>
246 |                                         <div className="text-sm text-white mt-3 flex items-center bg-[#F6A5B7] p-2 rounded-lg">
247 |                                             <CalendarClock className="h-4 w-4 mr-2 text-white" />
248 |                                             <span>El límite se reiniciará a 10 historias {resetDateString}</span>
249 |                                         </div>
250 |                                     </div>
251 | 
252 |                                     {/* Voice Credits */}
253 |                                     <div className="bg-white/70 rounded-2xl p-4 border border-[#A5D6F6]/30 shadow-sm">
254 |                                         <div className="flex items-center gap-3 mb-2">
255 |                                             <div className="w-10 h-10 rounded-full bg-[#A5D6F6]/20 flex items-center justify-center">
256 |                                                 <Mic className="h-5 w-5 text-[#A5D6F6]" />
257 |                                             </div>
258 |                                             <div>
259 |                                                 <h3 className="font-bold text-lg text-[#222]">Créditos de voz disponibles</h3>
260 |                                                 <p className="text-[#7DC4E0] text-sm">Para narrar tus cuentos</p>
261 |                                             </div>
262 |                                         </div>
263 |                                         <div className="flex justify-between items-center mb-2 px-2">
264 |                                             <span className="text-[#222] font-medium">Disponibles:</span>
265 |                                             <span className="font-mono font-bold text-xl text-[#A5D6F6]">{profileSettings.voice_credits || 0}</span>
266 |                                         </div>
267 | 
268 |                                         {/* Botón Comprar Créditos Voz (Free user) */}
269 |                                         <button
270 |                                             onClick={() => handleCheckout('credits')}
271 |                                             // disabled={isCheckoutLoading || isPortalLoading}
272 |                                             disabled={true}
273 |                                             className="flex items-center justify-between w-full py-3 px-4 mt-3 bg-[#A5D6F6]/40 rounded-xl shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
274 |                                         >
275 |                                             <div className="flex items-center gap-2 text-[#BB79D1] font-bold">
276 |                                                 <CreditCard className="h-4 w-4" />
277 |                                                 <span>Comprar 20 créditos más por 10€</span>
278 |                                             </div>
279 |                                             {isCheckoutLoading ? (
280 |                                                 <div className="h-4 w-4 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin"></div>
281 |                                             ) : (
282 |                                                 <ChevronRight className="h-4 w-4 text-white" />
283 |                                             )}
284 |                                         </button>
285 |                                     </div>
286 | 
287 |                                     {/* Botón Ver Planes */}
288 |                                     <div className="border-t border-[#BB79D1]/10 pt-4">
289 |                                         <Link
290 |                                             to="/plans?tab=premium"
291 |                                             className="flex items-center justify-between w-full py-3 px-4 bg-[#f7c59f]/40 border border-[#f7c59f]/30 hover:bg-[#f7c59f]/60 text-white rounded-2xl font-bold transition-all shadow-md hover:shadow-lg"
292 |                                         >
293 |                                             <div className="flex items-center gap-2">
294 |                                                 <Star className="h-4 w-4" />
295 |                                                 <span>Ver Plan Premium</span>
296 |                                             </div>
297 |                                             <ChevronRight className="h-4 w-4" />
298 |                                         </Link>
299 |                                     </div>
300 |                                 </div>
301 |                             )}
302 | 
303 |                             {/* Premium User Content */}
304 |                             {premiumUser && (
305 |                                 <div className="space-y-5">
306 |                                     {/* Voice Credits Section Separada */}
307 |                                     <div className="bg-white/70 rounded-2xl p-4 border border-[#A5D6F6]/30 shadow-sm">
308 |                                         <div className="flex items-center gap-3 mb-2">
309 |                                             <div className="w-10 h-10 rounded-full bg-[#A5D6F6]/20 flex items-center justify-center">
310 |                                                 <Mic className="h-5 w-5 text-[#A5D6F6]" />
311 |                                             </div>
312 |                                             <div>
313 |                                                 <h3 className="font-bold text-lg text-[#222]">Créditos de voz disponibles</h3>
314 |                                                 <p className="text-[#7DC4E0] text-sm">Para narrar tus cuentos</p>
315 |                                             </div>
316 |                                         </div>
317 |                                         {/* Créditos del plan mensual */}
318 |                                         <div className="flex justify-between items-center px-2">
319 |                                             <span className="text-[#222] font-medium">Del plan este mes:</span>
320 |                                             <span className="font-mono font-bold text-lg text-[#A5D6F6]">
321 |                                                 {profileSettings.monthly_voice_generations_used !== undefined
322 |                                                     ? Math.max(0, PREMIUM_MONTHLY_VOICE_ALLOWANCE - profileSettings.monthly_voice_generations_used)
323 |                                                     : 'N/A'}
324 |                                                 {' / '}{PREMIUM_MONTHLY_VOICE_ALLOWANCE}
325 |                                             </span>
326 |                                         </div>
327 |                                         {/* Créditos comprados adicionales */}
328 |                                         <div className="flex justify-between items-center mt-1 px-2 pt-2 border-t border-[#A5D6F6]/20">
329 |                                             <span className="text-[#222] font-medium">Adicionales comprados:</span>
330 |                                             <span className="font-mono font-bold text-lg text-[#A5D6F6]">
331 |                                                 {profileSettings.voice_credits ?? 0}
332 |                                             </span>
333 |                                         </div>
334 |                                         {/* Texto explicativo actualizado */}
335 |                                         <div className="text-sm text-white mt-3 flex items-center bg-[#A5D6F6] p-2 rounded-lg">
336 |                                             <CalendarClock className="h-4 w-4 mr-2 text-white" />
337 |                                             <span>Recibes {PREMIUM_MONTHLY_VOICE_ALLOWANCE} narraciones con tu plan cada mes (próximo reinicio {resetDateString}). Los créditos que compres se añaden a tu cuenta, no caducan, y se utilizan cuando agotes los de tu plan.</span>
338 |                                         </div>
339 |                                         {/* Botón Comprar Créditos Voz (Premium user) */}
340 |                                         <button
341 |                                             onClick={() => handleCheckout('credits')}
342 |                                             disabled={isCheckoutLoading}
343 |                                             className="flex items-center justify-between w-full py-3 px-4 mt-3 bg-[#A5D6F6]/40 rounded-xl shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
344 |                                         >
345 |                                             <div className="flex items-center gap-2 text-white font-bold">
346 |                                                 <CreditCard className="h-4 w-4" />
347 |                                                 <span>Comprar {VOICE_CREDITS_PACKAGE_AMOUNT} créditos más por {VOICE_CREDITS_PACKAGE_PRICE_EUR}€</span>
348 |                                             </div>
349 |                                             {isCheckoutLoading ? (
350 |                                                 <div className="h-4 w-4 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin"></div>
351 |                                             ) : (
352 |                                                 <ChevronRight className="h-4 w-4 text-white" />
353 |                                             )}
354 |                                         </button>
355 |                                     </div>
356 |                                     {/* Gestionar Suscripción (sin cambios) */}
357 |                                     {profileSettings.stripe_customer_id && (
358 |                                         <div className="border-t border-[#BB79D1]/10 pt-4">
359 |                                             <button
360 |                                                 onClick={handleManageSubscription}
361 |                                                 disabled={isPortalLoading}
362 |                                                 className="flex items-center justify-between w-full py-3 px-4 bg-[#f7c59f]/40 border border-[#f7c59f]/30 hover:bg-[#f7c59f]/60 text-white rounded-2xl font-bold transition-all shadow-md hover:shadow-lg"
363 |                                             >
364 |                                                 {isPortalLoading ? (
365 |                                                     <div className="h-5 w-5 border-2 border-[#BB79D1] border-t-transparent rounded-full animate-spin"></div>
366 |                                                 ) : (
367 |                                                     <div className="flex items-center gap-2">
368 |                                                         <Settings className="h-4 w-4" />
369 |                                                         <span>Gestionar Suscripción</span>
370 |                                                     </div>
371 |                                                 )}
372 |                                                 <ChevronRight className="h-4 w-4" />
373 |                                             </button>
374 |                                         </div>
375 |                                     )}
376 |                                 </div>
377 |                             )}
378 |                         </div>
379 |                     </motion.div>
380 | 
381 |                     {/* General Section */}
382 |                     <motion.div
383 |                         initial={{ opacity: 0, y: 20 }}
384 |                         animate={{ opacity: 1, y: 0 }}
385 |                         transition={{ duration: 0.5, delay: 0.3 }}
386 |                         className="bg-white/40 backdrop-blur-md rounded-3xl border border-[#BB79D1]/20 shadow-xl overflow-hidden mb-10"
387 |                     >
388 |                         <div className="p-5 border-b border-[#BB79D1]/10 flex items-center gap-3">
389 |                             <div className="w-10 h-10 rounded-full bg-[#BB79D1]/20 flex items-center justify-center">
390 |                                 <Settings className="h-5 w-5 text-[#BB79D1]" />
391 |                             </div>
392 |                             <h2 className="text-xl font-semibold font-heading text-[#BB79D1]">General</h2>
393 |                         </div>
394 |                         <div className="p-5">
395 |                             <button
396 |                                 onClick={handleLogout}
397 |                                 disabled={isLogoutLoading}
398 |                                 className="flex items-center justify-center w-full py-3 px-4 bg-[#F6A5B7] hover:bg-[#BB79D1] text-white rounded-2xl font-bold gap-2 transition-colors shadow-md"
399 |                             >
400 |                                 {isLogoutLoading ? (
401 |                                     <div className="h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
402 |                                 ) : (
403 |                                     <>
404 |                                         <LogOut className="h-4 w-4" />
405 |                                         <span>Cerrar Sesión</span>
406 |                                     </>
407 |                                 )}
408 |                             </button>
409 |                         </div>
410 |                     </motion.div>
411 |                 </div>
412 |             </div>
413 |         </PageTransition>
414 |     );
415 | };
416 | 
417 | export default SettingsPage;
```

src/pages/Signup.tsx
```
1 | import { useState } from "react";
2 | import { useNavigate } from "react-router-dom";
3 | import { Mail, Lock, Eye, EyeOff } from "lucide-react";
4 | import { Input } from "@/components/ui/input";
5 | import { Form, FormControl, FormField, FormItem, FormMessage } from "@/components/ui/form";
6 | import { useForm } from "react-hook-form";
7 | import StoryButton from "../components/StoryButton";
8 | import PageTransition from "../components/PageTransition";
9 | import { useToast } from "@/hooks/use-toast";
10 | import BackButton from "../components/BackButton";
11 | import { signUp, signInWithGoogle } from "../supabaseAuth";
12 | 
13 | export default function Signup() {
14 |   const navigate = useNavigate();
15 |   const { toast } = useToast();
16 |   const [showPassword, setShowPassword] = useState(false);
17 |   const [showConfirmPassword, setShowConfirmPassword] = useState(false);
18 |   const [isLoading, setIsLoading] = useState(false);
19 |   const [isGoogleLoading, setIsGoogleLoading] = useState(false);
20 |   
21 |   const form = useForm({
22 |     defaultValues: {
23 |       email: "",
24 |       password: "",
25 |       confirmPassword: ""
26 |     }
27 |   });
28 | 
29 |   const handleSignup = async (data: { email: string; password: string; confirmPassword: string }) => {
30 |     if (!data.email || !data.password || !data.confirmPassword) {
31 |       toast({
32 |         title: "Error en el registro",
33 |         description: "Por favor, completa todos los campos",
34 |         variant: "destructive"
35 |       });
36 |       return;
37 |     }
38 |     
39 |     if (data.password !== data.confirmPassword) {
40 |       toast({
41 |         title: "Error en el registro",
42 |         description: "Las contraseñas no coinciden",
43 |         variant: "destructive"
44 |       });
45 |       return;
46 |     }
47 |     
48 |     try {
49 |       setIsLoading(true);
50 |       const { user, error } = await signUp(data.email, data.password);
51 |       
52 |       if (error) {
53 |         toast({
54 |           title: "Error en el registro",
55 |           description: error.message,
56 |           variant: "destructive"
57 |         });
58 |         return;
59 |       }
60 |       
61 |       if (user) {
62 |         toast({
63 |           title: "Registro exitoso",
64 |           description: "¡Tu cuenta ha sido creada!",
65 |         });
66 |         // Redirigir a la página de login después de un registro exitoso
67 |         setTimeout(() => {
68 |           navigate("/signup-success");
69 |         }, 2000);
70 |       } else {
71 |         toast({
72 |           title: "Error en el registro",
73 |           description: "No se pudo crear la cuenta",
74 |           variant: "destructive"
75 |         });
76 |       }
77 |     } catch (err) {
78 |       toast({
79 |         title: "Error inesperado",
80 |         description: "Ha ocurrido un error inesperado",
81 |         variant: "destructive"
82 |       });
83 |       console.error(err);
84 |     } finally {
85 |       setIsLoading(false);
86 |     }
87 |   };
88 |   
89 |   const handleGoogleSignup = async () => {
90 |     try {
91 |       setIsGoogleLoading(true);
92 |       const { error } = await signInWithGoogle();
93 |       
94 |       if (error) {
95 |         toast({
96 |           title: "Error al registrarse con Google",
97 |           description: error.message,
98 |           variant: "destructive"
99 |         });
100 |       }
101 |     } catch (err) {
102 |       toast({
103 |         title: "Error inesperado",
104 |         description: "Ha ocurrido un error al registrarse con Google",
105 |         variant: "destructive"
106 |       });
107 |       console.error(err);
108 |     } finally {
109 |       setIsGoogleLoading(false);
110 |     }
111 |   };
112 |   
113 |   const togglePasswordVisibility = () => setShowPassword(!showPassword);
114 |   const toggleConfirmPasswordVisibility = () => setShowConfirmPassword(!showConfirmPassword);
115 |   
116 |   return (
117 |     <PageTransition>
118 |       <div 
119 |         className="min-h-screen flex flex-col items-center justify-center p-6"
120 |         style={{
121 |           backgroundImage: 'url(/fondo_png.png)',
122 |           backgroundSize: 'cover',
123 |           backgroundPosition: 'center',
124 |           backgroundRepeat: 'no-repeat',
125 |         }}
126 |       >
127 |         <div className="absolute top-4 left-4 z-10">
128 |           <BackButton />
129 |         </div>
130 |         
131 |         <div className="w-full max-w-md bg-white/70 rounded-3xl p-8 shadow-lg border border-[#BB79D1]/20">
132 |           <div className="flex justify-center mb-6">
133 |             <img src="/logo_png.png" alt="TaleMe Logo" className="w-48 max-w-full" />
134 |           </div>
135 |           
136 |           <h1 className="text-3xl font-bold text-[#222] mb-6 text-center">
137 |             Crear Cuenta
138 |           </h1>
139 |           
140 |           <Form {...form}>
141 |             <form 
142 |               onSubmit={form.handleSubmit(handleSignup)} 
143 |               className="space-y-5"
144 |             >
145 |               <FormField
146 |                 control={form.control}
147 |                 name="email"
148 |                 render={({ field }) => (
149 |                   <FormItem>
150 |                     <div className="relative">
151 |                       <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1]" size={20} />
152 |                       <FormControl>
153 |                         <Input
154 |                           placeholder="Correo electrónico"
155 |                           className="pl-10 py-6 rounded-xl bg-white/80 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-1 focus:ring-[#BB79D1] text-[#333]"
156 |                           type="email"
157 |                           {...field}
158 |                           required
159 |                         />
160 |                       </FormControl>
161 |                     </div>
162 |                     <FormMessage className="text-red-500" />
163 |                   </FormItem>
164 |                 )}
165 |               />
166 |               
167 |               <FormField
168 |                 control={form.control}
169 |                 name="password"
170 |                 render={({ field }) => (
171 |                   <FormItem>
172 |                     <div className="relative">
173 |                       <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1]" size={20} />
174 |                       <FormControl>
175 |                         <Input
176 |                           placeholder="Contraseña"
177 |                           className="pl-10 pr-10 py-6 rounded-xl bg-white/80 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-1 focus:ring-[#BB79D1] text-[#333]"
178 |                           type={showPassword ? "text" : "password"}
179 |                           {...field}
180 |                           required
181 |                         />
182 |                       </FormControl>
183 |                       <button 
184 |                         type="button"
185 |                         onClick={togglePasswordVisibility}
186 |                         className="absolute right-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1] hover:text-[#A5D6F6] transition-colors"
187 |                       >
188 |                         {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
189 |                       </button>
190 |                     </div>
191 |                     <FormMessage className="text-red-500" />
192 |                   </FormItem>
193 |                 )}
194 |               />
195 |               
196 |               <FormField
197 |                 control={form.control}
198 |                 name="confirmPassword"
199 |                 render={({ field }) => (
200 |                   <FormItem>
201 |                     <div className="relative">
202 |                       <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1]" size={20} />
203 |                       <FormControl>
204 |                         <Input
205 |                           placeholder="Confirmar contraseña"
206 |                           className="pl-10 pr-10 py-6 rounded-xl bg-white/80 border-[#BB79D1]/30 focus:border-[#BB79D1] focus:ring-1 focus:ring-[#BB79D1] text-[#333]"
207 |                           type={showConfirmPassword ? "text" : "password"}
208 |                           {...field}
209 |                           required
210 |                         />
211 |                       </FormControl>
212 |                       <button 
213 |                         type="button"
214 |                         onClick={toggleConfirmPasswordVisibility}
215 |                         className="absolute right-3 top-1/2 transform -translate-y-1/2 text-[#BB79D1] hover:text-[#A5D6F6] transition-colors"
216 |                       >
217 |                         {showConfirmPassword ? <EyeOff size={20} /> : <Eye size={20} />}
218 |                       </button>
219 |                     </div>
220 |                     <FormMessage className="text-red-500" />
221 |                   </FormItem>
222 |                 )}
223 |               />
224 |               
225 |               <button
226 |                 type="submit"
227 |                 disabled={isLoading}
228 |                 className="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg transition-all duration-200 bg-[#F6A5B7] hover:bg-[#F6A5B7]/80 active:bg-[#F6A5B7]/90 disabled:opacity-60 disabled:cursor-not-allowed"
229 |               >
230 |                 {isLoading ? "Creando cuenta..." : "Crear Cuenta"}
231 |               </button>
232 |               
233 |               <div className="relative flex items-center my-4">
234 |                 <div className="flex-grow border-t border-[#BB79D1]/20"></div>
235 |                 <span className="mx-4 flex-shrink text-[#555] text-sm">O regístrate con</span>
236 |                 <div className="flex-grow border-t border-[#BB79D1]/20"></div>
237 |               </div>
238 |               
239 |               <button
240 |                 type="button"
241 |                 onClick={handleGoogleSignup}
242 |                 disabled={isGoogleLoading}
243 |                 className="w-full flex items-center justify-center gap-2 bg-white text-[#333] rounded-xl py-3 hover:bg-gray-100 transition-colors duration-300 border border-[#BB79D1]/20 shadow-md"
244 |               >
245 |                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px">
246 |                   <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" />
247 |                   <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" />
248 |                   <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" />
249 |                   <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z" />
250 |                 </svg>
251 |                 {isGoogleLoading ? "Conectando..." : "Registrarse con Google"}
252 |               </button>
253 |               
254 |               <div className="text-center mt-5">
255 |                 <span className="text-[#555] text-sm">¿Ya tienes una cuenta? </span>
256 |                 <button
257 |                   type="button"
258 |                   onClick={() => navigate("/login")}
259 |                   className="text-[#BB79D1] font-semibold text-sm hover:underline"
260 |                 >
261 |                   Iniciar Sesión
262 |                 </button>
263 |               </div>
264 |             </form>
265 |           </Form>
266 |         </div>
267 |       </div>
268 |     </PageTransition>
269 |   );
270 | }
```

src/pages/SignupSuccess.tsx
```
1 | import { useNavigate } from "react-router-dom";
2 | import { CheckCircle } from "lucide-react";
3 | import PageTransition from "../components/PageTransition";
4 | import StoryButton from "../components/StoryButton";
5 | 
6 | export default function SignupSuccess() {
7 |   const navigate = useNavigate();
8 |   
9 |   return (
10 |     <PageTransition>
11 |       <div 
12 |         className="min-h-screen flex flex-col items-center justify-center p-6"
13 |         style={{
14 |           backgroundImage: 'url(/fondo_png.png)',
15 |           backgroundSize: 'cover',
16 |           backgroundPosition: 'center',
17 |           backgroundRepeat: 'no-repeat',
18 |         }}
19 |       >
20 |         <div className="w-full max-w-md bg-white/70 rounded-3xl p-8 shadow-lg border border-[#BB79D1]/20 flex flex-col items-center">
21 |           <div className="flex justify-center mb-6">
22 |             <img src="/logo_png.png" alt="TaleMe Logo" className="w-48 max-w-full" />
23 |           </div>
24 |           
25 |           <CheckCircle className="h-24 w-24 text-[#BB79D1] mb-4" />
26 |           
27 |           <h1 className="text-3xl font-bold text-[#222] mb-4 text-center">
28 |             ¡Registro Exitoso!
29 |           </h1>
30 |           
31 |           <p className="text-[#555] text-center mb-8">
32 |             Tu cuenta ha sido creada correctamente. Por favor, revisa tu correo electrónico para confirmar tu registro.
33 |           </p>
34 |           
35 |           <div className="w-full max-w-xs">
36 |             <button
37 |               onClick={() => navigate("/login")}
38 |               className="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg transition-all duration-200 bg-[#F6A5B7] hover:bg-[#F6A5B7]/80 active:bg-[#F6A5B7]/90"
39 |             >
40 |               Ir a Iniciar Sesión
41 |             </button>
42 |           </div>
43 |         </div>
44 |       </div>
45 |     </PageTransition>
46 |   );
47 | } 
```

src/pages/StoryAudioPage.tsx
```
1 | import { useState, useEffect, useRef } from "react";
2 | import { useParams, useNavigate } from "react-router-dom";
3 | import { motion, AnimatePresence } from "framer-motion";
4 | import { Play, Pause, ChevronLeft, ChevronRight, ArrowLeft, Trash2, Brush } from "lucide-react";
5 | import { Button } from "@/components/ui/button";
6 | import { Slider } from "@/components/ui/slider";
7 | import { generateSpeech } from "@/services/ai/ttsService";
8 | import { useStoriesStore } from "../store/stories/storiesStore";
9 | import { useChaptersStore } from "../store/stories/chapters/chaptersStore";
10 | import { useAudioStore } from "../store/stories/audio/audioStore";
11 | import { toast } from "sonner";
12 | import WaveForm from "@/components/WaveForm";
13 | import { STORY_VOICES, PLAYBACK_SPEEDS, CUSTOM_VOICE_MAPPING, PREVIEW_FILES } from "@/constants/story-voices.constant";
14 | import { PreviewVoiceModal } from "@/components/PreviewVoiceModal";
15 | import { createClient, SupabaseClient } from '@supabase/supabase-js';
16 | import { Howl } from 'howler';
17 | import { useUserStore } from "../store/user/userStore";
18 | import { toastManager } from "@/lib/utils";
19 | 
20 | // Configuración del cliente de Supabase
21 | const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
22 | const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
23 | const user = useUserStore.getState().user;
24 | 
25 | if (!supabaseUrl || !supabaseAnonKey) {
26 |   console.error("Supabase URL or Anon Key is missing. Check your .env file.");
27 |   // Podrías lanzar un error o manejar esto de alguna manera
28 | }
29 | 
30 | const supabase: SupabaseClient | null = supabaseUrl && supabaseAnonKey ? createClient(supabaseUrl, supabaseAnonKey) : null;
31 | 
32 | // Playback speeds
33 | 
34 | 
35 | // Audio Wave Loading Animation Component
36 | const AudioWaveLoading = ({ color = "#fff" }) => {
37 |   return (
38 |     <div className="flex items-center justify-center gap-1.5">
39 |       {[1, 2, 3, 4, 5].map((bar) => (
40 |         <motion.div
41 |           key={bar}
42 |           className="w-2 bg-white rounded-full"
43 |           initial={{ height: 10 }}
44 |           animate={{
45 |             height: [10, 32, 10],
46 |             opacity: [0.4, 1, 0.4]
47 |           }}
48 |           transition={{
49 |             duration: 0.8,
50 |             repeat: Infinity,
51 |             delay: bar * 0.15,
52 |             ease: "easeInOut"
53 |           }}
54 |           style={{ backgroundColor: color }}
55 |         />
56 |       ))}
57 |     </div>
58 |   );
59 | };
60 | 
61 | // Format time helper
62 | const formatTime = (seconds: number): string => {
63 |   if (isNaN(seconds)) return "0:00";
64 |   const minutes = Math.floor(seconds / 60);
65 |   const remainingSeconds = Math.floor(seconds % 60);
66 |   return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
67 | };
68 | 
69 | export default function StoryAudioPage() {
70 |   const { storyId, chapterId } = useParams<{ storyId: string, chapterId?: string }>();
71 |   const navigate = useNavigate();
72 |   const { getStoryById } = useStoriesStore();
73 |   const { getChaptersByStoryId, loadChaptersFromSupabase } = useChaptersStore();
74 |   const {
75 |     setGenerationStatus,
76 |     getGenerationStatus,
77 |     setCurrentVoice,
78 |     getCurrentVoice,
79 |   } = useAudioStore();
80 | 
81 |   const [isPlaying, setIsPlaying] = useState(false);
82 |   const [isLoading, setIsLoading] = useState(false);
83 |   const [currentTime, setCurrentTime] = useState(0);
84 |   const [duration, setDuration] = useState(0);
85 |   const [audioUrl, setAudioUrl] = useState<string | null>(null);
86 |   const [voiceIndex, setVoiceIndex] = useState(0);
87 |   const [playbackSpeedIndex, setPlaybackSpeedIndex] = useState(1); // Default to 1x (index 1)
88 |   const [showGenerationPopup, setShowGenerationPopup] = useState(false);
89 |   const [generationProgress, setGenerationProgress] = useState(0);
90 |   const [audioIntensity, setAudioIntensity] = useState(0.5);
91 |   
92 |   // Referencia a la instancia de Howler
93 |   const howlRef = useRef<Howl | null>(null);
94 |   
95 |   // Timer para actualizar currentTime
96 |   const timerRef = useRef<NodeJS.Timeout | null>(null);
97 |   
98 |   // Referencia para análisis de audio (visualización)
99 |   const audioContextRef = useRef<AudioContext | null>(null);
100 |   const analyserRef = useRef<AnalyserNode | null>(null);
101 |   const dataArrayRef = useRef<Uint8Array | null>(null);
102 | 
103 |   // Get selected voice and playback speed
104 |   const selectedVoice = STORY_VOICES[voiceIndex];
105 |   const playbackSpeed = PLAYBACK_SPEEDS[playbackSpeedIndex];
106 | 
107 |   const [showPreviewModal, setShowPreviewModal] = useState(false);
108 |   const [previewUrl, setPreviewUrl] = useState<string | null>(null);
109 |   
110 |   // Set currentVoice in store when it changes
111 |   useEffect(() => {
112 |     setCurrentVoice(selectedVoice.id);
113 |   }, [selectedVoice.id, setCurrentVoice]);
114 | 
115 |   // Initialize voice from store if available
116 |   useEffect(() => {
117 |     const savedVoice = getCurrentVoice();
118 |     if (savedVoice) {
119 |       const voiceIdx = STORY_VOICES.findIndex(v => v.id === savedVoice);
120 |       if (voiceIdx !== -1) {
121 |         setVoiceIndex(voiceIdx);
122 |       }
123 |     }
124 |   }, [getCurrentVoice]);
125 | 
126 |   // Load story data
127 |   useEffect(() => {
128 |     if (storyId) {
129 |       // Cargar la historia como ya lo haces
130 |       const story = getStoryById(storyId);
131 |       if (!story) {
132 |         navigate("/not-found");
133 |         return;
134 |       }
135 |       
136 |       // Añadir carga de capítulos frescos
137 |       loadChaptersFromSupabase(storyId).catch(() => 
138 |         toast.error("Error cargando capítulos")
139 |       );
140 |     }
141 |   }, [storyId, navigate, getStoryById, loadChaptersFromSupabase]);
142 | 
143 |   // Get story content
144 |   const story = storyId ? getStoryById(storyId) : null;
145 |   const chapters = storyId ? getChaptersByStoryId(storyId) : [];
146 |   const currentChapterIndex = chapterId ? parseInt(chapterId, 10) : 0;
147 | 
148 |   // If no valid chapter or story, use a placeholder
149 |   const title = chapters.length > 0 && currentChapterIndex < chapters.length
150 |     ? chapters[currentChapterIndex].title || story?.title
151 |     : story?.title || "Historia";
152 | 
153 |   const content = chapters.length > 0 && currentChapterIndex < chapters.length
154 |     ? chapters[currentChapterIndex].content
155 |     : story?.content || "";
156 | 
157 |   // Estado para controlar si ya se mostró un toast para la combinación actual
158 |   const [lastAudioState, setLastAudioState] = useState<{
159 |     storyId: string | null;
160 |     chapterIndex: number | null;
161 |     voiceId: string | null;
162 |     hasAudio: boolean | null;
163 |   }>({
164 |     storyId: null,
165 |     chapterIndex: null,
166 |     voiceId: null,
167 |     hasAudio: null
168 |   });
169 | 
170 |   // Nueva función para obtener audio desde Supabase
171 |   const getAudioFromSupabase = async (storyIdToFetch: string, chapterIdx: number, voiceIdToFetch: string) => {
172 |     if (!supabase) {
173 |       console.error("Cliente Supabase no inicializado.");
174 |       return null;
175 |     }
176 |     if (!chapters[chapterIdx]) {
177 |       return null;
178 |     }
179 | 
180 |     const chapter = chapters[chapterIdx];
181 |     if (!chapter || !chapter.id) {
182 |       return null;
183 |     }
184 | 
185 |     try {
186 |       // Buscar en la tabla chapter_audio_files
187 |       const { data, error } = await supabase
188 |         .from('audio_files')
189 |         .select('*')
190 |         .eq('chapter_id', chapter.id)
191 |         .eq('voice_id', voiceIdToFetch)
192 |         .eq('user_id', user.id || '')
193 |         .maybeSingle();
194 | 
195 |       if (error && error.code !== 'PGRST116') {
196 |         console.error('Error al buscar audio existente:', error.message);
197 |         return null;
198 |       }
199 | 
200 |       // Si encontramos el registro en la base de datos, usar su public_url
201 |       if (data && data.public_url) {
202 |         return data.public_url;
203 |       }
204 |       
205 |       // Si no se encontró el audio, verificar si existe físicamente en Storage
206 |       const expectedPath = `${storyIdToFetch}/${chapter.id}/${voiceIdToFetch}.mp3`;
207 |       
208 |       // Verificar si el archivo existe realmente en el bucket antes de devolver la URL
209 |       const { data: existsData, error: existsError } = await supabase.storage
210 |         .from('narrations')
211 |         .list(storyIdToFetch, {
212 |           search: `${chapter.id}/${voiceIdToFetch}.mp3`
213 |         });
214 |         
215 |       if (existsError) {
216 |         console.error('Error al verificar existencia del archivo:', existsError);
217 |         return null;
218 |       }
219 |       
220 |       
221 |       // Solo si el archivo existe realmente, devolver la URL pública
222 |       if (existsData && existsData.length > 0) {
223 |         const { data: fileData } = await supabase.storage
224 |           .from('narrations')
225 |           .getPublicUrl(expectedPath);
226 |         
227 |         if (fileData && fileData.publicUrl) {
228 |           return fileData.publicUrl;
229 |         }
230 |       }
231 |       
232 |       return null;
233 |     } catch (e) {
234 |       console.error('Error al buscar audio existente:', e);
235 |       return null;
236 |     }
237 |   };
238 | 
239 |   // Efecto para cargar audio existente con control de toasts mejorado
240 |   useEffect(() => {
241 |     const loadAudio = async () => {
242 |       if (!storyId || currentChapterIndex === undefined || !selectedVoice || chapters.length === 0 || !chapters[currentChapterIndex]) {
243 |         setAudioUrl(null);
244 |         return;
245 |       }
246 | 
247 |       const chapter = chapters[currentChapterIndex];
248 |       if (!chapter?.id) {
249 |         setAudioUrl(null);
250 |         return;
251 |       }
252 | 
253 |       // Verificar si ya procesamos esta combinación para evitar toasts duplicados
254 |       const currentState = {
255 |         storyId,
256 |         chapterIndex: currentChapterIndex,
257 |         voiceId: selectedVoice.id,
258 |         hasAudio: null
259 |       };
260 | 
261 |       const isNewCombination = (
262 |         lastAudioState.storyId !== currentState.storyId ||
263 |         lastAudioState.chapterIndex !== currentState.chapterIndex ||
264 |         lastAudioState.voiceId !== currentState.voiceId
265 |       );
266 | 
267 |       if (!isNewCombination) {
268 |         return; // No hacer nada si es la misma combinación
269 |       }
270 | 
271 |       setIsLoading(true);
272 |       setAudioUrl(null);
273 |       
274 |       // Limpiar toasts previos solo cuando cambiamos de combinación
275 |       toastManager.clear();
276 | 
277 |       try {
278 |         const url = await getAudioFromSupabase(storyId, currentChapterIndex, selectedVoice.id);
279 |         
280 |         const newStateWithAudio = {
281 |           ...currentState,
282 |           hasAudio: !!url
283 |         };
284 |         
285 |         setLastAudioState(newStateWithAudio);
286 |         
287 |         if (url) {
288 |           setAudioUrl(url);
289 |           // Solo mostrar toast de éxito si es una nueva combinación
290 |           if (isNewCombination) {
291 |             toastManager.show('success', "Audio cargado correctamente");
292 |           }
293 |         } else {
294 |           setAudioUrl(null);
295 |           // Solo mostrar toast de info si es una nueva combinación
296 |           if (isNewCombination) {
297 |             toastManager.show('info', "No hay audio grabado para esta voz y capítulo");
298 |           }
299 |         }
300 |       } catch (error) {
301 |         console.error('Error loading audio:', error);
302 |         setAudioUrl(null);
303 |         setLastAudioState({
304 |           ...currentState,
305 |           hasAudio: false
306 |         });
307 |         
308 |         if (isNewCombination) {
309 |           toastManager.show('error', "Error al cargar el audio");
310 |         }
311 |       } finally {
312 |         setIsLoading(false);
313 |       }
314 |     };
315 | 
316 |     loadAudio();
317 |   }, [storyId, currentChapterIndex, selectedVoice?.id, chapters]);
318 | 
319 | 
320 |   // Configurar Howler cuando cambia el audioUrl
321 |   useEffect(() => {
322 |     // Limpiar instancia anterior
323 |     if (howlRef.current) {
324 |       howlRef.current.unload();
325 |       howlRef.current = null;
326 |     }
327 | 
328 |     // Limpiar timer de actualización
329 |     if (timerRef.current) {
330 |       clearInterval(timerRef.current);
331 |       timerRef.current = null;
332 |     }
333 | 
334 |     if (!audioUrl) return;
335 | 
336 |     setIsLoading(true);
337 | 
338 |     // Crear nueva instancia de Howl
339 |     const howl = new Howl({
340 |       src: [audioUrl],
341 |       html5: true, // Mejor para streaming
342 |       preload: true,
343 |       format: ['mp3'],
344 |       onload: () => {
345 |         setIsLoading(false);
346 |         setDuration(howl.duration());
347 |       },
348 |       onloaderror: () => {
349 |         setIsLoading(false);
350 |         toastManager.show('error', "No se pudo cargar el audio", "Posible problema de CORS o formato");
351 |       },
352 |       onplay: () => {
353 |         setIsPlaying(true);
354 |         
355 |         // Actualizar la posición cada 100ms durante la reproducción
356 |         if (timerRef.current) clearInterval(timerRef.current);
357 |         timerRef.current = setInterval(() => {
358 |           if (howlRef.current) {
359 |             setCurrentTime(howlRef.current.seek() as number);
360 |           }
361 |         }, 100);
362 |       },
363 |       onpause: () => {
364 |         setIsPlaying(false);
365 |         if (timerRef.current) {
366 |           clearInterval(timerRef.current);
367 |           timerRef.current = null;
368 |         }
369 |       },
370 |       onstop: () => {
371 |         setIsPlaying(false);
372 |         if (timerRef.current) {
373 |           clearInterval(timerRef.current);
374 |           timerRef.current = null;
375 |         }
376 |       },
377 |       onend: () => {
378 |         setIsPlaying(false);
379 |         setCurrentTime(howl.duration());
380 |         if (timerRef.current) {
381 |           clearInterval(timerRef.current);
382 |           timerRef.current = null;
383 |         }
384 |       },
385 |       onseek: () => {
386 |         // Actualizar el tiempo cuando se busca manualmente
387 |         if (howlRef.current) {
388 |           setCurrentTime(howlRef.current.seek() as number);
389 |         }
390 |       }
391 |     });
392 | 
393 |     // Establecer velocidad de reproducción
394 |     howl.rate(playbackSpeed);
395 |     
396 |     // Guardar referencia
397 |     howlRef.current = howl;
398 |   }, [audioUrl]);
399 | 
400 |   // Actualizar velocidad de reproducción cuando cambia
401 |   useEffect(() => {
402 |     if (howlRef.current) {
403 |       howlRef.current.rate(playbackSpeed);
404 |     }
405 |   }, [playbackSpeed]);
406 | 
407 |   // Limpiar recursos al desmontar
408 |   useEffect(() => {
409 |     return () => {
410 |       if (howlRef.current) {
411 |         howlRef.current.unload();
412 |       }
413 |       if (timerRef.current) {
414 |         clearInterval(timerRef.current);
415 |       }
416 |       if (audioContextRef.current && audioContextRef.current.state !== 'closed') {
417 |         audioContextRef.current.close();
418 |       }
419 |     };
420 |   }, []);
421 | 
422 |   const handlePreviewVoice = (voiceId: string) => {
423 |    
424 |     const url = PREVIEW_FILES[voiceId];
425 |     if (!url) {
426 |       toastManager.show('error', "Vista previa no disponible para esta voz");
427 |       return;
428 |     }
429 |     setPreviewUrl(url);
430 |     setShowPreviewModal(true);
431 |   };
432 | 
433 |   // Handle voice change with arrow navigation
434 |   const handlePreviousVoice = () => {
435 |     toastManager.clear(); // Limpiar toasts al cambiar voz
436 |     setVoiceIndex((prev) => (prev === 0 ? STORY_VOICES.length - 1 : prev - 1));
437 |   };
438 | 
439 |   const handleNextVoice = () => {
440 |     toastManager.clear(); // Limpiar toasts al cambiar voz
441 |     setVoiceIndex((prev) => (prev === STORY_VOICES.length - 1 ? 0 : prev + 1));
442 |   };
443 | 
444 |   // Handle playback speed change - cycle through speeds
445 |   const handleSpeedChange = () => {
446 |     setPlaybackSpeedIndex((prev) => (prev === PLAYBACK_SPEEDS.length - 1 ? 0 : prev + 1));
447 |   };
448 | 
449 |   // Manejo de play/pause con Howler
450 |   const handlePlayPause = () => {
451 |     if (!audioUrl) {
452 |       setShowGenerationPopup(true);
453 |       return;
454 |     }
455 | 
456 |     if (!howlRef.current) {
457 |       toastManager.show('error', "Reproductor no inicializado");
458 |       return;
459 |     }
460 | 
461 |     if (isPlaying) {
462 |       howlRef.current.pause();
463 |     } else {
464 |       howlRef.current.play();
465 |     }
466 |   };
467 | 
468 |   // Manejar el avance/retroceso en el slider
469 |   const handleSeek = (value: number[]) => {
470 |     if (!howlRef.current) return;
471 |     
472 |     const seekTime = value[0];
473 |     howlRef.current.seek(seekTime);
474 |     setCurrentTime(seekTime);
475 |   };
476 | 
477 |   const handleEndedEvent = () => {
478 |     setIsPlaying(false);
479 |     setCurrentTime(duration);
480 |   };
481 | 
482 |   // Generar audio
483 |   const handleGenerateAudio = async () => {
484 |     try {
485 |       setIsLoading(true);
486 |       setGenerationStatus(storyId || '', currentChapterIndex, 'generating', 10);
487 |       setGenerationProgress(10);
488 | 
489 |       // Simular progreso
490 |       const progressInterval = setInterval(() => {
491 |         setGenerationProgress(prev => {
492 |           const newValue = prev + Math.random() * 15;
493 |           const progress = newValue > 90 ? 90 : newValue;
494 |           setGenerationStatus(storyId || '', currentChapterIndex, 'generating', progress);
495 |           return progress;
496 |         });
497 |       }, 800);
498 | 
499 |       // Validar capítulo actual
500 |       const chapter = chapters[currentChapterIndex];
501 |       if (!chapter || !chapter.id) {
502 |         toast.error("Error: No se pudo identificar el capítulo");
503 |         setIsLoading(false);
504 |         setShowGenerationPopup(false);
505 |         clearInterval(progressInterval);
506 |         setGenerationStatus(storyId || '', currentChapterIndex, 'error', 0);
507 |         return;
508 |       }
509 | 
510 |       // Liberar URL anterior y howl
511 |       if (audioUrl) {
512 |         setAudioUrl(null);
513 |       }
514 |       if (howlRef.current) {
515 |         howlRef.current.unload();
516 |         howlRef.current = null;
517 |       }
518 | 
519 |       // Mapeo de voces para OpenAI
520 |       const mappedVoice = CUSTOM_VOICE_MAPPING[selectedVoice.id] || 'nova';
521 |       
522 |       // Generar audio con OpenAI TTS
523 |       const audioBlob = await generateSpeech({
524 |         text: content,
525 |         voice: mappedVoice,
526 |         model: 'gpt-4o-mini-tts',
527 |         instructions: selectedVoice.instructions
528 |       });
529 | 
530 |       // Preparar para subir a Supabase
531 |       const audioFile = new File([audioBlob], `${selectedVoice.id}_audio.mp3`, { type: 'audio/mpeg' });
532 | 
533 |       const formData = new FormData();
534 |       formData.append('userId', user.id || '');
535 |       formData.append('chapterId', chapter.id);
536 |       formData.append('voiceId', selectedVoice.id);
537 |       formData.append('audioFile', audioFile);
538 |       formData.append('storyId', storyId || '');
539 |       
540 |       // Indicar fase de subida
541 |       setGenerationStatus(storyId || '', currentChapterIndex, 'generating', 95);
542 | 
543 |       if (!supabase) {
544 |         toast.error("Cliente Supabase no inicializado");
545 |         setIsLoading(false);
546 |         setShowGenerationPopup(false);
547 |         clearInterval(progressInterval);
548 |         setGenerationStatus(storyId || '', currentChapterIndex, 'error', 0);
549 |         return;
550 |       }
551 | 
552 |       // Invocar Edge Function para subir audio
553 |       const { data: functionResponse, error: functionError } = await supabase.functions.invoke(
554 |         'upload-chapter-audio',
555 |         { body: formData }
556 |       );
557 | 
558 |       clearInterval(progressInterval);
559 | 
560 |       if (functionError) {
561 |         toast.error(`Error al subir el audio: ${functionError.message || 'Error desconocido'}`);
562 |         setGenerationStatus(storyId || '', currentChapterIndex, 'error', 0);
563 |         setIsLoading(false);
564 |         setShowGenerationPopup(false);
565 |         return;
566 |       }
567 | 
568 |       if (functionResponse && functionResponse.publicUrl) {
569 |         setAudioUrl(functionResponse.publicUrl);
570 |         setGenerationStatus(storyId || '', currentChapterIndex, 'completed', 100);
571 |         setShowGenerationPopup(false);
572 |         setGenerationProgress(100);
573 |         toast.success("Audio generado y guardado");
574 |       } else {
575 |         toast.error("Error al procesar la respuesta del servidor");
576 |         setGenerationStatus(storyId || '', currentChapterIndex, 'error', 0);
577 |       }
578 |       
579 |     } catch (error) {
580 |       toast.error(`Error: ${error instanceof Error ? error.message : 'Problema desconocido'}`);
581 |       setGenerationStatus(storyId || '', currentChapterIndex, 'error', 0);
582 |     } finally {
583 |       setIsLoading(false);
584 |       setShowGenerationPopup(false);
585 |     }
586 |   };
587 | 
588 |   // Eliminar funciones de manejo de caché local
589 |   const handleCleanAllAudio = () => {
590 |     if (howlRef.current) {
591 |       howlRef.current.pause();
592 |       howlRef.current.unload();
593 |       howlRef.current = null;
594 |     }
595 |     
596 |     if (audioUrl) {
597 |       setAudioUrl(null);
598 |     }
599 |     
600 |     setIsPlaying(false);
601 |   };
602 | 
603 |   return (
604 |     <div
605 |       className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden"
606 |       style={{
607 |         backgroundImage: 'url("/fondo_png.png")',
608 |         backgroundSize: 'cover',
609 |         backgroundPosition: 'center',
610 |         backgroundRepeat: 'no-repeat'
611 |       }}
612 |     >
613 |       {/* Overlay con el color de la voz seleccionada para mantener la identidad visual */}
614 |       <div 
615 |         className="absolute inset-0 z-0 opacity-70"
616 |         style={{ backgroundColor: selectedVoice.color }}
617 |       />
618 |       
619 |       {/* Content container with podcast player design */}
620 |       <div className="relative z-10 w-full max-w-sm rounded-3xl overflow-hidden bg-white/10 backdrop-blur-md shadow-2xl">
621 |         {/* Header with podcast title - Restructured for better title visibility */}
622 |         <div className="p-5 flex flex-col space-y-3">
623 |           {/* Back button and title row - removed width constraints */}
624 |           <div className="flex items-center space-x-3">
625 |             <button
626 |               onClick={() => navigate(`/story/${storyId}`)}
627 |               className="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-all flex-shrink-0"
628 |             >
629 |               <ArrowLeft size={20} className="text-gray-800" />
630 |             </button>
631 |             <h1 className="text-lg font-semibold text-gray-800 flex-grow">
632 |               {title}
633 |             </h1>
634 |             {/* <button
635 |               onClick={async () => {
636 |                 if (storyId) {
637 |                   toast.info("Refrescando datos de capítulos...");
638 |                   try {
639 |                     await loadChaptersFromSupabase(storyId);
640 |                     toast.success("Capítulos actualizados.");
641 |                   } catch (error) {
642 |                     toast.error("Error al actualizar capítulos.");
643 |                   }
644 |                 }
645 |               }}
646 |               title="Refrescar capítulos"
647 |               className="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-all flex-shrink-0"
648 |             >
649 |               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-800">
650 |                 <path d="M21 2v6h-6"></path>
651 |                 <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
652 |                 <path d="M3 12a9 9 0 0 0 6.7 15L13 22"></path>
653 |                 <path d="M14.3 19.1L21 22v-6"></path>
654 |               </svg>
655 |             </button> */}
656 |           </div>
657 |         </div>
658 | 
659 |         {/* Main content */}
660 |         <div className="relative aspect-square overflow-hidden">
661 |           {/* Waveform background */}
662 |           <div className="absolute inset-0">
663 |             <WaveForm
664 |               isPlaying={isPlaying}
665 |               color={selectedVoice.color}
666 |               intensity={audioIntensity}
667 |             />
668 |           </div>
669 | 
670 |           {/* Center content with play button */}
671 |           <div className="absolute inset-0 flex flex-col items-center justify-center">
672 |             {/* Narrator indicator - small and subtle */}
673 |             <div className="mb-4 text-center w-32">
674 |               <span className="text-lg opacity-80 text-gray-800">{selectedVoice.icon}</span>
675 |               <p className="text-xs font-medium text-gray-800/80">{selectedVoice.name}</p>
676 |             </div>
677 | 
678 |             {/* Play button */}
679 |             <button
680 |               onClick={handlePlayPause}
681 |               disabled={isLoading}
682 |               className="w-20 h-20 rounded-full bg-white flex items-center justify-center shadow-lg focus:outline-none hover:scale-105 transition-transform"
683 |             >
684 |               {isLoading ? (
685 |                 <AudioWaveLoading color={selectedVoice.color} />
686 |               ) : isPlaying ? (
687 |                 <Pause className="w-10 h-10" style={{ color: selectedVoice.color }} />
688 |               ) : (
689 |                 <Play className="w-10 h-10 ml-1" style={{ color: selectedVoice.color }} />
690 |               )}
691 |             </button>
692 | 
693 |             {/* Time display */}
694 |             <div className="mt-8 text-center">
695 |               <p className="text-sm font-medium text-gray-800/80">
696 |                 {formatTime(currentTime)} / {formatTime(duration || 0)}
697 |               </p>
698 |             </div>
699 |           </div>
700 |         </div>
701 | 
702 |         {/* Controls section */}
703 |         <div className="px-5 pt-4 pb-5 bg-black/10">
704 |           {/* Progress bar */}
705 |           <Slider
706 |             value={[currentTime]}
707 |             max={duration || 100}
708 |             step={0.1}
709 |             onValueChange={handleSeek}
710 |             disabled={!audioUrl}
711 |             className="mb-5"
712 |           />
713 | 
714 |           {/* Botón para escuchar al narrador */}
715 |           <button
716 |             onClick={() => handlePreviewVoice(selectedVoice.id)}
717 |             className="w-full flex items-center justify-center py-2.5 px-4 rounded-full text-sm font-medium bg-white/20 text-gray-800 hover:bg-white/30 mt-0 mb-4 transition-all"
718 |           >
719 |             <Play size={18} className="mr-2 text-gray-800" />
720 |             Voz de la narración
721 |           </button>
722 | 
723 |           {/* Voice selector - moved to top of controls for better visibility */}
724 |           <div className="mb-4 flex justify-center items-center bg-white/10 py-2 px-3 rounded-full">
725 |             <button
726 |               onClick={handlePreviousVoice}
727 |               className="p-2 text-gray-800/80 hover:text-gray-800 flex-shrink-0"
728 |             >
729 |               <ChevronLeft size={22} />
730 |             </button>
731 |             <div className="flex flex-col items-center mx-3 flex-grow">
732 |               <span className="text-xl opacity-80 text-gray-800">{selectedVoice.icon}</span>
733 |               <span className="text-sm font-medium text-gray-800/90">{selectedVoice.name}</span>
734 |             </div>
735 |             <button
736 |               onClick={handleNextVoice}
737 |               className="p-2 text-gray-800/80 hover:text-gray-800 flex-shrink-0"
738 |             >
739 |               <ChevronRight size={22} />
740 |             </button>
741 |           </div>
742 | 
743 |           {/* Bottom controls row */}
744 |           <div className="flex justify-between items-center">
745 |             {/* Return to reading button - enlarged */}
746 |             <button
747 |               onClick={() => navigate(`/story/${storyId}`)}
748 |               className="py-2.5 px-5 rounded-full text-sm font-medium bg-white/20 text-gray-800 hover:bg-white/30 flex-grow-0"
749 |             >
750 |               Volver a la lectura
751 |             </button>
752 |             
753 |             {/* Playback speed - enlarged */}
754 |             <button
755 |               onClick={handleSpeedChange}
756 |               className="py-2.5 px-5 rounded-full text-sm font-medium bg-white/20 text-gray-800 hover:bg-white/30 ml-3"
757 |             >
758 |               {playbackSpeed}x
759 |             </button>
760 |           </div>
761 |         </div>
762 |       </div>
763 | 
764 |       {/* Voice generation popup */}
765 |       {showGenerationPopup && (
766 |         <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-6">
767 |           <motion.div
768 |             initial={{ opacity: 0, scale: 0.9 }}
769 |             animate={{ opacity: 1, scale: 1 }}
770 |             className="w-full max-w-sm rounded-3xl p-6 text-white shadow-2xl"
771 |             style={{ backgroundColor: selectedVoice.color }}
772 |           >
773 |             <div className="text-center mb-4">
774 |               <span className="text-5xl mb-4 inline-block">{selectedVoice.icon}</span>
775 |               <h3 className="text-xl font-bold mb-2">{selectedVoice.name}</h3>
776 |               <p className="text-gray-800 mb-5 text-sm">{selectedVoice.description}</p>
777 | 
778 |               {isLoading ? (
779 |                 <>
780 |                   <div className="w-full bg-white/20 rounded-full h-2 mb-3">
781 |                     <div
782 |                       className="bg-white h-2 rounded-full transition-all duration-300"
783 |                       style={{ width: `${generationProgress}%` }}
784 |                     ></div>
785 |                   </div>
786 |                   <p className="text-gray-800 text-sm">Generando audio, por favor espera...</p>
787 |                 </>
788 |               ) : (
789 |                 <button
790 |                   onClick={handleGenerateAudio}
791 |                   className="w-full py-3 rounded-full bg-white/20 hover:bg-white/30 text-gray-800"
792 |                 >
793 |                   Generar Audio
794 |                 </button>
795 |               )}
796 |             </div>
797 | 
798 |             {!isLoading && (
799 |               <button
800 |                 onClick={() => setShowGenerationPopup(false)}
801 |                 className="w-full py-2 text-gray-800/80 hover:text-gray-800 hover:bg-white/10 text-sm"
802 |               >
803 |                 Cancelar
804 |               </button>
805 |             )}
806 |           </motion.div>
807 |         </div>
808 |       )}
809 |       {previewUrl && (
810 |         <PreviewVoiceModal
811 |           voice={selectedVoice}
812 |           url={previewUrl}
813 |           open={showPreviewModal}
814 |           onClose={() => {
815 |             setShowPreviewModal(false);
816 |             setPreviewUrl(null);
817 |           }}
818 |         />
819 |       )}
820 |     </div>
821 |   );
822 | }
```

src/pages/StoryContinuation.tsx
```
1 | // src/pages/StoryContinuation.tsx
2 | // VERSIÓN CORREGIDA para manejar la respuesta { content, title } del servicio
3 | 
4 | import React, { useState, useEffect, useCallback } from "react";
5 | import { useParams, useNavigate, useLocation } from "react-router-dom";
6 | import { motion } from "framer-motion";
7 | import { BookOpen } from "lucide-react";
8 | import { useStoriesStore } from "../store/stories/storiesStore";
9 | import { useChaptersStore } from "../store/stories/chapters/chaptersStore";
10 | import { useUserStore } from "../store/user/userStore";
11 | import BackButton from "../components/BackButton";
12 | import PageTransition from "../components/PageTransition";
13 | import StoryContinuationOptions from "../components/StoryContinuationOptions";
14 | import StoryContinuationCustomInput from "../components/StoryContinuationCustomInput";
15 | import { toast } from "sonner";
16 | import { Story, StoryChapter as StoryChapterType } from "../types";
17 | import { StoryContinuationService } from "../services/ai/StoryContinuationService";
18 | import { generateId } from "../store/core/utils";
19 | import IconLoadingAnimation from "../components/IconLoadingAnimation";
20 | 
21 | export default function StoryContinuation() {
22 |   const { storyId } = useParams<{ storyId: string }>();
23 |   const navigate = useNavigate();
24 |   const location = useLocation();
25 |   const { getStoryById } = useStoriesStore();
26 |   const { getChaptersByStoryId, addChapter } = useChaptersStore();
27 |   const { canContinueStory } = useUserStore();
28 | 
29 |   const [isLoading, setIsLoading] = useState(false);
30 |   const [isLoadingOptions, setIsLoadingOptions] = useState(false);
31 |   const [showCustomInput, setShowCustomInput] = useState(false);
32 |   const [continuationOptions, setContinuationOptions] = useState<{ summary: string }[]>([]);
33 |   const [story, setStory] = useState<Story | null>(null);
34 |   const [chapters, setChapters] = useState<StoryChapterType[]>([]);
35 |   const [shouldGenerateOptions, setShouldGenerateOptions] = useState(true);
36 |   const [isAllowedToContinue, setIsAllowedToContinue] = useState(true);
37 | 
38 |   useEffect(() => {
39 |     if (!storyId) {
40 |       navigate("/home");
41 |       return;
42 |     }
43 | 
44 |     const fetchedStory = getStoryById(storyId);
45 |     if (!fetchedStory) {
46 |       toast.error("Historia no encontrada");
47 |       navigate("/saved-stories");
48 |       return;
49 |     }
50 |     setStory(fetchedStory);
51 | 
52 |     const existingChapters = getChaptersByStoryId(storyId);
53 |     let currentChapters: StoryChapterType[];
54 | 
55 |     if (existingChapters.length === 0 && fetchedStory.content) {
56 |       const initialChapter: StoryChapterType = {
57 |         chapterNumber: 1,
58 |         title: fetchedStory.title || "Capítulo 1",
59 |         content: fetchedStory.content,
60 |         createdAt: fetchedStory.createdAt,
61 |       };
62 |       currentChapters = [initialChapter];
63 |     } else {
64 |       currentChapters = existingChapters;
65 |     }
66 |     setChapters(currentChapters);
67 | 
68 |     const allowed = canContinueStory(storyId);
69 |     setIsAllowedToContinue(allowed);
70 |     if (!allowed) {
71 |       toast.info("Has alcanzado el límite de continuación gratuita para esta historia.");
72 |     }
73 | 
74 |   }, [storyId, getStoryById, getChaptersByStoryId, navigate, canContinueStory]);
75 | 
76 |   useEffect(() => {
77 |     if (isAllowedToContinue) {
78 |       setShouldGenerateOptions(true);
79 |     }
80 |   }, [location.search, isAllowedToContinue]);
81 | 
82 |   const generateOptions = useCallback(async () => {
83 |     if (!story || chapters.length === 0 || !isAllowedToContinue) return;
84 | 
85 |     console.log(`Generating options for story ${story.id}`);
86 |     setIsLoadingOptions(true);
87 |     setContinuationOptions([]);
88 |     try {
89 |       // Obtener profileSettings para pasar childAge y specialNeed
90 |       const profileSettings = useUserStore.getState().profileSettings;
91 |       
92 |       const response = await StoryContinuationService.generateContinuationOptions(
93 |         story, 
94 |         chapters,
95 |         profileSettings?.childAge,
96 |         profileSettings?.specialNeed
97 |       );
98 |       if (response?.options?.length === 3) {
99 |         setContinuationOptions(response.options);
100 |       } else {
101 |         console.warn("generateOptions: No se recibieron 3 opciones válidas. Usando defaults.");
102 |         throw new Error("Fallback");
103 |       }
104 |     } catch (error) {
105 |       console.error("Error generating continuation options:", error);
106 |       toast.error("No se pudieron generar las opciones. Intenta de nuevo.");
107 |       setContinuationOptions([
108 |         { summary: "Explorar el misterioso jardín." },
109 |         { summary: "Seguir al pájaro parlanchín." },
110 |         { summary: "Preguntar al viejo árbol sabio." }
111 |       ]);
112 |     } finally {
113 |       setIsLoadingOptions(false);
114 |     }
115 |   }, [story, chapters, isAllowedToContinue]);
116 | 
117 |   useEffect(() => {
118 |     if (story && chapters.length > 0 && shouldGenerateOptions && isAllowedToContinue) {
119 |       generateOptions();
120 |       setShouldGenerateOptions(false);
121 |     }
122 |   }, [chapters, story, shouldGenerateOptions, generateOptions, isAllowedToContinue]);
123 | 
124 |   const handleGenerateAndSaveChapter = useCallback(async (
125 |     generationPromise: Promise<{ content: string; title: string }>,
126 |     generationMethod: StoryChapterType['generationMethod'],
127 |     customInput?: string
128 |   ) => {
129 |     if (!story || !storyId || !isAllowedToContinue) {
130 |       toast.error("No puedes continuar esta historia (límite alcanzado).");
131 |       return;
132 |     }
133 | 
134 |     setIsLoading(true);
135 |     toast.loading("Generando continuación...");
136 | 
137 |     try {
138 |       const nextChapterNumber = chapters.length + 1;
139 |       const { content, title } = await generationPromise;
140 | 
141 |       const newChapter: StoryChapterType = {
142 |         chapterNumber: nextChapterNumber,
143 |         title: title || `Capítulo ${nextChapterNumber}`,
144 |         content: content,
145 |         createdAt: new Date().toISOString(),
146 |         generationMethod: generationMethod,
147 |         ...(customInput && { customInput: customInput })
148 |       };
149 | 
150 |       await addChapter(storyId, newChapter);
151 | 
152 |       const updatedChapters = [...chapters, newChapter];
153 |       setChapters(updatedChapters);
154 | 
155 |       toast.dismiss();
156 |       toast.success("¡Continuación generada con éxito!");
157 | 
158 |       setShouldGenerateOptions(true);
159 | 
160 |       navigate(`/story/${storyId}?chapter=${newChapter.chapterNumber - 1}`);
161 | 
162 |     } catch (error: any) {
163 |       console.error("Error al generar continuación:", error);
164 |       toast.dismiss();
165 |       toast.error("Error al generar la continuación", {
166 |         description: error?.message || "Inténtalo de nuevo.",
167 |       });
168 |     } finally {
169 |       setIsLoading(false);
170 |     }
171 |   }, [story, storyId, isAllowedToContinue, addChapter, chapters, navigate]);
172 | 
173 |   const handleSelectFree = () => {
174 |     if (!story) return; // Añadir guarda por si acaso
175 |     // Obtener el estado MÁS ACTUAL de los capítulos ANTES de enviar
176 |     const currentChaptersFromStore = useChaptersStore.getState().getChaptersByStoryId(story.id);
177 |     console.log(`[StoryContinuation] Passing ${currentChaptersFromStore.length} chapters to freeContinuation service.`);
178 | 
179 |     handleGenerateAndSaveChapter(
180 |       // Pasar los capítulos correctos del store
181 |       StoryContinuationService.generateFreeContinuation(story, currentChaptersFromStore),
182 |       "free"
183 |     );
184 |   };
185 | 
186 |   const handleSelectOption = (index: number) => {
187 |     if (!story) return; // Añadir guarda
188 |     const selectedOptionSummary = continuationOptions[index]?.summary;
189 |     if (!selectedOptionSummary) {
190 |       toast.error("Opción seleccionada no válida.");
191 |       return;
192 |     }
193 |     // Obtener el estado MÁS ACTUAL de los capítulos ANTES de enviar
194 |     const currentChaptersFromStore = useChaptersStore.getState().getChaptersByStoryId(story.id);
195 |     console.log(`[StoryContinuation] Passing ${currentChaptersFromStore.length} chapters to optionContinuation service.`);
196 | 
197 |     handleGenerateAndSaveChapter(
198 |       // Pasar los capítulos correctos del store
199 |       StoryContinuationService.generateOptionContinuation(story, currentChaptersFromStore, selectedOptionSummary),
200 |       `option${index + 1}` as "option1" | "option2" | "option3"
201 |     );
202 |   };
203 | 
204 |   const handleCustomContinuation = (userDirection: string) => {
205 |     if (!story) return; // Añadir guarda
206 |     setShowCustomInput(false);
207 |     // Obtener el estado MÁS ACTUAL de los capítulos ANTES de enviar
208 |     const currentChaptersFromStore = useChaptersStore.getState().getChaptersByStoryId(story.id);
209 |     console.log(`[StoryContinuation] Passing ${currentChaptersFromStore.length} chapters to directedContinuation service.`);
210 | 
211 |     handleGenerateAndSaveChapter(
212 |       // Pasar los capítulos correctos del store
213 |       StoryContinuationService.generateDirectedContinuation(story, currentChaptersFromStore, userDirection),
214 |       "custom",
215 |       userDirection
216 |     );
217 |   };
218 | 
219 |   if (isLoading) {
220 |     return (
221 |       <PageTransition>
222 |         <div
223 |           className="min-h-screen flex flex-col items-center justify-center p-6"
224 |           style={{
225 |             backgroundImage: "url(/fondo_png.png)",
226 |             backgroundSize: "cover",
227 |             backgroundPosition: "center",
228 |             backgroundRepeat: "no-repeat",
229 |           }}
230 |         >
231 |           <div className="w-full max-w-md flex flex-col items-center justify-center">
232 |             <motion.div
233 |               initial={{ opacity: 0, scale: 0.8 }}
234 |               animate={{ opacity: 1, scale: 1 }}
235 |               transition={{ duration: 0.5 }}
236 |               className="mb-10"
237 |             >
238 |               <IconLoadingAnimation message="Generando continuación..." />
239 |             </motion.div>
240 | 
241 |             <motion.div
242 |               initial={{ opacity: 0 }}
243 |               animate={{ opacity: 1 }}
244 |               transition={{ delay: 1, duration: 1 }}
245 |               className="bg-white/70 text-[#222] p-4 rounded-xl max-w-sm text-center shadow-md"
246 |             >
247 |               <p className="font-medium">Estamos personalizando una continuación mágica para tu historia...</p>
248 | 
249 |               <div className="mt-4 grid grid-cols-3 gap-2">
250 |                 {story?.options?.character && (
251 |                   <div className="bg-[#7DC4E0]/20 p-2 rounded-lg border border-[#7DC4E0]/30">
252 |                     <p className="text-xs font-semibold text-[#7DC4E0]">Personaje</p>
253 |                     <p className="text-sm truncate">{story.options.character.name || "Personaje"}</p>
254 |                   </div>
255 |                 )}
256 | 
257 |                 {story?.options?.genre && (
258 |                   <div className="bg-[#BB79D1]/20 p-2 rounded-lg border border-[#BB79D1]/30">
259 |                     <p className="text-xs font-semibold text-[#BB79D1]">Género</p>
260 |                     <p className="text-sm truncate">{story.options.genre}</p>
261 |                   </div>
262 |                 )}
263 | 
264 |                 {story?.options?.duration && (
265 |                   <div className="bg-[#F9DA60]/20 p-2 rounded-lg border border-[#F9DA60]/30">
266 |                     <p className="text-xs font-semibold text-[#F9DA60]">Duración</p>
267 |                     <p className="text-sm truncate">{story.options.duration}</p>
268 |                   </div>
269 |                 )}
270 |               </div>
271 |             </motion.div>
272 |           </div>
273 |         </div>
274 |       </PageTransition>
275 |     );
276 |   }
277 | 
278 |   return (
279 |     <PageTransition>
280 |       <div
281 |         className="min-h-screen flex flex-col items-center justify-center relative"
282 |         style={{
283 |           backgroundImage: "url(/fondo_png.png)",
284 |           backgroundSize: "cover",
285 |           backgroundPosition: "center",
286 |           backgroundRepeat: "no-repeat",
287 |         }}
288 |       >
289 |         <BackButton
290 |           onClick={() => {
291 |             if (showCustomInput) {
292 |               setShowCustomInput(false);
293 |             } else {
294 |               navigate(`/story/${storyId}?chapter=${chapters.length > 0 ? chapters.length - 1 : 0}`);
295 |             }
296 |           }}
297 |         />
298 | 
299 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
300 |           {chapters.length > 0 && (
301 |             <motion.div
302 |               initial={{ opacity: 0, y: -10 }}
303 |               animate={{ opacity: 1, y: 0 }}
304 |               transition={{ duration: 0.3 }}
305 |               className="bg-white/70 rounded-xl p-4 mb-4 text-[#222] shadow-md"
306 |             >
307 |               <div className="flex items-center">
308 |                 <BookOpen size={20} className="mr-2 text-[#BB79D1]" />
309 |                 <h2 className="text-lg font-medium truncate" title={chapters[chapters.length - 1].title || `Capítulo ${chapters.length}`}>
310 |                   Continuando: {chapters[chapters.length - 1].title || `Capítulo ${chapters.length}`}
311 |                 </h2>
312 |               </div>
313 |             </motion.div>
314 |           )}
315 | 
316 |           <motion.h1
317 |             initial={{ opacity: 0, y: -10 }}
318 |             animate={{ opacity: 1, y: 0 }}
319 |             transition={{ duration: 0.3, delay: 0.1 }}
320 |             className="text-3xl font-bold text-[#BB79D1] text-center mb-4 font-heading drop-shadow-lg"
321 |           >
322 |             ¿Cómo quieres que continúe?
323 |           </motion.h1>
324 | 
325 |           <motion.p
326 |             initial={{ opacity: 0, y: -10 }}
327 |             animate={{ opacity: 1, y: 0 }}
328 |             transition={{ duration: 0.3, delay: 0.2 }}
329 |             className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-6 font-medium shadow-sm"
330 |           >
331 |             Elige una opción para continuar tu historia
332 |           </motion.p>
333 | 
334 |           <motion.div
335 |             initial={{ opacity: 0, y: 20 }}
336 |             animate={{ opacity: 1, y: 0 }}
337 |             transition={{ duration: 0.4, delay: 0.3 }}
338 |           >
339 |             {!showCustomInput ? (
340 |               <StoryContinuationOptions
341 |                 options={continuationOptions}
342 |                 onSelectOption={handleSelectOption}
343 |                 onSelectFree={handleSelectFree}
344 |                 onSelectCustom={() => setShowCustomInput(true)}
345 |                 isLoading={isLoadingOptions}
346 |                 disabled={!isAllowedToContinue}
347 |               />
348 |             ) : (
349 |               <StoryContinuationCustomInput
350 |                 onSubmit={handleCustomContinuation}
351 |                 onBack={() => setShowCustomInput(false)}
352 |                 disabled={!isAllowedToContinue}
353 |               />
354 |             )}
355 |           </motion.div>
356 | 
357 |           {!isAllowedToContinue && chapters.length > 0 && (
358 |             <motion.div
359 |               initial={{ opacity: 0 }}
360 |               animate={{ opacity: 1 }}
361 |               transition={{ duration: 0.3, delay: 0.4 }}
362 |               className="text-center bg-white/70 rounded-xl p-4 mt-6 shadow-md border-2 border-[#F6A5B7]/30"
363 |             >
364 |               <p className="text-[#F6A5B7] font-semibold">
365 |                 Has alcanzado el límite de continuación gratuita para esta historia. ¡Considera hacerte Premium para continuaciones ilimitadas!
366 |               </p>
367 |             </motion.div>
368 |           )}
369 |         </div>
370 |       </div>
371 |     </PageTransition>
372 |   );
373 | }
```

src/pages/StoryDetailsInput.tsx
```
1 | import React, { useState, useEffect, useCallback } from 'react';
2 | import { useNavigate } from 'react-router-dom';
3 | import { motion } from 'framer-motion';
4 | import { useStoryOptionsStore } from '../store/storyOptions/storyOptionsStore';
5 | import PageTransition from '../components/PageTransition';
6 | import BackButton from '../components/BackButton';
7 | import StoryButton from '../components/StoryButton';
8 | import { supabase } from '../supabaseClient';
9 | import type { PresetSuggestion } from '../types';
10 | import { RefreshCw, Sparkles } from 'lucide-react';
11 | 
12 | const StoryDetailsInput: React.FC = () => {
13 |   const [detailsText, setDetailsText] = useState('');
14 |   const setAdditionalDetails = useStoryOptionsStore(
15 |     (state) => state.setAdditionalDetails
16 |   );
17 |   const navigate = useNavigate();
18 | 
19 |   // --- Estado para Presets --- 
20 |   const [presets, setPresets] = useState<PresetSuggestion[]>([]);
21 |   const [allPresets, setAllPresets] = useState<PresetSuggestion[]>([]);
22 |   const [isLoadingPresets, setIsLoadingPresets] = useState<boolean>(true);
23 | 
24 |   // --- Función para obtener todos los presets --- 
25 |   const fetchAndStoreAllPresets = useCallback(async () => {
26 |     setIsLoadingPresets(true);
27 |     try {
28 |       const { data, error } = await supabase
29 |         .from('preset_suggestions')
30 |         .select('id, text_prompt')
31 |         .eq('is_active', true);
32 | 
33 |       if (error) {
34 |         console.error('Error fetching presets:', error.message);
35 |       } else if (data) {
36 |         setAllPresets(data);
37 |       }
38 |     } catch (err) {
39 |       console.error('Unexpected error fetching presets:', err);
40 |     } finally {
41 |       setIsLoadingPresets(false);
42 |     }
43 |   }, []);
44 | 
45 |   // --- Función para seleccionar 3 presets aleatorios --- 
46 |   const selectRandomPresets = useCallback(() => {
47 |     if (allPresets.length < 3) {
48 |       setPresets(allPresets);
49 |       return;
50 |     }
51 | 
52 |     // Algoritmo simple de aleatorización: barajar y tomar 3
53 |     const shuffled = [...allPresets].sort(() => 0.5 - Math.random());
54 |     setPresets(shuffled.slice(0, 3));
55 |   }, [allPresets]);
56 | 
57 |   // --- Efecto para cargar todos los presets al montar --- 
58 |   useEffect(() => {
59 |     fetchAndStoreAllPresets();
60 |   }, [fetchAndStoreAllPresets]);
61 | 
62 |   // --- Efecto para seleccionar los primeros presets aleatorios --- 
63 |   useEffect(() => {
64 |     if (allPresets.length > 0) {
65 |       selectRandomPresets();
66 |     }
67 |   }, [allPresets, selectRandomPresets]);
68 | 
69 |   // --- Manejador para generar historia --- 
70 |   const handleGenerate = () => {
71 |     // Pasar detalles solo si el textarea tiene contenido
72 |     if (detailsText.trim()) {
73 |       setAdditionalDetails(detailsText.trim());
74 |     } else {
75 |       setAdditionalDetails(undefined); // Tratar como omitido si está vacío
76 |     }
77 |     navigate('/generating'); // Navegar a la pantalla de generación
78 |   };
79 | 
80 |   // --- Manejador para aplicar un preset al textarea --- 
81 |   const handlePresetClick = (text: string) => {
82 |     setDetailsText(text);
83 |   };
84 | 
85 |   // Animaciones para los elementos de la página
86 |   const fadeIn = {
87 |     hidden: { opacity: 0, y: 10 },
88 |     visible: { opacity: 1, y: 0, transition: { duration: 0.3 } }
89 |   };
90 | 
91 |   // Animación para los presets
92 |   const container = {
93 |     hidden: { opacity: 0 },
94 |     show: {
95 |       opacity: 1,
96 |       transition: {
97 |         staggerChildren: 0.05
98 |       }
99 |     }
100 |   };
101 | 
102 |   const item = {
103 |     hidden: { y: 10, opacity: 0 },
104 |     show: { y: 0, opacity: 1 }
105 |   };
106 | 
107 |   return (
108 |     <PageTransition>
109 |       <div
110 |         className="min-h-screen flex flex-col items-center justify-center relative"
111 |         style={{
112 |           backgroundImage: "url(/fondo_png.png)",
113 |           backgroundSize: "cover",
114 |           backgroundPosition: "center",
115 |           backgroundRepeat: "no-repeat",
116 |         }}
117 |       >
118 |         <BackButton />
119 |         
120 |         <div className="w-full max-w-2xl mx-auto px-4 py-8 flex-1 flex flex-col justify-center">
121 |           {/* Título y subtítulo animados */}
122 |           <motion.h1 
123 |             className="text-3xl font-bold text-[#BB79D1] mb-3 text-center font-heading drop-shadow-lg"
124 |             variants={fadeIn}
125 |             initial="hidden"
126 |             animate="visible"
127 |           >
128 |             ¿Algún <span className="text-[#F6A5B7]">detalle extra</span>?
129 |           </motion.h1>
130 |           
131 |           <motion.p 
132 |             className="mb-4 text-center text-[#222] bg-white/80 rounded-xl px-4 py-2 font-medium shadow-sm max-w-lg mx-auto"
133 |             variants={fadeIn}
134 |             initial="hidden"
135 |             animate="visible"
136 |             transition={{ delay: 0.1 }}
137 |           >
138 |             Añade instrucciones o ideas para personalizar tu historia.
139 |           </motion.p>
140 | 
141 |           {/* Badge "Paso opcional" */}
142 |           <motion.div
143 |             className="flex justify-center mb-2"
144 |             variants={fadeIn}
145 |             initial="hidden"
146 |             animate="visible"
147 |             transition={{ delay: 0.15 }}
148 |           >
149 |             <span className="inline-flex items-center px-4 py-1 rounded-2xl text-sm font-semibold bg-white/70 border-2 border-[#A5D6F6]/40 text-[#7DC4E0] shadow-sm" style={{letterSpacing:'0.01em'}}>
150 |               <svg className="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
151 |                 <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
152 |               </svg>
153 |               Paso opcional
154 |             </span>
155 |           </motion.div>
156 |           
157 |           {/* Sección de Presets */}
158 |           <motion.div
159 |             className="mb-4 w-full"
160 |             variants={fadeIn}
161 |             initial="hidden"
162 |             animate="visible"
163 |             transition={{ delay: 0.2 }}
164 |           >
165 |             <div className="flex items-center justify-between mb-3">
166 |               <div className="flex items-center text-[#222]">
167 |                 <Sparkles size={16} className="mr-1 text-[#F9DA60]" />
168 |                 <span className="text-sm font-medium">Ideas para inspirarte:</span>
169 |               </div>
170 |               
171 |               <button
172 |                 onClick={selectRandomPresets}
173 |                 disabled={isLoadingPresets || allPresets.length < 3}
174 |                 className="text-[#7DC4E0] hover:text-[#BB79D1] disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm flex items-center bg-white/70 px-2 py-1 rounded-full shadow-sm"
175 |               >
176 |                 <RefreshCw size={14} className="mr-1" />
177 |                 Nuevas ideas
178 |               </button>
179 |             </div>
180 | 
181 |             <motion.div 
182 |               variants={container}
183 |               initial="hidden"
184 |               animate="show"
185 |               className="grid grid-cols-1 md:grid-cols-3 gap-2 mb-4"
186 |             >
187 |               {isLoadingPresets ? (
188 |                 <div className="col-span-full flex justify-center py-3 bg-white/70 rounded-xl">
189 |                   <div className="animate-pulse flex space-x-2">
190 |                     <div className="h-2 w-2 bg-[#BB79D1]/60 rounded-full"></div>
191 |                     <div className="h-2 w-2 bg-[#BB79D1]/60 rounded-full"></div>
192 |                     <div className="h-2 w-2 bg-[#BB79D1]/60 rounded-full"></div>
193 |                   </div>
194 |                 </div>
195 |               ) : presets.length > 0 ? (
196 |                 presets.map((preset) => (
197 |                   <motion.div key={preset.id} variants={item}>
198 |                     <button
199 |                       onClick={() => handlePresetClick(preset.text_prompt)}
200 |                       className="w-full text-left p-3 rounded-xl bg-white/70 border-2 border-[#F6A5B7]/30 text-[#222] text-sm hover:bg-[#F6A5B7]/10 transition-all shadow-sm hover:shadow-md"
201 |                     >
202 |                       {preset.text_prompt}
203 |                     </button>
204 |                   </motion.div>
205 |                 ))
206 |               ) : (
207 |                 <div className="col-span-full text-center text-[#555] text-sm italic py-3 bg-white/70 rounded-xl">
208 |                   No hay sugerencias disponibles.
209 |                 </div>
210 |               )}
211 |             </motion.div>
212 |           </motion.div>
213 |           
214 |           {/* Contenedor del textarea con animación */} 
215 |           <motion.div
216 |             className="mb-6 w-full"
217 |             variants={fadeIn}
218 |             initial="hidden"
219 |             animate="visible"
220 |             transition={{ delay: 0.25 }}
221 |           >
222 |             <textarea
223 |               id="storyDetailsTextarea"
224 |               value={detailsText}
225 |               onChange={(e) => setDetailsText(e.target.value)}
226 |               placeholder="Escribe tus ideas o selecciona una de las sugerencias de arriba..."
227 |               className="w-full p-4 border-2 border-[#BB79D1]/40 rounded-xl text-[#222] bg-white/70 shadow-lg focus:ring-[#BB79D1] focus:border-[#BB79D1] h-32 resize-none placeholder-[#555]/70"
228 |             />
229 |           </motion.div>
230 |           
231 |           {/* Botón único de Generar Historia */} 
232 |           <motion.div 
233 |             className="flex justify-center w-full mt-2 mb-2"
234 |             variants={fadeIn}
235 |             initial="hidden"
236 |             animate="visible"
237 |             transition={{ delay: 0.3 }}
238 |           >
239 |             <StoryButton
240 |               onClick={handleGenerate}
241 |               className="w-full max-w-xs py-4 rounded-2xl text-white text-lg font-semibold shadow-lg bg-[#BB79D1] hover:bg-[#BB79D1]/90 border-2 border-[#BB79D1]/50 transition-all duration-200"
242 |             >
243 |               Generar Historia
244 |             </StoryButton>
245 |           </motion.div>
246 |         </div>
247 |       </div>
248 |     </PageTransition>
249 |   );
250 | };
251 | 
252 | export default StoryDetailsInput;
```

src/pages/StoryGenre.tsx
```
1 | import { useNavigate } from "react-router-dom";
2 | import { motion } from "framer-motion";
3 | import { useStoryOptionsStore } from "../store/storyOptions/storyOptionsStore";
4 | import BackButton from "../components/BackButton";
5 | import StoryButton from "../components/StoryButton";
6 | import PageTransition from "../components/PageTransition";
7 | import { Compass, Sparkles, Search, Rocket, SmilePlus, Feather } from "lucide-react";
8 | 
9 | const storyGenres = [
10 |   { id: "adventure", name: "Aventura", icon: <Compass /> },
11 |   { id: "fantasy", name: "Fantasía", icon: <Sparkles /> },
12 |   { id: "mystery", name: "Misterio", icon: <Search /> },
13 |   { id: "science-fiction", name: "Ciencia Ficción", icon: <Rocket /> },
14 |   { id: "comedy", name: "Comedia", icon: <SmilePlus /> },
15 |   { id: "fable", name: "Fábula", icon: <Feather /> }
16 | ];
17 | 
18 | export default function StoryGenre() {
19 |   const navigate = useNavigate();
20 |   const { currentStoryOptions, setGenre } = useStoryOptionsStore();
21 |   const selectedGenre = currentStoryOptions.genre || "";
22 |   
23 |   const handleSelectGenre = (genre: string) => {
24 |     setGenre(genre);
25 |   };
26 |   
27 |   const handleContinue = () => {
28 |     navigate("/story-moral");
29 |   };
30 |   
31 |   const container = {
32 |     hidden: { opacity: 0 },
33 |     show: {
34 |       opacity: 1,
35 |       transition: {
36 |         staggerChildren: 0.1
37 |       }
38 |     }
39 |   };
40 |   
41 |   const item = {
42 |     hidden: { y: 20, opacity: 0 },
43 |     show: { y: 0, opacity: 1 }
44 |   };
45 |   
46 |   return (
47 |     <PageTransition>
48 |       <div
49 |         className="min-h-screen flex flex-col items-center justify-center relative"
50 |         style={{
51 |           backgroundImage: "url(/fondo_png.png)",
52 |           backgroundSize: "cover",
53 |           backgroundPosition: "center",
54 |           backgroundRepeat: "no-repeat",
55 |         }}
56 |       >
57 |         <BackButton />
58 |         
59 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
60 |           <h1 className="text-3xl font-bold text-[#BB79D1] text-center mb-4 font-heading drop-shadow-lg">
61 |             Género del Cuento
62 |           </h1>
63 |           
64 |           <p className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-8 font-medium shadow-sm">
65 |             Elige el tipo de historia que quieres crear
66 |           </p>
67 |           
68 |           <motion.div 
69 |             variants={container}
70 |             initial="hidden"
71 |             animate="show"
72 |             className="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8"
73 |           >
74 |             <motion.div key="adventure" variants={item}>
75 |               <div
76 |                 onClick={() => handleSelectGenre("adventure")}
77 |                 className={`
78 |                   flex flex-col items-center justify-center p-6 h-32 sm:h-40 cursor-pointer
79 |                   bg-white/70 rounded-2xl border-2 border-[#F9DA60]/60
80 |                   ${selectedGenre === "adventure" ? 'ring-4 ring-[#F9DA60] shadow-lg transform scale-105' : 'hover:bg-[#F9DA60]/10 hover:scale-105 hover:shadow-md'}
81 |                   transition-all duration-300
82 |                 `}
83 |               >
84 |                 <div className="text-[#F9DA60] text-3xl mb-3">
85 |                   <Compass />
86 |                 </div>
87 |                 <span className="text-[#222] text-center font-medium">Aventura</span>
88 |               </div>
89 |             </motion.div>
90 |             
91 |             <motion.div key="fantasy" variants={item}>
92 |               <div
93 |                 onClick={() => handleSelectGenre("fantasy")}
94 |                 className={`
95 |                   flex flex-col items-center justify-center p-6 h-32 sm:h-40 cursor-pointer
96 |                   bg-white/70 rounded-2xl border-2 border-[#BB79D1]/60
97 |                   ${selectedGenre === "fantasy" ? 'ring-4 ring-[#BB79D1] shadow-lg transform scale-105' : 'hover:bg-[#BB79D1]/10 hover:scale-105 hover:shadow-md'}
98 |                   transition-all duration-300
99 |                 `}
100 |               >
101 |                 <div className="text-[#BB79D1] text-3xl mb-3">
102 |                   <Sparkles />
103 |                 </div>
104 |                 <span className="text-[#222] text-center font-medium">Fantasía</span>
105 |               </div>
106 |             </motion.div>
107 |             
108 |             <motion.div key="mystery" variants={item}>
109 |               <div
110 |                 onClick={() => handleSelectGenre("mystery")}
111 |                 className={`
112 |                   flex flex-col items-center justify-center p-6 h-32 sm:h-40 cursor-pointer
113 |                   bg-white/70 rounded-2xl border-2 border-[#7DC4E0]/60
114 |                   ${selectedGenre === "mystery" ? 'ring-4 ring-[#7DC4E0] shadow-lg transform scale-105' : 'hover:bg-[#7DC4E0]/10 hover:scale-105 hover:shadow-md'}
115 |                   transition-all duration-300
116 |                 `}
117 |               >
118 |                 <div className="text-[#7DC4E0] text-3xl mb-3">
119 |                   <Search />
120 |                 </div>
121 |                 <span className="text-[#222] text-center font-medium">Misterio</span>
122 |               </div>
123 |             </motion.div>
124 |             
125 |             <motion.div key="science-fiction" variants={item}>
126 |               <div
127 |                 onClick={() => handleSelectGenre("science-fiction")}
128 |                 className={`
129 |                   flex flex-col items-center justify-center p-6 h-32 sm:h-40 cursor-pointer
130 |                   bg-white/70 rounded-2xl border-2 border-[#7DC4E0]/60
131 |                   ${selectedGenre === "science-fiction" ? 'ring-4 ring-[#7DC4E0] shadow-lg transform scale-105' : 'hover:bg-[#7DC4E0]/10 hover:scale-105 hover:shadow-md'}
132 |                   transition-all duration-300
133 |                 `}
134 |               >
135 |                 <div className="text-[#7DC4E0] text-3xl mb-3">
136 |                   <Rocket />
137 |                 </div>
138 |                 <span className="text-[#222] text-center font-medium">Ciencia Ficción</span>
139 |               </div>
140 |             </motion.div>
141 |             
142 |             <motion.div key="comedy" variants={item}>
143 |               <div
144 |                 onClick={() => handleSelectGenre("comedy")}
145 |                 className={`
146 |                   flex flex-col items-center justify-center p-6 h-32 sm:h-40 cursor-pointer
147 |                   bg-white/70 rounded-2xl border-2 border-[#F6A5B7]/60
148 |                   ${selectedGenre === "comedy" ? 'ring-4 ring-[#F6A5B7] shadow-lg transform scale-105' : 'hover:bg-[#F6A5B7]/10 hover:scale-105 hover:shadow-md'}
149 |                   transition-all duration-300
150 |                 `}
151 |               >
152 |                 <div className="text-[#F6A5B7] text-3xl mb-3">
153 |                   <SmilePlus />
154 |                 </div>
155 |                 <span className="text-[#222] text-center font-medium">Comedia</span>
156 |               </div>
157 |             </motion.div>
158 |             
159 |             <motion.div key="fable" variants={item}>
160 |               <div
161 |                 onClick={() => handleSelectGenre("fable")}
162 |                 className={`
163 |                   flex flex-col items-center justify-center p-6 h-32 sm:h-40 cursor-pointer
164 |                   bg-white/70 rounded-2xl border-2 border-[#F9DA60]/60
165 |                   ${selectedGenre === "fable" ? 'ring-4 ring-[#F9DA60] shadow-lg transform scale-105' : 'hover:bg-[#F9DA60]/10 hover:scale-105 hover:shadow-md'}
166 |                   transition-all duration-300
167 |                 `}
168 |               >
169 |                 <div className="text-[#F9DA60] text-3xl mb-3">
170 |                   <Feather />
171 |                 </div>
172 |                 <span className="text-[#222] text-center font-medium">Fábula</span>
173 |               </div>
174 |             </motion.div>
175 |           </motion.div>
176 |           
177 |           <div className="flex justify-center w-full mt-2 mb-2">
178 |             <StoryButton
179 |               onClick={handleContinue}
180 |               disabled={!selectedGenre}
181 |               className="w-full max-w-xs py-4 rounded-2xl text-white text-lg font-semibold shadow-lg bg-[#BB79D1] hover:bg-[#BB79D1]/90 border-2 border-[#BB79D1]/50 transition-all duration-200"
182 |             >
183 |               Continuar
184 |             </StoryButton>
185 |           </div>
186 |         </div>
187 |       </div>
188 |     </PageTransition>
189 |   );
190 | }
```

src/pages/StoryMoral.tsx
```
1 | import { useNavigate } from "react-router-dom";
2 | import { motion } from "framer-motion";
3 | import { useStoryOptionsStore } from "../store/storyOptions/storyOptionsStore";
4 | import StoryOptionCard from "../components/StoryOptionCard";
5 | import BackButton from "../components/BackButton";
6 | import StoryButton from "../components/StoryButton";
7 | import PageTransition from "../components/PageTransition";
8 | 
9 | const morals = [
10 |   { id: "none", name: "Sin moraleja específica" },
11 |   { id: "kindness", name: "Siempre sé amable" },
12 |   { id: "honesty", name: "Sé honesto" },
13 |   { id: "change", name: "Sé el cambio que quieres ver" },
14 |   { id: "truth", name: "Siempre di la verdad" },
15 |   { id: "think", name: "Piensa antes de actuar" },
16 |   { id: "never-give-up", name: "Nunca te rindas" },
17 |   { id: "respect", name: "Respeta a los demás" },
18 |   { id: "friendship", name: "La importancia de la amistad" },
19 |   { id: "forgiveness", name: "Aprender a perdonar" },
20 |   { id: "accept", name: "No siempre conseguirás lo que quieres" },
21 |   { id: "patience", name: "La paciencia tiene su recompensa" }
22 | ];
23 | 
24 | export default function StoryMoral() {
25 |   const navigate = useNavigate();
26 |   const { currentStoryOptions, setMoral } = useStoryOptionsStore();
27 |   const selectedMoral = currentStoryOptions.moral || "";
28 | 
29 |   const handleSelectMoral = (moral: string) => {
30 |     setMoral(moral);
31 |   };
32 | 
33 |   const handleContinue = () => {
34 |     navigate("/story-details-input");
35 |   };
36 | 
37 |   const container = {
38 |     hidden: { opacity: 0 },
39 |     show: {
40 |       opacity: 1,
41 |       transition: {
42 |         staggerChildren: 0.05
43 |       }
44 |     }
45 |   };
46 | 
47 |   const item = {
48 |     hidden: { y: 10, opacity: 0 },
49 |     show: { y: 0, opacity: 1 }
50 |   };
51 | 
52 |   return (
53 |     <PageTransition>
54 |       <div
55 |         className="min-h-screen flex flex-col items-center justify-center relative"
56 |         style={{
57 |           backgroundImage: "url(/fondo_png.png)",
58 |           backgroundSize: "cover",
59 |           backgroundPosition: "center",
60 |           backgroundRepeat: "no-repeat",
61 |         }}
62 |       >
63 |         <BackButton />
64 | 
65 |         <div className="w-full max-w-2xl mx-auto px-4 py-8">
66 |           <h1 className="text-3xl font-bold text-[#BB79D1] text-center mb-4 font-heading drop-shadow-lg">
67 |             Elige una <span className="text-[#F6A5B7]">moraleja</span> para la historia
68 |           </h1>
69 | 
70 |           <p className="text-lg text-[#222] bg-white/80 rounded-xl px-4 py-2 text-center mb-8 font-medium shadow-sm">
71 |             Selecciona el mensaje o valor que quieres transmitir
72 |           </p>
73 | 
74 |           <motion.div
75 |             variants={container}
76 |             initial="hidden"
77 |             animate="show"
78 |             className="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8"
79 |           >
80 |             {morals.map((moral) => (
81 |               <motion.div key={moral.id} variants={item}>
82 |                 <div
83 |                   onClick={() => handleSelectMoral(moral.id)}
84 |                   className={`
85 |                     flex flex-col items-center justify-center p-6 h-28 cursor-pointer
86 |                     bg-white/70 rounded-2xl border-2 border-[#BB79D1]/30
87 |                     ${selectedMoral === moral.id ? 'ring-4 ring-[#BB79D1] shadow-lg transform scale-105' : 'hover:bg-[#BB79D1]/10 hover:scale-105 hover:shadow-md'}
88 |                     transition-all duration-300
89 |                   `}
90 |                 >
91 |                   <span className="text-[#222] text-center font-medium">{moral.name}</span>
92 |                 </div>
93 |               </motion.div>
94 |             ))}
95 |           </motion.div>
96 | 
97 |           <div className="flex justify-center w-full mt-2 mb-2">
98 |             <StoryButton
99 |               onClick={handleContinue}
100 |               disabled={!selectedMoral}
101 |               className="w-full max-w-xs py-4 rounded-2xl text-white text-lg font-semibold shadow-lg bg-[#BB79D1] hover:bg-[#BB79D1]/90 border-2 border-[#BB79D1]/50 transition-all duration-200"
102 |             >
103 |               Continuar
104 |             </StoryButton>
105 |           </div>
106 |         </div>
107 |       </div>
108 |     </PageTransition>
109 |   );
110 | }
```

src/pages/StoryViewer.tsx
```
1 | // src/pages/StoryViewer.tsx
2 | // VERSIÓN CORREGIDA: Maneja {content, title} y usa selectores de límites
3 | 
4 | import React, { useState, useEffect, useCallback } from "react"; // Añadido useCallback
5 | import { useParams, useNavigate, useLocation } from "react-router-dom";
6 | import { Share, Printer, Volume2, Home, Award, BookOpen, ChevronLeft, ChevronRight, AlertCircle, FileText, FileDown } from "lucide-react";
7 | import { motion } from "framer-motion";
8 | import { useStoriesStore } from "../store/stories/storiesStore";
9 | import { useChaptersStore } from "../store/stories/chapters/chaptersStore";
10 | import { useChallengesStore } from "../store/stories/challenges/challengesStore";
11 | import { useUserStore } from "../store/user/userStore"; // Importar para los selectores de límites
12 | import BackButton from "../components/BackButton";
13 | // import StoryButton from "../components/StoryButton"; // Parece no usarse aquí directamente
14 | import PageTransition from "../components/PageTransition";
15 | import ChallengeSelector from "../components/ChallengeSelector";
16 | import LanguageSelector from "../components/LanguageSelector";
17 | import ChallengeQuestion from "../components/ChallengeQuestion";
18 | import { toast } from "sonner"; // Asegurarse que toast está importado
19 | import { ChallengeCategory, ChallengeQuestion as ChallengeQuestionType, StoryChapter, Story } from "../types"; // Importar Story
20 | import { ChallengeService } from "../services/ai/ChallengeService"; // Asumiendo ruta
21 | import { parseTextToParagraphs } from '@/lib/utils';
22 | import { generateId } from "../store/core/utils";
23 | import StoryPdfPreview from "../components/StoryPdfPreview";
24 | 
25 | export default function StoryViewer() {
26 |   const { storyId } = useParams<{ storyId: string }>();
27 |   const navigate = useNavigate();
28 |   const location = useLocation();
29 |   const { getStoryById, isLoadingStories } = useStoriesStore(state => ({
30 |     getStoryById: state.getStoryById,
31 |     isLoadingStories: state.isLoadingStories,
32 |   }));
33 |   const { getChaptersByStoryId } = useChaptersStore();
34 |   const { addChallenge } = useChallengesStore();
35 |   // --- Obtener selectores de límites/permisos del userStore ---
36 |   const { profileSettings, canContinueStory, canGenerateVoice } = useUserStore();
37 | 
38 |   // Estado local
39 |   const [currentChapterIndex, setCurrentChapterIndex] = useState(0);
40 |   const [chapters, setChapters] = useState<StoryChapter[]>([]);
41 |   const [story, setStory] = useState<Story | null>(null); // Para pasar al servicio de desafío/continuación
42 |   const [showChallengeSelector, setShowChallengeSelector] = useState(false);
43 |   const [selectedCategory, setSelectedCategory] = useState<ChallengeCategory | null>(null);
44 |   const [showLanguageSelector, setShowLanguageSelector] = useState(false);
45 |   const [selectedLanguage, setSelectedLanguage] = useState<string | null>(null);
46 |   const [challengeQuestion, setChallengeQuestion] = useState<ChallengeQuestionType | null>(null);
47 |   const [isLoadingQuestion, setIsLoadingQuestion] = useState(false);
48 |   const [isGeneratingContinuation, setIsGeneratingContinuation] = useState(false); // Estado de carga para continuación
49 |   const [showPdfPreview, setShowPdfPreview] = useState(false);
50 | 
51 |   // --- Permisos derivados del store ---
52 |   // Estos se actualizan reactivamente si el estado del userStore cambia
53 |   const isAllowedToContinue = storyId ? canContinueStory(storyId) : false;
54 |   const isAllowedToGenerateVoice = canGenerateVoice();
55 | 
56 |   // --- Cálculo para saber si es el último capítulo ---
57 |   const totalChapters = chapters.length;
58 |   const currentChapterNumber = currentChapterIndex + 1;
59 |   const isLastChapter = totalChapters > 0 && currentChapterNumber === totalChapters;
60 | 
61 |   // --- Efecto para cargar historia y capítulos ---
62 |   useEffect(() => {
63 |     if (!storyId) { navigate("/home", { replace: true }); return; }
64 | 
65 |     // Esperar a que las historias terminen de cargarse
66 |     if (isLoadingStories) {
67 |       console.log("[StoryViewer_DEBUG] Waiting for stories to load...");
68 |       return; // Salir del efecto si aún está cargando
69 |     }
70 |     console.log("[StoryViewer_DEBUG] Stories loaded. Attempting to fetch story:", storyId);
71 | 
72 |     const fetchedStory = getStoryById(storyId);
73 |     console.log("[StoryViewer_DEBUG] Fetched story from store:", fetchedStory ? `"${fetchedStory.title}"` : 'NOT FOUND');
74 | 
75 |     if (!fetchedStory) {
76 |       console.error(`[StoryViewer_DEBUG] Story with ID ${storyId} not found after loading! Navigating to /not-found.`);
77 |       navigate("/not-found", { replace: true }); // Usar replace para no ensuciar el historial
78 |       return;
79 |     }
80 |     setStory(fetchedStory); // Guardar la historia base
81 |     
82 |     // No navegar a /profile aquí, checkAuth debería haberlo hecho si es necesario
83 |     
84 |     const storyChapters = getChaptersByStoryId(storyId);
85 |     let chaptersToSet: StoryChapter[];
86 |     if (storyChapters.length === 0 && fetchedStory.content) {
87 |       console.log("[StoryViewer_DEBUG] No chapters found in store, creating initial chapter from story content.");
88 |       // Crear capítulo inicial si no existe en el store de capítulos
89 |       chaptersToSet = [{
90 |         id: generateId(),
91 |         chapterNumber: 1,
92 |         title: fetchedStory.title || "Capítulo 1",
93 |         content: fetchedStory.content,
94 |         createdAt: fetchedStory.createdAt
95 |       }];
96 |       // Nota: No llamamos a addChapter aquí, solo lo mostramos. Se guarda si se continúa.
97 |     } else {
98 |       console.log(`[StoryViewer_DEBUG] Found ${storyChapters.length} chapters in store. Sorting.`);
99 |       chaptersToSet = [...storyChapters].sort((a, b) => a.chapterNumber - b.chapterNumber); // Asegurar orden
100 |     }
101 |     setChapters(chaptersToSet);
102 |     console.log(`[StoryViewer_DEBUG] Set chapters state with ${chaptersToSet.length} chapters.`);
103 | 
104 |     // Establecer capítulo inicial basado en URL o el último si no hay parámetro
105 |     const searchParams = new URLSearchParams(location.search);
106 |     const chapterParam = searchParams.get('chapter');
107 |     let initialIndex = chaptersToSet.length > 0 ? chaptersToSet.length - 1 : 0; // Default al último capítulo o 0 si no hay
108 |     if (chapterParam !== null) {
109 |       const chapterIndex = parseInt(chapterParam, 10);
110 |       if (!isNaN(chapterIndex) && chapterIndex >= 0 && chapterIndex < chaptersToSet.length) {
111 |         initialIndex = chapterIndex;
112 |       }
113 |     }
114 |     console.log(`[StoryViewer_DEBUG] Setting current chapter index to: ${initialIndex}`);
115 |     setCurrentChapterIndex(initialIndex);
116 | 
117 |   }, [storyId, location.search, getStoryById, getChaptersByStoryId, navigate, isLoadingStories]); // <- Añadir isLoadingStories como dependencia
118 | 
119 |   // --- Renderizado Condicional --- (Modificado)
120 |   if (isLoadingStories) {
121 |     console.log("[StoryViewer Render_DEBUG] Rendering loading spinner because isLoadingStories is true.");
122 |     return <div className="gradient-bg min-h-screen flex items-center justify-center text-white">Cargando historia...</div>;
123 |   }
124 | 
125 |   // Si la carga terminó pero la historia no se encontró (el useEffect ya habrá navegado a /not-found)
126 |   if (!story) {
127 |     console.log("[StoryViewer Render_DEBUG] Rendering 'Historia no encontrada' because story state is null after loading finished.");
128 |     // Podríamos mostrar un mensaje aquí mientras ocurre la navegación del useEffect
129 |     return <div className="gradient-bg min-h-screen flex items-center justify-center text-white">Historia no encontrada. Redirigiendo...</div>;
130 |     // O return null;
131 |   }
132 | 
133 |   // Si llegamos aquí, la historia está cargada. Renderizar contenido.
134 |   console.log(`[StoryViewer Render_DEBUG] Rendering main content for story: ${story.title}`);
135 | 
136 |   // --- Manejadores de Acciones ---
137 |   const handleShare = async () => {
138 |     const shareUrl = window.location.href; // URL actual incluyendo el capítulo
139 |     const shareTitle = story?.title || "Mi Historia TaleMe!";
140 |     const shareText = chapters.length > 0 ? chapters[currentChapterIndex]?.title : "Echa un vistazo a esta historia";
141 | 
142 |     if (navigator.share) {
143 |       try {
144 |         await navigator.share({
145 |           title: shareTitle,
146 |           text: shareText,
147 |           url: shareUrl,
148 |         });
149 |         toast.success("¡Historia compartida!");
150 |       } catch (error) {
151 |         console.error("Error al compartir:", error);
152 |         toast.error("No se pudo compartir", { description: "El navegador canceló la acción o hubo un error." });
153 |       }
154 |     } else {
155 |       // Fallback: Copiar al portapapeles
156 |       try {
157 |         await navigator.clipboard.writeText(shareUrl);
158 |         toast.info("Enlace copiado al portapapeles", {
159 |           description: "Puedes pegarlo para compartir la historia."
160 |         });
161 |       } catch (err) {
162 |         console.error('Error al copiar al portapapeles:', err);
163 |         toast.error("No se pudo copiar el enlace", {
164 |           description: "Tu navegador no soporta esta función o hubo un error."
165 |         });
166 |       }
167 |     }
168 |   };
169 | 
170 |   const handlePrint = () => {
171 |     // Mostrar el modal de generación de PDF en lugar de la impresión del navegador
172 |     setShowPdfPreview(true);
173 |   };
174 | 
175 |   const toggleAudioPlayer = () => {
176 |     // Usar el estado derivado isAllowedToGenerateVoice
177 |     if (isAllowedToGenerateVoice) {
178 |       navigate(`/story/${storyId}/audio/${currentChapterIndex}`);
179 |     } else {
180 |       toast.error("Límite de voz alcanzado", {
181 |         description: "No tienes generaciones de voz gratuitas o créditos disponibles."
182 |       });
183 |     }
184 |   };
185 | 
186 |   // --- Manejadores de Desafío (sin cambios lógicos aquí) ---
187 |   const handleShowChallenge = () => setShowChallengeSelector(true);
188 |   const handleSelectCategory = (category: ChallengeCategory) => { /* ... */ setSelectedCategory(category); };
189 |   const handleSelectLanguage = (language: string) => setSelectedLanguage(language);
190 |   const handleContinueAfterLanguage = () => { /* ... */ setShowLanguageSelector(false); generateChallengeQuestion(); };
191 |   const handleContinueAfterCategory = () => { /* ... */ if (selectedCategory === 'language') setShowLanguageSelector(true); else generateChallengeQuestion(); setShowChallengeSelector(false); };
192 |   const handleBackToCategories = () => { /* ... */ setShowLanguageSelector(false); setShowChallengeSelector(true); };
193 |   const handleTryAgain = () => generateChallengeQuestion();
194 |   const handleNextQuestion = () => { /* ... */ setChallengeQuestion(null); setSelectedCategory(null); setSelectedLanguage(null); setShowChallengeSelector(false); };
195 |   const handleChangeChallenge = () => { /* ... */ setChallengeQuestion(null); setSelectedCategory(null); setSelectedLanguage(null); setShowChallengeSelector(true); };
196 | 
197 |   const generateChallengeQuestion = async () => {
198 |     if (!selectedCategory || !story || !profileSettings) return;
199 |     setIsLoadingQuestion(true);
200 |     try {
201 |       if (selectedCategory === 'language' && !selectedLanguage) throw new Error('Idioma no seleccionado');
202 |       toast.loading('Generando pregunta...');
203 |       const challenge = await ChallengeService.createChallenge(story, selectedCategory, profileSettings, selectedCategory === 'language' ? selectedLanguage : undefined);
204 |       addChallenge(challenge);
205 |       setChallengeQuestion(challenge.questions[0]);
206 |       toast.dismiss();
207 |       toast.success('¡Pregunta lista!');
208 |     } catch (error: unknown) {
209 |       console.error('Error al generar pregunta:', error);
210 |       toast.dismiss();
211 |       toast.error('No se pudo generar la pregunta', { 
212 |         description: error instanceof Error ? error.message : 'Error desconocido'
213 |       });
214 |     } finally {
215 |       setIsLoadingQuestion(false);
216 |     }
217 |   };
218 |   // --- Fin Manejadores Desafío ---
219 | 
220 |   // --- Manejadores de Navegación de Capítulos ---
221 |   const handlePreviousChapter = () => {
222 |     if (currentChapterIndex > 0) setCurrentChapterIndex(currentChapterIndex - 1);
223 |   };
224 |   const handleNextChapter = () => {
225 |     if (currentChapterIndex < chapters.length - 1) setCurrentChapterIndex(currentChapterIndex + 1);
226 |   };
227 |   // --- Fin Navegación Capítulos ---
228 | 
229 |   // --- Manejador para el botón de atrás ---
230 |   const handleGoBack = () => {
231 |     navigate('/'); // Navegar explícitamente a la página de inicio
232 |   };
233 | 
234 |   // --- *** INICIO: Lógica de Continuación MODIFICADA *** ---
235 |   const goToContinuationPage = () => {
236 |     // Usa el estado derivado isAllowedToContinue
237 |     if (isAllowedToContinue) {
238 |       // Navega a la PÁGINA de continuación, no genera aquí
239 |       navigate(`/story/${storyId}/continue?refresh=${Date.now()}`);
240 |     } else {
241 |       toast.error("Límite de continuación alcanzado", {
242 |         description: "Solo puedes añadir una continuación gratuita por historia."
243 |       });
244 |     }
245 |   };
246 | 
247 |   // --- *** FIN: Lógica de Continuación MODIFICADA *** ---
248 | 
249 |   // --- Renderizado ---
250 |   const currentChapter = chapters[currentChapterIndex];
251 | 
252 |   if (!currentChapter) {
253 |     // Manejar caso donde el índice es inválido (aunque useEffect debería prevenirlo)
254 |     return <div className="gradient-bg min-h-screen flex items-center justify-center text-white">Error: Capítulo no encontrado.</div>;
255 |   }
256 | 
257 |   return (
258 |     <PageTransition>
259 |       <div
260 |         className="min-h-screen relative pb-24 flex flex-col items-center justify-start"
261 |         style={{
262 |           backgroundImage: "url(/fondo_png.png)",
263 |           backgroundSize: "cover",
264 |           backgroundPosition: "center",
265 |           backgroundRepeat: "no-repeat",
266 |         }}
267 |       >
268 |         {/* Botón de Volver atrás */}
269 |         <BackButton onClick={handleGoBack} />
270 | 
271 |         <div className="absolute top-6 right-6 flex space-x-2 z-10">
272 |           <button
273 |             onClick={handleShare}
274 |             className="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md border border-white/20 flex items-center justify-center text-[#BB79D1] hover:bg-white/40 hover:scale-105 active:scale-95 transition-all shadow-md"
275 |             aria-label="Compartir"
276 |           >
277 |             <Share className="h-5 w-5" />
278 |           </button>
279 |           <button
280 |             onClick={handlePrint}
281 |             className="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md border border-white/20 flex items-center justify-center text-[#BB79D1] hover:bg-white/40 hover:scale-105 active:scale-95 transition-all shadow-md"
282 |             aria-label="Generar PDF"
283 |             title="Generar PDF del cuento"
284 |           >
285 |             <FileDown className="h-5 w-5" />
286 |           </button>
287 |         </div>
288 | 
289 |         <div className="w-full max-w-2xl mx-auto pt-20 px-2 sm:px-6 flex-1 flex flex-col">
290 |           {/* Título del Capítulo/Historia */}
291 |           <motion.h1
292 |             initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.1 }}
293 |             className="text-2xl sm:text-3xl font-bold text-center mb-4 text-[#BB79D1] drop-shadow-lg px-2"
294 |             title={currentChapter.title || story.title}
295 |           >
296 |             {chapters.length > 1 ? `Cap. ${currentChapterIndex + 1}: ` : ''}
297 |             {currentChapter.title || story.title || "Historia sin título"}
298 |           </motion.h1>
299 | 
300 |           {/* Contenido Principal (Historia o Desafío) */}
301 |           {!showChallengeSelector && !showLanguageSelector && !challengeQuestion && (
302 |             <motion.div
303 |               initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.2 }}
304 |               className="bg-white/80 rounded-2xl p-4 sm:p-8 mb-6 text-[#222] leading-relaxed text-base sm:text-lg shadow-lg max-w-full"
305 |               style={{ minHeight: '40vh', boxShadow: '0 2px 24px 0 rgba(187,121,209,0.10)' }}
306 |             >
307 |               {parseTextToParagraphs(currentChapter.content).map((paragraph, index) => (
308 |                 <p key={index} className="mb-4 last:mb-0 text-[1.08em]" style={{ wordBreak: 'break-word' }}>
309 |                   {paragraph}
310 |                 </p>
311 |               ))}
312 |             </motion.div>
313 |           )}
314 | 
315 |           {/* Selectores y Pregunta de Desafío (sin cambios) */}
316 |           {showChallengeSelector && <ChallengeSelector onSelectCategory={handleSelectCategory} onContinue={handleContinueAfterCategory} />}
317 |           {showLanguageSelector && <LanguageSelector currentLanguage={profileSettings?.language || 'es'} onSelectLanguage={handleSelectLanguage} onContinue={handleContinueAfterLanguage} onBack={handleBackToCategories} />}
318 |           {challengeQuestion && <ChallengeQuestion question={challengeQuestion} onNextQuestion={handleNextQuestion} onTryAgain={handleTryAgain} onChangeChallenge={handleChangeChallenge} />}
319 | 
320 |           {/* --- Barra de Acciones Inferior --- */}
321 |           {!showChallengeSelector && !showLanguageSelector && !challengeQuestion && (
322 |             <motion.div
323 |               initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5, delay: 0.3 }}
324 |               className="mt-4 sm:mt-8"
325 |             >
326 |               {/* Navegación entre Capítulos */}
327 |               <div className="flex justify-between items-center mb-4 px-1 sm:px-2">
328 |                 <button onClick={handlePreviousChapter} disabled={currentChapterIndex === 0} className="text-[#BB79D1] bg-white/70 hover:bg-[#F6A5B7]/20 rounded-xl px-3 py-2 text-sm font-semibold shadow disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-1 transition-all">
329 |                   <ChevronLeft size={18} /> Anterior
330 |                 </button>
331 |                 <span className="text-[#222] text-base sm:text-lg font-bold select-none drop-shadow-sm bg-white/70 px-3 py-1 rounded-xl shadow-sm">
332 |                   Capítulo {currentChapterIndex + 1} / {chapters.length}
333 |                 </span>
334 |                 <button onClick={handleNextChapter} disabled={currentChapterIndex === chapters.length - 1} className="text-[#BB79D1] bg-white/70 hover:bg-[#F6A5B7]/20 rounded-xl px-3 py-2 text-sm font-semibold shadow disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-1 transition-all">
335 |                   Siguiente <ChevronRight size={18} />
336 |                 </button>
337 |               </div>
338 | 
339 |               {/* Botones de Acción Principales */}
340 |               <div className="flex flex-col items-center space-y-4 sm:space-y-5">
341 |                 {/* Primera fila: Acepta el Reto y Continuar Historia */}
342 |                 <div className="flex flex-col sm:flex-row gap-4 sm:gap-6 justify-center items-center w-full">
343 |                   <button
344 |                     onClick={handleShowChallenge}
345 |                     className={`flex items-center justify-center px-5 sm:px-6 py-3 sm:py-4 rounded-2xl font-semibold text-white shadow-lg text-base sm:text-lg w-full sm:w-auto bg-[#7DC4E0] hover:bg-[#7DC4E0]/80 active:bg-[#A5D6F6] focus:bg-[#A5D6F6] transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed`}
346 |                     disabled={isLoadingQuestion}
347 |                   >
348 |                     <Award size={22} className="mr-2" />
349 |                     {isLoadingQuestion ? "Generando..." : "Acepta el Reto"}
350 |                   </button>
351 | 
352 |                   <button
353 |                     onClick={goToContinuationPage}
354 |                     // Deshabilitado si NO se permite continuar (plan) O si NO es el último capítulo
355 |                     disabled={!isAllowedToContinue || !isLastChapter}
356 |                     className={`flex items-center justify-center px-5 sm:px-6 py-3 sm:py-4 rounded-2xl font-semibold transition-all shadow-lg text-base sm:text-lg w-full sm:w-auto ${isAllowedToContinue && isLastChapter ? 'bg-[#BB79D1] hover:bg-[#BB79D1]/80 text-white active:bg-[#E6B7D9] focus:bg-[#E6B7D9]' : 'bg-gray-300 cursor-not-allowed text-gray-500'}`}
357 |                     // Título dinámico según la razón de la deshabilitación
358 |                     title={
359 |                       !isAllowedToContinue
360 |                         ? "Límite de continuación gratuita alcanzado"
361 |                         : !isLastChapter
362 |                         ? "Solo puedes continuar desde el último capítulo"
363 |                         : "Continuar la historia"
364 |                     }
365 |                   >
366 |                     <BookOpen size={22} className="mr-2" />
367 |                     Continuar Historia
368 |                   </button>
369 |                 </div>
370 | 
371 |                 {/* Segunda fila: Narrar */}
372 |                 <button
373 |                   onClick={toggleAudioPlayer}
374 |                   disabled={!isAllowedToGenerateVoice}
375 |                   className={`flex items-center justify-center px-5 sm:px-6 py-3 sm:py-4 rounded-2xl font-semibold transition-all shadow-lg text-base sm:text-lg w-full sm:w-64 ${isAllowedToGenerateVoice ? 'bg-[#f7c59f] hover:bg-[#ffd7ba] text-white active:bg-[#ffd7ba] focus:bg-[#ffd7ba]' : 'bg-gray-300 cursor-not-allowed text-gray-500'}`}
376 |                   title={!isAllowedToGenerateVoice ? "Límite de voz o créditos agotados" : "Escuchar narración"}
377 |                 >
378 |                   <Volume2 size={22} className="mr-2" />
379 |                   Narrar
380 |                   {!isAllowedToGenerateVoice && <AlertCircle className="ml-1 h-4 w-4" />}
381 |                 </button>
382 | 
383 |                 {/* Tercera fila: Volver al Inicio */}
384 |                 <button
385 |                   onClick={() => navigate("/home")}
386 |                   className="flex items-center justify-center px-5 sm:px-6 py-2.5 sm:py-3 rounded-2xl font-semibold bg-white/60 hover:bg-white/80 text-[#BB79D1] transition-all shadow w-full sm:w-48 text-base"
387 |                 >
388 |                   <Home size={18} className="mr-2" /> Volver al Inicio
389 |                 </button>
390 |               </div>
391 |             </motion.div>
392 |           )}
393 |         </div> {/* Fin container */}
394 | 
395 |         {/* Modal de generación de PDF */}
396 |         <StoryPdfPreview
397 |           isOpen={showPdfPreview}
398 |           onClose={() => setShowPdfPreview(false)}
399 |           title={currentChapter?.title || story?.title || "Tu cuento TaleMe!"}
400 |           content={currentChapter?.content || ""}
401 |           storyId={storyId!}
402 |           chapterId={currentChapter?.id || "1"}
403 |         />
404 |       </div> {/* Fin fondo */}
405 |     </PageTransition>
406 |   );
407 | }
408 | 
409 | // Estilos CSS reutilizados (puedes ponerlos en tu index.css o similar)
410 | /*
411 | .action-icon-button {
412 |   @apply w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white/15 backdrop-blur-md flex items-center justify-center text-white hover:bg-white/25 transition-all;
413 | }
414 | .nav-button {
415 |   @apply text-white/80 hover:text-white text-sm inline-flex items-center gap-1 transition-colors;
416 | }
417 | .action-button {
418 |    @apply text-white px-5 py-2.5 sm:px-6 sm:py-3 rounded-full font-medium flex items-center justify-center shadow-lg transition-all text-sm sm:text-base w-full sm:w-auto;
419 | }
420 | */
```

src/pages/TermsAndConditions.tsx
```
1 | import React from 'react';
2 | import { useNavigate } from 'react-router-dom';
3 | import { Button } from "@/components/ui/button";
4 | import PageTransition from "../components/PageTransition";
5 | 
6 | const TermsAndConditions: React.FC = () => {
7 |   const navigate = useNavigate();
8 | 
9 |   return (
10 |     <PageTransition>
11 |       <div 
12 |         className="min-h-screen flex flex-col"
13 |         style={{
14 |           backgroundImage: 'url(/fondo_png.png)',
15 |           backgroundSize: 'cover',
16 |           backgroundPosition: 'center',
17 |           backgroundRepeat: 'no-repeat',
18 |         }}
19 |       >
20 |         <div className="container mx-auto py-8 px-4 flex-1 overflow-auto">
21 |           <div className="max-w-4xl mx-auto">
22 |             <div className="text-center mb-6">
23 |               <h1 className="text-3xl font-bold text-[#222]">TÉRMINOS Y CONDICIONES DE USO – USUARIOS DE TALEME!</h1>
24 |               <p className="text-sm text-[#555] mt-2">Última actualización: 23 de abril de 2025</p>
25 |             </div>
26 | 
27 |             <div className="space-y-6 bg-white/80 p-8 rounded-2xl backdrop-blur-sm shadow-lg">
28 |               <p>
29 |                 Estos Términos y Condiciones regulan el acceso, la navegación y el uso de los servicios ofrecidos a través de la plataforma "TaleMe!" (en adelante, la "Plataforma"), titularidad de TaleMe!, con domicilio en Zaragoza, España, y correo electrónico de contacto hola@taleme.app.
30 |               </p>
31 | 
32 |               <div>
33 |                 <h2 className="text-xl font-bold text-[#BB79D1]">1. OBJETO</h2>
34 |                 <p className="mt-2">
35 |                   Estos Términos establecen los derechos y obligaciones de los Usuarios y de TaleMe! respecto al acceso y uso de la Plataforma, que permite la generación de cuentos infantiles mediante Inteligencia Artificial.
36 |                 </p>
37 |               </div>
38 | 
39 |               <div>
40 |                 <h2 className="text-xl font-bold text-[#BB79D1]">2. DESCRIPCIÓN DEL SERVICIO</h2>
41 |                 <p className="mt-2">
42 |                   TaleMe! es una aplicación web diseñada para crear, editar y escuchar cuentos infantiles personalizados, aprovechando tecnologías de IA. El Usuario puede:
43 |                 </p>
44 |                 <p className="mt-2">
45 |                   Generar relatos a partir de parámetros (edad, tema, estilo).
46 |                 </p>
47 |                 <p className="mt-2">
48 |                   Guardar y gestionar su biblioteca de historias.
49 |                 </p>
50 |                 <p className="mt-2">
51 |                   Recibir notificaciones por correo electrónico con enlaces a sus creaciones.
52 |                 </p>
53 |               </div>
54 | 
55 |               <div>
56 |                 <h2 className="text-xl font-bold text-[#BB79D1]">3. ACCESO Y REGISTRO</h2>
57 |                 <p className="mt-2">
58 |                   Cuenta de Usuario: Para utilizar TaleMe! es necesario registrarse facilitando un email válido y una contraseña.
59 |                 </p>
60 |                 <p className="mt-2">
61 |                   Veracidad de los Datos: El Usuario garantiza que la información proporcionada es veraz y actual. En caso de modificación, deberá actualizar sus datos en su perfil.
62 |                 </p>
63 |                 <p className="mt-2">
64 |                   Edad Mínima: Solo pueden registrarse mayores de 14 años. Los menores deberán contar con el consentimiento de su padre, madre o tutor legal.
65 |                 </p>
66 |               </div>
67 | 
68 |               <div>
69 |                 <h2 className="text-xl font-bold text-[#BB79D1]">4. LICENCIA DE USO</h2>
70 |                 <p className="mt-2">
71 |                   TaleMe! otorga al Usuario una licencia limitada, revocable, no exclusiva e intransferible para uso personal y no comercial de la Plataforma.
72 |                   Queda prohibido:
73 |                 </p>
74 |                 <p className="mt-2">
75 |                   Copiar, distribuir o modificar el software de la Plataforma.
76 |                 </p>
77 |                 <p className="mt-2">
78 |                   Descompilar, realizar ingeniería inversa o extraer código.
79 |                 </p>
80 |                 <p className="mt-2">
81 |                   Compartir credenciales de acceso con terceros.
82 |                 </p>
83 |                 <p className="mt-2">
84 |                   Hacer un uso comercial de los servicios sin autorización expresa por escrito.
85 |                 </p>
86 |               </div>
87 | 
88 |               <div>
89 |                 <h2 className="text-xl font-bold text-[#BB79D1]">5. CUENTA, CONTRASEÑA Y SEGURIDAD</h2>
90 |                 <p className="mt-2">
91 |                   El Usuario es responsable de mantener la confidencialidad de su contraseña y de todas las actividades que se realicen bajo su cuenta. En caso de uso no autorizado, deberá notificarlo de inmediato a hola@taleme.app.
92 |                 </p>
93 |               </div>
94 | 
95 |               <div>
96 |                 <h2 className="text-xl font-bold text-[#BB79D1]">6. NOTIFICACIONES</h2>
97 |                 <p className="mt-2">
98 |                   Todas las comunicaciones e información relevante (novedades, enlaces de descarga, cambios en estos Términos) se enviarán al correo electrónico registrado. El Usuario debe mantenerlo actualizado.
99 |                 </p>
100 |               </div>
101 | 
102 |               <div>
103 |                 <h2 className="text-xl font-bold text-[#BB79D1]">7. REQUISITOS TÉCNICOS</h2>
104 |                 <p className="mt-2">
105 |                   Para acceder a TaleMe! se requiere:
106 |                 </p>
107 |                 <p className="mt-2">
108 |                   Dispositivo con conexión a Internet.
109 |                 </p>
110 |                 <p className="mt-2">
111 |                   Navegador web actualizado (Chrome, Firefox, Edge, Safari).
112 |                   TaleMe! no garantiza el correcto funcionamiento en navegadores o dispositivos no compatibles.
113 |                 </p>
114 |               </div>
115 | 
116 |               <div>
117 |                 <h2 className="text-xl font-bold text-[#BB79D1]">8. PROPIEDAD INTELECTUAL</h2>
118 |                 <p className="mt-2">
119 |                   Relatos Generados: El Usuario conservará todos los derechos de propiedad intelectual sobre los cuentos que genere. TaleMe! no reivindica derechos sobre dichos contenidos.
120 |                 </p>
121 |                 <p className="mt-2">
122 |                   Plataforma y Contenidos: El software, diseño, logos, marcas y documentación de TaleMe! son propiedad exclusiva de TaleMe! y están protegidos por la normativa de propiedad intelectual. Queda prohibido su uso sin autorización.
123 |                 </p>
124 |               </div>
125 | 
126 |               <div>
127 |                 <h2 className="text-xl font-bold text-[#BB79D1]">9. EXENCIÓN DE GARANTÍAS Y LIMITACIÓN DE RESPONSABILIDAD</h2>
128 |                 <p className="mt-2">
129 |                   TaleMe! proporciona la Plataforma "tal cual" y "según disponibilidad".
130 |                 </p>
131 |                 <p className="mt-2">
132 |                   No garantiza la continuidad, puntualidad o ausencia de errores.
133 |                 </p>
134 |                 <p className="mt-2">
135 |                   No será responsable de daños directos o indirectos derivados del uso o imposibilidad de uso de la Plataforma, ni de la pérdida de datos.
136 |                 </p>
137 |               </div>
138 | 
139 |               <div>
140 |                 <h2 className="text-xl font-bold text-[#BB79D1]">10. POLÍTICA DE PRIVACIDAD</h2>
141 |                 <p className="mt-2">
142 |                   El tratamiento de datos personales se realiza conforme a la Política de Privacidad disponible en nuestra web. El Usuario puede ejercer sus derechos de acceso, rectificación, supresión y oposición enviando un email a hola@taleme.app.
143 |                 </p>
144 |               </div>
145 | 
146 |               <div>
147 |                 <h2 className="text-xl font-bold text-[#BB79D1]">11. MODIFICACIONES DE LOS TÉRMINOS</h2>
148 |                 <p className="mt-2">
149 |                   TaleMe! se reserva el derecho de modificar estos Términos en cualquier momento. Los cambios se notificarán por correo electrónico o mediante aviso en la Plataforma. Si el Usuario no está de acuerdo, podrá cancelar su cuenta y dejar de usar el servicio.
150 |                 </p>
151 |               </div>
152 | 
153 |               <div>
154 |                 <h2 className="text-xl font-bold text-[#BB79D1]">12. LEY APLICABLE Y JURISDICCIÓN</h2>
155 |                 <p className="mt-2">
156 |                   Estos Términos se rigen por la legislación española. Para cualquier controversia, las partes se someten a la jurisdicción de los Juzgados y Tribunales de Zaragoza (España), con renuncia a cualquier otro fuero.
157 |                 </p>
158 |               </div>
159 | 
160 |               <p className="italic">
161 |                 Gracias por elegir TaleMe! Estamos aquí para acompañarte en la creación de historias inolvidables.
162 |               </p>
163 |             </div>
164 |             
165 |             <div className="flex justify-center mt-6">
166 |               <Button 
167 |                 variant="default" 
168 |                 onClick={() => navigate(-1)}
169 |                 className="min-w-32"
170 |               >
171 |                 Volver
172 |               </Button>
173 |             </div>
174 |           </div>
175 |         </div>
176 |       </div>
177 |     </PageTransition>
178 |   );
179 | };
180 | 
181 | export default TermsAndConditions; 
```

src/pages/Welcome.tsx
```
1 | import { motion } from "framer-motion";
2 | import { BookOpen, Sparkles, Headphones, Brain, LogIn, UserPlus, Star, Gift, Zap } from "lucide-react";
3 | import { useNavigate, Link } from "react-router-dom";
4 | import { useEffect, useState } from "react";
5 | import PageTransition from "../components/PageTransition";
6 | import { useUserStore } from "../store/user/userStore";
7 | 
8 | interface FeatureCardProps {
9 |   icon: React.ReactNode;
10 |   title: string;
11 |   description: string;
12 |   color: string;
13 | }
14 | 
15 | export default function Welcome() {
16 |   const navigate = useNavigate();
17 |   const { checkAuth, user } = useUserStore();
18 |   const [isLoading, setIsLoading] = useState(true);
19 | 
20 |   useEffect(() => {
21 |     const checkAuthentication = async () => {
22 |       try {
23 |         const isAuthenticated = await checkAuth();
24 |         if (isAuthenticated) {
25 |           navigate("/home");
26 |         }
27 |       } catch (error) {
28 |         console.error("Error checking authentication:", error);
29 |       } finally {
30 |         setIsLoading(false);
31 |       }
32 |     };
33 | 
34 |     checkAuthentication();
35 |   }, [checkAuth, navigate]);
36 | 
37 |   if (isLoading) {
38 |     return (
39 |       <div 
40 |         className="min-h-screen flex items-center justify-center"
41 |         style={{
42 |           backgroundImage: 'url(/fondo_png.png)',
43 |           backgroundSize: 'cover',
44 |           backgroundPosition: 'center',
45 |           backgroundRepeat: 'no-repeat',
46 |         }}
47 |       >
48 |         <div className="w-16 h-16 rounded-full bg-white/30 flex items-center justify-center p-3 backdrop-blur-sm">
49 |           <div className="animate-spin h-full w-full border-4 border-[#F6A5B7] rounded-full border-t-transparent"></div>
50 |         </div>
51 |       </div>
52 |     );
53 |   }
54 | 
55 |   return (
56 |     <PageTransition>
57 |       <div 
58 |         className="min-h-screen flex flex-col items-center overflow-auto"
59 |         style={{
60 |           backgroundImage: 'url(/fondo_png.png)',
61 |           backgroundSize: 'cover',
62 |           backgroundPosition: 'center',
63 |           backgroundRepeat: 'no-repeat',
64 |         }}
65 |       >
66 |         <header className="w-full max-w-6xl px-4 sm:px-6 md:px-8 py-3 flex items-center justify-between">
67 |           <div className="flex items-center">
68 |             <img src="/logo_png.png" alt="TaleMe Logo" className="h-20 md:h-24" />
69 |           </div>
70 |           <div className="flex gap-3">
71 |             <button
72 |               onClick={() => navigate("/login")}
73 |               className="py-2 px-4 rounded-xl text-[#333] font-medium bg-white/80 hover:bg-white transition-all duration-200 shadow-md"
74 |             >
75 |               Iniciar Sesión
76 |             </button>
77 |             <button
78 |               onClick={() => navigate("/signup")}
79 |               className="py-2 px-4 rounded-xl text-white font-medium bg-[#F6A5B7] hover:bg-[#F6A5B7]/90 transition-all duration-200 shadow-md"
80 |             >
81 |               Registrarse
82 |             </button>
83 |           </div>
84 |         </header>
85 | 
86 |         <main className="w-full max-w-6xl px-4 sm:px-6 md:px-8 py-6 md:py-8 flex flex-col items-center">
87 |           {/* Hero Section */}
88 |           <motion.div
89 |             initial={{ y: 20, opacity: 0 }}
90 |             animate={{ y: 0, opacity: 1 }}
91 |             transition={{ duration: 0.8, ease: "easeOut" }}
92 |             className="text-center mb-10 md:mb-12"
93 |           >
94 |             <h1 className="text-4xl md:text-5xl lg:text-6xl font-bold mb-4 text-[#222]">
95 |               Historias mágicas <span className="text-[#BB79D1]">personalizadas</span>
96 |             </h1>
97 |             <p className="text-lg md:text-xl text-[#333] max-w-2xl mx-auto mb-8">
98 |               Crea cuentos únicos adaptados a los gustos y personalidad de cada niño, con narración de voz y retos educativos.
99 |             </p>
100 |             <motion.div
101 |               initial={{ y: 20, opacity: 0 }}
102 |               animate={{ y: 0, opacity: 1 }}
103 |               transition={{ duration: 0.8, delay: 0.4, ease: "easeOut" }}
104 |               className="flex flex-col sm:flex-row gap-4 justify-center"
105 |             >
106 |               <button
107 |                 onClick={() => navigate("/signup")}
108 |                 className="py-3 px-8 rounded-2xl text-white text-lg font-semibold bg-[#F6A5B7] hover:bg-[#F6A5B7]/90 transition-all duration-200 shadow-lg flex items-center justify-center gap-2"
109 |               >
110 |                 <BookOpen size={20} />
111 |                 <span>CREAR MI PRIMERA HISTORIA</span>
112 |               </button>
113 |             </motion.div>
114 |           </motion.div>
115 | 
116 |           {/* Features Section */}
117 |           <motion.div
118 |             initial={{ y: 20, opacity: 0 }}
119 |             animate={{ y: 0, opacity: 1 }}
120 |             transition={{ duration: 0.8, delay: 0.6, ease: "easeOut" }}
121 |             className="w-full mb-12"
122 |           >
123 |             <h2 className="text-2xl md:text-3xl font-bold text-center mb-8 text-[#222]">
124 |               ¿Qué hace especial a <span className="text-[#BB79D1]">TaleMe</span>?
125 |             </h2>
126 | 
127 |             <div className="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
128 |               <FeatureCard
129 |                 icon={<Sparkles className="w-6 h-6" />}
130 |                 title="Historias Personalizadas"
131 |                 description="Cuentos adaptados a los gustos, edad y personalidad de cada niño."
132 |                 color="#F6A5B7"
133 |               />
134 |               <FeatureCard
135 |                 icon={<Headphones className="w-6 h-6" />}
136 |                 title="Narración de Voz"
137 |                 description="Narraciones profesionales que dan vida a cada historia."
138 |                 color="#7DC4E0"
139 |               />
140 |               <FeatureCard
141 |                 icon={<Brain className="w-6 h-6" />}
142 |                 title="Retos Educativos"
143 |                 description="Mejora la lectura, matemáticas e idiomas con juegos divertidos."
144 |                 color="#BB79D1"
145 |               />
146 |             </div>
147 |           </motion.div>
148 | 
149 |           {/* Benefits Section */}
150 |           <motion.div
151 |             initial={{ y: 20, opacity: 0 }}
152 |             animate={{ y: 0, opacity: 1 }}
153 |             transition={{ duration: 0.8, delay: 0.8, ease: "easeOut" }}
154 |             className="w-full mb-12 bg-white/70 rounded-3xl p-8 shadow-lg border border-[#BB79D1]/20"
155 |           >
156 |             <h2 className="text-2xl md:text-3xl font-bold text-center mb-8 text-[#222]">
157 |               Beneficios para toda la familia
158 |             </h2>
159 | 
160 |             <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
161 |               <BenefitItem
162 |                 icon={<Star className="text-[#F9DA60]" size={24} />}
163 |                 title="Fomenta la imaginación"
164 |                 description="Historias que estimulan la creatividad y el pensamiento."
165 |               />
166 |               <BenefitItem
167 |                 icon={<BookOpen className="text-[#F6A5B7]" size={24} />}
168 |                 title="Mejora la lectura"
169 |                 description="Desarrolla habilidades de comprensión y vocabulario."
170 |               />
171 |               <BenefitItem
172 |                 icon={<Gift className="text-[#BB79D1]" size={24} />}
173 |                 title="Momentos especiales"
174 |                 description="Crea recuerdos únicos con historias personalizadas."
175 |               />
176 |               <BenefitItem
177 |                 icon={<Zap className="text-[#7DC4E0]" size={24} />}
178 |                 title="Aprendizaje divertido"
179 |                 description="Retos educativos integrados en cada historia."
180 |               />
181 |               <BenefitItem
182 |                 icon={<Brain className="text-[#F6A5B7]" size={24} />}
183 |                 title="Desarrollo cognitivo"
184 |                 description="Estimula el pensamiento crítico y la resolución de problemas."
185 |               />
186 |               <BenefitItem
187 |                 icon={<Sparkles className="text-[#F9DA60]" size={24} />}
188 |                 title="Personalización total"
189 |                 description="Adapta cada historia a los intereses del niño."
190 |               />
191 |             </div>
192 |           </motion.div>
193 |         </main>
194 |       </div>
195 |     </PageTransition>
196 |   );
197 | }
198 | 
199 | function FeatureCard({ icon, title, description, color }: FeatureCardProps) {
200 |   return (
201 |     <div className="bg-white/70 rounded-2xl p-6 shadow-lg border border-[#BB79D1]/20 h-full transition-all duration-300 hover:shadow-xl hover:transform hover:scale-105">
202 |       <div className="flex items-center mb-4">
203 |         <div 
204 |           className="w-12 h-12 rounded-full flex items-center justify-center mr-4"
205 |           style={{ backgroundColor: `${color}30` }}
206 |         >
207 |           <div className="text-[#333]" style={{ color }}>
208 |             {icon}
209 |           </div>
210 |         </div>
211 |         <h3 className="text-xl font-semibold text-[#333]">{title}</h3>
212 |       </div>
213 |       <p className="text-[#555]">{description}</p>
214 |     </div>
215 |   );
216 | }
217 | 
218 | function BenefitItem({ icon, title, description }: { icon: React.ReactNode; title: string; description: string }) {
219 |   return (
220 |     <div className="flex items-start">
221 |       <div className="mr-4 mt-1">
222 |         {icon}
223 |       </div>
224 |       <div>
225 |         <h4 className="text-lg font-semibold text-[#333] mb-1">{title}</h4>
226 |         <p className="text-[#555]">{description}</p>
227 |       </div>
228 |     </div>
229 |   );
230 | }
```

src/services/pdfService.ts
```
1 | import jsPDF from 'jspdf';
2 | import html2canvas from 'html2canvas';
3 | import { APP_CONFIG } from '../config/app';
4 | 
5 | interface StoryPDFOptions {
6 |   title: string;
7 |   author?: string;
8 |   content: string;
9 |   coverImageUrl?: string;
10 | }
11 | 
12 | /**
13 |  * Servicio para la generación de PDFs de cuentos
14 |  */
15 | export const PdfService = {
16 |   /**
17 |    * Genera un PDF con una portada personalizada y el contenido del cuento
18 |    * @param options Opciones para la generación del PDF
19 |    * @returns Promise que resuelve con un Blob del PDF generado
20 |    */
21 |   async generateStoryPdf(options: StoryPDFOptions): Promise<Blob> {
22 |     const { title, author, content } = options;
23 |     const pdf = new jsPDF('p', 'mm', 'a4');
24 |     const pageWidth = pdf.internal.pageSize.getWidth();
25 |     const pageHeight = pdf.internal.pageSize.getHeight();
26 |     
27 |     // Colores y estilos
28 |     const backgroundColor = '#fff6e0';
29 |     const textColor = '#ce9789'; // Color más amigable para niños
30 |     const titleColor = '#BB79D1';
31 |     
32 |     // Agregar la portada
33 |     await this.addCoverPage(pdf, title, author);
34 |     
35 |     // Agregar el contenido
36 |     await this.addContentPages(pdf, content, backgroundColor, textColor, title);
37 |     
38 |     // Agregar contraportada
39 |     await this.addBackCoverPage(pdf);
40 |     
41 |     // Añadir pie de página a todas las páginas
42 |     const totalPages = pdf.getNumberOfPages ? pdf.getNumberOfPages() : pdf.internal.pages.length - 1;
43 |     for (let i = 1; i <= totalPages; i++) {
44 |       pdf.setPage(i);
45 |       this.addFooter(pdf, i, totalPages);
46 |     }
47 |     
48 |     return pdf.output('blob');
49 |   },
50 |   
51 |   /**
52 |    * Crea la portada del PDF
53 |    */
54 |   async addCoverPage(pdf: jsPDF, title: string, author?: string): Promise<void> {
55 |     const pageWidth = pdf.internal.pageSize.getWidth();
56 |     const pageHeight = pdf.internal.pageSize.getHeight();
57 |     
58 |     // Establecer el fondo de la portada
59 |     pdf.setFillColor(255, 246, 224); // #fff6e0 en RGB
60 |     pdf.rect(0, 0, pageWidth, pageHeight, 'F');
61 |     
62 |     // Cargar la imagen de fondo
63 |     try {
64 |       // Simulamos cargar la imagen de fondo usando html2canvas
65 |       const backgroundDiv = document.createElement('div');
66 |       backgroundDiv.style.backgroundImage = 'url(/fondo_png.png)';
67 |       backgroundDiv.style.backgroundSize = 'cover';
68 |       backgroundDiv.style.width = '210mm';
69 |       backgroundDiv.style.height = '297mm';
70 |       document.body.appendChild(backgroundDiv);
71 |       
72 |       const canvas = await html2canvas(backgroundDiv, {
73 |         scale: 2,
74 |         logging: false,
75 |         useCORS: true
76 |       });
77 |       
78 |       document.body.removeChild(backgroundDiv);
79 |       
80 |       // Agregar imagen de fondo con opacidad
81 |       const imgData = canvas.toDataURL('image/png');
82 |       // Usar método alternativo para manejar la opacidad
83 |       const opacity = 0.15;
84 |       // Las versiones más nuevas de jsPDF tienen globalAlpha en options
85 |       try {
86 |         // Intentar primero con la versión más nueva de la API
87 |         pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight, undefined, 'FAST', 0);
88 |       } catch (e) {
89 |         // Si falla, intentar con la API estándar
90 |         pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);
91 |       }
92 |     } catch (error) {
93 |       console.error('Error al cargar la imagen de fondo:', error);
94 |     }
95 |     
96 |     // Agregar el logo
97 |     try {
98 |       const logo = new Image();
99 |       logo.src = '/logo_png.png';
100 |       
101 |       // Esperar a que el logo se cargue
102 |       await new Promise<void>((resolve) => {
103 |         logo.onload = () => resolve();
104 |         logo.onerror = () => {
105 |           console.error('Error al cargar el logo');
106 |           resolve();
107 |         };
108 |       });
109 |       
110 |       // Crear un canvas temporal para el logo
111 |       const logoCanvas = document.createElement('canvas');
112 |       const logoWidth = 60; // ancho en mm
113 |       const logoHeight = (logo.height / logo.width) * logoWidth;
114 |       
115 |       logoCanvas.width = logo.width;
116 |       logoCanvas.height = logo.height;
117 |       const ctx = logoCanvas.getContext('2d');
118 |       if (ctx) {  // Verificar que el contexto no sea null
119 |         ctx.drawImage(logo, 0, 0, logo.width, logo.height);
120 |         
121 |         const logoData = logoCanvas.toDataURL('image/png');
122 |         pdf.addImage(logoData, 'PNG', (pageWidth - logoWidth) / 2, 40, logoWidth, logoHeight);
123 |       }
124 |     } catch (error) {
125 |       console.error('Error al cargar el logo:', error);
126 |     }
127 |     
128 |     // Añadir el título
129 |     pdf.setFont('helvetica', 'bold');
130 |     pdf.setTextColor('#BB79D1'); // Morado de la marca
131 |     
132 |     // Ajustar el tamaño de la fuente según la longitud del título
133 |     const titleFontSize = Math.min(32, 1000 / title.length);
134 |     pdf.setFontSize(titleFontSize);
135 |     
136 |     const titleWidth = pdf.getStringUnitWidth(title) * titleFontSize / pdf.internal.scaleFactor;
137 |     const titleX = (pageWidth - titleWidth) / 2;
138 |     
139 |     // Agregar título
140 |     pdf.text(title, pageWidth / 2, pageHeight / 2, { align: 'center' });
141 |     
142 |     // Agregar autor si existe
143 |     if (author) {
144 |       pdf.setFont('helvetica', 'italic');
145 |       pdf.setTextColor('#555555');
146 |       pdf.setFontSize(12);
147 |       pdf.text(`por ${author}`, pageWidth / 2, pageHeight / 2 + 15, { align: 'center' });
148 |     }
149 |     
150 |     // Agregar fecha de generación
151 |     const currentDate = new Date().toLocaleDateString();
152 |     pdf.setFont('helvetica', 'normal');
153 |     pdf.setFontSize(10);
154 |     pdf.setTextColor('#777777');
155 |     pdf.text(`Generado por ${APP_CONFIG.name}!`, pageWidth / 2, pageHeight - 20, { align: 'center' });
156 |   },
157 |   
158 |   /**
159 |    * Agrega las páginas con el contenido del cuento
160 |    */
161 |   async addContentPages(pdf: jsPDF, content: string, backgroundColor: string, textColor: string, title: string): Promise<void> {
162 |     // Añadir una nueva página para el contenido
163 |     pdf.addPage();
164 |     
165 |     const pageWidth = pdf.internal.pageSize.getWidth();
166 |     const pageHeight = pdf.internal.pageSize.getHeight();
167 |     
168 |     // Establecer el color de fondo blanco para las páginas de contenido
169 |     pdf.setFillColor(255, 255, 255); // Blanco
170 |     pdf.rect(0, 0, pageWidth, pageHeight, 'F');
171 |     
172 |     // Añadir encabezado con logo y título
173 |     await this.addHeaderToPage(pdf, title);
174 |     
175 |     // Configurar estilos de texto para el contenido - más grande y negrita para niños
176 |     pdf.setFont('helvetica', 'bold');
177 |     pdf.setFontSize(16); // Letra más grande para mejor legibilidad infantil
178 |     pdf.setTextColor(textColor);
179 |     
180 |     // Márgenes
181 |     const margin = 25; // Márgenes más amplios para mejor experiencia de lectura
182 |     const effectiveWidth = pageWidth - 2 * margin;
183 |     
184 |     // Dividir el contenido en párrafos
185 |     const paragraphs = content.split('\n\n');
186 |     if (paragraphs.length === 1) {
187 |       // Si solo hay un párrafo, dividir por saltos de línea simples
188 |       paragraphs.splice(0, 1, ...content.split('\n'));
189 |     }
190 |     
191 |     // Contador para llevar la posición Y actual
192 |     let yPos = margin + 20; // Aumentamos el margen superior para dar espacio al encabezado
193 |     
194 |     // Iterar sobre cada párrafo
195 |     for (const paragraph of paragraphs) {
196 |       if (paragraph.trim() === '') continue;
197 |       
198 |       // Dividir el texto en líneas para que quepa dentro de la página
199 |       const lines = pdf.splitTextToSize(paragraph, effectiveWidth);
200 |       
201 |       // Verificar si necesitamos una nueva página para este párrafo
202 |       if (yPos + lines.length * 9 > pageHeight - margin) {
203 |         pdf.addPage();
204 |         pdf.setFillColor(255, 255, 255); // Fondo blanco para las nuevas páginas de contenido
205 |         pdf.rect(0, 0, pageWidth, pageHeight, 'F');
206 |         
207 |         // Añadir encabezado en la nueva página
208 |         await this.addHeaderToPage(pdf, title);
209 |         
210 |         // Importante: restaurar el color del texto después de añadir el encabezado
211 |         pdf.setFont('helvetica', 'bold');
212 |         pdf.setFontSize(16);
213 |         pdf.setTextColor(textColor); // Restauramos el color original para el contenido
214 |         
215 |         yPos = margin + 20; // Reiniciar posición Y considerando espacio para el encabezado
216 |       }
217 |       
218 |       // Agregar las líneas del párrafo
219 |       pdf.text(lines, margin, yPos);
220 |       
221 |       // Actualizar la posición Y para el siguiente párrafo con menos espaciado
222 |       yPos += lines.length * 9 + 3; // Reducido el espaciado entre párrafos
223 |     }
224 |   },
225 | 
226 |   /**
227 |    * Agrega un encabezado a la página actual con logo en miniatura y título
228 |    */
229 |   async addHeaderToPage(pdf: jsPDF, title: string): Promise<void> {
230 |     const pageWidth = pdf.internal.pageSize.getWidth();
231 |     
232 |     // Añadir logo en miniatura
233 |     try {
234 |       const logo = new Image();
235 |       logo.src = '/logo_png.png';
236 |       
237 |       // Esperar a que el logo se cargue
238 |       await new Promise<void>((resolve) => {
239 |         logo.onload = () => resolve();
240 |         logo.onerror = () => {
241 |           console.error('Error al cargar el logo para el encabezado');
242 |           resolve();
243 |         };
244 |       });
245 |       
246 |       // Crear un canvas temporal para el logo
247 |       const logoCanvas = document.createElement('canvas');
248 |       const logoWidth = 15; // ancho en mm (más pequeño para el encabezado)
249 |       const logoHeight = (logo.height / logo.width) * logoWidth;
250 |       
251 |       logoCanvas.width = logo.width;
252 |       logoCanvas.height = logo.height;
253 |       const ctx = logoCanvas.getContext('2d');
254 |       if (ctx) {
255 |         ctx.drawImage(logo, 0, 0, logo.width, logo.height);
256 |         
257 |         const logoData = logoCanvas.toDataURL('image/png');
258 |         
259 |         // Posicionar logo en esquina superior izquierda con un margen
260 |         pdf.addImage(logoData, 'PNG', 10, 10, logoWidth, logoHeight);
261 |       }
262 |     } catch (error) {
263 |       console.error('Error al añadir logo al encabezado:', error);
264 |     }
265 |     
266 |     // Añadir título en esquina superior derecha
267 |     if (title) {
268 |       // Configurar estilo infantil y amigable para el encabezado
269 |       pdf.setFont('helvetica', 'bold'); // Cambiar a negrita para mejor legibilidad infantil
270 |       pdf.setFontSize(12); // Ligeramente más grande
271 |       pdf.setTextColor('#BB79D1'); // Color de marca TaleMe
272 |       
273 |       // Truncar título si es muy largo
274 |       let displayTitle = title;
275 |       if (displayTitle.length > 30) {
276 |         displayTitle = displayTitle.substring(0, 27) + '...';
277 |       }
278 |       
279 |       // Dibujar un fondo suave para el título
280 |       const titleWidth = pdf.getStringUnitWidth(displayTitle) * 12 / pdf.internal.scaleFactor;
281 |       const padding = 3; // Padding en mm
282 |       
283 |       pdf.setFillColor(240, 248, 255); // Fondo azul muy suave para mejor contraste en fondo blanco
284 |       pdf.roundedRect(pageWidth - titleWidth - 20, 8, titleWidth + 10, 10, 2, 2, 'F');
285 |       
286 |       // Posicionar en esquina superior derecha con fondo
287 |       pdf.text(displayTitle, pageWidth - 15, 15, { align: 'right' });
288 |     }
289 |   },
290 | 
291 |   /**
292 |    * Agrega una contraportada al PDF con logo y texto de cierre
293 |    */
294 |   async addBackCoverPage(pdf: jsPDF): Promise<void> {
295 |     pdf.addPage();
296 |     const pageWidth = pdf.internal.pageSize.getWidth();
297 |     const pageHeight = pdf.internal.pageSize.getHeight();
298 |     
299 |     // Establecer el fondo de la contraportada
300 |     pdf.setFillColor(255, 246, 224); // #fff6e0 en RGB
301 |     pdf.rect(0, 0, pageWidth, pageHeight, 'F');
302 |     
303 |     // Cargar la imagen de fondo con baja opacidad
304 |     try {
305 |       // Simulamos cargar la imagen de fondo usando html2canvas
306 |       const backgroundDiv = document.createElement('div');
307 |       backgroundDiv.style.backgroundImage = 'url(/fondo_png.png)';
308 |       backgroundDiv.style.backgroundSize = 'cover';
309 |       backgroundDiv.style.width = '210mm';
310 |       backgroundDiv.style.height = '297mm';
311 |       document.body.appendChild(backgroundDiv);
312 |       
313 |       const canvas = await html2canvas(backgroundDiv, {
314 |         scale: 2,
315 |         logging: false,
316 |         useCORS: true
317 |       });
318 |       
319 |       document.body.removeChild(backgroundDiv);
320 |       
321 |       // Agregar imagen de fondo con opacidad
322 |       const imgData = canvas.toDataURL('image/png');
323 |       try {
324 |         pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight, undefined, 'FAST', 0);
325 |       } catch (e) {
326 |         pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);
327 |       }
328 |     } catch (error) {
329 |       console.error('Error al cargar la imagen de fondo:', error);
330 |     }
331 |     
332 |     // Agregar el logo
333 |     try {
334 |       const logo = new Image();
335 |       logo.src = '/logo_png.png';
336 |       
337 |       // Esperar a que el logo se cargue
338 |       await new Promise<void>((resolve) => {
339 |         logo.onload = () => resolve();
340 |         logo.onerror = () => {
341 |           console.error('Error al cargar el logo');
342 |           resolve();
343 |         };
344 |       });
345 |       
346 |       // Crear un canvas temporal para el logo
347 |       const logoCanvas = document.createElement('canvas');
348 |       const logoWidth = 50; // ancho en mm
349 |       const logoHeight = (logo.height / logo.width) * logoWidth;
350 |       
351 |       logoCanvas.width = logo.width;
352 |       logoCanvas.height = logo.height;
353 |       const ctx = logoCanvas.getContext('2d');
354 |       if (ctx) {
355 |         ctx.drawImage(logo, 0, 0, logo.width, logo.height);
356 |         
357 |         const logoData = logoCanvas.toDataURL('image/png');
358 |         pdf.addImage(logoData, 'PNG', (pageWidth - logoWidth) / 2, pageHeight / 3 - 25, logoWidth, logoHeight);
359 |       }
360 |     } catch (error) {
361 |       console.error('Error al cargar el logo:', error);
362 |     }
363 |     
364 |     pdf.setFont('helvetica', 'bold');
365 |     pdf.setTextColor('#BB79D1');
366 |     pdf.setFontSize(18);
367 |     pdf.text(`Generado por ${APP_CONFIG.name}!`, pageWidth / 2, pageHeight / 2 - 10, { align: 'center' });
368 |     
369 |     // Agregar año actual
370 |     const currentYear = new Date().getFullYear().toString();
371 |     pdf.setFontSize(14);
372 |     pdf.setFont('helvetica', 'normal');
373 |     pdf.setTextColor('#777777');
374 |     pdf.text(currentYear, pageWidth / 2, pageHeight / 2 + 30, { align: 'center' });
375 |   },
376 |   
377 |   /**
378 |    * Añade un pie de página a la página actual
379 |    */
380 |   addFooter(pdf: jsPDF, currentPage: number, totalPages: number): void {
381 |     const pageWidth = pdf.internal.pageSize.getWidth();
382 |     const pageHeight = pdf.internal.pageSize.getHeight();
383 |     
384 |     pdf.setFontSize(8);
385 |     pdf.setTextColor('#777777');
386 |     
387 |     // Agregar número de página
388 |     pdf.text(`${currentPage} / ${totalPages}`, pageWidth - 20, pageHeight - 10);
389 |     
390 |     // Agregar nombre de la aplicación y versión
391 |     pdf.text(`${APP_CONFIG.name} v${APP_CONFIG.version}`, 20, pageHeight - 10);
392 |   },
393 |   
394 |   /**
395 |    * Descarga el PDF generado
396 |    */
397 |   downloadPdf(blob: Blob, filename: string): void {
398 |     const url = URL.createObjectURL(blob);
399 |     const link = document.createElement('a');
400 |     link.href = url;
401 |     link.download = filename.endsWith('.pdf') ? filename : `${filename}.pdf`;
402 |     document.body.appendChild(link);
403 |     link.click();
404 |     document.body.removeChild(link);
405 |     URL.revokeObjectURL(url);
406 |   }
407 | }; 
```

src/services/storyPdfService.ts
```
1 | import { supabase } from '../supabaseClient';
2 | import { IMAGES_TYPE } from '../constants/story-images.constant';
3 | import { PdfService } from './pdfService';
4 | import { ImageGenerationService } from './ai/imageGenerationService';
5 | import jsPDF from 'jspdf';
6 | import { APP_CONFIG } from '../config/app';
7 | 
8 | interface ImageValidationResult {
9 |   cover: boolean;
10 |   scene_1: boolean;
11 |   scene_2: boolean;
12 |   allValid: boolean;
13 |   missingImages: string[];
14 |   imageUrls?: {
15 |     cover?: string;
16 |     scene_1?: string;
17 |     scene_2?: string;
18 |   };
19 | }
20 | 
21 | interface StoryPdfGenerationOptions {
22 |   title: string;
23 |   author?: string;
24 |   content: string;
25 |   storyId: string;
26 |   chapterId: string;
27 | }
28 | 
29 | interface IllustratedPdfGenerationOptions extends StoryPdfGenerationOptions {
30 |   imageUrls: {
31 |     cover: string;
32 |     scene_1: string;
33 |     scene_2: string;
34 |   };
35 | }
36 | 
37 | /**
38 |  * Interface for progress tracking during image generation
39 |  */
40 | export interface ImageGenerationProgress {
41 |   currentStep: string;
42 |   currentImageType?: string;
43 |   completedImages: number;
44 |   totalImages: number;
45 |   progress: number; // 0-100
46 | }
47 | 
48 | /**
49 |  * Interface for complete illustrated PDF generation with automatic image generation
50 |  */
51 | interface CompleteIllustratedPdfOptions extends StoryPdfGenerationOptions {
52 |   onProgress?: (progress: ImageGenerationProgress) => void;
53 | }
54 | 
55 | /**
56 |  * Service for handling story PDF generation with image validation and illustrated PDF creation
57 |  */
58 | export class StoryPdfService {
59 |   private static readonly REQUIRED_IMAGES = [IMAGES_TYPE.COVER, IMAGES_TYPE.SCENE_1, IMAGES_TYPE.SCENE_2];
60 |   private static readonly IMAGE_BUCKET = 'images-stories';
61 | 
62 | 
63 | 
64 |   /**
65 |    * Validates that all required images exist in Supabase storage for illustrated PDF generation
66 |    * @param storyId Story identifier
67 |    * @param chapterId Chapter identifier
68 |    * @returns Promise with validation results and image URLs if available
69 |    */
70 |   static async validateRequiredImages(storyId: string, chapterId: string): Promise<ImageValidationResult> {
71 |     const validationResult: ImageValidationResult = {
72 |       cover: false,
73 |       scene_1: false,
74 |       scene_2: false,
75 |       allValid: false,
76 |       missingImages: [],
77 |       imageUrls: {}
78 |     };
79 | 
80 |     try {
81 |       console.log('[StoryPdfService] Validating images for story:', storyId, 'chapter:', chapterId);
82 | 
83 |       for (const imageType of this.REQUIRED_IMAGES) {
84 |         const imagePath = `${storyId}/${chapterId}/${imageType}.jpeg`;
85 |         
86 |         // Get public URL from Supabase storage
87 |         const { data } = supabase.storage
88 |           .from(this.IMAGE_BUCKET)
89 |           .getPublicUrl(imagePath);
90 | 
91 |         if (data?.publicUrl) {
92 |           // Validate image accessibility with HTTP HEAD request
93 |           try {
94 |             const response = await fetch(data.publicUrl, { method: 'HEAD' });
95 |             if (response.ok) {
96 |               validationResult[imageType as keyof Omit<ImageValidationResult, 'allValid' | 'missingImages' | 'imageUrls'>] = true;
97 |               validationResult.imageUrls![imageType as keyof NonNullable<ImageValidationResult['imageUrls']>] = data.publicUrl;
98 |               console.log(`[StoryPdfService] ✅ Found ${imageType}: ${data.publicUrl}`);
99 |             } else {
100 |               console.log(`[StoryPdfService] ❌ Image ${imageType} not accessible:`, response.status);
101 |               validationResult.missingImages.push(this.getImageDisplayName(imageType));
102 |             }
103 |           } catch (fetchError) {
104 |             console.log(`[StoryPdfService] ❌ Error accessing ${imageType}:`, fetchError);
105 |             validationResult.missingImages.push(this.getImageDisplayName(imageType));
106 |           }
107 |         } else {
108 |           console.log(`[StoryPdfService] ❌ No public URL for ${imageType}`);
109 |           validationResult.missingImages.push(this.getImageDisplayName(imageType));
110 |         }
111 |       }
112 | 
113 |       validationResult.allValid = validationResult.cover && validationResult.scene_1 && validationResult.scene_2;
114 |       console.log('[StoryPdfService] Image validation results:', validationResult);
115 |       
116 |       return validationResult;
117 |     } catch (error) {
118 |       console.error('[StoryPdfService] Error validating images:', error);
119 |       // Return all images as missing on error
120 |       validationResult.missingImages = this.REQUIRED_IMAGES.map(this.getImageDisplayName);
121 |       return validationResult;
122 |     }
123 |   }
124 | 
125 |   /**
126 |    * Generates standard TaleMe format PDF (text only)
127 |    * @param options PDF generation options
128 |    * @returns Promise with generated PDF blob
129 |    */
130 |   static async generateStandardPdf(options: StoryPdfGenerationOptions): Promise<Blob> {
131 |     try {
132 |       console.log('[StoryPdfService] Generating standard PDF for:', options.title);
133 |       
134 |       const pdfBlob = await PdfService.generateStoryPdf({
135 |         title: options.title,
136 |         author: options.author,
137 |         content: options.content
138 |       });
139 |       
140 |       console.log('[StoryPdfService] Standard PDF generated successfully');
141 |       return pdfBlob;
142 |     } catch (error) {
143 |       console.error('[StoryPdfService] Error generating standard PDF:', error);
144 |       throw new Error(`Failed to generate standard PDF: ${error instanceof Error ? error.message : 'Unknown error'}`);
145 |     }
146 |   }
147 | 
148 |   /**
149 |    * Generates illustrated PDF with images from storage
150 |    * @param options Illustrated PDF generation options with image URLs
151 |    * @returns Promise with generated PDF blob
152 |    */
153 |   static async generateIllustratedPdf(options: IllustratedPdfGenerationOptions): Promise<Blob> {
154 |     try {
155 |       console.log('[StoryPdfService] Generating illustrated PDF for:', options.title);
156 |       console.log('[StoryPdfService] Image URLs for PDF:', options.imageUrls);
157 |       
158 |       const pdf = new jsPDF('p', 'mm', 'a4');
159 |       const pageWidth = pdf.internal.pageSize.getWidth();
160 |       const pageHeight = pdf.internal.pageSize.getHeight();
161 |       
162 |       // Colors and styles for children's book
163 |       const textColor = '#2c3e50'; // Darker text for better readability over images
164 |       const titleColor = '#BB79D1';
165 |       
166 |       // Convert image URLs to base64 data URLs
167 |       const coverImageData = await this.loadImageAsDataUrl(options.imageUrls.cover);
168 |       const scene1ImageData = await this.loadImageAsDataUrl(options.imageUrls.scene_1);
169 |       const scene2ImageData = await this.loadImageAsDataUrl(options.imageUrls.scene_2);
170 |       
171 |       // Add illustrated cover page
172 |       await this.addIllustratedCoverPage(pdf, options.title, options.author, coverImageData);
173 |       
174 |       // Add illustrated content pages
175 |       await this.addIllustratedContentPages(
176 |         pdf, 
177 |         options.content, 
178 |         textColor, 
179 |         options.title,
180 |         scene1ImageData,
181 |         scene2ImageData
182 |       );
183 |       
184 |       // Add back cover (same as standard)
185 |       await this.addBackCoverPage(pdf);
186 |       
187 |       // Add footer to all pages
188 |       const totalPages = pdf.getNumberOfPages ? pdf.getNumberOfPages() : pdf.internal.pages.length - 1;
189 |       for (let i = 1; i <= totalPages; i++) {
190 |         pdf.setPage(i);
191 |         this.addFooter(pdf, i, totalPages);
192 |       }
193 |       
194 |       console.log('[StoryPdfService] Illustrated PDF generated successfully');
195 |       return pdf.output('blob');
196 |     } catch (error) {
197 |       console.error('[StoryPdfService] Error generating illustrated PDF:', error);
198 |       throw new Error(`Failed to generate illustrated PDF: ${error instanceof Error ? error.message : 'Unknown error'}`);
199 |     }
200 |   }
201 | 
202 |   /**
203 |    * Downloads a PDF blob with appropriate filename
204 |    * @param pdfBlob PDF blob to download
205 |    * @param title Story title for filename
206 |    * @param isIllustrated Whether this is an illustrated PDF
207 |    */
208 |   static downloadPdf(pdfBlob: Blob, title: string, isIllustrated: boolean = false): void {
209 |     try {
210 |       const safeName = title.toLowerCase().replace(/[^a-z0-9]/g, '-');
211 |       const prefix = isIllustrated ? 'taleme-cuento-ilustrado' : 'taleme-cuento';
212 |       const filename = `${prefix}-${safeName}.pdf`;
213 |       
214 |       PdfService.downloadPdf(pdfBlob, filename);
215 |       console.log(`[StoryPdfService] PDF downloaded: ${filename}`);
216 |     } catch (error) {
217 |       console.error('[StoryPdfService] Error downloading PDF:', error);
218 |       throw new Error(`Failed to download PDF: ${error instanceof Error ? error.message : 'Unknown error'}`);
219 |     }
220 |   }
221 | 
222 |   /**
223 |    * Gets human-readable display name for image type
224 |    * @param imageType Technical image type identifier
225 |    * @returns Human-readable name in Spanish
226 |    */
227 |   private static getImageDisplayName(imageType: string): string {
228 |     const displayNames: Record<string, string> = {
229 |       [IMAGES_TYPE.COVER]: 'Portada',
230 |       [IMAGES_TYPE.SCENE_1]: 'Escena 1',
231 |       [IMAGES_TYPE.SCENE_2]: 'Escena 2',
232 |       [IMAGES_TYPE.CHARACTER]: 'Personaje'
233 |     };
234 |     
235 |     return displayNames[imageType] || imageType;
236 |   }
237 | 
238 |   /**
239 |    * Validates if illustrated PDF generation is possible for given story
240 |    * @param storyId Story identifier
241 |    * @param chapterId Chapter identifier
242 |    * @returns Promise with validation result and details
243 |    */
244 |   static async canGenerateIllustratedPdf(storyId: string, chapterId: string): Promise<{
245 |     canGenerate: boolean;
246 |     reason?: string;
247 |     missingImages?: string[];
248 |   }> {
249 |     try {
250 |       const validation = await this.validateRequiredImages(storyId, chapterId);
251 |       
252 |       if (validation.allValid) {
253 |         return { canGenerate: true };
254 |       } else {
255 |         return {
256 |           canGenerate: false,
257 |           reason: `Faltan imágenes necesarias: ${validation.missingImages.join(', ')}`,
258 |           missingImages: validation.missingImages
259 |         };
260 |       }
261 |     } catch (error) {
262 |       console.error('[StoryPdfService] Error checking illustrated PDF capability:', error);
263 |       return {
264 |         canGenerate: false,
265 |         reason: 'Error al verificar las imágenes disponibles'
266 |       };
267 |     }
268 |   }
269 | 
270 |   /**
271 |    * Loads an image from URL and converts it to base64 data URL
272 |    * @param imageUrl Public URL of the image
273 |    * @returns Promise with base64 data URL
274 |    */
275 |   private static async loadImageAsDataUrl(imageUrl: string): Promise<string> {
276 |     try {
277 |       console.log('[StoryPdfService] Loading image from URL:', imageUrl);
278 |       
279 |       return new Promise((resolve, reject) => {
280 |         const img = new Image();
281 |         img.crossOrigin = 'anonymous'; // Enable CORS
282 |         
283 |         img.onload = () => {
284 |           try {
285 |             // Create canvas to convert image to base64
286 |             const canvas = document.createElement('canvas');
287 |             const ctx = canvas.getContext('2d');
288 |             
289 |             if (!ctx) {
290 |               reject(new Error('Could not get canvas context'));
291 |               return;
292 |             }
293 |             
294 |             canvas.width = img.width;
295 |             canvas.height = img.height;
296 |             
297 |             // Draw image on canvas
298 |             ctx.drawImage(img, 0, 0);
299 |             
300 |             // Convert to data URL
301 |             const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
302 |             console.log('[StoryPdfService] Image loaded and converted to data URL');
303 |             resolve(dataUrl);
304 |           } catch (error) {
305 |             console.error('[StoryPdfService] Error converting image to data URL:', error);
306 |             reject(error);
307 |           }
308 |         };
309 |         
310 |         img.onerror = () => {
311 |           console.error('[StoryPdfService] Error loading image from URL:', imageUrl);
312 |           reject(new Error(`Failed to load image from URL: ${imageUrl}`));
313 |         };
314 |         
315 |         img.src = imageUrl;
316 |       });
317 |     } catch (error) {
318 |       console.error('[StoryPdfService] Error in loadImageAsDataUrl:', error);
319 |       throw error;
320 |     }
321 |   }
322 | 
323 |     /**
324 |    * Creates an illustrated cover page using the cover image
325 |    * @param pdf jsPDF instance
326 |    * @param title Story title
327 |    * @param author Story author
328 |    * @param coverImageData Base64 image data
329 |    */
330 |   private static async addIllustratedCoverPage(pdf: jsPDF, title: string, author?: string, coverImageData?: string): Promise<void> {
331 |     const pageWidth = pdf.internal.pageSize.getWidth();
332 |     const pageHeight = pdf.internal.pageSize.getHeight();
333 |     
334 |     try {
335 |       if (coverImageData) {
336 |         // Add cover image as full background - no overlays, image contains the title
337 |         pdf.addImage(coverImageData, 'JPEG', 0, 0, pageWidth, pageHeight);
338 |         
339 |         // Only add TaleMe logo in corner for branding
340 |         await this.addLogoToPage(pdf, 15, 15, 25);
341 |       } else {
342 |         // Fallback to standard cover if image fails
343 |         pdf.setFillColor(255, 246, 224);
344 |         pdf.rect(0, 0, pageWidth, pageHeight, 'F');
345 |         
346 |         // If image fails, show title as fallback
347 |         pdf.setFont('helvetica', 'bold');
348 |         pdf.setTextColor('#BB79D1');
349 |         const titleFontSize = Math.min(28, 800 / title.length);
350 |         pdf.setFontSize(titleFontSize);
351 |         pdf.text(title, pageWidth / 2, pageHeight / 2, { align: 'center' });
352 |         
353 |         if (author) {
354 |           pdf.setFont('helvetica', 'italic');
355 |           pdf.setFontSize(14);
356 |           pdf.setTextColor('#555555');
357 |           pdf.text(`por ${author}`, pageWidth / 2, pageHeight / 2 + 20, { align: 'center' });
358 |         }
359 |         
360 |         await this.addLogoToPage(pdf, 15, 15, 30);
361 |       }
362 |       
363 |     } catch (error) {
364 |       console.error('[StoryPdfService] Error creating illustrated cover:', error);
365 |       // Fallback to standard background on error
366 |       pdf.setFillColor(255, 246, 224);
367 |       pdf.rect(0, 0, pageWidth, pageHeight, 'F');
368 |     }
369 |   }
370 | 
371 |   /**
372 |    * Creates illustrated content pages with scene backgrounds
373 |    * @param pdf jsPDF instance
374 |    * @param content Story content
375 |    * @param textColor Text color
376 |    * @param title Story title
377 |    * @param scene1ImageData Scene 1 image data
378 |    * @param scene2ImageData Scene 2 image data
379 |    */
380 |   private static async addIllustratedContentPages(
381 |     pdf: jsPDF,
382 |     content: string,
383 |     textColor: string,
384 |     title: string,
385 |     scene1ImageData: string,
386 |     scene2ImageData: string
387 |   ): Promise<void> {
388 |     const pageWidth = pdf.internal.pageSize.getWidth();
389 |     const pageHeight = pdf.internal.pageSize.getHeight();
390 |     const margin = 20;
391 |     const effectiveWidth = pageWidth - 2 * margin;
392 |     
393 |     // Split content into paragraphs
394 |     const paragraphs = content.split('\n\n').filter(p => p.trim() !== '');
395 |     if (paragraphs.length === 1) {
396 |       paragraphs.splice(0, 1, ...content.split('\n').filter(p => p.trim() !== ''));
397 |     }
398 |     
399 |     // Pre-calculate approximate number of pages needed for proper image distribution
400 |     const estimatedTotalPages = this.estimateRequiredPages(content, pageWidth, pageHeight, margin);
401 |     const scene1Pages = Math.ceil(estimatedTotalPages / 2); // First half uses scene_1
402 |     
403 |     console.log(`[StoryPdfService] Estimated pages: ${estimatedTotalPages}, Scene1 pages: ${scene1Pages}, Scene2 pages: ${estimatedTotalPages - scene1Pages}`);
404 |     
405 |     let paragraphIndex = 0;
406 |     let pageIndex = 0;
407 |     
408 |     // Process all paragraphs, creating pages as needed
409 |     while (paragraphIndex < paragraphs.length) {
410 |       pdf.addPage();
411 |       
412 |       // Determine which background image to use (first half scene_1, second half scene_2)
413 |       const useScene1 = pageIndex < scene1Pages;
414 |       const backgroundImage = useScene1 ? scene1ImageData : scene2ImageData;
415 |       
416 |       console.log(`[StoryPdfService] Page ${pageIndex + 1}: Using ${useScene1 ? 'scene_1' : 'scene_2'}`);
417 |       
418 |              // Add background image - clean, no overlays
419 |        try {
420 |          pdf.addImage(backgroundImage, 'JPEG', 0, 0, pageWidth, pageHeight);
421 |        } catch (error) {
422 |          console.error('[StoryPdfService] Error adding background image:', error);
423 |          // Fallback to white background
424 |          pdf.setFillColor(255, 255, 255);
425 |          pdf.rect(0, 0, pageWidth, pageHeight, 'F');
426 |        }
427 |       
428 |       // Add header with logo and title
429 |       await this.addHeaderToPage(pdf, title);
430 |       
431 |              // Configure text style for children's book - clean black text over images
432 |        pdf.setFont('helvetica', 'bold');
433 |        pdf.setFontSize(22); // Large text for children's book readability over images
434 |        pdf.setTextColor('#000000'); // Pure black for maximum contrast
435 |        
436 |        // Add paragraphs to this page with varied positioning
437 |        let yPos = margin + 30; // Space for header
438 |        
439 |        // Process paragraphs until we run out of space or paragraphs
440 |        while (paragraphIndex < paragraphs.length) {
441 |          const paragraph = paragraphs[paragraphIndex];
442 |          
443 |          // Add some randomness to text positioning for children's book feel
444 |          const randomOffset = (Math.random() - 0.5) * 10; // ±5mm random offset
445 |          const adjustedMargin = Math.max(15, Math.min(25, margin + randomOffset));
446 |          const adjustedWidth = pageWidth - 2 * adjustedMargin;
447 |          
448 |          // Split text to fit width
449 |          const lines = pdf.splitTextToSize(paragraph, adjustedWidth);
450 |          
451 |          // Check if paragraph fits on current page (adjusted for larger text)
452 |          if (yPos + lines.length * 15 + 25 > pageHeight - margin) {
453 |            // Paragraph doesn't fit, leave it for next page
454 |            break;
455 |          }
456 |          
457 |          // Add paragraph text with white border for better visibility over images
458 |          this.drawTextWithWhiteBorder(pdf, lines, adjustedMargin, yPos);
459 |          
460 |          // Update position for next paragraph with more spacing for larger text
461 |          yPos += lines.length * 15 + 25; // Extra space between paragraphs for 22pt text
462 |          paragraphIndex++;
463 |        }
464 |        
465 |        // Move to next page
466 |        pageIndex++;
467 |     }
468 |   }
469 | 
470 |   /**
471 |    * Adds back cover page (reuses standard logic from PdfService)
472 |    */
473 |   private static async addBackCoverPage(pdf: jsPDF): Promise<void> {
474 |     pdf.addPage();
475 |     const pageWidth = pdf.internal.pageSize.getWidth();
476 |     const pageHeight = pdf.internal.pageSize.getHeight();
477 |     
478 |     // Set background color
479 |     pdf.setFillColor(255, 246, 224);
480 |     pdf.rect(0, 0, pageWidth, pageHeight, 'F');
481 |     
482 |     // Add logo
483 |     await this.addLogoToPage(pdf, (pageWidth - 50) / 2, pageHeight / 3 - 25, 50);
484 |     
485 |     // Add TaleMe text
486 |     pdf.setFont('helvetica', 'bold');
487 |     pdf.setTextColor('#BB79D1');
488 |     pdf.setFontSize(18);
489 |     pdf.text(`Generado por ${APP_CONFIG.name}!`, pageWidth / 2, pageHeight / 2 - 10, { align: 'center' });
490 |     
491 |     // Add current year
492 |     const currentYear = new Date().getFullYear().toString();
493 |     pdf.setFontSize(14);
494 |     pdf.setFont('helvetica', 'normal');
495 |     pdf.setTextColor('#777777');
496 |     pdf.text(currentYear, pageWidth / 2, pageHeight / 2 + 30, { align: 'center' });
497 |   }
498 | 
499 |      /**
500 |     * Adds header with logo and title to current page
501 |     */
502 |    private static async addHeaderToPage(pdf: jsPDF, title: string): Promise<void> {
503 |      const pageWidth = pdf.internal.pageSize.getWidth();
504 |      
505 |      // Add logo
506 |      await this.addLogoToPage(pdf, 10, 10, 15);
507 |      
508 |      // Add title - clean text without background for illustrated version
509 |      if (title) {
510 |        pdf.setFont('helvetica', 'bold');
511 |        pdf.setFontSize(14); // Slightly larger to match increased content text
512 |        pdf.setTextColor('#000000'); // Black text for visibility over images
513 |        
514 |        let displayTitle = title;
515 |        if (displayTitle.length > 30) {
516 |          displayTitle = displayTitle.substring(0, 27) + '...';
517 |        }
518 |        
519 |        // Text with white border for visibility over image
520 |        this.drawTextWithWhiteBorder(pdf, displayTitle, pageWidth - 15, 15, { align: 'right' });
521 |      }
522 |    }
523 | 
524 |   /**
525 |    * Adds TaleMe logo to specified position
526 |    */
527 |   private static async addLogoToPage(pdf: jsPDF, x: number, y: number, width: number): Promise<void> {
528 |     try {
529 |       const logo = new Image();
530 |       logo.src = '/logo_png.png';
531 |       
532 |       await new Promise<void>((resolve) => {
533 |         logo.onload = () => {
534 |           try {
535 |             const canvas = document.createElement('canvas');
536 |             const height = (logo.height / logo.width) * width;
537 |             
538 |             canvas.width = logo.width;
539 |             canvas.height = logo.height;
540 |             const ctx = canvas.getContext('2d');
541 |             
542 |             if (ctx) {
543 |               ctx.drawImage(logo, 0, 0, logo.width, logo.height);
544 |               const logoData = canvas.toDataURL('image/png');
545 |               pdf.addImage(logoData, 'PNG', x, y, width, height);
546 |             }
547 |           } catch (error) {
548 |             console.error('[StoryPdfService] Error processing logo:', error);
549 |           }
550 |           resolve();
551 |         };
552 |         
553 |         logo.onerror = () => {
554 |           console.error('[StoryPdfService] Error loading logo');
555 |           resolve();
556 |         };
557 |       });
558 |     } catch (error) {
559 |       console.error('[StoryPdfService] Error adding logo:', error);
560 |     }
561 |   }
562 | 
563 |   /**
564 |    * Adds footer to current page
565 |    */
566 |   private static addFooter(pdf: jsPDF, currentPage: number, totalPages: number): void {
567 |     const pageWidth = pdf.internal.pageSize.getWidth();
568 |     const pageHeight = pdf.internal.pageSize.getHeight();
569 |     
570 |     pdf.setFontSize(8);
571 |     pdf.setTextColor('#777777');
572 |     
573 |     // Add page number
574 |     pdf.text(`${currentPage} / ${totalPages}`, pageWidth - 20, pageHeight - 10);
575 |     
576 |     // Add app name and version
577 |     pdf.text(`${APP_CONFIG.name} v${APP_CONFIG.version}`, 20, pageHeight - 10);
578 |   }
579 | 
580 |   /**
581 |    * Estimates the number of pages required for the given content
582 |    * @param content Story content
583 |    * @param pageWidth PDF page width
584 |    * @param pageHeight PDF page height
585 |    * @param margin Page margin
586 |    * @returns Estimated number of pages
587 |    */
588 |   private static estimateRequiredPages(content: string, pageWidth: number, pageHeight: number, margin: number): number {
589 |     // Split content into paragraphs like in the actual generation
590 |     const paragraphs = content.split('\n\n').filter(p => p.trim() !== '');
591 |     let finalParagraphs = paragraphs;
592 |     
593 |     if (paragraphs.length === 1) {
594 |       finalParagraphs = content.split('\n').filter(p => p.trim() !== '');
595 |     }
596 |     
597 |     // Estimate based on content length and typical paragraph distribution
598 |     const averageCharsPerLine = 70; // Approximate characters per line at 22pt font
599 |     const linesPerPage = 12; // Conservative estimate for illustrated pages (with header space and larger text)
600 |     const charsPerPage = averageCharsPerLine * linesPerPage;
601 |     
602 |     const totalChars = content.length;
603 |     const estimatedPages = Math.max(1, Math.ceil(totalChars / charsPerPage));
604 |     
605 |     // Also estimate based on paragraph count (minimum 2-3 paragraphs per page)
606 |     const paragraphBasedPages = Math.ceil(finalParagraphs.length / 2.5);
607 |     
608 |     // Use the higher estimate to be conservative
609 |     const finalEstimate = Math.max(estimatedPages, paragraphBasedPages);
610 |     
611 |     console.log(`[StoryPdfService] Content estimation - Chars: ${totalChars}, Paragraphs: ${finalParagraphs.length}, Estimated pages: ${finalEstimate}`);
612 |     
613 |     return finalEstimate;
614 |   }
615 | 
616 |   /**
617 |    * Draws text with white outline/stroke for better visibility over images
618 |    * @param pdf jsPDF instance
619 |    * @param text Text to draw
620 |    * @param x X position
621 |    * @param y Y position
622 |    * @param options Text options
623 |    */
624 |   private static drawTextWithWhiteBorder(
625 |     pdf: jsPDF, 
626 |     text: string | string[], 
627 |     x: number, 
628 |     y: number, 
629 |     options?: { align?: 'left' | 'center' | 'right' }
630 |   ): void {
631 |     const borderWidth = 0.5; // White border width
632 |     
633 |     // Draw white border by drawing text multiple times with slight offsets
634 |     const offsets = [
635 |       [-borderWidth, -borderWidth], [0, -borderWidth], [borderWidth, -borderWidth],
636 |       [-borderWidth, 0], [borderWidth, 0],
637 |       [-borderWidth, borderWidth], [0, borderWidth], [borderWidth, borderWidth]
638 |     ];
639 |     
640 |     // Draw white outline
641 |     pdf.setTextColor('#FFFFFF');
642 |     offsets.forEach(([offsetX, offsetY]) => {
643 |       pdf.text(text, x + offsetX, y + offsetY, options);
644 |     });
645 |     
646 |     // Draw black text on top
647 |     pdf.setTextColor('#000000');
648 |     pdf.text(text, x, y, options);
649 |   }
650 | 
651 |   /**
652 |    * Generates illustrated PDF with automatic image generation if needed
653 |    * @param options Complete illustrated PDF options with progress callback
654 |    * @returns Promise with generated PDF blob
655 |    */
656 |   static async generateCompleteIllustratedPdf(options: CompleteIllustratedPdfOptions): Promise<Blob> {
657 |     const { title, author, content, storyId, chapterId, onProgress } = options;
658 |     
659 |     try {
660 |       console.log('[StoryPdfService] Starting complete illustrated PDF generation for:', title);
661 |       
662 |       // Step 1: Validate existing images
663 |       onProgress?.({
664 |         currentStep: 'Validando imágenes existentes...',
665 |         completedImages: 0,
666 |         totalImages: 3,
667 |         progress: 5
668 |       });
669 |       
670 |       const imageValidation = await this.validateRequiredImages(storyId, chapterId);
671 |       
672 |       let imageUrls: { cover: string; scene_1: string; scene_2: string };
673 |       
674 |       if (!imageValidation.allValid) {
675 |         console.log('[StoryPdfService] Missing images detected, generating them...');
676 |         
677 |         // Step 2: Generate missing images with progress tracking
678 |         onProgress?.({
679 |           currentStep: 'Generando imágenes del cuento...',
680 |           completedImages: 0,
681 |           totalImages: 3,
682 |           progress: 10
683 |         });
684 |         
685 |         const generationResult = await this.generateImagesWithProgress(
686 |           { title, content, storyId, chapterId },
687 |           onProgress
688 |         );
689 |         
690 |         if (!generationResult.success || !generationResult.imageUrls) {
691 |           throw new Error(`Failed to generate required images: ${generationResult.error}`);
692 |         }
693 |         
694 |         imageUrls = generationResult.imageUrls;
695 |       } else {
696 |         console.log('[StoryPdfService] All images exist, proceeding with PDF generation...');
697 |         imageUrls = {
698 |           cover: imageValidation.imageUrls!.cover!,
699 |           scene_1: imageValidation.imageUrls!.scene_1!,
700 |           scene_2: imageValidation.imageUrls!.scene_2!
701 |         };
702 |       }
703 |       
704 |       // Step 3: Generate illustrated PDF
705 |       onProgress?.({
706 |         currentStep: 'Generando PDF ilustrado...',
707 |         completedImages: 3,
708 |         totalImages: 3,
709 |         progress: 85
710 |       });
711 |       
712 |       const pdfBlob = await this.generateIllustratedPdf({
713 |         title,
714 |         author,
715 |         content,
716 |         storyId,
717 |         chapterId,
718 |         imageUrls
719 |       });
720 |       
721 |       onProgress?.({
722 |         currentStep: 'PDF generado exitosamente',
723 |         completedImages: 3,
724 |         totalImages: 3,
725 |         progress: 100
726 |       });
727 |       
728 |       console.log('[StoryPdfService] Complete illustrated PDF generated successfully');
729 |       return pdfBlob;
730 |       
731 |     } catch (error) {
732 |       console.error('[StoryPdfService] Error generating complete illustrated PDF:', error);
733 |       throw new Error(`Failed to generate illustrated PDF: ${error instanceof Error ? error.message : 'Unknown error'}`);
734 |     }
735 |   }
736 | 
737 |   /**
738 |    * Generates all required images with progress tracking
739 |    * @param options Image generation options
740 |    * @param onProgress Progress callback function
741 |    * @returns Promise with generation result and image URLs
742 |    */
743 |   private static async generateImagesWithProgress(
744 |     options: { title: string; content: string; storyId: string; chapterId: string },
745 |     onProgress?: (progress: ImageGenerationProgress) => void
746 |   ): Promise<{ success: boolean; imageUrls?: { cover: string; scene_1: string; scene_2: string }; error?: string }> {
747 |     try {
748 |       const { title, content, storyId, chapterId } = options;
749 |       
750 |       console.log('[StoryPdfService] Generating images with progress tracking...');
751 |       
752 |       // Update progress for generation start
753 |       onProgress?.({
754 |         currentStep: 'Iniciando generación de imágenes...',
755 |         completedImages: 0,
756 |         totalImages: 3,
757 |         progress: 20
758 |       });
759 |       
760 |       // Incremental progress simulation based on 35 seconds max generation time
761 |       let currentProgress = 20;
762 |       const maxTime = 35000; // 35 seconds max
763 |       const targetProgress = 75; // Target progress when images are generated
764 |       const progressIncrement = (targetProgress - 20) / (maxTime / 1000); // Progress per second
765 |       
766 |       const progressInterval = setInterval(() => {
767 |         currentProgress = Math.min(targetProgress, currentProgress + progressIncrement);
768 |         onProgress?.({
769 |           currentStep: 'Generando imágenes con IA...',
770 |           completedImages: 0,
771 |           totalImages: 3,
772 |           progress: Math.round(currentProgress)
773 |         });
774 |       }, 1000); // Update every second
775 |       
776 |       try {
777 |         // Use the ImageGenerationService to generate all images
778 |         const result = await ImageGenerationService.generateStoryImages({
779 |           title,
780 |           content,
781 |           storyId,
782 |           chapterId
783 |         });
784 |         
785 |         clearInterval(progressInterval);
786 |         
787 |         if (!result.success || result.images.length === 0) {
788 |           return {
789 |             success: false,
790 |             error: result.error || 'No images were generated'
791 |           };
792 |         }
793 |         
794 |         // Map results to image URLs
795 |         const imageUrls: { cover?: string; scene_1?: string; scene_2?: string } = {};
796 |         
797 |         result.images.forEach(img => {
798 |           if (img.type === IMAGES_TYPE.COVER) {
799 |             imageUrls.cover = img.url;
800 |           } else if (img.type === IMAGES_TYPE.SCENE_1) {
801 |             imageUrls.scene_1 = img.url;
802 |           } else if (img.type === IMAGES_TYPE.SCENE_2) {
803 |             imageUrls.scene_2 = img.url;
804 |           }
805 |         });
806 |         
807 |         // Validate we have all required images
808 |         const hasAllImages = imageUrls.cover && imageUrls.scene_1 && imageUrls.scene_2;
809 |         
810 |         if (!hasAllImages) {
811 |           const missingImages: string[] = [];
812 |           if (!imageUrls.cover) missingImages.push('Portada');
813 |           if (!imageUrls.scene_1) missingImages.push('Escena 1');
814 |           if (!imageUrls.scene_2) missingImages.push('Escena 2');
815 |           
816 |           return {
817 |             success: false,
818 |             error: `Faltan imágenes: ${missingImages.join(', ')}`
819 |           };
820 |         }
821 |         
822 |         onProgress?.({
823 |           currentStep: 'Imágenes generadas exitosamente',
824 |           completedImages: 3,
825 |           totalImages: 3,
826 |           progress: 80
827 |         });
828 |         
829 |         return {
830 |           success: true,
831 |           imageUrls: {
832 |             cover: imageUrls.cover!,
833 |             scene_1: imageUrls.scene_1!,
834 |             scene_2: imageUrls.scene_2!
835 |           }
836 |         };
837 |         
838 |       } catch (error) {
839 |         clearInterval(progressInterval);
840 |         throw error;
841 |       }
842 |       
843 |     } catch (error) {
844 |       console.error('[StoryPdfService] Error generating images with progress:', error);
845 |       return {
846 |         success: false,
847 |         error: error instanceof Error ? error.message : 'Unknown error'
848 |       };
849 |     }
850 |   }
851 | } 
```

src/services/stripeService.ts
```
1 | import { loadStripe, Stripe } from '@stripe/stripe-js';
2 | 
3 | // Singleton pattern para cargar Stripe.js solo una vez
4 | let stripePromise: Promise<Stripe | null>;
5 | 
6 | /**
7 |  * Obtiene la instancia de Stripe.js inicializada con la clave publicable
8 |  * @returns Promise con la instancia de Stripe o null si hay error
9 |  */
10 | export const getStripe = (): Promise<Stripe | null> => {
11 |   if (!stripePromise) {
12 |     const publishableKey = import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY;
13 |     if (!publishableKey) {
14 |       console.error("VITE_STRIPE_PUBLISHABLE_KEY no está configurada en .env");
15 |       // Retorna una promesa rechazada o null, dependiendo de cómo quieras manejarlo
16 |       return Promise.resolve(null);
17 |     }
18 |     stripePromise = loadStripe(publishableKey);
19 |   }
20 |   return stripePromise;
21 | };
22 | 
23 | /**
24 |  * Crea una sesión de checkout llamando a la Edge Function de Supabase
25 |  * @param item Tipo de item a comprar ('premium' para suscripción o 'credits' para créditos de voz)
26 |  * @returns Objeto con la URL de checkout o un mensaje de error
27 |  */
28 | export interface CheckoutSessionResponse {
29 |   url?: string;
30 |   error?: string;
31 | }
32 | 
33 | export const createCheckoutSession = async (
34 |   item: 'premium' | 'credits'
35 | ): Promise<CheckoutSessionResponse> => {
36 |   console.log(`Solicitando sesión de checkout para: ${item}`);
37 | 
38 |   try {
39 |     // 1. Obtener la sesión actual de Supabase para el token
40 |     // Añadir extensión .ts
41 |     const { supabase } = await import('../supabaseClient.ts');
42 |     const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
43 | 
44 |     if (sessionError || !sessionData?.session) {
45 |       console.error('Error al obtener la sesión de Supabase o usuario no autenticado:', sessionError);
46 |       return { error: 'Usuario no autenticado o error de sesión.' };
47 |     }
48 | 
49 |     const token = sessionData.session.access_token;
50 |     const anonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
51 | 
52 |     if (!anonKey) {
53 |       console.error("VITE_SUPABASE_ANON_KEY no está configurada.");
54 |       return { error: "Error de configuración del cliente." };
55 |     }
56 | 
57 |     // 2. Llamar a la Edge Function usando fetch
58 |     const response = await fetch(
59 |       `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/create-checkout-session`,
60 |       {
61 |         method: 'POST',
62 |         headers: {
63 |           'Authorization': `Bearer ${token}`,
64 |           'Content-Type': 'application/json',
65 |           'apikey': anonKey,
66 |         },
67 |         body: JSON.stringify({ item }),
68 |       }
69 |     );
70 | 
71 |     const responseData = await response.json();
72 | 
73 |     if (!response.ok) {
74 |       console.error('Error en la respuesta de la Edge Function (create-checkout-session):', responseData);
75 |       // Usar el mensaje de error de la respuesta si existe, si no, un genérico
76 |       throw new Error(responseData.error || `Error ${response.status} del servidor`);
77 |     }
78 | 
79 |     console.log('URL de checkout recibida:', responseData.url);
80 |     return { url: responseData.url };
81 | 
82 |   } catch (error) { // error es 'unknown'
83 |     console.error('Error al llamar a la función create-checkout-session:', error);
84 |     // Manejo seguro del tipo 'unknown'
85 |     let errorMessage = 'Error desconocido al iniciar el pago.';
86 |     if (error instanceof Error) {
87 |         errorMessage = error.message;
88 |     } else if (typeof error === 'string') {
89 |         errorMessage = error;
90 |     }
91 |     return { error: `No se pudo iniciar el pago: ${errorMessage}` };
92 |   }
93 | };
94 | 
95 | /**
96 |  * Crea una sesión del portal de cliente de Stripe para gestionar suscripciones
97 |  * @returns Objeto con la URL del portal o un mensaje de error
98 |  */
99 | export interface CustomerPortalSessionResponse {
100 |   url?: string;
101 |   error?: string;
102 | }
103 | 
104 | export const createCustomerPortalSession = async (): Promise<CustomerPortalSessionResponse> => {
105 |   console.log('Solicitando sesión del portal de cliente de Stripe');
106 | 
107 |   try {
108 |     // 1. Obtener la sesión actual de Supabase para el token
109 |     // Añadir extensión .ts
110 |     const { supabase } = await import('../supabaseClient.ts');
111 |     const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
112 | 
113 |     if (sessionError || !sessionData?.session) {
114 |       console.error('Error al obtener la sesión de Supabase o usuario no autenticado:', sessionError);
115 |       return { error: 'Usuario no autenticado o error de sesión.' };
116 |     }
117 | 
118 |     const token = sessionData.session.access_token;
119 |     const anonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
120 | 
121 |     if (!anonKey) {
122 |       console.error("VITE_SUPABASE_ANON_KEY no está configurada.");
123 |       return { error: "Error de configuración del cliente." };
124 |     }
125 | 
126 |     // 2. Llamar a la Edge Function usando fetch
127 |     const response = await fetch(
128 |       `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/create-customer-portal-session`,
129 |       {
130 |         method: 'POST',
131 |         headers: {
132 |           'Authorization': `Bearer ${token}`,
133 |           'Content-Type': 'application/json',
134 |           'apikey': anonKey,
135 |         }
136 |         // No necesita body
137 |       }
138 |     );
139 | 
140 |     const responseData = await response.json();
141 | 
142 |     if (!response.ok) {
143 |       console.error('Error en la respuesta de la Edge Function (create-customer-portal-session):', responseData);
144 |       // Usar el mensaje de error de la respuesta si existe
145 |       throw new Error(responseData.error || `Error ${response.status} del servidor`);
146 |     }
147 | 
148 |     console.log('URL del portal de cliente recibida:', responseData.url);
149 |     return { url: responseData.url };
150 | 
151 |   } catch (error) { // error es 'unknown'
152 |     console.error('Error al llamar a la función create-customer-portal-session:', error);
153 |     // Manejo seguro del tipo 'unknown'
154 |     let errorMessage = 'Error desconocido al acceder al portal.';
155 |     if (error instanceof Error) {
156 |         errorMessage = error.message;
157 |     } else if (typeof error === 'string') {
158 |         errorMessage = error;
159 |     }
160 |     return { error: `No se pudo acceder al portal de cliente: ${errorMessage}` };
161 |   }
162 | };
```

src/services/supabase.ts
```
1 | // Importa los tipos necesarios
2 | import {
3 |     Challenge,
4 |     ChallengeQuestion,
5 |     ProfileSettings,
6 |     Story,
7 |     StoryChapter,
8 |     StoryCharacter,
9 | } from "../types";
10 | 
11 | // --- Importa la instancia ÚNICA del cliente Supabase ---
12 | import { supabase } from "../supabaseClient"; // Ajusta esta ruta si es necesario
13 | 
14 | // --- Listener de Auth (Opcional, solo para logging) ---
15 | // Ya no inicializamos el cliente aquí, solo usamos el importado.
16 | supabase.auth.onAuthStateChange((event, session) => {
17 |     if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
18 |         console.log('Evento Auth en supabase.ts:', event, '- Usuario:', session?.user?.id);
19 |     } else if (event === 'SIGNED_OUT') {
20 |         console.log('Evento Auth en supabase.ts: SIGNED_OUT');
21 |     }
22 | });
23 | 
24 | // --- Funciones de Perfil ---
25 | 
26 | export const syncUserProfile = async (
27 |     userId: string,
28 |     // Renombramos el parámetro para claridad y ajustamos tipo
29 |     dataToSync: Partial<ProfileSettings> & { [key: string]: any },
30 | ): Promise<{ success: boolean; error?: any }> => {
31 |     try {
32 |         console.log(`[syncUserProfile_DEBUG] Attempting to sync for user ${userId} with data:`, dataToSync);
33 | 
34 |         // Preparamos los datos para upsert, asegurando que 'id' y 'updated_at' están presentes
35 |         const upsertData = {
36 |             id: userId,             // ID es necesario para upsert
37 |             ...dataToSync,         // Usamos directamente los datos mapeados (ej. child_age, special_need)
38 |             updated_at: new Date(), // Siempre actualizamos la fecha
39 |         };
40 | 
41 |         // Opcional: Asegurarse de que special_need sea null si es undefined, aunque upsert debería manejarlo
42 |         // Corregido: Usar notación de corchetes para evitar error de linting con snake_case
43 |         if (upsertData['special_need'] === undefined) {
44 |             upsertData['special_need'] = null;
45 |         }
46 | 
47 |         const { error } = await supabase
48 |             .from("profiles")
49 |             .upsert(upsertData); // <<< Pasamos el objeto correcto a upsert
50 | 
51 |         if (error) {
52 |             console.error("Error sincronizando perfil (posible RLS):", error);
53 |             throw error; // Re-lanzar para el catch general
54 |         }
55 |         console.log(`[syncUserProfile_DEBUG] Profile synced successfully for user ${userId}`);
56 |         return { success: true };
57 |     } catch (error) {
58 |         console.error("Fallo general en syncUserProfile:", error);
59 |         // Asegurarse de devolver un objeto Error estándar
60 |         const errorMessage = error instanceof Error ? error.message : String(error);
61 |         return { success: false, error: new Error(errorMessage) }; 
62 |     }
63 | };
64 | 
65 | export const getUserProfile = async (userId: string): Promise<{ success: boolean, profile?: ProfileSettings, error?: any }> => {
66 |     try {
67 |         console.log(`Solicitando perfil para usuario: ${userId}`);
68 |         const { data, error } = await supabase
69 |             .from("profiles")
70 |             .select("*") // Selecciona todas las columnas
71 |             .eq("id", userId)
72 |             .single();
73 | 
74 |         if (error && error.code === 'PGRST116') {
75 |             console.log(`No se encontró perfil para usuario ${userId}`);
76 |             return { success: false };
77 |         } else if (error) {
78 |             console.error(`Error al obtener perfil para ${userId} (posible RLS):`, error);
79 |             throw error;
80 |         }
81 | 
82 |         console.log(`Datos de perfil recibidos para ${userId}:`, data);
83 | 
84 |         if (data) {
85 |             // Mapea todos los campos recuperados
86 |             const profile: ProfileSettings = {
87 |                 language: data.language,
88 |                 childAge: data.child_age,
89 |                 specialNeed: data.special_need,
90 |                 stripe_customer_id: data.stripe_customer_id,
91 |                 subscription_status: data.subscription_status,
92 |                 subscription_id: data.subscription_id,
93 |                 plan_id: data.plan_id,
94 |                 current_period_end: data.current_period_end,
95 |                 voice_credits: data.voice_credits,
96 |                 monthly_stories_generated: data.monthly_stories_generated,
97 |                 monthly_voice_generations_used: data.monthly_voice_generations_used,
98 |                 has_completed_setup: data.has_completed_setup,
99 |             };
100 |             return { success: true, profile: profile };
101 |         }
102 | 
103 |         console.log(`No se encontró perfil (inesperado) para usuario ${userId}`);
104 |         return { success: false };
105 | 
106 |     } catch (error) {
107 |         console.error(`Fallo general en getUserProfile para ${userId}:`, error);
108 |         return { success: false, error };
109 |     }
110 | };
111 | 
112 | // --- Funciones de Personajes ---
113 | 
114 | export const syncCharacter = async (
115 |     userId: string,
116 |     character: StoryCharacter,
117 | ): Promise<{ success: boolean; error?: any }> => {
118 |     try {
119 |         console.log(`[DEBUG] Sincronizando personaje "${character.name}" (ID: ${character.id}) para usuario ${userId}`);
120 |         const { data: existingChar, error: queryError } = await supabase
121 |             .from("characters")
122 |             .select("id, user_id")
123 |             .eq("id", character.id)
124 |             .maybeSingle();
125 | 
126 |         if (queryError) {
127 |             console.error(`[DEBUG] Error al verificar existencia del personaje:`, queryError);
128 |             throw queryError;
129 |         }
130 | 
131 |         const characterData = {
132 |             id: character.id,
133 |             user_id: userId,
134 |             name: character.name,
135 |             hobbies: character.hobbies,
136 |             description: character.description,
137 |             profession: character.profession,
138 |             character_type: character.characterType,
139 |             personality: character.personality,
140 |             updated_at: new Date(),
141 |         };
142 | 
143 |         let result;
144 |         if (existingChar) {
145 |             console.log(`[DEBUG] Personaje ${character.id} existe. Actualizando.`);
146 |             if (existingChar.user_id !== userId) {
147 |                 console.error(`[DEBUG] ¡Error de seguridad! Intento de modificar personaje ${character.id} de otro usuario.`);
148 |                 return { success: false, error: new Error('No tienes permiso para modificar este personaje') };
149 |             }
150 |             result = await supabase
151 |                 .from("characters")
152 |                 .update(characterData)
153 |                 .eq("id", character.id);
154 |         } else {
155 |             console.log(`[DEBUG] Creando nuevo personaje con ID: ${character.id}`);
156 |             result = await supabase
157 |                 .from("characters")
158 |                 .insert(characterData);
159 |         }
160 | 
161 |         const { error } = result;
162 |         if (error) {
163 |             console.error(`[DEBUG] Error en operación upsert de personaje (posible RLS):`, error);
164 |             throw error;
165 |         }
166 | 
167 |         console.log(`[DEBUG] Personaje "${character.name}" guardado exitosamente.`);
168 |         return { success: true };
169 |     } catch (error) {
170 |         console.error("[DEBUG] Fallo general en syncCharacter:", error);
171 |         return { success: false, error };
172 |     }
173 | };
174 | 
175 | export const getUserCharacters = async (userId: string): Promise<{ success: boolean; characters?: StoryCharacter[]; error?: any }> => {
176 |     // --- CORREGIDO: Eliminada la consulta ineficiente ---
177 |     try {
178 |         console.log(`[DEBUG] Consultando personajes para usuario ${userId}`);
179 |         const { data, error } = await supabase
180 |             .from("characters")
181 |             .select("*") // Consulta correcta y única
182 |             .eq("user_id", userId);
183 | 
184 |         if (error) {
185 |             console.error(`[DEBUG] Error en consulta de personajes (posible RLS):`, error);
186 |             throw error;
187 |         }
188 | 
189 |         console.log(`[DEBUG] Personajes encontrados: ${data?.length || 0}`);
190 |         const characters: StoryCharacter[] = data ? data.map((char) => ({
191 |             id: char.id,
192 |             name: char.name,
193 |             hobbies: char.hobbies || [],
194 |             description: char.description || '',
195 |             profession: char.profession || '',
196 |             characterType: char.character_type || '',
197 |             personality: char.personality || '',
198 |         })) : [];
199 | 
200 |         return { success: true, characters: characters };
201 |     } catch (error) {
202 |         console.error("Fallo general en getUserCharacters:", error);
203 |         return { success: false, error };
204 |     }
205 | };
206 | 
207 | export const deleteCharacter = async (characterId: string): Promise<{ success: boolean; error?: any }> => {
208 |     try {
209 |         const { data: { user } } = await supabase.auth.getUser();
210 |         if (!user) {
211 |             return { success: false, error: new Error('No autenticado') };
212 |         }
213 |         const userId = user.id;
214 | 
215 |         const { data: characterData, error: queryError } = await supabase
216 |             .from("characters")
217 |             .select("user_id")
218 |             .eq("id", characterId)
219 |             .maybeSingle();
220 | 
221 |         if (queryError) {
222 |             console.error("Error verificando propiedad:", queryError);
223 |             return { success: false, error: queryError };
224 |         }
225 |         if (!characterData) {
226 |             console.warn(`Personaje ${characterId} no encontrado para eliminar.`);
227 |             return { success: false, error: new Error('Personaje no encontrado') };
228 |         }
229 |         if (characterData.user_id !== userId) {
230 |             console.error(`Seguridad: Usuario ${userId} intentó eliminar personaje ${characterId} de ${characterData.user_id}`);
231 |             return { success: false, error: new Error('Permiso denegado') };
232 |         }
233 | 
234 |         const { error } = await supabase
235 |             .from("characters")
236 |             .delete()
237 |             .eq("id", characterId);
238 | 
239 |         if (error) {
240 |             console.error("Error eliminando personaje (RLS?):", error);
241 |             throw error;
242 |         }
243 |         return { success: true };
244 |     } catch (error) {
245 |         console.error("Fallo general en deleteCharacter:", error);
246 |         return { success: false, error };
247 |     }
248 | };
249 | 
250 | // --- Funciones de Historias ---
251 | 
252 | export const syncStory = async (userId: string, story: Story): Promise<{ success: boolean; error?: any }> => {
253 |     try {
254 |         console.log(`Sincronizando historia ${story.id} para usuario ${userId}`);
255 |         const storyData = {
256 |             id: story.id,
257 |             user_id: userId,
258 |             title: story.title,
259 |             content: story.content,
260 |             audio_url: story.audioUrl,
261 |             moral: story.options.moral,
262 |             genre: story.options.genre,
263 |             duration: story.options.duration,
264 |             character_id: story.options.character.id,
265 |             additional_details: story.additional_details,
266 |             updated_at: new Date(),
267 |         };
268 |         const { error } = await supabase.from("stories").upsert(storyData);
269 |         if (error) {
270 |             console.error(`Error al sincronizar historia ${story.id} (RLS?):`, error);
271 |             throw error;
272 |         }
273 |         console.log(`Historia ${story.id} sincronizada.`);
274 |         return { success: true };
275 |     } catch (error) {
276 |         console.error("Fallo general en syncStory:", error);
277 |         return { success: false, error };
278 |     }
279 | };
280 | 
281 | export const getUserStories = async (userId: string): Promise<{ success: boolean; stories?: Story[]; error?: any }> => {
282 |     try {
283 |         console.log(`Buscando historias para usuario ${userId}`);
284 |         const { data, error } = await supabase
285 |             .from("stories")
286 |             .select(`*, characters (*)`)
287 |             .eq("user_id", userId)
288 |             .order('created_at', { ascending: false }); // Ordenar por más reciente
289 | 
290 |         if (error) {
291 |             console.error("Error obteniendo historias (RLS?):", error);
292 |             throw error;
293 |         }
294 | 
295 |         const stories: Story[] = data ? data.map((story) => {
296 |             const characterData = story.characters;
297 |             console.log(`[getUserStories_DEBUG] DB raw title for story ${story.id}: "${story.title}"`); // <-- ADD THIS
298 | 
299 |             return {
300 |                 id: story.id,
301 |                 title: story.title || "Historia sin título",
302 |                 content: story.content,
303 |                 audioUrl: story.audio_url,
304 |                 options: {
305 |                     moral: story.moral,
306 |                     genre: story.genre,
307 |                     duration: story.duration,
308 |                     character: {
309 |                         id: characterData?.id || 'deleted_character',
310 |                         name: characterData?.name || 'Personaje Eliminado',
311 |                         hobbies: characterData?.hobbies || [],
312 |                         description: characterData?.description || '',
313 |                         profession: characterData?.profession || '',
314 |                         characterType: characterData?.character_type || '',
315 |                         personality: characterData?.personality || '',
316 |                     } as StoryCharacter,
317 |                 },
318 |                 createdAt: story.created_at,
319 |                 additional_details: story.additional_details, // <-- Incluir aquí
320 |             };
321 |         }) : [];
322 | 
323 |         console.log(`Encontradas ${stories.length} historias`);
324 |         return { success: true, stories: stories };
325 |     } catch (error) {
326 |         console.error("Fallo general en getUserStories:", error);
327 |         return { success: false, error };
328 |     }
329 | };
330 | 
331 | /**
332 |  * Obtiene el número de capítulos existentes para una historia específica.
333 |  */
334 | export const getChapterCountForStory = async (storyId: string): Promise<{ count: number; error: Error | null }> => {
335 |     try {
336 |         const { count, error } = await supabase
337 |             .from('story_chapters')
338 |             .select('*', { count: 'exact', head: true }) // Solo necesitamos el conteo
339 |             .eq('story_id', storyId);
340 | 
341 |         if (error) {
342 |             console.error('Error al contar capítulos:', error);
343 |             return { count: 0, error };
344 |         }
345 | 
346 |         return { count: count ?? 0, error: null }; // Devuelve 0 si count es null
347 | 
348 |     } catch (error: any) {
349 |         console.error('Error inesperado al contar capítulos:', error);
350 |         return { count: 0, error };
351 |     }
352 | };
353 | 
354 | // --- Funciones para Capítulos ---
355 | 
356 | export const syncChapter = async (chapter: StoryChapter, storyId: string): Promise<{ success: boolean; error?: any }> => {
357 |     console.log("🚀 ~ syncChapter ~ chapter:", chapter)
358 |     try {
359 |         const { error } = await supabase
360 |             .from("story_chapters")
361 |             .upsert({
362 |                 id: chapter.id,
363 |                 story_id: storyId,
364 |                 chapter_number: chapter.chapterNumber,
365 |                 title: chapter.title,
366 |                 content: chapter.content,
367 |                 generation_method: chapter.generationMethod,
368 |                 custom_input: chapter.customInput,
369 |                 updated_at: new Date(),
370 |             });
371 |         if (error) {
372 |             console.error("Error sincronizando capítulo (RLS/FK?):", error);
373 |             throw error;
374 |         }
375 |         return { success: true };
376 |     } catch (error) {
377 |         console.error("Fallo general en syncChapter:", error);
378 |         return { success: false, error };
379 |     }
380 | };
381 | 
382 | export const getStoryChapters = async (storyId: string): Promise<{ success: boolean; chapters?: StoryChapter[]; error?: any }> => {
383 |     try {
384 |         const { data, error } = await supabase
385 |             .from("story_chapters")
386 |             .select("*")
387 |             .eq("story_id", storyId)
388 |             .order('chapter_number', { ascending: true });
389 | 
390 |         if (error) {
391 |             console.error("Error obteniendo capítulos (RLS/FK?):", error);
392 |             throw error;
393 |         }
394 |         const chapters: StoryChapter[] = data ? data.map((chapter) => ({
395 |             id: chapter.id,
396 |             chapterNumber: chapter.chapter_number,
397 |             title: chapter.title,
398 |             content: chapter.content,
399 |             createdAt: chapter.created_at,
400 |             generationMethod: chapter.generation_method,
401 |             customInput: chapter.custom_input,
402 |         })) : [];
403 |         return { success: true, chapters: chapters };
404 |     } catch (error) {
405 |         console.error("Fallo general en getStoryChapters:", error);
406 |         return { success: false, error };
407 |     }
408 | };
409 | 
410 | // --- Funciones para Desafíos ---
411 | 
412 | export const syncChallenge = async (challenge: Challenge): Promise<{ success: boolean; error?: any }> => {
413 |     try {
414 |         const { data, error: challengeError } = await supabase
415 |             .from("challenges")
416 |             .upsert({
417 |                 id: challenge.id,
418 |                 story_id: challenge.storyId,
419 |                 created_at: challenge.createdAt,
420 |             })
421 |             .select("id")
422 |             .single();
423 | 
424 |         if (challengeError) {
425 |             console.error("Error en upsert de desafío (RLS/FK?):", challengeError);
426 |             throw challengeError;
427 |         }
428 |         if (!data?.id) throw new Error("No se pudo obtener ID del desafío.");
429 |         const challengeId = data.id;
430 | 
431 |         // Batch upsert preguntas (más eficiente si hay muchas)
432 |         const questionUpserts = challenge.questions.map(question => ({
433 |             id: question.id,
434 |             challenge_id: challengeId,
435 |             question: question.question,
436 |             options: question.options,
437 |             correct_option_index: question.correctOptionIndex,
438 |             explanation: question.explanation,
439 |             category: question.category,
440 |             target_language: question.targetLanguage,
441 |         }));
442 | 
443 |         if (questionUpserts.length > 0) {
444 |             const { error: questionsError } = await supabase
445 |                 .from("challenge_questions")
446 |                 .upsert(questionUpserts);
447 |             if (questionsError) {
448 |                 console.error(`Error en upsert masivo de preguntas (RLS/FK?):`, questionsError);
449 |                 throw questionsError;
450 |             }
451 |         }
452 | 
453 |         return { success: true };
454 |     } catch (error) {
455 |         console.error("Fallo general en syncChallenge:", error);
456 |         return { success: false, error };
457 |     }
458 | };
459 | 
460 | 
461 | export const getStoryChallenges = async (storyId: string): Promise<{ success: boolean; challenges?: Challenge[]; error?: any }> => {
462 |     try {
463 |         const { data: challengesData, error: challengesError } = await supabase
464 |             .from("challenges")
465 |             .select("*, challenge_questions(*)") // Join con preguntas
466 |             .eq("story_id", storyId);
467 | 
468 |         if (challengesError) {
469 |             console.error("Error obteniendo desafíos (RLS?):", challengesError);
470 |             throw challengesError;
471 |         }
472 | 
473 |         const challenges: Challenge[] = challengesData ? challengesData.map(challengeRecord => ({
474 |             id: challengeRecord.id,
475 |             storyId: challengeRecord.story_id,
476 |             createdAt: challengeRecord.created_at,
477 |             questions: (challengeRecord.challenge_questions || []).map((q: any) => ({ // Tipar 'q' si es posible
478 |                 id: q.id,
479 |                 question: q.question,
480 |                 options: q.options,
481 |                 correctOptionIndex: q.correct_option_index,
482 |                 explanation: q.explanation,
483 |                 category: q.category,
484 |                 targetLanguage: q.target_language,
485 |             })),
486 |         })) : [];
487 | 
488 |         return { success: true, challenges };
489 |     } catch (error) {
490 |         console.error("Fallo general en getStoryChallenges:", error);
491 |         return { success: false, error };
492 |     }
493 | };
494 | 
495 | // --- Funciones para Archivos de Audio ---
496 | 
497 | export const syncAudioFile = async (
498 |     userId: string,
499 |     storyId: string,
500 |     chapterId: string | number,
501 |     voiceId: string,
502 |     audioUrl: string,
503 | ): Promise<{ success: boolean; error?: any }> => {
504 |     try {
505 |         const { error } = await supabase
506 |             .from("audio_files")
507 |             .upsert({
508 |                 user_id: userId,
509 |                 story_id: storyId,
510 |                 chapter_id: chapterId,
511 |                 voice_id: voiceId,
512 |                 url: audioUrl,
513 |             });
514 |         if (error) {
515 |             console.error("Error sincronizando archivo de audio (RLS/FK?):", error);
516 |             throw error;
517 |         }
518 |         return { success: true };
519 |     } catch (error) {
520 |         console.error("Fallo general en syncAudioFile:", error);
521 |         return { success: false, error };
522 |     }
523 | };
524 | 
525 | export const getUserAudios = async (userId: string): Promise<{ success: boolean; audios?: any[]; error?: any }> => { // Ajustar tipo 'audios' si tienes uno específico
526 |     try {
527 |         const { data, error } = await supabase
528 |             .from("audio_files")
529 |             .select("*")
530 |             .eq("user_id", userId);
531 | 
532 |         if (error) {
533 |             console.error("Error obteniendo archivos de audio (RLS?):", error);
534 |             throw error;
535 |         }
536 |         const audios = data || [];
537 |         return { success: true, audios: audios };
538 |     } catch (error) {
539 |         console.error("Fallo general en getUserAudios:", error);
540 |         return { success: false, error };
541 |     }
542 | };
543 | 
544 | // --- Funciones para Preferencias de Voz ---
545 | 
546 | export const setCurrentVoice = async (userId: string, voiceId: string): Promise<{ success: boolean; error?: any }> => {
547 |     try {
548 |         // Paso 1: Resetear la voz actual
549 |         await supabase
550 |             .from("user_voices")
551 |             .update({ is_current: false })
552 |             .eq("user_id", userId)
553 |             .eq("is_current", true);
554 | 
555 |         // Paso 2: Establecer la nueva voz actual
556 |         const { error } = await supabase
557 |             .from("user_voices")
558 |             .upsert({
559 |                 user_id: userId,
560 |                 voice_id: voiceId,
561 |                 is_current: true,
562 |                 updated_at: new Date(),
563 |             });
564 |         if (error) {
565 |             console.error("Error en upsert de voz actual (RLS?):", error);
566 |             throw error;
567 |         }
568 |         return { success: true };
569 |     } catch (error) {
570 |         console.error("Fallo general en setCurrentVoice:", error);
571 |         return { success: false, error };
572 |     }
573 | };
574 | 
575 | export const getCurrentVoice = async (userId: string): Promise<{ success: boolean; voiceId?: string | null; error?: any }> => {
576 |     try {
577 |         const { data, error } = await supabase
578 |             .from("user_voices")
579 |             .select("voice_id")
580 |             .eq("user_id", userId)
581 |             .eq("is_current", true)
582 |             .maybeSingle();
583 | 
584 |         if (error) {
585 |             console.error("Error obteniendo voz actual (RLS?):", error);
586 |             throw error;
587 |         }
588 |         return { success: true, voiceId: data?.voice_id || null };
589 |     } catch (error) {
590 |         console.error("Fallo general en getCurrentVoice:", error);
591 |         return { success: false, error };
592 |     }
593 | };
594 | 
595 | 
596 | // --- Servicio de Cola de Sincronización ---
597 | // (Se mantiene la versión mejorada con re-encolado)
598 | interface SyncQueueItem {
599 |     table: string;
600 |     operation: "insert" | "update" | "delete";
601 |     data: any;
602 |     timestamp: number;
603 | }
604 | 
605 | class SyncQueueService {
606 |     private static instance: SyncQueueService;
607 |     private queue: SyncQueueItem[] = [];
608 |     private isProcessing = false;
609 |     private readonly STORAGE_KEY = "sync_queue";
610 | 
611 |     private constructor() {
612 |         this.loadQueue();
613 |         if (typeof window !== "undefined" && !window.hasOwnProperty('_syncQueueListenerAdded')) {
614 |             window.addEventListener("online", () => this.processQueue());
615 |             (window as any)._syncQueueListenerAdded = true;
616 |         }
617 |     }
618 | 
619 |     static getInstance(): SyncQueueService {
620 |         if (!SyncQueueService.instance) {
621 |             SyncQueueService.instance = new SyncQueueService();
622 |         }
623 |         return SyncQueueService.instance;
624 |     }
625 | 
626 |     private loadQueue() {
627 |         if (typeof localStorage === 'undefined') return;
628 |         try {
629 |             const savedQueue = localStorage.getItem(this.STORAGE_KEY);
630 |             if (savedQueue) {
631 |                 this.queue = JSON.parse(savedQueue);
632 |                 console.log(`Cola de sincronización cargada con ${this.queue.length} elementos.`);
633 |             }
634 |         } catch (error) {
635 |             console.error("Error cargando cola de sincronización:", error);
636 |             this.queue = [];
637 |         }
638 |     }
639 | 
640 |     private saveQueue() {
641 |         if (typeof localStorage === 'undefined') return;
642 |         try {
643 |             localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.queue));
644 |         } catch (error) {
645 |             console.error("Error guardando cola de sincronización:", error);
646 |         }
647 |     }
648 | 
649 |     addToQueue(table: string, operation: "insert" | "update" | "delete", data: any,) {
650 |         console.log(`Añadiendo a cola: ${operation} en ${table}`, data);
651 |         this.queue.push({ table, operation, data, timestamp: Date.now() });
652 |         this.saveQueue();
653 |         if (typeof navigator !== 'undefined' && navigator.onLine) {
654 |             this.processQueue();
655 |         }
656 |     }
657 | 
658 |     async processQueue() {
659 |         if (this.isProcessing || this.queue.length === 0 || (typeof navigator !== 'undefined' && !navigator.onLine)) {
660 |             if (this.isProcessing) console.log("Cola ya en proceso.");
661 |             return;
662 |         }
663 |         console.log(`Procesando cola: ${this.queue.length} elementos.`);
664 |         this.isProcessing = true;
665 |         const itemsToProcess = [...this.queue];
666 |         this.queue = [];
667 |         this.saveQueue();
668 |         const failedItems: SyncQueueItem[] = [];
669 | 
670 |         try {
671 |             for (const item of itemsToProcess) {
672 |                 let success = false;
673 |                 console.log(`Procesando: ${item.operation} en ${item.table}`); // No loguear item.data por defecto (puede ser grande)
674 |                 try {
675 |                     let operationError = null;
676 |                     switch (item.operation) {
677 |                         case "insert":
678 |                         case "update":
679 |                             const { error } = await supabase.from(item.table).upsert(item.data);
680 |                             operationError = error;
681 |                             break;
682 |                         case "delete":
683 |                             if (!item.data?.id) {
684 |                                 console.error("Datos para DELETE sin ID:", item);
685 |                                 operationError = new Error("Datos para DELETE sin ID");
686 |                                 break;
687 |                             }
688 |                             const { error: deleteError } = await supabase.from(item.table).delete().eq("id", item.data.id);
689 |                             operationError = deleteError;
690 |                             break;
691 |                     }
692 |                     if (operationError) {
693 |                         console.error(`Error procesando item [${item.operation} ${item.table}]:`, operationError);
694 |                     } else {
695 |                         console.log(`Item procesado: ${item.operation} ${item.table}`);
696 |                         success = true;
697 |                     }
698 |                 } catch (processingError) {
699 |                     console.error(`Error inesperado procesando item:`, processingError);
700 |                 }
701 |                 if (!success) failedItems.push(item);
702 |             }
703 |         } finally {
704 |             if (failedItems.length > 0) {
705 |                 console.warn(`Re-encolando ${failedItems.length} elementos fallidos.`);
706 |                 this.queue = [...failedItems, ...this.queue];
707 |                 this.saveQueue();
708 |             }
709 |             console.log(`Procesamiento de cola finalizado. Pendientes: ${this.queue.length}`);
710 |             this.isProcessing = false;
711 |         }
712 |     }
713 |     getQueueLength(): number { return this.queue.length; }
714 | }
715 | 
716 | export const syncQueue = SyncQueueService.getInstance();
```

src/services/syncService.ts
```
1 | import { useUserStore } from "../store/user/userStore";
2 | // REMOVED: No necesitas importar characterStore, storiesStore, audioStore aquí
3 | // import { useCharacterStore } from "../store/character/characterStore";
4 | // import { useStoriesStore } from "../store/stories/storiesStore";
5 | // import { useAudioStore } from "../store/stories/audio/audioStore";
6 | // import { getCurrentUser } from "../supabaseAuth"; // Ya no se usa aquí directamente
7 | import { supabase } from "../supabaseClient"; // Importa el cliente supabase si no lo tienes ya
8 | 
9 | /**
10 |  * Servicio para INICIAR la sincronización de datos del usuario con Supabase
11 |  * delegando la carga real al userStore.
12 |  */
13 | export const syncUserData = async (): Promise<boolean> => {
14 |     console.log("Intentando iniciar sincronización de datos...");
15 |     try {
16 |         // 1. Verificar conexión (ligero y útil)
17 |         if (typeof navigator !== 'undefined' && !navigator.onLine) {
18 |             console.log("Offline. Sincronización pospuesta.");
19 |             return false;
20 |         }
21 | 
22 |         // 2. Verificar si hay una sesión activa usando el cliente Supabase
23 |         // Esto es más directo que llamar a getCurrentUser de supabaseAuth
24 |         const { data: { session }, error: sessionError } = await supabase.auth.getSession();
25 | 
26 |         if (sessionError) {
27 |             console.error("Error al obtener la sesión:", sessionError.message);
28 |             // Considerar si llamar a checkAuth aquí para limpiar el estado local si falla
29 |             // await useUserStore.getState().checkAuth();
30 |             return false;
31 |         }
32 | 
33 |         if (!session || !session.user) {
34 |             console.log("No hay sesión de usuario activa, no se inicia sincronización.");
35 |             // Si no hay sesión, checkAuth se encargará de poner el estado de usuario a null
36 |             // No necesitamos hacer nada más aquí, la UI reaccionará al estado nulo del userStore
37 |             // Opcionalmente, puedes llamar a checkAuth para asegurar limpieza:
38 |             // await useUserStore.getState().checkAuth();
39 |             return false;
40 |         }
41 | 
42 |         const userId = session.user.id;
43 |         console.log(`Sesión activa detectada para usuario ${userId}. Iniciando proceso checkAuth/sync.`);
44 | 
45 |         // 3. Disparar el proceso de carga centralizado en userStore
46 |         // checkAuth() AHORA es responsable de:
47 |         //    a) Confirmar la sesión (ya lo hicimos, pero checkAuth lo reconfirma)
48 |         //    b) Llamar a getUserProfile para obtener datos de perfil (incluyendo Stripe/límites)
49 |         //    c) Actualizar userStore.user y userStore.profileSettings
50 |         //    d) Llamar a syncAllUserData(userId) DENTRO de userStore
51 |         //    e) syncAllUserData llamará a los load...FromSupabase de los otros stores.
52 |         const checkAuthSuccessful = await useUserStore.getState().checkAuth();
53 | 
54 |         if (checkAuthSuccessful) {
55 |             console.log("Proceso checkAuth completado exitosamente. La carga de datos debería estar en curso o finalizada por userStore.");
56 |             return true;
57 |         } else {
58 |             // checkAuth devuelve false si no hay usuario o si hubo un error interno en checkAuth.
59 |             console.warn("checkAuth() devolvió false. La sincronización podría no haberse completado.");
60 |             return false;
61 |         }
62 | 
63 |     } catch (error) {
64 |         // Captura errores generales que podrían ocurrir en este flujo
65 |         console.error("Error inesperado en syncUserData:", error);
66 |         return false;
67 |     }
68 | };
69 | 
70 | /**
71 |  * Escuchar cambios en la conectividad para sincronizar
72 |  * cuando el usuario vuelve a estar online.
73 |  */
74 | export const initSyncListeners = () => {
75 |     // Solo ejecutar en el cliente
76 |     if (typeof window !== "undefined" && !window.hasOwnProperty('_syncListenersInitialized')) {
77 |         console.log("Inicializando listeners de conectividad...");
78 |         // Sincronizar cuando vuelve la conexión
79 |         window.addEventListener("online", () => {
80 |             console.log("Evento 'online' detectado, intentando sincronizar datos...");
81 |             syncUserData(); // Llama a la función refactorizada
82 |         });
83 |         // Sincronizar cuando cambia el estado de visibilidad (útil si la pestaña estuvo inactiva)
84 |         document.addEventListener('visibilitychange', () => {
85 |             if (document.visibilityState === 'visible') {
86 |                 console.log("Pestaña visible, intentando sincronizar datos...");
87 |                 syncUserData();
88 |             }
89 |         });
90 |         // Añadir un flag para evitar duplicar listeners si esta función se llama más de una vez
91 |         (window as any)._syncListenersInitialized = true;
92 |     } else if (typeof window !== "undefined") {
93 |         console.log("Listeners de conectividad ya inicializados.");
94 |     }
95 | };
96 | 
97 | /**
98 |  * Inicializar el servicio de sincronización.
99 |  * Esta función debe llamarse UNA SOLA VEZ al inicio de la aplicación.
100 |  */
101 | export const initSyncService = () => {
102 |     // Iniciar listeners de conexión y visibilidad
103 |     initSyncListeners();
104 | 
105 |     console.log("Servicio de sincronización inicializado.");
106 | 
107 |     // Intentar sincronización inicial inmediatamente si hay conexión
108 |     // syncUserData ya verifica la conexión internamente.
109 |     console.log("Intentando sincronización inicial...");
110 |     syncUserData();
111 | 
112 | };
```

src/store/index.ts
```
1 | // Exportación de los stores individuales
2 | export * from './user/userStore';
3 | export * from './character/characterStore';
4 | export * from './storyOptions/storyOptionsStore';
5 | export * from './stories/storiesStore';
6 | export * from './stories/chapters/chaptersStore';
7 | export * from './stories/challenges/challengesStore';
8 | export * from './stories/audio/audioStore';
9 | 
10 | // Exportación del generador de historias
11 | export * from './stories/storyGenerator'; 
```

src/types/index.ts
```
1 | export type ProfileSettings = {
2 |   // --- DATOS PRINCIPALES ---
3 |   // Muestra estos campos en gris oscuro (#222) sobre fondo claro para máxima legibilidad
4 |   language: string; // Idioma preferido del usuario
5 |   childAge: number; // Edad del niño/a
6 |   specialNeed?: string | null; // Necesidad especial (si aplica)
7 | 
8 |   // --- CAMPOS DE STRIPE ---
9 |   // Datos sensibles, mostrar en gris oscuro o azul claro solo si es info secundaria
10 |   stripe_customer_id?: string | null;
11 |   subscription_status?: string | null; // Estado de la suscripción (destacar si es "activa" o "cancelada")
12 |   subscription_id?: string | null;
13 |   plan_id?: string | null;
14 |   current_period_end?: string | null; // Fecha de renovación, mostrar en gris oscuro o azul claro
15 | 
16 |   // --- LÍMITES Y CRÉDITOS ---
17 |   // Mostrar estos campos en tarjetas con fondo blanco translúcido y texto destacado:
18 |   // - Números/acento: color de la paleta (ej. rosa #F6A5B7 para "8 / 10")
19 |   // - Texto principal: gris oscuro (#222)
20 |   // - Descripciones: azul claro (#7DC4E0)
21 |   voice_credits?: number | null; // Créditos de voz restantes
22 |   monthly_stories_generated?: number | null; // Historias generadas este mes
23 |   period_start_date?: string | null;
24 |   monthly_voice_generations_used?: number | null; // Usos de voz este mes
25 | 
26 |   // --- OTROS ---
27 |   has_completed_setup: boolean; // Mostrar como check visual, icono en color de la paleta
28 | };
29 | 
30 | export type StoryDuration = 'short' | 'medium' | 'long';
31 | 
32 | export type StoryCharacter = {
33 |   id: string;
34 |   name: string;
35 |   hobbies: string[];
36 |   description: string;
37 |   profession: string;
38 |   characterType: string;
39 |   personality?: string;
40 | }
41 | 
42 | export type PartialStoryCharacter = {
43 |   id: string;
44 |   name?: string;
45 |   hobbies?: string[];
46 |   description?: string;
47 |   profession?: string;
48 |   characterType?: string;
49 |   personality?: string;
50 | }
51 | 
52 | export type StoryOptions = {
53 |   moral: string;
54 |   character: StoryCharacter;
55 |   genre: string;
56 |   duration: StoryDuration;
57 |   language?: string;
58 |   userProvidedContext?: string;
59 | }
60 | 
61 | export type Story = {
62 |   id: string;
63 |   title: string;
64 |   content: string;
65 |   audioUrl?: string;
66 |   options: StoryOptions;
67 |   createdAt: string;
68 |   additional_details?: string | null;
69 | }
70 | 
71 | export type User = {
72 |   email: string;
73 |   id: string;
74 | }
75 | 
76 | export type HobbyOption = {
77 |   id: string;
78 |   name: string;
79 |   icon: React.ReactNode;
80 | }
81 | 
82 | export type ChallengeCategory = 'language' | 'math' | 'comprehension';
83 | 
84 | export type ChallengeQuestion = {
85 |   id: string;
86 |   question: string;
87 |   options: string[];
88 |   correctOptionIndex: number;
89 |   explanation: string;
90 |   category: ChallengeCategory;
91 |   targetLanguage?: string; // Only for language challenges
92 | };
93 | 
94 | export type Challenge = {
95 |   id: string;
96 |   storyId: string;
97 |   questions: ChallengeQuestion[];
98 |   createdAt: string;
99 | };
100 | 
101 | export type StoryChapter = {
102 |   id: string;
103 |   chapterNumber: number;
104 |   title: string;
105 |   content: string;
106 |   createdAt: string;
107 |   generationMethod?: 'free' | 'option1' | 'option2' | 'option3' | 'custom';
108 |   customInput?: string; // Only if generationMethod is 'custom'
109 | };
110 | 
111 | export type StoryWithChapters = {
112 |   id: string;
113 |   title: string;
114 |   content: string;
115 |   audioUrl?: string;
116 |   options: StoryOptions;
117 |   createdAt: string;
118 |   additional_details?: string | null;
119 |   chapters: StoryChapter[];
120 |   hasMultipleChapters?: boolean;
121 |   chaptersCount?: number;
122 | };
123 | 
124 | export type PresetSuggestion = {
125 |   id: number; // Supabase bigint maps to number in JS/TS if not excessively large
126 |   text_prompt: string;
127 | };
```

src/types/jsx.d.ts
```
1 | import React from 'react';
2 | 
3 | declare global {
4 |   namespace JSX {
5 |     interface IntrinsicElements {
6 |       div: React.DetailedHTMLProps<React.HTMLAttributes<HTMLDivElement>, HTMLDivElement>;
7 |       span: React.DetailedHTMLProps<React.HTMLAttributes<HTMLSpanElement>, HTMLSpanElement>;
8 |       button: React.DetailedHTMLProps<React.ButtonHTMLAttributes<HTMLButtonElement>, HTMLButtonElement>;
9 |       input: React.DetailedHTMLProps<React.InputHTMLAttributes<HTMLInputElement>, HTMLInputElement>;
10 |       select: React.DetailedHTMLProps<React.SelectHTMLAttributes<HTMLSelectElement>, HTMLSelectElement>;
11 |       option: React.DetailedHTMLProps<React.OptionHTMLAttributes<HTMLOptionElement>, HTMLOptionElement>;
12 |       label: React.DetailedHTMLProps<React.LabelHTMLAttributes<HTMLLabelElement>, HTMLLabelElement>;
13 |       audio: React.DetailedHTMLProps<React.AudioHTMLAttributes<HTMLAudioElement>, HTMLAudioElement>;
14 |       img: React.DetailedHTMLProps<React.ImgHTMLAttributes<HTMLImageElement>, HTMLImageElement>;
15 |       p: React.DetailedHTMLProps<React.HTMLAttributes<HTMLParagraphElement>, HTMLParagraphElement>;
16 |       h1: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
17 |       h2: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
18 |       h3: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
19 |       h4: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
20 |       h5: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
21 |       h6: React.DetailedHTMLProps<React.HTMLAttributes<HTMLHeadingElement>, HTMLHeadingElement>;
22 |     }
23 |   }
24 | } 
```

supabase/.branches/_current_branch
```
1 | main
```

supabase/functions/deno.jsonc
```
1 | // supabase/edge-functions/deno.jsonc
2 | {
3 |     "compilerOptions": {
4 |         "allowJs": true,
5 |         "lib": [
6 |             "deno.window",
7 |             "deno.unstable"
8 |         ], // Añade las libs que necesiten tus funciones
9 |         "strict": true
10 |         // No necesitas "jsx" aquí si no usas JSX en las funciones
11 |     },
12 |     "imports": {
13 |         // Define aquí alias específicos si los necesitas DENTRO de las funciones
14 |         // Ejemplo: "shared/": "./_shared/"
15 |         "stripe": "https://esm.sh/stripe@14.13.0?target=deno",
16 |         "supabase": "https://esm.sh/@supabase/supabase-js@2.39.8",
17 |         "jose": "https://deno.land/x/jose@v5.6.3/index.ts"
18 |         // ...otros imports comunes para tus funciones...
19 |     }
20 |     // Puedes añadir config de lint/fmt si quieres usarlos específicamente aquí
21 | }
```

supabase/functions/deno.lock
```
1 | {
2 |   "version": "5",
3 |   "specifiers": {
4 |     "npm:@google/generative-ai@*": "0.24.1",
5 |     "npm:@types/node@*": "22.12.0",
6 |     "npm:uuid@9.0.0": "9.0.0"
7 |   },
8 |   "npm": {
9 |     "@google/generative-ai@0.24.1": {
10 |       "integrity": "sha512-MqO+MLfM6kjxcKoy0p1wRzG3b4ZZXtPI+z2IE26UogS2Cm/XHO+7gGRBh6gcJsOiIVoH93UwKvW4HdgiOZCy9Q=="
11 |     },
12 |     "@types/node@22.12.0": {
13 |       "integrity": "sha512-Fll2FZ1riMjNmlmJOdAyY5pUbkftXslB5DgEzlIuNaiWhXd00FhWxVC/r4yV/4wBb9JfImTu+jiSvXTkJ7F/gA==",
14 |       "dependencies": [
15 |         "undici-types"
16 |       ]
17 |     },
18 |     "undici-types@6.20.0": {
19 |       "integrity": "sha512-Ny6QZ2Nju20vw1SRHe3d9jVu6gJ+4e3+MMpqu7pqE5HT6WsTSlce++GQmK5UXS8mzV8DSYHrQH+Xrf2jVcuKNg=="
20 |     },
21 |     "uuid@9.0.0": {
22 |       "integrity": "sha512-MXcSTerfPa4uqyzStbRoTgt5XIe3x5+42+q1sDuy3R5MDk66URdLMOZe5aPX/SQd+kuYAh0FdP/pO28IkQyTeg==",
23 |       "bin": true
24 |     }
25 |   },
26 |   "redirects": {
27 |     "https://esm.sh/@supabase/node-fetch@^2.6.14?target=denonext": "https://esm.sh/@supabase/node-fetch@2.6.15?target=denonext",
28 |     "https://esm.sh/@types/ws@~8.18.1/index.d.mts": "https://esm.sh/@types/ws@8.18.1/index.d.mts",
29 |     "https://esm.sh/bufferutil@^4.0.1?target=denonext": "https://esm.sh/bufferutil@4.0.9?target=denonext",
30 |     "https://esm.sh/node-gyp-build@^4.3.0?target=denonext": "https://esm.sh/node-gyp-build@4.8.4?target=denonext",
31 |     "https://esm.sh/tr46@~0.0.3?target=denonext": "https://esm.sh/tr46@0.0.3?target=denonext",
32 |     "https://esm.sh/utf-8-validate@%3E=5.0.2?target=denonext": "https://esm.sh/utf-8-validate@6.0.5?target=denonext",
33 |     "https://esm.sh/webidl-conversions@^3.0.0?target=denonext": "https://esm.sh/webidl-conversions@3.0.1?target=denonext",
34 |     "https://esm.sh/whatwg-url@^5.0.0?target=denonext": "https://esm.sh/whatwg-url@5.0.0?target=denonext",
35 |     "https://esm.sh/ws@^8.14.2?target=denonext": "https://esm.sh/ws@8.18.2?target=denonext"
36 |   },
37 |   "remote": {
38 |     "https://deno.land/std@0.177.0/async/abortable.ts": "73acfb3ed7261ce0d930dbe89e43db8d34e017b063cf0eaa7d215477bf53442e",
39 |     "https://deno.land/std@0.177.0/async/deadline.ts": "c5facb0b404eede83e38bd2717ea8ab34faa2ffb20ef87fd261fcba32ba307aa",
40 |     "https://deno.land/std@0.177.0/async/debounce.ts": "adab11d04ca38d699444ac8a9d9856b4155e8dda2afd07ce78276c01ea5a4332",
41 |     "https://deno.land/std@0.177.0/async/deferred.ts": "42790112f36a75a57db4a96d33974a936deb7b04d25c6084a9fa8a49f135def8",
42 |     "https://deno.land/std@0.177.0/async/delay.ts": "73aa04cec034c84fc748c7be49bb15cac3dd43a57174bfdb7a4aec22c248f0dd",
43 |     "https://deno.land/std@0.177.0/async/mod.ts": "f04344fa21738e5ad6bea37a6bfffd57c617c2d372bb9f9dcfd118a1b622e576",
44 |     "https://deno.land/std@0.177.0/async/mux_async_iterator.ts": "70c7f2ee4e9466161350473ad61cac0b9f115cff4c552eaa7ef9d50c4cbb4cc9",
45 |     "https://deno.land/std@0.177.0/async/pool.ts": "fd082bd4aaf26445909889435a5c74334c017847842ec035739b4ae637ae8260",
46 |     "https://deno.land/std@0.177.0/async/retry.ts": "5efa3ba450ac0c07a40a82e2df296287b5013755d232049efd7ea2244f15b20f",
47 |     "https://deno.land/std@0.177.0/async/tee.ts": "47e42d35f622650b02234d43803d0383a89eb4387e1b83b5a40106d18ae36757",
48 |     "https://deno.land/std@0.177.0/http/server.ts": "cbb17b594651215ba95c01a395700684e569c165a567e4e04bba327f41197433",
49 |     "https://esm.sh/@supabase/functions-js@2.1.5/denonext/functions-js.mjs": "e6c31ad2262a84ed55da33f4a253a9ec5cd5cc41a6b4393b5ab9b0a108a2e9a8",
50 |     "https://esm.sh/@supabase/gotrue-js@2.62.2/denonext/gotrue-js.mjs": "d3dd1c95a023b518efab9fc1fb8fa172458864a4e0f4a95b5e77f8a0df526054",
51 |     "https://esm.sh/@supabase/node-fetch@2.6.15/denonext/node-fetch.mjs": "0bae9052231f4f6dbccc7234d05ea96923dbf967be12f402764580b6bf9f713d",
52 |     "https://esm.sh/@supabase/node-fetch@2.6.15?target=denonext": "4d28c4ad97328403184353f68434f2b6973971507919e9150297413664919cf3",
53 |     "https://esm.sh/@supabase/postgrest-js@1.9.2/denonext/postgrest-js.mjs": "216c149bc04130518774d10fcf2df5d1c1369d985fee7fe942840f6f77459e27",
54 |     "https://esm.sh/@supabase/realtime-js@2.9.3/denonext/realtime-js.mjs": "aac782e4fcf8d2e2f4b2592f566a0324b19b0262a2938a0c8ce546c681faef14",
55 |     "https://esm.sh/@supabase/storage-js@2.5.5/denonext/storage-js.mjs": "a952ba6fdc889a4ae8d671ce4d1a152702c1caa3158eb2269a0208b091856075",
56 |     "https://esm.sh/@supabase/supabase-js@2.39.8": "5cb81f5217dda9564abd7d7d6211484d30441d41a113954d5904bcd0ef1007e0",
57 |     "https://esm.sh/@supabase/supabase-js@2.39.8/denonext/supabase-js.mjs": "1a4d0e38fed110fef252639a51247066a642e855794bea026efb26e5ed55abd8",
58 |     "https://esm.sh/bufferutil@4.0.9/denonext/bufferutil.mjs": "13dca4d5bb2c68cbe119f880fa3bd785b9a81a8e02e0834dae604b4b85295cd8",
59 |     "https://esm.sh/bufferutil@4.0.9?target=denonext": "e32574569ab438facfcc3f412c659b0719bbf05477136ca176938c9a3ac45125",
60 |     "https://esm.sh/node-gyp-build@4.8.4/denonext/node-gyp-build.mjs": "9a86f2d044fc77bd60aaa3d697c2ba1b818da5fb1b9aaeedec59a40b8e908803",
61 |     "https://esm.sh/node-gyp-build@4.8.4?target=denonext": "261a6cedf1fdbf159798141ba1e2311ac1510682c5c8b55dacc8cf5fdee4aa06",
62 |     "https://esm.sh/tr46@0.0.3/denonext/tr46.mjs": "5753ec0a99414f4055f0c1f97691100f13d88e48a8443b00aebb90a512785fa2",
63 |     "https://esm.sh/tr46@0.0.3?target=denonext": "19cb9be0f0d418a0c3abb81f2df31f080e9540a04e43b0f699bce1149cba0cbb",
64 |     "https://esm.sh/utf-8-validate@6.0.5/denonext/utf-8-validate.mjs": "66b8ea532a0c745068f5b96ddb1bae332c3036703243541d2e89e66331974d98",
65 |     "https://esm.sh/utf-8-validate@6.0.5?target=denonext": "071bc33ba1a58297e23a34d69dd589fd06df04b0f373b382ff5da544a623f271",
66 |     "https://esm.sh/webidl-conversions@3.0.1/denonext/webidl-conversions.mjs": "54b5c2d50a294853c4ccebf9d5ed8988c94f4e24e463d84ec859a866ea5fafec",
67 |     "https://esm.sh/webidl-conversions@3.0.1?target=denonext": "4e20318d50528084616c79d7b3f6e7f0fe7b6d09013bd01b3974d7448d767e29",
68 |     "https://esm.sh/whatwg-url@5.0.0/denonext/whatwg-url.mjs": "29b16d74ee72624c915745bbd25b617cfd2248c6af0f5120d131e232a9a9af79",
69 |     "https://esm.sh/whatwg-url@5.0.0?target=denonext": "f001a2cadf81312d214ca330033f474e74d81a003e21e8c5d70a1f46dc97b02d",
70 |     "https://esm.sh/ws@8.18.2/denonext/ws.mjs": "b9211ecb1511b09f418c1330920c66800b66710b2cd2997b64b7e0525bd895d2",
71 |     "https://esm.sh/ws@8.18.2?target=denonext": "2ee7b1bb11543dda3e7e1c685ad8599b6f18aea785302374c3def5da468a1e51"
72 |   }
73 | }
```

supabase/migrations/20230901000000_init_db.sql
```
1 | -- Habilitar la extensión para generar UUIDs
2 | CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
3 | 
4 | -- Tabla de perfiles de usuario
5 | CREATE TABLE public.profiles (
6 |   id UUID REFERENCES auth.users(id) PRIMARY KEY,
7 |   language TEXT NOT NULL,
8 |   child_age INT NOT NULL,
9 |   special_need TEXT,
10 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
11 |   updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
12 | );
13 | 
14 | -- Tabla de personajes
15 | CREATE TABLE public.characters (
16 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
17 |   user_id UUID REFERENCES auth.users(id) NOT NULL,
18 |   name TEXT NOT NULL,
19 |   hobbies TEXT[] NOT NULL,
20 |   description TEXT NOT NULL,
21 |   profession TEXT NOT NULL,
22 |   character_type TEXT NOT NULL,
23 |   personality TEXT,
24 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
25 |   updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
26 | );
27 | 
28 | -- Tabla de historias
29 | CREATE TABLE public.stories (
30 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
31 |   user_id UUID REFERENCES auth.users(id) NOT NULL,
32 |   title TEXT NOT NULL,
33 |   content TEXT NOT NULL,
34 |   audio_url TEXT,
35 |   image_url TEXT,
36 |   moral TEXT,
37 |   genre TEXT,
38 |   duration TEXT NOT NULL,
39 |   character_id UUID REFERENCES public.characters(id) NOT NULL,
40 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
41 |   updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
42 | );
43 | 
44 | -- Tabla de capítulos
45 | CREATE TABLE public.story_chapters (
46 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
47 |   story_id UUID REFERENCES public.stories(id) NOT NULL,
48 |   chapter_number INT NOT NULL,
49 |   title TEXT NOT NULL,
50 |   content TEXT NOT NULL,
51 |   generation_method TEXT,
52 |   custom_input TEXT,
53 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
54 |   updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
55 | );
56 | 
57 | -- Tabla de desafíos
58 | CREATE TABLE public.challenges (
59 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
60 |   story_id UUID REFERENCES public.stories(id) NOT NULL,
61 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
62 | );
63 | 
64 | -- Tabla de preguntas de desafíos
65 | CREATE TABLE public.challenge_questions (
66 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
67 |   challenge_id UUID REFERENCES public.challenges(id) NOT NULL,
68 |   question TEXT NOT NULL,
69 |   options TEXT[] NOT NULL,
70 |   correct_option_index INT NOT NULL,
71 |   explanation TEXT NOT NULL,
72 |   category TEXT NOT NULL,
73 |   target_language TEXT,
74 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
75 | );
76 | 
77 | -- Tabla de archivos de audio
78 | CREATE TABLE public.audio_files (
79 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
80 |   user_id UUID REFERENCES auth.users(id) NOT NULL,
81 |   story_id UUID REFERENCES public.stories(id),
82 |   chapter_id UUID REFERENCES public.story_chapters(id),
83 |   voice_id TEXT NOT NULL,
84 |   url TEXT NOT NULL,
85 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
86 | );
87 | 
88 | -- Tabla de preferencias de voz del usuario
89 | CREATE TABLE public.user_voices (
90 |   id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
91 |   user_id UUID REFERENCES auth.users(id) NOT NULL,
92 |   voice_id TEXT NOT NULL,
93 |   is_current BOOLEAN DEFAULT FALSE,
94 |   created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
95 |   updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
96 | );
97 | 
98 | -- Habilitar RLS (Row Level Security) en todas las tablas
99 | ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
100 | ALTER TABLE public.characters ENABLE ROW LEVEL SECURITY;
101 | ALTER TABLE public.stories ENABLE ROW LEVEL SECURITY;
102 | ALTER TABLE public.story_chapters ENABLE ROW LEVEL SECURITY;
103 | ALTER TABLE public.challenges ENABLE ROW LEVEL SECURITY;
104 | ALTER TABLE public.challenge_questions ENABLE ROW LEVEL SECURITY;
105 | ALTER TABLE public.audio_files ENABLE ROW LEVEL SECURITY;
106 | ALTER TABLE public.user_voices ENABLE ROW LEVEL SECURITY;
107 | 
108 | -- Políticas RLS para perfiles
109 | CREATE POLICY "Los usuarios pueden ver su propio perfil" ON public.profiles
110 |   FOR SELECT USING (auth.uid() = id);
111 | CREATE POLICY "Los usuarios pueden crear su propio perfil" ON public.profiles
112 |   FOR INSERT WITH CHECK (auth.uid() = id);
113 | CREATE POLICY "Los usuarios pueden actualizar su propio perfil" ON public.profiles
114 |   FOR UPDATE USING (auth.uid() = id);
115 | 
116 | -- Políticas RLS para personajes
117 | CREATE POLICY "Los usuarios pueden ver sus propios personajes" ON public.characters
118 |   FOR SELECT USING (auth.uid() = user_id);
119 | CREATE POLICY "Los usuarios pueden crear sus propios personajes" ON public.characters
120 |   FOR INSERT WITH CHECK (auth.uid() = user_id);
121 | CREATE POLICY "Los usuarios pueden actualizar sus propios personajes" ON public.characters
122 |   FOR UPDATE USING (auth.uid() = user_id);
123 | CREATE POLICY "Los usuarios pueden eliminar sus propios personajes" ON public.characters
124 |   FOR DELETE USING (auth.uid() = user_id);
125 | 
126 | -- Políticas RLS para historias
127 | CREATE POLICY "Los usuarios pueden ver sus propias historias" ON public.stories
128 |   FOR SELECT USING (auth.uid() = user_id);
129 | CREATE POLICY "Los usuarios pueden crear sus propias historias" ON public.stories
130 |   FOR INSERT WITH CHECK (auth.uid() = user_id);
131 | CREATE POLICY "Los usuarios pueden actualizar sus propias historias" ON public.stories
132 |   FOR UPDATE USING (auth.uid() = user_id);
133 | CREATE POLICY "Los usuarios pueden eliminar sus propias historias" ON public.stories
134 |   FOR DELETE USING (auth.uid() = user_id);
135 | 
136 | -- Políticas RLS para capítulos
137 | CREATE POLICY "Los usuarios pueden ver capítulos de sus historias" ON public.story_chapters
138 |   FOR SELECT USING (auth.uid() IN (
139 |     SELECT user_id FROM public.stories WHERE id = story_id
140 |   ));
141 | CREATE POLICY "Los usuarios pueden crear capítulos en sus historias" ON public.story_chapters
142 |   FOR INSERT WITH CHECK (auth.uid() IN (
143 |     SELECT user_id FROM public.stories WHERE id = story_id
144 |   ));
145 | CREATE POLICY "Los usuarios pueden actualizar capítulos de sus historias" ON public.story_chapters
146 |   FOR UPDATE USING (auth.uid() IN (
147 |     SELECT user_id FROM public.stories WHERE id = story_id
148 |   ));
149 | CREATE POLICY "Los usuarios pueden eliminar capítulos de sus historias" ON public.story_chapters
150 |   FOR DELETE USING (auth.uid() IN (
151 |     SELECT user_id FROM public.stories WHERE id = story_id
152 |   ));
153 | 
154 | -- Políticas RLS para desafíos
155 | CREATE POLICY "Los usuarios pueden ver desafíos de sus historias" ON public.challenges
156 |   FOR SELECT USING (auth.uid() IN (
157 |     SELECT user_id FROM public.stories WHERE id = story_id
158 |   ));
159 | CREATE POLICY "Los usuarios pueden crear desafíos en sus historias" ON public.challenges
160 |   FOR INSERT WITH CHECK (auth.uid() IN (
161 |     SELECT user_id FROM public.stories WHERE id = story_id
162 |   ));
163 | CREATE POLICY "Los usuarios pueden actualizar desafíos de sus historias" ON public.challenges
164 |   FOR UPDATE USING (auth.uid() IN (
165 |     SELECT user_id FROM public.stories WHERE id = story_id
166 |   ));
167 | 
168 | -- Políticas RLS para preguntas de desafíos
169 | CREATE POLICY "Los usuarios pueden ver preguntas de desafíos de sus historias" ON public.challenge_questions
170 |   FOR SELECT USING (auth.uid() IN (
171 |     SELECT s.user_id 
172 |     FROM public.stories s 
173 |     JOIN public.challenges c ON s.id = c.story_id 
174 |     WHERE c.id = challenge_id
175 |   ));
176 | CREATE POLICY "Los usuarios pueden crear preguntas en desafíos de sus historias" ON public.challenge_questions
177 |   FOR INSERT WITH CHECK (auth.uid() IN (
178 |     SELECT s.user_id 
179 |     FROM public.stories s 
180 |     JOIN public.challenges c ON s.id = c.story_id 
181 |     WHERE c.id = challenge_id
182 |   ));
183 | CREATE POLICY "Los usuarios pueden actualizar preguntas de desafíos de sus historias" ON public.challenge_questions
184 |   FOR UPDATE USING (auth.uid() IN (
185 |     SELECT s.user_id 
186 |     FROM public.stories s 
187 |     JOIN public.challenges c ON s.id = c.story_id 
188 |     WHERE c.id = challenge_id
189 |   ));
190 | 
191 | -- Políticas RLS para archivos de audio
192 | CREATE POLICY "Los usuarios pueden ver sus archivos de audio" ON public.audio_files
193 |   FOR SELECT USING (auth.uid() = user_id);
194 | CREATE POLICY "Los usuarios pueden crear sus archivos de audio" ON public.audio_files
195 |   FOR INSERT WITH CHECK (auth.uid() = user_id);
196 | CREATE POLICY "Los usuarios pueden actualizar sus archivos de audio" ON public.audio_files
197 |   FOR UPDATE USING (auth.uid() = user_id);
198 | CREATE POLICY "Los usuarios pueden eliminar sus archivos de audio" ON public.audio_files
199 |   FOR DELETE USING (auth.uid() = user_id);
200 | 
201 | -- Políticas RLS para preferencias de voz
202 | CREATE POLICY "Los usuarios pueden ver sus preferencias de voz" ON public.user_voices
203 |   FOR SELECT USING (auth.uid() = user_id);
204 | CREATE POLICY "Los usuarios pueden crear sus preferencias de voz" ON public.user_voices
205 |   FOR INSERT WITH CHECK (auth.uid() = user_id);
206 | CREATE POLICY "Los usuarios pueden actualizar sus preferencias de voz" ON public.user_voices
207 |   FOR UPDATE USING (auth.uid() = user_id);
208 | CREATE POLICY "Los usuarios pueden eliminar sus preferencias de voz" ON public.user_voices
209 |   FOR DELETE USING (auth.uid() = user_id);
210 | 
211 | -- Creación de funciones y triggers para actualizar automáticamente 'updated_at'
212 | CREATE OR REPLACE FUNCTION update_modified_column()
213 | RETURNS TRIGGER AS $$
214 | BEGIN
215 |    NEW.updated_at = NOW();
216 |    RETURN NEW;
217 | END;
218 | $$ LANGUAGE 'plpgsql';
219 | 
220 | -- Triggers para actualizar updated_at en cada tabla
221 | CREATE TRIGGER update_profiles_modtime
222 |   BEFORE UPDATE ON public.profiles
223 |   FOR EACH ROW EXECUTE PROCEDURE update_modified_column();
224 | 
225 | CREATE TRIGGER update_characters_modtime
226 |   BEFORE UPDATE ON public.characters
227 |   FOR EACH ROW EXECUTE PROCEDURE update_modified_column();
228 | 
229 | CREATE TRIGGER update_stories_modtime
230 |   BEFORE UPDATE ON public.stories
231 |   FOR EACH ROW EXECUTE PROCEDURE update_modified_column();
232 | 
233 | CREATE TRIGGER update_story_chapters_modtime
234 |   BEFORE UPDATE ON public.story_chapters
235 |   FOR EACH ROW EXECUTE PROCEDURE update_modified_column();
236 | 
237 | CREATE TRIGGER update_user_voices_modtime
238 |   BEFORE UPDATE ON public.user_voices
239 |   FOR EACH ROW EXECUTE PROCEDURE update_modified_column(); 
```

supabase/migrations/20231027103000_schedule_monthly_reset.sql
```
1 | -- Activar pg_cron si es necesario
2 | CREATE EXTENSION IF NOT EXISTS pg_cron WITH SCHEMA extensions;
3 | 
4 | -- Programar el job para ejecutar la función de reseteo
5 | -- Ejecuta a las 00:00 del día 1 de cada mes
6 | SELECT cron.schedule(
7 |     'monthly_story_reset',
8 |     '0 0 1 * *',
9 |    $$ SELECT public.reset_monthly_story_counts(); $$
10 | );
```

supabase/sql-functions/decrement_voice_credits.sql
```
1 | CREATE OR REPLACE FUNCTION public.decrement_voice_credits(user_uuid uuid)
2 | RETURNS integer LANGUAGE plpgsql SECURITY INVOKER AS $$
3 | DECLARE updated_credits INTEGER;
4 | BEGIN
5 |   UPDATE public.profiles SET voice_credits = voice_credits - 1
6 |   WHERE id = user_uuid AND voice_credits > 0
7 |   RETURNING voice_credits INTO updated_credits;
8 |   RETURN COALESCE(updated_credits, -1);
9 | END;
10 | $$;
```

supabase/sql-functions/handle_new_user.sql
```
1 | CREATE OR REPLACE FUNCTION public.handle_new_user()
2 | RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER AS $$
3 | BEGIN
4 |   INSERT INTO public.profiles (id, language) VALUES (new.id, 'es');
5 |   RETURN new;
6 | END;
7 | $$;
```

supabase/sql-functions/increment_monthly_voice_usage.sql
```
1 | CREATE OR REPLACE FUNCTION public.increment_monthly_voice_usage(user_uuid uuid)
2 | RETURNS void LANGUAGE plpgsql SECURITY INVOKER AS $$
3 | BEGIN
4 |   UPDATE public.profiles
5 |   SET monthly_voice_generations_used = COALESCE(monthly_voice_generations_used, 0) + 1
6 |   WHERE id = user_uuid;
7 | END;
8 | $$;
```

supabase/sql-functions/increment_story_count.sql
```
1 | CREATE OR REPLACE FUNCTION public.increment_story_count(user_uuid uuid)
2 | RETURNS void LANGUAGE plpgsql SECURITY INVOKER AS $$
3 | BEGIN
4 |   UPDATE public.profiles
5 |   SET monthly_stories_generated = COALESCE(monthly_stories_generated, 0) + 1 -- Nombre Corregido
6 |   WHERE id = user_uuid;
7 | END;
8 | $$;
```

supabase/sql-functions/increment_voice_credits.sql
```
1 | CREATE OR REPLACE FUNCTION public.increment_voice_credits(user_uuid uuid, credits_to_add integer)
2 | RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$ -- Mantenido DEFINER
3 | BEGIN
4 |   UPDATE public.profiles
5 |   SET voice_credits = COALESCE(voice_credits, 0) + credits_to_add
6 |   WHERE id = user_uuid;
7 | END;
8 | $$;
```

supabase/sql-functions/reset_monthly_counters.sql
```
1 | CREATE OR REPLACE FUNCTION public.reset_monthly_counters()
2 | RETURNS void
3 | LANGUAGE plpgsql
4 | SECURITY DEFINER
5 | AS $$
6 | BEGIN
7 |   -- Resetea el contador de historias generadas SÓLO para usuarios NO premium
8 |   UPDATE public.profiles
9 |   SET monthly_stories_generated = 0
10 |   WHERE (subscription_status IS NULL OR subscription_status NOT IN ('active', 'trialing')) -- Condición para gratuitos/cancelados
11 |     AND monthly_stories_generated > 0; -- Opcional: solo actualiza si es necesario
12 | 
13 |   RAISE LOG 'Contadores mensuales de historias para usuarios gratuitos reseteados.';
14 | 
15 |   -- NO TOCAR monthly_voice_generations_used aquí. Eso se maneja en el webhook.
16 | END;
17 | $$;
```

supabase/sql-functions/update_modified_column.sql
```
1 | CREATE OR REPLACE FUNCTION public.update_modified_column()
2 | RETURNS trigger LANGUAGE plpgsql SECURITY INVOKER AS $$
3 | BEGIN
4 |    NEW.updated_at = NOW();
5 |    RETURN NEW;
6 | END;
7 | $$;
```

src/components/ui/accordion.tsx
```
1 | import * as React from "react"
2 | import * as AccordionPrimitive from "@radix-ui/react-accordion"
3 | import { ChevronDown } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const Accordion = AccordionPrimitive.Root
8 | 
9 | const AccordionItem = React.forwardRef<
10 |   React.ElementRef<typeof AccordionPrimitive.Item>,
11 |   React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
12 | >(({ className, ...props }, ref) => (
13 |   <AccordionPrimitive.Item
14 |     ref={ref}
15 |     className={cn("border-b", className)}
16 |     {...props}
17 |   />
18 | ))
19 | AccordionItem.displayName = "AccordionItem"
20 | 
21 | const AccordionTrigger = React.forwardRef<
22 |   React.ElementRef<typeof AccordionPrimitive.Trigger>,
23 |   React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
24 | >(({ className, children, ...props }, ref) => (
25 |   <AccordionPrimitive.Header className="flex">
26 |     <AccordionPrimitive.Trigger
27 |       ref={ref}
28 |       className={cn(
29 |         "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
30 |         className
31 |       )}
32 |       {...props}
33 |     >
34 |       {children}
35 |       <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
36 |     </AccordionPrimitive.Trigger>
37 |   </AccordionPrimitive.Header>
38 | ))
39 | AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName
40 | 
41 | const AccordionContent = React.forwardRef<
42 |   React.ElementRef<typeof AccordionPrimitive.Content>,
43 |   React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
44 | >(({ className, children, ...props }, ref) => (
45 |   <AccordionPrimitive.Content
46 |     ref={ref}
47 |     className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
48 |     {...props}
49 |   >
50 |     <div className={cn("pb-4 pt-0", className)}>{children}</div>
51 |   </AccordionPrimitive.Content>
52 | ))
53 | 
54 | AccordionContent.displayName = AccordionPrimitive.Content.displayName
55 | 
56 | export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
```

src/components/ui/alert-dialog.tsx
```
1 | import * as React from "react"
2 | import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"
3 | 
4 | import { cn } from "@/lib/utils"
5 | import { buttonVariants } from "@/components/ui/button"
6 | 
7 | const AlertDialog = AlertDialogPrimitive.Root
8 | 
9 | const AlertDialogTrigger = AlertDialogPrimitive.Trigger
10 | 
11 | const AlertDialogPortal = AlertDialogPrimitive.Portal
12 | 
13 | const AlertDialogOverlay = React.forwardRef<
14 |   React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
15 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
16 | >(({ className, ...props }, ref) => (
17 |   <AlertDialogPrimitive.Overlay
18 |     className={cn(
19 |       "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
20 |       className
21 |     )}
22 |     {...props}
23 |     ref={ref}
24 |   />
25 | ))
26 | AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName
27 | 
28 | const AlertDialogContent = React.forwardRef<
29 |   React.ElementRef<typeof AlertDialogPrimitive.Content>,
30 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
31 | >(({ className, ...props }, ref) => (
32 |   <AlertDialogPortal>
33 |     <AlertDialogOverlay />
34 |     <AlertDialogPrimitive.Content
35 |       ref={ref}
36 |       className={cn(
37 |         "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
38 |         className
39 |       )}
40 |       {...props}
41 |     />
42 |   </AlertDialogPortal>
43 | ))
44 | AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName
45 | 
46 | const AlertDialogHeader = ({
47 |   className,
48 |   ...props
49 | }: React.HTMLAttributes<HTMLDivElement>) => (
50 |   <div
51 |     className={cn(
52 |       "flex flex-col space-y-2 text-center sm:text-left",
53 |       className
54 |     )}
55 |     {...props}
56 |   />
57 | )
58 | AlertDialogHeader.displayName = "AlertDialogHeader"
59 | 
60 | const AlertDialogFooter = ({
61 |   className,
62 |   ...props
63 | }: React.HTMLAttributes<HTMLDivElement>) => (
64 |   <div
65 |     className={cn(
66 |       "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
67 |       className
68 |     )}
69 |     {...props}
70 |   />
71 | )
72 | AlertDialogFooter.displayName = "AlertDialogFooter"
73 | 
74 | const AlertDialogTitle = React.forwardRef<
75 |   React.ElementRef<typeof AlertDialogPrimitive.Title>,
76 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
77 | >(({ className, ...props }, ref) => (
78 |   <AlertDialogPrimitive.Title
79 |     ref={ref}
80 |     className={cn("text-lg font-semibold", className)}
81 |     {...props}
82 |   />
83 | ))
84 | AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName
85 | 
86 | const AlertDialogDescription = React.forwardRef<
87 |   React.ElementRef<typeof AlertDialogPrimitive.Description>,
88 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
89 | >(({ className, ...props }, ref) => (
90 |   <AlertDialogPrimitive.Description
91 |     ref={ref}
92 |     className={cn("text-sm text-muted-foreground", className)}
93 |     {...props}
94 |   />
95 | ))
96 | AlertDialogDescription.displayName =
97 |   AlertDialogPrimitive.Description.displayName
98 | 
99 | const AlertDialogAction = React.forwardRef<
100 |   React.ElementRef<typeof AlertDialogPrimitive.Action>,
101 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
102 | >(({ className, ...props }, ref) => (
103 |   <AlertDialogPrimitive.Action
104 |     ref={ref}
105 |     className={cn(buttonVariants(), className)}
106 |     {...props}
107 |   />
108 | ))
109 | AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName
110 | 
111 | const AlertDialogCancel = React.forwardRef<
112 |   React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
113 |   React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
114 | >(({ className, ...props }, ref) => (
115 |   <AlertDialogPrimitive.Cancel
116 |     ref={ref}
117 |     className={cn(
118 |       buttonVariants({ variant: "outline" }),
119 |       "mt-2 sm:mt-0",
120 |       className
121 |     )}
122 |     {...props}
123 |   />
124 | ))
125 | AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName
126 | 
127 | export {
128 |   AlertDialog,
129 |   AlertDialogPortal,
130 |   AlertDialogOverlay,
131 |   AlertDialogTrigger,
132 |   AlertDialogContent,
133 |   AlertDialogHeader,
134 |   AlertDialogFooter,
135 |   AlertDialogTitle,
136 |   AlertDialogDescription,
137 |   AlertDialogAction,
138 |   AlertDialogCancel,
139 | }
```

src/components/ui/alert.tsx
```
1 | import * as React from "react"
2 | import { cva, type VariantProps } from "class-variance-authority"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const alertVariants = cva(
7 |   "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
8 |   {
9 |     variants: {
10 |       variant: {
11 |         default: "bg-background text-foreground",
12 |         destructive:
13 |           "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
14 |       },
15 |     },
16 |     defaultVariants: {
17 |       variant: "default",
18 |     },
19 |   }
20 | )
21 | 
22 | const Alert = React.forwardRef<
23 |   HTMLDivElement,
24 |   React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
25 | >(({ className, variant, ...props }, ref) => (
26 |   <div
27 |     ref={ref}
28 |     role="alert"
29 |     className={cn(alertVariants({ variant }), className)}
30 |     {...props}
31 |   />
32 | ))
33 | Alert.displayName = "Alert"
34 | 
35 | const AlertTitle = React.forwardRef<
36 |   HTMLParagraphElement,
37 |   React.HTMLAttributes<HTMLHeadingElement>
38 | >(({ className, ...props }, ref) => (
39 |   <h5
40 |     ref={ref}
41 |     className={cn("mb-1 font-medium leading-none tracking-tight", className)}
42 |     {...props}
43 |   />
44 | ))
45 | AlertTitle.displayName = "AlertTitle"
46 | 
47 | const AlertDescription = React.forwardRef<
48 |   HTMLParagraphElement,
49 |   React.HTMLAttributes<HTMLParagraphElement>
50 | >(({ className, ...props }, ref) => (
51 |   <div
52 |     ref={ref}
53 |     className={cn("text-sm [&_p]:leading-relaxed", className)}
54 |     {...props}
55 |   />
56 | ))
57 | AlertDescription.displayName = "AlertDescription"
58 | 
59 | export { Alert, AlertTitle, AlertDescription }
```

src/components/ui/aspect-ratio.tsx
```
1 | import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio"
2 | 
3 | const AspectRatio = AspectRatioPrimitive.Root
4 | 
5 | export { AspectRatio }
```

src/components/ui/avatar.tsx
```
1 | import * as React from "react"
2 | import * as AvatarPrimitive from "@radix-ui/react-avatar"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Avatar = React.forwardRef<
7 |   React.ElementRef<typeof AvatarPrimitive.Root>,
8 |   React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
9 | >(({ className, ...props }, ref) => (
10 |   <AvatarPrimitive.Root
11 |     ref={ref}
12 |     className={cn(
13 |       "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
14 |       className
15 |     )}
16 |     {...props}
17 |   />
18 | ))
19 | Avatar.displayName = AvatarPrimitive.Root.displayName
20 | 
21 | const AvatarImage = React.forwardRef<
22 |   React.ElementRef<typeof AvatarPrimitive.Image>,
23 |   React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
24 | >(({ className, ...props }, ref) => (
25 |   <AvatarPrimitive.Image
26 |     ref={ref}
27 |     className={cn("aspect-square h-full w-full", className)}
28 |     {...props}
29 |   />
30 | ))
31 | AvatarImage.displayName = AvatarPrimitive.Image.displayName
32 | 
33 | const AvatarFallback = React.forwardRef<
34 |   React.ElementRef<typeof AvatarPrimitive.Fallback>,
35 |   React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
36 | >(({ className, ...props }, ref) => (
37 |   <AvatarPrimitive.Fallback
38 |     ref={ref}
39 |     className={cn(
40 |       "flex h-full w-full items-center justify-center rounded-full bg-muted",
41 |       className
42 |     )}
43 |     {...props}
44 |   />
45 | ))
46 | AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName
47 | 
48 | export { Avatar, AvatarImage, AvatarFallback }
```

src/components/ui/badge.tsx
```
1 | import * as React from "react"
2 | import { cva, type VariantProps } from "class-variance-authority"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const badgeVariants = cva(
7 |   "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
8 |   {
9 |     variants: {
10 |       variant: {
11 |         default:
12 |           "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
13 |         secondary:
14 |           "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
15 |         destructive:
16 |           "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
17 |         outline: "text-foreground",
18 |       },
19 |     },
20 |     defaultVariants: {
21 |       variant: "default",
22 |     },
23 |   }
24 | )
25 | 
26 | export interface BadgeProps
27 |   extends React.HTMLAttributes<HTMLDivElement>,
28 |     VariantProps<typeof badgeVariants> {}
29 | 
30 | function Badge({ className, variant, ...props }: BadgeProps) {
31 |   return (
32 |     <div className={cn(badgeVariants({ variant }), className)} {...props} />
33 |   )
34 | }
35 | 
36 | export { Badge, badgeVariants }
```

src/components/ui/breadcrumb.tsx
```
1 | import * as React from "react"
2 | import { Slot } from "@radix-ui/react-slot"
3 | import { ChevronRight, MoreHorizontal } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const Breadcrumb = React.forwardRef<
8 |   HTMLElement,
9 |   React.ComponentPropsWithoutRef<"nav"> & {
10 |     separator?: React.ReactNode
11 |   }
12 | >(({ ...props }, ref) => <nav ref={ref} aria-label="breadcrumb" {...props} />)
13 | Breadcrumb.displayName = "Breadcrumb"
14 | 
15 | const BreadcrumbList = React.forwardRef<
16 |   HTMLOListElement,
17 |   React.ComponentPropsWithoutRef<"ol">
18 | >(({ className, ...props }, ref) => (
19 |   <ol
20 |     ref={ref}
21 |     className={cn(
22 |       "flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",
23 |       className
24 |     )}
25 |     {...props}
26 |   />
27 | ))
28 | BreadcrumbList.displayName = "BreadcrumbList"
29 | 
30 | const BreadcrumbItem = React.forwardRef<
31 |   HTMLLIElement,
32 |   React.ComponentPropsWithoutRef<"li">
33 | >(({ className, ...props }, ref) => (
34 |   <li
35 |     ref={ref}
36 |     className={cn("inline-flex items-center gap-1.5", className)}
37 |     {...props}
38 |   />
39 | ))
40 | BreadcrumbItem.displayName = "BreadcrumbItem"
41 | 
42 | const BreadcrumbLink = React.forwardRef<
43 |   HTMLAnchorElement,
44 |   React.ComponentPropsWithoutRef<"a"> & {
45 |     asChild?: boolean
46 |   }
47 | >(({ asChild, className, ...props }, ref) => {
48 |   const Comp = asChild ? Slot : "a"
49 | 
50 |   return (
51 |     <Comp
52 |       ref={ref}
53 |       className={cn("transition-colors hover:text-foreground", className)}
54 |       {...props}
55 |     />
56 |   )
57 | })
58 | BreadcrumbLink.displayName = "BreadcrumbLink"
59 | 
60 | const BreadcrumbPage = React.forwardRef<
61 |   HTMLSpanElement,
62 |   React.ComponentPropsWithoutRef<"span">
63 | >(({ className, ...props }, ref) => (
64 |   <span
65 |     ref={ref}
66 |     role="link"
67 |     aria-disabled="true"
68 |     aria-current="page"
69 |     className={cn("font-normal text-foreground", className)}
70 |     {...props}
71 |   />
72 | ))
73 | BreadcrumbPage.displayName = "BreadcrumbPage"
74 | 
75 | const BreadcrumbSeparator = ({
76 |   children,
77 |   className,
78 |   ...props
79 | }: React.ComponentProps<"li">) => (
80 |   <li
81 |     role="presentation"
82 |     aria-hidden="true"
83 |     className={cn("[&>svg]:size-3.5", className)}
84 |     {...props}
85 |   >
86 |     {children ?? <ChevronRight />}
87 |   </li>
88 | )
89 | BreadcrumbSeparator.displayName = "BreadcrumbSeparator"
90 | 
91 | const BreadcrumbEllipsis = ({
92 |   className,
93 |   ...props
94 | }: React.ComponentProps<"span">) => (
95 |   <span
96 |     role="presentation"
97 |     aria-hidden="true"
98 |     className={cn("flex h-9 w-9 items-center justify-center", className)}
99 |     {...props}
100 |   >
101 |     <MoreHorizontal className="h-4 w-4" />
102 |     <span className="sr-only">More</span>
103 |   </span>
104 | )
105 | BreadcrumbEllipsis.displayName = "BreadcrumbElipssis"
106 | 
107 | export {
108 |   Breadcrumb,
109 |   BreadcrumbList,
110 |   BreadcrumbItem,
111 |   BreadcrumbLink,
112 |   BreadcrumbPage,
113 |   BreadcrumbSeparator,
114 |   BreadcrumbEllipsis,
115 | }
```

src/components/ui/button.tsx
```
1 | import * as React from "react"
2 | import { Slot } from "@radix-ui/react-slot"
3 | import { cva, type VariantProps } from "class-variance-authority"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const buttonVariants = cva(
8 |   "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
9 |   {
10 |     variants: {
11 |       variant: {
12 |         default: "bg-primary text-primary-foreground hover:bg-primary/90",
13 |         destructive:
14 |           "bg-destructive text-destructive-foreground hover:bg-destructive/90",
15 |         outline:
16 |           "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
17 |         secondary:
18 |           "bg-secondary text-secondary-foreground hover:bg-secondary/80",
19 |         ghost: "hover:bg-accent hover:text-accent-foreground",
20 |         link: "text-primary underline-offset-4 hover:underline",
21 |       },
22 |       size: {
23 |         default: "h-10 px-4 py-2",
24 |         sm: "h-9 rounded-md px-3",
25 |         lg: "h-11 rounded-md px-8",
26 |         icon: "h-10 w-10",
27 |       },
28 |     },
29 |     defaultVariants: {
30 |       variant: "default",
31 |       size: "default",
32 |     },
33 |   }
34 | )
35 | 
36 | export interface ButtonProps
37 |   extends React.ButtonHTMLAttributes<HTMLButtonElement>,
38 |     VariantProps<typeof buttonVariants> {
39 |   asChild?: boolean
40 | }
41 | 
42 | const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
43 |   ({ className, variant, size, asChild = false, ...props }, ref) => {
44 |     const Comp = asChild ? Slot : "button"
45 |     return (
46 |       <Comp
47 |         className={cn(buttonVariants({ variant, size, className }))}
48 |         ref={ref}
49 |         {...props}
50 |       />
51 |     )
52 |   }
53 | )
54 | Button.displayName = "Button"
55 | 
56 | export { Button, buttonVariants }
```

src/components/ui/calendar.tsx
```
1 | import * as React from "react";
2 | import { ChevronLeft, ChevronRight } from "lucide-react";
3 | import { DayPicker } from "react-day-picker";
4 | 
5 | import { cn } from "@/lib/utils";
6 | import { buttonVariants } from "@/components/ui/button";
7 | 
8 | export type CalendarProps = React.ComponentProps<typeof DayPicker>;
9 | 
10 | function Calendar({
11 |   className,
12 |   classNames,
13 |   showOutsideDays = true,
14 |   ...props
15 | }: CalendarProps) {
16 |   return (
17 |     <DayPicker
18 |       showOutsideDays={showOutsideDays}
19 |       className={cn("p-3", className)}
20 |       classNames={{
21 |         months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
22 |         month: "space-y-4",
23 |         caption: "flex justify-center pt-1 relative items-center",
24 |         caption_label: "text-sm font-medium",
25 |         nav: "space-x-1 flex items-center",
26 |         nav_button: cn(
27 |           buttonVariants({ variant: "outline" }),
28 |           "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
29 |         ),
30 |         nav_button_previous: "absolute left-1",
31 |         nav_button_next: "absolute right-1",
32 |         table: "w-full border-collapse space-y-1",
33 |         head_row: "flex",
34 |         head_cell:
35 |           "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
36 |         row: "flex w-full mt-2",
37 |         cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
38 |         day: cn(
39 |           buttonVariants({ variant: "ghost" }),
40 |           "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
41 |         ),
42 |         day_range_end: "day-range-end",
43 |         day_selected:
44 |           "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
45 |         day_today: "bg-accent text-accent-foreground",
46 |         day_outside:
47 |           "day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",
48 |         day_disabled: "text-muted-foreground opacity-50",
49 |         day_range_middle:
50 |           "aria-selected:bg-accent aria-selected:text-accent-foreground",
51 |         day_hidden: "invisible",
52 |         ...classNames,
53 |       }}
54 |       components={{
55 |         IconLeft: ({ ..._props }) => <ChevronLeft className="h-4 w-4" />,
56 |         IconRight: ({ ..._props }) => <ChevronRight className="h-4 w-4" />,
57 |       }}
58 |       {...props}
59 |     />
60 |   );
61 | }
62 | Calendar.displayName = "Calendar";
63 | 
64 | export { Calendar };
```

src/components/ui/card.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | const Card = React.forwardRef<
6 |   HTMLDivElement,
7 |   React.HTMLAttributes<HTMLDivElement>
8 | >(({ className, ...props }, ref) => (
9 |   <div
10 |     ref={ref}
11 |     className={cn(
12 |       "rounded-lg border bg-card text-card-foreground shadow-sm",
13 |       className
14 |     )}
15 |     {...props}
16 |   />
17 | ))
18 | Card.displayName = "Card"
19 | 
20 | const CardHeader = React.forwardRef<
21 |   HTMLDivElement,
22 |   React.HTMLAttributes<HTMLDivElement>
23 | >(({ className, ...props }, ref) => (
24 |   <div
25 |     ref={ref}
26 |     className={cn("flex flex-col space-y-1.5 p-6", className)}
27 |     {...props}
28 |   />
29 | ))
30 | CardHeader.displayName = "CardHeader"
31 | 
32 | const CardTitle = React.forwardRef<
33 |   HTMLParagraphElement,
34 |   React.HTMLAttributes<HTMLHeadingElement>
35 | >(({ className, ...props }, ref) => (
36 |   <h3
37 |     ref={ref}
38 |     className={cn(
39 |       "text-2xl font-semibold leading-none tracking-tight",
40 |       className
41 |     )}
42 |     {...props}
43 |   />
44 | ))
45 | CardTitle.displayName = "CardTitle"
46 | 
47 | const CardDescription = React.forwardRef<
48 |   HTMLParagraphElement,
49 |   React.HTMLAttributes<HTMLParagraphElement>
50 | >(({ className, ...props }, ref) => (
51 |   <p
52 |     ref={ref}
53 |     className={cn("text-sm text-muted-foreground", className)}
54 |     {...props}
55 |   />
56 | ))
57 | CardDescription.displayName = "CardDescription"
58 | 
59 | const CardContent = React.forwardRef<
60 |   HTMLDivElement,
61 |   React.HTMLAttributes<HTMLDivElement>
62 | >(({ className, ...props }, ref) => (
63 |   <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
64 | ))
65 | CardContent.displayName = "CardContent"
66 | 
67 | const CardFooter = React.forwardRef<
68 |   HTMLDivElement,
69 |   React.HTMLAttributes<HTMLDivElement>
70 | >(({ className, ...props }, ref) => (
71 |   <div
72 |     ref={ref}
73 |     className={cn("flex items-center p-6 pt-0", className)}
74 |     {...props}
75 |   />
76 | ))
77 | CardFooter.displayName = "CardFooter"
78 | 
79 | export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
```

src/components/ui/carousel.tsx
```
1 | import * as React from "react"
2 | import useEmblaCarousel, {
3 |   type UseEmblaCarouselType,
4 | } from "embla-carousel-react"
5 | import { ArrowLeft, ArrowRight } from "lucide-react"
6 | 
7 | import { cn } from "@/lib/utils"
8 | import { Button } from "@/components/ui/button"
9 | 
10 | type CarouselApi = UseEmblaCarouselType[1]
11 | type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
12 | type CarouselOptions = UseCarouselParameters[0]
13 | type CarouselPlugin = UseCarouselParameters[1]
14 | 
15 | type CarouselProps = {
16 |   opts?: CarouselOptions
17 |   plugins?: CarouselPlugin
18 |   orientation?: "horizontal" | "vertical"
19 |   setApi?: (api: CarouselApi) => void
20 | }
21 | 
22 | type CarouselContextProps = {
23 |   carouselRef: ReturnType<typeof useEmblaCarousel>[0]
24 |   api: ReturnType<typeof useEmblaCarousel>[1]
25 |   scrollPrev: () => void
26 |   scrollNext: () => void
27 |   canScrollPrev: boolean
28 |   canScrollNext: boolean
29 | } & CarouselProps
30 | 
31 | const CarouselContext = React.createContext<CarouselContextProps | null>(null)
32 | 
33 | function useCarousel() {
34 |   const context = React.useContext(CarouselContext)
35 | 
36 |   if (!context) {
37 |     throw new Error("useCarousel must be used within a <Carousel />")
38 |   }
39 | 
40 |   return context
41 | }
42 | 
43 | const Carousel = React.forwardRef<
44 |   HTMLDivElement,
45 |   React.HTMLAttributes<HTMLDivElement> & CarouselProps
46 | >(
47 |   (
48 |     {
49 |       orientation = "horizontal",
50 |       opts,
51 |       setApi,
52 |       plugins,
53 |       className,
54 |       children,
55 |       ...props
56 |     },
57 |     ref
58 |   ) => {
59 |     const [carouselRef, api] = useEmblaCarousel(
60 |       {
61 |         ...opts,
62 |         axis: orientation === "horizontal" ? "x" : "y",
63 |       },
64 |       plugins
65 |     )
66 |     const [canScrollPrev, setCanScrollPrev] = React.useState(false)
67 |     const [canScrollNext, setCanScrollNext] = React.useState(false)
68 | 
69 |     const onSelect = React.useCallback((api: CarouselApi) => {
70 |       if (!api) {
71 |         return
72 |       }
73 | 
74 |       setCanScrollPrev(api.canScrollPrev())
75 |       setCanScrollNext(api.canScrollNext())
76 |     }, [])
77 | 
78 |     const scrollPrev = React.useCallback(() => {
79 |       api?.scrollPrev()
80 |     }, [api])
81 | 
82 |     const scrollNext = React.useCallback(() => {
83 |       api?.scrollNext()
84 |     }, [api])
85 | 
86 |     const handleKeyDown = React.useCallback(
87 |       (event: React.KeyboardEvent<HTMLDivElement>) => {
88 |         if (event.key === "ArrowLeft") {
89 |           event.preventDefault()
90 |           scrollPrev()
91 |         } else if (event.key === "ArrowRight") {
92 |           event.preventDefault()
93 |           scrollNext()
94 |         }
95 |       },
96 |       [scrollPrev, scrollNext]
97 |     )
98 | 
99 |     React.useEffect(() => {
100 |       if (!api || !setApi) {
101 |         return
102 |       }
103 | 
104 |       setApi(api)
105 |     }, [api, setApi])
106 | 
107 |     React.useEffect(() => {
108 |       if (!api) {
109 |         return
110 |       }
111 | 
112 |       onSelect(api)
113 |       api.on("reInit", onSelect)
114 |       api.on("select", onSelect)
115 | 
116 |       return () => {
117 |         api?.off("select", onSelect)
118 |       }
119 |     }, [api, onSelect])
120 | 
121 |     return (
122 |       <CarouselContext.Provider
123 |         value={{
124 |           carouselRef,
125 |           api: api,
126 |           opts,
127 |           orientation:
128 |             orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
129 |           scrollPrev,
130 |           scrollNext,
131 |           canScrollPrev,
132 |           canScrollNext,
133 |         }}
134 |       >
135 |         <div
136 |           ref={ref}
137 |           onKeyDownCapture={handleKeyDown}
138 |           className={cn("relative", className)}
139 |           role="region"
140 |           aria-roledescription="carousel"
141 |           {...props}
142 |         >
143 |           {children}
144 |         </div>
145 |       </CarouselContext.Provider>
146 |     )
147 |   }
148 | )
149 | Carousel.displayName = "Carousel"
150 | 
151 | const CarouselContent = React.forwardRef<
152 |   HTMLDivElement,
153 |   React.HTMLAttributes<HTMLDivElement>
154 | >(({ className, ...props }, ref) => {
155 |   const { carouselRef, orientation } = useCarousel()
156 | 
157 |   return (
158 |     <div ref={carouselRef} className="overflow-hidden">
159 |       <div
160 |         ref={ref}
161 |         className={cn(
162 |           "flex",
163 |           orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
164 |           className
165 |         )}
166 |         {...props}
167 |       />
168 |     </div>
169 |   )
170 | })
171 | CarouselContent.displayName = "CarouselContent"
172 | 
173 | const CarouselItem = React.forwardRef<
174 |   HTMLDivElement,
175 |   React.HTMLAttributes<HTMLDivElement>
176 | >(({ className, ...props }, ref) => {
177 |   const { orientation } = useCarousel()
178 | 
179 |   return (
180 |     <div
181 |       ref={ref}
182 |       role="group"
183 |       aria-roledescription="slide"
184 |       className={cn(
185 |         "min-w-0 shrink-0 grow-0 basis-full",
186 |         orientation === "horizontal" ? "pl-4" : "pt-4",
187 |         className
188 |       )}
189 |       {...props}
190 |     />
191 |   )
192 | })
193 | CarouselItem.displayName = "CarouselItem"
194 | 
195 | const CarouselPrevious = React.forwardRef<
196 |   HTMLButtonElement,
197 |   React.ComponentProps<typeof Button>
198 | >(({ className, variant = "outline", size = "icon", ...props }, ref) => {
199 |   const { orientation, scrollPrev, canScrollPrev } = useCarousel()
200 | 
201 |   return (
202 |     <Button
203 |       ref={ref}
204 |       variant={variant}
205 |       size={size}
206 |       className={cn(
207 |         "absolute  h-8 w-8 rounded-full",
208 |         orientation === "horizontal"
209 |           ? "-left-12 top-1/2 -translate-y-1/2"
210 |           : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
211 |         className
212 |       )}
213 |       disabled={!canScrollPrev}
214 |       onClick={scrollPrev}
215 |       {...props}
216 |     >
217 |       <ArrowLeft className="h-4 w-4" />
218 |       <span className="sr-only">Previous slide</span>
219 |     </Button>
220 |   )
221 | })
222 | CarouselPrevious.displayName = "CarouselPrevious"
223 | 
224 | const CarouselNext = React.forwardRef<
225 |   HTMLButtonElement,
226 |   React.ComponentProps<typeof Button>
227 | >(({ className, variant = "outline", size = "icon", ...props }, ref) => {
228 |   const { orientation, scrollNext, canScrollNext } = useCarousel()
229 | 
230 |   return (
231 |     <Button
232 |       ref={ref}
233 |       variant={variant}
234 |       size={size}
235 |       className={cn(
236 |         "absolute h-8 w-8 rounded-full",
237 |         orientation === "horizontal"
238 |           ? "-right-12 top-1/2 -translate-y-1/2"
239 |           : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
240 |         className
241 |       )}
242 |       disabled={!canScrollNext}
243 |       onClick={scrollNext}
244 |       {...props}
245 |     >
246 |       <ArrowRight className="h-4 w-4" />
247 |       <span className="sr-only">Next slide</span>
248 |     </Button>
249 |   )
250 | })
251 | CarouselNext.displayName = "CarouselNext"
252 | 
253 | export {
254 |   type CarouselApi,
255 |   Carousel,
256 |   CarouselContent,
257 |   CarouselItem,
258 |   CarouselPrevious,
259 |   CarouselNext,
260 | }
```

src/components/ui/chart.tsx
```
1 | import * as React from "react"
2 | import * as RechartsPrimitive from "recharts"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | // Format: { THEME_NAME: CSS_SELECTOR }
7 | const THEMES = { light: "", dark: ".dark" } as const
8 | 
9 | export type ChartConfig = {
10 |   [k in string]: {
11 |     label?: React.ReactNode
12 |     icon?: React.ComponentType
13 |   } & (
14 |     | { color?: string; theme?: never }
15 |     | { color?: never; theme: Record<keyof typeof THEMES, string> }
16 |   )
17 | }
18 | 
19 | type ChartContextProps = {
20 |   config: ChartConfig
21 | }
22 | 
23 | const ChartContext = React.createContext<ChartContextProps | null>(null)
24 | 
25 | function useChart() {
26 |   const context = React.useContext(ChartContext)
27 | 
28 |   if (!context) {
29 |     throw new Error("useChart must be used within a <ChartContainer />")
30 |   }
31 | 
32 |   return context
33 | }
34 | 
35 | const ChartContainer = React.forwardRef<
36 |   HTMLDivElement,
37 |   React.ComponentProps<"div"> & {
38 |     config: ChartConfig
39 |     children: React.ComponentProps<
40 |       typeof RechartsPrimitive.ResponsiveContainer
41 |     >["children"]
42 |   }
43 | >(({ id, className, children, config, ...props }, ref) => {
44 |   const uniqueId = React.useId()
45 |   const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`
46 | 
47 |   return (
48 |     <ChartContext.Provider value={{ config }}>
49 |       <div
50 |         data-chart={chartId}
51 |         ref={ref}
52 |         className={cn(
53 |           "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
54 |           className
55 |         )}
56 |         {...props}
57 |       >
58 |         <ChartStyle id={chartId} config={config} />
59 |         <RechartsPrimitive.ResponsiveContainer>
60 |           {children}
61 |         </RechartsPrimitive.ResponsiveContainer>
62 |       </div>
63 |     </ChartContext.Provider>
64 |   )
65 | })
66 | ChartContainer.displayName = "Chart"
67 | 
68 | const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
69 |   const colorConfig = Object.entries(config).filter(
70 |     ([_, config]) => config.theme || config.color
71 |   )
72 | 
73 |   if (!colorConfig.length) {
74 |     return null
75 |   }
76 | 
77 |   return (
78 |     <style
79 |       dangerouslySetInnerHTML={{
80 |         __html: Object.entries(THEMES)
81 |           .map(
82 |             ([theme, prefix]) => `
83 | ${prefix} [data-chart=${id}] {
84 | ${colorConfig
85 |   .map(([key, itemConfig]) => {
86 |     const color =
87 |       itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
88 |       itemConfig.color
89 |     return color ? `  --color-${key}: ${color};` : null
90 |   })
91 |   .join("\n")}
92 | }
93 | `
94 |           )
95 |           .join("\n"),
96 |       }}
97 |     />
98 |   )
99 | }
100 | 
101 | const ChartTooltip = RechartsPrimitive.Tooltip
102 | 
103 | const ChartTooltipContent = React.forwardRef<
104 |   HTMLDivElement,
105 |   React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
106 |     React.ComponentProps<"div"> & {
107 |       hideLabel?: boolean
108 |       hideIndicator?: boolean
109 |       indicator?: "line" | "dot" | "dashed"
110 |       nameKey?: string
111 |       labelKey?: string
112 |     }
113 | >(
114 |   (
115 |     {
116 |       active,
117 |       payload,
118 |       className,
119 |       indicator = "dot",
120 |       hideLabel = false,
121 |       hideIndicator = false,
122 |       label,
123 |       labelFormatter,
124 |       labelClassName,
125 |       formatter,
126 |       color,
127 |       nameKey,
128 |       labelKey,
129 |     },
130 |     ref
131 |   ) => {
132 |     const { config } = useChart()
133 | 
134 |     const tooltipLabel = React.useMemo(() => {
135 |       if (hideLabel || !payload?.length) {
136 |         return null
137 |       }
138 | 
139 |       const [item] = payload
140 |       const key = `${labelKey || item.dataKey || item.name || "value"}`
141 |       const itemConfig = getPayloadConfigFromPayload(config, item, key)
142 |       const value =
143 |         !labelKey && typeof label === "string"
144 |           ? config[label as keyof typeof config]?.label || label
145 |           : itemConfig?.label
146 | 
147 |       if (labelFormatter) {
148 |         return (
149 |           <div className={cn("font-medium", labelClassName)}>
150 |             {labelFormatter(value, payload)}
151 |           </div>
152 |         )
153 |       }
154 | 
155 |       if (!value) {
156 |         return null
157 |       }
158 | 
159 |       return <div className={cn("font-medium", labelClassName)}>{value}</div>
160 |     }, [
161 |       label,
162 |       labelFormatter,
163 |       payload,
164 |       hideLabel,
165 |       labelClassName,
166 |       config,
167 |       labelKey,
168 |     ])
169 | 
170 |     if (!active || !payload?.length) {
171 |       return null
172 |     }
173 | 
174 |     const nestLabel = payload.length === 1 && indicator !== "dot"
175 | 
176 |     return (
177 |       <div
178 |         ref={ref}
179 |         className={cn(
180 |           "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
181 |           className
182 |         )}
183 |       >
184 |         {!nestLabel ? tooltipLabel : null}
185 |         <div className="grid gap-1.5">
186 |           {payload.map((item, index) => {
187 |             const key = `${nameKey || item.name || item.dataKey || "value"}`
188 |             const itemConfig = getPayloadConfigFromPayload(config, item, key)
189 |             const indicatorColor = color || item.payload.fill || item.color
190 | 
191 |             return (
192 |               <div
193 |                 key={item.dataKey}
194 |                 className={cn(
195 |                   "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
196 |                   indicator === "dot" && "items-center"
197 |                 )}
198 |               >
199 |                 {formatter && item?.value !== undefined && item.name ? (
200 |                   formatter(item.value, item.name, item, index, item.payload)
201 |                 ) : (
202 |                   <>
203 |                     {itemConfig?.icon ? (
204 |                       <itemConfig.icon />
205 |                     ) : (
206 |                       !hideIndicator && (
207 |                         <div
208 |                           className={cn(
209 |                             "shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",
210 |                             {
211 |                               "h-2.5 w-2.5": indicator === "dot",
212 |                               "w-1": indicator === "line",
213 |                               "w-0 border-[1.5px] border-dashed bg-transparent":
214 |                                 indicator === "dashed",
215 |                               "my-0.5": nestLabel && indicator === "dashed",
216 |                             }
217 |                           )}
218 |                           style={
219 |                             {
220 |                               "--color-bg": indicatorColor,
221 |                               "--color-border": indicatorColor,
222 |                             } as React.CSSProperties
223 |                           }
224 |                         />
225 |                       )
226 |                     )}
227 |                     <div
228 |                       className={cn(
229 |                         "flex flex-1 justify-between leading-none",
230 |                         nestLabel ? "items-end" : "items-center"
231 |                       )}
232 |                     >
233 |                       <div className="grid gap-1.5">
234 |                         {nestLabel ? tooltipLabel : null}
235 |                         <span className="text-muted-foreground">
236 |                           {itemConfig?.label || item.name}
237 |                         </span>
238 |                       </div>
239 |                       {item.value && (
240 |                         <span className="font-mono font-medium tabular-nums text-foreground">
241 |                           {item.value.toLocaleString()}
242 |                         </span>
243 |                       )}
244 |                     </div>
245 |                   </>
246 |                 )}
247 |               </div>
248 |             )
249 |           })}
250 |         </div>
251 |       </div>
252 |     )
253 |   }
254 | )
255 | ChartTooltipContent.displayName = "ChartTooltip"
256 | 
257 | const ChartLegend = RechartsPrimitive.Legend
258 | 
259 | const ChartLegendContent = React.forwardRef<
260 |   HTMLDivElement,
261 |   React.ComponentProps<"div"> &
262 |     Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
263 |       hideIcon?: boolean
264 |       nameKey?: string
265 |     }
266 | >(
267 |   (
268 |     { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
269 |     ref
270 |   ) => {
271 |     const { config } = useChart()
272 | 
273 |     if (!payload?.length) {
274 |       return null
275 |     }
276 | 
277 |     return (
278 |       <div
279 |         ref={ref}
280 |         className={cn(
281 |           "flex items-center justify-center gap-4",
282 |           verticalAlign === "top" ? "pb-3" : "pt-3",
283 |           className
284 |         )}
285 |       >
286 |         {payload.map((item) => {
287 |           const key = `${nameKey || item.dataKey || "value"}`
288 |           const itemConfig = getPayloadConfigFromPayload(config, item, key)
289 | 
290 |           return (
291 |             <div
292 |               key={item.value}
293 |               className={cn(
294 |                 "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
295 |               )}
296 |             >
297 |               {itemConfig?.icon && !hideIcon ? (
298 |                 <itemConfig.icon />
299 |               ) : (
300 |                 <div
301 |                   className="h-2 w-2 shrink-0 rounded-[2px]"
302 |                   style={{
303 |                     backgroundColor: item.color,
304 |                   }}
305 |                 />
306 |               )}
307 |               {itemConfig?.label}
308 |             </div>
309 |           )
310 |         })}
311 |       </div>
312 |     )
313 |   }
314 | )
315 | ChartLegendContent.displayName = "ChartLegend"
316 | 
317 | // Helper to extract item config from a payload.
318 | function getPayloadConfigFromPayload(
319 |   config: ChartConfig,
320 |   payload: unknown,
321 |   key: string
322 | ) {
323 |   if (typeof payload !== "object" || payload === null) {
324 |     return undefined
325 |   }
326 | 
327 |   const payloadPayload =
328 |     "payload" in payload &&
329 |     typeof payload.payload === "object" &&
330 |     payload.payload !== null
331 |       ? payload.payload
332 |       : undefined
333 | 
334 |   let configLabelKey: string = key
335 | 
336 |   if (
337 |     key in payload &&
338 |     typeof payload[key as keyof typeof payload] === "string"
339 |   ) {
340 |     configLabelKey = payload[key as keyof typeof payload] as string
341 |   } else if (
342 |     payloadPayload &&
343 |     key in payloadPayload &&
344 |     typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
345 |   ) {
346 |     configLabelKey = payloadPayload[
347 |       key as keyof typeof payloadPayload
348 |     ] as string
349 |   }
350 | 
351 |   return configLabelKey in config
352 |     ? config[configLabelKey]
353 |     : config[key as keyof typeof config]
354 | }
355 | 
356 | export {
357 |   ChartContainer,
358 |   ChartTooltip,
359 |   ChartTooltipContent,
360 |   ChartLegend,
361 |   ChartLegendContent,
362 |   ChartStyle,
363 | }
```

src/components/ui/checkbox.tsx
```
1 | import * as React from "react"
2 | import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
3 | import { Check } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const Checkbox = React.forwardRef<
8 |   React.ElementRef<typeof CheckboxPrimitive.Root>,
9 |   React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
10 | >(({ className, ...props }, ref) => (
11 |   <CheckboxPrimitive.Root
12 |     ref={ref}
13 |     className={cn(
14 |       "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
15 |       className
16 |     )}
17 |     {...props}
18 |   >
19 |     <CheckboxPrimitive.Indicator
20 |       className={cn("flex items-center justify-center text-current")}
21 |     >
22 |       <Check className="h-4 w-4" />
23 |     </CheckboxPrimitive.Indicator>
24 |   </CheckboxPrimitive.Root>
25 | ))
26 | Checkbox.displayName = CheckboxPrimitive.Root.displayName
27 | 
28 | export { Checkbox }
```

src/components/ui/collapsible.tsx
```
1 | import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"
2 | 
3 | const Collapsible = CollapsiblePrimitive.Root
4 | 
5 | const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger
6 | 
7 | const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent
8 | 
9 | export { Collapsible, CollapsibleTrigger, CollapsibleContent }
```

src/components/ui/command.tsx
```
1 | import * as React from "react"
2 | import { type DialogProps } from "@radix-ui/react-dialog"
3 | import { Command as CommandPrimitive } from "cmdk"
4 | import { Search } from "lucide-react"
5 | 
6 | import { cn } from "@/lib/utils"
7 | import { Dialog, DialogContent } from "@/components/ui/dialog"
8 | 
9 | const Command = React.forwardRef<
10 |   React.ElementRef<typeof CommandPrimitive>,
11 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive>
12 | >(({ className, ...props }, ref) => (
13 |   <CommandPrimitive
14 |     ref={ref}
15 |     className={cn(
16 |       "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
17 |       className
18 |     )}
19 |     {...props}
20 |   />
21 | ))
22 | Command.displayName = CommandPrimitive.displayName
23 | 
24 | interface CommandDialogProps extends DialogProps {}
25 | 
26 | const CommandDialog = ({ children, ...props }: CommandDialogProps) => {
27 |   return (
28 |     <Dialog {...props}>
29 |       <DialogContent className="overflow-hidden p-0 shadow-lg">
30 |         <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
31 |           {children}
32 |         </Command>
33 |       </DialogContent>
34 |     </Dialog>
35 |   )
36 | }
37 | 
38 | const CommandInput = React.forwardRef<
39 |   React.ElementRef<typeof CommandPrimitive.Input>,
40 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
41 | >(({ className, ...props }, ref) => (
42 |   <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
43 |     <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
44 |     <CommandPrimitive.Input
45 |       ref={ref}
46 |       className={cn(
47 |         "flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
48 |         className
49 |       )}
50 |       {...props}
51 |     />
52 |   </div>
53 | ))
54 | 
55 | CommandInput.displayName = CommandPrimitive.Input.displayName
56 | 
57 | const CommandList = React.forwardRef<
58 |   React.ElementRef<typeof CommandPrimitive.List>,
59 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
60 | >(({ className, ...props }, ref) => (
61 |   <CommandPrimitive.List
62 |     ref={ref}
63 |     className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
64 |     {...props}
65 |   />
66 | ))
67 | 
68 | CommandList.displayName = CommandPrimitive.List.displayName
69 | 
70 | const CommandEmpty = React.forwardRef<
71 |   React.ElementRef<typeof CommandPrimitive.Empty>,
72 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
73 | >((props, ref) => (
74 |   <CommandPrimitive.Empty
75 |     ref={ref}
76 |     className="py-6 text-center text-sm"
77 |     {...props}
78 |   />
79 | ))
80 | 
81 | CommandEmpty.displayName = CommandPrimitive.Empty.displayName
82 | 
83 | const CommandGroup = React.forwardRef<
84 |   React.ElementRef<typeof CommandPrimitive.Group>,
85 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
86 | >(({ className, ...props }, ref) => (
87 |   <CommandPrimitive.Group
88 |     ref={ref}
89 |     className={cn(
90 |       "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
91 |       className
92 |     )}
93 |     {...props}
94 |   />
95 | ))
96 | 
97 | CommandGroup.displayName = CommandPrimitive.Group.displayName
98 | 
99 | const CommandSeparator = React.forwardRef<
100 |   React.ElementRef<typeof CommandPrimitive.Separator>,
101 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
102 | >(({ className, ...props }, ref) => (
103 |   <CommandPrimitive.Separator
104 |     ref={ref}
105 |     className={cn("-mx-1 h-px bg-border", className)}
106 |     {...props}
107 |   />
108 | ))
109 | CommandSeparator.displayName = CommandPrimitive.Separator.displayName
110 | 
111 | const CommandItem = React.forwardRef<
112 |   React.ElementRef<typeof CommandPrimitive.Item>,
113 |   React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
114 | >(({ className, ...props }, ref) => (
115 |   <CommandPrimitive.Item
116 |     ref={ref}
117 |     className={cn(
118 |       "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",
119 |       className
120 |     )}
121 |     {...props}
122 |   />
123 | ))
124 | 
125 | CommandItem.displayName = CommandPrimitive.Item.displayName
126 | 
127 | const CommandShortcut = ({
128 |   className,
129 |   ...props
130 | }: React.HTMLAttributes<HTMLSpanElement>) => {
131 |   return (
132 |     <span
133 |       className={cn(
134 |         "ml-auto text-xs tracking-widest text-muted-foreground",
135 |         className
136 |       )}
137 |       {...props}
138 |     />
139 |   )
140 | }
141 | CommandShortcut.displayName = "CommandShortcut"
142 | 
143 | export {
144 |   Command,
145 |   CommandDialog,
146 |   CommandInput,
147 |   CommandList,
148 |   CommandEmpty,
149 |   CommandGroup,
150 |   CommandItem,
151 |   CommandShortcut,
152 |   CommandSeparator,
153 | }
```

src/components/ui/context-menu.tsx
```
1 | import * as React from "react"
2 | import * as ContextMenuPrimitive from "@radix-ui/react-context-menu"
3 | import { Check, ChevronRight, Circle } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const ContextMenu = ContextMenuPrimitive.Root
8 | 
9 | const ContextMenuTrigger = ContextMenuPrimitive.Trigger
10 | 
11 | const ContextMenuGroup = ContextMenuPrimitive.Group
12 | 
13 | const ContextMenuPortal = ContextMenuPrimitive.Portal
14 | 
15 | const ContextMenuSub = ContextMenuPrimitive.Sub
16 | 
17 | const ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup
18 | 
19 | const ContextMenuSubTrigger = React.forwardRef<
20 |   React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,
21 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {
22 |     inset?: boolean
23 |   }
24 | >(({ className, inset, children, ...props }, ref) => (
25 |   <ContextMenuPrimitive.SubTrigger
26 |     ref={ref}
27 |     className={cn(
28 |       "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
29 |       inset && "pl-8",
30 |       className
31 |     )}
32 |     {...props}
33 |   >
34 |     {children}
35 |     <ChevronRight className="ml-auto h-4 w-4" />
36 |   </ContextMenuPrimitive.SubTrigger>
37 | ))
38 | ContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName
39 | 
40 | const ContextMenuSubContent = React.forwardRef<
41 |   React.ElementRef<typeof ContextMenuPrimitive.SubContent>,
42 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>
43 | >(({ className, ...props }, ref) => (
44 |   <ContextMenuPrimitive.SubContent
45 |     ref={ref}
46 |     className={cn(
47 |       "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
48 |       className
49 |     )}
50 |     {...props}
51 |   />
52 | ))
53 | ContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName
54 | 
55 | const ContextMenuContent = React.forwardRef<
56 |   React.ElementRef<typeof ContextMenuPrimitive.Content>,
57 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>
58 | >(({ className, ...props }, ref) => (
59 |   <ContextMenuPrimitive.Portal>
60 |     <ContextMenuPrimitive.Content
61 |       ref={ref}
62 |       className={cn(
63 |         "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
64 |         className
65 |       )}
66 |       {...props}
67 |     />
68 |   </ContextMenuPrimitive.Portal>
69 | ))
70 | ContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName
71 | 
72 | const ContextMenuItem = React.forwardRef<
73 |   React.ElementRef<typeof ContextMenuPrimitive.Item>,
74 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {
75 |     inset?: boolean
76 |   }
77 | >(({ className, inset, ...props }, ref) => (
78 |   <ContextMenuPrimitive.Item
79 |     ref={ref}
80 |     className={cn(
81 |       "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
82 |       inset && "pl-8",
83 |       className
84 |     )}
85 |     {...props}
86 |   />
87 | ))
88 | ContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName
89 | 
90 | const ContextMenuCheckboxItem = React.forwardRef<
91 |   React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,
92 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>
93 | >(({ className, children, checked, ...props }, ref) => (
94 |   <ContextMenuPrimitive.CheckboxItem
95 |     ref={ref}
96 |     className={cn(
97 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
98 |       className
99 |     )}
100 |     checked={checked}
101 |     {...props}
102 |   >
103 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
104 |       <ContextMenuPrimitive.ItemIndicator>
105 |         <Check className="h-4 w-4" />
106 |       </ContextMenuPrimitive.ItemIndicator>
107 |     </span>
108 |     {children}
109 |   </ContextMenuPrimitive.CheckboxItem>
110 | ))
111 | ContextMenuCheckboxItem.displayName =
112 |   ContextMenuPrimitive.CheckboxItem.displayName
113 | 
114 | const ContextMenuRadioItem = React.forwardRef<
115 |   React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,
116 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>
117 | >(({ className, children, ...props }, ref) => (
118 |   <ContextMenuPrimitive.RadioItem
119 |     ref={ref}
120 |     className={cn(
121 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
122 |       className
123 |     )}
124 |     {...props}
125 |   >
126 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
127 |       <ContextMenuPrimitive.ItemIndicator>
128 |         <Circle className="h-2 w-2 fill-current" />
129 |       </ContextMenuPrimitive.ItemIndicator>
130 |     </span>
131 |     {children}
132 |   </ContextMenuPrimitive.RadioItem>
133 | ))
134 | ContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName
135 | 
136 | const ContextMenuLabel = React.forwardRef<
137 |   React.ElementRef<typeof ContextMenuPrimitive.Label>,
138 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {
139 |     inset?: boolean
140 |   }
141 | >(({ className, inset, ...props }, ref) => (
142 |   <ContextMenuPrimitive.Label
143 |     ref={ref}
144 |     className={cn(
145 |       "px-2 py-1.5 text-sm font-semibold text-foreground",
146 |       inset && "pl-8",
147 |       className
148 |     )}
149 |     {...props}
150 |   />
151 | ))
152 | ContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName
153 | 
154 | const ContextMenuSeparator = React.forwardRef<
155 |   React.ElementRef<typeof ContextMenuPrimitive.Separator>,
156 |   React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>
157 | >(({ className, ...props }, ref) => (
158 |   <ContextMenuPrimitive.Separator
159 |     ref={ref}
160 |     className={cn("-mx-1 my-1 h-px bg-border", className)}
161 |     {...props}
162 |   />
163 | ))
164 | ContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName
165 | 
166 | const ContextMenuShortcut = ({
167 |   className,
168 |   ...props
169 | }: React.HTMLAttributes<HTMLSpanElement>) => {
170 |   return (
171 |     <span
172 |       className={cn(
173 |         "ml-auto text-xs tracking-widest text-muted-foreground",
174 |         className
175 |       )}
176 |       {...props}
177 |     />
178 |   )
179 | }
180 | ContextMenuShortcut.displayName = "ContextMenuShortcut"
181 | 
182 | export {
183 |   ContextMenu,
184 |   ContextMenuTrigger,
185 |   ContextMenuContent,
186 |   ContextMenuItem,
187 |   ContextMenuCheckboxItem,
188 |   ContextMenuRadioItem,
189 |   ContextMenuLabel,
190 |   ContextMenuSeparator,
191 |   ContextMenuShortcut,
192 |   ContextMenuGroup,
193 |   ContextMenuPortal,
194 |   ContextMenuSub,
195 |   ContextMenuSubContent,
196 |   ContextMenuSubTrigger,
197 |   ContextMenuRadioGroup,
198 | }
```

src/components/ui/dialog.tsx
```
1 | import * as React from "react"
2 | import * as DialogPrimitive from "@radix-ui/react-dialog"
3 | import { X } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const Dialog = DialogPrimitive.Root
8 | 
9 | const DialogTrigger = DialogPrimitive.Trigger
10 | 
11 | const DialogPortal = DialogPrimitive.Portal
12 | 
13 | const DialogClose = DialogPrimitive.Close
14 | 
15 | const DialogOverlay = React.forwardRef<
16 |   React.ElementRef<typeof DialogPrimitive.Overlay>,
17 |   React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
18 | >(({ className, ...props }, ref) => (
19 |   <DialogPrimitive.Overlay
20 |     ref={ref}
21 |     className={cn(
22 |       "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
23 |       className
24 |     )}
25 |     {...props}
26 |   />
27 | ))
28 | DialogOverlay.displayName = DialogPrimitive.Overlay.displayName
29 | 
30 | const DialogContent = React.forwardRef<
31 |   React.ElementRef<typeof DialogPrimitive.Content>,
32 |   React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
33 | >(({ className, children, ...props }, ref) => (
34 |   <DialogPortal>
35 |     <DialogOverlay />
36 |     <DialogPrimitive.Content
37 |       ref={ref}
38 |       className={cn(
39 |         "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
40 |         className
41 |       )}
42 |       {...props}
43 |     >
44 |       {children}
45 |       <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
46 |         <X className="h-4 w-4" />
47 |         <span className="sr-only">Close</span>
48 |       </DialogPrimitive.Close>
49 |     </DialogPrimitive.Content>
50 |   </DialogPortal>
51 | ))
52 | DialogContent.displayName = DialogPrimitive.Content.displayName
53 | 
54 | const DialogHeader = ({
55 |   className,
56 |   ...props
57 | }: React.HTMLAttributes<HTMLDivElement>) => (
58 |   <div
59 |     className={cn(
60 |       "flex flex-col space-y-1.5 text-center sm:text-left",
61 |       className
62 |     )}
63 |     {...props}
64 |   />
65 | )
66 | DialogHeader.displayName = "DialogHeader"
67 | 
68 | const DialogFooter = ({
69 |   className,
70 |   ...props
71 | }: React.HTMLAttributes<HTMLDivElement>) => (
72 |   <div
73 |     className={cn(
74 |       "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
75 |       className
76 |     )}
77 |     {...props}
78 |   />
79 | )
80 | DialogFooter.displayName = "DialogFooter"
81 | 
82 | const DialogTitle = React.forwardRef<
83 |   React.ElementRef<typeof DialogPrimitive.Title>,
84 |   React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
85 | >(({ className, ...props }, ref) => (
86 |   <DialogPrimitive.Title
87 |     ref={ref}
88 |     className={cn(
89 |       "text-lg font-semibold leading-none tracking-tight",
90 |       className
91 |     )}
92 |     {...props}
93 |   />
94 | ))
95 | DialogTitle.displayName = DialogPrimitive.Title.displayName
96 | 
97 | const DialogDescription = React.forwardRef<
98 |   React.ElementRef<typeof DialogPrimitive.Description>,
99 |   React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
100 | >(({ className, ...props }, ref) => (
101 |   <DialogPrimitive.Description
102 |     ref={ref}
103 |     className={cn("text-sm text-muted-foreground", className)}
104 |     {...props}
105 |   />
106 | ))
107 | DialogDescription.displayName = DialogPrimitive.Description.displayName
108 | 
109 | export {
110 |   Dialog,
111 |   DialogPortal,
112 |   DialogOverlay,
113 |   DialogClose,
114 |   DialogTrigger,
115 |   DialogContent,
116 |   DialogHeader,
117 |   DialogFooter,
118 |   DialogTitle,
119 |   DialogDescription,
120 | }
```

src/components/ui/drawer.tsx
```
1 | import * as React from "react"
2 | import { Drawer as DrawerPrimitive } from "vaul"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Drawer = ({
7 |   shouldScaleBackground = true,
8 |   ...props
9 | }: React.ComponentProps<typeof DrawerPrimitive.Root>) => (
10 |   <DrawerPrimitive.Root
11 |     shouldScaleBackground={shouldScaleBackground}
12 |     {...props}
13 |   />
14 | )
15 | Drawer.displayName = "Drawer"
16 | 
17 | const DrawerTrigger = DrawerPrimitive.Trigger
18 | 
19 | const DrawerPortal = DrawerPrimitive.Portal
20 | 
21 | const DrawerClose = DrawerPrimitive.Close
22 | 
23 | const DrawerOverlay = React.forwardRef<
24 |   React.ElementRef<typeof DrawerPrimitive.Overlay>,
25 |   React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>
26 | >(({ className, ...props }, ref) => (
27 |   <DrawerPrimitive.Overlay
28 |     ref={ref}
29 |     className={cn("fixed inset-0 z-50 bg-black/80", className)}
30 |     {...props}
31 |   />
32 | ))
33 | DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName
34 | 
35 | const DrawerContent = React.forwardRef<
36 |   React.ElementRef<typeof DrawerPrimitive.Content>,
37 |   React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>
38 | >(({ className, children, ...props }, ref) => (
39 |   <DrawerPortal>
40 |     <DrawerOverlay />
41 |     <DrawerPrimitive.Content
42 |       ref={ref}
43 |       className={cn(
44 |         "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
45 |         className
46 |       )}
47 |       {...props}
48 |     >
49 |       <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
50 |       {children}
51 |     </DrawerPrimitive.Content>
52 |   </DrawerPortal>
53 | ))
54 | DrawerContent.displayName = "DrawerContent"
55 | 
56 | const DrawerHeader = ({
57 |   className,
58 |   ...props
59 | }: React.HTMLAttributes<HTMLDivElement>) => (
60 |   <div
61 |     className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)}
62 |     {...props}
63 |   />
64 | )
65 | DrawerHeader.displayName = "DrawerHeader"
66 | 
67 | const DrawerFooter = ({
68 |   className,
69 |   ...props
70 | }: React.HTMLAttributes<HTMLDivElement>) => (
71 |   <div
72 |     className={cn("mt-auto flex flex-col gap-2 p-4", className)}
73 |     {...props}
74 |   />
75 | )
76 | DrawerFooter.displayName = "DrawerFooter"
77 | 
78 | const DrawerTitle = React.forwardRef<
79 |   React.ElementRef<typeof DrawerPrimitive.Title>,
80 |   React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>
81 | >(({ className, ...props }, ref) => (
82 |   <DrawerPrimitive.Title
83 |     ref={ref}
84 |     className={cn(
85 |       "text-lg font-semibold leading-none tracking-tight",
86 |       className
87 |     )}
88 |     {...props}
89 |   />
90 | ))
91 | DrawerTitle.displayName = DrawerPrimitive.Title.displayName
92 | 
93 | const DrawerDescription = React.forwardRef<
94 |   React.ElementRef<typeof DrawerPrimitive.Description>,
95 |   React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>
96 | >(({ className, ...props }, ref) => (
97 |   <DrawerPrimitive.Description
98 |     ref={ref}
99 |     className={cn("text-sm text-muted-foreground", className)}
100 |     {...props}
101 |   />
102 | ))
103 | DrawerDescription.displayName = DrawerPrimitive.Description.displayName
104 | 
105 | export {
106 |   Drawer,
107 |   DrawerPortal,
108 |   DrawerOverlay,
109 |   DrawerTrigger,
110 |   DrawerClose,
111 |   DrawerContent,
112 |   DrawerHeader,
113 |   DrawerFooter,
114 |   DrawerTitle,
115 |   DrawerDescription,
116 | }
```

src/components/ui/dropdown-menu.tsx
```
1 | import * as React from "react"
2 | import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
3 | import { Check, ChevronRight, Circle } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const DropdownMenu = DropdownMenuPrimitive.Root
8 | 
9 | const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger
10 | 
11 | const DropdownMenuGroup = DropdownMenuPrimitive.Group
12 | 
13 | const DropdownMenuPortal = DropdownMenuPrimitive.Portal
14 | 
15 | const DropdownMenuSub = DropdownMenuPrimitive.Sub
16 | 
17 | const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup
18 | 
19 | const DropdownMenuSubTrigger = React.forwardRef<
20 |   React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
21 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
22 |     inset?: boolean
23 |   }
24 | >(({ className, inset, children, ...props }, ref) => (
25 |   <DropdownMenuPrimitive.SubTrigger
26 |     ref={ref}
27 |     className={cn(
28 |       "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",
29 |       inset && "pl-8",
30 |       className
31 |     )}
32 |     {...props}
33 |   >
34 |     {children}
35 |     <ChevronRight className="ml-auto h-4 w-4" />
36 |   </DropdownMenuPrimitive.SubTrigger>
37 | ))
38 | DropdownMenuSubTrigger.displayName =
39 |   DropdownMenuPrimitive.SubTrigger.displayName
40 | 
41 | const DropdownMenuSubContent = React.forwardRef<
42 |   React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
43 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
44 | >(({ className, ...props }, ref) => (
45 |   <DropdownMenuPrimitive.SubContent
46 |     ref={ref}
47 |     className={cn(
48 |       "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
49 |       className
50 |     )}
51 |     {...props}
52 |   />
53 | ))
54 | DropdownMenuSubContent.displayName =
55 |   DropdownMenuPrimitive.SubContent.displayName
56 | 
57 | const DropdownMenuContent = React.forwardRef<
58 |   React.ElementRef<typeof DropdownMenuPrimitive.Content>,
59 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
60 | >(({ className, sideOffset = 4, ...props }, ref) => (
61 |   <DropdownMenuPrimitive.Portal>
62 |     <DropdownMenuPrimitive.Content
63 |       ref={ref}
64 |       sideOffset={sideOffset}
65 |       className={cn(
66 |         "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
67 |         className
68 |       )}
69 |       {...props}
70 |     />
71 |   </DropdownMenuPrimitive.Portal>
72 | ))
73 | DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName
74 | 
75 | const DropdownMenuItem = React.forwardRef<
76 |   React.ElementRef<typeof DropdownMenuPrimitive.Item>,
77 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
78 |     inset?: boolean
79 |   }
80 | >(({ className, inset, ...props }, ref) => (
81 |   <DropdownMenuPrimitive.Item
82 |     ref={ref}
83 |     className={cn(
84 |       "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
85 |       inset && "pl-8",
86 |       className
87 |     )}
88 |     {...props}
89 |   />
90 | ))
91 | DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName
92 | 
93 | const DropdownMenuCheckboxItem = React.forwardRef<
94 |   React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
95 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
96 | >(({ className, children, checked, ...props }, ref) => (
97 |   <DropdownMenuPrimitive.CheckboxItem
98 |     ref={ref}
99 |     className={cn(
100 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
101 |       className
102 |     )}
103 |     checked={checked}
104 |     {...props}
105 |   >
106 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
107 |       <DropdownMenuPrimitive.ItemIndicator>
108 |         <Check className="h-4 w-4" />
109 |       </DropdownMenuPrimitive.ItemIndicator>
110 |     </span>
111 |     {children}
112 |   </DropdownMenuPrimitive.CheckboxItem>
113 | ))
114 | DropdownMenuCheckboxItem.displayName =
115 |   DropdownMenuPrimitive.CheckboxItem.displayName
116 | 
117 | const DropdownMenuRadioItem = React.forwardRef<
118 |   React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
119 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
120 | >(({ className, children, ...props }, ref) => (
121 |   <DropdownMenuPrimitive.RadioItem
122 |     ref={ref}
123 |     className={cn(
124 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
125 |       className
126 |     )}
127 |     {...props}
128 |   >
129 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
130 |       <DropdownMenuPrimitive.ItemIndicator>
131 |         <Circle className="h-2 w-2 fill-current" />
132 |       </DropdownMenuPrimitive.ItemIndicator>
133 |     </span>
134 |     {children}
135 |   </DropdownMenuPrimitive.RadioItem>
136 | ))
137 | DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName
138 | 
139 | const DropdownMenuLabel = React.forwardRef<
140 |   React.ElementRef<typeof DropdownMenuPrimitive.Label>,
141 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
142 |     inset?: boolean
143 |   }
144 | >(({ className, inset, ...props }, ref) => (
145 |   <DropdownMenuPrimitive.Label
146 |     ref={ref}
147 |     className={cn(
148 |       "px-2 py-1.5 text-sm font-semibold",
149 |       inset && "pl-8",
150 |       className
151 |     )}
152 |     {...props}
153 |   />
154 | ))
155 | DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName
156 | 
157 | const DropdownMenuSeparator = React.forwardRef<
158 |   React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
159 |   React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
160 | >(({ className, ...props }, ref) => (
161 |   <DropdownMenuPrimitive.Separator
162 |     ref={ref}
163 |     className={cn("-mx-1 my-1 h-px bg-muted", className)}
164 |     {...props}
165 |   />
166 | ))
167 | DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName
168 | 
169 | const DropdownMenuShortcut = ({
170 |   className,
171 |   ...props
172 | }: React.HTMLAttributes<HTMLSpanElement>) => {
173 |   return (
174 |     <span
175 |       className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
176 |       {...props}
177 |     />
178 |   )
179 | }
180 | DropdownMenuShortcut.displayName = "DropdownMenuShortcut"
181 | 
182 | export {
183 |   DropdownMenu,
184 |   DropdownMenuTrigger,
185 |   DropdownMenuContent,
186 |   DropdownMenuItem,
187 |   DropdownMenuCheckboxItem,
188 |   DropdownMenuRadioItem,
189 |   DropdownMenuLabel,
190 |   DropdownMenuSeparator,
191 |   DropdownMenuShortcut,
192 |   DropdownMenuGroup,
193 |   DropdownMenuPortal,
194 |   DropdownMenuSub,
195 |   DropdownMenuSubContent,
196 |   DropdownMenuSubTrigger,
197 |   DropdownMenuRadioGroup,
198 | }
```

src/components/ui/form.tsx
```
1 | import * as React from "react"
2 | import * as LabelPrimitive from "@radix-ui/react-label"
3 | import { Slot } from "@radix-ui/react-slot"
4 | import {
5 |   Controller,
6 |   ControllerProps,
7 |   FieldPath,
8 |   FieldValues,
9 |   FormProvider,
10 |   useFormContext,
11 | } from "react-hook-form"
12 | 
13 | import { cn } from "@/lib/utils"
14 | import { Label } from "@/components/ui/label"
15 | 
16 | const Form = FormProvider
17 | 
18 | type FormFieldContextValue<
19 |   TFieldValues extends FieldValues = FieldValues,
20 |   TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
21 | > = {
22 |   name: TName
23 | }
24 | 
25 | const FormFieldContext = React.createContext<FormFieldContextValue>(
26 |   {} as FormFieldContextValue
27 | )
28 | 
29 | const FormField = <
30 |   TFieldValues extends FieldValues = FieldValues,
31 |   TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
32 | >({
33 |   ...props
34 | }: ControllerProps<TFieldValues, TName>) => {
35 |   return (
36 |     <FormFieldContext.Provider value={{ name: props.name }}>
37 |       <Controller {...props} />
38 |     </FormFieldContext.Provider>
39 |   )
40 | }
41 | 
42 | const useFormField = () => {
43 |   const fieldContext = React.useContext(FormFieldContext)
44 |   const itemContext = React.useContext(FormItemContext)
45 |   const { getFieldState, formState } = useFormContext()
46 | 
47 |   const fieldState = getFieldState(fieldContext.name, formState)
48 | 
49 |   if (!fieldContext) {
50 |     throw new Error("useFormField should be used within <FormField>")
51 |   }
52 | 
53 |   const { id } = itemContext
54 | 
55 |   return {
56 |     id,
57 |     name: fieldContext.name,
58 |     formItemId: `${id}-form-item`,
59 |     formDescriptionId: `${id}-form-item-description`,
60 |     formMessageId: `${id}-form-item-message`,
61 |     ...fieldState,
62 |   }
63 | }
64 | 
65 | type FormItemContextValue = {
66 |   id: string
67 | }
68 | 
69 | const FormItemContext = React.createContext<FormItemContextValue>(
70 |   {} as FormItemContextValue
71 | )
72 | 
73 | const FormItem = React.forwardRef<
74 |   HTMLDivElement,
75 |   React.HTMLAttributes<HTMLDivElement>
76 | >(({ className, ...props }, ref) => {
77 |   const id = React.useId()
78 | 
79 |   return (
80 |     <FormItemContext.Provider value={{ id }}>
81 |       <div ref={ref} className={cn("space-y-2", className)} {...props} />
82 |     </FormItemContext.Provider>
83 |   )
84 | })
85 | FormItem.displayName = "FormItem"
86 | 
87 | const FormLabel = React.forwardRef<
88 |   React.ElementRef<typeof LabelPrimitive.Root>,
89 |   React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
90 | >(({ className, ...props }, ref) => {
91 |   const { error, formItemId } = useFormField()
92 | 
93 |   return (
94 |     <Label
95 |       ref={ref}
96 |       className={cn(error && "text-destructive", className)}
97 |       htmlFor={formItemId}
98 |       {...props}
99 |     />
100 |   )
101 | })
102 | FormLabel.displayName = "FormLabel"
103 | 
104 | const FormControl = React.forwardRef<
105 |   React.ElementRef<typeof Slot>,
106 |   React.ComponentPropsWithoutRef<typeof Slot>
107 | >(({ ...props }, ref) => {
108 |   const { error, formItemId, formDescriptionId, formMessageId } = useFormField()
109 | 
110 |   return (
111 |     <Slot
112 |       ref={ref}
113 |       id={formItemId}
114 |       aria-describedby={
115 |         !error
116 |           ? `${formDescriptionId}`
117 |           : `${formDescriptionId} ${formMessageId}`
118 |       }
119 |       aria-invalid={!!error}
120 |       {...props}
121 |     />
122 |   )
123 | })
124 | FormControl.displayName = "FormControl"
125 | 
126 | const FormDescription = React.forwardRef<
127 |   HTMLParagraphElement,
128 |   React.HTMLAttributes<HTMLParagraphElement>
129 | >(({ className, ...props }, ref) => {
130 |   const { formDescriptionId } = useFormField()
131 | 
132 |   return (
133 |     <p
134 |       ref={ref}
135 |       id={formDescriptionId}
136 |       className={cn("text-sm text-muted-foreground", className)}
137 |       {...props}
138 |     />
139 |   )
140 | })
141 | FormDescription.displayName = "FormDescription"
142 | 
143 | const FormMessage = React.forwardRef<
144 |   HTMLParagraphElement,
145 |   React.HTMLAttributes<HTMLParagraphElement>
146 | >(({ className, children, ...props }, ref) => {
147 |   const { error, formMessageId } = useFormField()
148 |   const body = error ? String(error?.message) : children
149 | 
150 |   if (!body) {
151 |     return null
152 |   }
153 | 
154 |   return (
155 |     <p
156 |       ref={ref}
157 |       id={formMessageId}
158 |       className={cn("text-sm font-medium text-destructive", className)}
159 |       {...props}
160 |     >
161 |       {body}
162 |     </p>
163 |   )
164 | })
165 | FormMessage.displayName = "FormMessage"
166 | 
167 | export {
168 |   useFormField,
169 |   Form,
170 |   FormItem,
171 |   FormLabel,
172 |   FormControl,
173 |   FormDescription,
174 |   FormMessage,
175 |   FormField,
176 | }
```

src/components/ui/hover-card.tsx
```
1 | import * as React from "react"
2 | import * as HoverCardPrimitive from "@radix-ui/react-hover-card"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const HoverCard = HoverCardPrimitive.Root
7 | 
8 | const HoverCardTrigger = HoverCardPrimitive.Trigger
9 | 
10 | const HoverCardContent = React.forwardRef<
11 |   React.ElementRef<typeof HoverCardPrimitive.Content>,
12 |   React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>
13 | >(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
14 |   <HoverCardPrimitive.Content
15 |     ref={ref}
16 |     align={align}
17 |     sideOffset={sideOffset}
18 |     className={cn(
19 |       "z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
20 |       className
21 |     )}
22 |     {...props}
23 |   />
24 | ))
25 | HoverCardContent.displayName = HoverCardPrimitive.Content.displayName
26 | 
27 | export { HoverCard, HoverCardTrigger, HoverCardContent }
```

src/components/ui/input-otp.tsx
```
1 | import * as React from "react"
2 | import { OTPInput, OTPInputContext } from "input-otp"
3 | import { Dot } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const InputOTP = React.forwardRef<
8 |   React.ElementRef<typeof OTPInput>,
9 |   React.ComponentPropsWithoutRef<typeof OTPInput>
10 | >(({ className, containerClassName, ...props }, ref) => (
11 |   <OTPInput
12 |     ref={ref}
13 |     containerClassName={cn(
14 |       "flex items-center gap-2 has-[:disabled]:opacity-50",
15 |       containerClassName
16 |     )}
17 |     className={cn("disabled:cursor-not-allowed", className)}
18 |     {...props}
19 |   />
20 | ))
21 | InputOTP.displayName = "InputOTP"
22 | 
23 | const InputOTPGroup = React.forwardRef<
24 |   React.ElementRef<"div">,
25 |   React.ComponentPropsWithoutRef<"div">
26 | >(({ className, ...props }, ref) => (
27 |   <div ref={ref} className={cn("flex items-center", className)} {...props} />
28 | ))
29 | InputOTPGroup.displayName = "InputOTPGroup"
30 | 
31 | const InputOTPSlot = React.forwardRef<
32 |   React.ElementRef<"div">,
33 |   React.ComponentPropsWithoutRef<"div"> & { index: number }
34 | >(({ index, className, ...props }, ref) => {
35 |   const inputOTPContext = React.useContext(OTPInputContext)
36 |   const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]
37 | 
38 |   return (
39 |     <div
40 |       ref={ref}
41 |       className={cn(
42 |         "relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",
43 |         isActive && "z-10 ring-2 ring-ring ring-offset-background",
44 |         className
45 |       )}
46 |       {...props}
47 |     >
48 |       {char}
49 |       {hasFakeCaret && (
50 |         <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
51 |           <div className="h-4 w-px animate-caret-blink bg-foreground duration-1000" />
52 |         </div>
53 |       )}
54 |     </div>
55 |   )
56 | })
57 | InputOTPSlot.displayName = "InputOTPSlot"
58 | 
59 | const InputOTPSeparator = React.forwardRef<
60 |   React.ElementRef<"div">,
61 |   React.ComponentPropsWithoutRef<"div">
62 | >(({ ...props }, ref) => (
63 |   <div ref={ref} role="separator" {...props}>
64 |     <Dot />
65 |   </div>
66 | ))
67 | InputOTPSeparator.displayName = "InputOTPSeparator"
68 | 
69 | export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }
```

src/components/ui/input.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
6 |   ({ className, type, ...props }, ref) => {
7 |     return (
8 |       <input
9 |         type={type}
10 |         className={cn(
11 |           "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
12 |           className
13 |         )}
14 |         ref={ref}
15 |         {...props}
16 |       />
17 |     )
18 |   }
19 | )
20 | Input.displayName = "Input"
21 | 
22 | export { Input }
```

src/components/ui/label.tsx
```
1 | import * as React from "react"
2 | import * as LabelPrimitive from "@radix-ui/react-label"
3 | import { cva, type VariantProps } from "class-variance-authority"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const labelVariants = cva(
8 |   "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
9 | )
10 | 
11 | const Label = React.forwardRef<
12 |   React.ElementRef<typeof LabelPrimitive.Root>,
13 |   React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
14 |     VariantProps<typeof labelVariants>
15 | >(({ className, ...props }, ref) => (
16 |   <LabelPrimitive.Root
17 |     ref={ref}
18 |     className={cn(labelVariants(), className)}
19 |     {...props}
20 |   />
21 | ))
22 | Label.displayName = LabelPrimitive.Root.displayName
23 | 
24 | export { Label }
```

src/components/ui/menubar.tsx
```
1 | import * as React from "react"
2 | import * as MenubarPrimitive from "@radix-ui/react-menubar"
3 | import { Check, ChevronRight, Circle } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const MenubarMenu = MenubarPrimitive.Menu
8 | 
9 | const MenubarGroup = MenubarPrimitive.Group
10 | 
11 | const MenubarPortal = MenubarPrimitive.Portal
12 | 
13 | const MenubarSub = MenubarPrimitive.Sub
14 | 
15 | const MenubarRadioGroup = MenubarPrimitive.RadioGroup
16 | 
17 | const Menubar = React.forwardRef<
18 |   React.ElementRef<typeof MenubarPrimitive.Root>,
19 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
20 | >(({ className, ...props }, ref) => (
21 |   <MenubarPrimitive.Root
22 |     ref={ref}
23 |     className={cn(
24 |       "flex h-10 items-center space-x-1 rounded-md border bg-background p-1",
25 |       className
26 |     )}
27 |     {...props}
28 |   />
29 | ))
30 | Menubar.displayName = MenubarPrimitive.Root.displayName
31 | 
32 | const MenubarTrigger = React.forwardRef<
33 |   React.ElementRef<typeof MenubarPrimitive.Trigger>,
34 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
35 | >(({ className, ...props }, ref) => (
36 |   <MenubarPrimitive.Trigger
37 |     ref={ref}
38 |     className={cn(
39 |       "flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
40 |       className
41 |     )}
42 |     {...props}
43 |   />
44 | ))
45 | MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName
46 | 
47 | const MenubarSubTrigger = React.forwardRef<
48 |   React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
49 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
50 |     inset?: boolean
51 |   }
52 | >(({ className, inset, children, ...props }, ref) => (
53 |   <MenubarPrimitive.SubTrigger
54 |     ref={ref}
55 |     className={cn(
56 |       "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
57 |       inset && "pl-8",
58 |       className
59 |     )}
60 |     {...props}
61 |   >
62 |     {children}
63 |     <ChevronRight className="ml-auto h-4 w-4" />
64 |   </MenubarPrimitive.SubTrigger>
65 | ))
66 | MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName
67 | 
68 | const MenubarSubContent = React.forwardRef<
69 |   React.ElementRef<typeof MenubarPrimitive.SubContent>,
70 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
71 | >(({ className, ...props }, ref) => (
72 |   <MenubarPrimitive.SubContent
73 |     ref={ref}
74 |     className={cn(
75 |       "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
76 |       className
77 |     )}
78 |     {...props}
79 |   />
80 | ))
81 | MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName
82 | 
83 | const MenubarContent = React.forwardRef<
84 |   React.ElementRef<typeof MenubarPrimitive.Content>,
85 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
86 | >(
87 |   (
88 |     { className, align = "start", alignOffset = -4, sideOffset = 8, ...props },
89 |     ref
90 |   ) => (
91 |     <MenubarPrimitive.Portal>
92 |       <MenubarPrimitive.Content
93 |         ref={ref}
94 |         align={align}
95 |         alignOffset={alignOffset}
96 |         sideOffset={sideOffset}
97 |         className={cn(
98 |           "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
99 |           className
100 |         )}
101 |         {...props}
102 |       />
103 |     </MenubarPrimitive.Portal>
104 |   )
105 | )
106 | MenubarContent.displayName = MenubarPrimitive.Content.displayName
107 | 
108 | const MenubarItem = React.forwardRef<
109 |   React.ElementRef<typeof MenubarPrimitive.Item>,
110 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
111 |     inset?: boolean
112 |   }
113 | >(({ className, inset, ...props }, ref) => (
114 |   <MenubarPrimitive.Item
115 |     ref={ref}
116 |     className={cn(
117 |       "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
118 |       inset && "pl-8",
119 |       className
120 |     )}
121 |     {...props}
122 |   />
123 | ))
124 | MenubarItem.displayName = MenubarPrimitive.Item.displayName
125 | 
126 | const MenubarCheckboxItem = React.forwardRef<
127 |   React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
128 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
129 | >(({ className, children, checked, ...props }, ref) => (
130 |   <MenubarPrimitive.CheckboxItem
131 |     ref={ref}
132 |     className={cn(
133 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
134 |       className
135 |     )}
136 |     checked={checked}
137 |     {...props}
138 |   >
139 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
140 |       <MenubarPrimitive.ItemIndicator>
141 |         <Check className="h-4 w-4" />
142 |       </MenubarPrimitive.ItemIndicator>
143 |     </span>
144 |     {children}
145 |   </MenubarPrimitive.CheckboxItem>
146 | ))
147 | MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName
148 | 
149 | const MenubarRadioItem = React.forwardRef<
150 |   React.ElementRef<typeof MenubarPrimitive.RadioItem>,
151 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
152 | >(({ className, children, ...props }, ref) => (
153 |   <MenubarPrimitive.RadioItem
154 |     ref={ref}
155 |     className={cn(
156 |       "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
157 |       className
158 |     )}
159 |     {...props}
160 |   >
161 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
162 |       <MenubarPrimitive.ItemIndicator>
163 |         <Circle className="h-2 w-2 fill-current" />
164 |       </MenubarPrimitive.ItemIndicator>
165 |     </span>
166 |     {children}
167 |   </MenubarPrimitive.RadioItem>
168 | ))
169 | MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName
170 | 
171 | const MenubarLabel = React.forwardRef<
172 |   React.ElementRef<typeof MenubarPrimitive.Label>,
173 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
174 |     inset?: boolean
175 |   }
176 | >(({ className, inset, ...props }, ref) => (
177 |   <MenubarPrimitive.Label
178 |     ref={ref}
179 |     className={cn(
180 |       "px-2 py-1.5 text-sm font-semibold",
181 |       inset && "pl-8",
182 |       className
183 |     )}
184 |     {...props}
185 |   />
186 | ))
187 | MenubarLabel.displayName = MenubarPrimitive.Label.displayName
188 | 
189 | const MenubarSeparator = React.forwardRef<
190 |   React.ElementRef<typeof MenubarPrimitive.Separator>,
191 |   React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
192 | >(({ className, ...props }, ref) => (
193 |   <MenubarPrimitive.Separator
194 |     ref={ref}
195 |     className={cn("-mx-1 my-1 h-px bg-muted", className)}
196 |     {...props}
197 |   />
198 | ))
199 | MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName
200 | 
201 | const MenubarShortcut = ({
202 |   className,
203 |   ...props
204 | }: React.HTMLAttributes<HTMLSpanElement>) => {
205 |   return (
206 |     <span
207 |       className={cn(
208 |         "ml-auto text-xs tracking-widest text-muted-foreground",
209 |         className
210 |       )}
211 |       {...props}
212 |     />
213 |   )
214 | }
215 | MenubarShortcut.displayname = "MenubarShortcut"
216 | 
217 | export {
218 |   Menubar,
219 |   MenubarMenu,
220 |   MenubarTrigger,
221 |   MenubarContent,
222 |   MenubarItem,
223 |   MenubarSeparator,
224 |   MenubarLabel,
225 |   MenubarCheckboxItem,
226 |   MenubarRadioGroup,
227 |   MenubarRadioItem,
228 |   MenubarPortal,
229 |   MenubarSubContent,
230 |   MenubarSubTrigger,
231 |   MenubarGroup,
232 |   MenubarSub,
233 |   MenubarShortcut,
234 | }
```

src/components/ui/navigation-menu.tsx
```
1 | import * as React from "react"
2 | import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu"
3 | import { cva } from "class-variance-authority"
4 | import { ChevronDown } from "lucide-react"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | const NavigationMenu = React.forwardRef<
9 |   React.ElementRef<typeof NavigationMenuPrimitive.Root>,
10 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>
11 | >(({ className, children, ...props }, ref) => (
12 |   <NavigationMenuPrimitive.Root
13 |     ref={ref}
14 |     className={cn(
15 |       "relative z-10 flex max-w-max flex-1 items-center justify-center",
16 |       className
17 |     )}
18 |     {...props}
19 |   >
20 |     {children}
21 |     <NavigationMenuViewport />
22 |   </NavigationMenuPrimitive.Root>
23 | ))
24 | NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName
25 | 
26 | const NavigationMenuList = React.forwardRef<
27 |   React.ElementRef<typeof NavigationMenuPrimitive.List>,
28 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>
29 | >(({ className, ...props }, ref) => (
30 |   <NavigationMenuPrimitive.List
31 |     ref={ref}
32 |     className={cn(
33 |       "group flex flex-1 list-none items-center justify-center space-x-1",
34 |       className
35 |     )}
36 |     {...props}
37 |   />
38 | ))
39 | NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName
40 | 
41 | const NavigationMenuItem = NavigationMenuPrimitive.Item
42 | 
43 | const navigationMenuTriggerStyle = cva(
44 |   "group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50"
45 | )
46 | 
47 | const NavigationMenuTrigger = React.forwardRef<
48 |   React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,
49 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>
50 | >(({ className, children, ...props }, ref) => (
51 |   <NavigationMenuPrimitive.Trigger
52 |     ref={ref}
53 |     className={cn(navigationMenuTriggerStyle(), "group", className)}
54 |     {...props}
55 |   >
56 |     {children}{" "}
57 |     <ChevronDown
58 |       className="relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180"
59 |       aria-hidden="true"
60 |     />
61 |   </NavigationMenuPrimitive.Trigger>
62 | ))
63 | NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName
64 | 
65 | const NavigationMenuContent = React.forwardRef<
66 |   React.ElementRef<typeof NavigationMenuPrimitive.Content>,
67 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>
68 | >(({ className, ...props }, ref) => (
69 |   <NavigationMenuPrimitive.Content
70 |     ref={ref}
71 |     className={cn(
72 |       "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto ",
73 |       className
74 |     )}
75 |     {...props}
76 |   />
77 | ))
78 | NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName
79 | 
80 | const NavigationMenuLink = NavigationMenuPrimitive.Link
81 | 
82 | const NavigationMenuViewport = React.forwardRef<
83 |   React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,
84 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>
85 | >(({ className, ...props }, ref) => (
86 |   <div className={cn("absolute left-0 top-full flex justify-center")}>
87 |     <NavigationMenuPrimitive.Viewport
88 |       className={cn(
89 |         "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]",
90 |         className
91 |       )}
92 |       ref={ref}
93 |       {...props}
94 |     />
95 |   </div>
96 | ))
97 | NavigationMenuViewport.displayName =
98 |   NavigationMenuPrimitive.Viewport.displayName
99 | 
100 | const NavigationMenuIndicator = React.forwardRef<
101 |   React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,
102 |   React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>
103 | >(({ className, ...props }, ref) => (
104 |   <NavigationMenuPrimitive.Indicator
105 |     ref={ref}
106 |     className={cn(
107 |       "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
108 |       className
109 |     )}
110 |     {...props}
111 |   >
112 |     <div className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
113 |   </NavigationMenuPrimitive.Indicator>
114 | ))
115 | NavigationMenuIndicator.displayName =
116 |   NavigationMenuPrimitive.Indicator.displayName
117 | 
118 | export {
119 |   navigationMenuTriggerStyle,
120 |   NavigationMenu,
121 |   NavigationMenuList,
122 |   NavigationMenuItem,
123 |   NavigationMenuContent,
124 |   NavigationMenuTrigger,
125 |   NavigationMenuLink,
126 |   NavigationMenuIndicator,
127 |   NavigationMenuViewport,
128 | }
```

src/components/ui/pagination.tsx
```
1 | import * as React from "react"
2 | import { ChevronLeft, ChevronRight, MoreHorizontal } from "lucide-react"
3 | 
4 | import { cn } from "@/lib/utils"
5 | import { ButtonProps, buttonVariants } from "@/components/ui/button"
6 | 
7 | const Pagination = ({ className, ...props }: React.ComponentProps<"nav">) => (
8 |   <nav
9 |     role="navigation"
10 |     aria-label="pagination"
11 |     className={cn("mx-auto flex w-full justify-center", className)}
12 |     {...props}
13 |   />
14 | )
15 | Pagination.displayName = "Pagination"
16 | 
17 | const PaginationContent = React.forwardRef<
18 |   HTMLUListElement,
19 |   React.ComponentProps<"ul">
20 | >(({ className, ...props }, ref) => (
21 |   <ul
22 |     ref={ref}
23 |     className={cn("flex flex-row items-center gap-1", className)}
24 |     {...props}
25 |   />
26 | ))
27 | PaginationContent.displayName = "PaginationContent"
28 | 
29 | const PaginationItem = React.forwardRef<
30 |   HTMLLIElement,
31 |   React.ComponentProps<"li">
32 | >(({ className, ...props }, ref) => (
33 |   <li ref={ref} className={cn("", className)} {...props} />
34 | ))
35 | PaginationItem.displayName = "PaginationItem"
36 | 
37 | type PaginationLinkProps = {
38 |   isActive?: boolean
39 | } & Pick<ButtonProps, "size"> &
40 |   React.ComponentProps<"a">
41 | 
42 | const PaginationLink = ({
43 |   className,
44 |   isActive,
45 |   size = "icon",
46 |   ...props
47 | }: PaginationLinkProps) => (
48 |   <a
49 |     aria-current={isActive ? "page" : undefined}
50 |     className={cn(
51 |       buttonVariants({
52 |         variant: isActive ? "outline" : "ghost",
53 |         size,
54 |       }),
55 |       className
56 |     )}
57 |     {...props}
58 |   />
59 | )
60 | PaginationLink.displayName = "PaginationLink"
61 | 
62 | const PaginationPrevious = ({
63 |   className,
64 |   ...props
65 | }: React.ComponentProps<typeof PaginationLink>) => (
66 |   <PaginationLink
67 |     aria-label="Go to previous page"
68 |     size="default"
69 |     className={cn("gap-1 pl-2.5", className)}
70 |     {...props}
71 |   >
72 |     <ChevronLeft className="h-4 w-4" />
73 |     <span>Previous</span>
74 |   </PaginationLink>
75 | )
76 | PaginationPrevious.displayName = "PaginationPrevious"
77 | 
78 | const PaginationNext = ({
79 |   className,
80 |   ...props
81 | }: React.ComponentProps<typeof PaginationLink>) => (
82 |   <PaginationLink
83 |     aria-label="Go to next page"
84 |     size="default"
85 |     className={cn("gap-1 pr-2.5", className)}
86 |     {...props}
87 |   >
88 |     <span>Next</span>
89 |     <ChevronRight className="h-4 w-4" />
90 |   </PaginationLink>
91 | )
92 | PaginationNext.displayName = "PaginationNext"
93 | 
94 | const PaginationEllipsis = ({
95 |   className,
96 |   ...props
97 | }: React.ComponentProps<"span">) => (
98 |   <span
99 |     aria-hidden
100 |     className={cn("flex h-9 w-9 items-center justify-center", className)}
101 |     {...props}
102 |   >
103 |     <MoreHorizontal className="h-4 w-4" />
104 |     <span className="sr-only">More pages</span>
105 |   </span>
106 | )
107 | PaginationEllipsis.displayName = "PaginationEllipsis"
108 | 
109 | export {
110 |   Pagination,
111 |   PaginationContent,
112 |   PaginationEllipsis,
113 |   PaginationItem,
114 |   PaginationLink,
115 |   PaginationNext,
116 |   PaginationPrevious,
117 | }
```

src/components/ui/popover.tsx
```
1 | import * as React from "react"
2 | import * as PopoverPrimitive from "@radix-ui/react-popover"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Popover = PopoverPrimitive.Root
7 | 
8 | const PopoverTrigger = PopoverPrimitive.Trigger
9 | 
10 | const PopoverContent = React.forwardRef<
11 |   React.ElementRef<typeof PopoverPrimitive.Content>,
12 |   React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
13 | >(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
14 |   <PopoverPrimitive.Portal>
15 |     <PopoverPrimitive.Content
16 |       ref={ref}
17 |       align={align}
18 |       sideOffset={sideOffset}
19 |       className={cn(
20 |         "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
21 |         className
22 |       )}
23 |       {...props}
24 |     />
25 |   </PopoverPrimitive.Portal>
26 | ))
27 | PopoverContent.displayName = PopoverPrimitive.Content.displayName
28 | 
29 | export { Popover, PopoverTrigger, PopoverContent }
```

src/components/ui/progress.tsx
```
1 | import * as React from "react"
2 | import * as ProgressPrimitive from "@radix-ui/react-progress"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Progress = React.forwardRef<
7 |   React.ElementRef<typeof ProgressPrimitive.Root>,
8 |   React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
9 | >(({ className, value, ...props }, ref) => (
10 |   <ProgressPrimitive.Root
11 |     ref={ref}
12 |     className={cn(
13 |       "relative h-4 w-full overflow-hidden rounded-full bg-secondary",
14 |       className
15 |     )}
16 |     {...props}
17 |   >
18 |     <ProgressPrimitive.Indicator
19 |       className="h-full w-full flex-1 bg-primary transition-all"
20 |       style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
21 |     />
22 |   </ProgressPrimitive.Root>
23 | ))
24 | Progress.displayName = ProgressPrimitive.Root.displayName
25 | 
26 | export { Progress }
```

src/components/ui/radio-group.tsx
```
1 | import * as React from "react"
2 | import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
3 | import { Circle } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const RadioGroup = React.forwardRef<
8 |   React.ElementRef<typeof RadioGroupPrimitive.Root>,
9 |   React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
10 | >(({ className, ...props }, ref) => {
11 |   return (
12 |     <RadioGroupPrimitive.Root
13 |       className={cn("grid gap-2", className)}
14 |       {...props}
15 |       ref={ref}
16 |     />
17 |   )
18 | })
19 | RadioGroup.displayName = RadioGroupPrimitive.Root.displayName
20 | 
21 | const RadioGroupItem = React.forwardRef<
22 |   React.ElementRef<typeof RadioGroupPrimitive.Item>,
23 |   React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
24 | >(({ className, ...props }, ref) => {
25 |   return (
26 |     <RadioGroupPrimitive.Item
27 |       ref={ref}
28 |       className={cn(
29 |         "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
30 |         className
31 |       )}
32 |       {...props}
33 |     >
34 |       <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
35 |         <Circle className="h-2.5 w-2.5 fill-current text-current" />
36 |       </RadioGroupPrimitive.Indicator>
37 |     </RadioGroupPrimitive.Item>
38 |   )
39 | })
40 | RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName
41 | 
42 | export { RadioGroup, RadioGroupItem }
```

src/components/ui/resizable.tsx
```
1 | import { GripVertical } from "lucide-react"
2 | import * as ResizablePrimitive from "react-resizable-panels"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const ResizablePanelGroup = ({
7 |   className,
8 |   ...props
9 | }: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (
10 |   <ResizablePrimitive.PanelGroup
11 |     className={cn(
12 |       "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
13 |       className
14 |     )}
15 |     {...props}
16 |   />
17 | )
18 | 
19 | const ResizablePanel = ResizablePrimitive.Panel
20 | 
21 | const ResizableHandle = ({
22 |   withHandle,
23 |   className,
24 |   ...props
25 | }: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
26 |   withHandle?: boolean
27 | }) => (
28 |   <ResizablePrimitive.PanelResizeHandle
29 |     className={cn(
30 |       "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
31 |       className
32 |     )}
33 |     {...props}
34 |   >
35 |     {withHandle && (
36 |       <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
37 |         <GripVertical className="h-2.5 w-2.5" />
38 |       </div>
39 |     )}
40 |   </ResizablePrimitive.PanelResizeHandle>
41 | )
42 | 
43 | export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
```

src/components/ui/scroll-area.tsx
```
1 | import * as React from "react"
2 | import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const ScrollArea = React.forwardRef<
7 |   React.ElementRef<typeof ScrollAreaPrimitive.Root>,
8 |   React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
9 | >(({ className, children, ...props }, ref) => (
10 |   <ScrollAreaPrimitive.Root
11 |     ref={ref}
12 |     className={cn("relative overflow-hidden", className)}
13 |     {...props}
14 |   >
15 |     <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
16 |       {children}
17 |     </ScrollAreaPrimitive.Viewport>
18 |     <ScrollBar />
19 |     <ScrollAreaPrimitive.Corner />
20 |   </ScrollAreaPrimitive.Root>
21 | ))
22 | ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName
23 | 
24 | const ScrollBar = React.forwardRef<
25 |   React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
26 |   React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
27 | >(({ className, orientation = "vertical", ...props }, ref) => (
28 |   <ScrollAreaPrimitive.ScrollAreaScrollbar
29 |     ref={ref}
30 |     orientation={orientation}
31 |     className={cn(
32 |       "flex touch-none select-none transition-colors",
33 |       orientation === "vertical" &&
34 |         "h-full w-2.5 border-l border-l-transparent p-[1px]",
35 |       orientation === "horizontal" &&
36 |         "h-2.5 flex-col border-t border-t-transparent p-[1px]",
37 |       className
38 |     )}
39 |     {...props}
40 |   >
41 |     <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
42 |   </ScrollAreaPrimitive.ScrollAreaScrollbar>
43 | ))
44 | ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName
45 | 
46 | export { ScrollArea, ScrollBar }
```

src/components/ui/select.tsx
```
1 | import * as React from "react"
2 | import * as SelectPrimitive from "@radix-ui/react-select"
3 | import { Check, ChevronDown, ChevronUp } from "lucide-react"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const Select = SelectPrimitive.Root
8 | 
9 | const SelectGroup = SelectPrimitive.Group
10 | 
11 | const SelectValue = SelectPrimitive.Value
12 | 
13 | const SelectTrigger = React.forwardRef<
14 |   React.ElementRef<typeof SelectPrimitive.Trigger>,
15 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
16 | >(({ className, children, ...props }, ref) => (
17 |   <SelectPrimitive.Trigger
18 |     ref={ref}
19 |     className={cn(
20 |       "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
21 |       className
22 |     )}
23 |     {...props}
24 |   >
25 |     {children}
26 |     <SelectPrimitive.Icon asChild>
27 |       <ChevronDown className="h-4 w-4 opacity-50" />
28 |     </SelectPrimitive.Icon>
29 |   </SelectPrimitive.Trigger>
30 | ))
31 | SelectTrigger.displayName = SelectPrimitive.Trigger.displayName
32 | 
33 | const SelectScrollUpButton = React.forwardRef<
34 |   React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
35 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
36 | >(({ className, ...props }, ref) => (
37 |   <SelectPrimitive.ScrollUpButton
38 |     ref={ref}
39 |     className={cn(
40 |       "flex cursor-default items-center justify-center py-1",
41 |       className
42 |     )}
43 |     {...props}
44 |   >
45 |     <ChevronUp className="h-4 w-4" />
46 |   </SelectPrimitive.ScrollUpButton>
47 | ))
48 | SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName
49 | 
50 | const SelectScrollDownButton = React.forwardRef<
51 |   React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
52 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
53 | >(({ className, ...props }, ref) => (
54 |   <SelectPrimitive.ScrollDownButton
55 |     ref={ref}
56 |     className={cn(
57 |       "flex cursor-default items-center justify-center py-1",
58 |       className
59 |     )}
60 |     {...props}
61 |   >
62 |     <ChevronDown className="h-4 w-4" />
63 |   </SelectPrimitive.ScrollDownButton>
64 | ))
65 | SelectScrollDownButton.displayName =
66 |   SelectPrimitive.ScrollDownButton.displayName
67 | 
68 | const SelectContent = React.forwardRef<
69 |   React.ElementRef<typeof SelectPrimitive.Content>,
70 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
71 | >(({ className, children, position = "popper", ...props }, ref) => (
72 |   <SelectPrimitive.Portal>
73 |     <SelectPrimitive.Content
74 |       ref={ref}
75 |       className={cn(
76 |         "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-white text-gray-900 shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
77 |         position === "popper" &&
78 |           "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
79 |         className
80 |       )}
81 |       position={position}
82 |       {...props}
83 |     >
84 |       <SelectScrollUpButton />
85 |       <SelectPrimitive.Viewport
86 |         className={cn(
87 |           "p-1",
88 |           position === "popper" &&
89 |             "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
90 |         )}
91 |       >
92 |         {children}
93 |       </SelectPrimitive.Viewport>
94 |       <SelectScrollDownButton />
95 |     </SelectPrimitive.Content>
96 |   </SelectPrimitive.Portal>
97 | ))
98 | SelectContent.displayName = SelectPrimitive.Content.displayName
99 | 
100 | const SelectLabel = React.forwardRef<
101 |   React.ElementRef<typeof SelectPrimitive.Label>,
102 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
103 | >(({ className, ...props }, ref) => (
104 |   <SelectPrimitive.Label
105 |     ref={ref}
106 |     className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
107 |     {...props}
108 |   />
109 | ))
110 | SelectLabel.displayName = SelectPrimitive.Label.displayName
111 | 
112 | const SelectItem = React.forwardRef<
113 |   React.ElementRef<typeof SelectPrimitive.Item>,
114 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
115 | >(({ className, children, ...props }, ref) => (
116 |   <SelectPrimitive.Item
117 |     ref={ref}
118 |     className={cn(
119 |       "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm text-black font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
120 |       className
121 |     )}
122 |     {...props}
123 |   >
124 |     <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
125 |       <SelectPrimitive.ItemIndicator>
126 |         <Check className="h-4 w-4" />
127 |       </SelectPrimitive.ItemIndicator>
128 |     </span>
129 | 
130 |     <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
131 |   </SelectPrimitive.Item>
132 | ))
133 | SelectItem.displayName = SelectPrimitive.Item.displayName
134 | 
135 | const SelectSeparator = React.forwardRef<
136 |   React.ElementRef<typeof SelectPrimitive.Separator>,
137 |   React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
138 | >(({ className, ...props }, ref) => (
139 |   <SelectPrimitive.Separator
140 |     ref={ref}
141 |     className={cn("-mx-1 my-1 h-px bg-muted", className)}
142 |     {...props}
143 |   />
144 | ))
145 | SelectSeparator.displayName = SelectPrimitive.Separator.displayName
146 | 
147 | export {
148 |   Select,
149 |   SelectGroup,
150 |   SelectValue,
151 |   SelectTrigger,
152 |   SelectContent,
153 |   SelectLabel,
154 |   SelectItem,
155 |   SelectSeparator,
156 |   SelectScrollUpButton,
157 |   SelectScrollDownButton,
158 | }
```

src/components/ui/separator.tsx
```
1 | import * as React from "react"
2 | import * as SeparatorPrimitive from "@radix-ui/react-separator"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Separator = React.forwardRef<
7 |   React.ElementRef<typeof SeparatorPrimitive.Root>,
8 |   React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
9 | >(
10 |   (
11 |     { className, orientation = "horizontal", decorative = true, ...props },
12 |     ref
13 |   ) => (
14 |     <SeparatorPrimitive.Root
15 |       ref={ref}
16 |       decorative={decorative}
17 |       orientation={orientation}
18 |       className={cn(
19 |         "shrink-0 bg-border",
20 |         orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
21 |         className
22 |       )}
23 |       {...props}
24 |     />
25 |   )
26 | )
27 | Separator.displayName = SeparatorPrimitive.Root.displayName
28 | 
29 | export { Separator }
```

src/components/ui/sheet.tsx
```
1 | import * as SheetPrimitive from "@radix-ui/react-dialog"
2 | import { cva, type VariantProps } from "class-variance-authority"
3 | import { X } from "lucide-react"
4 | import * as React from "react"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | const Sheet = SheetPrimitive.Root
9 | 
10 | const SheetTrigger = SheetPrimitive.Trigger
11 | 
12 | const SheetClose = SheetPrimitive.Close
13 | 
14 | const SheetPortal = SheetPrimitive.Portal
15 | 
16 | const SheetOverlay = React.forwardRef<
17 |   React.ElementRef<typeof SheetPrimitive.Overlay>,
18 |   React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
19 | >(({ className, ...props }, ref) => (
20 |   <SheetPrimitive.Overlay
21 |     className={cn(
22 |       "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
23 |       className
24 |     )}
25 |     {...props}
26 |     ref={ref}
27 |   />
28 | ))
29 | SheetOverlay.displayName = SheetPrimitive.Overlay.displayName
30 | 
31 | const sheetVariants = cva(
32 |   "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
33 |   {
34 |     variants: {
35 |       side: {
36 |         top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
37 |         bottom:
38 |           "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
39 |         left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
40 |         right:
41 |           "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
42 |       },
43 |     },
44 |     defaultVariants: {
45 |       side: "right",
46 |     },
47 |   }
48 | )
49 | 
50 | interface SheetContentProps
51 |   extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
52 |   VariantProps<typeof sheetVariants> { }
53 | 
54 | const SheetContent = React.forwardRef<
55 |   React.ElementRef<typeof SheetPrimitive.Content>,
56 |   SheetContentProps
57 | >(({ side = "right", className, children, ...props }, ref) => (
58 |   <SheetPortal>
59 |     <SheetOverlay />
60 |     <SheetPrimitive.Content
61 |       ref={ref}
62 |       className={cn(sheetVariants({ side }), className)}
63 |       {...props}
64 |     >
65 |       {children}
66 |       <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
67 |         <X className="h-4 w-4" />
68 |         <span className="sr-only">Close</span>
69 |       </SheetPrimitive.Close>
70 |     </SheetPrimitive.Content>
71 |   </SheetPortal>
72 | ))
73 | SheetContent.displayName = SheetPrimitive.Content.displayName
74 | 
75 | const SheetHeader = ({
76 |   className,
77 |   ...props
78 | }: React.HTMLAttributes<HTMLDivElement>) => (
79 |   <div
80 |     className={cn(
81 |       "flex flex-col space-y-2 text-center sm:text-left",
82 |       className
83 |     )}
84 |     {...props}
85 |   />
86 | )
87 | SheetHeader.displayName = "SheetHeader"
88 | 
89 | const SheetFooter = ({
90 |   className,
91 |   ...props
92 | }: React.HTMLAttributes<HTMLDivElement>) => (
93 |   <div
94 |     className={cn(
95 |       "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
96 |       className
97 |     )}
98 |     {...props}
99 |   />
100 | )
101 | SheetFooter.displayName = "SheetFooter"
102 | 
103 | const SheetTitle = React.forwardRef<
104 |   React.ElementRef<typeof SheetPrimitive.Title>,
105 |   React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
106 | >(({ className, ...props }, ref) => (
107 |   <SheetPrimitive.Title
108 |     ref={ref}
109 |     className={cn("text-lg font-semibold text-foreground", className)}
110 |     {...props}
111 |   />
112 | ))
113 | SheetTitle.displayName = SheetPrimitive.Title.displayName
114 | 
115 | const SheetDescription = React.forwardRef<
116 |   React.ElementRef<typeof SheetPrimitive.Description>,
117 |   React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
118 | >(({ className, ...props }, ref) => (
119 |   <SheetPrimitive.Description
120 |     ref={ref}
121 |     className={cn("text-sm text-muted-foreground", className)}
122 |     {...props}
123 |   />
124 | ))
125 | SheetDescription.displayName = SheetPrimitive.Description.displayName
126 | 
127 | export {
128 |   Sheet, SheetClose,
129 |   SheetContent, SheetDescription, SheetFooter, SheetHeader, SheetOverlay, SheetPortal, SheetTitle, SheetTrigger
130 | }
131 | 
```

src/components/ui/sidebar.tsx
```
1 | import * as React from "react"
2 | import { Slot } from "@radix-ui/react-slot"
3 | import { VariantProps, cva } from "class-variance-authority"
4 | import { PanelLeft } from "lucide-react"
5 | 
6 | import { useIsMobile } from "@/hooks/use-mobile"
7 | import { cn } from "@/lib/utils"
8 | import { Button } from "@/components/ui/button"
9 | import { Input } from "@/components/ui/input"
10 | import { Separator } from "@/components/ui/separator"
11 | import { Sheet, SheetContent } from "@/components/ui/sheet"
12 | import { Skeleton } from "@/components/ui/skeleton"
13 | import {
14 |   Tooltip,
15 |   TooltipContent,
16 |   TooltipProvider,
17 |   TooltipTrigger,
18 | } from "@/components/ui/tooltip"
19 | 
20 | const SIDEBAR_COOKIE_NAME = "sidebar:state"
21 | const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
22 | const SIDEBAR_WIDTH = "16rem"
23 | const SIDEBAR_WIDTH_MOBILE = "18rem"
24 | const SIDEBAR_WIDTH_ICON = "3rem"
25 | const SIDEBAR_KEYBOARD_SHORTCUT = "b"
26 | 
27 | type SidebarContext = {
28 |   state: "expanded" | "collapsed"
29 |   open: boolean
30 |   setOpen: (open: boolean) => void
31 |   openMobile: boolean
32 |   setOpenMobile: (open: boolean) => void
33 |   isMobile: boolean
34 |   toggleSidebar: () => void
35 | }
36 | 
37 | const SidebarContext = React.createContext<SidebarContext | null>(null)
38 | 
39 | function useSidebar() {
40 |   const context = React.useContext(SidebarContext)
41 |   if (!context) {
42 |     throw new Error("useSidebar must be used within a SidebarProvider.")
43 |   }
44 | 
45 |   return context
46 | }
47 | 
48 | const SidebarProvider = React.forwardRef<
49 |   HTMLDivElement,
50 |   React.ComponentProps<"div"> & {
51 |     defaultOpen?: boolean
52 |     open?: boolean
53 |     onOpenChange?: (open: boolean) => void
54 |   }
55 | >(
56 |   (
57 |     {
58 |       defaultOpen = true,
59 |       open: openProp,
60 |       onOpenChange: setOpenProp,
61 |       className,
62 |       style,
63 |       children,
64 |       ...props
65 |     },
66 |     ref
67 |   ) => {
68 |     const isMobile = useIsMobile()
69 |     const [openMobile, setOpenMobile] = React.useState(false)
70 | 
71 |     // This is the internal state of the sidebar.
72 |     // We use openProp and setOpenProp for control from outside the component.
73 |     const [_open, _setOpen] = React.useState(defaultOpen)
74 |     const open = openProp ?? _open
75 |     const setOpen = React.useCallback(
76 |       (value: boolean | ((value: boolean) => boolean)) => {
77 |         const openState = typeof value === "function" ? value(open) : value
78 |         if (setOpenProp) {
79 |           setOpenProp(openState)
80 |         } else {
81 |           _setOpen(openState)
82 |         }
83 | 
84 |         // This sets the cookie to keep the sidebar state.
85 |         document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
86 |       },
87 |       [setOpenProp, open]
88 |     )
89 | 
90 |     // Helper to toggle the sidebar.
91 |     const toggleSidebar = React.useCallback(() => {
92 |       return isMobile
93 |         ? setOpenMobile((open) => !open)
94 |         : setOpen((open) => !open)
95 |     }, [isMobile, setOpen, setOpenMobile])
96 | 
97 |     // Adds a keyboard shortcut to toggle the sidebar.
98 |     React.useEffect(() => {
99 |       const handleKeyDown = (event: KeyboardEvent) => {
100 |         if (
101 |           event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
102 |           (event.metaKey || event.ctrlKey)
103 |         ) {
104 |           event.preventDefault()
105 |           toggleSidebar()
106 |         }
107 |       }
108 | 
109 |       window.addEventListener("keydown", handleKeyDown)
110 |       return () => window.removeEventListener("keydown", handleKeyDown)
111 |     }, [toggleSidebar])
112 | 
113 |     // We add a state so that we can do data-state="expanded" or "collapsed".
114 |     // This makes it easier to style the sidebar with Tailwind classes.
115 |     const state = open ? "expanded" : "collapsed"
116 | 
117 |     const contextValue = React.useMemo<SidebarContext>(
118 |       () => ({
119 |         state,
120 |         open,
121 |         setOpen,
122 |         isMobile,
123 |         openMobile,
124 |         setOpenMobile,
125 |         toggleSidebar,
126 |       }),
127 |       [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
128 |     )
129 | 
130 |     return (
131 |       <SidebarContext.Provider value={contextValue}>
132 |         <TooltipProvider delayDuration={0}>
133 |           <div
134 |             style={
135 |               {
136 |                 "--sidebar-width": SIDEBAR_WIDTH,
137 |                 "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
138 |                 ...style,
139 |               } as React.CSSProperties
140 |             }
141 |             className={cn(
142 |               "group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",
143 |               className
144 |             )}
145 |             ref={ref}
146 |             {...props}
147 |           >
148 |             {children}
149 |           </div>
150 |         </TooltipProvider>
151 |       </SidebarContext.Provider>
152 |     )
153 |   }
154 | )
155 | SidebarProvider.displayName = "SidebarProvider"
156 | 
157 | const Sidebar = React.forwardRef<
158 |   HTMLDivElement,
159 |   React.ComponentProps<"div"> & {
160 |     side?: "left" | "right"
161 |     variant?: "sidebar" | "floating" | "inset"
162 |     collapsible?: "offcanvas" | "icon" | "none"
163 |   }
164 | >(
165 |   (
166 |     {
167 |       side = "left",
168 |       variant = "sidebar",
169 |       collapsible = "offcanvas",
170 |       className,
171 |       children,
172 |       ...props
173 |     },
174 |     ref
175 |   ) => {
176 |     const { isMobile, state, openMobile, setOpenMobile } = useSidebar()
177 | 
178 |     if (collapsible === "none") {
179 |       return (
180 |         <div
181 |           className={cn(
182 |             "flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",
183 |             className
184 |           )}
185 |           ref={ref}
186 |           {...props}
187 |         >
188 |           {children}
189 |         </div>
190 |       )
191 |     }
192 | 
193 |     if (isMobile) {
194 |       return (
195 |         <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
196 |           <SheetContent
197 |             data-sidebar="sidebar"
198 |             data-mobile="true"
199 |             className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
200 |             style={
201 |               {
202 |                 "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
203 |               } as React.CSSProperties
204 |             }
205 |             side={side}
206 |           >
207 |             <div className="flex h-full w-full flex-col">{children}</div>
208 |           </SheetContent>
209 |         </Sheet>
210 |       )
211 |     }
212 | 
213 |     return (
214 |       <div
215 |         ref={ref}
216 |         className="group peer hidden md:block text-sidebar-foreground"
217 |         data-state={state}
218 |         data-collapsible={state === "collapsed" ? collapsible : ""}
219 |         data-variant={variant}
220 |         data-side={side}
221 |       >
222 |         {/* This is what handles the sidebar gap on desktop */}
223 |         <div
224 |           className={cn(
225 |             "duration-200 relative h-svh w-[--sidebar-width] bg-transparent transition-[width] ease-linear",
226 |             "group-data-[collapsible=offcanvas]:w-0",
227 |             "group-data-[side=right]:rotate-180",
228 |             variant === "floating" || variant === "inset"
229 |               ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
230 |               : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]"
231 |           )}
232 |         />
233 |         <div
234 |           className={cn(
235 |             "duration-200 fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex",
236 |             side === "left"
237 |               ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
238 |               : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
239 |             // Adjust the padding for floating and inset variants.
240 |             variant === "floating" || variant === "inset"
241 |               ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
242 |               : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
243 |             className
244 |           )}
245 |           {...props}
246 |         >
247 |           <div
248 |             data-sidebar="sidebar"
249 |             className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow"
250 |           >
251 |             {children}
252 |           </div>
253 |         </div>
254 |       </div>
255 |     )
256 |   }
257 | )
258 | Sidebar.displayName = "Sidebar"
259 | 
260 | const SidebarTrigger = React.forwardRef<
261 |   React.ElementRef<typeof Button>,
262 |   React.ComponentProps<typeof Button>
263 | >(({ className, onClick, ...props }, ref) => {
264 |   const { toggleSidebar } = useSidebar()
265 | 
266 |   return (
267 |     <Button
268 |       ref={ref}
269 |       data-sidebar="trigger"
270 |       variant="ghost"
271 |       size="icon"
272 |       className={cn("h-7 w-7", className)}
273 |       onClick={(event) => {
274 |         onClick?.(event)
275 |         toggleSidebar()
276 |       }}
277 |       {...props}
278 |     >
279 |       <PanelLeft />
280 |       <span className="sr-only">Toggle Sidebar</span>
281 |     </Button>
282 |   )
283 | })
284 | SidebarTrigger.displayName = "SidebarTrigger"
285 | 
286 | const SidebarRail = React.forwardRef<
287 |   HTMLButtonElement,
288 |   React.ComponentProps<"button">
289 | >(({ className, ...props }, ref) => {
290 |   const { toggleSidebar } = useSidebar()
291 | 
292 |   return (
293 |     <button
294 |       ref={ref}
295 |       data-sidebar="rail"
296 |       aria-label="Toggle Sidebar"
297 |       tabIndex={-1}
298 |       onClick={toggleSidebar}
299 |       title="Toggle Sidebar"
300 |       className={cn(
301 |         "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex",
302 |         "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
303 |         "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
304 |         "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
305 |         "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
306 |         "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
307 |         className
308 |       )}
309 |       {...props}
310 |     />
311 |   )
312 | })
313 | SidebarRail.displayName = "SidebarRail"
314 | 
315 | const SidebarInset = React.forwardRef<
316 |   HTMLDivElement,
317 |   React.ComponentProps<"main">
318 | >(({ className, ...props }, ref) => {
319 |   return (
320 |     <main
321 |       ref={ref}
322 |       className={cn(
323 |         "relative flex min-h-svh flex-1 flex-col bg-background",
324 |         "peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
325 |         className
326 |       )}
327 |       {...props}
328 |     />
329 |   )
330 | })
331 | SidebarInset.displayName = "SidebarInset"
332 | 
333 | const SidebarInput = React.forwardRef<
334 |   React.ElementRef<typeof Input>,
335 |   React.ComponentProps<typeof Input>
336 | >(({ className, ...props }, ref) => {
337 |   return (
338 |     <Input
339 |       ref={ref}
340 |       data-sidebar="input"
341 |       className={cn(
342 |         "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
343 |         className
344 |       )}
345 |       {...props}
346 |     />
347 |   )
348 | })
349 | SidebarInput.displayName = "SidebarInput"
350 | 
351 | const SidebarHeader = React.forwardRef<
352 |   HTMLDivElement,
353 |   React.ComponentProps<"div">
354 | >(({ className, ...props }, ref) => {
355 |   return (
356 |     <div
357 |       ref={ref}
358 |       data-sidebar="header"
359 |       className={cn("flex flex-col gap-2 p-2", className)}
360 |       {...props}
361 |     />
362 |   )
363 | })
364 | SidebarHeader.displayName = "SidebarHeader"
365 | 
366 | const SidebarFooter = React.forwardRef<
367 |   HTMLDivElement,
368 |   React.ComponentProps<"div">
369 | >(({ className, ...props }, ref) => {
370 |   return (
371 |     <div
372 |       ref={ref}
373 |       data-sidebar="footer"
374 |       className={cn("flex flex-col gap-2 p-2", className)}
375 |       {...props}
376 |     />
377 |   )
378 | })
379 | SidebarFooter.displayName = "SidebarFooter"
380 | 
381 | const SidebarSeparator = React.forwardRef<
382 |   React.ElementRef<typeof Separator>,
383 |   React.ComponentProps<typeof Separator>
384 | >(({ className, ...props }, ref) => {
385 |   return (
386 |     <Separator
387 |       ref={ref}
388 |       data-sidebar="separator"
389 |       className={cn("mx-2 w-auto bg-sidebar-border", className)}
390 |       {...props}
391 |     />
392 |   )
393 | })
394 | SidebarSeparator.displayName = "SidebarSeparator"
395 | 
396 | const SidebarContent = React.forwardRef<
397 |   HTMLDivElement,
398 |   React.ComponentProps<"div">
399 | >(({ className, ...props }, ref) => {
400 |   return (
401 |     <div
402 |       ref={ref}
403 |       data-sidebar="content"
404 |       className={cn(
405 |         "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
406 |         className
407 |       )}
408 |       {...props}
409 |     />
410 |   )
411 | })
412 | SidebarContent.displayName = "SidebarContent"
413 | 
414 | const SidebarGroup = React.forwardRef<
415 |   HTMLDivElement,
416 |   React.ComponentProps<"div">
417 | >(({ className, ...props }, ref) => {
418 |   return (
419 |     <div
420 |       ref={ref}
421 |       data-sidebar="group"
422 |       className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
423 |       {...props}
424 |     />
425 |   )
426 | })
427 | SidebarGroup.displayName = "SidebarGroup"
428 | 
429 | const SidebarGroupLabel = React.forwardRef<
430 |   HTMLDivElement,
431 |   React.ComponentProps<"div"> & { asChild?: boolean }
432 | >(({ className, asChild = false, ...props }, ref) => {
433 |   const Comp = asChild ? Slot : "div"
434 | 
435 |   return (
436 |     <Comp
437 |       ref={ref}
438 |       data-sidebar="group-label"
439 |       className={cn(
440 |         "duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
441 |         "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
442 |         className
443 |       )}
444 |       {...props}
445 |     />
446 |   )
447 | })
448 | SidebarGroupLabel.displayName = "SidebarGroupLabel"
449 | 
450 | const SidebarGroupAction = React.forwardRef<
451 |   HTMLButtonElement,
452 |   React.ComponentProps<"button"> & { asChild?: boolean }
453 | >(({ className, asChild = false, ...props }, ref) => {
454 |   const Comp = asChild ? Slot : "button"
455 | 
456 |   return (
457 |     <Comp
458 |       ref={ref}
459 |       data-sidebar="group-action"
460 |       className={cn(
461 |         "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
462 |         // Increases the hit area of the button on mobile.
463 |         "after:absolute after:-inset-2 after:md:hidden",
464 |         "group-data-[collapsible=icon]:hidden",
465 |         className
466 |       )}
467 |       {...props}
468 |     />
469 |   )
470 | })
471 | SidebarGroupAction.displayName = "SidebarGroupAction"
472 | 
473 | const SidebarGroupContent = React.forwardRef<
474 |   HTMLDivElement,
475 |   React.ComponentProps<"div">
476 | >(({ className, ...props }, ref) => (
477 |   <div
478 |     ref={ref}
479 |     data-sidebar="group-content"
480 |     className={cn("w-full text-sm", className)}
481 |     {...props}
482 |   />
483 | ))
484 | SidebarGroupContent.displayName = "SidebarGroupContent"
485 | 
486 | const SidebarMenu = React.forwardRef<
487 |   HTMLUListElement,
488 |   React.ComponentProps<"ul">
489 | >(({ className, ...props }, ref) => (
490 |   <ul
491 |     ref={ref}
492 |     data-sidebar="menu"
493 |     className={cn("flex w-full min-w-0 flex-col gap-1", className)}
494 |     {...props}
495 |   />
496 | ))
497 | SidebarMenu.displayName = "SidebarMenu"
498 | 
499 | const SidebarMenuItem = React.forwardRef<
500 |   HTMLLIElement,
501 |   React.ComponentProps<"li">
502 | >(({ className, ...props }, ref) => (
503 |   <li
504 |     ref={ref}
505 |     data-sidebar="menu-item"
506 |     className={cn("group/menu-item relative", className)}
507 |     {...props}
508 |   />
509 | ))
510 | SidebarMenuItem.displayName = "SidebarMenuItem"
511 | 
512 | const sidebarMenuButtonVariants = cva(
513 |   "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
514 |   {
515 |     variants: {
516 |       variant: {
517 |         default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
518 |         outline:
519 |           "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
520 |       },
521 |       size: {
522 |         default: "h-8 text-sm",
523 |         sm: "h-7 text-xs",
524 |         lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
525 |       },
526 |     },
527 |     defaultVariants: {
528 |       variant: "default",
529 |       size: "default",
530 |     },
531 |   }
532 | )
533 | 
534 | const SidebarMenuButton = React.forwardRef<
535 |   HTMLButtonElement,
536 |   React.ComponentProps<"button"> & {
537 |     asChild?: boolean
538 |     isActive?: boolean
539 |     tooltip?: string | React.ComponentProps<typeof TooltipContent>
540 |   } & VariantProps<typeof sidebarMenuButtonVariants>
541 | >(
542 |   (
543 |     {
544 |       asChild = false,
545 |       isActive = false,
546 |       variant = "default",
547 |       size = "default",
548 |       tooltip,
549 |       className,
550 |       ...props
551 |     },
552 |     ref
553 |   ) => {
554 |     const Comp = asChild ? Slot : "button"
555 |     const { isMobile, state } = useSidebar()
556 | 
557 |     const button = (
558 |       <Comp
559 |         ref={ref}
560 |         data-sidebar="menu-button"
561 |         data-size={size}
562 |         data-active={isActive}
563 |         className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
564 |         {...props}
565 |       />
566 |     )
567 | 
568 |     if (!tooltip) {
569 |       return button
570 |     }
571 | 
572 |     if (typeof tooltip === "string") {
573 |       tooltip = {
574 |         children: tooltip,
575 |       }
576 |     }
577 | 
578 |     return (
579 |       <Tooltip>
580 |         <TooltipTrigger asChild>{button}</TooltipTrigger>
581 |         <TooltipContent
582 |           side="right"
583 |           align="center"
584 |           hidden={state !== "collapsed" || isMobile}
585 |           {...tooltip}
586 |         />
587 |       </Tooltip>
588 |     )
589 |   }
590 | )
591 | SidebarMenuButton.displayName = "SidebarMenuButton"
592 | 
593 | const SidebarMenuAction = React.forwardRef<
594 |   HTMLButtonElement,
595 |   React.ComponentProps<"button"> & {
596 |     asChild?: boolean
597 |     showOnHover?: boolean
598 |   }
599 | >(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
600 |   const Comp = asChild ? Slot : "button"
601 | 
602 |   return (
603 |     <Comp
604 |       ref={ref}
605 |       data-sidebar="menu-action"
606 |       className={cn(
607 |         "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0",
608 |         // Increases the hit area of the button on mobile.
609 |         "after:absolute after:-inset-2 after:md:hidden",
610 |         "peer-data-[size=sm]/menu-button:top-1",
611 |         "peer-data-[size=default]/menu-button:top-1.5",
612 |         "peer-data-[size=lg]/menu-button:top-2.5",
613 |         "group-data-[collapsible=icon]:hidden",
614 |         showOnHover &&
615 |           "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
616 |         className
617 |       )}
618 |       {...props}
619 |     />
620 |   )
621 | })
622 | SidebarMenuAction.displayName = "SidebarMenuAction"
623 | 
624 | const SidebarMenuBadge = React.forwardRef<
625 |   HTMLDivElement,
626 |   React.ComponentProps<"div">
627 | >(({ className, ...props }, ref) => (
628 |   <div
629 |     ref={ref}
630 |     data-sidebar="menu-badge"
631 |     className={cn(
632 |       "absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none",
633 |       "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
634 |       "peer-data-[size=sm]/menu-button:top-1",
635 |       "peer-data-[size=default]/menu-button:top-1.5",
636 |       "peer-data-[size=lg]/menu-button:top-2.5",
637 |       "group-data-[collapsible=icon]:hidden",
638 |       className
639 |     )}
640 |     {...props}
641 |   />
642 | ))
643 | SidebarMenuBadge.displayName = "SidebarMenuBadge"
644 | 
645 | const SidebarMenuSkeleton = React.forwardRef<
646 |   HTMLDivElement,
647 |   React.ComponentProps<"div"> & {
648 |     showIcon?: boolean
649 |   }
650 | >(({ className, showIcon = false, ...props }, ref) => {
651 |   // Random width between 50 to 90%.
652 |   const width = React.useMemo(() => {
653 |     return `${Math.floor(Math.random() * 40) + 50}%`
654 |   }, [])
655 | 
656 |   return (
657 |     <div
658 |       ref={ref}
659 |       data-sidebar="menu-skeleton"
660 |       className={cn("rounded-md h-8 flex gap-2 px-2 items-center", className)}
661 |       {...props}
662 |     >
663 |       {showIcon && (
664 |         <Skeleton
665 |           className="size-4 rounded-md"
666 |           data-sidebar="menu-skeleton-icon"
667 |         />
668 |       )}
669 |       <Skeleton
670 |         className="h-4 flex-1 max-w-[--skeleton-width]"
671 |         data-sidebar="menu-skeleton-text"
672 |         style={
673 |           {
674 |             "--skeleton-width": width,
675 |           } as React.CSSProperties
676 |         }
677 |       />
678 |     </div>
679 |   )
680 | })
681 | SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton"
682 | 
683 | const SidebarMenuSub = React.forwardRef<
684 |   HTMLUListElement,
685 |   React.ComponentProps<"ul">
686 | >(({ className, ...props }, ref) => (
687 |   <ul
688 |     ref={ref}
689 |     data-sidebar="menu-sub"
690 |     className={cn(
691 |       "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
692 |       "group-data-[collapsible=icon]:hidden",
693 |       className
694 |     )}
695 |     {...props}
696 |   />
697 | ))
698 | SidebarMenuSub.displayName = "SidebarMenuSub"
699 | 
700 | const SidebarMenuSubItem = React.forwardRef<
701 |   HTMLLIElement,
702 |   React.ComponentProps<"li">
703 | >(({ ...props }, ref) => <li ref={ref} {...props} />)
704 | SidebarMenuSubItem.displayName = "SidebarMenuSubItem"
705 | 
706 | const SidebarMenuSubButton = React.forwardRef<
707 |   HTMLAnchorElement,
708 |   React.ComponentProps<"a"> & {
709 |     asChild?: boolean
710 |     size?: "sm" | "md"
711 |     isActive?: boolean
712 |   }
713 | >(({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
714 |   const Comp = asChild ? Slot : "a"
715 | 
716 |   return (
717 |     <Comp
718 |       ref={ref}
719 |       data-sidebar="menu-sub-button"
720 |       data-size={size}
721 |       data-active={isActive}
722 |       className={cn(
723 |         "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
724 |         "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
725 |         size === "sm" && "text-xs",
726 |         size === "md" && "text-sm",
727 |         "group-data-[collapsible=icon]:hidden",
728 |         className
729 |       )}
730 |       {...props}
731 |     />
732 |   )
733 | })
734 | SidebarMenuSubButton.displayName = "SidebarMenuSubButton"
735 | 
736 | export {
737 |   Sidebar,
738 |   SidebarContent,
739 |   SidebarFooter,
740 |   SidebarGroup,
741 |   SidebarGroupAction,
742 |   SidebarGroupContent,
743 |   SidebarGroupLabel,
744 |   SidebarHeader,
745 |   SidebarInput,
746 |   SidebarInset,
747 |   SidebarMenu,
748 |   SidebarMenuAction,
749 |   SidebarMenuBadge,
750 |   SidebarMenuButton,
751 |   SidebarMenuItem,
752 |   SidebarMenuSkeleton,
753 |   SidebarMenuSub,
754 |   SidebarMenuSubButton,
755 |   SidebarMenuSubItem,
756 |   SidebarProvider,
757 |   SidebarRail,
758 |   SidebarSeparator,
759 |   SidebarTrigger,
760 |   useSidebar,
761 | }
```

src/components/ui/skeleton.tsx
```
1 | import { cn } from "@/lib/utils"
2 | 
3 | function Skeleton({
4 |   className,
5 |   ...props
6 | }: React.HTMLAttributes<HTMLDivElement>) {
7 |   return (
8 |     <div
9 |       className={cn("animate-pulse rounded-md bg-muted", className)}
10 |       {...props}
11 |     />
12 |   )
13 | }
14 | 
15 | export { Skeleton }
```

src/components/ui/slider.tsx
```
1 | import * as React from "react"
2 | import * as SliderPrimitive from "@radix-ui/react-slider"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Slider = React.forwardRef<
7 |   React.ElementRef<typeof SliderPrimitive.Root>,
8 |   React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
9 | >(({ className, ...props }, ref) => (
10 |   <SliderPrimitive.Root
11 |     ref={ref}
12 |     className={cn(
13 |       "relative flex w-full touch-none select-none items-center",
14 |       className
15 |     )}
16 |     {...props}
17 |   >
18 |     <SliderPrimitive.Track className="relative h-3 w-full grow overflow-hidden rounded-full bg-secondary">
19 |       <SliderPrimitive.Range className="absolute h-full bg-story-orange-400" />
20 |     </SliderPrimitive.Track>
21 |     <SliderPrimitive.Thumb className="block h-8 w-8 rounded-full border-4 border-story-orange-400 bg-white drop-shadow-md ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
22 |   </SliderPrimitive.Root>
23 | ))
24 | Slider.displayName = SliderPrimitive.Root.displayName
25 | 
26 | export { Slider }
```

src/components/ui/sonner.tsx
```
1 | import { useTheme } from "next-themes"
2 | import { Toaster as Sonner } from "sonner"
3 | 
4 | type ToasterProps = React.ComponentProps<typeof Sonner>
5 | 
6 | const Toaster = ({ ...props }: ToasterProps) => {
7 |   const { theme = "system" } = useTheme()
8 | 
9 |   return (
10 |     <Sonner
11 |       theme={theme as ToasterProps["theme"]}
12 |       className="toaster group"
13 |       toastOptions={{
14 |         classNames: {
15 |           toast:
16 |             "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
17 |           description: "group-[.toast]:text-muted-foreground",
18 |           actionButton:
19 |             "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
20 |           cancelButton:
21 |             "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
22 |         },
23 |       }}
24 |       {...props}
25 |     />
26 |   )
27 | }
28 | 
29 | export { Toaster }
```

src/components/ui/switch.tsx
```
1 | import * as React from "react"
2 | import * as SwitchPrimitives from "@radix-ui/react-switch"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Switch = React.forwardRef<
7 |   React.ElementRef<typeof SwitchPrimitives.Root>,
8 |   React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
9 | >(({ className, ...props }, ref) => (
10 |   <SwitchPrimitives.Root
11 |     className={cn(
12 |       "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
13 |       className
14 |     )}
15 |     {...props}
16 |     ref={ref}
17 |   >
18 |     <SwitchPrimitives.Thumb
19 |       className={cn(
20 |         "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"
21 |       )}
22 |     />
23 |   </SwitchPrimitives.Root>
24 | ))
25 | Switch.displayName = SwitchPrimitives.Root.displayName
26 | 
27 | export { Switch }
```

src/components/ui/table.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | const Table = React.forwardRef<
6 |   HTMLTableElement,
7 |   React.HTMLAttributes<HTMLTableElement>
8 | >(({ className, ...props }, ref) => (
9 |   <div className="relative w-full overflow-auto">
10 |     <table
11 |       ref={ref}
12 |       className={cn("w-full caption-bottom text-sm", className)}
13 |       {...props}
14 |     />
15 |   </div>
16 | ))
17 | Table.displayName = "Table"
18 | 
19 | const TableHeader = React.forwardRef<
20 |   HTMLTableSectionElement,
21 |   React.HTMLAttributes<HTMLTableSectionElement>
22 | >(({ className, ...props }, ref) => (
23 |   <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
24 | ))
25 | TableHeader.displayName = "TableHeader"
26 | 
27 | const TableBody = React.forwardRef<
28 |   HTMLTableSectionElement,
29 |   React.HTMLAttributes<HTMLTableSectionElement>
30 | >(({ className, ...props }, ref) => (
31 |   <tbody
32 |     ref={ref}
33 |     className={cn("[&_tr:last-child]:border-0", className)}
34 |     {...props}
35 |   />
36 | ))
37 | TableBody.displayName = "TableBody"
38 | 
39 | const TableFooter = React.forwardRef<
40 |   HTMLTableSectionElement,
41 |   React.HTMLAttributes<HTMLTableSectionElement>
42 | >(({ className, ...props }, ref) => (
43 |   <tfoot
44 |     ref={ref}
45 |     className={cn(
46 |       "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
47 |       className
48 |     )}
49 |     {...props}
50 |   />
51 | ))
52 | TableFooter.displayName = "TableFooter"
53 | 
54 | const TableRow = React.forwardRef<
55 |   HTMLTableRowElement,
56 |   React.HTMLAttributes<HTMLTableRowElement>
57 | >(({ className, ...props }, ref) => (
58 |   <tr
59 |     ref={ref}
60 |     className={cn(
61 |       "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
62 |       className
63 |     )}
64 |     {...props}
65 |   />
66 | ))
67 | TableRow.displayName = "TableRow"
68 | 
69 | const TableHead = React.forwardRef<
70 |   HTMLTableCellElement,
71 |   React.ThHTMLAttributes<HTMLTableCellElement>
72 | >(({ className, ...props }, ref) => (
73 |   <th
74 |     ref={ref}
75 |     className={cn(
76 |       "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
77 |       className
78 |     )}
79 |     {...props}
80 |   />
81 | ))
82 | TableHead.displayName = "TableHead"
83 | 
84 | const TableCell = React.forwardRef<
85 |   HTMLTableCellElement,
86 |   React.TdHTMLAttributes<HTMLTableCellElement>
87 | >(({ className, ...props }, ref) => (
88 |   <td
89 |     ref={ref}
90 |     className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
91 |     {...props}
92 |   />
93 | ))
94 | TableCell.displayName = "TableCell"
95 | 
96 | const TableCaption = React.forwardRef<
97 |   HTMLTableCaptionElement,
98 |   React.HTMLAttributes<HTMLTableCaptionElement>
99 | >(({ className, ...props }, ref) => (
100 |   <caption
101 |     ref={ref}
102 |     className={cn("mt-4 text-sm text-muted-foreground", className)}
103 |     {...props}
104 |   />
105 | ))
106 | TableCaption.displayName = "TableCaption"
107 | 
108 | export {
109 |   Table,
110 |   TableHeader,
111 |   TableBody,
112 |   TableFooter,
113 |   TableHead,
114 |   TableRow,
115 |   TableCell,
116 |   TableCaption,
117 | }
```

src/components/ui/tabs.tsx
```
1 | import * as React from "react"
2 | import * as TabsPrimitive from "@radix-ui/react-tabs"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Tabs = TabsPrimitive.Root
7 | 
8 | const TabsList = React.forwardRef<
9 |   React.ElementRef<typeof TabsPrimitive.List>,
10 |   React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
11 | >(({ className, ...props }, ref) => (
12 |   <TabsPrimitive.List
13 |     ref={ref}
14 |     className={cn(
15 |       "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
16 |       className
17 |     )}
18 |     {...props}
19 |   />
20 | ))
21 | TabsList.displayName = TabsPrimitive.List.displayName
22 | 
23 | const TabsTrigger = React.forwardRef<
24 |   React.ElementRef<typeof TabsPrimitive.Trigger>,
25 |   React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
26 | >(({ className, ...props }, ref) => (
27 |   <TabsPrimitive.Trigger
28 |     ref={ref}
29 |     className={cn(
30 |       "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
31 |       className
32 |     )}
33 |     {...props}
34 |   />
35 | ))
36 | TabsTrigger.displayName = TabsPrimitive.Trigger.displayName
37 | 
38 | const TabsContent = React.forwardRef<
39 |   React.ElementRef<typeof TabsPrimitive.Content>,
40 |   React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
41 | >(({ className, ...props }, ref) => (
42 |   <TabsPrimitive.Content
43 |     ref={ref}
44 |     className={cn(
45 |       "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
46 |       className
47 |     )}
48 |     {...props}
49 |   />
50 | ))
51 | TabsContent.displayName = TabsPrimitive.Content.displayName
52 | 
53 | export { Tabs, TabsList, TabsTrigger, TabsContent }
```

src/components/ui/textarea.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | export interface TextareaProps
6 |   extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}
7 | 
8 | const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
9 |   ({ className, ...props }, ref) => {
10 |     return (
11 |       <textarea
12 |         className={cn(
13 |           "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
14 |           className
15 |         )}
16 |         ref={ref}
17 |         {...props}
18 |       />
19 |     )
20 |   }
21 | )
22 | Textarea.displayName = "Textarea"
23 | 
24 | export { Textarea }
```

src/components/ui/toast.tsx
```
1 | import * as React from "react"
2 | import * as ToastPrimitives from "@radix-ui/react-toast"
3 | import { cva, type VariantProps } from "class-variance-authority"
4 | import { X } from "lucide-react"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | const ToastProvider = ToastPrimitives.Provider
9 | 
10 | const ToastViewport = React.forwardRef<
11 |   React.ElementRef<typeof ToastPrimitives.Viewport>,
12 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
13 | >(({ className, ...props }, ref) => (
14 |   <ToastPrimitives.Viewport
15 |     ref={ref}
16 |     className={cn(
17 |       "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
18 |       className
19 |     )}
20 |     {...props}
21 |   />
22 | ))
23 | ToastViewport.displayName = ToastPrimitives.Viewport.displayName
24 | 
25 | const toastVariants = cva(
26 |   "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
27 |   {
28 |     variants: {
29 |       variant: {
30 |         default: "border bg-background text-foreground",
31 |         destructive:
32 |           "destructive group border-destructive bg-destructive text-destructive-foreground",
33 |       },
34 |     },
35 |     defaultVariants: {
36 |       variant: "default",
37 |     },
38 |   }
39 | )
40 | 
41 | const Toast = React.forwardRef<
42 |   React.ElementRef<typeof ToastPrimitives.Root>,
43 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
44 |     VariantProps<typeof toastVariants>
45 | >(({ className, variant, ...props }, ref) => {
46 |   return (
47 |     <ToastPrimitives.Root
48 |       ref={ref}
49 |       className={cn(toastVariants({ variant }), className)}
50 |       {...props}
51 |     />
52 |   )
53 | })
54 | Toast.displayName = ToastPrimitives.Root.displayName
55 | 
56 | const ToastAction = React.forwardRef<
57 |   React.ElementRef<typeof ToastPrimitives.Action>,
58 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
59 | >(({ className, ...props }, ref) => (
60 |   <ToastPrimitives.Action
61 |     ref={ref}
62 |     className={cn(
63 |       "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
64 |       className
65 |     )}
66 |     {...props}
67 |   />
68 | ))
69 | ToastAction.displayName = ToastPrimitives.Action.displayName
70 | 
71 | const ToastClose = React.forwardRef<
72 |   React.ElementRef<typeof ToastPrimitives.Close>,
73 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
74 | >(({ className, ...props }, ref) => (
75 |   <ToastPrimitives.Close
76 |     ref={ref}
77 |     className={cn(
78 |       "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
79 |       className
80 |     )}
81 |     toast-close=""
82 |     {...props}
83 |   >
84 |     <X className="h-4 w-4" />
85 |   </ToastPrimitives.Close>
86 | ))
87 | ToastClose.displayName = ToastPrimitives.Close.displayName
88 | 
89 | const ToastTitle = React.forwardRef<
90 |   React.ElementRef<typeof ToastPrimitives.Title>,
91 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
92 | >(({ className, ...props }, ref) => (
93 |   <ToastPrimitives.Title
94 |     ref={ref}
95 |     className={cn("text-sm font-semibold", className)}
96 |     {...props}
97 |   />
98 | ))
99 | ToastTitle.displayName = ToastPrimitives.Title.displayName
100 | 
101 | const ToastDescription = React.forwardRef<
102 |   React.ElementRef<typeof ToastPrimitives.Description>,
103 |   React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
104 | >(({ className, ...props }, ref) => (
105 |   <ToastPrimitives.Description
106 |     ref={ref}
107 |     className={cn("text-sm opacity-90", className)}
108 |     {...props}
109 |   />
110 | ))
111 | ToastDescription.displayName = ToastPrimitives.Description.displayName
112 | 
113 | type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>
114 | 
115 | type ToastActionElement = React.ReactElement<typeof ToastAction>
116 | 
117 | export {
118 |   type ToastProps,
119 |   type ToastActionElement,
120 |   ToastProvider,
121 |   ToastViewport,
122 |   Toast,
123 |   ToastTitle,
124 |   ToastDescription,
125 |   ToastClose,
126 |   ToastAction,
127 | }
```

src/components/ui/toaster.tsx
```
1 | import { useToast } from "@/hooks/use-toast"
2 | import {
3 |   Toast,
4 |   ToastClose,
5 |   ToastDescription,
6 |   ToastProvider,
7 |   ToastTitle,
8 |   ToastViewport,
9 | } from "@/components/ui/toast"
10 | 
11 | export function Toaster() {
12 |   const { toasts } = useToast()
13 | 
14 |   return (
15 |     <ToastProvider>
16 |       {toasts.map(function ({ id, title, description, action, ...props }) {
17 |         return (
18 |           <Toast key={id} {...props}>
19 |             <div className="grid gap-1">
20 |               {title && <ToastTitle>{title}</ToastTitle>}
21 |               {description && (
22 |                 <ToastDescription>{description}</ToastDescription>
23 |               )}
24 |             </div>
25 |             {action}
26 |             <ToastClose />
27 |           </Toast>
28 |         )
29 |       })}
30 |       <ToastViewport />
31 |     </ToastProvider>
32 |   )
33 | }
```

src/components/ui/toggle-group.tsx
```
1 | import * as React from "react"
2 | import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
3 | import { type VariantProps } from "class-variance-authority"
4 | 
5 | import { cn } from "@/lib/utils"
6 | import { toggleVariants } from "@/components/ui/toggle"
7 | 
8 | const ToggleGroupContext = React.createContext<
9 |   VariantProps<typeof toggleVariants>
10 | >({
11 |   size: "default",
12 |   variant: "default",
13 | })
14 | 
15 | const ToggleGroup = React.forwardRef<
16 |   React.ElementRef<typeof ToggleGroupPrimitive.Root>,
17 |   React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
18 |     VariantProps<typeof toggleVariants>
19 | >(({ className, variant, size, children, ...props }, ref) => (
20 |   <ToggleGroupPrimitive.Root
21 |     ref={ref}
22 |     className={cn("flex items-center justify-center gap-1", className)}
23 |     {...props}
24 |   >
25 |     <ToggleGroupContext.Provider value={{ variant, size }}>
26 |       {children}
27 |     </ToggleGroupContext.Provider>
28 |   </ToggleGroupPrimitive.Root>
29 | ))
30 | 
31 | ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName
32 | 
33 | const ToggleGroupItem = React.forwardRef<
34 |   React.ElementRef<typeof ToggleGroupPrimitive.Item>,
35 |   React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
36 |     VariantProps<typeof toggleVariants>
37 | >(({ className, children, variant, size, ...props }, ref) => {
38 |   const context = React.useContext(ToggleGroupContext)
39 | 
40 |   return (
41 |     <ToggleGroupPrimitive.Item
42 |       ref={ref}
43 |       className={cn(
44 |         toggleVariants({
45 |           variant: context.variant || variant,
46 |           size: context.size || size,
47 |         }),
48 |         className
49 |       )}
50 |       {...props}
51 |     >
52 |       {children}
53 |     </ToggleGroupPrimitive.Item>
54 |   )
55 | })
56 | 
57 | ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName
58 | 
59 | export { ToggleGroup, ToggleGroupItem }
```

src/components/ui/toggle.tsx
```
1 | import * as React from "react"
2 | import * as TogglePrimitive from "@radix-ui/react-toggle"
3 | import { cva, type VariantProps } from "class-variance-authority"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const toggleVariants = cva(
8 |   "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",
9 |   {
10 |     variants: {
11 |       variant: {
12 |         default: "bg-transparent",
13 |         outline:
14 |           "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
15 |       },
16 |       size: {
17 |         default: "h-10 px-3",
18 |         sm: "h-9 px-2.5",
19 |         lg: "h-11 px-5",
20 |       },
21 |     },
22 |     defaultVariants: {
23 |       variant: "default",
24 |       size: "default",
25 |     },
26 |   }
27 | )
28 | 
29 | const Toggle = React.forwardRef<
30 |   React.ElementRef<typeof TogglePrimitive.Root>,
31 |   React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &
32 |     VariantProps<typeof toggleVariants>
33 | >(({ className, variant, size, ...props }, ref) => (
34 |   <TogglePrimitive.Root
35 |     ref={ref}
36 |     className={cn(toggleVariants({ variant, size, className }))}
37 |     {...props}
38 |   />
39 | ))
40 | 
41 | Toggle.displayName = TogglePrimitive.Root.displayName
42 | 
43 | export { Toggle, toggleVariants }
```

src/components/ui/tooltip.tsx
```
1 | import * as React from "react"
2 | import * as TooltipPrimitive from "@radix-ui/react-tooltip"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const TooltipProvider = TooltipPrimitive.Provider
7 | 
8 | const Tooltip = TooltipPrimitive.Root
9 | 
10 | const TooltipTrigger = TooltipPrimitive.Trigger
11 | 
12 | const TooltipContent = React.forwardRef<
13 |   React.ElementRef<typeof TooltipPrimitive.Content>,
14 |   React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
15 | >(({ className, sideOffset = 4, ...props }, ref) => (
16 |   <TooltipPrimitive.Content
17 |     ref={ref}
18 |     sideOffset={sideOffset}
19 |     className={cn(
20 |       "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
21 |       className
22 |     )}
23 |     {...props}
24 |   />
25 | ))
26 | TooltipContent.displayName = TooltipPrimitive.Content.displayName
27 | 
28 | export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

src/components/ui/use-toast.ts
```
1 | import { useToast, toast } from "@/hooks/use-toast";
2 | 
3 | export { useToast, toast };
```

src/services/ai/ChallengeService.ts
```
1 | import {
2 |   Challenge,
3 |   ChallengeCategory,
4 |   ChallengeQuestion,
5 |   ProfileSettings,
6 |   Story,
7 | } from "../../types";
8 | 
9 | import { supabase } from "../../supabaseClient";
10 | 
11 | /**
12 |  * Servicio para interactuar con la Edge Function challenge
13 |  */
14 | export class ChallengeService {
15 |   /**
16 |    * Generates a challenge question based on the story
17 |    */
18 |   public static async generateChallengeQuestion(
19 |     story: Story,
20 |     category: ChallengeCategory,
21 |     profileSettings: ProfileSettings,
22 |     targetLanguage?: string,
23 |   ): Promise<ChallengeQuestion> {
24 |     try {
25 |       console.log(
26 |         "Enviando solicitud a la Edge Function challenge (generateChallengeQuestion)...",
27 |       );
28 | 
29 |       const { data, error } = await supabase.functions.invoke("challenge", {
30 |         body: {
31 |           action: "createChallenge",
32 |           story,
33 |           category,
34 |           profileSettings,
35 |           targetLanguage,
36 |         },
37 |       });
38 | 
39 |       if (error) {
40 |         console.error("Error en Edge Function challenge:", error);
41 |         throw error;
42 |       }
43 | 
44 |       if (!data || !data.questions || !data.questions[0]) {
45 |         throw new Error("La respuesta de challenge no contiene preguntas");
46 |       }
47 | 
48 |       return data.questions[0];
49 |     } catch (error) {
50 |       console.error("Error generating challenge question:", error);
51 |       throw error;
52 |     }
53 |   }
54 | 
55 |   /**
56 |    * Creates a new challenge with a question
57 |    */
58 |   public static async createChallenge(
59 |     story: Story,
60 |     category: ChallengeCategory,
61 |     profileSettings: ProfileSettings,
62 |     targetLanguage?: string,
63 |   ): Promise<Challenge> {
64 |     try {
65 |       console.log(
66 |         "Enviando solicitud a la Edge Function challenge (createChallenge)...",
67 |       );
68 | 
69 |       const { data, error } = await supabase.functions.invoke("challenge", {
70 |         body: {
71 |           action: "createChallenge",
72 |           story,
73 |           category,
74 |           profileSettings,
75 |           targetLanguage,
76 |         },
77 |       });
78 | 
79 |       if (error) {
80 |         console.error("Error en Edge Function challenge:", error);
81 |         throw error;
82 |       }
83 | 
84 |       if (!data || !data.id || !data.questions) {
85 |         throw new Error("La respuesta de challenge no tiene un formato válido");
86 |       }
87 | 
88 |       return data as Challenge;
89 |     } catch (error) {
90 |       console.error("Error creating challenge:", error);
91 |       throw error;
92 |     }
93 |   }
94 | 
95 |   /**
96 |    * Returns list of available languages for language challenges
97 |    */
98 |   public static async getAvailableLanguages(
99 |     currentLanguage: string,
100 |   ): Promise<{ code: string; name: string }[]> {
101 |     try {
102 |       console.log(
103 |         "Enviando solicitud a la Edge Function challenge (getLanguages)...",
104 |       );
105 | 
106 |       const { data, error } = await supabase.functions.invoke("challenge", {
107 |         body: {
108 |           action: "getLanguages",
109 |           profileSettings: {
110 |             language: currentLanguage,
111 |           },
112 |         },
113 |       });
114 | 
115 |       if (error) {
116 |         console.error("Error en Edge Function challenge:", error);
117 |         throw error;
118 |       }
119 | 
120 |       if (!data || !data.languages) {
121 |         throw new Error("La respuesta de challenge no contiene idiomas");
122 |       }
123 | 
124 |       return data.languages;
125 |     } catch (error) {
126 |       console.error("Error getting available languages:", error);
127 | 
128 |       // Fallback languages if the API call fails
129 |       const languages = [
130 |         { code: "en", name: "Inglés" },
131 |         { code: "fr", name: "Francés" },
132 |         { code: "de", name: "Alemán" },
133 |         { code: "it", name: "Italiano" },
134 |         { code: "pt", name: "Portugués" },
135 |       ];
136 | 
137 |       // Filter out the current language
138 |       return languages.filter((lang) => lang.code !== currentLanguage);
139 |     }
140 |   }
141 | }
```

src/services/ai/GenerateStoryService.ts
```
1 | // src/services/ai/GenerateStoryService.ts
2 | import { StoryOptions, Story } from "../../types"; // Importar Story si no está
3 | import { supabase } from "../../supabaseClient";
4 | 
5 | export interface GenerateStoryParams {
6 |   options: Partial<StoryOptions>; // O el tipo completo si siempre está completo
7 |   language?: string;
8 |   childAge?: number;
9 |   specialNeed?: string;
10 |   additionalDetails?: string; // <-- Añadir nueva propiedad
11 | }
12 | 
13 | // Definir el tipo de respuesta esperada de la Edge Function
14 | export interface GenerateStoryResponse {
15 |   content: string;
16 |   title: string;
17 | }
18 | 
19 | export class GenerateStoryService {
20 |   /**
21 |    * Generates initial story content and title using the 'generate-story' Edge Function.
22 |    */
23 |   public static async generateStoryWithAI(params: GenerateStoryParams): Promise<GenerateStoryResponse> {
24 |     try {
25 |       console.log('Enviando solicitud a la Edge Function generate-story con params:', params); // Loguear parámetros
26 | 
27 |       // Asegúrate de pasar el token de autenticación si la función lo requiere (lo requiere)
28 |       const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
29 |       if (sessionError || !sessionData.session) {
30 |         throw new Error(sessionError?.message || 'Usuario no autenticado.');
31 |       }
32 |       const token = sessionData.session.access_token;
33 | 
34 |       // DEBUG: Log the exact payload being sent
35 |       console.log(">>> Payload being sent to generate-story:", JSON.stringify(params, null, 2));
36 | 
37 |       const { data, error } = await supabase.functions.invoke<GenerateStoryResponse>('generate-story', { // Especificar tipo de respuesta <T>
38 |         body: params, // El cuerpo ya contiene las opciones, idioma, etc. y additionalDetails
39 |         headers: {
40 |           'Authorization': `Bearer ${token}` // Pasar el token
41 |         }
42 |       });
43 | 
44 |       if (error) {
45 |         console.error('Error en Edge Function generate-story:', error);
46 |         // Puedes intentar obtener más detalles del error si es un HttpError
47 |         let message = error.message;
48 |         if ((error as any).context) { // Supabase FunctionsHttpError tiene 'context'
49 |           message = `${message} - ${JSON.stringify((error as any).context)}`;
50 |         }
51 |         throw new Error(message);
52 |       }
53 | 
54 |       // Validar que la respuesta tiene el formato esperado { content: string, title: string }
55 |       if (!data || typeof data.content !== 'string' || typeof data.title !== 'string') {
56 |         console.error('Respuesta inesperada de generate-story:', data);
57 |         throw new Error('La respuesta de generate-story no contiene contenido y título válidos.');
58 |       }
59 | 
60 |       console.log('Respuesta de generate-story recibida (título):', data.title);
61 |       return data; // Devolver el objeto { content, title } completo
62 | 
63 |     } catch (error) {
64 |       console.error('Error en GenerateStoryService.generateStoryWithAI:', error);
65 |       // Relanzar para que el llamador (storyGenerator) pueda manejarlo
66 |       throw error;
67 |     }
68 |   }
69 | }
```

src/services/ai/StoryContinuationService.ts
```
1 | // src/services/StoryContinuationService.ts
2 | import { Story, StoryChapter } from "../../types"; // Importa tus tipos
3 | import { supabase } from "../../supabaseClient";
4 | 
5 | // Definir el tipo de respuesta esperada para continuaciones
6 | interface ContinuationResponse {
7 |   content: string;
8 |   title: string;
9 | }
10 | // Definir tipo para opciones generadas
11 | interface OptionsResponse {
12 |   options: { summary: string }[];
13 | }
14 | 
15 | 
16 | export class StoryContinuationService {
17 | 
18 |   /**
19 |    * Llama a la Edge Function 'story-continuation' para diferentes acciones.
20 |    * @param action La acción a realizar ('generateOptions', 'freeContinuation', etc.)
21 |    * @param payload Los datos específicos para esa acción.
22 |    * @returns La respuesta de la Edge Function (depende de la acción).
23 |    */
24 |   private static async invokeContinuationFunction<T = any>(action: string, payload: object): Promise<T> {
25 |     console.log(`Enviando solicitud a la Edge Function story-continuation (action: ${action})...`);
26 | 
27 |     const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
28 |     if (sessionError || !sessionData.session) {
29 |       throw new Error(sessionError?.message || 'Usuario no autenticado.');
30 |     }
31 |     const token = sessionData.session.access_token;
32 | 
33 |     const bodyPayload = {
34 |       action: action,
35 |       ...payload // Incluir el resto de los datos (story, chapters, etc.)
36 |     };
37 | 
38 |     try {
39 |       const jsonBodyString = JSON.stringify(bodyPayload, null, 2); // Pretty print
40 |       console.log(`[StoryContinuationService_DEBUG] Body payload AFTER stringify (length: ${jsonBodyString?.length}):\n---\n${jsonBodyString}\n---`);
41 |     } catch (stringifyError) {
42 |         console.error('[StoryContinuationService_DEBUG] Error during JSON.stringify:', stringifyError, 'Payload was:', bodyPayload);
43 |         throw new Error('Failed to stringify payload before sending to edge function.'); // Re-throw or handle
44 |     }
45 | 
46 |     const { data, error } = await supabase.functions.invoke<T>('story-continuation', { // Usar tipo genérico o específico
47 |       body: bodyPayload, // PASAR EL OBJETO DIRECTAMENTE
48 |       headers: {
49 |         'Authorization': `Bearer ${token}`
50 |         // 'Content-Type': 'application/json' // DEJAR QUE INVOKE LO MANEJE
51 |       }
52 |     });
53 | 
54 |     if (error) {
55 |       console.error(`Error en Edge Function story-continuation (action: ${action}):`, error);
56 |       let message = error.message;
57 |       if ((error as any).context) {
58 |         message = `${message} - ${JSON.stringify((error as any).context)}`;
59 |       }
60 |       throw new Error(message);
61 |     }
62 | 
63 |     console.log(`Respuesta recibida de story-continuation (action: ${action})`);
64 |     return data as T; // Devolver datos (casteo puede ser necesario)
65 |   }
66 | 
67 |   /**
68 |    * Genera opciones de continuación.
69 |    */
70 |   public static async generateContinuationOptions(
71 |     story: Story, 
72 |     chapters: StoryChapter[],
73 |     childAge?: number,
74 |     specialNeed?: string | null
75 |   ): Promise<OptionsResponse> {
76 |     const response = await this.invokeContinuationFunction<OptionsResponse>('generateOptions', { 
77 |       story, 
78 |       chapters, 
79 |       language: story.options.language,
80 |       childAge,
81 |       specialNeed
82 |     });
83 |     if (!response || !Array.isArray(response.options)) {
84 |       console.error("Respuesta inválida para generateOptions:", response);
85 |       throw new Error("No se pudieron generar las opciones de continuación.");
86 |     }
87 |     return response;
88 |   }
89 | 
90 |   /**
91 |    * Genera una continuación libre (contenido y título).
92 |    */
93 |   public static async generateFreeContinuation(story: Story, chapters: StoryChapter[]): Promise<ContinuationResponse> {
94 |     const response = await this.invokeContinuationFunction<ContinuationResponse>('freeContinuation', { 
95 |       story, 
96 |       chapters, 
97 |       language: story.options.language 
98 |     });
99 |     if (!response || typeof response.content !== 'string' || typeof response.title !== 'string') {
100 |       console.error("Respuesta inválida para freeContinuation:", response);
101 |       throw new Error("No se pudo generar la continuación libre.");
102 |     }
103 |     return response;
104 |   }
105 | 
106 |   /**
107 |    * Genera una continuación basada en una opción seleccionada (contenido y título).
108 |    */
109 |   public static async generateOptionContinuation(story: Story, chapters: StoryChapter[], selectedOptionSummary: string): Promise<ContinuationResponse> {
110 |     const response = await this.invokeContinuationFunction<ContinuationResponse>('optionContinuation', { 
111 |       story, 
112 |       chapters, 
113 |       selectedOptionSummary, 
114 |       language: story.options.language 
115 |     });
116 |     if (!response || typeof response.content !== 'string' || typeof response.title !== 'string') {
117 |       console.error("Respuesta inválida para optionContinuation:", response);
118 |       throw new Error("No se pudo generar la continuación de opción.");
119 |     }
120 |     return response;
121 |   }
122 | 
123 |   /**
124 |    * Genera una continuación basada en la dirección del usuario (contenido y título).
125 |    */
126 |   public static async generateDirectedContinuation(story: Story, chapters: StoryChapter[], userDirection: string): Promise<ContinuationResponse> {
127 |     const response = await this.invokeContinuationFunction<ContinuationResponse>('directedContinuation', { 
128 |       story, 
129 |       chapters, 
130 |       userDirection, 
131 |       language: story.options.language 
132 |     });
133 |     if (!response || typeof response.content !== 'string' || typeof response.title !== 'string') {
134 |       console.error("Respuesta inválida para directedContinuation:", response);
135 |       throw new Error("No se pudo generar la continuación dirigida.");
136 |     }
137 |     return response;
138 |   }
139 | 
140 |   // generateChapterTitle ya no es necesaria para el flujo principal
141 |   // public static async generateChapterTitle(content: string): Promise<{ title: string }> {
142 |   //    // ... (código anterior si quieres mantenerla por alguna razón, pero no se llamará desde generateStory)
143 |   // }
144 | }
```

src/services/ai/imageGenerationService.ts
```
1 | import { SYSTEM_PROMPT_BASE, IMAGES_TYPE } from '@/constants/story-images.constant';
2 | import { supabase } from '@/supabaseClient';
3 | import OpenAI from "openai";
4 | 
5 | interface ImageGenerationOptions {
6 |   title: string;
7 |   content: string;
8 |   storyId: string;
9 |   chapterId?: string | number;
10 | }
11 | 
12 | interface GeneratedImage {
13 |   type: string;
14 |   url: string;
15 |   prompt: string;
16 | }
17 | 
18 | interface ImageGenerationResult {
19 |   success: boolean;
20 |   images: GeneratedImage[];
21 |   error?: string;
22 | }
23 | 
24 | /**
25 |  * Service for generating story images using OpenAI GPT-4.1-mini with image generation tools
26 |  */
27 | export class ImageGenerationService {
28 |   private static readonly MODEL = 'gpt-image-1';
29 |   private static openai = new OpenAI({
30 |     apiKey: import.meta.env.VITE_OPEN_AI_API_KEY,
31 |     dangerouslyAllowBrowser: true // Solo para desarrollo, en producción usar Edge Functions
32 |   });
33 | 
34 |   /**
35 |    * Generates all story images (cover, scenes, character) asynchronously
36 |    * @param options Story data for image generation
37 |    * @returns Promise with generation results
38 |    */
39 |   static async generateStoryImages(options: ImageGenerationOptions): Promise<ImageGenerationResult> {
40 |     const { title, content, storyId, chapterId = 1 } = options;
41 |     
42 |     try {
43 |       console.log('[ImageGeneration] Starting image generation for story:', storyId);
44 |       
45 |       // Create prompts for each image type
46 |       const prompts = this.createImagePrompts(title, content);
47 |       
48 |       // Generate all images concurrently for speed
49 |       const imagePromises = Object.entries(prompts).map(([imageType, prompt]) =>
50 |         this.generateSingleImage(imageType, prompt, storyId, chapterId)
51 |       );
52 |       
53 |       const results = await Promise.allSettled(imagePromises);
54 |       
55 |       // Process results
56 |       const successfulImages: GeneratedImage[] = [];
57 |       const errors: string[] = [];
58 |       
59 |       results.forEach((result, index) => {
60 |         const imageType = Object.keys(prompts)[index];
61 |         
62 |         if (result.status === 'fulfilled' && result.value.success) {
63 |           successfulImages.push(result.value.image!);
64 |         } else if (result.status === 'rejected') {
65 |           errors.push(`${imageType}: ${result.reason}`);
66 |         } else if (result.status === 'fulfilled' && !result.value.success) {
67 |           errors.push(`${imageType}: ${result.value.error}`);
68 |         }
69 |       });
70 |       
71 |       console.log(`[ImageGeneration] Generated ${successfulImages.length}/${Object.keys(prompts).length} images successfully`);
72 |       
73 |       return {
74 |         success: successfulImages.length > 0,
75 |         images: successfulImages,
76 |         error: errors.length > 0 ? errors.join('; ') : undefined
77 |       };
78 |       
79 |     } catch (error) {
80 |       console.error('[ImageGeneration] Error generating story images:', error);
81 |       return {
82 |         success: false,
83 |         images: [],
84 |         error: error instanceof Error ? error.message : 'Error desconocido'
85 |       };
86 |     }
87 |   }
88 | 
89 |   /**
90 |    * Creates specific prompts for each image type
91 |    * CHARACTER is generated first to establish visual consistency for scenes
92 |    */
93 |   private static createImagePrompts(title: string, content: string): Record<string, string> {
94 |     const baseContext = `**Cuento:**
95 | Título: ${title}
96 | Cuento: ${content}`;
97 | 
98 |     return {
99 |     [IMAGES_TYPE.COVER]: `${SYSTEM_PROMPT_BASE}
100 | 
101 | ${baseContext}
102 | 
103 | Genera una imagen de PORTADA que capture la esencia del cuento. Debe incluir el título de manera artística y elementos visuales que representen la historia principal, manteniendo la misma estética del personaje principal. Estilo acuarela tradicional de cuento infantil.`,
104 | 
105 |       [IMAGES_TYPE.SCENE_1]: `${SYSTEM_PROMPT_BASE}
106 | 
107 | ${baseContext}
108 | 
109 | Genera una imagen de la PRIMERA ESCENA más importante del cuento, donde el PERSONAJE PRINCIPAL debe ser el elemento central de la composición. Debe mostrar un momento clave de la historia con el protagonista en acción, manteniendo las características visuales establecidas del personaje. Estilo acuarela tradicional de cuento infantil.`,
110 | 
111 |       [IMAGES_TYPE.SCENE_2]: `${SYSTEM_PROMPT_BASE}
112 | 
113 | ${baseContext}
114 | 
115 | Genera una imagen de la SEGUNDA ESCENA más importante del cuento, donde el PERSONAJE PRINCIPAL debe ser prominente en la escena. Debe representar otro momento crucial diferente al anterior, mostrando al protagonista en una situación distinta pero manteniendo continuidad visual y las características del personaje establecidas. Estilo acuarela tradicional de cuento infantil.`
116 |     };
117 |   }
118 | 
119 |   /**
120 |    * Generates a single image and uploads it to Supabase
121 |    */
122 |   private static async generateSingleImage(
123 |     imageType: string, 
124 |     prompt: string, 
125 |     storyId: string, 
126 |     chapterId: string | number
127 |   ): Promise<{ success: boolean; image?: GeneratedImage; error?: string }> {
128 |     try {
129 |       console.log(`[ImageGeneration] Generating ${imageType} image...`);
130 |       
131 |       // Generate image with OpenAI
132 |       const imageBase64 = await this.callOpenAIImageGeneration(prompt);
133 |       
134 |       if (!imageBase64) {
135 |         throw new Error('No image data returned from OpenAI');
136 |       }
137 |       
138 |       // Upload to Supabase via Edge Function
139 |       const uploadResult = await this.uploadImageToSupabase(imageBase64, imageType, storyId, chapterId);
140 |       
141 |       if (!uploadResult.success) {
142 |         throw new Error(`Upload failed: ${uploadResult.error}`);
143 |       }
144 |       
145 |       console.log(`[ImageGeneration] Successfully generated and uploaded ${imageType}`);
146 |       
147 |       return {
148 |         success: true,
149 |         image: {
150 |           type: imageType,
151 |           url: uploadResult.publicUrl!,
152 |           prompt: prompt
153 |         }
154 |       };
155 |       
156 |     } catch (error) {
157 |       console.error(`[ImageGeneration] Error generating ${imageType}:`, error);
158 |       return {
159 |         success: false,
160 |         error: error instanceof Error ? error.message : 'Error desconocido'
161 |       };
162 |     }
163 |   }
164 | 
165 |   /**
166 |    * Calls OpenAI API to generate image using GPT-4.1-mini with image generation tools
167 |    */
168 |   private static async callOpenAIImageGeneration(prompt: string): Promise<string | null> {
169 |     try {
170 |       const response = await this.openai.images.generate({
171 |         model: this.MODEL,
172 |         prompt: prompt,
173 |         n: 1,
174 |         quality: "medium",
175 |         size: "1024x1536",
176 |         background: "opaque"
177 |       });
178 | 
179 | 
180 |       return response.data[0].b64_json;
181 |     } catch (error) {
182 |       console.error('[ImageGeneration] OpenAI API error:', error);
183 |       throw new Error(`OpenAI API error: ${error instanceof Error ? error.message : 'Unknown error'}`);
184 |     }
185 |   }
186 | 
187 |   /**
188 |    * Uploads generated image to Supabase storage via Edge Function
189 |    */
190 |   private static async uploadImageToSupabase(
191 |     imageBase64: string, 
192 |     imageType: string, 
193 |     storyId: string, 
194 |     chapterId: string | number
195 |   ): Promise<{ success: boolean; publicUrl?: string; error?: string }> {
196 |     try {
197 |       console.log(`[ImageGeneration] Uploading ${imageType} via Supabase invoke...`);
198 | 
199 |       const { data: functionResponse, error: functionError } = await supabase.functions.invoke(
200 |         'upload-story-image',
201 |         {
202 |           body: {
203 |             imageBase64,
204 |             imageType,
205 |             storyId,
206 |             chapterId: chapterId.toString()
207 |           }
208 |         }
209 |       );
210 | 
211 |       if (functionError) {
212 |         console.error('[ImageGeneration] Function error:', functionError);
213 |         throw new Error(`Function error: ${functionError.message}`);
214 |       }
215 | 
216 |       if (!functionResponse?.success) {
217 |         const errorMsg = functionResponse?.error || functionResponse?.details || 'Unknown upload error';
218 |         throw new Error(`Upload failed: ${errorMsg}`);
219 |       }
220 | 
221 |       console.log(`[ImageGeneration] Successfully uploaded ${imageType}:`, functionResponse.publicUrl);
222 | 
223 |       return {
224 |         success: true,
225 |         publicUrl: functionResponse.publicUrl
226 |       };
227 |       
228 |     } catch (error) {
229 |       console.error('[ImageGeneration] Upload error:', error);
230 |       return {
231 |         success: false,
232 |         error: error instanceof Error ? error.message : 'Error de subida'
233 |       };
234 |     }
235 |   }
236 | } 
```

src/services/ai/ttsService.ts
```
1 | // src/services/ai/ttsService.ts
2 | import { SYSTEM_PROMPT } from '@/constants/story-voices.constant';
3 | import OpenAI from 'openai';
4 | 
5 | /**
6 |  * Servicio para generar audio a partir de texto usando la API REST de OpenAI
7 |  * No usa Supabase ni funciones edge; realiza un fetch directo con tu clave.
8 |  */
9 | export type OpenAIVoiceType =
10 |   | 'alloy'
11 |   | 'echo'
12 |   | 'fable'
13 |   | 'onyx'
14 |   | 'nova'
15 |   | 'shimmer'
16 |   | 'coral'
17 |   | 'sage'
18 |   | 'ash';
19 | 
20 | export interface TTSOptions {
21 |   text: string;
22 |   voice?: OpenAIVoiceType;
23 |   model?: string;
24 |   instructions?: string;
25 | }
26 | 
27 | interface OpenAIError {
28 |   status?: number;
29 |   code?: string | number;
30 |   message?: string;
31 | }
32 | 
33 | function isOpenAIError(error: unknown): error is OpenAIError {
34 |   return typeof error === 'object' && error !== null;
35 | }
36 | 
37 | // Voces disponibles en OpenAI
38 | export const OPENAI_VOICES = [
39 |   { id: 'alloy' as const, name: 'Alloy', description: 'Alloy (Neutral)' },
40 |   { id: 'echo' as const, name: 'Echo', description: 'Echo (Masculino)' },
41 |   { id: 'fable' as const, name: 'Fable', description: 'Fable (Fantasía)' },
42 |   { id: 'onyx' as const, name: 'Onyx', description: 'Onyx (Masculino)' },
43 |   { id: 'nova' as const, name: 'Nova', description: 'Nova (Femenina)' },
44 |   { id: 'shimmer' as const, name: 'Shimmer', description: 'Shimmer (Femenina)' },
45 |   { id: 'coral' as const, name: 'Coral', description: 'Coral (Femenina)' },
46 |   { id: 'sage' as const, name: 'Sage', description: 'Sage (Narrador)' },
47 |   { id: 'ash' as const, name: 'Ash', description: 'Ash (Juvenil)' }
48 | ];
49 | 
50 | // Inicializar cliente de OpenAI
51 | const openai = new OpenAI({
52 |   apiKey: import.meta.env.VITE_OPEN_AI_API_KEY,
53 |   dangerouslyAllowBrowser: true // Permitir uso en el navegador
54 | });
55 | 
56 | // Función para obtener las voces disponibles
57 | export const getAvailableVoices = async () => {
58 |   return OPENAI_VOICES;
59 | };
60 | 
61 | /**
62 |  * Genera audio a partir de texto usando la API del cliente oficial de OpenAI
63 |  */
64 | export const generateSpeech = async ({
65 |   text,
66 |   voice = 'nova',
67 |   model,
68 |   instructions
69 | }: TTSOptions): Promise<Blob> => {
70 |   if (!text || text.trim() === '') {
71 |     throw new Error('El texto es requerido');
72 |   }
73 | 
74 |   // Limpiar el texto antes de procesarlo
75 |   const cleanedText = cleanTextForSpeech(text);
76 | 
77 |   // Combinar el system prompt con las instrucciones específicas del narrador
78 |   const fullInstructions = instructions 
79 |     ? `${SYSTEM_PROMPT} ${instructions}`
80 |     : SYSTEM_PROMPT;
81 | 
82 |   console.log(`Iniciando generación de audio... Texto limpio: ${cleanedText.length} caracteres`);
83 | 
84 |   console.log(`Configuración: Voz=${voice}, Modelo=${model}`);
85 |   
86 |   try {
87 |     // Llamar directamente a la API de OpenAI usando el cliente oficial
88 |     const response = await openai.audio.speech.create({
89 |       model,
90 |       voice,
91 |       input: cleanedText,
92 |       instructions: fullInstructions
93 |     });
94 | 
95 |     // Convertir la respuesta a un Blob usando arrayBuffer
96 |     const buffer = await response.arrayBuffer();
97 |     const audioBlob = new Blob([buffer], { type: 'audio/mpeg' });
98 |     
99 |     console.log("Blob de audio creado:", audioBlob.size, "bytes");
100 |     console.log('Audio generado correctamente');
101 |     
102 |     return audioBlob;
103 |   } catch (error: unknown) {
104 |     console.error('Error en generación de voz:', error);
105 |     
106 |     const openAIError = isOpenAIError(error) ? error as OpenAIError : null;
107 |     
108 |     // Manejar específicamente el error 429 (Too Many Requests)
109 |     if (openAIError?.status === 429 || openAIError?.code === 429) {
110 |       throw new Error('Alcanzaste el máximo de créditos para generar un audio');
111 |     }
112 |     
113 |     if (openAIError?.status === 401 || openAIError?.code === 'invalid_api_key') {
114 |       throw new Error('Error de autenticación con el servicio de voz');
115 |     }
116 |     
117 |     if (openAIError?.status === 400) {
118 |       throw new Error('El texto proporcionado no es válido para generar audio');
119 |     }
120 |     
121 |     if (openAIError?.status && openAIError.status >= 500) {
122 |       throw new Error('El servicio de voz no está disponible temporalmente');
123 |     }
124 |     
125 |     const errorMessage = error instanceof Error ? error.message : 'Error inesperado al generar el audio';
126 |     throw new Error(errorMessage);
127 |   }
128 | };
129 | 
130 | function cleanTextForSpeech(text: string): string {
131 |   return text
132 |     // Mantener caracteres especiales españoles
133 |     .replace(/[^\w\s.,!?áéíóúñÁÉÍÓÚÑ-]/g, '')
134 |     // Normalizar espacios
135 |     .replace(/\s+/g, ' ')
136 |     // Agregar pausas naturales
137 |     .replace(/([.!?])\s+/g, '$1\n')
138 |     .replace(/([.,])\s+/g, '$1 ')
139 |     // Eliminar líneas vacías múltiples
140 |     .replace(/\n\s*\n/g, '\n')
141 |     .trim();
142 | }
```

src/store/character/characterStore.ts
```
1 | import { CharacterState } from "../types/storeTypes";
2 | import { StoryCharacter } from "../../types";
3 | import { createPersistentStore, registerStoreRefresh } from "../core/createStore";
4 | import { createDefaultCharacter, generateId } from "../core/utils";
5 | import {
6 |   deleteCharacter as deleteSupabaseCharacter,
7 |   getUserCharacters,
8 |   syncCharacter,
9 |   syncQueue,
10 | } from "../../services/supabase";
11 | import { useUserStore } from "../user/userStore";
12 | 
13 | // Estado inicial
14 | const initialState: Pick<
15 |   CharacterState,
16 |   "currentCharacter" | "savedCharacters"
17 | > = {
18 |   currentCharacter: createDefaultCharacter(),
19 |   savedCharacters: [],
20 | };
21 | 
22 | export const useCharacterStore = createPersistentStore<CharacterState>(
23 |   initialState,
24 |   (set, get) => {
25 |     // Cargar personajes desde Supabase al inicializar el store
26 |     setTimeout(() => {
27 |       const user = useUserStore.getState().user;
28 |       if (user) {
29 |         console.log("Inicializando characterStore - cargando personajes desde Supabase");
30 |         loadCharactersFromSupabase(user.id);
31 |       }
32 |     }, 100);
33 |     
34 |     // Función auxiliar para cargar personajes (fuera del objeto para poder usarla en el timeout)
35 |     const loadCharactersFromSupabase = async (userId: string) => {
36 |       try {
37 |         console.log(`Cargando personajes para usuario ${userId} desde Supabase`);
38 |         
39 |         // Primero, limpiar el array existente para evitar mezclar personajes
40 |         set({ savedCharacters: [] });
41 |         
42 |         // Log para depuración
43 |         console.log(`[DEBUG] Consultando personajes SOLO para el usuario con ID: ${userId}`);
44 |         
45 |         const { success, characters } = await getUserCharacters(userId);
46 | 
47 |         if (success && characters) {
48 |           console.log(`Se encontraron ${characters.length} personajes para usuario ${userId}`);
49 |           
50 |           // Establecer solo los personajes recuperados de Supabase
51 |           set({ savedCharacters: characters });
52 |           console.log(`Lista actualizada: ${characters.length} personajes para usuario ${userId}`);
53 |         } else {
54 |           console.log(`No se encontraron personajes para el usuario ${userId} o hubo un error`);
55 |         }
56 |       } catch (error) {
57 |         console.error(`Error cargando personajes desde Supabase para usuario ${userId}:`, error);
58 |       }
59 |     };
60 |     
61 |     return {
62 |       updateCharacter: (updates) => {
63 |         // Si actualizamos un personaje sin ID, asegurarnos de que tenga uno único
64 |         set((state) => {
65 |           const current = state.currentCharacter;
66 |           
67 |           // Verificar si estamos editando un personaje nuevo sin ID propio o con ID vacío
68 |           if (!current.id || current.id === "") {
69 |             console.log("Personaje sin ID detectado, generando uno nuevo");
70 |             const newId = generateId("char");
71 |             console.log(`ID generado para nuevo personaje: ${newId}`);
72 |             return {
73 |               currentCharacter: {
74 |                 ...current,
75 |                 ...updates,
76 |                 id: newId
77 |               }
78 |             };
79 |           }
80 |           
81 |           // Actualización normal si ya tiene ID
82 |           return {
83 |             currentCharacter: {
84 |               ...current,
85 |               ...updates,
86 |             },
87 |           };
88 |         });
89 |       },
90 | 
91 |       resetCharacter: () => {
92 |         console.log("Reseteando personaje actual con nuevo ID");
93 |         const newId = generateId("char");
94 |         console.log(`Nuevo ID generado: ${newId}`);
95 |         
96 |         // Crear un personaje completamente vacío con un nuevo ID
97 |         set({
98 |           currentCharacter: {
99 |             id: newId,
100 |             name: "",
101 |             hobbies: [],
102 |             description: "",
103 |             profession: "",
104 |             characterType: "",
105 |             personality: "",
106 |           }
107 |         });
108 |       },
109 | 
110 |       saveCurrentCharacter: async () => {
111 |         // Guardar primero localmente
112 |         const user = useUserStore.getState().user;
113 |         if (!user) {
114 |           console.error("No se puede guardar el personaje: usuario no autenticado");
115 |           return { success: false, error: "Usuario no autenticado" };
116 |         }
117 | 
118 |         // Generar el ID una sola vez para asegurar consistencia
119 |         let characterToSave: StoryCharacter | null = null;
120 |         let nameExists = false;
121 | 
122 |         set((state) => {
123 |           const character = state.currentCharacter;
124 | 
125 |           if (!character || !character.name) {
126 |             return state;
127 |           }
128 | 
129 |           // Verificar si hay algún personaje existente con el mismo nombre
130 |           const existingWithSameName = state.savedCharacters.find(
131 |             c => c.name.toLowerCase() === character.name.toLowerCase() && c.id !== character.id
132 |           );
133 | 
134 |           if (existingWithSameName) {
135 |             console.log(`ADVERTENCIA: Ya existe un personaje con el nombre "${character.name}"`);
136 |             nameExists = true;
137 |             // No modificar el estado si hay un duplicado
138 |             return state;
139 |           }
140 | 
141 |           // Generar ID solo si es necesario
142 |           const characterId = character.id || generateId("char");
143 |           console.log(`Guardando personaje "${character.name}" con ID: ${characterId}`);
144 |           
145 |           // Guardar localmente el personaje con su ID
146 |           characterToSave = {
147 |             ...character,
148 |             id: characterId,
149 |           };
150 | 
151 |           // Check if character already exists
152 |           const existingCharIndex = state.savedCharacters.findIndex(
153 |             (char) => char.id === characterId,
154 |           );
155 | 
156 |           if (existingCharIndex >= 0) {
157 |             // Update existing character
158 |             const updatedCharacters = [...state.savedCharacters];
159 |             updatedCharacters[existingCharIndex] = characterToSave;
160 |             console.log(`Actualizando personaje existente con ID: ${characterId}`);
161 |             return { 
162 |               savedCharacters: updatedCharacters,
163 |               currentCharacter: characterToSave  // Actualizar currentCharacter con el ID
164 |             };
165 |           } else {
166 |             // Add new character
167 |             console.log(`Agregando nuevo personaje con ID: ${characterId}`);
168 |             return {
169 |               savedCharacters: [...state.savedCharacters, characterToSave],
170 |               currentCharacter: characterToSave  // Actualizar currentCharacter con el ID
171 |             };
172 |           }
173 |         });
174 | 
175 |         // Si se detectó un nombre duplicado, retornar error
176 |         if (nameExists) {
177 |           return { 
178 |             success: false, 
179 |             error: `Ya existe un personaje con el nombre "${get().currentCharacter.name}". Por favor, elige otro nombre.` 
180 |           };
181 |         }
182 | 
183 |         // Si no hay personaje para guardar, retornar error
184 |         if (!characterToSave) {
185 |           return { success: false, error: "No hay datos válidos para guardar" };
186 |         }
187 | 
188 |         // Ahora sincronizar con Supabase
189 |         try {
190 |           // Usar el objeto que ya tiene el ID asignado
191 |           if (characterToSave && characterToSave.name) {
192 |             console.log(`Sincronizando personaje ${characterToSave.name} (ID: ${characterToSave.id}) para usuario ${user.id}`);
193 |             const { success, error } = await syncCharacter(user.id, characterToSave);
194 | 
195 |             if (!success) {
196 |               console.log("Falló la sincronización directa, agregando a la cola");
197 |               // Si falla, agregarlo a la cola de sincronización
198 |               syncQueue.addToQueue("characters", "update", {
199 |                 id: characterToSave.id,
200 |                 user_id: user.id,
201 |                 name: characterToSave.name,
202 |                 hobbies: characterToSave.hobbies,
203 |                 description: characterToSave.description,
204 |                 profession: characterToSave.profession,
205 |                 character_type: characterToSave.characterType,
206 |                 personality: characterToSave.personality,
207 |               });
208 |               return { success: false, error };
209 |             }
210 |             return { success: true };
211 |           }
212 |           return { success: false, error: "Datos de personaje inválidos" };
213 |         } catch (error) {
214 |           console.error("Error sincronizando personaje con Supabase:", error);
215 |           return { success: false, error };
216 |         }
217 |       },
218 | 
219 |       selectCharacter: (characterId) =>
220 |         set((state) => {
221 |           const character = state.savedCharacters.find((char) =>
222 |             char.id === characterId
223 |           );
224 | 
225 |           if (!character) {
226 |             return state;
227 |           }
228 | 
229 |           return {
230 |             currentCharacter: character,
231 |           };
232 |         }),
233 | 
234 |       deleteCharacter: async (characterId) => {
235 |         const user = useUserStore.getState().user;
236 |         if (!user) {
237 |           console.error("No se puede eliminar el personaje: usuario no autenticado");
238 |           return;
239 |         }
240 | 
241 |         // Eliminar localmente primero
242 |         set((state) => ({
243 |           savedCharacters: state.savedCharacters.filter((char) =>
244 |             char.id !== characterId
245 |           ),
246 |           // Si el personaje actual es el que se elimina, resetearlo
247 |           currentCharacter: state.currentCharacter.id === characterId 
248 |             ? createDefaultCharacter() 
249 |             : state.currentCharacter
250 |         }));
251 | 
252 |         // Luego sincronizar con Supabase
253 |         try {
254 |           console.log(`Eliminando personaje ${characterId} para usuario ${user.id}`);
255 |           const { success } = await deleteSupabaseCharacter(characterId);
256 | 
257 |           if (!success) {
258 |             console.log("Falló la eliminación directa, agregando a la cola");
259 |             // Si falla, agregar a la cola de sincronización
260 |             syncQueue.addToQueue("characters", "delete", { 
261 |               id: characterId,
262 |               user_id: user.id
263 |             });
264 |           }
265 |         } catch (error) {
266 |           console.error("Error eliminando personaje de Supabase:", error);
267 |           // Agregar a la cola de sincronización
268 |           syncQueue.addToQueue("characters", "delete", { 
269 |             id: characterId,
270 |             user_id: user.id
271 |           });
272 |         }
273 |       },
274 | 
275 |       loadCharactersFromSupabase: async (userId?: string) => {
276 |         const user = useUserStore.getState().user;
277 | 
278 |         if (!user) {
279 |           console.error("No se pueden cargar los personajes: usuario no autenticado");
280 |           return;
281 |         }
282 |         
283 |         await loadCharactersFromSupabase(user.id);
284 |       },
285 |     };
286 |   },
287 |   "characters",
288 | );
289 | 
290 | // Exportar función para poder forzar una recarga de personajes desde cualquier parte
291 | export const reloadCharacters = () => {
292 |   const user = useUserStore.getState().user;
293 |   if (user) {
294 |     console.log("Forzando recarga de personajes desde Supabase");
295 |     useCharacterStore.getState().loadCharactersFromSupabase();
296 |   }
297 | };
298 | 
299 | // Registrar la función de recarga para que se ejecute cuando cambie el usuario
300 | registerStoreRefresh("characters", reloadCharacters);
```

src/store/core/createStore.ts
```
1 | import { create } from 'zustand';
2 | import { persist } from 'zustand/middleware';
3 | 
4 | // Almacenamiento global del ID de usuario autenticado
5 | let currentAuthUserId: string | null = null;
6 | // Lista de stores que necesitan ser refrescados cuando cambia el usuario
7 | const storesRegistry: {[key: string]: Function} = {};
8 | 
9 | /**
10 |  * Establece el ID del usuario autenticado actualmente
11 |  * Esta función debe ser llamada desde el componente de autenticación
12 |  */
13 | export const setCurrentAuthUser = (userId: string | null) => {
14 |   console.log(`Cambiando usuario autenticado de [${currentAuthUserId}] a [${userId}]`);
15 |   
16 |   if (userId !== currentAuthUserId) {
17 |     // Si cambia el usuario, limpiar stores anteriores
18 |     if (userId) {
19 |       cleanPreviousUserStores(userId);
20 |       // Notificar a todos los stores registrados para que se actualicen
21 |       refreshAllStores();
22 |     }
23 |     currentAuthUserId = userId;
24 |   }
25 | };
26 | 
27 | /**
28 |  * Limpia los stores que no pertenecen al usuario actual
29 |  */
30 | export const cleanPreviousUserStores = (currentUserId: string) => {
31 |   console.log(`Limpiando stores previos para usuario: ${currentUserId}`);
32 |   
33 |   let cleaned = 0;
34 |   for (let i = 0; i < localStorage.length; i++) {
35 |     const key = localStorage.key(i);
36 |     if (key && key.startsWith('story-app-')) {
37 |       // Si no es una clave del usuario actual y no es la clave global de usuario
38 |       if (!key.includes(`-${currentUserId}-`) && !key.includes('story-app-user')) {
39 |         console.log(`Eliminando store: ${key}`);
40 |         localStorage.removeItem(key);
41 |         i--; // Ajustar el índice
42 |         cleaned++;
43 |       }
44 |     }
45 |   }
46 |   console.log(`Se limpiaron ${cleaned} stores anteriores`);
47 |   
48 |   // Identificar las claves que coinciden con el store de personajes
49 |   const characterKeys = [];
50 |   for (let i = 0; i < localStorage.length; i++) {
51 |     const key = localStorage.key(i);
52 |     if (key && key.includes('-characters')) {
53 |       characterKeys.push(key);
54 |       try {
55 |         const value = JSON.parse(localStorage.getItem(key) || '{}');
56 |         console.log(`[DEBUG] Clave ${key}, tiene ${value?.state?.savedCharacters?.length || 0} personajes`);
57 |       } catch (error) {
58 |         console.error(`[DEBUG] Error al analizar clave ${key}:`, error);
59 |       }
60 |     }
61 |   }
62 |   
63 |   console.log(`[DEBUG] Claves de personajes encontradas: ${characterKeys.join(', ')}`);
64 | };
65 | 
66 | /**
67 |  * Refresca todos los stores registrados para que carguen datos frescos
68 |  */
69 | export const refreshAllStores = () => {
70 |   console.log(`Refrescando ${Object.keys(storesRegistry).length} stores registrados`);
71 |   
72 |   Object.keys(storesRegistry).forEach(storeName => {
73 |     const refreshFn = storesRegistry[storeName];
74 |     if (typeof refreshFn === 'function') {
75 |       console.log(`Refrescando store: ${storeName}`);
76 |       try {
77 |         refreshFn();
78 |       } catch (error) {
79 |         console.error(`Error refrescando store ${storeName}:`, error);
80 |       }
81 |     }
82 |   });
83 | };
84 | 
85 | /**
86 |  * Registra una función para refrescar un store cuando cambia el usuario
87 |  */
88 | export const registerStoreRefresh = (storeName: string, refreshFn: Function) => {
89 |   storesRegistry[storeName] = refreshFn;
90 |   console.log(`Store ${storeName} registrado para refresco automático`);
91 | };
92 | 
93 | /**
94 |  * Crea un store persistente con Zustand que incluye el ID del usuario en el nombre
95 |  * para garantizar que cada usuario tenga sus propios datos
96 |  */
97 | export const createPersistentStore = <T>(
98 |   initialState: Partial<T>,
99 |   storeLogic: (set: Function, get: Function) => Partial<T>,
100 |   storeName: string
101 | ) => {
102 |   const fullStoreName = getStoreNameWithUserId(storeName);
103 |   
104 |   // Crear el store
105 |   const useStore = create<T>()(
106 |     persist(
107 |       (set, get) => ({
108 |         ...initialState,
109 |         ...storeLogic(set, get)
110 |       }) as T,
111 |       {
112 |         name: fullStoreName,
113 |       }
114 |     )
115 |   );
116 |   
117 |   return useStore;
118 | };
119 | 
120 | /**
121 |  * Genera un nombre de store único para cada usuario basado en su ID
122 |  */
123 | const getStoreNameWithUserId = (baseName: string): string => {
124 |   // Si hay un usuario autenticado, usar su ID
125 |   const userId = currentAuthUserId || 'anonymous';
126 |   
127 |   // El store para el usuario tiene que incluir su ID
128 |   const storeName = `story-app-${userId}-${baseName}`;
129 |   console.log(`Creando/accediendo store: ${storeName}`);
130 |   return storeName;
131 | }; 
```

src/store/core/utils.ts
```
1 | import { StoryCharacter } from "../../types";
2 | import { v4 as uuidv4 } from "uuid";
3 | 
4 | /**
5 |  * Genera un ID único formato UUID, compatible con PostgreSQL
6 |  * Reemplaza la implementación anterior que usaba prefijos personalizados
7 |  */
8 | export const generateId = (prefix: string = "id") => {
9 |   return uuidv4();
10 | };
11 | 
12 | /**
13 |  * Crea un personaje con valores por defecto y un ID único totalmente nuevo
14 |  */
15 | export const createDefaultCharacter = (): StoryCharacter => {
16 |   const newId = generateId("char");
17 |   console.log(`Creando personaje por defecto con nuevo ID: ${newId}`);
18 |   return {
19 |     id: newId,
20 |     name: "",
21 |     hobbies: [],
22 |     description: "",
23 |     profession: "",
24 |     characterType: "",
25 |     personality: "",
26 |   }
27 | };
```

src/store/stories/storiesStore.ts
```
1 | import { StoriesState } from "../types/storeTypes";
2 | import { createPersistentStore } from "../core/createStore";
3 | import { getUserStories, syncQueue, syncStory } from "../../services/supabase";
4 | import { useUserStore } from "../user/userStore";
5 | 
6 | // Estado inicial
7 | const initialState: Pick<
8 |   StoriesState,
9 |   "generatedStories" | "isGeneratingStory" | "isLoadingStories"
10 | > = {
11 |   generatedStories: [],
12 |   isGeneratingStory: false,
13 |   isLoadingStories: false,
14 | };
15 | 
16 | export const useStoriesStore = createPersistentStore<StoriesState>(
17 |   initialState,
18 |   (set, get) => ({
19 |     setIsGeneratingStory: (isGenerating) =>
20 |       set({
21 |         isGeneratingStory: isGenerating,
22 |       }),
23 | 
24 |     addGeneratedStory: async (story) => {
25 |       console.log("🚀 ~ addGeneratedStory: ~ story:", story)
26 |       // Guardar localmente primero
27 |       set((state) => ({
28 |         generatedStories: [story, ...state.generatedStories],
29 |       }));
30 | 
31 |       // Luego sincronizar con Supabase
32 |       try {
33 |         const user = useUserStore.getState().user;
34 | 
35 |         if (user) {
36 |           const { success } = await syncStory(user.id, story);
37 | 
38 |           if (!success) {
39 |             // Si falla, agregar a la cola de sincronización
40 |             syncQueue.addToQueue("stories", "insert", {
41 |               id: story.id,
42 |               user_id: user.id,
43 |               title: story.title,
44 |               content: story.content,
45 |               audio_url: story.audioUrl,
46 |               moral: story.options.moral,
47 |               genre: story.options.genre,
48 |               duration: story.options.duration,
49 |               character_id: story.options.character.id,
50 |               additional_details: story.additional_details,
51 |             });
52 |           }
53 |         }
54 |       } catch (error) {
55 |         console.error("Error sincronizando historia con Supabase:", error);
56 |       }
57 |     },
58 | 
59 |     getStoryById: (id) => {
60 |       return get().generatedStories.find((story) => story.id === id);
61 |     },
62 | 
63 |     loadStoriesFromSupabase: async (userId?: string) => {
64 |       const user = useUserStore.getState().user;
65 |       if (!user) return;
66 | 
67 |       set({ isLoadingStories: true });
68 |       try {
69 |         console.log(`Cargando historias para usuario ${user.id}`);
70 | 
71 |         // IMPORTANTE: Limpiar antes de cargar
72 |         set({ generatedStories: [] });
73 | 
74 |         const { success, stories } = await getUserStories(user.id);
75 | 
76 |         if (success && stories) {
77 |           console.log(`Cargadas ${stories.length} historias de Supabase`);
78 |           set({ generatedStories: stories });
79 |         } else {
80 |           console.warn("No se encontraron historias o hubo un error");
81 |         }
82 |       } catch (error) {
83 |         console.error("Error al cargar historias:", error);
84 |       } finally {
85 |         set({ isLoadingStories: false });
86 |       }
87 |     },
88 |   }),
89 |   "stories",
90 | );
```

src/store/stories/storyGenerator.ts
```
1 | // src/store/stories/storyGenerator.ts
2 | import { toast } from "sonner";
3 | import { Story, StoryOptions, StoryChapter } from "../../types"; 
4 | import { useStoriesStore } from "./storiesStore";
5 | import { useUserStore } from "../user/userStore";
6 | import { useCharacterStore } from "../character/characterStore";
7 | import { useStoryOptionsStore } from "../storyOptions/storyOptionsStore"; 
8 | import { generateId } from "../core/utils"; 
9 | import { GenerateStoryService, GenerateStoryParams } from "@/services/ai/GenerateStoryService";
10 | import { useChaptersStore } from "./chapters/chaptersStore"; 
11 | 
12 | /**
13 |  * Genera una historia completa (Capítulo 1 + Título) a partir de las opciones
14 |  */
15 | export const generateStory = async (options: Partial<StoryOptions>): Promise<Story | null> => { 
16 |   const storiesStore = useStoriesStore.getState();
17 |   const chaptersStore = useChaptersStore.getState(); 
18 |   const characterStore = useCharacterStore.getState();
19 |   const storyOptionsState = useStoryOptionsStore.getState(); 
20 | 
21 |   console.log("🔍 DEBUG - Opciones generación historia:", JSON.stringify(options, null, 2));
22 |   console.log("🔍 DEBUG - Detalles Adicionales:", storyOptionsState.additionalDetails);
23 | 
24 |   storiesStore.setIsGeneratingStory(true);
25 | 
26 |   try {
27 |     const storyId = generateId(); 
28 |     const profileSettings = useUserStore.getState().profileSettings; 
29 |     const characterForStory = useCharacterStore.getState().currentCharacter; 
30 |     const additionalDetails = storyOptionsState.additionalDetails; 
31 | 
32 |     // --- DEBUG: Log detallado de parámetros ANTES de construir payload --- 
33 |     console.log("🔍 DEBUG PRE-PAYLOAD: Datos Perfil ->", JSON.stringify(profileSettings, null, 2));
34 |     console.log("🔍 DEBUG PRE-PAYLOAD: Datos Personaje ->", JSON.stringify(characterForStory, null, 2));
35 |     console.log("🔍 DEBUG PRE-PAYLOAD: Opciones Recibidas (función) ->", JSON.stringify(options, null, 2));
36 |     console.log("🔍 DEBUG PRE-PAYLOAD: Duración (store) ->", storyOptionsState.currentStoryOptions.duration);
37 |     console.log("🔍 DEBUG PRE-PAYLOAD: Detalles Adicionales ->", additionalDetails);
38 |     // --- FIN DEBUG ---
39 | 
40 |     if (!profileSettings) throw new Error("Perfil de usuario no cargado.");
41 |     if (!characterForStory) throw new Error("Personaje no seleccionado o inválido.");
42 | 
43 |     // --- Llamada ÚNICA al servicio que invoca la EF 'generate-story' ---
44 |     const payload: GenerateStoryParams = {
45 |       options: {
46 |         character: characterForStory,
47 |         genre: options.genre, 
48 |         moral: options.moral, 
49 |         duration: storyOptionsState.currentStoryOptions.duration, 
50 |       },
51 |       language: profileSettings.language, 
52 |       childAge: profileSettings.childAge ?? 5, 
53 |       specialNeed: profileSettings.specialNeed, 
54 |       additionalDetails: additionalDetails || undefined, 
55 |     };
56 | 
57 |     console.log("Enviando solicitud a la Edge Function generate-story con params:", payload);
58 | 
59 |     const storyResponse = await GenerateStoryService.generateStoryWithAI(payload);
60 |     // storyResponse ahora es { content: string, title: string }
61 |     console.log(`[storyGenerator_DEBUG] Title received from Service: "${storyResponse.title}"`);
62 | 
63 |     // Guardar el personaje si es uno nuevo o modificado (asumiendo que save es seguro)
64 |     // Considera si esto debe hacerse solo si la generación fue exitosa
65 |     await characterStore.saveCurrentCharacter();
66 | 
67 |     // Crear el objeto historia con título y contenido de la respuesta
68 |     const story: Story = {
69 |       id: storyId,
70 |       title: storyResponse.title, 
71 |       content: storyResponse.content, 
72 |       options: { 
73 |         moral: options.moral || "Ser amable", 
74 |         character: characterForStory,
75 |         genre: options.genre || "aventura",
76 |         duration: options.duration || "medium",
77 |         language: payload.language,
78 |       },
79 |       additional_details: additionalDetails, 
80 |       createdAt: new Date().toISOString(),
81 |       // audioUrl se añadirá después si se genera
82 |     };
83 | 
84 |     console.log("🔍 DEBUG - Historia Creada:", JSON.stringify(story.options, null, 2));
85 |     console.log(`[storyGenerator_DEBUG] Title being saved to store: "${story.title}"`);
86 | 
87 |     // 1. Guardar la historia principal (como antes)
88 |     // Guardar la historia generada en el store
89 |     await storiesStore.addGeneratedStory(story); 
90 | 
91 |     // 2. Crear y guardar el Capítulo 1
92 |     const firstChapter: StoryChapter = {
93 |       id: generateId(),
94 |       chapterNumber: 1,
95 |       title: story.title, 
96 |       content: story.content, 
97 |       generationMethod: 'free', 
98 |       createdAt: new Date().toISOString(),
99 |       // customInput no aplica aquí
100 |     };
101 |     await chaptersStore.addChapter(story.id, firstChapter); 
102 | 
103 |     // Limpiar las opciones de la historia temporalmente almacenadas
104 |     storyOptionsState.resetStoryOptions(); 
105 | 
106 |     return story; 
107 | 
108 |   } catch (error: any) {
109 |     console.error("Error al generar historia en storyGenerator:", error);
110 |     toast.error("Error al generar la historia", {
111 |       description: error?.message || "Inténtalo de nuevo.",
112 |     });
113 |     // Considera si también deberías llamar a resetStoryOptions aquí
114 |     storyOptionsState.resetStoryOptions(); 
115 |     return null; 
116 |   } finally {
117 |     storiesStore.setIsGeneratingStory(false);
118 |   }
119 | };
```

src/store/storyOptions/storyOptionsStore.ts
```
1 | import { StoryOptionsState } from '../types/storeTypes';
2 | import { StoryOptions, StoryDuration } from '../../types';
3 | import { createPersistentStore } from '../core/createStore';
4 | 
5 | // Estado inicial
6 | const initialState: Pick<StoryOptionsState, 'currentStoryOptions' | 'additionalDetails'> = {
7 |   currentStoryOptions: {},
8 |   additionalDetails: null,
9 | };
10 | 
11 | export const useStoryOptionsStore = createPersistentStore<StoryOptionsState>(
12 |   initialState,
13 |   (set) => ({
14 |     updateStoryOptions: (options) => set((state) => ({
15 |       currentStoryOptions: { ...state.currentStoryOptions, ...options }
16 |     })),
17 |     
18 |     resetStoryOptions: () => set({ 
19 |       currentStoryOptions: {}, 
20 |       additionalDetails: null 
21 |     }),
22 |     
23 |     setDuration: (duration) => set((state) => ({
24 |       currentStoryOptions: { ...state.currentStoryOptions, duration }
25 |     })),
26 |     
27 |     setMoral: (moral) => set((state) => ({
28 |       currentStoryOptions: { ...state.currentStoryOptions, moral }
29 |     })),
30 |     
31 |     setGenre: (genre) => set((state) => ({
32 |       currentStoryOptions: { ...state.currentStoryOptions, genre }
33 |     })),
34 |     
35 |     setAdditionalDetails: (details) => set({ additionalDetails: details }),
36 |   }),
37 |   'story-options'
38 | );
```

src/store/types/storeTypes.ts
```
1 | import {
2 |   Challenge,
3 |   ProfileSettings,
4 |   Story,
5 |   StoryChapter,
6 |   StoryCharacter,
7 |   StoryDuration,
8 |   StoryOptions,
9 |   StoryWithChapters,
10 |   User,
11 | } from "../../types";
12 | 
13 | // Tipos específicos para los stores
14 | export interface UserState {
15 |   user: User | null;
16 |   profileSettings: ProfileSettings | null;
17 |   intendedRedirectPath: string | null; // Añadido para gestionar redirecciones
18 | 
19 |   loginUser: (user: User) => void;
20 |   logoutUser: () => void;
21 |   setProfileSettings: (settings: Partial<ProfileSettings>) => void;
22 |   hasCompletedProfile: () => boolean;
23 |   checkAuth: () => Promise<User | null>;
24 | 
25 |   // Nuevos selectores para suscripción y límites
26 |   isPremium: () => boolean;
27 |   getRemainingMonthlyStories: () => number;
28 |   canCreateStory: () => boolean;
29 |   getRemainingMonthlyVoiceGenerations: () => number;
30 |   getAvailableVoiceCredits: () => number;
31 |   canGenerateVoice: () => boolean;
32 |   canContinueStory: (storyId: string) => boolean;
33 | }
34 | 
35 | export interface CharacterState {
36 |   currentCharacter: StoryCharacter | null;
37 |   savedCharacters: StoryCharacter[];
38 | 
39 |   updateCharacter: (updates: Partial<StoryCharacter>) => void;
40 |   resetCharacter: () => void;
41 |   saveCurrentCharacter: () => Promise<{ success: boolean; error?: any }>;
42 |   selectCharacter: (characterId: string) => void;
43 |   deleteCharacter: (characterId: string) => void;
44 |   loadCharactersFromSupabase: () => Promise<void>;
45 | }
46 | 
47 | export interface StoryOptionsState {
48 |   currentStoryOptions: Partial<StoryOptions>;
49 |   additionalDetails?: string | null;
50 | 
51 |   updateStoryOptions: (options: Partial<StoryOptions>) => void;
52 |   resetStoryOptions: () => void;
53 |   setDuration: (duration: StoryDuration) => void;
54 |   setMoral: (moral: string) => void;
55 |   setGenre: (genre: string) => void;
56 |   setAdditionalDetails: (details?: string | null) => void;
57 | }
58 | 
59 | export interface StoriesState {
60 |   generatedStories: Story[];
61 |   isGeneratingStory: boolean;
62 |   isLoadingStories: boolean;
63 | 
64 |   setIsGeneratingStory: (isGenerating: boolean) => void;
65 |   addGeneratedStory: (story: Story) => void;
66 |   getStoryById: (id: string) => Story | undefined;
67 |   loadStoriesFromSupabase: () => Promise<void>;
68 | }
69 | 
70 | export interface ChaptersState {
71 |   storyChapters: StoryWithChapters[];
72 | 
73 |   getChaptersByStoryId: (storyId: string) => StoryChapter[];
74 |   addChapter: (storyId: string, chapter: StoryChapter) => void;
75 |   getLastChapterByStoryId: (storyId: string) => StoryChapter | undefined;
76 |   loadChaptersFromSupabase: (storyId: string) => Promise<void>;
77 | }
78 | 
79 | export interface ChallengesState {
80 |   challenges: Challenge[];
81 | 
82 |   addChallenge: (challenge: Challenge) => void;
83 |   getChallengesByStoryId: (storyId: string) => Challenge[];
84 |   loadChallengesFromSupabase: (storyId: string) => Promise<void>;
85 | }
86 | 
87 | export interface AudioState {
88 |   audioCache: {
89 |     [key: string]: {
90 |       url: string;
91 |       timestamp: string;
92 |     };
93 |   };
94 |   generationStatus: {
95 |     [key: string]: {
96 |       status: "idle" | "generating" | "completed" | "error";
97 |       progress: number;
98 |     };
99 |   };
100 |   currentVoice: string | null;
101 | 
102 |   addAudioToCache: (
103 |     storyId: string,
104 |     chapterId: string | number,
105 |     voiceId: string,
106 |     audioUrl: string,
107 |   ) => void;
108 |   getAudioFromCache: (
109 |     storyId: string,
110 |     chapterId: string | number,
111 |     voiceId: string,
112 |   ) => string | null;
113 |   setGenerationStatus: (
114 |     storyId: string,
115 |     chapterId: string | number,
116 |     status: "idle" | "generating" | "completed" | "error",
117 |     progress?: number,
118 |   ) => void;
119 |   getGenerationStatus: (
120 |     storyId: string,
121 |     chapterId: string | number,
122 |   ) => { status: string; progress: number };
123 |   setCurrentVoice: (voiceId: string) => void;
124 |   getCurrentVoice: () => string | null;
125 |   clearOldAudioCache: (olderThanDays?: number) => void;
126 |   loadAudioFromSupabase: () => Promise<void>;
127 | }
128 | 
129 | // Estado combinado para mantener compatibilidad con el código existente
130 | export interface StoryState
131 |   extends UserState, StoriesState, ChallengesState, ChaptersState, AudioState {
132 |   currentStoryOptions: Partial<StoryOptions> & {
133 |     character?: StoryCharacter;
134 |   };
135 |   savedCharacters: StoryCharacter[];
136 | 
137 |   // Métodos específicos de Character para compatibilidad
138 |   setCharacterName: (name: string) => void;
139 |   setCharacterHobbies: (hobbies: string[]) => void;
140 |   setCharacterDescription: (description: string) => void;
141 |   setCharacterProfession: (profession: string) => void;
142 |   setCharacterType: (type: string) => void;
143 |   setCharacterPersonality: (personality: string) => void;
144 | }
```

supabase/functions/_shared/cors.ts
```
1 | // supabase/functions/_shared/cors.ts
2 | 
3 | export const corsHeaders = {
4 |   // For development: include localhost
5 |   'Access-Control-Allow-Origin': '*',
6 |   
7 |   // If you need to support multiple origins, you can use this instead
8 |   // and add logic in your function to set the appropriate origin
9 |   // 'Access-Control-Allow-Origin': '*', 
10 |   
11 |   'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
12 |   'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
13 |   'Access-Control-Max-Age': '86400',  // 24 hours caching for preflight requests
14 | };
```

src/store/user/userStore.ts
```
1 | // src/store/user/userStore.ts
2 | 
3 | import { UserState } from "../types/storeTypes";
4 | import { ProfileSettings, User } from "../../types";
5 | import { createPersistentStore, setCurrentAuthUser } from "../core/createStore";
6 | import { getCurrentUser, logout } from "../../supabaseAuth";
7 | import {
8 |   getUserProfile,
9 |   syncQueue,
10 |   syncUserProfile,
11 | } from "../../services/supabase";
12 | import { supabase } from "../../supabaseClient";
13 | import { useChaptersStore } from '../stories/chapters/chaptersStore';
14 | 
15 | const PREMIUM_MONTHLY_VOICE_ALLOWANCE = 20; // Max free monthly voice generations for premium
16 | 
17 | // Estado inicial
18 | const initialState: Pick<UserState, "user" | "profileSettings" | "intendedRedirectPath"> = {
19 |   user: null,
20 |   profileSettings: null,
21 |   intendedRedirectPath: null, // Inicializado
22 | };
23 | 
24 | // Lógica del store
25 | export const useUserStore = createPersistentStore<UserState>(
26 |   initialState,
27 |   (set, get) => ({
28 |     loginUser: async (user: User): Promise<void> => { // Revertido a Promise<void>
29 |       // Actualizar usuario en el store global
30 |       setCurrentAuthUser(user.id);
31 | 
32 |       // Establecer el usuario en el store
33 |       set({ user, intendedRedirectPath: null }); // Reset path on new login attempt
34 | 
35 |       let redirectPath = '/login'; // Default path
36 | 
37 |       // Al iniciar sesión, cargar datos desde Supabase
38 |       try {
39 |         // 1. Cargar perfil
40 |         console.log(`Cargando perfil para usuario ${user.id} desde Supabase`);
41 |         const { success, profile } = await getUserProfile(user.id);
42 |         if (success && profile) {
43 |           console.log("Perfil cargado con éxito:", profile);
44 |           set({ profileSettings: profile });
45 |           // Determinar ruta de redirección basado en setup
46 |           redirectPath = profile.has_completed_setup ? '/home' : '/profile-config';
47 |         } else {
48 |           console.warn("No se encontró perfil para el usuario logueado o hubo un error, redirigiendo a setup:", user.id);
49 |           // Podría ser un usuario nuevo o un error. Dirigir a setup como fallback seguro.
50 |           redirectPath = '/profile-config';
51 |         }
52 | 
53 |         // 2. Iniciar sincronización de otros datos (no bloqueante para la redirección)
54 |         syncAllUserData(user.id);
55 | 
56 |       } catch (error) {
57 |         console.error("Error cargando datos de usuario desde Supabase:", error);
58 |         redirectPath = '/login'; // En caso de error, volver a login
59 |       }
60 |       set({ intendedRedirectPath: redirectPath }); // Establecer el path en el estado
61 |     },
62 | 
63 |     logoutUser: async () => {
64 |       // Guardar una referencia al usuario actual antes de cerrar sesión
65 |       const currentUser = get().user;
66 | 
67 |       // Intentar sincronizar datos pendientes antes de cerrar sesión
68 |       if (currentUser) {
69 |         await syncQueue.processQueue();
70 |       }
71 | 
72 |       // Cerrar sesión en Supabase
73 |       await logout();
74 | 
75 |       // Limpiar el estado del store
76 |       set({ user: null, profileSettings: null, intendedRedirectPath: null });
77 | 
78 |       // Actualizar usuario en el store global (ningún usuario autenticado)
79 |       setCurrentAuthUser(null);
80 |     },
81 | 
82 |     setProfileSettings: async (settings: Partial<ProfileSettings>) => {
83 |       // 1. Merge partial settings with current state
84 |       set((state) => ({
85 |         profileSettings: {
86 |           // Ensure we have a base object even if profileSettings was null
87 |           ...(state.profileSettings || { has_completed_setup: false }), // Default has_completed_setup if null
88 |           ...settings,
89 |         } as ProfileSettings // Assert as ProfileSettings after merge
90 |       }));
91 | 
92 |       // 2. Sincronizar solo los campos proporcionados con Supabase
93 |       const user = get().user;
94 |       if (user) {
95 |         // 3. Construir objeto solo con los campos presentes en 'settings'
96 |         const syncData: { [key: string]: any } = {};
97 |         // Mapeo de camelCase (TypeScript) a snake_case (Supabase)
98 |         const keyMap: { [K in keyof ProfileSettings]?: string } = {
99 |           childAge: 'child_age',
100 |           specialNeed: 'special_need',
101 |           language: 'language',
102 |           has_completed_setup: 'has_completed_setup', // Añadir mapeo si alguna vez se actualiza por aquí
103 |           // Añadir otros campos editables si es necesario
104 |         };
105 | 
106 |         for (const key in settings) {
107 |           if (Object.prototype.hasOwnProperty.call(settings, key)) {
108 |             const mappedKey = keyMap[key as keyof ProfileSettings];
109 |             if (mappedKey) {
110 |               // Asegurar que el valor no sea undefined antes de asignarlo
111 |               const value = settings[key as keyof ProfileSettings];
112 |               if (value !== undefined) {
113 |                 syncData[mappedKey] = value;
114 |               }
115 |             }
116 |           }
117 |         }
118 | 
119 |         // No sincronizar si no hay datos válidos para enviar
120 |         if (Object.keys(syncData).length === 0) {
121 |           console.log("setProfileSettings: No hay datos editables válidos para sincronizar.");
122 |           return;
123 |         }
124 | 
125 |         try {
126 |           // 4. Intentar la sincronización directa
127 |           const { success, error: syncError } = await syncUserProfile(user.id, syncData as any);
128 |           if (!success) {
129 |             console.warn("Sincronización directa fallida, añadiendo a la cola:", syncError);
130 |             // 5. Si falla, agregarlo a la cola de sincronización
131 |             syncQueue.addToQueue("profiles", "update", { id: user.id, ...syncData });
132 |           }
133 |         } catch (error) {
134 |           console.error("Error sincronizando perfil con Supabase:", error);
135 |           // 6. Agregar a la cola de sincronización en caso de error
136 |           syncQueue.addToQueue("profiles", "update", { id: user.id, ...syncData });
137 |         }
138 |       }
139 |     },
140 | 
141 |     hasCompletedProfile: () => {
142 |       const profile = get().profileSettings;
143 |       // Considerar el perfil completado si existe y el flag es true
144 |       return !!profile && profile.has_completed_setup;
145 |     },
146 | 
147 |     // --- Selectores Actualizados/Nuevos ---
148 |     isPremium: () => {
149 |       const status = get().profileSettings?.subscription_status;
150 |       return status === 'active' || status === 'trialing';
151 |     },
152 | 
153 |     getRemainingMonthlyStories: () => {
154 |       const settings = get().profileSettings;
155 |       // Si es premium, devuelve infinito (o un número grande), si no, calcula el restante de 10.
156 |       if (get().isPremium() || !settings) return Infinity;
157 |       return Math.max(0, 10 - (settings.monthly_stories_generated || 0));
158 |     },
159 | 
160 |     canCreateStory: () => {
161 |       return get().getRemainingMonthlyStories() > 0;
162 |     },
163 | 
164 |     getRemainingMonthlyVoiceGenerations: () => {
165 |       const settings = get().profileSettings;
166 |       // Solo aplica a premium, devuelve 0 si no lo es.
167 |       if (!get().isPremium() || !settings) return 0;
168 |       // Asumiendo 20 generaciones gratis al mes
169 |       return Math.max(0, 20 - (settings.monthly_voice_generations_used || 0));
170 |     },
171 | 
172 |     getAvailableVoiceCredits: () => {
173 |       return get().profileSettings?.voice_credits || 0;
174 |     },
175 | 
176 |     canGenerateVoice: () => {
177 |       const settings = get().profileSettings;
178 |       console.log('[canGenerateVoice_DEBUG] Checking canGenerateVoice. Settings:', settings);
179 | 
180 |       // a. Handle missing profile
181 |       if (!settings) {
182 |         console.warn('[canGenerateVoice_DEBUG] No profile settings found. Denying voice generation.');
183 |         return false;
184 |       }
185 | 
186 |       // b. Get values safely
187 |       const subscriptionStatus = settings.subscription_status;
188 |       const monthlyGenerationsUsed = settings.monthly_voice_generations_used ?? 0;
189 |       const voiceCredits = settings.voice_credits ?? 0;
190 | 
191 |       // c. Determine if premium
192 |       const isPremium = subscriptionStatus === 'active' || subscriptionStatus === 'trialing';
193 |       console.log(`[canGenerateVoice_DEBUG] User Status: ${subscriptionStatus}, Is Premium: ${isPremium}`);
194 | 
195 |       // d. Main logic
196 |       if (isPremium) {
197 |         const hasMonthlyGenerations = monthlyGenerationsUsed < PREMIUM_MONTHLY_VOICE_ALLOWANCE;
198 |         const hasPurchasedCredits = voiceCredits > 0;
199 |         const allowed = hasMonthlyGenerations || hasPurchasedCredits;
200 |         console.log(`[canGenerateVoice_DEBUG] Premium Check - Monthly Used: ${monthlyGenerationsUsed}/${PREMIUM_MONTHLY_VOICE_ALLOWANCE}, Credits: ${voiceCredits}. Allowed: ${allowed}`);
201 |         return allowed;
202 |       } else {
203 |         // Non-premium (Free, Canceled, etc.)
204 |         const hasPurchasedCredits = voiceCredits > 0;
205 |         console.log(`[canGenerateVoice_DEBUG] Non-Premium Check - Credits: ${voiceCredits}. Allowed: ${hasPurchasedCredits}`);
206 |         return hasPurchasedCredits; // Only allowed if they have purchased credits
207 |       }
208 |     },
209 | 
210 |     canContinueStory: (storyId: string) => {
211 |       if (get().isPremium()) return true; // Premium puede continuar ilimitadamente
212 | 
213 |       // Gratuito: obtener capítulos y contar
214 |       const chapters = useChaptersStore.getState().getChaptersByStoryId(storyId);
215 |       // Permite si hay menos de 2 capítulos (Cap 1 inicial + 1 continuación)
216 |       return chapters.length < 2;
217 |     },
218 | 
219 |     checkAuth: async (): Promise<User | null> => {
220 |       let authenticatedUser: User | null = null;
221 |       try {
222 |         const { data: { session } } = await supabase.auth.getSession();
223 | 
224 |         const { user, error } = await getCurrentUser();
225 | 
226 |         if (user && !error) {
227 |           set({ user });
228 |           authenticatedUser = user;
229 |           // Cargar perfil SI hay usuario
230 |           const { success, profile } = await getUserProfile(user.id);
231 |           if (success && profile) {
232 |             set({ profileSettings: profile });
233 |             // Sincronizar el resto en segundo plano
234 |             syncAllUserData(user.id);
235 |           } else {
236 |             // Aún autenticado, pero sin perfil o error al cargarlo.
237 |             // La redirección a profile-config se manejará en la página de destino o AuthGuard si es necesario
238 |             console.warn("checkAuth: Usuario autenticado pero perfil no encontrado o error al cargar:", user.id);
239 |             set({ profileSettings: null });
240 |           }
241 | 
242 |         } else {
243 |           // No hay usuario o hubo error
244 |           if (error) console.error("Error en getCurrentUser:", error);
245 |           set({ user: null, profileSettings: null });
246 |           authenticatedUser = null;
247 |         }
248 |       } catch (e) {
249 |         console.error("Error crítico durante checkAuth:", e);
250 |         set({ user: null, profileSettings: null });
251 |         authenticatedUser = null;
252 |       }
253 |       return authenticatedUser;
254 |     },
255 |   }),
256 |   "user",
257 | );
258 | 
259 | // Función para sincronizar todos los datos del usuario desde Supabase
260 | async function syncAllUserData(userId: string) {
261 |   console.log(`Iniciando carga completa para usuario: ${userId}`);
262 | 
263 |   // 1. Limpiar todos los datos locales primero
264 |   const otherStores = [
265 |     { store: (await import('../stories/storiesStore')).useStoriesStore, method: 'loadStoriesFromSupabase' },
266 |     { store: (await import('../character/characterStore')).useCharacterStore, method: 'loadCharactersFromSupabase' },
267 |     // Agrega otros stores aquí
268 |   ];
269 | 
270 |   // 2. Cargar secuencialmente
271 |   for (const { store, method } of otherStores) {
272 |     try {
273 |       console.log(`Cargando datos con método: ${method}`);
274 |       await store.getState()[method](userId);
275 |     } catch (error) {
276 |       console.error(`Error cargando datos con ${method}:`, error);
277 |     }
278 |   }
279 | 
280 |   console.log("Sincronización completa");
281 | }
```

supabase/functions/create-customer-portal-session/index.ts
```
1 | // supabase/functions/create-customer-portal-session/index.ts
2 | 
3 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
4 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
5 | import Stripe from 'https://esm.sh/stripe@14.13.0?target=deno';
6 | import { corsHeaders } from '../_shared/cors.ts'; // Ruta corregida
7 | 
8 | console.log(`Function create-customer-portal-session initializing...`);
9 | 
10 | // --- Variables de Entorno y Cliente Stripe ---
11 | const stripeSecretKey = Deno.env.get('STRIPE_SECRET_KEY');
12 | const appBaseUrl = Deno.env.get('APP_BASE_URL');
13 | 
14 | // Verificación inicial (fuera del handler para errores de configuración tempranos)
15 | if (!stripeSecretKey) {
16 |     console.error("FATAL: STRIPE_SECRET_KEY environment variable is not set.");
17 |     // La función fallará al intentar inicializar Stripe, pero este log ayuda.
18 | }
19 | if (!appBaseUrl) {
20 |     console.error("FATAL: APP_BASE_URL environment variable is not set.");
21 |     // La verificación dentro del handler devolverá error 500 al cliente.
22 | }
23 | 
24 | // Inicializa Stripe con la clave secreta (si existe)
25 | // El '!' aquí es menos crítico porque si es null, Stripe() lanzará un error claro.
26 | // Pero es más seguro haberlo verificado antes.
27 | const stripe = new Stripe(stripeSecretKey!, {
28 |   apiVersion: '2023-10-16',
29 |   httpClient: Stripe.createFetchHttpClient(),
30 | });
31 | // --- Fin Variables y Cliente ---
32 | 
33 | 
34 | serve(async (req: Request) => {
35 |   // Gestiona la solicitud preflight CORS del navegador
36 |   if (req.method === 'OPTIONS') {
37 |     console.log('Handling OPTIONS preflight request');
38 |     return new Response('ok', { headers: corsHeaders });
39 |   }
40 | 
41 |   console.log(`Handling ${req.method} request`);
42 | 
43 |   try {
44 |     // Verificar de nuevo la variable APP_BASE_URL dentro del handler para poder retornar una respuesta
45 |     if (!appBaseUrl) {
46 |       // Este log ya se mostró al inicio, pero aquí retornamos error al cliente
47 |       console.error("Configuration Error: APP_BASE_URL is not set.");
48 |       return new Response(JSON.stringify({ error: 'Error de configuración interna del servidor.' }), {
49 |           status: 500, // Internal Server Error
50 |           headers: { ...corsHeaders, 'Content-Type': 'application/json' },
51 |       });
52 |     }
53 |     // Podríamos añadir una verificación similar para stripeSecretKey aquí también si quisiéramos ser extra seguros
54 | 
55 |     // 1. Inicializa el cliente de Supabase específico para esta solicitud
56 |     const supabaseClient = createClient(
57 |       Deno.env.get('SUPABASE_URL') ?? '',
58 |       Deno.env.get('SUPABASE_ANON_KEY') ?? '',
59 |       { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
60 |     );
61 | 
62 |     // 2. Verifica si el usuario está autenticado
63 |     const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
64 |     if (userError || !user) {
65 |       console.error('Authentication error:', userError);
66 |       return new Response(JSON.stringify({ error: 'Usuario no autenticado o inválido.' }), {
67 |         status: 401, // Unauthorized
68 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' },
69 |       });
70 |     }
71 |     console.log(`Authenticated user ID: ${user.id}`);
72 | 
73 |     // 3. Busca el stripe_customer_id en el perfil del usuario
74 |     const { data: profile, error: profileError } = await supabaseClient
75 |       .from('profiles')
76 |       .select('stripe_customer_id')
77 |       .eq('id', user.id)
78 |       .maybeSingle(); // Usa maybeSingle para manejar perfil no encontrado sin error
79 | 
80 |     // Maneja errores de DB que no sean 'no encontrado'
81 |     if (profileError && profileError.code !== 'PGRST116') {
82 |         console.error(`Database error fetching profile for user ${user.id}:`, profileError);
83 |         // Lanza un error para que sea capturado por el catch principal
84 |         throw new Error(`Error al consultar el perfil: ${profileError.message}`);
85 |     }
86 | 
87 |     // 4. Verifica que el usuario tenga un stripe_customer_id
88 |     if (!profile?.stripe_customer_id) {
89 |       console.warn(`No Stripe Customer ID found for user ${user.id}. Cannot open portal.`);
90 |       // Devuelve un error específico 404 para el frontend
91 |       return new Response(JSON.stringify({
92 |         error: 'No se encontró información de facturación para gestionar. Realiza una compra primero.'
93 |       }), {
94 |         status: 404, // Not Found
95 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' },
96 |       });
97 |     }
98 | 
99 |     const stripeCustomerId = profile.stripe_customer_id;
100 |     console.log(`Found Stripe Customer ID: ${stripeCustomerId}`);
101 | 
102 |     // 5. Crea una sesión del portal de cliente de Stripe
103 |     //    Define la ruta correcta del frontend para la página de inicio
104 |     const correctFrontendPath = '/'; // Ruta correcta para HomePage
105 |     const returnUrl = `${appBaseUrl}${correctFrontendPath}`; // Construye la URL completa
106 | 
107 |     console.log(`Creating Stripe Billing Portal session for Customer ${stripeCustomerId} with return URL: ${returnUrl}`); // Log con la URL correcta
108 |     const portalSession = await stripe.billingPortal.sessions.create({
109 |       customer: stripeCustomerId,
110 |       return_url: returnUrl, // Usa la URL corregida
111 |     });
112 | 
113 |     console.log(`Stripe Customer Portal session created: ${portalSession.id}`);
114 | 
115 |     // 6. Devuelve la URL de la sesión al frontend
116 |     return new Response(JSON.stringify({ url: portalSession.url }), {
117 |       headers: { ...corsHeaders, 'Content-Type': 'application/json' },
118 |       status: 200,
119 |     });
120 | 
121 |   } catch (error) { // 'error' aquí es de tipo 'unknown'
122 |     console.error('Unhandled error in create-customer-portal-session:', error);
123 | 
124 |     // ---- Bloque Catch con manejo seguro de 'unknown' ----
125 |     let errorMessage = 'Error desconocido'; // Mensaje por defecto
126 |     if (error instanceof Error) {
127 |       errorMessage = error.message; // Es seguro acceder a .message
128 |     } else if (typeof error === 'string') {
129 |       errorMessage = error; // Si se lanzó un string
130 |     }
131 |     // ---- Fin Bloque Catch ----
132 | 
133 |     // Devuelve la respuesta usando el mensaje obtenido de forma segura
134 |     return new Response(JSON.stringify({ error: `Error interno del servidor: ${errorMessage}` }), {
135 |       status: 500, // Internal Server Error
136 |       headers: { ...corsHeaders, 'Content-Type': 'application/json' },
137 |     });
138 |   }
139 | });
```

supabase/functions/create-checkout-session/index.ts
```
1 | // supabase/functions/create-checkout-session/index.ts
2 | 
3 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
4 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
5 | import Stripe from 'https://esm.sh/stripe@14.13.0?target=deno';
6 | import { corsHeaders } from '../_shared/cors.ts'; // Ruta corregida
7 | 
8 | console.log(`[CREATE_CHECKOUT_DEBUG] Function create-checkout-session initializing...`);
9 | 
10 | // Inicializa Stripe
11 | const stripeSecretKey = Deno.env.get('STRIPE_SECRET_KEY');
12 | if (!stripeSecretKey) {
13 |   console.error("[CREATE_CHECKOUT_ERROR] CRITICAL: STRIPE_SECRET_KEY environment variable is not set.");
14 |   // Considera lanzar un error si falta
15 | }
16 | const stripe = new Stripe(stripeSecretKey!, {
17 |   apiVersion: '2023-10-16',
18 |   httpClient: Stripe.createFetchHttpClient(),
19 | });
20 | 
21 | // Obtén la URL base
22 | const appBaseUrl = Deno.env.get('APP_BASE_URL');
23 | if (!appBaseUrl) {
24 |   console.error("[CREATE_CHECKOUT_ERROR] APP_BASE_URL environment variable is not set.");
25 |   // Considera lanzar un error
26 | }
27 | 
28 | serve(async (req: Request) => {
29 |   // Gestiona preflight CORS
30 |   if (req.method === 'OPTIONS') {
31 |     console.log('[CREATE_CHECKOUT_DEBUG] Handling OPTIONS preflight request');
32 |     return new Response('ok', { headers: corsHeaders });
33 |   }
34 | 
35 |   console.log(`[CREATE_CHECKOUT_DEBUG] Handling ${req.method} request`);
36 | 
37 |   try {
38 |     // 1. Inicializa cliente Supabase
39 |     const supabaseClient = createClient(
40 |       Deno.env.get('SUPABASE_URL') ?? '',
41 |       Deno.env.get('SUPABASE_ANON_KEY') ?? '',
42 |       { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
43 |     );
44 | 
45 |     // 2. Verifica autenticación
46 |     const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
47 |     if (userError || !user) {
48 |       console.error('[CREATE_CHECKOUT_ERROR] Authentication error:', userError?.message || 'No user found');
49 |       return new Response(JSON.stringify({ error: 'Usuario no autenticado o inválido.' }), {
50 |         status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' },
51 |       });
52 |     }
53 |     console.log(`[CREATE_CHECKOUT_DEBUG] Authenticated user ID: ${user.id}`);
54 | 
55 |     // 3. Parsea el cuerpo y determina el item
56 |     let priceId: string | null = null;
57 |     let mode: 'payment' | 'subscription' = 'payment';
58 |     let finalMetadata = {}; // Usamos un nombre diferente para claridad
59 | 
60 |     const requestBody = await req.json();
61 |     const item = requestBody.item;
62 |     console.log(`[CREATE_CHECKOUT_DEBUG] Received request to purchase item: "${item}"`);
63 | 
64 |     if (item === 'premium') {
65 |       priceId = Deno.env.get('PREMIUM_PLAN_PRICE_ID');
66 |       mode = 'subscription';
67 |       finalMetadata = { supabase_user_id: user.id };
68 |       console.log(`[CREATE_CHECKOUT_DEBUG] Mode set to 'subscription'. Metadata for subscription_data: ${JSON.stringify(finalMetadata)}`);
69 |     } else if (item === 'credits') {
70 |       priceId = Deno.env.get('VOICE_CREDITS_PRICE_ID');
71 |       mode = 'payment';
72 |       // !! VERIFICACIÓN CLAVE !!
73 |       finalMetadata = { supabase_user_id: user.id, item_purchased: 'voice_credits' };
74 |       console.log(`[CREATE_CHECKOUT_DEBUG] Mode set to 'payment'. Metadata for payment_intent_data: ${JSON.stringify(finalMetadata)}`);
75 |     } else {
76 |       console.error(`[CREATE_CHECKOUT_ERROR] Invalid item requested: ${item}`);
77 |       return new Response(JSON.stringify({ error: 'Artículo solicitado inválido.' }), {
78 |         status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' },
79 |       });
80 |     }
81 | 
82 |     if (!priceId) {
83 |       console.error(`[CREATE_CHECKOUT_ERROR] Stripe Price ID is not configured in env variables for item: ${item}. Check PREMIUM_PLAN_PRICE_ID or VOICE_CREDITS_PRICE_ID.`);
84 |       throw new Error('Error de configuración del servidor: falta el ID de precio.');
85 |     }
86 |     console.log(`[CREATE_CHECKOUT_DEBUG] Resolved Price ID: ${priceId}, Mode: ${mode}`);
87 | 
88 |     // 4. Busca o crea cliente Stripe
89 |     let stripeCustomerId: string;
90 |     const { data: profile, error: profileError } = await supabaseClient
91 |       .from('profiles')
92 |       .select('stripe_customer_id')
93 |       .eq('id', user.id)
94 |       .maybeSingle();
95 | 
96 |     if (profileError) {
97 |       console.error('[CREATE_CHECKOUT_ERROR] Database error fetching profile:', profileError);
98 |       throw new Error('Error al consultar el perfil del usuario.');
99 |     }
100 | 
101 |     if (profile?.stripe_customer_id) {
102 |       stripeCustomerId = profile.stripe_customer_id;
103 |       console.log(`[CREATE_CHECKOUT_DEBUG] Found existing Stripe Customer ID: ${stripeCustomerId}`);
104 |     } else {
105 |       console.log(`[CREATE_CHECKOUT_DEBUG] Stripe Customer ID not found for user ${user.id}. Creating new Stripe Customer...`);
106 |       const customer = await stripe.customers.create({
107 |         email: user.email,
108 |         metadata: { supabase_user_id: user.id }, // Metadata en el cliente Stripe
109 |       });
110 |       stripeCustomerId = customer.id;
111 |       console.log(`[CREATE_CHECKOUT_DEBUG] Created new Stripe Customer ID: ${stripeCustomerId}. Updating profile...`);
112 | 
113 |       const { error: updateError } = await supabaseClient
114 |         .from('profiles')
115 |         .update({ stripe_customer_id: stripeCustomerId })
116 |         .eq('id', user.id);
117 | 
118 |       if (updateError) {
119 |         console.error('[CREATE_CHECKOUT_ERROR] Failed to update profile with Stripe Customer ID:', updateError);
120 |         throw new Error('No se pudo actualizar el perfil del usuario con la información de Stripe.');
121 |       }
122 |       console.log(`[CREATE_CHECKOUT_DEBUG] Profile updated successfully with Stripe Customer ID.`);
123 |     }
124 | 
125 |     // 6. Prepara y crea la sesión de Stripe Checkout
126 |     console.log(`[CREATE_CHECKOUT_DEBUG] Preparing Stripe Checkout session for Customer ${stripeCustomerId}...`);
127 |     const sessionParams: Stripe.Checkout.SessionCreateParams = {
128 |       customer: stripeCustomerId,
129 |       payment_method_types: ['card'],
130 |       line_items: [{ price: priceId, quantity: 1 }],
131 |       mode: mode,
132 |       success_url: `${appBaseUrl}/payment-success?session_id={CHECKOUT_SESSION_ID}`,
133 |       cancel_url: `${appBaseUrl}/payment-cancel`,
134 |       // Adjunta metadata relevante según el modo
135 |       ...(mode === 'subscription' && {
136 |         subscription_data: { metadata: finalMetadata } // Metadata para suscripciones
137 |       }),
138 |       ...(mode === 'payment' && {
139 |         payment_intent_data: { metadata: finalMetadata } // !! Metadata para pagos únicos (créditos) !!
140 |       }),
141 |     };
142 | 
143 |     // !! LOG ANTES DE CREAR !!
144 |     console.log(`[CREATE_CHECKOUT_DEBUG] Session parameters being sent to Stripe: ${JSON.stringify(sessionParams)}`);
145 | 
146 |     const session = await stripe.checkout.sessions.create(sessionParams);
147 |     console.log(`[CREATE_CHECKOUT_DEBUG] Stripe Checkout session created: ${session.id}, URL: ${session.url}`);
148 | 
149 |     // 7. Devuelve la URL
150 |     return new Response(JSON.stringify({ url: session.url }), {
151 |       headers: { ...corsHeaders, 'Content-Type': 'application/json' },
152 |       status: 200,
153 |     });
154 | 
155 |   } catch (error) {
156 |     console.error('[CREATE_CHECKOUT_ERROR] Unhandled error in create-checkout-session:', error);
157 |     return new Response(JSON.stringify({ error: `Error interno del servidor: ${error.message}` }), {
158 |       status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' },
159 |     });
160 |   }
161 | });
```

supabase/functions/generate-story/index.ts
```
1 | // supabase/functions/generate-story/index.ts
2 | // v7.0 (OpenAI Client + JSON Output): Uses OpenAI client for Gemini, expects JSON.
3 | // IMPORTANT: prompt.ts has been updated to instruct AI for JSON output.
4 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
5 | import { corsHeaders } from '../_shared/cors.ts';
6 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
7 | import OpenAI from "npm:openai@^4.33.0"; // Using OpenAI client
8 | 
9 | // Importar funciones de prompt desde prompt.ts
10 | // createUserPrompt_JsonFormat (antes createUserPrompt_SeparatorFormat) ahora genera un prompt que pide JSON.
11 | import { createSystemPrompt, createUserPrompt_JsonFormat } from './prompt.ts';
12 | 
13 | // --- Helper Function (remains largely the same, adapted for potentially cleaner inputs from JSON) ---
14 | function cleanExtractedText(text: string | undefined | null, type: 'title' | 'content'): string {
15 |   const defaultText = type === 'title' ? `Aventura Inolvidable` : 'El cuento tiene un giro inesperado...';
16 |   if (text === null || text === undefined || typeof text !== 'string') {
17 |     console.warn(`[Helper v7.0] cleanExtractedText (${type}): Input empty/not string.`);
18 |     return defaultText;
19 |   }
20 |   console.log(`[Helper v7.0] cleanExtractedText (${type}) - BEFORE: "${text.substring(0, 150)}..."`);
21 |   let cleaned = text.trim();
22 | 
23 |   // These might be less necessary if AI strictly adheres to JSON values, but good for robustness
24 |   cleaned = cleaned.replace(/^Título:\s*/i, '').trim();
25 |   cleaned = cleaned.replace(/^Contenido:\s*/i, '').trim();
26 |   if (type === 'content') {
27 |     cleaned = cleaned.replace(/^\s*\d+\.\s+/gm, ''); // Eliminar numeración de listas
28 |     cleaned = cleaned.replace(/^\s*[-\*]\s+/gm, ''); // Eliminar viñetas de listas
29 |   }
30 |   if (type === 'title') {
31 |     cleaned = cleaned.replace(/^["'“‘](.*)["'”’]$/s, '$1').trim(); // Quitar comillas alrededor del título
32 |   }
33 |   cleaned = cleaned.replace(/^(Respuesta|Aquí tienes el título|El título es):\s*/i, '').trim();
34 |   cleaned = cleaned.replace(/^(Aquí tienes el cuento|El cuento es):\s*/i, '').trim();
35 | 
36 |   console.log(`[Helper v7.0] cleanExtractedText (${type}) - AFTER: "${cleaned.substring(0, 150)}..."`);
37 |   return cleaned || defaultText; // Ensure non-empty string or default
38 | }
39 | 
40 | // --- Interface for Structured AI Response ---
41 | interface StoryGenerationResult {
42 |   title: string;
43 |   content: string;
44 | }
45 | 
46 | function isValidStoryResult(data: any): data is StoryGenerationResult {
47 |   return data &&
48 |     typeof data.title === 'string' &&
49 |     typeof data.content === 'string';
50 | }
51 | 
52 | // --- Main Handler ---
53 | serve(async (req: Request) => {
54 |   const functionVersion = "v7.0 (OpenAI Client + JSON)";
55 |   // 1. MANEJAR PREFLIGHT PRIMERO
56 |   if (req.method === "OPTIONS") {
57 |     console.log(`[${functionVersion}] Handling OPTIONS preflight request...`);
58 |     return new Response("ok", { headers: corsHeaders });
59 |   }
60 | 
61 |   // --- Configuración ---
62 |   const GEMINI_API_KEY = Deno.env.get("GEMINI_API_KEY");
63 |   const GEMINI_COMPATIBLE_ENDPOINT = Deno.env.get("GEMINI_COMPATIBLE_ENDPOINT") || 'https://generativelanguage.googleapis.com/v1beta/openai/';
64 |   const TEXT_MODEL_GENERATE = Deno.env.get('TEXT_MODEL_GENERATE'); // Model name for Gemini via OpenAI endpoint
65 | 
66 |   if (!GEMINI_API_KEY) throw new Error("GEMINI_API_KEY environment variable not set");
67 |   if (!GEMINI_COMPATIBLE_ENDPOINT) throw new Error("GEMINI_COMPATIBLE_ENDPOINT environment variable not set and no fallback could be used");
68 |   if (!TEXT_MODEL_GENERATE) throw new Error("TEXT_MODEL_GENERATE environment variable not set for OpenAI client.");
69 | 
70 |   // --- Initialize OpenAI Client for Gemini ---
71 |   const openai = new OpenAI({
72 |     apiKey: GEMINI_API_KEY,
73 |     baseURL: GEMINI_COMPATIBLE_ENDPOINT.endsWith('/') ? GEMINI_COMPATIBLE_ENDPOINT : GEMINI_COMPATIBLE_ENDPOINT + '/',
74 |   });
75 |   console.log(`[${functionVersion}] OpenAI client configured for Gemini model '${TEXT_MODEL_GENERATE}' via baseURL: ${openai.baseURL}`);
76 | 
77 |   const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
78 |   const APP_SERVICE_ROLE_KEY = Deno.env.get('APP_SERVICE_ROLE_KEY');
79 | 
80 |   if (!SUPABASE_URL || !APP_SERVICE_ROLE_KEY) {
81 |     console.error("Supabase URL or Service Role Key not set");
82 |     throw new Error("Supabase URL or Service Role Key not set");
83 |   }
84 |   const supabaseAdmin = createClient(SUPABASE_URL, APP_SERVICE_ROLE_KEY);
85 | 
86 |   // 2. Verificar Método POST
87 |   if (req.method !== 'POST') {
88 |     console.log(`[${functionVersion}] Method ${req.method} not allowed.`);
89 |     return new Response(JSON.stringify({ error: 'Método no permitido. Usar POST.' }), {
90 |       status: 405, headers: { ...corsHeaders, 'Content-Type': 'application/json' }
91 |     });
92 |   }
93 | 
94 |   let userId: string | null = null;
95 |   let userIdForIncrement: string | null = null;
96 | 
97 |   try {
98 |     // 3. AUTENTICACIÓN
99 |     console.log(`[${functionVersion}] Handling POST request...`);
100 |     const authHeader = req.headers.get('Authorization');
101 |     if (!authHeader || !authHeader.startsWith('Bearer ')) {
102 |       console.error("Authorization header missing or invalid.");
103 |       return new Response(JSON.stringify({ error: 'Token inválido o ausente.' }), {
104 |         status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" }
105 |       });
106 |     }
107 |     const token = authHeader.replace('Bearer ', '');
108 |     const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);
109 | 
110 |     if (authError || !user) {
111 |       console.error("Auth Error:", authError);
112 |       return new Response(JSON.stringify({ error: authError?.message || 'No autenticado.' }), {
113 |         status: authError?.status || 401, headers: { ...corsHeaders, "Content-Type": "application/json" }
114 |       });
115 |     }
116 |     userId = user.id;
117 |     console.log(`[${functionVersion}] User Auth: ${userId}`);
118 | 
119 |     // 4. Perfil y Límites
120 |     const { data: profile, error: profileError } = await supabaseAdmin
121 |       .from('profiles')
122 |       .select('subscription_status, monthly_stories_generated')
123 |       .eq('id', userId)
124 |       .maybeSingle();
125 | 
126 |     if (profileError) {
127 |       console.error(`Error fetching profile for ${userId}:`, profileError);
128 |       throw new Error(`Error al obtener perfil de usuario: ${profileError.message}`);
129 |     }
130 | 
131 |     let isPremiumUser = false;
132 |     if (profile) {
133 |       isPremiumUser = profile.subscription_status === 'active' || profile.subscription_status === 'trialing';
134 |     } else {
135 |       console.warn(`Perfil no encontrado para ${userId}. Tratando como gratuito.`);
136 |     }
137 | 
138 |     let currentStoriesGenerated = profile?.monthly_stories_generated ?? 0;
139 |     const FREE_STORY_LIMIT = 10;
140 | 
141 |     if (!isPremiumUser) {
142 |       userIdForIncrement = userId;
143 |       console.log(`[${functionVersion}] Free user ${userId}. Stories: ${currentStoriesGenerated}/${FREE_STORY_LIMIT}`);
144 |       if (currentStoriesGenerated >= FREE_STORY_LIMIT) {
145 |         return new Response(JSON.stringify({
146 |           error: `Límite mensual (${FREE_STORY_LIMIT}) alcanzado.`
147 |         }), {
148 |           status: 429,
149 |           headers: { ...corsHeaders, "Content-Type": "application/json" }
150 |         });
151 |       }
152 |     } else {
153 |       console.log(`[${functionVersion}] Premium user ${userId}.`);
154 |     }
155 | 
156 |     // 5. Body y Validación
157 |     let params: any;
158 |     try {
159 |       params = await req.json();
160 |       console.log(`[${functionVersion}] Params Recibidos:`, params);
161 | 
162 |       if (!params || typeof params !== 'object' ||
163 |         !params.options || typeof params.options !== 'object' ||
164 |         !params.options.character || typeof params.options.character !== 'object' || !params.options.character.name ||
165 |         typeof params.language !== 'string' || !params.language ||
166 |         params.childAge === undefined || // childAge puede ser 0, así que undefined es la comprobación correcta
167 |         typeof params.options.duration !== 'string' || !params.options.duration ||
168 |         typeof params.options.genre !== 'string' || !params.options.genre ||
169 |         typeof params.options.moral !== 'string' || !params.options.moral
170 |       ) {
171 |         console.error("Validation failed. Missing or invalid fields in params:", {
172 |           hasOptions: !!params.options,
173 |           hasCharacter: !!params.options?.character,
174 |           hasCharacterName: !!params.options?.character?.name,
175 |           hasLanguage: typeof params.language === 'string' && !!params.language,
176 |           hasChildAge: params.childAge !== undefined,
177 |           hasDuration: typeof params.options?.duration === 'string' && !!params.options.duration,
178 |           hasGenre: typeof params.options?.genre === 'string' && !!params.options.genre,
179 |           hasMoral: typeof params.options?.moral === 'string' && !!params.options.moral
180 |         });
181 |         throw new Error("Parámetros inválidos/incompletos (revisar character.name, language, childAge, options.duration, options.genre, options.moral).");
182 |       }
183 |     } catch (error) {
184 |       console.error(`[${functionVersion}] Failed to parse/validate JSON body for user ${userId}. Error:`, error);
185 |       const message = error instanceof Error ? error.message : "Error desconocido al procesar JSON.";
186 |       throw new Error(`Invalid/empty/incomplete JSON in body: ${message}.`);
187 |     }
188 | 
189 |     // 6. Generación IA con OpenAI Client y Esperando JSON
190 |     const systemPrompt = createSystemPrompt(params.language, params.childAge, params.specialNeed);
191 |     const userPrompt = createUserPrompt_JsonFormat({ // Esta función ahora genera un prompt pidiendo JSON
192 |       options: params.options,
193 |       additionalDetails: params.additionalDetails
194 |     });
195 |     const combinedPrompt = `${systemPrompt}\n\n${userPrompt}`;
196 | 
197 |     console.log(`[${functionVersion}] Calling AI (${TEXT_MODEL_GENERATE}) for JSON output (User: ${userId}). Prompt length: ${combinedPrompt.length}`);
198 | 
199 |     const chatCompletion = await openai.chat.completions.create({
200 |       model: TEXT_MODEL_GENERATE,
201 |       messages: [{ role: "user", content: combinedPrompt }],
202 |       response_format: { type: "json_object" }, // Request JSON output
203 |       temperature: 0.8, // From original generationConfig
204 |       top_p: 0.95,      // From original generationConfig
205 |       max_tokens: 16000 // From original generationConfig, ensure adequate for Gemini via OpenAI
206 |     });
207 | 
208 |     const aiResponseContent = chatCompletion.choices[0]?.message?.content;
209 |     const finishReason = chatCompletion.choices[0]?.finish_reason;
210 | 
211 |     console.log(`[${functionVersion}] Raw AI JSON response (first 200 chars): ${aiResponseContent?.substring(0, 200) || '(No text received)'}... Finish Reason: ${finishReason}`);
212 | 
213 |     if (finishReason === 'length') {
214 |       console.warn(`[${functionVersion}] AI generation may have been truncated due to 'length' finish_reason.`);
215 |     }
216 |     // Nota: blockReason específico como en GoogleGenerativeAI no está directamente disponible.
217 |     // Se confía en finish_reason o contenido vacío para problemas.
218 | 
219 |     // 7. Procesar Respuesta JSON de la IA
220 |     let finalTitle = 'Aventura Inolvidable'; // Default
221 |     let finalContent = ''; // Default
222 |     let parsedSuccessfully = false;
223 | 
224 |     if (aiResponseContent) {
225 |       try {
226 |         const storyResult: StoryGenerationResult = JSON.parse(aiResponseContent);
227 |         if (isValidStoryResult(storyResult)) {
228 |           finalTitle = cleanExtractedText(storyResult.title, 'title');
229 |           finalContent = cleanExtractedText(storyResult.content, 'content');
230 |           parsedSuccessfully = true;
231 |           console.log(`[${functionVersion}] Parsed AI JSON successfully. Title: "${finalTitle}"`);
232 |         } else {
233 |           console.warn(`[${functionVersion}] AI response JSON structure is invalid. Received: ${aiResponseContent.substring(0, 500)}...`);
234 |         }
235 |       } catch (parseError) {
236 |         console.error(`[${functionVersion}] Failed to parse JSON from AI response. Error: ${parseError.message}. Raw content: ${aiResponseContent.substring(0, 500)}...`);
237 |       }
238 |     } else {
239 |       console.error(`[${functionVersion}] AI response was empty or text could not be extracted. Finish Reason: ${finishReason}`);
240 |     }
241 | 
242 |     if (!parsedSuccessfully) {
243 |       console.warn(`[${functionVersion}] Using fallback: Default title, and attempting to use raw AI response (if any) as content (after cleaning).`);
244 |       finalContent = cleanExtractedText(aiResponseContent, 'content'); // aiResponseContent could be null here
245 |       // finalTitle remains the default 'Aventura Inolvidable'
246 |     }
247 | 
248 |     if (!finalContent) {
249 |       console.error(`[${functionVersion}] Content is empty even after JSON parsing/fallback and cleaning.`);
250 |       // Considerar devolver la respuesta cruda o un mensaje de error específico
251 |       finalContent = "Hubo un problema al generar el contenido del cuento, pero aquí está la respuesta cruda de la IA (puede no estar formateada): " + (aiResponseContent || "No se recibió respuesta de la IA.");
252 |     }
253 | 
254 |     console.log(`[${functionVersion}] Final Title: "${finalTitle}", Final Content Length: ${finalContent.length}`);
255 | 
256 |     // 8. Incrementar Contador
257 |     if (userIdForIncrement) {
258 |       console.log(`[${functionVersion}] Incrementing count for ${userIdForIncrement}...`);
259 |       const { error: incrementError } = await supabaseAdmin.rpc('increment_story_count', {
260 |         user_uuid: userIdForIncrement
261 |       });
262 |       if (incrementError) {
263 |         console.error(`[${functionVersion}] CRITICAL: Failed count increment for ${userIdForIncrement}: ${incrementError.message}`);
264 |       } else {
265 |         console.log(`[${functionVersion}] Count incremented for ${userIdForIncrement}.`);
266 |       }
267 |     }
268 | 
269 |     // 9. Respuesta Final
270 |     return new Response(JSON.stringify({
271 |       content: finalContent,
272 |       title: finalTitle
273 |     }), {
274 |       status: 200,
275 |       headers: { ...corsHeaders, "Content-Type": "application/json" }
276 |     });
277 | 
278 |   } catch (error) {
279 |     // 10. Manejo de Errores
280 |     console.error(`[${functionVersion}] Error (User: ${userId || 'UNKNOWN'}):`, error);
281 |     let statusCode = 500;
282 |     const message = error instanceof Error ? error.message : "Error interno desconocido.";
283 | 
284 |     if (error instanceof Error) {
285 |       const lowerMessage = message.toLowerCase();
286 |       if (lowerMessage.includes("autenticado") || lowerMessage.includes("token inválido")) statusCode = 401;
287 |       else if (lowerMessage.includes("límite")) statusCode = 429;
288 |       else if (lowerMessage.includes("inválido") || lowerMessage.includes("json in body") || lowerMessage.includes("parámetros")) statusCode = 400;
289 |       // Actualizado para errores de IA con JSON
290 |       else if (lowerMessage.includes("ai response was not valid json") || lowerMessage.includes("ai response was empty") || lowerMessage.includes("ai response json structure is invalid") || lowerMessage.includes("blocked") || lowerMessage.includes("filter")) statusCode = 502; // Bad Gateway
291 |     }
292 | 
293 |     return new Response(JSON.stringify({
294 |       error: `Error procesando solicitud: ${message}`
295 |     }), {
296 |       status: statusCode,
297 |       headers: { ...corsHeaders, "Content-Type": "application/json" }
298 |     });
299 |   }
300 | });
```

supabase/functions/generate-story/prompt.ts
```
1 | // supabase/edge-functions/generate-story/prompt.ts
2 | // v7.0 (JSON Output): Contiene las funciones para generar los prompts.
3 | // createUserPrompt_JsonFormat ahora instruye a la IA para devolver JSON.
4 | 
5 | // createSystemPrompt: El contenido textual de la guía para la IA no cambia.
6 | export function createSystemPrompt(language: string, childAge?: number, specialNeed?: string): string {
7 |     console.log(`[Helper v7.0] createSystemPrompt: lang=${language}, age=${childAge}, need=${specialNeed}`); // Log version actualizada
8 | 
9 |     let base = `Eres un escritor experto en crear cuentos infantiles educativos y creativos. Escribe siempre en ${language}, con un estilo adecuado para niños de ${childAge ?? 7} años.`;
10 |     if (specialNeed && specialNeed !== 'Ninguna') {
11 |         base += ` La adaptación para "${specialNeed}" debe ser sutil, priorizando siempre la claridad, la comprensión y un tono positivo en la narración.`;
12 |         base += ` A continuación, algunas guías específicas para "${specialNeed}":\n`;
13 | 
14 |         switch (specialNeed) {
15 |             case 'TEA': // Trastorno del Espectro Autista
16 |                 base += `   - **Lenguaje Claro y Literal:** Usa frases cortas, directas y concretas. Evita el lenguaje figurado (metáforas, ironía) y las ambigüedades. Si es necesario introducir conceptos abstractos, explícalos de forma muy sencilla dentro de la narrativa.\n`;
17 |                 base += `   - **Estructura Predecible:** Mantén una secuencia narrativa muy clara y lógica (inicio, desarrollo con un problema claro, final con resolución). Puedes usar elementos o frases clave que se repitan para ayudar a anticipar eventos de forma natural.\n`;
18 |                 base += `   - **Descripciones Explícitas de Emociones e Interacciones Sociales:** Describe las emociones de los personajes de manera explícita y sencilla (ej. 'Lucas se sintió alegre cuando...'). Las interacciones sociales deben ser claras y directas.\n`;
19 |                 base += `   - **Enfoque en Detalles Concretos:** Céntrate en detalles observables y acciones concretas en lugar de pensamientos o intenciones internas muy complejas, a menos que se expliquen de forma simple.\n`;
20 |                 base += `   - **Tono Positivo y Calmado:** Asegura un tono general tranquilizador y positivo.\n`;
21 |                 break;
22 |             case 'TDAH': // Déficit de Atención e Hiperactividad
23 |                 base += `   - **Inicio Atractivo y Trama Dinámica:** Comienza la historia de forma que capte el interés rápidamente. Mantén una trama con buen ritmo y elementos de sorpresa o curiosidad para sostener la atención.\n`;
24 |                 base += `   - **Lenguaje Estimulante pero Conciso:** Utiliza un lenguaje vívido y atractivo. Alterna frases de diferentes longitudes, pero prioriza la concisión para facilitar el seguimiento. Evita descripciones excesivamente largas o pasajes muy densos sin acción.\n`;
25 |                 base += `   - **Estructura Clara:** Asegura que el hilo conductor de la historia sea fácil de seguir, con transiciones claras entre las partes.\n`;
26 |                 base += `   - **Fomentar la Conexión (a través del texto):** Incluye preguntas retóricas cortas (ej. '¿Adivinas qué pasó después?'), onomatopeyas y exclamaciones que hagan la narración más viva.\n`;
27 |                 break;
28 |             case 'Dislexia': // Dislexia o Dificultad en Lectura
29 |                 base += `   - **Lenguaje Sencillo y Accesible:** Opta por vocabulario común y frases cortas. Prefiere la voz activa y estructuras gramaticales directas (Sujeto-Verbo-Predicado).\n`;
30 |                 base += `   - **Evitar Complejidad Lingüística Innecesaria:** Reduce el uso de palabras con ortografía muy compleja o poco fonéticas si existen alternativas más simples. No uses jerga ni lenguaje excesivamente formal.\n`;
31 |                 base += `   - **Repetición Natural de Palabras Clave:** Reintroduce palabras importantes de forma sutil en diferentes contextos para facilitar su reconocimiento y afianzamiento, sin que suene forzado.\n`;
32 |                 base += `   - **Narrativa Clara y Lineal:** La progresión de eventos debe ser lógica y fácil de seguir, sin saltos temporales o argumentales confusos.\n`;
33 |                 break;
34 |             case 'Ansiedad': // Ansiedad o Miedos Específicos
35 |                 base += `   - **Tono General Tranquilizador y Optimista:** Mantén un ambiente narrativo calmado, amable y consistentemente positivo durante toda la historia.\n`;
36 |                 base += `   - **Resolución Clara y Segura del Conflicto:** El problema central debe resolverse de manera completa, positiva y que refuerce la sensación de seguridad. Evita finales ambiguos o abiertos que puedan generar inquietud.\n`;
37 |                 base += `   - **Evitar Ambigüedades y Elementos Perturbadores:** No incluyas elementos narrativos que puedan ser fácilmente interpretados como amenazantes. Sé cuidadoso con el suspense; si lo usas, que sea leve y se resuelva rápidamente de forma positiva.\n`;
38 |                 base += `   - **Modelado Sutil de Afrontamiento Positivo:** Si los personajes enfrentan pequeños desafíos o preocupaciones (comunes, no miedos intensos a menos que el usuario lo especifique), muéstralos manejándolos con calma, buscando ayuda de forma constructiva o encontrando soluciones prácticas y positivas.\n`;
39 |                 base += `   - **Previsibilidad Reconfortante:** Una estructura narrativa clara y con cierta previsibilidad en cuanto a su tono y resolución puede ser beneficiosa.\n`;
40 |                 break;
41 |             case 'Down': // Síndrome de Down
42 |                 base += `   - **Lenguaje Muy Concreto y Literal:** Usa palabras que se refieran a objetos, acciones y emociones observables y concretas. Evita abstracciones y lenguaje figurado.\n`;
43 |                 base += `   - **Frases Cortas y Estructura Simple:** Construye oraciones breves y con una estructura gramatical sencilla (Sujeto-Verbo-Objeto).\n`;
44 |                 base += `   - **Repetición de Información Clave:** Incorpora la repetición natural de nombres de personajes, lugares importantes, acciones clave o frases pegadizas para reforzar la memoria y la comprensión.\n`;
45 |                 base += `   - **Secuencia Narrativa Muy Clara y Lineal:** La historia debe seguir un orden de eventos simple, cronológico y fácil de anticipar. Divide la historia en partes claras si es posible (ej. primero pasó esto, luego esto otro, y al final...). \n`;
46 |                 base += `   - **Temas Familiares y Relevantes:** Utiliza situaciones, personajes y temas que puedan ser fácilmente relacionados con experiencias cotidianas o intereses comunes de los niños.\n`;
47 |                 break;
48 |             case 'Comprension': // Dificultades de Comprensión Auditiva o Lingüística
49 |                 base += `   - **Frases Muy Claras y Sencillas:** Usa oraciones cortas, directas y con una estructura gramatical simple. Evita la voz pasiva y las oraciones subordinadas complejas.\n`;
50 |                 base += `   - **Vocabulario Controlado y Explícito:** Utiliza palabras comunes y de alta frecuencia. Si es necesario introducir una palabra nueva, intenta que el contexto inmediato clarifique su significado de forma natural o usa una breve paráfrasis sencilla.\n`;
51 |                 base += `   - **Repetición Estratégica de Conceptos Clave:** Reitera información importante (nombres, lugares, ideas principales) de manera sutil y en diferentes momentos para facilitar su asimilación.\n`;
52 |                 base += `   - **Conexiones Lógicas Explícitas:** Asegúrate de que las relaciones de causa-efecto y las secuencias temporales sean muy evidentes. Puedes usar conectores sencillos y claros (ej. 'porque', 'entonces', 'después').\n`;
53 |                 base += `   - **Lenguaje Altamente Descriptivo (Visualizable):** Aunque la salida es texto, usa un lenguaje que ayude a crear imágenes mentales claras y vívidas de los personajes, escenarios y acciones.\n`;
54 |                 break;
55 |             default:
56 |                 base += `   - Dado que "${specialNeed}" es una necesidad específica no listada en las guías detalladas, enfócate en aplicar principios generales de adaptación: maximiza la claridad del lenguaje, asegura una estructura narrativa sencilla y comprensible, y mantén un tono consistentemente positivo y alentador.\n`;
57 |                 break;
58 |         }
59 |     }
60 |     base += ` La historia debe seguir una estructura narrativa clara: un inicio que capte la atención, un desarrollo con un conflicto claro y un final que resuelva el problema de manera positiva y educativa.`;
61 |     base += ` Sé creativo, asegurándote de que la trama sea coherente y atractiva. Utiliza un lenguaje sencillo, pero emocionalmente resonante.`;
62 |     base += ` Recuerda, la historia debe ser adecuada para su edad y debe ofrecer un aprendizaje valioso al final, manteniendo siempre un enfoque amigable y accesible para los niños.`;
63 |     return base;
64 | }
65 | 
66 | // Definición de tipos para las opciones del prompt de usuario (sin cambios respecto a v6.1)
67 | interface CharacterOptions {
68 |     name: string;
69 |     profession?: string;
70 |     hobbies?: string[];
71 |     personality?: string;
72 | }
73 | 
74 | interface UserPromptOptions {
75 |     character: CharacterOptions;
76 |     genre: string;
77 |     moral: string;
78 |     duration?: string;
79 |     language?: string;
80 | }
81 | 
82 | interface CreateUserPromptParams {
83 |     options: UserPromptOptions;
84 |     additionalDetails?: string;
85 | }
86 | 
87 | // createUserPrompt_JsonFormat: Anteriormente createUserPrompt_SeparatorFormat.
88 | // Modificada para instruir a la IA a devolver un objeto JSON.
89 | // El contenido textual de la guía para la IA no cambia, solo el formato de respuesta.
90 | export function createUserPrompt_JsonFormat({ options, additionalDetails }: CreateUserPromptParams): string {
91 |     console.log(`[Helper v7.0] createUserPrompt_JsonFormat: options=`, options, `details=`, additionalDetails); // Log version actualizada
92 |     const char = options.character;
93 |     const storyDuration = options.duration || 'medium';
94 |     const language = options.language || 'es';
95 | 
96 |     // Create base request (sin cambios en el texto respecto a v6.1)
97 |     let request = `Crea un cuento infantil. Género: ${options.genre}. Moraleja: ${options.moral}. Personaje principal: ${char.name}`;
98 |     if (char.profession) request += `, profesión: ${char.profession}`;
99 |     if (char.hobbies?.length) request += `, hobbies: ${char.hobbies.join(', ')}`;
100 |     if (char.personality) request += `, personalidad: ${char.personality}`;
101 |     request += `.\n\n`;
102 | 
103 |     // Content, length and structure instructions (sin cambios en el texto respecto a v6.1)
104 |     request += `**Instrucciones de Contenido, Longitud y Estructura:**\n`;
105 |     request += `1. **Duración objetivo:** '${storyDuration}'.\n`;
106 | 
107 |     if (storyDuration === 'short') request += `    * Guía (Corta): ~800 tokens.\n`; // Espaciado consistente con v6.1
108 |     else if (storyDuration === 'long') request += `    * Guía (Larga): ~2150 tokens.\n`; // Espaciado consistente con v6.1
109 |     else request += `    * Guía (Media): ~1350 tokens.\n`; // Espaciado consistente con v6.1
110 | 
111 |     // Additional user details (if any) (sin cambios en el texto respecto a v6.1)
112 |     if (additionalDetails && typeof additionalDetails === 'string' && additionalDetails.trim()) {
113 |         request += `\n**Instrucciones adicionales del usuario:**\n${additionalDetails.trim()}\n`;
114 |     }
115 | 
116 |     // Story structure instructions (sin cambios en el texto respecto a v6.1)
117 |     request += `2. **Estructura completa:** Inicio, desarrollo y final claros.\n`;
118 | 
119 |     // Tone and style (sin cambios en el texto respecto a v6.1)
120 |     request += `3. **Tono y estilo:** Emplea onomatopeyas o pequeñas preguntas como: “¿Te imaginas…?”, “¡Splash!”, etc., para mantener la atención de los niños.\n`;
121 |     request += `   Además, usa ocasionalmente la estructura de fábula, especialmente si el género lo permite (aventura, fantasía, etc.).\n`; // Espaciado consistente con v6.1
122 | 
123 |     // **Inspiration** (sin cambios en el texto respecto a v6.1)
124 |     request += `4. **Inspiración:** Toma elementos de la tradición oral y de los clásicos de Disney (magia, amistad, humor inocente), pero crea personajes y situaciones originales. Evita copiar y busca innovar con ideas frescas y emocionantes.\n`;
125 | 
126 |     // Title request (texto general sin cambios, se adapta al formato JSON abajo)
127 |     request += `5. **Título:** Genera un título extraordinario (memorable, original, etc.). El título debe seguir el estilo "Sentence case", donde solo la primera palabra y los nombres propios comienzan con mayúscula. El título debe estar escrito en el mismo idioma seleccionado para la historia: ${language}.\n`;
128 | 
129 |     // Response format instructions (MODIFICADO PARA JSON)
130 |     request += `\n**Instrucciones de formato de respuesta (¡MUY IMPORTANTE!):**\n`;
131 |     request += `* Debes responder con un ÚNICO objeto JSON.\n`;
132 |     request += `* El objeto JSON debe tener exactamente dos claves (keys): "title" y "content".\n`;
133 |     request += `* El valor de la clave "title" debe ser una cadena de texto (string) que contenga ÚNICAMENTE el título generado (idealmente entre 4 y 7 palabras), respetando las indicaciones del punto 5 sobre el título (idioma ${language}, "Sentence case").\n`;
134 |     request += `* El valor de la clave "content" debe ser una cadena de texto (string) con TODO el contenido del cuento, comenzando directamente con la primera frase de la historia.\n`;
135 |     request += `* Ejemplo del formato JSON esperado: {"title": "Un título extraordinario aquí", "content": "Había una vez en un lugar muy lejano..."}\n`;
136 |     request += `* NO incluyas NADA antes del carácter '{' que inicia el objeto JSON.\n`;
137 |     request += `* NO incluyas NADA después del carácter '}' que finaliza el objeto JSON.\n`;
138 |     request += `* Asegúrate de que el JSON sea válido y completo.\n`;
139 |     request += `* NO uses markdown ni ningún otro formato DENTRO de los strings del JSON a menos que sea parte natural del texto del cuento.\n`;
140 | 
141 |     return request;
142 | }
```

supabase/functions/challenge/index.ts
```
1 | import { GoogleGenerativeAI } from "npm:@google/generative-ai";
2 | import { serve } from "https://deno.land/std@0.177.0/http/server.ts";
3 | import { corsHeaders } from '../_shared/cors.ts';
4 | import { v4 as uuidv4 } from "npm:uuid@9.0.0";
5 | import {
6 |   getSystemPromptPreamble,
7 |   getLanguageChallengeInstruction,
8 |   getMathChallengeInstruction,
9 |   getComprehensionChallengeInstruction,
10 |   getSpecialNeedInstruction,
11 | } from "./prompt.ts"; // Asegúrate que la ruta a prompt.ts sea correcta
12 | 
13 | // Configuración de la API de Gemini
14 | const API_KEY = Deno.env.get("GEMINI_API_KEY") || "";
15 | const genAI = new GoogleGenerativeAI(API_KEY);
16 | 
17 | const modelName = Deno.env.get('TEXT_MODEL_GENERATE') || "gemini-pro"; // Default model si no está en env
18 | const model = genAI.getGenerativeModel({
19 |   model: modelName,
20 | });
21 | 
22 | // Generar un UUID
23 | const generateId = () => uuidv4();
24 | 
25 | // Tipos necesarios
26 | interface ProfileSettings {
27 |   childAge: number;
28 |   specialNeed?: string;
29 |   language: string;
30 | }
31 | 
32 | interface StoryCharacter {
33 |   id: string;
34 |   name: string;
35 |   profession: string;
36 |   characterType: string;
37 |   hobbies: string[];
38 |   personality?: string;
39 | }
40 | 
41 | interface StoryOptions {
42 |   character: StoryCharacter;
43 |   genre: string;
44 |   moral: string;
45 |   duration: "short" | "medium" | "long";
46 | }
47 | 
48 | interface Story {
49 |   id: string;
50 |   title: string;
51 |   content: string;
52 |   options: StoryOptions;
53 | }
54 | 
55 | type ChallengeCategory = "language" | "math" | "comprehension";
56 | 
57 | interface ChallengeQuestion {
58 |   id: string;
59 |   category: ChallengeCategory;
60 |   question: string;
61 |   options: string[];
62 |   correctOptionIndex: number;
63 |   explanation: string;
64 |   targetLanguage?: string;
65 | }
66 | 
67 | interface Challenge {
68 |   id: string;
69 |   storyId: string;
70 |   questions: ChallengeQuestion[];
71 |   createdAt: string;
72 | }
73 | 
74 | /**
75 |  * Genera una pregunta de desafío basada en la historia
76 |  */
77 | async function generateChallengeQuestion(
78 |   story: Story,
79 |   category: ChallengeCategory,
80 |   profileSettings: ProfileSettings,
81 |   targetLanguage?: string,
82 | ): Promise<{
83 |   question: string;
84 |   options: string[];
85 |   correctOptionIndex: number;
86 |   explanation: string;
87 | }> {
88 |   try {
89 |     // Extraer datos relevantes del perfil y la historia
90 |     const { childAge, specialNeed, language } = profileSettings;
91 |     const { character, genre, moral } = story.options;
92 | 
93 |     const profileDataForPrompt = { childAge, language, specialNeed };
94 |     const storyDataForPrompt = { title: story.title, genre, moral, content: story.content };
95 |     const characterDataForPrompt = { ...character };
96 | 
97 |     let systemPrompt = getSystemPromptPreamble(profileDataForPrompt, storyDataForPrompt, characterDataForPrompt);
98 | 
99 |     switch (category) {
100 |       case "language":
101 |         if (!targetLanguage) {
102 |           throw new Error("targetLanguage es requerido para la categoría 'language'");
103 |         }
104 |         systemPrompt += getLanguageChallengeInstruction(childAge, specialNeed, targetLanguage);
105 |         break;
106 |       case "math":
107 |         systemPrompt += getMathChallengeInstruction(childAge, specialNeed);
108 |         break;
109 |       case "comprehension":
110 |         systemPrompt += getComprehensionChallengeInstruction(childAge, specialNeed);
111 |         break;
112 |     }
113 | 
114 |     systemPrompt += getSpecialNeedInstruction(specialNeed);
115 | 
116 |     const result = await model.generateContent({
117 |       contents: [{ role: "user", parts: [{ text: systemPrompt }] }],
118 |       generationConfig: {
119 |         temperature: 0.7,
120 |         topK: 40,
121 |         topP: 0.95,
122 |       },
123 |     });
124 |     const response = await result.response;
125 |     const text = response.text();
126 | 
127 |     try {
128 |       const jsonMatch = text.match(/```json\s*(\{[\s\S]*?\})\s*```/) ||
129 |         text.match(/```\s*(\{[\s\S]*?\})\s*```/) ||
130 |         text.match(/(\{[\s\S]*?\})/);
131 | 
132 |       if (jsonMatch && jsonMatch[1]) {
133 |         const jsonResponse = JSON.parse(jsonMatch[1]);
134 | 
135 |         if (
136 |           !jsonResponse.question || !jsonResponse.options ||
137 |           typeof jsonResponse.correctOptionIndex !== "number" ||
138 |           !jsonResponse.explanation
139 |         ) {
140 |           throw new Error("Invalid response format from AI");
141 |         }
142 | 
143 |         return {
144 |           question: jsonResponse.question,
145 |           options: jsonResponse.options,
146 |           correctOptionIndex: jsonResponse.correctOptionIndex,
147 |           explanation: jsonResponse.explanation,
148 |         };
149 |       } else {
150 |         console.error("AI Response Text:", text); // Loguear la respuesta si no se encuentra JSON
151 |         throw new Error("Could not extract JSON from AI response");
152 |       }
153 |     } catch (parseError) {
154 |       console.error("Failed to parse AI response:", text, parseError);
155 |       return generateFallbackQuestion(category, targetLanguage, story);
156 |     }
157 |   } catch (error) {
158 |     console.error("Error in generateChallengeQuestion:", error);
159 |     return generateFallbackQuestion(category, targetLanguage, story);
160 |   }
161 | }
162 | 
163 | /**
164 |  * Genera una pregunta de respaldo si la API falla
165 |  */
166 | function generateFallbackQuestion(
167 |   category: ChallengeCategory,
168 |   targetLanguage?: string,
169 |   story?: Story,
170 | ): {
171 |   question: string;
172 |   options: string[];
173 |   correctOptionIndex: number;
174 |   explanation: string;
175 | } {
176 |   const characterName = story?.options?.character?.name || "protagonista";
177 | 
178 |   switch (category) {
179 |     case "language":
180 |       return {
181 |         question: `¿Cómo se dice "${story ? "amigo" : "amigo"}" en ${targetLanguage || "inglés"
182 |           }?`,
183 |         options: ["Friend", "House", "Book", "Play"],
184 |         correctOptionIndex: 0,
185 |         explanation: `"Amigo" en ${targetLanguage || "inglés"
186 |           } se dice "Friend". Es una palabra importante para las relaciones personales.`,
187 |       };
188 | 
189 |     case "math":
190 |       return {
191 |         question:
192 |           `Si ${characterName} tiene 5 objetos y encuentra 3 más, ¿cuántos tiene en total?`,
193 |         options: ["7", "8", "9", "10"],
194 |         correctOptionIndex: 1,
195 |         explanation:
196 |           "La suma de 5 + 3 = 8. Recuerda que para sumar debes combinar ambas cantidades.",
197 |       };
198 | 
199 |     case "comprehension":
200 |       return {
201 |         question: `¿Qué aprendemos de la historia de ${characterName}?`,
202 |         options: [
203 |           "Es importante ayudar a los demás",
204 |           "Nunca debemos confiar en nadie",
205 |           "La amistad no es importante",
206 |           "No debemos esforzarnos",
207 |         ],
208 |         correctOptionIndex: 0,
209 |         explanation:
210 |           "La historia nos enseña la importancia de ayudar a los demás. Cuando cooperamos y somos amables, todos salimos beneficiados.",
211 |       };
212 |   }
213 | }
214 | 
215 | /**
216 |  * Crea un nuevo desafío con una pregunta
217 |  */
218 | async function createChallenge(
219 |   story: Story,
220 |   category: ChallengeCategory,
221 |   profileSettings: ProfileSettings,
222 |   targetLanguage?: string,
223 | ): Promise<Challenge> {
224 |   try {
225 |     const questionData = await generateChallengeQuestion(
226 |       story,
227 |       category,
228 |       profileSettings,
229 |       targetLanguage,
230 |     );
231 | 
232 |     const question: ChallengeQuestion = {
233 |       id: generateId(),
234 |       category,
235 |       targetLanguage: category === "language" ? targetLanguage : undefined,
236 |       ...questionData,
237 |     };
238 | 
239 |     const challenge: Challenge = {
240 |       id: generateId(),
241 |       storyId: story.id,
242 |       questions: [question],
243 |       createdAt: new Date().toISOString(),
244 |     };
245 | 
246 |     return challenge;
247 |   } catch (error) {
248 |     console.error("Error creating challenge:", error);
249 |     throw error; // Re-throw para que sea manejado por el handler principal
250 |   }
251 | }
252 | 
253 | /**
254 |  * Lista de idiomas disponibles para desafíos de idiomas
255 |  */
256 | function getAvailableLanguages(
257 |   currentLanguage: string,
258 | ): { code: string; name: string }[] {
259 |   const languages = [
260 |     { code: "en", name: "Inglés" },
261 |     { code: "es", name: "Español" },
262 |     { code: "fr", name: "Francés" },
263 |     { code: "de", name: "Alemán" },
264 |     { code: "it", name: "Italiano" },
265 |     { code: "pt", name: "Portugués" },
266 |     { code: "ru", name: "Ruso" },
267 |     { code: "zh", name: "Chino" },
268 |     { code: "ja", name: "Japonés" },
269 |     { code: "ko", name: "Coreano" },
270 |   ];
271 | 
272 |   return languages.filter((lang) => lang.code !== currentLanguage);
273 | }
274 | 
275 | /**
276 |  * Función principal para manejar las solicitudes
277 |  */
278 | serve(async (req) => {
279 |   if (req.method === "OPTIONS") {
280 |     return new Response("ok", { headers: corsHeaders });
281 |   }
282 | 
283 |   try {
284 |     const body = await req.json();
285 |     const { action, story, category, profileSettings, targetLanguage } = body;
286 | 
287 |     if (!action) {
288 |       return new Response(
289 |         JSON.stringify({ error: "La acción no fue proporcionada." }),
290 |         {
291 |           headers: { ...corsHeaders, "Content-Type": "application/json" },
292 |           status: 400, // Bad Request
293 |         },
294 |       );
295 |     }
296 | 
297 |     if (action === "createChallenge") {
298 |       if (!story || !category || !profileSettings) {
299 |         return new Response(
300 |           JSON.stringify({ error: "Faltan parámetros para createChallenge: story, category o profileSettings." }),
301 |           {
302 |             headers: { ...corsHeaders, "Content-Type": "application/json" },
303 |             status: 400,
304 |           },
305 |         );
306 |       }
307 |       if (category === "language" && !targetLanguage) {
308 |         return new Response(
309 |           JSON.stringify({ error: "Falta el parámetro targetLanguage para la categoría 'language'." }),
310 |           {
311 |             headers: { ...corsHeaders, "Content-Type": "application/json" },
312 |             status: 400,
313 |           },
314 |         );
315 |       }
316 | 
317 |       const challenge = await createChallenge(
318 |         story,
319 |         category,
320 |         profileSettings,
321 |         targetLanguage,
322 |       );
323 | 
324 |       return new Response(
325 |         JSON.stringify(challenge),
326 |         {
327 |           headers: { ...corsHeaders, "Content-Type": "application/json" },
328 |           status: 200,
329 |         },
330 |       );
331 |     } else if (action === "getLanguages") {
332 |       if (!profileSettings || !profileSettings.language) {
333 |         return new Response(
334 |           JSON.stringify({ error: "Falta profileSettings.language para getLanguages." }),
335 |           {
336 |             headers: { ...corsHeaders, "Content-Type": "application/json" },
337 |             status: 400,
338 |           },
339 |         );
340 |       }
341 |       const languages = getAvailableLanguages(profileSettings.language);
342 | 
343 |       return new Response(
344 |         JSON.stringify({ languages }),
345 |         {
346 |           headers: { ...corsHeaders, "Content-Type": "application/json" },
347 |           status: 200,
348 |         },
349 |       );
350 |     } else {
351 |       return new Response(
352 |         JSON.stringify({ error: `Acción no soportada: ${action}` }),
353 |         {
354 |           headers: { ...corsHeaders, "Content-Type": "application/json" },
355 |           status: 400, // Bad Request para acciones no válidas
356 |         },
357 |       );
358 |     }
359 |   } catch (error) {
360 |     console.error("Server Error:", error); // Log del error en el servidor
361 |     const errorMessage = error instanceof Error ? error.message : "Error interno del servidor";
362 |     return new Response(
363 |       JSON.stringify({ error: errorMessage }),
364 |       {
365 |         headers: { ...corsHeaders, "Content-Type": "application/json" },
366 |         status: 500, // Internal Server Error
367 |       },
368 |     );
369 |   }
370 | });
371 | 
372 | console.log("Challenge generation service running...");
```

supabase/functions/challenge/prompt.ts
```
1 | // prompt.ts
2 | 
3 | interface StoryDataForPrompt {
4 |     title: string;
5 |     genre: string;
6 |     moral: string;
7 |     content: string;
8 | }
9 | 
10 | interface CharacterDataForPrompt {
11 |     name: string;
12 |     profession: string;
13 |     characterType: string;
14 |     hobbies: string[];
15 |     personality?: string;
16 | }
17 | 
18 | interface ProfileDataForPrompt {
19 |     childAge: number;
20 |     language: string;
21 |     specialNeed?: string;
22 | }
23 | 
24 | export function getSystemPromptPreamble(
25 |     profile: ProfileDataForPrompt,
26 |     story: StoryDataForPrompt,
27 |     character: CharacterDataForPrompt,
28 | ): string {
29 |     return `Eres un experto educador infantil especializado en crear preguntas educativas para niños. Tu tarea es crear una pregunta de desafío educativo basada en el siguiente contexto:
30 |   
31 |   DATOS DEL OYENTE:
32 |   - Edad: ${profile.childAge} años
33 |   - Idioma principal: ${profile.language}
34 |   ${profile.specialNeed && profile.specialNeed !== "Ninguna" ? `- Necesidad especial: ${profile.specialNeed}` : ""}
35 |   
36 |   DATOS DE LA HISTORIA:
37 |   - Título: ${story.title}
38 |   - Género: ${story.genre}
39 |   - Moraleja/Enseñanza: ${story.moral}
40 |   
41 |   PERSONAJE PRINCIPAL:
42 |   - Nombre: ${character.name}
43 |   - Profesión: ${character.profession}
44 |   - Tipo de personaje: ${character.characterType}
45 |   - Aficiones: ${character.hobbies.join(", ")}
46 |   - Personalidad: ${character.personality || "No especificada"}
47 |   
48 |   HISTORIA COMPLETA:
49 |   ${story.content}
50 |   
51 |   `;
52 | }
53 | 
54 | export function getLanguageChallengeInstruction(
55 |     childAge: number,
56 |     specialNeed: string | undefined,
57 |     targetLanguage: string, // Es requerido para esta instrucción
58 | ): string {
59 |     return `
60 |   INSTRUCCIÓN:
61 |   Crea una pregunta para aprender el idioma ${targetLanguage} relacionada con elementos de la historia. La pregunta debe:
62 |   1. Contener una palabra o frase en ${targetLanguage} relacionada con un elemento clave de la historia (personaje, objeto, acción, etc.)
63 |   2. Ofrecer 4 opciones de respuesta (solo una correcta)
64 |   3. Ser apropiada para un niño de ${childAge} años ${specialNeed && specialNeed !== "Ninguna" ? `con ${specialNeed}` : ""
65 |         }
66 |   4. Incluir una explicación clara de por qué la respuesta es correcta
67 |   
68 |   FORMATO DE RESPUESTA (es obligatorio usar este formato exacto):
69 |   {
70 |     "question": "Texto de la pregunta en español incluyendo la palabra en ${targetLanguage}",
71 |     "options": ["Opción 1", "Opción 2", "Opción 3", "Opción 4"],
72 |     "correctOptionIndex": 0,
73 |     "explanation": "Explicación de la respuesta correcta"
74 |   }`;
75 | }
76 | 
77 | export function getMathChallengeInstruction(
78 |     childAge: number,
79 |     specialNeed: string | undefined,
80 | ): string {
81 |     return `
82 |   INSTRUCCIÓN:
83 |   Crea un problema matemático relacionado con elementos de la historia. El problema debe:
84 |   1. Utilizar personajes, objetos o situaciones que aparecen en la historia
85 |   2. Ser apropiado para el nivel educativo de un niño de ${childAge} años ${specialNeed && specialNeed !== "Ninguna" ? `con ${specialNeed}` : ""
86 |         }
87 |   3. Ofrecer 4 opciones de respuesta (solo una correcta)
88 |   4. Incluir una explicación clara de cómo se resuelve el problema
89 |   
90 |   FORMATO DE RESPUESTA (es obligatorio usar este formato exacto):
91 |   {
92 |     "question": "Texto del problema matemático contextualizado en la historia",
93 |     "options": ["Opción 1", "Opción 2", "Opción 3", "Opción 4"],
94 |     "correctOptionIndex": 0,
95 |     "explanation": "Explicación paso a paso de cómo resolver el problema"
96 |   }`;
97 | }
98 | 
99 | export function getComprehensionChallengeInstruction(
100 |     childAge: number,
101 |     specialNeed: string | undefined,
102 | ): string {
103 |     return `
104 |   INSTRUCCIÓN:
105 |   Crea una pregunta de comprensión lectora relacionada con la historia. La pregunta debe:
106 |   1. Evaluar la comprensión de la trama, personajes, motivaciones o enseñanza de la historia
107 |   2. Ser apropiada para un niño de ${childAge} años ${specialNeed && specialNeed !== "Ninguna" ? `con ${specialNeed}` : ""
108 |         }
109 |   3. Ofrecer 4 opciones de respuesta (solo una correcta)
110 |   4. Incluir una explicación clara de por qué la respuesta es correcta, citando elementos específicos de la historia
111 |   
112 |   FORMATO DE RESPUESTA (es obligatorio usar este formato exacto):
113 |   {
114 |     "question": "Texto de la pregunta de comprensión",
115 |     "options": ["Opción 1", "Opción 2", "Opción 3", "Opción 4"],
116 |     "correctOptionIndex": 0,
117 |     "explanation": "Explicación detallada de la respuesta correcta con referencias a la historia"
118 |   }`;
119 | }
120 | 
121 | export function getSpecialNeedInstruction(specialNeed?: string): string {
122 |     if (!specialNeed || specialNeed === "Ninguna") {
123 |         return "";
124 |     }
125 | 
126 |     let adaptationPrompt = `\n\nIMPORTANTE: La pregunta debe estar adaptada para un niño con ${specialNeed}. Asegúrate de que:`;
127 |     switch (specialNeed) {
128 |         case "TEA":
129 |             adaptationPrompt += `
130 |   - El lenguaje sea claro, directo y literal
131 |   - Las instrucciones sean explícitas
132 |   - Evita el uso de metáforas o lenguaje figurado
133 |   - Las opciones de respuesta sean concretas`;
134 |             break;
135 |         case "TDAH":
136 |             adaptationPrompt += `
137 |   - La pregunta sea breve y directa
138 |   - El contenido sea visualmente atractivo
139 |   - Las opciones de respuesta sean concisas
140 |   - La explicación sea dinámica y enfocada`;
141 |             break;
142 |         case "Dislexia":
143 |             adaptationPrompt += `
144 |   - La pregunta use vocabulario sencillo y familiar
145 |   - Las frases sean cortas y estructuradas
146 |   - Evita palabras visualmente similares
147 |   - Las opciones de respuesta sean claramente diferenciables`;
148 |             break;
149 |         default:
150 |             // No añade nada si la necesidad especial no está en la lista
151 |             return "";
152 |     }
153 |     return adaptationPrompt;
154 | }
```

supabase/functions/stripe-webhook/index.ts
```
1 | // supabase/functions/stripe-webhook/index.ts
2 | 
3 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
4 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
5 | import Stripe from 'https://esm.sh/stripe@14.13.0?target=deno';
6 | // Asegúrate que la ruta es correcta para tu estructura
7 | import { corsHeaders } from '../_shared/cors.ts'; // Ajusta si moviste cors.ts
8 | 
9 | // --- Constantes y Configuración ---
10 | console.log(`[WEBHOOK_DEBUG] Stripe Webhook Function Initializing...`);
11 | 
12 | const STRIPE_SECRET_KEY = Deno.env.get('STRIPE_SECRET_KEY');
13 | const STRIPE_SIGNING_SECRET = Deno.env.get('STRIPE_SIGNING_SECRET');
14 | const APP_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY'); // O el nombre que uses
15 | const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
16 | 
17 | if (!STRIPE_SECRET_KEY || !STRIPE_SIGNING_SECRET || !SUPABASE_URL || !APP_SERVICE_ROLE_KEY) {
18 |   console.error('[WEBHOOK_ERROR] CRITICAL: Missing environment variables. Check STRIPE_SECRET_KEY, STRIPE_SIGNING_SECRET, SUPABASE_SERVICE_ROLE_KEY.');
19 |   // Considera lanzar un error
20 | }
21 | 
22 | const stripe = new Stripe(STRIPE_SECRET_KEY!, {
23 |   apiVersion: '2023-10-16',
24 |   httpClient: Stripe.createFetchHttpClient(),
25 | });
26 | 
27 | const cryptoProvider = Stripe.createSubtleCryptoProvider();
28 | 
29 | const supabaseAdmin = createClient(SUPABASE_URL!, APP_SERVICE_ROLE_KEY!);
30 | 
31 | console.log('[WEBHOOK_DEBUG] Stripe Webhook Function Initialized successfully.');
32 | 
33 | // --- Lógica Principal del Servidor ---
34 | serve(async (req: Request) => {
35 |   if (req.method === 'OPTIONS') {
36 |     console.log('[WEBHOOK_DEBUG] Handling OPTIONS preflight request');
37 |     return new Response('ok', { headers: corsHeaders });
38 |   }
39 | 
40 |   const signature = req.headers.get('Stripe-Signature');
41 |   if (!signature) {
42 |     console.error('[WEBHOOK_ERROR] FAIL: Missing Stripe-Signature header');
43 |     return new Response('Missing Stripe-Signature header', { status: 400 });
44 |   }
45 | 
46 |   const body = await req.text();
47 | 
48 |   try {
49 |     // 1. Verifica la firma
50 |     console.log('[WEBHOOK_DEBUG] Verifying webhook signature...');
51 |     const event = await stripe.webhooks.constructEventAsync(
52 |       body,
53 |       signature,
54 |       STRIPE_SIGNING_SECRET!,
55 |       undefined,
56 |       cryptoProvider
57 |     );
58 |     console.log(`[WEBHOOK_INFO] Webhook event received: ${event.id}, Type: ${event.type}`);
59 | 
60 |     // 2. Maneja el evento
61 |     const eventObject = event.data.object as any;
62 |     let supabaseUserId: string | null = null;
63 |     let stripeCustomerId: string | null = null;
64 | 
65 |     // --- Inicio: Lógica robusta para identificar al usuario ---
66 |     console.log('[WEBHOOK_DEBUG] Attempting to identify user...');
67 |     if (eventObject.customer) {
68 |       stripeCustomerId = eventObject.customer;
69 |       console.log(`[WEBHOOK_DEBUG] Found stripeCustomerId from event object: ${stripeCustomerId}`);
70 |     }
71 | 
72 |     if (eventObject.metadata?.supabase_user_id) {
73 |       supabaseUserId = eventObject.metadata.supabase_user_id;
74 |       console.log(`[WEBHOOK_DEBUG] Found supabaseUserId from event metadata: ${supabaseUserId}`);
75 |     }
76 |     else if (stripeCustomerId) {
77 |       console.log(`[WEBHOOK_DEBUG] supabaseUserId not in event metadata, trying customer metadata for ${stripeCustomerId}...`);
78 |       try {
79 |         const customer = await stripe.customers.retrieve(stripeCustomerId) as Stripe.Customer;
80 |         if (!customer.deleted && customer.metadata?.supabase_user_id) {
81 |           supabaseUserId = customer.metadata.supabase_user_id;
82 |           console.log(`[WEBHOOK_DEBUG] Found supabaseUserId from customer metadata: ${supabaseUserId}`);
83 |         } else {
84 |           console.log(`[WEBHOOK_DEBUG] supabase_user_id not found in customer metadata or customer deleted.`);
85 |         }
86 |       } catch (customerError) { console.warn(`[WEBHOOK_WARN] Error retrieving customer ${stripeCustomerId}:`, customerError.message); }
87 |     }
88 | 
89 |     if (!supabaseUserId && stripeCustomerId) {
90 |       console.log(`[WEBHOOK_DEBUG] supabaseUserId not found yet, querying profiles table for customer ${stripeCustomerId}...`);
91 |       try {
92 |         const { data: profile, error: profileError } = await supabaseAdmin
93 |           .from('profiles').select('id').eq('stripe_customer_id', stripeCustomerId).single();
94 |         if (profileError && profileError.code !== 'PGRST116') { // Ignore 'not found' error, log others
95 |           console.error(`[WEBHOOK_ERROR] DB error querying profiles for ${stripeCustomerId}:`, profileError);
96 |         } else if (profile) {
97 |           supabaseUserId = profile.id;
98 |           console.log(`[WEBHOOK_DEBUG] Found supabaseUserId ${supabaseUserId} from profiles table.`);
99 |         } else {
100 |           console.log(`[WEBHOOK_DEBUG] Profile not found for stripe_customer_id ${stripeCustomerId}.`);
101 |         }
102 |       } catch (dbError) {
103 |         console.error(`[WEBHOOK_ERROR] Exception querying profiles table for customer ${stripeCustomerId}:`, dbError.message);
104 |       }
105 |     }
106 | 
107 |     if (!supabaseUserId && !['customer.subscription.deleted', 'customer.deleted'].includes(event.type)) {
108 |       console.error(`[WEBHOOK_ERROR] CRITICAL FAIL: Could not determine supabase_user_id for event ${event.id} (Type: ${event.type}). Customer: ${stripeCustomerId}. Cannot process update.`);
109 |       return new Response(JSON.stringify({ received: true, error: 'Webhook Error: User identification failed.' }), { status: 200 });
110 |     } else if (supabaseUserId) {
111 |       console.log(`[WEBHOOK_DEBUG] User identified successfully: supabaseUserId=${supabaseUserId}`);
112 |     } else {
113 |       console.log(`[WEBHOOK_DEBUG] Proceeding without supabaseUserId (likely a customer deletion event).`);
114 |     }
115 |     // --- Fin: Lógica robusta para identificar al usuario ---
116 | 
117 |     // --- Manejadores de Eventos Específicos ---
118 |     switch (event.type) {
119 | 
120 |       case 'checkout.session.completed': {
121 |         const session = eventObject as Stripe.Checkout.Session;
122 |         console.log(`[WEBHOOK_INFO] Processing checkout.session.completed for session ${session.id}, Mode: ${session.mode}`);
123 | 
124 |         // --- Suscripción Iniciada ---
125 |         if (session.mode === 'subscription') {
126 |           if (!supabaseUserId) throw new Error(`[WEBHOOK_ERROR] Cannot process subscription checkout ${session.id}: missing supabase_user_id.`);
127 | 
128 |           const subscriptionId = session.subscription as string;
129 |           console.log(`[WEBHOOK_DEBUG] Retrieving subscription ${subscriptionId}`);
130 |           const subscription = await stripe.subscriptions.retrieve(subscriptionId);
131 |           // const planId = subscription.items.data[0]?.price.id; // Descomenta si necesitas
132 |           const status = subscription.status;
133 |           const currentPeriodEnd = new Date(subscription.current_period_end * 1000);
134 | 
135 |           console.log(`[WEBHOOK_INFO] Updating profile for new subscription ${subscription.id} for user ${supabaseUserId}`);
136 |           const { error } = await supabaseAdmin
137 |             .from('profiles')
138 |             .update({
139 |               stripe_subscription_id: subscription.id,
140 |               subscription_status: status,
141 |               stripe_customer_id: stripeCustomerId, // Asegurar que esté guardado/actualizado
142 |               current_period_end: currentPeriodEnd.toISOString(),
143 |               monthly_voice_generations_used: 0, // Resetear contador de uso
144 |             })
145 |             .eq('id', supabaseUserId);
146 | 
147 |           if (error) {
148 |             console.error(`[WEBHOOK_ERROR] FAIL: Error updating profile for subscription ${subscription.id}:`, error);
149 |             throw error; // Relanza para el catch general
150 |           } else {
151 |             console.log(`[WEBHOOK_INFO] OK: Profile updated for new subscription ${subscription.id}.`);
152 |           }
153 | 
154 |           // --- Compra Única (Créditos) - CÓDIGO CORREGIDO + DEBUGGING ---
155 |         } else if (session.mode === 'payment') {
156 |           console.log(`[WEBHOOK_DEBUG] Handling checkout.session.completed for one-time payment: ${session.id}`);
157 | 
158 |           const paymentIntentId = session.payment_intent as string;
159 |           if (!paymentIntentId) {
160 |             console.error(`[WEBHOOK_ERROR] FAIL: Payment Intent ID missing in session ${session.id} for mode=payment.`);
161 |             return new Response(JSON.stringify({ received: true, error: 'Missing payment intent ID' }), { status: 200 });
162 |           }
163 |           console.log(`[WEBHOOK_DEBUG] Found PaymentIntent ID from session: ${paymentIntentId}`);
164 | 
165 |           let paymentIntent: Stripe.PaymentIntent;
166 |           try {
167 |             console.log(`[WEBHOOK_DEBUG] Retrieving PaymentIntent ${paymentIntentId}...`);
168 |             paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);
169 |             console.log(`[WEBHOOK_DEBUG] Retrieved PaymentIntent ${paymentIntent.id}. Status: ${paymentIntent.status}`);
170 |           } catch (piError) {
171 |             console.error(`[WEBHOOK_ERROR] FAIL: Could not retrieve PaymentIntent ${paymentIntentId}:`, piError);
172 |             return new Response(JSON.stringify({ received: true, error: 'Failed to retrieve payment intent' }), { status: 200 });
173 |           }
174 | 
175 |           // !! LEER METADATA DEL PAYMENT INTENT RECUPERADO !!
176 |           const piMetadata = paymentIntent.metadata; // Objeto metadata completo
177 |           const itemPurchased = piMetadata?.item_purchased;
178 |           const userIdFromMetadata = piMetadata?.supabase_user_id;
179 | 
180 |           // -------- AÑADIR ESTOS LOGS --------
181 |           console.log(`[WEBHOOK_DEBUG] Retrieved PaymentIntent Metadata: ${JSON.stringify(piMetadata)}`);
182 |           console.log(`[WEBHOOK_DEBUG] Value read for itemPurchased: "${itemPurchased}" (Type: ${typeof itemPurchased})`);
183 |           // -----------------------------------
184 | 
185 |           // Re-verificar supabaseUserId si no se obtuvo antes
186 |           if (!supabaseUserId && userIdFromMetadata) {
187 |             supabaseUserId = userIdFromMetadata;
188 |             console.log(`[WEBHOOK_DEBUG] supabaseUserId updated from PaymentIntent metadata: ${supabaseUserId}`);
189 |           }
190 | 
191 |           if (!supabaseUserId) {
192 |             console.error(`[WEBHOOK_ERROR] FAIL: Cannot process payment intent ${paymentIntent.id}: missing supabase_user_id after all checks.`);
193 |             return new Response(JSON.stringify({ received: true, error: 'User identification failed for payment' }), { status: 200 });
194 |           }
195 | 
196 |           // Comparar con la cadena EXACTA 'voice_credits'
197 |           if (itemPurchased === 'voice_credits') {
198 |             console.log(`[WEBHOOK_DEBUG] Condition 'itemPurchased === "voice_credits"' is TRUE.`);
199 | 
200 |             if (paymentIntent.status !== 'succeeded') {
201 |               console.warn(`[WEBHOOK_WARN] PaymentIntent ${paymentIntent.id} status is ${paymentIntent.status}, not 'succeeded'. Skipping credit increment.`);
202 |               return new Response(JSON.stringify({ received: true, status: 'payment_not_succeeded' }), { status: 200 });
203 |             }
204 | 
205 |             // ¡¡¡ VERIFICA ESTE NÚMERO !!!
206 |             const creditsToAdd = 20; // Ejemplo: 20 créditos
207 |             console.log(`[WEBHOOK_INFO] Attempting to add ${creditsToAdd} voice credits to user ${supabaseUserId} via RPC.`);
208 | 
209 |             const { error: creditError } = await supabaseAdmin.rpc('increment_voice_credits', {
210 |               user_uuid: supabaseUserId,
211 |               credits_to_add: creditsToAdd
212 |             });
213 | 
214 |             if (creditError) {
215 |               console.error(`[WEBHOOK_ERROR] FAIL: Error adding voice credits via RPC for user ${supabaseUserId} from PI ${paymentIntent.id}:`, creditError);
216 |               return new Response(JSON.stringify({ received: true, error: 'Failed to update credits in DB' }), { status: 200 });
217 |             } else {
218 |               console.log(`[WEBHOOK_INFO] OK: Added ${creditsToAdd} voice credits via RPC for user ${supabaseUserId} from PI ${paymentIntent.id}.`);
219 |             }
220 |           } else {
221 |             // Este log ahora nos dirá por qué falló la comparación
222 |             console.log(`[WEBHOOK_INFO] Condition 'itemPurchased === "voice_credits"' is FALSE. Actual value: "${itemPurchased}". No credits added.`);
223 |           }
224 |         }
225 |         break;
226 |       } // Fin case 'checkout.session.completed'
227 | 
228 |       case 'invoice.paid': {
229 |         const invoice = eventObject as Stripe.Invoice;
230 |         console.log(`[WEBHOOK_INFO] Processing invoice.paid for invoice ${invoice.id}, Billing Reason: ${invoice.billing_reason}`);
231 |         if (!supabaseUserId) throw new Error(`[WEBHOOK_ERROR] Cannot process invoice ${invoice.id}: missing supabase_user_id.`);
232 | 
233 |         if (invoice.paid && invoice.subscription && invoice.billing_reason === 'subscription_cycle') { // Procesar solo renovaciones aquí
234 |           const subscriptionId = invoice.subscription as string;
235 |           console.log(`[WEBHOOK_DEBUG] Retrieving subscription ${subscriptionId} for renewal.`);
236 |           const subscription = await stripe.subscriptions.retrieve(subscriptionId);
237 |           const currentPeriodEnd = new Date(subscription.current_period_end * 1000);
238 | 
239 |           console.log(`[WEBHOOK_INFO] Resetting monthly usage for user ${supabaseUserId} due to subscription renewal.`);
240 |           const { error } = await supabaseAdmin
241 |             .from('profiles')
242 |             .update({
243 |               subscription_status: subscription.status,
244 |               current_period_end: currentPeriodEnd.toISOString(),
245 |               monthly_voice_generations_used: 0, // Resetear uso mensual
246 |             })
247 |             .eq('id', supabaseUserId);
248 | 
249 |           if (error) {
250 |             console.error(`[WEBHOOK_ERROR] FAIL: Error updating profile for invoice.paid ${invoice.id}:`, error);
251 |             throw error;
252 |           } else {
253 |             console.log(`[WEBHOOK_INFO] OK: Profile updated (monthly usage reset) for invoice.paid ${invoice.id} (User: ${supabaseUserId}).`);
254 |           }
255 |         } else {
256 |           console.log(`[WEBHOOK_INFO] Invoice ${invoice.id} paid, but not a subscription renewal or already handled.`);
257 |         }
258 |         break;
259 |       } // Fin case 'invoice.paid'
260 | 
261 |       case 'customer.subscription.updated': {
262 |         const subscription = eventObject as Stripe.Subscription;
263 |         console.log(`[WEBHOOK_INFO] Processing customer.subscription.updated for subscription ${subscription.id}, Status: ${subscription.status}`);
264 |         if (!supabaseUserId) throw new Error(`[WEBHOOK_ERROR] Cannot process subscription update ${subscription.id}: missing supabase_user_id.`);
265 | 
266 |         const status = subscription.status;
267 |         const currentPeriodEnd = new Date(subscription.current_period_end * 1000);
268 | 
269 |         const updatePayload: { [key: string]: any } = {
270 |           subscription_status: status,
271 |           current_period_end: currentPeriodEnd.toISOString(),
272 |         };
273 | 
274 |         if (subscription.cancel_at_period_end) {
275 |           console.log(`[WEBHOOK_INFO] Subscription ${subscription.id} scheduled for cancellation at period end.`);
276 |         }
277 | 
278 |         console.log(`[WEBHOOK_INFO] Updating profile for customer.subscription.updated ${subscription.id}`);
279 |         const { error } = await supabaseAdmin
280 |           .from('profiles')
281 |           .update(updatePayload)
282 |           .eq('id', supabaseUserId);
283 | 
284 |         if (error) {
285 |           console.error(`[WEBHOOK_ERROR] FAIL: Error updating profile for customer.subscription.updated ${subscription.id}:`, error);
286 |           throw error;
287 |         } else {
288 |           console.log(`[WEBHOOK_INFO] OK: Profile updated for customer.subscription.updated ${subscription.id}.`);
289 |         }
290 |         break;
291 |       } // Fin case 'customer.subscription.updated'
292 | 
293 |       case 'customer.subscription.deleted': {
294 |         const subscription = eventObject as Stripe.Subscription;
295 |         console.log(`[WEBHOOK_INFO] Processing customer.subscription.deleted for subscription ${subscription.id}`);
296 | 
297 |         if (!stripeCustomerId) throw new Error(`[WEBHOOK_ERROR] Cannot process subscription delete ${subscription.id}: missing stripe_customer_id.`);
298 | 
299 |         console.log(`[WEBHOOK_INFO] Updating profile for customer.subscription.deleted using customer ID ${stripeCustomerId}`);
300 |         const { error } = await supabaseAdmin
301 |           .from('profiles')
302 |           .update({
303 |             stripe_subscription_id: null,
304 |             subscription_status: 'canceled',
305 |             current_period_end: null,
306 |             monthly_voice_generations_used: 0,
307 |             // voice_credits: 0, // Comentado para conservar créditos comprados
308 |           })
309 |           .eq('stripe_customer_id', stripeCustomerId);
310 | 
311 |         if (error) {
312 |           console.error(`[WEBHOOK_ERROR] FAIL: Error updating profile for customer.subscription.deleted ${subscription.id}:`, error);
313 |         } else {
314 |           console.log(`[WEBHOOK_INFO] OK: Profile updated for customer.subscription.deleted ${subscription.id}.`);
315 |         }
316 |         break;
317 |       } // Fin case 'customer.subscription.deleted'
318 | 
319 |       default:
320 |         console.log(`[WEBHOOK_INFO] Unhandled event type: ${event.type}. ID: ${event.id}`);
321 |     }
322 | 
323 |     // 3. Responde a Stripe
324 |     console.log(`[WEBHOOK_INFO] Webhook processed successfully for event: ${event.id}`);
325 |     return new Response(JSON.stringify({ received: true }), { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
326 | 
327 |   } catch (err) {
328 |     console.error('[WEBHOOK_ERROR] FATAL: Webhook handler error:', err);
329 |     const isSignatureError = err.type === 'StripeSignatureVerificationError';
330 |     const status = isSignatureError ? 400 : 500;
331 |     return new Response(`Webhook Error: ${err.message}`, { status: status, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
332 |   }
333 | });
```

supabase/functions/story-continuation/index.ts
```
1 | // supabase/edge-functions/story-continuation/index.ts
2 | // v7.0 (OpenAI Client + JSON Output): Uses OpenAI client for Gemini, expects structured JSON.
3 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
4 | import { corsHeaders } from '../_shared/cors.ts';
5 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
6 | import OpenAI from "npm:openai@^4.33.0";
7 | 
8 | import {
9 |   createContinuationOptionsPrompt,
10 |   createContinuationPrompt,
11 |   type Story, // Assuming Story type is defined in prompt.ts
12 |   type Chapter, // Assuming Chapter type is defined in prompt.ts
13 |   type ContinuationContextType,
14 | } from './prompt.ts';
15 | 
16 | // --- Configuración Global ---
17 | const GEMINI_API_KEY = Deno.env.get("GEMINI_API_KEY");
18 | const GEMINI_COMPATIBLE_ENDPOINT = Deno.env.get("GEMINI_COMPATIBLE_ENDPOINT") || 'https://generativelanguage.googleapis.com/v1beta/openai/';
19 | const TEXT_MODEL_GENERATE = Deno.env.get('TEXT_MODEL_GENERATE');
20 | 
21 | if (!GEMINI_API_KEY) throw new Error("GEMINI_API_KEY environment variable not set");
22 | if (!GEMINI_COMPATIBLE_ENDPOINT) throw new Error("GEMINI_COMPATIBLE_ENDPOINT environment variable not set");
23 | if (!TEXT_MODEL_GENERATE) throw new Error("TEXT_MODEL_GENERATE environment variable not set for OpenAI client.");
24 | 
25 | const openai = new OpenAI({
26 |   apiKey: GEMINI_API_KEY,
27 |   baseURL: GEMINI_COMPATIBLE_ENDPOINT.endsWith('/') ? GEMINI_COMPATIBLE_ENDPOINT : GEMINI_COMPATIBLE_ENDPOINT + '/',
28 | });
29 | const functionVersion = "v7.0 (OpenAI Client + JSON)";
30 | console.log(`story-continuation ${functionVersion}: Using model ${TEXT_MODEL_GENERATE} via ${openai.baseURL}`);
31 | 
32 | const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
33 | const APP_SERVICE_ROLE_KEY = Deno.env.get('APP_SERVICE_ROLE_KEY');
34 | if (!SUPABASE_URL || !APP_SERVICE_ROLE_KEY) throw new Error("Supabase URL or Service Role Key not set");
35 | const supabaseAdmin = createClient(SUPABASE_URL, APP_SERVICE_ROLE_KEY);
36 | 
37 | // --- Interfaces for AI JSON Responses ---
38 | interface AiContinuationOption {
39 |   summary: string;
40 | }
41 | interface AiContinuationOptionsResponse {
42 |   options: AiContinuationOption[];
43 | }
44 | interface AiContinuationResponse {
45 |   title: string;
46 |   content: string;
47 | }
48 | 
49 | // --- Validation functions for AI responses ---
50 | function isValidOptionsResponse(data: any): data is AiContinuationOptionsResponse {
51 |   return data &&
52 |     Array.isArray(data.options) &&
53 |     data.options.every((opt: any) => typeof opt.summary === 'string' && opt.summary.trim() !== '');
54 | }
55 | 
56 | function isValidContinuationResponse(data: any): data is AiContinuationResponse {
57 |   return data &&
58 |     typeof data.title === 'string' && // Title can be empty initially, cleanExtractedText handles default
59 |     typeof data.content === 'string' && data.content.trim() !== '';
60 | }
61 | 
62 | 
63 | // --- Funciones Helper ---
64 | async function generateContinuationOptions(
65 |   story: Story,
66 |   chapters: Chapter[],
67 |   language: string = 'es',
68 |   childAge: number = 7,
69 |   specialNeed: string | null = null,
70 | ): Promise<AiContinuationOptionsResponse> {
71 |   console.log(`[${functionVersion}] generateContinuationOptions for story ${story?.id}`);
72 | 
73 |   if (!story || !story.id || !story.title || !story.content || !story.options) {
74 |     throw new Error("Datos de historia inválidos/incompletos para generar opciones.");
75 |   }
76 |   if (!Array.isArray(chapters)) {
77 |     throw new Error("Datos de capítulos inválidos para generar opciones.");
78 |   }
79 | 
80 |   const prompt = createContinuationOptionsPrompt(story, chapters, language, childAge, specialNeed);
81 |   console.log(`[${functionVersion}] Prompt para generación de opciones (lang: ${language}):\n---\n${prompt.substring(0, 300)}...\n---`);
82 | 
83 |   let aiResponseContent: string | null = null;
84 |   try {
85 |     const chatCompletion = await openai.chat.completions.create({
86 |       model: TEXT_MODEL_GENERATE,
87 |       messages: [{ role: "user", content: prompt }],
88 |       response_format: { type: "json_object" },
89 |       temperature: 0.7, // Adjusted temperature for option generation (can be tuned)
90 |       max_tokens: 8192, // Sufficient for a few options
91 |     });
92 | 
93 |     aiResponseContent = chatCompletion.choices[0]?.message?.content;
94 |     const finishReason = chatCompletion.choices[0]?.finish_reason;
95 | 
96 |     console.log(`[${functionVersion}] Raw AI JSON for options (first 200 chars): ${aiResponseContent?.substring(0, 200) || '(No content received)'}... Finish Reason: ${finishReason}`);
97 | 
98 |     if (finishReason === 'length') {
99 |       console.warn(`[${functionVersion}] AI option generation may have been truncated.`);
100 |     }
101 |     if (!aiResponseContent) {
102 |       throw new Error("Respuesta vacía de la IA para las opciones.");
103 |     }
104 | 
105 |     const parsedResponse = JSON.parse(aiResponseContent);
106 | 
107 |     if (isValidOptionsResponse(parsedResponse)) {
108 |       console.log(`[${functionVersion}] Opciones JSON parseadas y validadas:`, parsedResponse.options);
109 |       return parsedResponse; // Return the whole object: { options: [...] }
110 |     }
111 |     console.error(`[${functionVersion}] Formato de opciones inválido después de parsear. Data:`, parsedResponse);
112 |     throw new Error("Formato de opciones inválido después de parsear el JSON de la IA.");
113 | 
114 |   } catch (e: any) {
115 |     console.error(`[${functionVersion}] Error procesando la respuesta de la IA para las opciones: ${e.message}. Raw response: ${aiResponseContent?.substring(0, 500)}`, e);
116 |     // Fallback
117 |     const defaultOptions = [
118 |       { summary: language.startsWith('en') ? "Continue the adventure" : "Continuar la aventura" },
119 |       { summary: language.startsWith('en') ? "Explore something new" : "Explorar algo nuevo" },
120 |       { summary: language.startsWith('en') ? "Meet a new friend" : "Encontrar un amigo" }
121 |     ].map(opt => ({ summary: `${opt.summary} (${language.startsWith('en') ? 'default option' : 'opción por defecto'})` }));
122 |     return { options: defaultOptions };
123 |   }
124 | }
125 | 
126 | // cleanExtractedText: Se mantiene, ya que procesa strings provenientes de la IA (dentro del JSON).
127 | function cleanExtractedText(text: string | undefined | null, type: 'title' | 'content'): string {
128 |   const defaultText = type === 'title' ? `Un Nuevo Capítulo` : 'La historia continúa de forma misteriosa...';
129 |   if (text === null || text === undefined || typeof text !== 'string') { // Allow empty string from AI, will return default
130 |     console.warn(`[${functionVersion}] cleanExtractedText (${type}): Input null, undefined, or not a string.`);
131 |     return defaultText;
132 |   }
133 |   // No console.log BEFORE for potentially very long content strings.
134 |   let cleaned = text;
135 |   // Markdown fences around the *whole string* should not happen with response_format: json_object,
136 |   // but if AI puts them *inside* a JSON string value, this might be useful.
137 |   // However, the primary instruction is AI should not use markdown *inside* string values unless natural.
138 |   // cleaned = cleaned.replace(/^```(?:json|text)?\s*([\s\S]*?)\s*```$/gm, '$1').trim(); // Less likely needed now
139 | 
140 |   cleaned = cleaned.trim(); // Trim first
141 |   cleaned = cleaned.replace(/^(Título|Title|Contenido|Content|Respuesta|Response):\s*/i, '').trim();
142 |   cleaned = cleaned.replace(/^(Aquí tienes el (título|contenido|cuento|capítulo)|Claro, aquí está el (título|contenido|cuento|capítulo)):\s*/i, '').trim();
143 |   cleaned = cleaned.replace(/\n\n\(Espero que te guste.*$/i, '').trim();
144 |   cleaned = cleaned.replace(/\n\n\[.*?\]$/i, '').trim();
145 | 
146 |   if (type === 'content') {
147 |     cleaned = cleaned.replace(/^\s*\d+\.\s+/gm, '');
148 |     cleaned = cleaned.replace(/^\s*[-\*]\s+/gm, '');
149 |   }
150 |   if (type === 'title') {
151 |     cleaned = cleaned.replace(/^["'“‘](.*)["'”’]$/s, '$1').trim();
152 |   }
153 |   cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
154 |   // console.log(`[${functionVersion}] cleanExtractedText (${type}) - AFTER: "${cleaned.substring(0, 150)}..."`);
155 |   return cleaned.trim() || defaultText; // Ensure it returns default if cleaning results in empty
156 | }
157 | // --- Fin Funciones Helper ---
158 | 
159 | serve(async (req: Request) => {
160 |   if (req.method === "OPTIONS") {
161 |     return new Response("ok", { headers: corsHeaders });
162 |   }
163 |   if (req.method !== 'POST') {
164 |     return new Response(JSON.stringify({ error: 'Método no permitido. Usar POST.' }), {
165 |       status: 405, headers: { ...corsHeaders, 'Content-Type': 'application/json' }
166 |     });
167 |   }
168 | 
169 |   let requestedAction = 'unknown';
170 |   let userId: string | null = null;
171 | 
172 |   try {
173 |     console.log(`[${functionVersion}] Handling POST request...`);
174 |     const authHeader = req.headers.get('Authorization');
175 |     if (!authHeader || !authHeader.startsWith('Bearer ')) {
176 |       console.error("Authorization header missing or invalid.");
177 |       return new Response(JSON.stringify({ error: 'Token inválido o ausente.' }), {
178 |         status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" }
179 |       });
180 |     }
181 |     const token = authHeader.replace('Bearer ', '');
182 |     const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);
183 |     if (authError || !user) {
184 |       console.error("Auth Error:", authError);
185 |       return new Response(JSON.stringify({ error: authError?.message || 'No autenticado.' }), {
186 |         status: authError?.status || 401, headers: { ...corsHeaders, "Content-Type": "application/json" }
187 |       });
188 |     }
189 |     userId = user.id;
190 |     console.log(`[${functionVersion}] User Auth: ${userId}`);
191 | 
192 |     let body: any;
193 |     try {
194 |       body = await req.json();
195 |       if (!body || typeof body !== 'object') throw new Error("Parsed body is not an object.");
196 |     } catch (error: any) {
197 |       console.error(`[${functionVersion}] Failed to parse JSON body for user ${userId}. Error:`, error);
198 |       throw new Error(`Invalid/empty JSON in body: ${error.message}.`);
199 |     }
200 | 
201 |     const { action, story, chapters = [], selectedOptionSummary, userDirection } = body;
202 |     requestedAction = action || 'unknown';
203 |     const story_id = story?.id;
204 | 
205 |     const isContinuationAction = ['freeContinuation', 'optionContinuation', 'directedContinuation'].includes(action);
206 |     const requiresStoryForContext = isContinuationAction || action === 'generateOptions';
207 | 
208 |     // Validaciones de entrada (largely same as v6.1)
209 |     if (!action) throw new Error("'action' es requerida.");
210 |     if (requiresStoryForContext) {
211 |       if (!story || typeof story !== 'object' || !story_id) {
212 |         throw new Error(`Objeto 'story' (con 'id') inválido/ausente para la acción '${action}'.`);
213 |       }
214 |       if (!story.content || !story.options || !story.options.character?.name || !story.title) {
215 |         throw new Error("Datos incompletos en el objeto 'story' recibido (content, options.character.name, title son necesarios).");
216 |       }
217 |       if (!Array.isArray(chapters)) {
218 |         throw new Error(`Array 'chapters' requerido (puede ser vacío) para la acción '${action}'.`);
219 |       }
220 |     }
221 |     if (action === 'optionContinuation' && (typeof selectedOptionSummary !== 'string' || !selectedOptionSummary.trim())) {
222 |       throw new Error("'selectedOptionSummary' (string no vacío) requerido para 'optionContinuation'.");
223 |     }
224 |     if (action === 'directedContinuation' && (typeof userDirection !== 'string' || !userDirection.trim())) {
225 |       throw new Error("'userDirection' (string no vacío) requerido para 'directedContinuation'.");
226 |     }
227 | 
228 |     const language = body.language || story?.options?.language || 'es';
229 |     const childAge = body.childAge || story?.options?.childAge || 7;
230 |     const specialNeed = body.specialNeed || story?.options?.specialNeed || 'Ninguna';
231 |     const storyDuration = body.storyDuration || story?.options?.duration || 'medium';
232 | 
233 |     // Límites (largely same logic as v6.1)
234 |     if (isContinuationAction) {
235 |       const { data: profile, error: profileError } = await supabaseAdmin.from('profiles').select('subscription_status').eq('id', userId).maybeSingle();
236 |       if (profileError) throw new Error("Error al verificar el perfil de usuario para límites.");
237 | 
238 |       const isPremium = profile?.subscription_status === 'active' || profile?.subscription_status === 'trialing';
239 |       if (!isPremium) {
240 |         const { count: chapterCount, error: countError } = await supabaseAdmin.from('story_chapters')
241 |           .select('*', { count: 'exact', head: true })
242 |           .eq('story_id', story_id);
243 |         if (countError) throw new Error("Error al verificar límites de continuación.");
244 | 
245 |         const FREE_CHAPTER_LIMIT = 2; // Límite de capítulos *adicionales* generables (no se si el capitulo 0 lo cuenta)
246 |         if (chapterCount !== null && chapterCount >= FREE_CHAPTER_LIMIT) {
247 |           return new Response(JSON.stringify({ error: 'Límite de continuaciones gratuitas alcanzado.' }), {
248 |             status: 403, headers: { ...corsHeaders, "Content-Type": "application/json" }
249 |           });
250 |         }
251 |       }
252 |     }
253 | 
254 |     // --- Ejecutar Acción Principal ---
255 |     let responsePayload: any = {}; // Use 'any' for flexibility, or a union type
256 |     console.log(`[${functionVersion}] Executing action: ${action} for user ${userId}, story ${story_id || 'N/A'}`);
257 | 
258 |     if (action === 'generateOptions') {
259 |       const optionsResponse = await generateContinuationOptions(story as Story, chapters as Chapter[], language, childAge, specialNeed);
260 |       responsePayload = optionsResponse; // This is already { options: [...] }
261 |     } else if (isContinuationAction) {
262 |       const continuationContext: ContinuationContextType = {};
263 |       if (action === 'optionContinuation') continuationContext.optionSummary = selectedOptionSummary;
264 |       if (action === 'directedContinuation') continuationContext.userDirection = userDirection;
265 | 
266 |       const continuationPrompt = createContinuationPrompt(
267 |         action as 'freeContinuation' | 'optionContinuation' | 'directedContinuation',
268 |         story as Story,
269 |         chapters as Chapter[],
270 |         continuationContext,
271 |         language,
272 |         childAge,
273 |         specialNeed,
274 |         storyDuration
275 |       );
276 | 
277 |       console.log(`[${functionVersion}] Calling AI for continuation. Prompt start: ${continuationPrompt.substring(0, 200)}...`);
278 | 
279 |       const chatCompletion = await openai.chat.completions.create({
280 |         model: TEXT_MODEL_GENERATE,
281 |         messages: [{ role: "user", content: continuationPrompt }],
282 |         response_format: { type: "json_object" },
283 |         temperature: 0.8, // from v6.1
284 |         top_p: 0.95,      // from v6.1
285 |         max_tokens: 8192  // from v6.1
286 |       });
287 | 
288 |       const aiResponseContent = chatCompletion.choices[0]?.message?.content;
289 |       const finishReason = chatCompletion.choices[0]?.finish_reason;
290 |       console.log(`[${functionVersion}] Raw AI JSON for continuation (first 200 chars): ${aiResponseContent?.substring(0, 200) || '(No content received)'}... Finish Reason: ${finishReason}`);
291 | 
292 |       if (finishReason === 'content_filter') {
293 |         console.error(`[${functionVersion}] AI Continuation Generation BLOCKED due to content filter.`);
294 |         throw new Error(`Generación de continuación bloqueada por seguridad: filtro de contenido.`);
295 |       }
296 |       if (finishReason === 'length') {
297 |         console.warn(`[${functionVersion}] AI continuation generation may have been truncated.`);
298 |       }
299 |       if (!aiResponseContent) {
300 |         throw new Error("Fallo al generar continuación: Respuesta IA vacía (sin bloqueo explícito).");
301 |       }
302 | 
303 |       let finalTitle = 'Un Nuevo Capítulo'; // Default
304 |       let finalContent = '';
305 |       let parsedSuccessfully = false;
306 | 
307 |       try {
308 |         const parsedResponse = JSON.parse(aiResponseContent);
309 |         if (isValidContinuationResponse(parsedResponse)) {
310 |           finalTitle = cleanExtractedText(parsedResponse.title, 'title');
311 |           finalContent = cleanExtractedText(parsedResponse.content, 'content');
312 |           parsedSuccessfully = true;
313 |           console.log(`[${functionVersion}] Parsed AI continuation JSON successfully.`);
314 |         } else {
315 |           console.warn(`[${functionVersion}] AI continuation response JSON structure invalid. Data:`, parsedResponse);
316 |         }
317 |       } catch (parseError: any) {
318 |         console.error(`[${functionVersion}] Failed to parse JSON from AI continuation response. Error: ${parseError.message}. Raw: ${aiResponseContent.substring(0, 300)}`);
319 |       }
320 | 
321 |       if (!parsedSuccessfully) {
322 |         console.warn(`[${functionVersion}] Using fallback for continuation: Default title, full raw response as content (if available).`);
323 |         finalContent = cleanExtractedText(aiResponseContent, 'content'); // aiResponseContent might be the non-JSON string
324 |       }
325 | 
326 |       if (!finalContent) { // If content is still empty after parsing/fallback and cleaning
327 |         console.error(`[${functionVersion}] Critical error: Final continuation content is empty after all processing.`);
328 |         finalContent = "La historia no pudo continuar esta vez. Intenta con otra opción o una nueva dirección.";
329 |         // Optionally throw, but providing a message might be better UX for continuations
330 |       }
331 | 
332 |       console.log(`[${functionVersion}] Final Title: "${finalTitle}", Final Content Length: ${finalContent.length}`);
333 |       responsePayload = { content: finalContent, title: finalTitle };
334 | 
335 |     } else {
336 |       throw new Error(`Acción no soportada: ${action}`);
337 |     }
338 | 
339 |     console.log(`[${functionVersion}] Action ${action} completed successfully for ${userId}.`);
340 |     return new Response(JSON.stringify(responsePayload), {
341 |       status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' }
342 |     });
343 | 
344 |   } catch (error: any) {
345 |     console.error(`Error in ${functionVersion} (User: ${userId || 'UNKNOWN'}, Action: ${requestedAction}):`, error.message, error.stack);
346 |     let statusCode = 500;
347 |     const lowerMessage = error.message.toLowerCase();
348 | 
349 |     if (lowerMessage.includes("token inválido") || lowerMessage.includes("no autenticado")) statusCode = 401;
350 |     else if (lowerMessage.includes("límite de continuaciones")) statusCode = 403;
351 |     else if (lowerMessage.includes("json in body") || lowerMessage.includes("inválido/ausente") || lowerMessage.includes("requerido")) statusCode = 400;
352 |     else if (lowerMessage.includes("bloqueada por seguridad") || lowerMessage.includes("respuesta ia vacía") || lowerMessage.includes("filtro de contenido")) statusCode = 502;
353 |     else if (lowerMessage.includes("acción no soportada")) statusCode = 400;
354 | 
355 |     return new Response(JSON.stringify({ error: `Error procesando solicitud (${requestedAction}): ${error.message}` }), {
356 |       status: statusCode, headers: { ...corsHeaders, 'Content-Type': 'application/json' }
357 |     });
358 |   }
359 | });
```

supabase/functions/story-continuation/prompt.ts
```
1 | // supabase/edge-functions/story-continuation/prompt.ts
2 | // v7.1 (JSON Output + Full Chapter Context): Prompts para la continuación de historias.
3 | // Ahora incluye el contenido COMPLETO de los capítulos anteriores en el contexto.
4 | 
5 | // --- Tipos (asumidos/definidos según el uso en index.ts) ---
6 | export interface CharacterOptions {
7 |     name: string;
8 |     profession?: string;
9 |     hobbies?: string[];
10 |     personality?: string;
11 | }
12 | 
13 | export interface StoryOptions {
14 |     character: CharacterOptions;
15 |     genre: string;
16 |     moral: string;
17 |     duration?: string; // 'short', 'medium', 'long'
18 |     language?: string;
19 |     childAge?: number;
20 |     specialNeed?: string;
21 | }
22 | 
23 | export interface Story {
24 |     id: string;
25 |     title: string; // Título general de la historia
26 |     content: string; // Contenido del capítulo inicial (o la historia base si no hay capítulos)
27 |     options: StoryOptions;
28 | }
29 | 
30 | export interface Chapter {
31 |     id: string;
32 |     chapter_number: number;
33 |     title: string;
34 |     content: string;
35 | }
36 | 
37 | export interface ContinuationContextType {
38 |     optionSummary?: string;
39 |     userDirection?: string;
40 | }
41 | 
42 | // --- Funciones de Prompt ---
43 | 
44 | /**
45 |  * Crea el prompt para generar opciones de continuación.
46 |  * Ahora incluye el contenido completo de la historia y capítulos anteriores.
47 |  */
48 | export function createContinuationOptionsPrompt(
49 |     story: Story,
50 |     chapters: Chapter[],
51 |     language: string = 'es',
52 |     childAge: number = 7,
53 |     specialNeed: string | null = null,
54 | ): string {
55 |     const functionVersion = "v7.1 (JSON Output + Full Context)";
56 |     console.log(`[Prompt Helper ${functionVersion}] createContinuationOptionsPrompt for story ID: ${story.id}, lang: ${language}`);
57 | 
58 |     let prompt = `Eres un asistente creativo experto en generar continuaciones interesantes y coherentes para cuentos infantiles.
59 |   Idioma Principal del Cuento: ${language}. Edad orientativa de los niños: ${childAge} años.`;
60 | 
61 |     if (specialNeed && specialNeed !== 'Ninguna') {
62 |         prompt += `\nConsidera adaptaciones sutiles para la necesidad: "${specialNeed}", manteniendo claridad y tono positivo.`;
63 |     }
64 | 
65 |     prompt += `\n\n--- CONTEXTO COMPLETO DE LA HISTORIA HASTA AHORA ---`;
66 |     prompt += `\n\n**Historia Original (Título General: "${story.title}")**`;
67 |     prompt += `\nPersonaje Principal: ${story.options.character.name}.`;
68 |     prompt += `\n\n**Inicio del Cuento:**\n${story.content}\n`; // Contenido completo de la historia inicial
69 | 
70 |     if (chapters && chapters.length > 0) {
71 |         prompt += `\n\n**Capítulos Anteriores:**`;
72 |         chapters.forEach((chap) => {
73 |             prompt += `\n\n**Capítulo ${chap.chapter_number}: "${chap.title}"**\n${chap.content}\n`; // Contenido completo de cada capítulo
74 |         });
75 |     }
76 |     prompt += `\n--- FIN DEL CONTEXTO COMPLETO ---\n`;
77 |     // NOTA: Proveer el contexto completo puede consumir muchos tokens.
78 | 
79 |     prompt += `\n\nBasándote en el estado actual de la historia (considerando TODO el contexto provisto arriba), genera 3 opciones concisas y atractivas para continuar el cuento. Cada opción debe ser un resumen breve (10-20 palabras) de un posible siguiente paso en la aventura.`;
80 |     prompt += `\nLas opciones deben ser variadas, ofreciendo diferentes caminos o enfoques para la continuación.`;
81 |     prompt += `\nAsegúrate de que las opciones exploren temas o acciones claramente distintos entre sí (por ejemplo: una opción sobre exploración, otra sobre la aparición de un nuevo personaje, y otra sobre usar un objeto existente de una manera novedosa).`;
82 |     prompt += `\nDeben estar escritas en ${language}.`;
83 | 
84 |     prompt += `\n\n**Instrucciones de formato de respuesta (¡MUY IMPORTANTE!):**`;
85 |     prompt += `\n* Debes responder con un ÚNICO objeto JSON.`;
86 |     prompt += `\n* El objeto JSON debe tener una sola clave (key) llamada "options".`;
87 |     prompt += `\n* El valor de la clave "options" debe ser un array (lista) de exactamente 3 objetos.`;
88 |     prompt += `\n* Cada objeto dentro del array "options" debe tener una única clave (key) llamada "summary".`;
89 |     prompt += `\n* El valor de la clave "summary" debe ser una cadena de texto (string) con el resumen de la opción de continuación (10-20 palabras en ${language}).`;
90 |     prompt += `\n* Ejemplo del formato JSON esperado:`;
91 |     prompt += `\n{`;
92 |     prompt += `\n  "options": [`;
93 |     prompt += `\n    { "summary": "El personaje decide explorar el bosque misterioso." },`;
94 |     prompt += `\n    { "summary": "Aparece un nuevo amigo que necesita ayuda." },`;
95 |     prompt += `\n    { "summary": "El personaje recuerda un objeto mágico que podría usar." }`;
96 |     prompt += `\n  ]`;
97 |     prompt += `\n}`;
98 |     prompt += `\n* NO incluyas NADA antes del carácter '{' que inicia el objeto JSON.`;
99 |     prompt += `\n* NO incluyas NADA después del carácter '}' que finaliza el objeto JSON.`;
100 |     prompt += `\n* Asegúrate de que el JSON sea válido y completo.`;
101 | 
102 |     return prompt;
103 | }
104 | 
105 | /**
106 |  * Crea el prompt para generar la continuación de un capítulo.
107 |  * Ahora incluye el contenido completo de la historia y capítulos anteriores.
108 |  */
109 | export function createContinuationPrompt(
110 |     action: 'freeContinuation' | 'optionContinuation' | 'directedContinuation',
111 |     story: Story,
112 |     chapters: Chapter[],
113 |     context: ContinuationContextType,
114 |     language: string = 'es',
115 |     childAge: number = 7,
116 |     specialNeed: string | null = null,
117 |     storyDuration: string = 'medium'
118 | ): string {
119 |     const functionVersion = "v7.1 (JSON Output + Full Context)";
120 |     console.log(`[Prompt Helper ${functionVersion}] createContinuationPrompt for story ID: ${story.id}, action: ${action}, lang: ${language}`);
121 | 
122 |     let prompt = `Eres un escritor experto continuando cuentos infantiles educativos y creativos.
123 |   Escribe siempre en ${language}, con un estilo adecuado para niños de ${childAge} años.
124 |   La historia original tiene un género de '${story.options.genre}' y una moraleja principal de '${story.options.moral}'.`;
125 | 
126 |     // Guía de longitud de capítulo
127 |     prompt += `\n\n**Guía de longitud del capítulo:**`;
128 |     if (storyDuration === 'short') prompt += `\n* Capítulo corto: ~800 tokens (aprox. 600-700 palabras).`;
129 |     else if (storyDuration === 'long') prompt += `\n* Capítulo largo: ~2150 tokens (aprox. 1600-1800 palabras).`;
130 |     else prompt += `\n* Capítulo de longitud media: ~1350 tokens (aprox. 1000-1200 palabras).`;
131 |     prompt += `\nEstas cifras son aproximadas y sirven como referencia para la extensión esperada.`;
132 | 
133 |     if (specialNeed && specialNeed !== 'Ninguna') {
134 |         prompt += `\nLa adaptación para "${specialNeed}" debe ser sutil, priorizando siempre la claridad, la comprensión y un tono positivo en la narración.`;
135 |         prompt += ` A continuación, algunas guías específicas para "${specialNeed}":\n`;
136 |         switch (specialNeed) {
137 |             case 'TEA':
138 |                 prompt += `   - **Lenguaje Claro y Literal:** Usa frases cortas, directas y concretas. Evita el lenguaje figurado (metáforas, ironía) y las ambigüedades. Si es necesario introducir conceptos abstractos, explícalos de forma muy sencilla dentro de la narrativa.\n`;
139 |                 prompt += `   - **Estructura Predecible:** Mantén una secuencia narrativa muy clara y lógica. Puedes usar elementos o frases clave que se repitan para ayudar a anticipar eventos de forma natural.\n`;
140 |                 prompt += `   - **Descripciones Explícitas de Emociones e Interacciones Sociales:** Describe las emociones de los personajes de manera explícita y sencilla. Las interacciones sociales deben ser claras y directas.\n`;
141 |                 prompt += `   - **Enfoque en Detalles Concretos:** Céntrate en detalles observables y acciones concretas.\n`;
142 |                 prompt += `   - **Tono Positivo y Calmado:** Asegura un tono general tranquilizador y positivo.\n`;
143 |                 break;
144 |             case 'TDAH':
145 |                 prompt += `   - **Inicio Atractivo y Trama Dinámica:** Comienza el capítulo de forma que capte el interés rápidamente. Mantén una trama con buen ritmo y elementos de sorpresa o curiosidad.\n`;
146 |                 prompt += `   - **Lenguaje Estimulante pero Conciso:** Utiliza un lenguaje vívido y atractivo. Alterna frases de diferentes longitudes, pero prioriza la concisión.\n`;
147 |                 prompt += `   - **Estructura Clara:** Asegura que el hilo conductor del capítulo sea fácil de seguir.\n`;
148 |                 prompt += `   - **Fomentar la Conexión:** Incluye preguntas retóricas cortas, onomatopeyas y exclamaciones.\n`;
149 |                 break;
150 |             case 'Dislexia':
151 |                 prompt += `   - **Lenguaje Sencillo y Accesible:** Opta por vocabulario común y frases cortas. Prefiere la voz activa.\n`;
152 |                 prompt += `   - **Evitar Complejidad Lingüística Innecesaria:** Reduce el uso de palabras con ortografía compleja o poco fonéticas.\n`;
153 |                 prompt += `   - **Repetición Natural de Palabras Clave:** Reintroduce palabras importantes de forma sutil.\n`;
154 |                 prompt += `   - **Narrativa Clara y Lineal:** La progresión de eventos debe ser lógica y fácil de seguir.\n`;
155 |                 break;
156 |             case 'Ansiedad':
157 |                 prompt += `   - **Tono General Tranquilizador y Optimista:** Mantén un ambiente narrativo calmado y consistentemente positivo.\n`;
158 |                 prompt += `   - **Resolución Clara y Segura del Conflicto (si aplica en el capítulo):** Si se introduce un mini-conflicto, debe resolverse de manera que refuerce la seguridad.\n`;
159 |                 prompt += `   - **Evitar Ambigüedades y Elementos Perturbadores:** No incluyas elementos que puedan ser fácilmente interpretados como amenazantes.\n`;
160 |                 prompt += `   - **Modelado Sutil de Afrontamiento Positivo:** Muestra personajes manejando pequeños desafíos con calma.\n`;
161 |                 break;
162 |             case 'Down':
163 |                 prompt += `   - **Lenguaje Muy Concreto y Literal:** Usa palabras que se refieran a objetos, acciones y emociones observables.\n`;
164 |                 prompt += `   - **Frases Cortas y Estructura Simple:** Construye oraciones breves y con una estructura gramatical sencilla.\n`;
165 |                 prompt += `   - **Repetición de Información Clave:** Incorpora la repetición natural de nombres o acciones clave del capítulo.\n`;
166 |                 prompt += `   - **Secuencia Narrativa Muy Clara y Lineal:** El capítulo debe seguir un orden de eventos simple y cronológico.\n`;
167 |                 break;
168 |             case 'Comprension':
169 |                 prompt += `   - **Frases Muy Claras y Sencillas:** Usa oraciones cortas, directas y con una estructura gramatical simple.\n`;
170 |                 prompt += `   - **Vocabulario Controlado y Explícito:** Utiliza palabras comunes. Si es necesario introducir una palabra nueva, clarifica su significado.\n`;
171 |                 prompt += `   - **Repetición Estratégica de Conceptos Clave:** Reitera información importante del capítulo.\n`;
172 |                 prompt += `   - **Conexiones Lógicas Explícitas:** Asegúrate de que las relaciones de causa-efecto sean muy evidentes.\n`;
173 |                 break;
174 |             default:
175 |                 prompt += `   - Dado que "${specialNeed}" es una necesidad específica no listada, enfócate en principios generales: maximiza la claridad, asegura una estructura sencilla y comprensible, y mantén un tono positivo.\n`;
176 |                 break;
177 |         }
178 |     }
179 | 
180 |     prompt += `\n\n--- CONTEXTO COMPLETO DE LA HISTORIA HASTA AHORA ---`;
181 |     prompt += `\n\n**Historia Original (Título General: "${story.title}")**`;
182 |     prompt += `\nPersonaje Principal: ${story.options.character.name}`;
183 |     if (story.options.character.profession) prompt += `, Profesión: ${story.options.character.profession}`;
184 |     if (story.options.character.personality) prompt += `, Personalidad: ${story.options.character.personality}`;
185 |     prompt += `\n\n**Inicio del Cuento:**\n${story.content}\n`; // Contenido completo de la historia inicial
186 | 
187 |     if (chapters && chapters.length > 0) {
188 |         prompt += `\n\n**Capítulos Anteriores:**`;
189 |         chapters.forEach((chap) => {
190 |             prompt += `\n\n**Capítulo ${chap.chapter_number}: "${chap.title}"**\n${chap.content}\n`; // Contenido completo de cada capítulo
191 |         });
192 |     }
193 |     prompt += `\n--- FIN DEL CONTEXTO COMPLETO ---\n`;
194 |     // NOTA: Proveer el contexto completo puede consumir muchos tokens.
195 | 
196 |     prompt += `\n\n--- TU TAREA ---`;
197 |     prompt += `\nConsiderando TODO el contexto provisto arriba, escribe el PRÓXIMO CAPÍTULO de esta historia.`;
198 | 
199 |     if (action === 'optionContinuation' && context.optionSummary) {
200 |         prompt += `\nLa continuación debe basarse en la siguiente opción elegida por el usuario: "${context.optionSummary}"`;
201 |     } else if (action === 'directedContinuation' && context.userDirection) {
202 |         prompt += `\nLa continuación debe seguir esta dirección específica proporcionada por el usuario: "${context.userDirection}"`;
203 |     } else {
204 |         prompt += `\nContinúa la historia de forma libre y creativa, manteniendo la coherencia con los eventos y personajes anteriores.`;
205 |     }
206 | 
207 |     prompt += `\n\nGuías para el Nuevo Capítulo:`;
208 |     prompt += `\n1. **Longitud del Capítulo:** Apunta a una longitud '${storyDuration}'.`;
209 |     // INICIO DE CAMBIOS *****
210 |     if (storyDuration === 'short') prompt += ` (aproximadamente 600-700 palabras).`;
211 |     else if (storyDuration === 'long') prompt += ` (aproximadamente 1600-1800 palabras).`;
212 |     else prompt += ` (aproximadamente 1000-1200 palabras).`;
213 |     // FIN DE CAMBIOS *****
214 | 
215 |     prompt += `\n2. **Estructura del Capítulo:** Debe tener un flujo narrativo claro, conectando con el capítulo anterior y avanzando la trama general. Puede introducir un nuevo pequeño desafío o desarrollo.`;
216 |     prompt += `\n3. **Tono y Estilo:** Mantén el tono y estilo del cuento original. Usa un lenguaje sencillo, pero emocionalmente resonante. Emplea onomatopeyas o pequeñas preguntas si es apropiado.`;
217 |     prompt += `\n4. **Coherencia:** Asegúrate de que los personajes se comporten de manera consistente y que los nuevos eventos encajen lógicamente en la historia.`;
218 |     prompt += `\n5. **Título del Capítulo:** Genera un título breve, atractivo y relevante para el contenido de este nuevo capítulo. Debe estar en ${language} y en "Sentence case".`;
219 | 
220 |     prompt += `\n\n**Instrucciones de formato de respuesta (¡MUY IMPORTANTE!):**`;
221 |     prompt += `\n* Debes responder con un ÚNICO objeto JSON.`;
222 |     prompt += `\n* El objeto JSON debe tener exactamente dos claves (keys): "title" y "content".`;
223 |     prompt += `\n* El valor de la clave "title" debe ser una cadena de texto (string) que contenga ÚNICAMENTE el título generado para este nuevo capítulo, respetando las indicaciones del punto 5 de las "Guías para el Nuevo Capítulo".`;
224 |     prompt += `\n* El valor de la clave "content" debe ser una cadena de texto (string) con TODO el contenido de este nuevo capítulo, comenzando directamente con la primera frase.`;
225 |     prompt += `\n* Ejemplo del formato JSON esperado: {"title": "El Desafío Inesperado", "content": "Al día siguiente, ${story.options.character.name} se despertó sintiendo una extraña energía en el aire..."}`;
226 |     prompt += `\n* NO incluyas NADA antes del carácter '{' que inicia el objeto JSON.`;
227 |     prompt += `\n* NO incluyas NADA después del carácter '}' que finaliza el objeto JSON.`;
228 |     prompt += `\n* Asegúrate de que el JSON sea válido y completo.`;
229 |     prompt += `\n* NO uses markdown ni ningún otro formato DENTRO de los strings del JSON a menos que sea parte natural del texto del cuento.`;
230 | 
231 |     return prompt;
232 | }
```

supabase/functions/upload-story-image/index.ts
```
1 | import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
2 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
3 | 
4 | const corsHeaders = {
5 |   'Access-Control-Allow-Origin': '*',
6 |   'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
7 | }
8 | 
9 | interface UploadImageRequest {
10 |   imageUrl?: string;  // Para URLs de OpenAI (método antiguo)
11 |   imageBase64?: string; // Para datos base64 del nuevo método
12 |   imageType: string;
13 |   storyId: string;
14 |   chapterId: string;
15 | }
16 | 
17 | /**
18 |  * Edge Function to upload story images to Supabase storage
19 |  * Path structure: images-stories/storyId/chapterId/imageType.jpeg
20 |  */
21 | serve(async (req: Request) => {
22 |   // Handle CORS preflight requests
23 |   if (req.method === 'OPTIONS') {
24 |     return new Response('ok', { headers: corsHeaders })
25 |   }
26 | 
27 |   try {
28 |     console.log('[UPLOAD_STORY_IMAGE] Starting image upload process...');
29 | 
30 |     // Get request data
31 |     const { imageUrl, imageBase64, imageType, storyId, chapterId }: UploadImageRequest = await req.json();
32 | 
33 |     // Validate required fields
34 |     if ((!imageUrl && !imageBase64) || !imageType || !storyId || !chapterId) {
35 |       console.error('[UPLOAD_STORY_IMAGE] Missing required fields:', { 
36 |         imageUrl: !!imageUrl, 
37 |         imageBase64: !!imageBase64, 
38 |         imageType, 
39 |         storyId, 
40 |         chapterId 
41 |       });
42 |       return new Response(
43 |         JSON.stringify({ error: 'Missing required fields: (imageUrl or imageBase64), imageType, storyId, chapterId' }),
44 |         { status: 400, headers: corsHeaders }
45 |       );
46 |     }
47 | 
48 |     // Validate imageType
49 |     const validImageTypes = ['cover', 'scene_1', 'scene_2'];
50 |     if (!validImageTypes.includes(imageType)) {
51 |       console.error('[UPLOAD_STORY_IMAGE] Invalid image type:', imageType);
52 |       return new Response(
53 |         JSON.stringify({ error: `Invalid imageType. Must be one of: ${validImageTypes.join(', ')}` }),
54 |         { status: 400, headers: corsHeaders }
55 |       );
56 |     }
57 | 
58 |     console.log(`[UPLOAD_STORY_IMAGE] Processing ${imageType} for story ${storyId}, chapter ${chapterId}`);
59 | 
60 |     // Create Supabase admin client
61 |     const supabaseAdmin = createClient(
62 |       Deno.env.get('SUPABASE_URL') ?? '',
63 |       Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
64 |     );
65 | 
66 |     // Process image data (either from URL or base64)
67 |     let imageBuffer: ArrayBuffer;
68 |     
69 |     if (imageBase64) {
70 |       console.log('[UPLOAD_STORY_IMAGE] Processing base64 image data...');
71 |       // Convert base64 to buffer
72 |       const binaryString = atob(imageBase64);
73 |       const bytes = new Uint8Array(binaryString.length);
74 |       for (let i = 0; i < binaryString.length; i++) {
75 |         bytes[i] = binaryString.charCodeAt(i);
76 |       }
77 |       imageBuffer = bytes.buffer;
78 |       console.log(`[UPLOAD_STORY_IMAGE] Processed base64 image: ${imageBuffer.byteLength} bytes`);
79 |     } else if (imageUrl) {
80 |       console.log('[UPLOAD_STORY_IMAGE] Downloading image from URL...');
81 |       const imageResponse = await fetch(imageUrl);
82 |       
83 |       if (!imageResponse.ok) {
84 |         throw new Error(`Failed to download image: ${imageResponse.status} ${imageResponse.statusText}`);
85 |       }
86 | 
87 |       const imageBlob = await imageResponse.blob();
88 |       imageBuffer = await imageBlob.arrayBuffer();
89 |       console.log(`[UPLOAD_STORY_IMAGE] Downloaded image: ${imageBuffer.byteLength} bytes`);
90 |     } else {
91 |       throw new Error('No image data provided');
92 |     }
93 | 
94 |     // Define storage path: images-stories/storyId/chapterId/imageType.jpeg
95 |     const storagePath = `${storyId}/${chapterId}/${imageType}.jpeg`;
96 |     console.log(`[UPLOAD_STORY_IMAGE] Uploading to path: ${storagePath}`);
97 | 
98 |     // Upload to Supabase Storage
99 |     const { data: uploadData, error: uploadError } = await supabaseAdmin.storage
100 |       .from('images-stories')
101 |       .upload(storagePath, imageBuffer, {
102 |         contentType: 'image/jpeg',
103 |         upsert: true, // Overwrite if exists
104 |       });
105 | 
106 |     if (uploadError) {
107 |       console.error('[UPLOAD_STORY_IMAGE] Upload error:', uploadError);
108 |       throw new Error(`Storage upload failed: ${uploadError.message}`);
109 |     }
110 | 
111 |     console.log('[UPLOAD_STORY_IMAGE] Upload successful:', uploadData);
112 | 
113 |     // Get public URL
114 |     const { data: urlData } = supabaseAdmin.storage
115 |       .from('images-stories')
116 |       .getPublicUrl(storagePath);
117 | 
118 |     const publicUrl = urlData.publicUrl;
119 |     console.log(`[UPLOAD_STORY_IMAGE] Public URL generated: ${publicUrl}`);
120 | 
121 |     // Return success response
122 |     return new Response(
123 |       JSON.stringify({
124 |         success: true,
125 |         publicUrl: publicUrl,
126 |         path: storagePath,
127 |         imageType: imageType,
128 |         storyId: storyId,
129 |         chapterId: chapterId
130 |       }),
131 |       {
132 |         status: 200,
133 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' }
134 |       }
135 |     );
136 | 
137 |   } catch (error) {
138 |     console.error('[UPLOAD_STORY_IMAGE] Error:', error);
139 |     
140 |     return new Response(
141 |       JSON.stringify({
142 |         error: 'Failed to upload story image',
143 |         details: error instanceof Error ? error.message : 'Unknown error'
144 |       }),
145 |       {
146 |         status: 500,
147 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' }
148 |       }
149 |     );
150 |   }
151 | }) 
```

supabase/functions/upload-chapter-audio/index.ts
```
1 | import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
2 | import { createClient, SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2';
3 | import { corsHeaders } from '../_shared/cors.ts'; // Asegúrate que la ruta sea correcta
4 | 
5 | // Tipado para los datos de la base de datos (opcional pero recomendado)
6 | interface ChapterAudioFile {
7 |   id?: string;
8 |   chapter_id: string;
9 |   user_id: string;
10 |   story_id: string;
11 |   voice_id: string;
12 |   storage_path: string;
13 |   public_url: string;
14 |   metadata?: Record<string, any>;
15 |   created_at?: string;
16 | }
17 | 
18 | serve(async (req: Request) => {
19 |   // Manejo de CORS preflight request
20 |   if (req.method === 'OPTIONS') {
21 |     return new Response('ok', { headers: corsHeaders });
22 |   }
23 | 
24 |   try {
25 |     const supabaseUrl = Deno.env.get('SUPABASE_URL');
26 |     const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
27 | 
28 |     if (!supabaseUrl || !supabaseServiceKey) {
29 |       console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY');
30 |       return new Response(JSON.stringify({ error: 'Variables de entorno del servidor no configuradas.' }), {
31 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' },
32 |         status: 500,
33 |       });
34 |     }
35 | 
36 |     const supabaseClient: SupabaseClient = createClient(supabaseUrl, supabaseServiceKey);
37 |     const formData = await req.formData();
38 | 
39 |     const chapterId = formData.get('chapterId') as string;
40 |     const voiceId = formData.get('voiceId') as string;
41 |     const audioFile = formData.get('audioFile') as File;
42 |     const userId = formData.get('userId') as string;
43 |     const storyId = formData.get('storyId') as string; // Añadido para la ruta de almacenamiento
44 | 
45 |     if (!chapterId || !voiceId || !audioFile || !storyId) {
46 |       return new Response(JSON.stringify({ error: 'Faltan parámetros: storyId, chapterId, voiceId o audioFile' }), {
47 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' },
48 |         status: 400,
49 |       });
50 |     }
51 | 
52 |     const bucketName = 'narrations'; 
53 |     // Estructura de ruta mejorada: bucket/storyId/chapterId/voiceId.mp3
54 |     const filePath = `${storyId}/${chapterId}/${voiceId}.mp3`; 
55 | 
56 |     console.log(`Subiendo archivo a: ${bucketName}/${filePath}`);
57 | 
58 |     const { data: uploadData, error: uploadError } = await supabaseClient.storage
59 |       .from(bucketName)
60 |       .upload(filePath, audioFile, {
61 |         cacheControl: '3600',
62 |         upsert: true, 
63 |         contentType: 'audio/mpeg',
64 |       });
65 | 
66 |     if (uploadError) {
67 |       console.error('Error subiendo a Storage:', uploadError);
68 |       // Si el error es 'Duplicate', significa que el archivo ya existe y upsert=true debería haberlo manejado.
69 |       // Podría ser un problema de permisos o configuración del bucket si no es 'Duplicate'.
70 |       // Para el caso específico de "The resource already exists" (cuando upsert=true),
71 |       // podemos considerar que el archivo ya está y continuar para obtener su URL.
72 |       if (uploadError.message !== 'The resource already exists') {
73 |          throw uploadError;
74 |       }
75 |       console.warn(`El archivo en ${filePath} ya existía. Se intentará obtener su URL pública.`);
76 |     }
77 | 
78 |     const { data: publicUrlData } = supabaseClient.storage
79 |       .from(bucketName)
80 |       .getPublicUrl(filePath);
81 | 
82 |     if (!publicUrlData || !publicUrlData.publicUrl) {
83 |       console.error('Error obteniendo URL pública para:', filePath);
84 |       throw new Error('No se pudo obtener la URL pública del archivo.');
85 |     }
86 |     const publicUrl = publicUrlData.publicUrl;
87 |     console.log('URL Pública obtenida:', publicUrl);
88 | 
89 |     const chapterAudioInsert: Omit<ChapterAudioFile, 'id' | 'created_at'> = {
90 |       chapter_id: chapterId,
91 |       story_id: storyId,
92 |       user_id: userId,
93 |       voice_id: voiceId,
94 |       storage_path: filePath, // Guardamos la ruta relativa al bucket
95 |       public_url: publicUrl,
96 |       // metadata: { fileSize: audioFile.size } // Opcional
97 |     };
98 | 
99 |     const { data: dbData, error: dbError } = await supabaseClient
100 |       .from('audio_files')
101 |       .upsert(chapterAudioInsert, {
102 |         onConflict: 'chapter_id, voice_id, user_id',
103 |         // ignoreDuplicates: false, // Queremos que actualice si hay conflicto
104 |       })
105 |       .select()
106 |       .single();
107 | 
108 |     if (dbError) {
109 |       console.error('Error guardando en base de datos:', dbError);
110 |       throw dbError;
111 |     }
112 |     console.log('Registro en DB:', dbData);
113 | 
114 |     return new Response(JSON.stringify({ publicUrl, chapterAudioFile: dbData }), {
115 |       headers: { ...corsHeaders, 'Content-Type': 'application/json' },
116 |       status: 200,
117 |     });
118 | 
119 |   } catch (error) {
120 |     console.error('Error en Edge Function (upload-chapter-audio):', error);
121 |     return new Response(JSON.stringify({ error: error.message || 'Error interno del servidor' }), {
122 |       headers: { ...corsHeaders, 'Content-Type': 'application/json' },
123 |       status: 500,
124 |     });
125 |   }
126 | });
```

supabase/functions/generate-audio/deno.jsonc
```
1 | {
2 |   "tasks": {
3 |     "start": "deno run --allow-net --allow-env index.ts"
4 |   },
5 |   "importMap": "./import_map.json"
6 | } 
```

supabase/functions/generate-audio/import_map.json
```
1 | {
2 |   "imports": {
3 |     "std/": "https://deno.land/std@0.177.0/",
4 |     "openai": "https://esm.sh/openai@4.0.0"
5 |   }
6 | } 
```

supabase/functions/generate-audio/index.ts
```
1 | // supabase/functions/ai/generate-audio/index.ts
2 | // Lógica CORREGIDA: Verifica créditos ANTES de TTS y actualiza DB. Permite a gratuitos usar créditos comprados.
3 | 
4 | import { serve } from "https://deno.land/std@0.177.0/http/server.ts"; // O la versión que uses
5 | import { OpenAI } from "https://esm.sh/openai@4.40.0"; // O versión más reciente
6 | import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.8';
7 | import { corsHeaders } from '../_shared/cors.ts'; // Asume que está en la carpeta renombrada 'functions'
8 | 
9 | // --- Configuración ---
10 | console.log(`[GENERATE_AUDIO_DEBUG] Function generate-audio initializing...`);
11 | 
12 | const openaiApiKey = Deno.env.get('OPENAI_API_KEY');
13 | if (!openaiApiKey) {
14 |     console.error("[GENERATE_AUDIO_ERROR] CRITICAL: OPENAI_API_KEY environment variable not set.");
15 |     // Lanzar error para detener la función si falta la clave
16 |     throw new Error("OPENAI_API_KEY environment variable not set");
17 | }
18 | const openai = new OpenAI({ apiKey: openaiApiKey });
19 | 
20 | const supabaseUrl = Deno.env.get('SUPABASE_URL');
21 | const serviceRoleKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY'); // O APP_SERVICE_ROLE_KEY si ese es el nombre
22 | if (!supabaseUrl || !serviceRoleKey) {
23 |     console.error("[GENERATE_AUDIO_ERROR] CRITICAL: Supabase URL or Service Role Key not set.");
24 |     throw new Error("Supabase URL or Service Role Key not set");
25 | }
26 | // Cliente Admin para operaciones críticas (consulta de perfil, actualización de créditos)
27 | const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey);
28 | 
29 | // Constante para el límite mensual (mejor si viene de env vars)
30 | const PREMIUM_MONTHLY_ALLOWANCE = 20;
31 | 
32 | console.log(`[GENERATE_AUDIO_DEBUG] Function generate-audio initialized successfully.`);
33 | // --- Fin Configuración ---
34 | 
35 | serve(async (req: Request) => {
36 |   // Manejo Preflight OPTIONS
37 |   if (req.method === 'OPTIONS') {
38 |     console.log('[GENERATE_AUDIO_DEBUG] Handling OPTIONS preflight request');
39 |     return new Response('ok', { headers: corsHeaders });
40 |   }
41 | 
42 |   let userId: string | null = null; // Para logging en caso de error temprano
43 |   let creditSource: 'monthly' | 'purchased' | 'none' = 'none'; // Para saber qué actualizar
44 | 
45 |   try {
46 |     // --- 1. Autenticación ---
47 |     console.log('[GENERATE_AUDIO_DEBUG] Attempting authentication...');
48 |     const authHeader = req.headers.get('Authorization');
49 |     if (!authHeader?.startsWith('Bearer ')) {
50 |         console.warn('[GENERATE_AUDIO_WARN] Invalid or missing Authorization header.');
51 |         return new Response(JSON.stringify({ error: 'Token inválido.' }), { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
52 |     }
53 |     const token = authHeader.replace('Bearer ', '');
54 | 
55 |     // Usamos el cliente ADMIN para obtener el usuario asociado al token JWT
56 |     // Esto es más seguro que crear un cliente por solicitud con el token del usuario
57 |     const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);
58 | 
59 |     if (authError || !user) {
60 |         console.error('[GENERATE_AUDIO_ERROR] Authentication failed:', authError?.message || 'User not found for token.');
61 |         return new Response(JSON.stringify({ error: 'No autenticado.' }), { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
62 |     }
63 |     userId = user.id; // Asignamos userId para logging posterior
64 |     console.log(`[GENERATE_AUDIO_INFO] User Authenticated: ${userId}`);
65 |     // --- Fin Autenticación ---
66 | 
67 |     // --- 2. Obtener Perfil y Verificar Permiso/Límites/Créditos ---
68 |     console.log(`[GENERATE_AUDIO_DEBUG] Fetching profile for user ${userId}...`);
69 |     const { data: profile, error: profileError } = await supabaseAdmin
70 |         .from('profiles')
71 |         .select('subscription_status, voice_credits, monthly_voice_generations_used')
72 |         .eq('id', userId)
73 |         .single(); // Usar single() para que falle si no hay exactamente 1 perfil
74 | 
75 |     if (profileError) {
76 |         console.error(`[GENERATE_AUDIO_ERROR] Failed to fetch profile for user ${userId}:`, profileError);
77 |         // No lanzar error aquí, devolver respuesta controlada
78 |         return new Response(JSON.stringify({ error: 'Error al obtener perfil de usuario.' }), { status: 500, headers: corsHeaders });
79 |     }
80 |     // No necesitamos chequear !profile porque .single() ya daría error si no existe
81 | 
82 |     console.log(`[GENERATE_AUDIO_DEBUG] Profile data for ${userId}:`, profile);
83 | 
84 |     let canGenerate = false;
85 |     const isPremium = profile.subscription_status === 'active' || profile.subscription_status === 'trialing';
86 |     const monthlyUsed = profile.monthly_voice_generations_used ?? 0;
87 |     const purchasedCredits = profile.voice_credits ?? 0;
88 | 
89 |     // --- Lógica de decisión ---
90 |     if (isPremium) {
91 |         console.log(`[GENERATE_AUDIO_DEBUG] User ${userId} is Premium/Trialing.`);
92 |         if (monthlyUsed < PREMIUM_MONTHLY_ALLOWANCE) {
93 |             console.log(`[GENERATE_AUDIO_INFO] Authorizing via monthly allowance for user ${userId}. Used: ${monthlyUsed}/${PREMIUM_MONTHLY_ALLOWANCE}.`);
94 |             canGenerate = true;
95 |             creditSource = 'monthly';
96 |         } else if (purchasedCredits > 0) {
97 |             console.log(`[GENERATE_AUDIO_INFO] Monthly allowance used. Authorizing via purchased credit for user ${userId}. Purchased available: ${purchasedCredits}.`);
98 |             canGenerate = true;
99 |             creditSource = 'purchased';
100 |         } else {
101 |             console.log(`[GENERATE_AUDIO_WARN] Denying - Premium user ${userId} has no monthly allowance or purchased credits remaining.`);
102 |         }
103 |     } else { // Usuario Gratuito, Cancelado, etc.
104 |         console.log(`[GENERATE_AUDIO_DEBUG] User ${userId} is not Premium (Status: ${profile.subscription_status}). Checking purchased credits...`);
105 |         if (purchasedCredits > 0) {
106 |             console.log(`[GENERATE_AUDIO_INFO] Authorizing via purchased credit for non-premium user ${userId}. Purchased available: ${purchasedCredits}.`);
107 |             canGenerate = true;
108 |             creditSource = 'purchased';
109 |         } else {
110 |             console.log(`[GENERATE_AUDIO_WARN] Denying - Non-premium user ${userId} has no purchased credits.`);
111 |             // Podríamos devolver 403 si NUNCA pudieran generar, pero como pueden comprar, 402 es mejor.
112 |         }
113 |     }
114 | 
115 |     // --- 3. Devolver error si no hay créditos ANTES de actualizar DB o llamar a TTS ---
116 |     if (!canGenerate) {
117 |         console.log(`[GENERATE_AUDIO_INFO] Denying audio generation for user ${userId} due to insufficient credits.`);
118 |         return new Response(JSON.stringify({ error: 'Créditos de voz insuficientes.' }), { status: 402, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }); // 402 Payment Required
119 |     }
120 | 
121 |     // --- 4. Actualizar Contador/Crédito (ANTES de llamar a OpenAI) ---
122 |     console.log(`[GENERATE_AUDIO_DEBUG] Attempting to update usage/credits for user ${userId} (Source: ${creditSource})...`);
123 |     let dbUpdateError = null;
124 |     let rpcResultData: number | null = null; // Para almacenar el resultado de decrement_voice_credits si es necesario
125 | 
126 |     if (creditSource === 'monthly') {
127 |         const { error: rpcError } = await supabaseAdmin.rpc('increment_monthly_voice_usage', { user_uuid: userId });
128 |         dbUpdateError = rpcError;
129 |         if (!dbUpdateError) console.log(`[GENERATE_AUDIO_INFO] DB OK: Monthly usage incremented for ${userId}.`);
130 | 
131 |     } else if (creditSource === 'purchased') {
132 |         // Llamamos a decrement y guardamos el resultado (podría ser el nuevo saldo o -1)
133 |         const { data, error: rpcError } = await supabaseAdmin.rpc('decrement_voice_credits', { user_uuid: userId });
134 |         dbUpdateError = rpcError;
135 |         rpcResultData = data; // Guardamos el resultado (puede ser null si la función no devuelve nada o el valor devuelto)
136 |         if (!dbUpdateError && typeof rpcResultData === 'number' && rpcResultData !== -1) {
137 |              console.log(`[GENERATE_AUDIO_INFO] DB OK: Purchased credit decremented for ${userId}. Approx new balance: ${rpcResultData}`);
138 |         } else if (!dbUpdateError && rpcResultData === -1) {
139 |              // Esto no debería pasar si canGenerate fue true, pero es un check de seguridad
140 |              console.warn(`[GENERATE_AUDIO_WARN] DB WARN: decrement_voice_credits returned -1 unexpectedly for user ${userId}.`);
141 |              // Considerar fallar aquí ya que el estado podría ser inconsistente
142 |              // dbUpdateError = new Error("Inconsistent state: decrement returned -1 after check passed.");
143 |         } else if (!dbUpdateError) {
144 |              console.log(`[GENERATE_AUDIO_INFO] DB OK: Purchased credit decremented for ${userId} (RPC did not return new balance).`);
145 |         }
146 |     }
147 | 
148 |     // Si la actualización de la DB falló, no continuamos
149 |     if (dbUpdateError) {
150 |         console.error(`[GENERATE_AUDIO_ERROR] CRITICAL FAIL: Failed to update ${creditSource} count via RPC for user ${userId}:`, dbUpdateError);
151 |         return new Response(JSON.stringify({ error: 'Error al actualizar el saldo de créditos.' }), { status: 500, headers: corsHeaders });
152 |     }
153 |     console.log(`[GENERATE_AUDIO_INFO] Credit/Usage count updated successfully for user ${userId}. Proceeding with TTS generation.`);
154 | 
155 |     // --- 5. Procesar Solicitud y Generar Audio (AHORA SÍ) ---
156 |     const { text, voice = 'alloy', model = 'tts-1' } = await req.json(); // Proporcionar defaults
157 |     if (!text || typeof text !== 'string' || text.trim().length === 0) {
158 |         console.warn(`[GENERATE_AUDIO_WARN] Invalid request body for user ${userId}: Text is missing or empty.`);
159 |         return new Response(JSON.stringify({ error: 'Texto inválido o ausente requerido.' }), { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
160 |     }
161 | 
162 |     console.log(`[GENERATE_AUDIO_INFO] Generating audio via OpenAI for user ${userId} (Voice: ${voice}, Model: ${model})...`);
163 |     const response = await openai.audio.speech.create({
164 |         model: model,
165 |         voice: voice,
166 |         input: text.trim() // Usar texto sin espacios extra
167 |     });
168 | 
169 |     // Verificar si la respuesta de OpenAI fue exitosa
170 |     if (!response.ok) {
171 |         const errorBody = await response.text(); // Intentar leer el cuerpo del error
172 |         console.error(`[GENERATE_AUDIO_ERROR] OpenAI API error for user ${userId}: ${response.status} ${response.statusText}`, errorBody);
173 |         // Devolver un error genérico al cliente, pero loguear el detalle
174 |         return new Response(JSON.stringify({ error: 'Error al contactar el servicio de generación de voz.' }), { status: 502, headers: corsHeaders }); // 502 Bad Gateway
175 |     }
176 | 
177 |     const audioBuffer = await response.arrayBuffer();
178 |     console.log(`[GENERATE_AUDIO_INFO] Audio generated successfully via OpenAI for user ${userId}.`);
179 |     // --- Fin Generar Audio ---
180 | 
181 |     // --- 6. Devolver Respuesta de Audio ---
182 |     // Nota: Ya no actualizamos créditos aquí, se hizo antes.
183 |     console.log(`[GENERATE_AUDIO_INFO] Returning audio buffer to user ${userId}.`);
184 |     return new Response(audioBuffer, {
185 |         headers: {
186 |             ...corsHeaders,
187 |             'Content-Type': 'audio/mpeg' // O el tipo correcto devuelto por OpenAI
188 |         },
189 |         status: 200
190 |     });
191 |     // --- Fin Devolver Respuesta ---
192 | 
193 |   } catch (error) {
194 |     // Captura errores generales (JSON parse, errores inesperados, etc.)
195 |     console.error(`[GENERATE_AUDIO_ERROR] Unhandled error in generate-audio function for user ${userId || 'UNKNOWN'}:`, error);
196 |     let errorMessage = 'Error interno del servidor al generar el audio.';
197 |     // Evitar exponer detalles internos en producción
198 |     // if (error instanceof Error) errorMessage = error.message;
199 |     // Usar 500 Internal Server Error para errores no manejados específicamente
200 |     return new Response(JSON.stringify({ error: errorMessage }), {
201 |         status: 500,
202 |         headers: { ...corsHeaders, 'Content-Type': 'application/json' }
203 |     });
204 |   }
205 | });
```

src/store/stories/audio/audioStore.ts
```
1 | import { create } from 'zustand';
2 | import { persist } from 'zustand/middleware';
3 | import { AudioState } from "../../types/storeTypes";
4 | import { createPersistentStore } from "../../core/createStore";
5 | import {
6 |   getCurrentVoice,
7 |   getUserAudios,
8 |   setCurrentVoice,
9 |   syncAudioFile,
10 |   syncQueue,
11 | } from "../../../services/supabase";
12 | import { useUserStore } from "../../user/userStore";
13 | 
14 | // Tipos
15 | type GenerationStatus = 'idle' | 'generating' | 'completed' | 'error';
16 | 
17 | interface AudioStateEntry {
18 |   url: string;
19 |   generatedAt: number;
20 |   // Eliminamos referencia a S3, solo usamos URLs locales (blob)
21 | }
22 | 
23 | interface AudioGenerationStatus {
24 |   status: GenerationStatus;
25 |   progress: number;
26 | }
27 | 
28 | interface AudioStore {
29 |   // Cache de audio
30 |   audioCache: Record<string, AudioStateEntry>; // storyId_chapterId_voiceId -> AudioStateEntry
31 |   
32 |   // Estado de generación
33 |   generationStatus: Record<string, AudioGenerationStatus>; // storyId_chapterId -> status
34 |   
35 |   // Preferencia de voz
36 |   currentVoice: string | null;
37 |   
38 |   // Acciones
39 |   addAudioToCache: (storyId: string, chapterId: string | number, voiceId: string, url: string) => void;
40 |   getAudioFromCache: (storyId: string, chapterId: string | number, voiceId: string) => string | null;
41 |   clearAudioCache: () => void;
42 |   removeAudioFromCache: (storyId: string, chapterId: string | number, voiceId: string) => void;
43 |   
44 |   // Acciones para generación
45 |   setGenerationStatus: (storyId: string, chapterId: string | number, status: GenerationStatus, progress?: number) => void;
46 |   getGenerationStatus: (storyId: string, chapterId: string | number) => AudioGenerationStatus;
47 |   
48 |   // Acciones preferencia de voz
49 |   setCurrentVoice: (voiceId: string) => void;
50 |   getCurrentVoice: () => string | null;
51 | }
52 | 
53 | // Crear store con persistencia
54 | export const useAudioStore = create<AudioStore>()(
55 |   persist(
56 |     (set, get) => ({
57 |       // Estado inicial
58 |       audioCache: {},
59 |       generationStatus: {},
60 |       currentVoice: null,
61 |       
62 |       // Acciones para cache de audio
63 |       addAudioToCache: (storyId, chapterId, voiceId, url) => {
64 |         const key = `${storyId}_${chapterId}_${voiceId}`;
65 |         set(state => ({
66 |           audioCache: {
67 |             ...state.audioCache,
68 |             [key]: {
69 |               url,
70 |               generatedAt: Date.now()
71 |             }
72 |           }
73 |         }));
74 |       },
75 |       
76 |       getAudioFromCache: (storyId, chapterId, voiceId) => {
77 |         const key = `${storyId}_${chapterId}_${voiceId}`;
78 |         const entry = get().audioCache[key];
79 |         return entry?.url || null;
80 |       },
81 |       
82 |       clearAudioCache: () => {
83 |         // Liberar URLs de blob antes de limpiar el cache
84 |         Object.values(get().audioCache).forEach(entry => {
85 |           if (entry.url.startsWith('blob:')) {
86 |             URL.revokeObjectURL(entry.url);
87 |           }
88 |         });
89 |         
90 |         set({ audioCache: {} });
91 |       },
92 |       
93 |       removeAudioFromCache: (storyId, chapterId, voiceId) => {
94 |         const key = `${storyId}_${chapterId}_${voiceId}`;
95 |         const entry = get().audioCache[key];
96 |         
97 |         // Si es un blob URL, liberarla
98 |         if (entry && entry.url.startsWith('blob:')) {
99 |           URL.revokeObjectURL(entry.url);
100 |         }
101 |         
102 |         set(state => {
103 |           const newCache = { ...state.audioCache };
104 |           delete newCache[key];
105 |           return { audioCache: newCache };
106 |         });
107 |       },
108 |       
109 |       // Acciones para estado de generación
110 |       setGenerationStatus: (storyId, chapterId, status, progress = 0) => {
111 |         const key = `${storyId}_${chapterId}`;
112 |         set(state => ({
113 |           generationStatus: {
114 |             ...state.generationStatus,
115 |             [key]: { status, progress }
116 |           }
117 |         }));
118 |       },
119 |       
120 |       getGenerationStatus: (storyId, chapterId) => {
121 |         const key = `${storyId}_${chapterId}`;
122 |         return get().generationStatus[key] || { status: 'idle', progress: 0 };
123 |       },
124 |       
125 |       // Acciones para preferencia de voz
126 |       setCurrentVoice: (voiceId) => {
127 |         set({ currentVoice: voiceId });
128 |       },
129 |       
130 |       getCurrentVoice: () => {
131 |         return get().currentVoice;
132 |       }
133 |     }),
134 |     {
135 |       name: 'audio-storage', // Nombre de la clave en localStorage
136 |     }
137 |   )
138 | );
```

src/store/stories/challenges/challengesStore.ts
```
1 | import { ChallengesState } from "../../types/storeTypes";
2 | import { Challenge } from "../../../types";
3 | import { createPersistentStore } from "../../core/createStore";
4 | import {
5 |   getStoryChallenges,
6 |   syncChallenge,
7 |   syncQueue,
8 | } from "../../../services/supabase";
9 | 
10 | // Estado inicial
11 | const initialState: Pick<ChallengesState, "challenges"> = {
12 |   challenges: [],
13 | };
14 | 
15 | export const useChallengesStore = createPersistentStore<ChallengesState>(
16 |   initialState,
17 |   (set, get) => ({
18 |     addChallenge: async (challenge) => {
19 |       // Guardar localmente primero
20 |       set((state) => ({
21 |         challenges: [challenge, ...state.challenges],
22 |       }));
23 | 
24 |       // Sincronizar con Supabase
25 |       try {
26 |         const { success } = await syncChallenge(challenge);
27 | 
28 |         if (!success) {
29 |           // Si falla, agregar a la cola de sincronización
30 |           syncQueue.addToQueue("challenges", "insert", {
31 |             id: challenge.id,
32 |             story_id: challenge.storyId,
33 |             created_at: challenge.createdAt,
34 |           });
35 | 
36 |           // También tenemos que guardar las preguntas
37 |           challenge.questions.forEach((question) => {
38 |             syncQueue.addToQueue("challenge_questions", "insert", {
39 |               id: question.id,
40 |               challenge_id: challenge.id,
41 |               question: question.question,
42 |               options: question.options,
43 |               correct_option_index: question.correctOptionIndex,
44 |               explanation: question.explanation,
45 |               category: question.category,
46 |               target_language: question.targetLanguage,
47 |             });
48 |           });
49 |         }
50 |       } catch (error) {
51 |         console.error("Error sincronizando desafío con Supabase:", error);
52 |       }
53 |     },
54 | 
55 |     getChallengesByStoryId: (storyId) => {
56 |       return get().challenges.filter((challenge) =>
57 |         challenge.storyId === storyId
58 |       );
59 |     },
60 | 
61 |     loadChallengesFromSupabase: async (storyId) => {
62 |       try {
63 |         const { success, challenges } = await getStoryChallenges(storyId);
64 | 
65 |         if (success && challenges) {
66 |           // Actualizar el store local con los desafíos de la historia
67 |           set((state) => {
68 |             // Filtrar los desafíos actuales eliminando los de esta historia
69 |             const filteredChallenges = state.challenges.filter(
70 |               (challenge) => challenge.storyId !== storyId,
71 |             );
72 | 
73 |             // Agregar los desafíos actualizados de la historia
74 |             return {
75 |               challenges: [...filteredChallenges, ...challenges],
76 |             };
77 |           });
78 |         }
79 |       } catch (error) {
80 |         console.error("Error cargando desafíos desde Supabase:", error);
81 |       }
82 |     },
83 |   }),
84 |   "challenges",
85 | );
```

src/store/stories/chapters/chaptersStore.ts
```
1 | import { ChaptersState } from "../../types/storeTypes";
2 | import { StoryWithChapters } from "../../../types";
3 | import { createPersistentStore } from "../../core/createStore";
4 | import { useStoriesStore } from "../storiesStore";
5 | import {
6 |   getStoryChapters,
7 |   syncChapter,
8 |   syncQueue,
9 | } from "../../../services/supabase";
10 | 
11 | // Estado inicial
12 | const initialState: Pick<ChaptersState, "storyChapters"> = {
13 |   storyChapters: [],
14 | };
15 | 
16 | export const useChaptersStore = createPersistentStore<ChaptersState>(
17 |   initialState,
18 |   (set, get) => ({
19 |     getChaptersByStoryId: (storyId) => {
20 |       const storyWithChapters = get().storyChapters.find((s) =>
21 |         s.id === storyId
22 |       );
23 |       return storyWithChapters ? storyWithChapters.chapters : [];
24 |     },
25 | 
26 |     addChapter: async (storyId, chapter) => {
27 |       console.log("🚀 ~ addChapter: ~ chapter:", chapter)
28 |       console.log("🚀 ~ addChapter: ~ storyId:", storyId)
29 |       try {
30 |         // 1. Intentar sincronizar con Supabase PRIMERO
31 |         const { success } = await syncChapter(chapter, storyId);
32 | 
33 |         if (success) {
34 |           // 2. SI la sincronización es exitosa, AHORA actualizar el store local
35 |           set((state) => {
36 |             const storyWithChapters = state.storyChapters.find((s) =>
37 |               s.id === storyId
38 |             );
39 | 
40 |             if (storyWithChapters) {
41 |               // Actualizar los capítulos existentes
42 |               return {
43 |                 storyChapters: state.storyChapters.map((s) =>
44 |                   s.id === storyId
45 |                     ? { ...s, chapters: [...s.chapters, chapter] }
46 |                     : s
47 |                 ),
48 |               };
49 |             } else {
50 |               // Crear nueva entrada para la historia
51 |               const storiesStore = useStoriesStore.getState();
52 |               const story = storiesStore.getStoryById(storyId);
53 | 
54 |               if (!story) return state; // Historia no encontrada
55 | 
56 |               const newStoryWithChapters: StoryWithChapters = {
57 |                 id: storyId,
58 |                 title: story.title,
59 |                 content: story.content,
60 |                 options: story.options,
61 |                 createdAt: story.createdAt,
62 |                 audioUrl: story.audioUrl,
63 |                 chapters: [chapter],
64 |               };
65 | 
66 |               return {
67 |                 storyChapters: [...state.storyChapters, newStoryWithChapters],
68 |               };
69 |             }
70 |           });
71 |         } else {
72 |            // 3. Si falla la sincronización directa, agregar a la cola SIN actualizar el estado local
73 |            console.warn("Sincronización directa de capítulo fallida, añadiendo a la cola.");
74 |            syncQueue.addToQueue("story_chapters", "insert", {
75 |              story_id: storyId,
76 |              chapter_number: chapter.chapterNumber,
77 |              title: chapter.title,
78 |              content: chapter.content,
79 |              generation_method: chapter.generationMethod,
80 |              custom_input: chapter.customInput,
81 |            });
82 |            // Lanzar un error para que el frontend sepa que no se guardó (opcional pero recomendado)
83 |            throw new Error("No se pudo guardar el capítulo en la base de datos.");
84 |         }
85 |       } catch (error) {
86 |         console.error("Error sincronizando capítulo con Supabase:", error);
87 |         // 4. Si hay un error en el try, agregar a la cola SIN actualizar el estado local
88 |         syncQueue.addToQueue("story_chapters", "insert", {
89 |           story_id: storyId,
90 |           chapter_number: chapter.chapterNumber,
91 |           title: chapter.title,
92 |           content: chapter.content,
93 |           generation_method: chapter.generationMethod,
94 |           custom_input: chapter.customInput,
95 |         });
96 |         // Propagar el error para que el frontend pueda manejarlo
97 |         throw error;
98 |       }
99 |     },
100 | 
101 |     getLastChapterByStoryId: (storyId) => {
102 |       const chapters = get().getChaptersByStoryId(storyId);
103 |       if (chapters.length === 0) return undefined;
104 | 
105 |       // Ordenar capítulos y devolver el último
106 |       return [...chapters].sort((a, b) => b.chapterNumber - a.chapterNumber)[0];
107 |     },
108 | 
109 |     loadChaptersFromSupabase: async (storyId) => {
110 |       try {
111 |         const { success, chapters } = await getStoryChapters(storyId);
112 | 
113 |         if (success && chapters && chapters.length > 0) {
114 |           const storiesStore = useStoriesStore.getState();
115 |           const story = storiesStore.getStoryById(storyId);
116 | 
117 |           if (!story) return; // Historia no encontrada
118 | 
119 |           set((state) => {
120 |             const existingStoryIndex = state.storyChapters.findIndex((s) =>
121 |               s.id === storyId
122 |             );
123 | 
124 |             if (existingStoryIndex >= 0) {
125 |               // Actualizar capítulos de la historia existente
126 |               const updatedStoryChapters = [...state.storyChapters];
127 |               updatedStoryChapters[existingStoryIndex] = {
128 |                 ...updatedStoryChapters[existingStoryIndex],
129 |                 chapters,
130 |               };
131 | 
132 |               return { storyChapters: updatedStoryChapters };
133 |             } else {
134 |               // Crear nueva entrada para la historia
135 |               const newStoryWithChapters: StoryWithChapters = {
136 |                 id: storyId,
137 |                 title: story.title,
138 |                 content: story.content,
139 |                 options: story.options,
140 |                 createdAt: story.createdAt,
141 |                 audioUrl: story.audioUrl,
142 |                 chapters,
143 |               };
144 | 
145 |               return {
146 |                 storyChapters: [...state.storyChapters, newStoryWithChapters],
147 |               };
148 |             }
149 |           });
150 |         }
151 |       } catch (error) {
152 |         console.error("Error cargando capítulos desde Supabase:", error);
153 |       }
154 |     },
155 |   }),
156 |   "chapters",
157 | );
```
